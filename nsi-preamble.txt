;@+leo-ver=5-thin
;@+node:ekr.20101027063949.1592: * @thin ../../nsi-preamble.txt
;@@language nsi

; Location of Pythonw.exe. Set by .onInit.
Var PythonExecutable

; ========== Boilerplate
SetCompressor bzip2
Caption "${name} Installer"
AutoCloseWindow false 
SilentInstall normal
CRCCheck on
SetCompress auto
SetDatablockOptimize on
WindowIcon on
ShowInstDetails show
ShowUnInstDetails show

; ========== Locations
Name "${name}"
OutFile "${target_file}"
InstallDir "$PROGRAMFILES\${name}-${version}"
Icon ${install_icon}

; =========== Pages

Var StartMenuFolder

!insertmacro MUI_PAGE_WELCOME
!insertmacro MUI_PAGE_LICENSE       ${license}
!insertmacro MUI_PAGE_COMPONENTS
!insertmacro MUI_PAGE_DIRECTORY
!insertmacro MUI_PAGE_STARTMENU     "Application" $StartMenuFolder
!insertmacro MUI_PAGE_INSTFILES
!insertmacro MUI_PAGE_FINISH

!insertmacro MUI_UNPAGE_WELCOME
; !insertmacro MUI_UNPAGE_LICENSE   ${license}
; !insertmacro MUI_UNPAGE_CONFIRM
;!insertmacro MUI_UNPAGE_COMPONENTS ; doesn't actually list components.
!insertmacro MUI_UNPAGE_DIRECTORY
!insertmacro MUI_UNPAGE_INSTFILES
!insertmacro MUI_UNPAGE_FINISH

; =========== Language (should follow pages)

!insertmacro MUI_LANGUAGE "English"

; Set PythonExecutable to full path to Pythonw.exe.
Function .onInit

    ReadRegStr $9 HKLM "SOFTWARE\Python\PythonCore\3.1\InstallPath" ""
    StrCmp $9 "" tryPython30 ok

tryPython30:
    ReadRegStr $9 HKLM "SOFTWARE\Python\PythonCore\3.0\InstallPath" ""
    StrCmp $9 "" tryPython27 ok

tryPython27:
    ReadRegStr $9 HKLM "SOFTWARE\Python\PythonCore\2.7\InstallPath" ""
    StrCmp $9 "" tryPython26 ok

tryPython26:
    ReadRegStr $9 HKLM "SOFTWARE\Python\PythonCore\2.6\InstallPath" ""
    StrCmp $9 "" oops ok

oops:
    MessageBox MB_OK "Python not found"
    ; Abort "Python not found"
    StrCpy $PythonExecutable ""
    Goto done
ok:
    ; MessageBox MB_OK "Found Python at $9"
    ; LogText "Found Python at $9"
    StrCpy $PythonExecutable "$9\pythonw.exe"
done:

; End .onInit
FunctionEnd
;@-leo
