;@+leo-ver=5-thin
;@+node:ekr.20101027115225.1494: * @thin nsi-boilerplate.txt
;@@language nsi

;@+<< prolog >>
;@+node:ekr.20101027115225.1495: ** << prolog >>

; Globals
Var PythonExecutable
    ; Location of Pythonw.exe. Set by .onInit.

; Boilerplate
SetCompressor bzip2
Caption "${name} Installer"
AutoCloseWindow false 
SilentInstall normal
CRCCheck on
SetCompress auto
SetDatablockOptimize on
WindowIcon on
ShowInstDetails show
ShowUnInstDetails show

; Locations
Name "${name}"
OutFile "${target_file}"
InstallDir "$PROGRAMFILES\${name}-${version}"
Icon ${install_icon}
;@-<< prolog >>
;@+<< pages >>
;@+node:ekr.20101027115225.1496: ** << pages >>

Var StartMenuFolder

!insertmacro MUI_PAGE_WELCOME
!insertmacro MUI_PAGE_LICENSE       ${license}
!insertmacro MUI_PAGE_COMPONENTS
!insertmacro MUI_PAGE_DIRECTORY
!insertmacro MUI_PAGE_STARTMENU     "Application" $StartMenuFolder
!insertmacro MUI_PAGE_INSTFILES
!insertmacro MUI_PAGE_FINISH

!insertmacro MUI_UNPAGE_WELCOME
; !insertmacro MUI_UNPAGE_LICENSE   ${license}
; !insertmacro MUI_UNPAGE_CONFIRM
; !insertmacro MUI_UNPAGE_COMPONENTS ; doesn't actually list components.
!insertmacro MUI_UNPAGE_DIRECTORY
!insertmacro MUI_UNPAGE_INSTFILES
!insertmacro MUI_UNPAGE_FINISH


;@-<< pages >>
;@+<< custom pages >>
;@+node:ekr.20101027115225.1505: ** << custom pages >>


;@-<< custom pages >>

; Language should follow pages.
!insertmacro MUI_LANGUAGE "English"

; The order of sections and functions does not matter.

;@+others
;@+node:ekr.20101027115225.1497: ** onInit

; Set PythonExecutable to full path to Pythonw.exe.
Function .onInit

    ReadRegStr $9 HKLM "SOFTWARE\Python\PythonCore\3.1\InstallPath" ""
    StrCmp $9 "" tryPython30 ok

tryPython30:
    ReadRegStr $9 HKLM "SOFTWARE\Python\PythonCore\3.0\InstallPath" ""
    StrCmp $9 "" tryPython27 ok

tryPython27:
    ReadRegStr $9 HKLM "SOFTWARE\Python\PythonCore\2.7\InstallPath" ""
    StrCmp $9 "" tryPython26 ok

tryPython26:
    ReadRegStr $9 HKLM "SOFTWARE\Python\PythonCore\2.6\InstallPath" ""
    StrCmp $9 "" oops ok

oops:
    MessageBox MB_OK "Python not found"
    ; Abort "Python not found"
    StrCpy $PythonExecutable ""
    Goto done
ok:
    ; MessageBox MB_OK "Found Python at $9"
    ; LogText "Found Python at $9"
    StrCpy $PythonExecutable "$9\pythonw.exe"
done:

; End .onInit
FunctionEnd
;@+node:ekr.20101027115225.1498: ** Section Desktop Shortcut

Section "Desktop Shortcut" SEC03

  ; Apparently important.
  SetOutPath $INSTDIR

  CreateShortCut "$DESKTOP\${name}.lnk" "$PythonExecutable" \
    "$INSTDIR\launchLeo.py" "$INSTDIR\${app_icon}" 0

SectionEnd
;@+node:ekr.20101027115225.1499: ** Section File Association

Section "${ext} File Association"

  SectionIn 1 2 3

  ; back up old value of extension in case some other program was using it
  ReadRegStr $1 HKCR "${ext}" ""
  StrCmp $1 "" Label1
  StrCmp $1 "${name}File" Label1
  WriteRegStr HKCR "${ext}" "backup_val" $1

Label1:
  WriteRegStr HKCR "${ext}" "" "${name}File"
  WriteRegStr HKCR "${name}File" "" "${name} File"
  WriteRegStr HKCR "${name}File\shell" "" "open"
  WriteRegStr HKCR "${name}File\DefaultIcon" "" '"$INSTDIR\${app_icon}"'
  WriteRegStr HKCR "${name}File\shell\open\command" "" '"$PythonExecutable" "$INSTDIR\launchLeo.py" "%*"'

SectionEnd
;@+node:ekr.20101027115225.1500: ** Section -Additional Icons

Section -AdditionalIcons

  SetOutPath $INSTDIR
  CreateDirectory "$SMPROGRAMS\${name}"
  CreateShortCut  "$SMPROGRAMS\${name}\Uninstall.lnk" "$INSTDIR\uninst.exe"

SectionEnd

;@+node:ekr.20101027115225.1501: ** Section -Post

Section -Post

  WriteRegStr HKLM ${leo_hklm} "" "$INSTDIR"
  WriteUninstaller "$INSTDIR\uninst.exe"
  WriteRegStr HKLM "${uninst_key}" "DisplayName" "${name}-${version} (remove only)"
  WriteRegStr HKLM "${uninst_key}" "UninstallString" "$INSTDIR\uninst.exe"
  WriteRegStr HKLM "${uninst_key}" "DisplayVersion" "${version}"
  WriteRegStr HKLM "${uninst_key}" "URLInfoAbout" "${site}"
  WriteRegStr HKLM "${uninst_key}" "Publisher" "${publisher}"

SectionEnd
;@+node:ekr.20101027115225.1504: ** Section LeoSection

Section "Leo" SEC01

!include nsi-install-files.txt

; End of "Leo" SEC01
SectionEnd
;@+node:ekr.20101027115225.1503: ** Section Uninstall

Section Uninstall

    DeleteRegKey HKLM "${leo_hklm}"

    ; Delete files & directories only if we own them!
    ReadRegStr $1 HKCR "${ext}" ""
    StrCmp $1 "${name}File" 0 FinishUninstall

    ; Delete files & directories only if there is no backup_val key.
    ReadRegStr $1 HKCR "${ext}" "backup_val"
    StrCmp $1 "" 0 DeleteKeysAndFiles
      DeleteRegKey HKCR "${ext}"
    Goto FinishUninstall

DeleteKeysAndFiles:
    WriteRegStr HKCR "${ext}" "" $1
    DeleteRegValue HKCR "${ext}" "backup_val"

; ---- Start of manifest-related data...

!include nsi-uninstall-files.txt

; ---- End of manifest related data.

FinishUninstall:

    Delete "$SMPROGRAMS\${name}\Uninstall.lnk"
    RMDir "$SMPROGRAMS\${name}-${version}"
    Delete "$DESKTOP\${name}.lnk"

    ; "Software\Microsoft\Windows\CurrentVersion\Uninstall\leo"
    DeleteRegKey HKLM "${uninst_key}" 
    SetAutoClose false

; end Uninstall section
SectionEnd
;@-others
;@-leo
