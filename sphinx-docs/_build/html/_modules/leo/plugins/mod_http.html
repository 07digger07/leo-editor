<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>leo.plugins.mod_http &mdash; Leo API 4.11dev documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '4.11dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Leo API 4.11dev documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Leo API 4.11dev documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for leo.plugins.mod_http</h1><div class="highlight"><pre>
<span class="c">#@+leo-ver=5-thin</span>
<span class="c">#@+node:EKR.20040517080250.1: * @file mod_http.py</span>
<span class="c">#@+&lt;&lt; docstring &gt;&gt;</span>
<span class="c">#@+node:ekr.20050111111238: ** &lt;&lt; docstring &gt;&gt;</span>
<span class="sd">&#39;&#39;&#39; A minimal http plugin for LEO, based on AsyncHttpServer.py.</span>

<span class="sd">Use this plugin is as follows:</span>

<span class="sd">1. Start Leo with the plugin enabled. You will see a purple message that says</span>
<span class="sd">   something like::</span>

<span class="sd">    &quot;http serving enabled on port 8080, version 0.91&quot;</span>

<span class="sd">2. Start a web browser, and enter the following url: http://localhost:8080/</span>

<span class="sd">You will see a a &quot;top&quot; level page containing one link for every open .leo file.</span>
<span class="sd">Start clicking :-)</span>

<span class="sd">You can use the browser&#39;s refresh button to update the top-level view in the</span>
<span class="sd">browser after you have opened or closed files.</span>

<span class="sd">To enable this plugin put this into your file::</span>

<span class="sd">    @settings</span>
<span class="sd">        @bool http_active = True</span>
<span class="sd">        @int  http_port = 8080</span>
<span class="sd">        @string rst_http_attributename = &#39;rst_http_attribute&#39;</span>

<span class="sd">**Note**: the browser_encoding constant (defined in the top node of this file)</span>
<span class="sd">must match the character encoding used in the browser. If it does not, non-ascii</span>
<span class="sd">characters will look strange.</span>

<span class="sd">Can also be used for bookmarking directly from the browser to Leo. To do this,</span>
<span class="sd">add a bookmark to the browser with the following URL / Location::</span>
<span class="sd">    </span>
<span class="sd">    javascript:w=window;if(w.content){w=w.content}; d=w.document; w.open(&#39;http://localhost:8130/_/add/bkmk/?&amp;name=&#39; + escape(d.title) + &#39;&amp;selection=&#39; + escape(window.getSelection()) + &#39;&amp;url=&#39; + escape(w.location.href),%22_blank%22,%22toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=no, resizable=yes, copyhistory=no, width=800, height=300, status=no%22);void(0)</span>
<span class="sd">    </span>
<span class="sd">and edit the port (8130 in the example above) to match the port you&#39;re using for</span>
<span class="sd">mod_http.</span>

<span class="sd">Bookmarks are created as the first node in the outline which has been opened</span>
<span class="sd">longest. You can set the ``@string`` ``http_bookmark_unl`` to specify an</span>
<span class="sd">alternative location, e.g.::</span>
<span class="sd">    </span>
<span class="sd">    @string http_bookmark_unl = /home/tbrown/.bookmarks.leo#@bookmarks--&gt;Incoming</span>

<span class="sd">to place them in the `Incoming` node in the `@bookmarks` node in the</span>
<span class="sd">`.bookmarks.leo` outline.</span>
<span class="sd">    </span>
<span class="sd">The headline is preceeded with &#39;@url &#39; *unless* the ``bookmarks`` plugin is</span>
<span class="sd">loaded. If the ``bookmarks`` plugin is loaded the bookmark will have to be moved</span>
<span class="sd">to a ``@bookmarks`` tree to be useful.</span>

<span class="sd">The browser may or may not be able to close the bookmark form window for you,</span>
<span class="sd">depending on settings - set ``dom.allow_scripts_to_close_windows`` to true in</span>
<span class="sd">``about:config`` in Firefox.</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="c">#@-&lt;&lt; docstring &gt;&gt;</span>

<span class="c">#@@language python</span>
<span class="c">#@@tabwidth -4</span>

<span class="c"># Adapted and extended from the Python Cookbook:</span>
<span class="c"># http://aspn.activestate.com/ASPN/Cookbook/Python/Recipe/259148</span>

<span class="n">__version__</span> <span class="o">=</span> <span class="s">&quot;0.99&quot;</span>

<span class="c"># This encoding must match the character encoding used in your browser.</span>
<span class="c"># If it does not, non-ascii characters will look very strange.</span>
<span class="n">browser_encoding</span> <span class="o">=</span> <span class="s">&#39;utf-8&#39;</span> <span class="c"># A hack.  Can we query the browser for this?</span>

<span class="c">#@+&lt;&lt; imports &gt;&gt;</span>
<span class="c">#@+node:EKR.20040517080250.3: ** &lt;&lt; imports &gt;&gt;</span>
<span class="kn">import</span> <span class="nn">leo.core.leoGlobals</span> <span class="kn">as</span> <span class="nn">g</span>

<span class="kn">import</span> <span class="nn">asynchat</span>
<span class="kn">import</span> <span class="nn">asyncore</span>
<span class="kn">import</span> <span class="nn">cgi</span>

<span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">http.server</span>
    <span class="n">SimpleHTTPRequestHandler</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">SimpleHTTPRequestHandler</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">SimpleHTTPServer</span>
    <span class="n">SimpleHTTPRequestHandler</span> <span class="o">=</span> <span class="n">SimpleHTTPServer</span><span class="o">.</span><span class="n">SimpleHTTPRequestHandler</span>
    
<span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">io</span>
    <span class="n">StringIO</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span>
    <span class="n">BytesIO</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">io</span>
    <span class="kn">import</span> <span class="nn">StringIO</span> <span class="c"># Python 2.x</span>
    <span class="n">StringIO</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span>
    <span class="n">BytesIO</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span>

<span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">urllib.parse</span> <span class="kn">as</span> <span class="nn">urlparse</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">urlparse</span>


<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">select</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">xml.sax.saxutils</span> <span class="kn">import</span> <span class="n">quoteattr</span>
<span class="c">#@-&lt;&lt; imports &gt;&gt;</span>
<span class="c">#@+&lt;&lt; version history &gt;&gt;</span>
<span class="c">#@+node:ekr.20050328104558: ** &lt;&lt; version history &gt;&gt;</span>
<span class="c">#@@killcolor</span>
<span class="c">#@+at</span>
<span class="c"># </span>
<span class="c"># 0.93 EKR:</span>
<span class="c">#     - Added &#39;version history&#39; section.</span>
<span class="c">#     - Removed vestigial sections.</span>
<span class="c">#     - Changed docstring to mention @string rst_http_attributename = &#39;rst_http_attribute&#39;</span>
<span class="c"># 0.93 EKR: Added init function.</span>
<span class="c"># But http was in the Plugins menu because the rst3 plugin imports it.</span>
<span class="c"># The fix was to the plugins manager, not this plugin or rst3.</span>
<span class="c"># 0.94 BWM</span>
<span class="c"># 0.95 EKR: Changed headline from applyConfiguration to getConfiguration to match name of method.</span>
<span class="c"># 0.96 EKR: suppress all pychecker warnings.</span>
<span class="c"># 0.97 EKR:</span>
<span class="c"># - Call g.signon in init so users can see that the plugin is enabled.</span>
<span class="c"># - Removed the old @page line from the docstring.</span>
<span class="c"># 0.98 EKR: Handle unicode characters properly.</span>
<span class="c"># 0.99 Lauri Ojansivu &lt;lauri.ojansivu@gmail.com&gt;: Many change for better html generation.</span>
<span class="c">#@-&lt;&lt; version history &gt;&gt;</span>

<span class="n">sockets_to_close</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c">#@+&lt;&lt; config &gt;&gt;</span>
<span class="c">#@+node:bwmulder.20050326191345: ** &lt;&lt; config &gt;&gt;</span>
<div class="viewcode-block" id="config"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.config">[docs]</a><span class="k">class</span> <span class="nc">config</span><span class="p">:</span>
    <span class="n">http_active</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">http_timeout</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">http_port</span> <span class="o">=</span> <span class="mi">8080</span>
    <span class="n">rst2_http_attributename</span> <span class="o">=</span> <span class="s">&#39;rst_http_attribute&#39;</span>
<span class="c">#@-&lt;&lt; config &gt;&gt;</span>
<span class="c">#@+others</span>
<span class="c">#@+node:ekr.20110522152535.18250: ** top-level</span>
<span class="c">#@+node:ekr.20060830091349: *3* init</span></div>
<div class="viewcode-block" id="init"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.init">[docs]</a><span class="k">def</span> <span class="nf">init</span> <span class="p">():</span>

    <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">registerHandler</span><span class="p">(</span><span class="s">&quot;open2&quot;</span><span class="p">,</span> <span class="n">onFileOpen</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">getGlobalConfiguration</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">http_active</span><span class="p">:</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="n">s</span><span class="o">=</span><span class="n">Server</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">config</span><span class="o">.</span><span class="n">http_port</span><span class="p">,</span><span class="n">RequestHandler</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;mod_http port already in use&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>
                    
            <span class="n">asyncore</span><span class="o">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">a_read</span>
            <span class="n">g</span><span class="o">.</span><span class="n">registerHandler</span><span class="p">(</span><span class="s">&quot;idle&quot;</span><span class="p">,</span> <span class="n">plugin_wrapper</span><span class="p">)</span>
    
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;http serving enabled on port </span><span class="si">%s</span><span class="s">, version </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">config</span><span class="o">.</span><span class="n">http_port</span><span class="p">,</span> <span class="n">__version__</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;purple&quot;</span><span class="p">)</span>
        
    <span class="n">g</span><span class="o">.</span><span class="n">plugin_signon</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">True</span>
<span class="c">#@+node:bwmulder.20050326191345.1: *3* onFileOpen</span></div>
<div class="viewcode-block" id="onFileOpen"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.onFileOpen">[docs]</a><span class="k">def</span> <span class="nf">onFileOpen</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">keywords</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">keywords</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;new_c&quot;</span><span class="p">)</span>
    
    <span class="c"># g.trace(&#39;c&#39;,repr(c))</span>

    <span class="n">wasactive</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">http_active</span>
    <span class="n">getConfiguration</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">http_active</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">wasactive</span><span class="p">:</span> <span class="c"># Ok for unit testing:</span>

        <span class="n">s</span><span class="o">=</span><span class="n">Server</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">config</span><span class="o">.</span><span class="n">http_port</span><span class="p">,</span><span class="n">RequestHandler</span><span class="p">)</span>
        <span class="n">asyncore</span><span class="o">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">a_read</span>
        <span class="n">g</span><span class="o">.</span><span class="n">registerHandler</span><span class="p">(</span><span class="s">&quot;idle&quot;</span><span class="p">,</span> <span class="n">plugin_wrapper</span><span class="p">)</span>

        <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;http serving enabled on port </span><span class="si">%s</span><span class="s">, version </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">config</span><span class="o">.</span><span class="n">http_port</span><span class="p">,</span> <span class="n">__version__</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;purple&quot;</span><span class="p">)</span>
<span class="c">#@+node:ekr.20110522152535.18252: *3* escape</span></div>
<div class="viewcode-block" id="escape"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.escape">[docs]</a><span class="k">def</span> <span class="nf">escape</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&amp;&#39;</span><span class="p">,</span> <span class="s">&quot;&amp;amp;&quot;</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s">&quot;&amp;lt;&quot;</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s">&quot;&amp;gt;&quot;</span><span class="p">)</span>

    <span class="c"># is there a more elegant way to do this?</span>
    <span class="c"># Replaces blanks with &amp;nbsp; id they are in</span>
    <span class="c"># the beginning of the line.</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">blank</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">blank</span><span class="p">):</span>
            <span class="n">resultchars</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">startline</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">char</span> <span class="o">==</span> <span class="n">blank</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">startline</span><span class="p">:</span>
                        <span class="n">resultchars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&amp;nbsp;&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">resultchars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">startline</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="n">resultchars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">resultchars</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;br /&gt;&#39;</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span> <span class="s">&#39;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&#39;</span><span class="p">)</span>
    <span class="c"># 8/9/2007</span>
    <span class="c"># s = g.toEncodedString(s,encoding=browser_encoding,reportErrors=False)</span>
    <span class="c"># StringIO.write(self, s)</span>
    <span class="k">return</span> <span class="n">s</span>
<span class="c">#@+node:bwmulder.20050322132919: ** rst_related</span>
<span class="c">#@+node:bwmulder.20050322134325: *3* reconstruct_html_from_attrs</span></div>
<div class="viewcode-block" id="reconstruct_html_from_attrs"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.reconstruct_html_from_attrs">[docs]</a><span class="k">def</span> <span class="nf">reconstruct_html_from_attrs</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">how_much_to_ignore</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given an attribute, reconstruct the html for this node.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">stack</span> <span class="o">=</span> <span class="n">attrs</span>
    <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">result</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">how_much_to_ignore</span><span class="p">:]</span>
    <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>
    <span class="n">stack</span> <span class="o">=</span> <span class="n">attrs</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">how_much_to_ignore</span><span class="p">):</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">result</span>
<span class="c">#@+node:bwmulder.20050322132919.2: *3* get_http_attribute</span></div>
<div class="viewcode-block" id="get_http_attribute"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.get_http_attribute">[docs]</a><span class="k">def</span> <span class="nf">get_http_attribute</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="n">vnode</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">vnode</span><span class="p">,</span> <span class="s">&#39;unknownAttributes&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">vnode</span><span class="o">.</span><span class="n">unknownAttributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">rst2_http_attributename</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="c">#@+node:bwmulder.20050322133050: *3* set_http_attribute</span></div>
<div class="viewcode-block" id="set_http_attribute"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.set_http_attribute">[docs]</a><span class="k">def</span> <span class="nf">set_http_attribute</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="n">vnode</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">vnode</span><span class="p">,</span> <span class="s">&#39;unknownAttributes&#39;</span><span class="p">):</span>
        <span class="n">vnode</span><span class="o">.</span><span class="n">unknownAttributes</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">rst2_http_attributename</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vnode</span><span class="o">.</span><span class="n">unknownAttributes</span> <span class="o">=</span> <span class="p">{</span><span class="n">config</span><span class="o">.</span><span class="n">rst2_http_attributename</span><span class="p">:</span> <span class="n">value</span><span class="p">}</span>

<span class="c">#@+node:bwmulder.20050322135114: *3* node_reference</span></div>
<div class="viewcode-block" id="node_reference"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.node_reference">[docs]</a><span class="k">def</span> <span class="nf">node_reference</span><span class="p">(</span><span class="n">vnode</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Use by the rst2 plugin.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">leo_interface</span><span class="p">()</span><span class="o">.</span><span class="n">node_reference</span><span class="p">(</span><span class="n">vnode</span><span class="p">)</span>
<span class="c">#@+node:EKR.20040517080250.4: ** class delayedSocketStream</span></div>
<div class="viewcode-block" id="delayedSocketStream"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.delayedSocketStream">[docs]</a><span class="k">class</span> <span class="nc">delayedSocketStream</span><span class="p">(</span><span class="n">asyncore</span><span class="o">.</span><span class="n">dispatcher_with_send</span><span class="p">):</span>
    <span class="c">#@+others</span>
    <span class="c">#@+node:EKR.20040517080250.5: *3* __init__</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sock</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_map</span> <span class="o">=</span> <span class="n">asyncore</span><span class="o">.</span><span class="n">socket_map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">=</span><span class="n">sock</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">setblocking</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="o">=</span><span class="mi">1</span>   <span class="c"># compatibility with SocketServer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c">#@+node:EKR.20040517080250.6: *3* write</span>
<div class="viewcode-block" id="delayedSocketStream.write"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.delayedSocketStream.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="c">#@+node:EKR.20040517080250.7: *3* initiate_sending</span></div>
<div class="viewcode-block" id="delayedSocketStream.initiate_sending"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.delayedSocketStream.initiate_sending">[docs]</a>    <span class="k">def</span> <span class="nf">initiate_sending</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="c">### Create a bytes string.</span>
        <span class="n">aList</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_buffer</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">aList</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_socket</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">setblocking</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connected</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">getpeername</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="c"># The addr isn&#39;t crucial</span>
            <span class="k">pass</span>
    <span class="c">#@+node:EKR.20040517080250.8: *3* handle_read</span></div>
<div class="viewcode-block" id="delayedSocketStream.handle_read"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.delayedSocketStream.handle_read">[docs]</a>    <span class="k">def</span> <span class="nf">handle_read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="c">#@+node:EKR.20040517080250.9: *3* writable</span></div>
<div class="viewcode-block" id="delayedSocketStream.writable"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.delayedSocketStream.writable">[docs]</a>    <span class="k">def</span> <span class="nf">writable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connected</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_buffer</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">sockets_to_close</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="c">#@-others</span>
<span class="c">#@+node:EKR.20040517080250.10: ** class nodeNotFound</span></div></div>
<div class="viewcode-block" id="nodeNotFound"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.nodeNotFound">[docs]</a><span class="k">class</span> <span class="nc">nodeNotFound</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>
<span class="c">#@+node:bwmulder.20061014153544: ** class noLeoNodePath</span></div>
<div class="viewcode-block" id="noLeoNodePath"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.noLeoNodePath">[docs]</a><span class="k">class</span> <span class="nc">noLeoNodePath</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Raised if the path can not be converted a filename and a series of numbers.</span>
<span class="sd">    Most likely a reference to a picture.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>
<span class="c">#@+node:EKR.20040517080250.20: ** class leo_interface</span></div>
<div class="viewcode-block" id="leo_interface"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.leo_interface">[docs]</a><span class="k">class</span> <span class="nc">leo_interface</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c">#@+others</span>
    <span class="c">#@+node:EKR.20040517080250.21: *3* add_leo_links</span>
<div class="viewcode-block" id="leo_interface.add_leo_links"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.leo_interface.add_leo_links">[docs]</a>    <span class="k">def</span> <span class="nf">add_leo_links</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a node &#39;node&#39;, add links to:</span>
<span class="sd">            The next sibling, if any.</span>
<span class="sd">            the next node.</span>
<span class="sd">            the parent.</span>
<span class="sd">            The children, if any.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Collecting the navigational links.</span>
        <span class="k">if</span> <span class="n">node</span><span class="p">:</span>
            <span class="n">nodename</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">h</span>
            <span class="n">threadNext</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">threadNext</span><span class="p">()</span>
            <span class="n">sibling</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;p&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="n">children</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">firstChild</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">firstChild</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">firstChild</span><span class="p">:</span>
                <span class="n">child</span> <span class="o">=</span> <span class="n">firstChild</span>
                <span class="k">while</span> <span class="n">child</span><span class="p">:</span>
                    <span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                    <span class="n">child</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">threadNext</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_leo_reference</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">threadNext</span><span class="p">,</span>  <span class="s">&quot;next&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;br /&gt;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sibling</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_leo_reference</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">sibling</span><span class="p">,</span> <span class="s">&quot;next Sibling&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;br /&gt;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_href</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="s">&quot;Top level&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_leo_reference</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="s">&quot;Up&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;br /&gt;&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&lt;/p&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c"># top level</span>
            <span class="n">child</span> <span class="o">=</span> <span class="n">window</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">rootVnode</span><span class="p">()</span>
            <span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">child</span><span class="p">]</span>
            <span class="nb">next</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="k">while</span> <span class="nb">next</span><span class="p">:</span>
                <span class="n">child</span> <span class="o">=</span> <span class="nb">next</span>
                <span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                <span class="nb">next</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="n">nodename</span> <span class="o">=</span> <span class="n">window</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">children</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&lt;h2&gt;&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;Children of &quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">escape</span><span class="p">(</span><span class="n">nodename</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;/h2&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;ol&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;li&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">create_leo_reference</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">child</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;/li&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;/ol&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="c">#@+node:EKR.20040517080250.22: *3* create_href</span></div>
<div class="viewcode-block" id="leo_interface.create_href"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.leo_interface.create_href">[docs]</a>    <span class="k">def</span> <span class="nf">create_href</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">href</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>

        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;&lt;a href=&quot;</span><span class="si">%s</span><span class="s">&quot;&gt;&#39;</span> <span class="o">%</span> <span class="n">href</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">escape</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;/a&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

    <span class="c">#@+node:bwmulder.20050319134815: *3* create_leo_h_reference</span></div>
<div class="viewcode-block" id="leo_interface.create_leo_h_reference"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.leo_interface.create_leo_h_reference">[docs]</a>    <span class="k">def</span> <span class="nf">create_leo_h_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">window</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">()]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_leo_nameparts</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="n">href</span> <span class="o">=</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">href</span>
    <span class="c">#@+node:EKR.20040517080250.23: *3* create_leo_reference</span></div>
<div class="viewcode-block" id="leo_interface.create_leo_reference"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.leo_interface.create_leo_reference">[docs]</a>    <span class="k">def</span> <span class="nf">create_leo_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a reference to &#39;node&#39; in &#39;window&#39;, displaying &#39;text&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">href</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_leo_h_reference</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_href</span><span class="p">(</span><span class="n">href</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    <span class="c">#@+node:EKR.20040517080250.24: *3* format_leo_node</span></div>
<div class="viewcode-block" id="leo_interface.format_leo_node"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.leo_interface.format_leo_node">[docs]</a>    <span class="k">def</span> <span class="nf">format_leo_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a node &#39;node&#39;, return the contents of that node as html text.</span>

<span class="sd">        Include some navigational references too</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">node</span><span class="p">:</span>
            <span class="n">headString</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">h</span>
            <span class="n">bodyString</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">b</span>
            <span class="n">format_info</span> <span class="o">=</span> <span class="n">get_http_attribute</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">headString</span><span class="p">,</span> <span class="n">bodyString</span> <span class="o">=</span> <span class="s">&quot;Top level&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span>
            <span class="n">format_info</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Strict//EN&quot; </span>
<span class="s">    &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd&quot;&gt; </span>
<span class="s">    &lt;html&gt; </span>
<span class="s">    &lt;head&gt; </span>
<span class="s">    &lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=UTF-8&quot; /&gt; </span>
<span class="s">    &lt;title&gt;&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">escape</span><span class="p">(</span><span class="n">window</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;:&quot;</span> <span class="o">+</span> <span class="n">headString</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;/title&gt;</span><span class="se">\n</span><span class="s">&lt;/head&gt;</span><span class="se">\n</span><span class="s">&lt;body&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="c"># write navigation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_leo_links</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="c"># write path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_path</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;hr /&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span> <span class="c"># horizontal rule</span>
        <span class="c"># f.write(&#39;&lt;span style=&quot;font-family: monospace;&quot;&gt;&#39;)</span>
        <span class="k">if</span> <span class="n">format_info</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;p&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="n">html_lines</span> <span class="o">=</span> <span class="n">reconstruct_html_from_attrs</span><span class="p">(</span><span class="n">format_info</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">html_lines</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&lt;/p&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">bodyString</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;p&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">escape</span><span class="p">(</span><span class="n">bodyString</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">bodyString</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&lt;/p&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="c"># f.write(&quot;&lt;/span&gt;\n&quot;)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&lt;/body&gt;</span><span class="se">\n</span><span class="s">&lt;/html&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span>
    <span class="c">#@+node:EKR.20040517080250.25: *3* get_leo_nameparts</span></div>
<div class="viewcode-block" id="leo_interface.get_leo_nameparts"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.leo_interface.get_leo_nameparts">[docs]</a>    <span class="k">def</span> <span class="nf">get_leo_nameparts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a &#39;node&#39;, construct a list of sibling numbers to get to that node.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">node</span><span class="p">:</span>
            <span class="n">cnode</span> <span class="o">=</span> <span class="n">node</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">cnode</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>
            <span class="k">while</span> <span class="n">parent</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">child</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">firstChild</span><span class="p">()</span>
                <span class="k">while</span> <span class="n">child</span> <span class="o">!=</span> <span class="n">cnode</span><span class="p">:</span>
                    <span class="n">child</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="n">cnode</span> <span class="o">=</span> <span class="n">parent</span>
                <span class="n">parent</span> <span class="o">=</span> <span class="n">cnode</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">previous</span> <span class="o">=</span> <span class="n">cnode</span><span class="o">.</span><span class="n">back</span><span class="p">()</span>
            <span class="k">while</span> <span class="n">previous</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">previous</span> <span class="o">=</span> <span class="n">previous</span><span class="o">.</span><span class="n">back</span><span class="p">()</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">result</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="c">#@+node:EKR.20040517080250.26: *3* get_leo_node</span></div>
<div class="viewcode-block" id="leo_interface.get_leo_node"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.leo_interface.get_leo_node">[docs]</a>    <span class="k">def</span> <span class="nf">get_leo_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        given a path of the form:</span>
<span class="sd">            [&lt;short filename&gt;,&lt;number1&gt;,&lt;number2&gt;...&lt;numbern&gt;]</span>
<span class="sd">            identify the leo node which is in that file, and,</span>
<span class="sd">            from top to bottom, is the &lt;number1&gt; child of the topmost</span>
<span class="sd">            node, the &lt;number2&gt; child of that node, and so on.</span>

<span class="sd">            Return None if that node can not be identified that way.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Identify the window</span>
        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">windowList</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">w</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">()</span> <span class="o">==</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>

        <span class="n">node</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">rootVnode</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">nodeNotFound</span>
            <span class="c"># go to the i&#39;th child for each path element.</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">path</span><span class="p">[</span><span class="mi">2</span><span class="p">:]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="c"># No Leo path</span>
                    <span class="k">raise</span> <span class="n">noLeoNodePath</span>
                <span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">nthChild</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">node</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">nodeNotFound</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">w</span><span class="p">,</span> <span class="n">node</span>
    <span class="c">#@+node:EKR.20040517080250.27: *3* get_leo_windowlist</span></div>
<div class="viewcode-block" id="leo_interface.get_leo_windowlist"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.leo_interface.get_leo_windowlist">[docs]</a>    <span class="k">def</span> <span class="nf">get_leo_windowlist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;title&gt;ROOT for LEO HTTP plugin&lt;/title&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;h2&gt;Windowlist&lt;/h2&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;hr /&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span> <span class="c"># horizontal rule</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;ul&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span> <span class="c"># get the singleton application instance.</span>
        <span class="n">windows</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">windowList</span> <span class="c"># get the list of all open frames.</span>
        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">windows</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;li&gt;&quot;</span><span class="p">)</span>
            <span class="n">shortfilename</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">()</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;&lt;a href=&quot;</span><span class="si">%s</span><span class="s">&quot;&gt;&#39;</span> <span class="o">%</span> <span class="n">shortfilename</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;file name: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">shortfilename</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;/a&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;/li&gt;&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;/ul&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;hr /&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span>
    <span class="c">#@+node:bwmulder.20050319135316: *3* node_reference</span></div>
<div class="viewcode-block" id="leo_interface.node_reference"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.leo_interface.node_reference">[docs]</a>    <span class="k">def</span> <span class="nf">node_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vnode</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a position p, return the name of the node.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># 1. Find the root</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">vnode</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">parent</span><span class="p">:</span>
            <span class="n">root</span> <span class="o">=</span> <span class="n">parent</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>

        <span class="k">while</span> <span class="n">root</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">_back</span><span class="p">:</span>
            <span class="n">root</span><span class="o">.</span><span class="n">moveToBack</span><span class="p">()</span>

        <span class="c"># 2. Return the window</span>
        <span class="n">window</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">windowList</span> <span class="k">if</span> <span class="n">w</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">rootVnode</span><span class="p">()</span><span class="o">.</span><span class="n">v</span> <span class="o">==</span> <span class="n">root</span><span class="o">.</span><span class="n">v</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_leo_h_reference</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">vnode</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="c">#@+node:bwmulder.20050322224921: *3* send_head</span></div>
<div class="viewcode-block" id="leo_interface.send_head"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.leo_interface.send_head">[docs]</a>    <span class="k">def</span> <span class="nf">send_head</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Common code for GET and HEAD commands.</span>

<span class="sd">         This sends the response code and MIME headers.</span>

<span class="sd">         Return value is either a file object (which has to be copied</span>
<span class="sd">         to the outputfile by the caller unless the command was HEAD,</span>
<span class="sd">         and must be closed by the caller under all circumstances), or</span>
<span class="sd">         None, in which case the caller has nothing further to do.</span>

<span class="sd">         &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_leo_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;_&#39;</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">leo_actions</span><span class="o">.</span><span class="n">get_response</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;favicon.ico&#39;</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">leo_actions</span><span class="o">.</span><span class="n">get_favicon</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">path</span> <span class="o">==</span> <span class="s">&#39;/&#39;</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_leo_windowlist</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">window</span><span class="p">,</span> <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_leo_node</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">window</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="s">&quot;File not found&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="bp">None</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_leo_node</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">nodeNotFound</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="s">&quot;Node not found&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">None</span>
                <span class="k">except</span> <span class="n">noLeoNodePath</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;No Leo node path:&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                    <span class="c"># Is there something better we can do here?</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="s">&quot;Node not found&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">None</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_response</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&quot;Content-type&quot;</span><span class="p">,</span> <span class="s">&quot;text/html&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_header</span><span class="p">(</span><span class="s">&quot;Content-Length&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">end_headers</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">f</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">traceback</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="k">raise</span>

    <span class="c">#@+node:EKR.20040517080250.30: *3* split_leo_path</span></div>
<div class="viewcode-block" id="leo_interface.split_leo_path"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.leo_interface.split_leo_path">[docs]</a>    <span class="k">def</span> <span class="nf">split_leo_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A leo node is represented by a string of the form:</span>
<span class="sd">            &lt;number1&gt;_&lt;number2&gt;...&lt;numbern&gt;,</span>
<span class="sd">        where &lt;number&gt; is the number of sibling of the node.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="s">&#39;/&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;/&#39;</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
    <span class="c">#@+node:EKR.20040517080250.28: *3* write_path</span></div>
<div class="viewcode-block" id="leo_interface.write_path"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.leo_interface.write_path">[docs]</a>    <span class="k">def</span> <span class="nf">write_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">node</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>
        <span class="n">result</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">result2</span> <span class="o">=</span> <span class="n">result</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">result2</span><span class="p">:</span>
                <span class="n">result2</span> <span class="o">=</span> <span class="s">&#39; / &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result2</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;p&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;br /&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">escape</span><span class="p">(</span><span class="n">result2</span><span class="p">))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;br /&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;/p&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;h2&gt;&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">escape</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&lt;/h2&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="c">#@-others</span>
<span class="c">#@+node:EKR.20040517080250.13: ** class RequestHandler</span></div></div>
<div class="viewcode-block" id="RequestHandler"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.RequestHandler">[docs]</a><span class="k">class</span> <span class="nc">RequestHandler</span><span class="p">(</span>
    <span class="n">leo_interface</span><span class="p">,</span>
    <span class="n">asynchat</span><span class="o">.</span><span class="n">async_chat</span><span class="p">,</span>
    <span class="n">SimpleHTTPRequestHandler</span>
<span class="p">):</span>
    <span class="c">#@+others</span>
    <span class="c">#@+node:EKR.20040517080250.14: *3* __init__</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">conn</span><span class="p">,</span><span class="n">addr</span><span class="p">,</span><span class="n">server</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">leo_actions</span> <span class="o">=</span> <span class="n">LeoActions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        
        <span class="n">asynchat</span><span class="o">.</span><span class="n">async_chat</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">conn</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">client_address</span><span class="o">=</span><span class="n">addr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">=</span><span class="n">conn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">=</span><span class="n">server</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span> <span class="o">=</span> <span class="n">delayedSocketStream</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="p">)</span>
        
        <span class="c"># Sets the terminator. When it is received, this means that the</span>
        <span class="c"># http request is complete, control will be passed to self.found_terminator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">term</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\r\n\r\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_terminator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span> <span class="c">###</span>
        
        <span class="c">### Set self.use_encoding and self.encoding.</span>
        <span class="c">### This is used by asyn_chat.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_encoding</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="s">&#39;utf-8&#39;</span>
    <span class="c">#@+node:EKR.20040517080250.15: *3* copyfile</span>
<div class="viewcode-block" id="RequestHandler.copyfile"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.RequestHandler.copyfile">[docs]</a>    <span class="k">def</span> <span class="nf">copyfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">outputfile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy all data between two file objects.</span>

<span class="sd">        The SOURCE argument is a file object open for reading</span>
<span class="sd">        (or anything with a read() method) and the DESTINATION</span>
<span class="sd">        argument is a file object open for writing (or</span>
<span class="sd">        anything with a write() method).</span>

<span class="sd">        The only reason for overriding this would be to change</span>
<span class="sd">        the block size or perhaps to replace newlines by CRLF</span>
<span class="sd">        -- note however that this the default server uses this</span>
<span class="sd">        to copy binary data as well.</span>
<span class="sd">         &quot;&quot;&quot;</span>

        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">outputfile</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="c">#@+node:EKR.20040517080250.16: *3* log_message</span></div>
<div class="viewcode-block" id="RequestHandler.log_message"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.RequestHandler.log_message">[docs]</a>    <span class="k">def</span> <span class="nf">log_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Log an arbitrary message.</span>

<span class="sd">         This is used by all other logging functions.  Override</span>
<span class="sd">         it if you have specific logging wishes.</span>

<span class="sd">         The first argument, FORMAT, is a format string for the</span>
<span class="sd">         message to be logged.  If the format string contains</span>
<span class="sd">         any % escapes requiring parameters, they should be</span>
<span class="sd">         specified as subsequent arguments (it&#39;s just like</span>
<span class="sd">         printf!).</span>

<span class="sd">         The client host and current date/time are prefixed to</span>
<span class="sd">         every message.</span>

<span class="sd">         &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> - - [</span><span class="si">%s</span><span class="s">] </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">address_string</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_date_time_string</span><span class="p">(),</span>
            <span class="n">format</span><span class="o">%</span><span class="n">args</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="c">#@+node:EKR.20040517080250.17: *3* collect_incoming_data</span></div>
<div class="viewcode-block" id="RequestHandler.collect_incoming_data"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.RequestHandler.collect_incoming_data">[docs]</a>    <span class="k">def</span> <span class="nf">collect_incoming_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Collects the data arriving on the connexion&quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="c">#@+node:EKR.20040517080250.18: *3* prepare_POST</span></div>
<div class="viewcode-block" id="RequestHandler.prepare_POST"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.RequestHandler.prepare_POST">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_POST</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;Prepare to read the request body&quot;&quot;&quot;</span>

        <span class="n">bytesToRead</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="s">&#39;content-length&#39;</span><span class="p">))</span>
        
        <span class="c"># set terminator to length (will read bytesToRead bytes)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_terminator</span><span class="p">(</span><span class="n">bytesToRead</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">=</span><span class="n">StringIO</span><span class="p">()</span>

        <span class="c"># control will be passed to a new found_terminator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">found_terminator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">handle_post_data</span>
    <span class="c">#@+node:EKR.20040517080250.19: *3* handle_post_data</span></div>
<div class="viewcode-block" id="RequestHandler.handle_post_data"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.RequestHandler.handle_post_data">[docs]</a>    <span class="k">def</span> <span class="nf">handle_post_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called when a POST request body has been read&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">=</span><span class="n">StringIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_POST</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
    <span class="c">#@+node:EKR.20040517080250.31: *3* do_GET</span></div>
<div class="viewcode-block" id="RequestHandler.do_GET"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.RequestHandler.do_GET">[docs]</a>    <span class="k">def</span> <span class="nf">do_GET</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Begins serving a GET request&quot;&quot;&quot;</span>

        <span class="c"># nothing more to do before handle_data()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handle_data</span><span class="p">()</span>
    <span class="c">#@+node:EKR.20040517080250.32: *3* do_POST</span></div>
<div class="viewcode-block" id="RequestHandler.do_POST"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.RequestHandler.do_POST">[docs]</a>    <span class="k">def</span> <span class="nf">do_POST</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;Begins serving a POST request. The request data must be readable</span>
<span class="sd">         on a file-like object called self.rfile&quot;&quot;&quot;</span>

        <span class="n">ctype</span><span class="p">,</span> <span class="n">pdict</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">.</span><span class="n">parse_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="s">&#39;content-type&#39;</span><span class="p">))</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="s">&#39;content-length&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ctype</span> <span class="o">==</span> <span class="s">&#39;multipart/form-data&#39;</span><span class="p">:</span>
            <span class="n">query</span><span class="o">=</span><span class="n">cgi</span><span class="o">.</span><span class="n">parse_multipart</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="p">,</span> <span class="n">pdict</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ctype</span> <span class="o">==</span> <span class="s">&#39;application/x-www-form-urlencoded&#39;</span><span class="p">:</span>
            <span class="n">qs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
            <span class="n">query</span><span class="o">=</span><span class="n">cgi</span><span class="o">.</span><span class="n">parse_qs</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="n">keep_blank_values</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>                   <span class="c"># Unknown content-type</span>
        <span class="c"># some browsers send 2 more bytes...</span>
        <span class="p">[</span><span class="n">ready_to_read</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">]</span><span class="o">=</span><span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">],[],[],</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ready_to_read</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">QUERY</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handle_data</span><span class="p">()</span>
    <span class="c">#@+node:EKR.20040517080250.33: *3* query</span></div>
<div class="viewcode-block" id="RequestHandler.query"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.RequestHandler.query">[docs]</a>    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parsedQuery</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;Returns the QUERY dictionary, similar to the result of cgi.parse_qs</span>
<span class="sd">         except that :</span>
<span class="sd">         - if the key ends with [], returns the value (a Python list)</span>
<span class="sd">         - if not, returns a string, empty if the list is empty, or with the</span>
<span class="sd">         first value in the list&quot;&quot;&quot;</span>

        <span class="n">res</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">parsedQuery</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">value</span><span class="o">=</span><span class="n">parsedQuery</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="c"># a Python list</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;[]&quot;</span><span class="p">):</span>
                <span class="n">res</span><span class="p">[</span><span class="n">item</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]]</span><span class="o">=</span><span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">res</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">=</span><span class="s">&#39;&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">res</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">=</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">res</span>
    <span class="c">#@+node:EKR.20040517080250.34: *3* handle_data</span></div>
<div class="viewcode-block" id="RequestHandler.handle_data"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.RequestHandler.handle_data">[docs]</a>    <span class="k">def</span> <span class="nf">handle_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Class to override&quot;&quot;&quot;</span>

        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_head</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20110522152535.18254: *3* handle_read_event (NEW)</span></div>
<div class="viewcode-block" id="RequestHandler.handle_read_event"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.RequestHandler.handle_read_event">[docs]</a>    <span class="k">def</span> <span class="nf">handle_read_event</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="sd">&#39;&#39;&#39;Over-ride SimpleHTTPRequestHandler.handle_read_event.&#39;&#39;&#39;</span>

        <span class="n">asynchat</span><span class="o">.</span><span class="n">async_chat</span><span class="o">.</span><span class="n">handle_read_event</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="c">#@+node:EKR.20040517080250.35: *3* handle_request_line (aka found_terminator)</span></div>
<div class="viewcode-block" id="RequestHandler.handle_request_line"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.RequestHandler.handle_request_line">[docs]</a>    <span class="k">def</span> <span class="nf">handle_request_line</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called when the http request line and headers have been received&quot;&quot;&quot;</span>

        <span class="c"># prepare attributes needed in parse_request()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">=</span><span class="n">BytesIO</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_requestline</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parse_request</span><span class="p">()</span>

        <span class="c"># if there is a Query String, decodes it in a QUERY dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_without_qs</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">qs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;?&#39;</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;?&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">path_without_qs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;?&#39;</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">QUERY</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">cgi</span><span class="o">.</span><span class="n">parse_qs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qs</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span><span class="s">&#39;HEAD&#39;</span><span class="p">]:</span>
            <span class="c"># if method is GET or HEAD, call do_GET or do_HEAD and finish</span>
            <span class="n">method</span><span class="o">=</span><span class="s">&quot;do_&quot;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">method</span><span class="p">):</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">method</span><span class="p">)</span>
                <span class="n">f</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">==</span><span class="s">&quot;POST&quot;</span><span class="p">:</span>
            <span class="c"># if method is POST, call prepare_POST, don&#39;t finish before</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prepare_POST</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_error</span><span class="p">(</span><span class="mi">501</span><span class="p">,</span> <span class="s">&quot;Unsupported method (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20110522152535.18256: *3* found_terminator</span></div>
<div class="viewcode-block" id="RequestHandler.found_terminator"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.RequestHandler.found_terminator">[docs]</a>    <span class="k">def</span> <span class="nf">found_terminator</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">handle_request_line</span><span class="p">()</span>
    <span class="c">#@+node:EKR.20040517080250.36: *3* finish</span></div>
<div class="viewcode-block" id="RequestHandler.finish"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.RequestHandler.finish">[docs]</a>    <span class="k">def</span> <span class="nf">finish</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Reset terminator (required after POST method), then close&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_terminator</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">term</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">initiate_sending</span><span class="p">()</span>
        <span class="c"># self.close()</span>
    <span class="c">#@-others</span>
<span class="c">#@+node:EKR.20040517080250.37: ** class Server</span></div></div>
<div class="viewcode-block" id="Server"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.Server">[docs]</a><span class="k">class</span> <span class="nc">Server</span><span class="p">(</span><span class="n">asyncore</span><span class="o">.</span><span class="n">dispatcher</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Copied from http_server in medusa&quot;&quot;&quot;</span>
    <span class="c">#@+others</span>
    <span class="c">#@+node:EKR.20040517080250.38: *3* __init__</span>
    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="o">=</span> <span class="n">ip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="o">=</span><span class="n">handler</span>

        <span class="n">asyncore</span><span class="o">.</span><span class="n">dispatcher</span><span class="o">.</span><span class="n">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_socket</span> <span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_reuse_addr</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span> <span class="p">((</span><span class="n">ip</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>

        <span class="c"># lower this to 5 if your OS complains</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listen</span> <span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
    <span class="c">#@+node:EKR.20040517080250.39: *3* handle_accept</span>
<div class="viewcode-block" id="Server.handle_accept"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.Server.handle_accept">[docs]</a>    <span class="k">def</span> <span class="nf">handle_accept</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span> <span class="p">(</span><span class="s">&#39;warning: server accept() threw an exception&#39;</span><span class="p">,</span> <span class="s">&#39;warning&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_info</span> <span class="p">(</span><span class="s">&#39;warning: server accept() threw EWOULDBLOCK&#39;</span><span class="p">,</span> <span class="s">&#39;warning&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c"># creates an instance of the handler class to handle the request/response</span>
        <span class="c"># on the incoming connexion</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span><span class="n">addr</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span>
    <span class="c">#@-others</span>
<span class="c">#@+node:tbrown.20110930093028.34530: ** class LeoActions</span></div></div>
<div class="viewcode-block" id="LeoActions"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.LeoActions">[docs]</a><span class="k">class</span> <span class="nc">LeoActions</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A place to collect other URL based actions like saving</span>
<span class="sd">    bookmarks from the browser.  Conceptually this stuff could</span>
<span class="sd">    go in class leo_interface but putting it here for separation</span>
<span class="sd">    for now.&quot;&quot;&quot;</span>
    
    <span class="c">#@+others</span>
    <span class="c">#@+node:tbrown.20110930220448.18077: *3* __init__</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_handler</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">request_handler</span> <span class="o">=</span> <span class="n">request_handler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bookmark_unl</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">commanders</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getString</span><span class="p">(</span><span class="s">&#39;http_bookmark_unl&#39;</span><span class="p">)</span>
    <span class="c">#@+node:tbrown.20110930220448.18075: *3* add_bookmark</span>
<div class="viewcode-block" id="LeoActions.add_bookmark"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.LeoActions.add_bookmark">[docs]</a>    <span class="k">def</span> <span class="nf">add_bookmark</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the file like &#39;f&#39; that leo_interface.send_head makes</span>

<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">parsed_url</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_handler</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">parse_qs</span><span class="p">(</span><span class="n">parsed_url</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
        
        <span class="c"># print(parsed_url.query)</span>
        <span class="c"># print(query)</span>
        
        <span class="n">name</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;NO TITLE&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">query</span><span class="p">[</span><span class="s">&#39;url&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="n">c</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># outline for bookmarks</span>
        <span class="n">previous</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># previous bookmark for adding selections</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># parent node for new bookmarks</span>
        <span class="n">using_root</span> <span class="o">=</span> <span class="bp">False</span>
        
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bookmark_unl</span>
        
        <span class="c"># g.trace(path)</span>

        <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
            <span class="c"># EKR</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">unl</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
                <span class="n">unl</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            
            <span class="n">parsed</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="c"># self.bookmark_unl) # EKR</span>
            <span class="n">leo_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            
            <span class="n">c</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">openWithFileName</span><span class="p">(</span><span class="n">leo_path</span><span class="p">,</span><span class="n">old_c</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&quot;Opened &#39;</span><span class="si">%s</span><span class="s">&#39; for bookmarks&quot;</span><span class="o">%</span> <span class="n">path</span><span class="p">)</span> <span class="c"># self.bookmark_unl)</span>

                <span class="n">parsed</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">unl</span><span class="p">)</span> <span class="c"># self.bookmark_unl) # EKR</span>
                <span class="k">if</span> <span class="n">parsed</span><span class="o">.</span><span class="n">fragment</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">recursiveUNLSearch</span><span class="p">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">fragment</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;--&gt;&quot;</span><span class="p">),</span><span class="n">c</span><span class="p">)</span>
                <span class="n">parent</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">currentPosition</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">hasChildren</span><span class="p">():</span>
                    <span class="n">previous</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">getFirstChild</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&quot;Failed to open &#39;</span><span class="si">%s</span><span class="s">&#39; for bookmarks&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">bookmark_unl</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">using_root</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">commanders</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span>
            <span class="n">previous</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span>
        
        <span class="n">f</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">previous</span> <span class="ow">and</span> <span class="n">url</span> <span class="o">==</span> <span class="n">previous</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="c"># another marking of the same page, just add selection</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_bookmark_selection</span><span class="p">(</span>
                <span class="n">previous</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;selection&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>

            <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">previous</span><span class="p">)</span>  <span class="c"># required for body text redraw</span>
            <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>

            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">    &lt;body onload=&quot;setTimeout(&#39;window.close();&#39;, 350);&quot; style=&#39;font-family:mono&#39;&gt;</span>
<span class="s">    &lt;p&gt;Selection added&lt;/p&gt;&lt;/body&gt;&quot;&quot;&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">f</span>
        
        <span class="k">if</span> <span class="s">&#39;_form&#39;</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
            <span class="c"># got extra details, save to new node</span>
            
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">    &lt;body onload=&quot;setTimeout(&#39;window.close();&#39;, 350);&quot; style=&#39;font-family:mono&#39;&gt;</span>
<span class="s">    &lt;p&gt;Bookmark saved&lt;/p&gt;&lt;/body&gt;&quot;&quot;&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">using_root</span><span class="p">:</span>
                <span class="n">nd</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">insertAfter</span><span class="p">()</span>
                <span class="n">nd</span><span class="o">.</span><span class="n">moveToRoot</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nd</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">insertAsNthChild</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">pluginIsLoaded</span><span class="p">(</span><span class="s">&#39;leo.plugins.bookmarks&#39;</span><span class="p">):</span>
                <span class="n">nd</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nd</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="s">&#39;@url &#39;</span><span class="o">+</span><span class="n">name</span>
            
            <span class="n">selection</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;selection&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">selection</span><span class="p">:</span>
                <span class="n">selection</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n\n</span><span class="s">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">+</span><span class="n">selection</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&quot;&quot;&quot;&#39;</span>
            
            <span class="n">nd</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="se">\n\n</span><span class="s">Tags: </span><span class="si">%s</span><span class="se">\n\n</span><span class="si">%s</span><span class="se">\n\n</span><span class="s">Collected: </span><span class="si">%s%s</span><span class="se">\n\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">url</span><span class="p">,</span> 
                <span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;tags&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;_name&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%c</span><span class="s">&quot;</span><span class="p">),</span>
                <span class="n">selection</span><span class="p">,</span>
                <span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;description&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">nd</span><span class="p">)</span>  <span class="c"># required for body text redraw</span>
            <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">f</span>
            
        <span class="c"># send form to collect extra details</span>
        
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">    &lt;html&gt;&lt;head&gt;&lt;style&gt;</span>
<span class="s">    body {font-family:mono; font-size: 80</span><span class="si">%%</span><span class="s">;}</span>
<span class="s">    th {text-align:right}</span>
<span class="s">    &lt;/style&gt;&lt;title&gt;Leo Add Bookmark&lt;/title&gt;</span>
<span class="s">    &lt;/head&gt;&lt;body onload=&#39;document.getElementById(&quot;tags&quot;).focus();&#39;&gt;</span>
<span class="s">    &lt;form method=&#39;GET&#39; action=&#39;/_/add/bkmk/&#39;&gt;</span>
<span class="s">    &lt;input type=&#39;hidden&#39; name=&#39;_form&#39; value=&#39;1&#39;/&gt;</span>
<span class="s">    &lt;input type=&#39;hidden&#39; name=&#39;_name&#39; value=</span><span class="si">%s</span><span class="s">/&gt;</span>
<span class="s">    &lt;input type=&#39;hidden&#39; name=&#39;selection&#39; value=</span><span class="si">%s</span><span class="s">/&gt;</span>
<span class="s">    &lt;table&gt;</span>
<span class="s">    &lt;tr&gt;&lt;th&gt;Tags:&lt;/th&gt;&lt;td&gt;&lt;input id=&#39;tags&#39; name=&#39;tags&#39; size=&#39;60&#39;/&gt;(comma sep.)&lt;/td&gt;&lt;/tr&gt;</span>
<span class="s">    &lt;tr&gt;&lt;th&gt;Title:&lt;/th&gt;&lt;td&gt;&lt;input name=&#39;name&#39; value=</span><span class="si">%s</span><span class="s"> size=&#39;60&#39;/&gt;&lt;/td&gt;&lt;/tr&gt;</span>
<span class="s">    &lt;tr&gt;&lt;th&gt;URL:&lt;/th&gt;&lt;td&gt;&lt;input name=&#39;url&#39; value=</span><span class="si">%s</span><span class="s"> size=&#39;60&#39;/&gt;&lt;/td&gt;&lt;/tr&gt;</span>
<span class="s">    &lt;tr&gt;&lt;th&gt;Notes:&lt;/th&gt;&lt;td&gt;&lt;textarea name=&#39;description&#39; cols=&#39;60&#39; rows=&#39;6&#39;&gt;&lt;/textarea&gt;&lt;/td&gt;&lt;/tr&gt;</span>
<span class="s">    &lt;/table&gt;</span>
<span class="s">    &lt;input type=&#39;submit&#39; value=&#39;Save&#39;/&gt;&lt;br/&gt;</span>
<span class="s">    &lt;/form&gt;</span>
<span class="s">    &lt;/body&gt;&lt;/html&gt;&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">quoteattr</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> 
                  <span class="n">quoteattr</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;selection&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]),</span> 
                  <span class="n">quoteattr</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> 
                  <span class="n">quoteattr</span><span class="p">(</span><span class="n">url</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">f</span>
    <span class="c">#@+node:tbrown.20111002082827.18325: *3* add_bookmark_selection</span></div>
<div class="viewcode-block" id="LeoActions.add_bookmark_selection"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.LeoActions.add_bookmark_selection">[docs]</a>    <span class="k">def</span> <span class="nf">add_bookmark_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Insert the selected text into the bookmark node,</span>
<span class="sd">        after any earlier selections but before the users comments.</span>
<span class="sd">        </span>
<span class="sd">            http://example.com/</span>
<span class="sd">            </span>
<span class="sd">            Tags: tags, are here</span>
<span class="sd">            </span>
<span class="sd">            Full title of the page</span>
<span class="sd">            </span>
<span class="sd">            Collected: timestamp</span>
<span class="sd">            </span>
<span class="sd">            &quot;&quot;&quot;</span>
<span class="sd">            The first saved selection</span>
<span class="sd">            &quot;&quot;&quot;</span>
<span class="sd">            </span>
<span class="sd">            &quot;&quot;&quot;</span>
<span class="sd">            The second saved selection</span>
<span class="sd">            &quot;&quot;&quot;</span>
<span class="sd">            </span>
<span class="sd">            Users comments</span>

<span class="sd">        i.e. just above the &quot;Users comments&quot; line.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="c"># g.trace(node.h)</span>
        
        <span class="n">b</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">insert</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;&quot;&quot;&quot;&#39;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="s">&#39;&quot;&quot;&quot;&#39;</span><span class="p">]</span>
        
        <span class="n">collected</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">tri_quotes</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">b</span><span class="p">):</span>
            
            <span class="k">if</span> <span class="n">collected</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;Collected: &#39;</span><span class="p">):</span>
                <span class="n">collected</span> <span class="o">=</span> <span class="n">n</span>
            
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="s">&#39;&quot;&quot;&quot;&#39;</span><span class="p">:</span>
                <span class="n">tri_quotes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">collected</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># not a regularly formatted text, just append</span>
            <span class="n">b</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">insert</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">tri_quotes</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c"># insert after the last balanced pair of tri quotes</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">tri_quotes</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">tri_quotes</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">tri_quotes</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">b</span><span class="p">[</span><span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">insert</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c"># found Collected but no tri quotes</span>
            <span class="n">b</span><span class="p">[</span><span class="n">collected</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">collected</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">insert</span>

        <span class="n">node</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span>
    <span class="c">#@+node:tbrown.20111005093154.17683: *3* get_favicon</span></div>
<div class="viewcode-block" id="LeoActions.get_favicon"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.LeoActions.get_favicon">[docs]</a>    <span class="k">def</span> <span class="nf">get_favicon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_join</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">computeLeoDir</span><span class="p">(),</span><span class="s">&#39;Icons&#39;</span><span class="p">,</span><span class="s">&#39;LeoApp16.ico&#39;</span><span class="p">)</span>
            
        <span class="c"># g.trace(g.os_path_exists(path),path)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
            <span class="c"># f.write(open(path).read())</span>
            <span class="n">f2</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">f</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="c">#@+node:tbrown.20110930220448.18076: *3* get_response</span></div>
<div class="viewcode-block" id="LeoActions.get_response"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.LeoActions.get_response">[docs]</a>    <span class="k">def</span> <span class="nf">get_response</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the file like &#39;f&#39; that leo_interface.send_head makes&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_handler</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;/_/add/bkmk/&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_bookmark</span><span class="p">()</span>
            
        <span class="n">f</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;Unknown URL in LeoActions.get_response()&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span>
    <span class="c">#@-others</span>
    
<span class="c">#@+node:EKR.20040517080250.40: ** poll</span></div></div>
<div class="viewcode-block" id="poll"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.poll">[docs]</a><span class="k">def</span> <span class="nf">poll</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">sockets_to_close</span>
    <span class="nb">map</span> <span class="o">=</span> <span class="n">asyncore</span><span class="o">.</span><span class="n">socket_map</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">map</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">w</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">e</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">fd</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">readable</span><span class="p">():</span>
                <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">writable</span><span class="p">():</span>
                <span class="n">w</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sockets_to_close</span><span class="p">:</span> <span class="c"># Set by writeable()</span>
            <span class="k">break</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sockets_to_close</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">sockets_to_close</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="p">[]</span> <span class="o">==</span> <span class="n">r</span> <span class="o">==</span> <span class="n">w</span> <span class="o">==</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c">#@+&lt;&lt; try r, w, e = select.select &gt;&gt;</span>
        <span class="c">#@+node:EKR.20040517080250.41: *3* &lt;&lt; try r, w, e = select.select &gt;&gt;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">select</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="c"># if err[0] != EINTR:</span>
                <span class="c"># raise</span>
            <span class="c"># else:</span>
                <span class="c"># return False</span>
            <span class="k">return</span> <span class="bp">False</span> <span class="c"># EKR: EINTR is undefined.</span>
        <span class="c">#@-&lt;&lt; try r, w, e = select.select &gt;&gt;</span>
    <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
        <span class="c">#@+&lt;&lt; asyncore.read(map.get(fd)) &gt;&gt;</span>
        <span class="c">#@+node:EKR.20040517080250.42: *3* &lt;&lt; asyncore.read(map.get(fd)) &gt;&gt;</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="nb">map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">asyncore</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="c">#@-&lt;&lt; asyncore.read(map.get(fd)) &gt;&gt;</span>
    <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="n">w</span><span class="p">:</span>
        <span class="c">#@+&lt;&lt; asyncore.write(map.get(fd)) &gt;&gt;</span>
        <span class="c">#@+node:EKR.20040517080250.43: *3* &lt;&lt; asyncore.write(map.get(fd)) &gt;&gt;</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="nb">map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">asyncore</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="c">#@-&lt;&lt; asyncore.write(map.get(fd)) &gt;&gt;</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
<span class="c">#@+node:EKR.20040517080250.44: ** loop</span></div>
<div class="viewcode-block" id="loop"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.loop">[docs]</a><span class="k">def</span> <span class="nf">loop</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">use_poll</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">map</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Override the loop function of asynchore.</span>
<span class="sd">    We poll only until there is not read or</span>
<span class="sd">    write request pending.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">poll</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
<span class="c">#@+node:EKR.20040517080250.45: ** plugin_wrapper</span></div>
<div class="viewcode-block" id="plugin_wrapper"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.plugin_wrapper">[docs]</a><span class="k">def</span> <span class="nf">plugin_wrapper</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">keywords</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">killed</span><span class="p">:</span> <span class="k">return</span>

    <span class="n">first</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">while</span> <span class="n">loop</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">http_timeout</span><span class="p">):</span>
        <span class="k">pass</span>
<span class="c">#@+node:EKR.20040517080250.46: ** asynchore_overrides</span>
<span class="c">#@+node:EKR.20040517080250.47: *3* a_read</span></div>
<div class="viewcode-block" id="a_read"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.a_read">[docs]</a><span class="k">def</span> <span class="nf">a_read</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">handle_read_event</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">asyncore</span><span class="o">.</span><span class="n">ExitNow</span><span class="p">:</span>
        <span class="k">raise</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c"># g.trace(&#39;error&#39;)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">handle_error</span><span class="p">()</span>
<span class="c">#@+node:EKR.20040517080250.48: ** getConfiguration</span></div>
<div class="viewcode-block" id="getConfiguration"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.getConfiguration">[docs]</a><span class="k">def</span> <span class="nf">getConfiguration</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Called when the user opens a new file.&quot;&quot;&quot;</span>

    <span class="c"># timeout.</span>
    <span class="n">newtimeout</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getInt</span><span class="p">(</span><span class="s">&quot;http_timeout&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">newtimeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">http_timeout</span> <span class="o">=</span> <span class="n">newtimeout</span>  <span class="o">/</span> <span class="mf">1000.0</span>
    
    <span class="c"># port.</span>
    <span class="n">newport</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getInt</span><span class="p">(</span><span class="s">&quot;http_port&quot;</span><span class="p">)</span> 
    <span class="k">if</span> <span class="n">newport</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">http_port</span> <span class="o">=</span> <span class="n">newport</span>

    <span class="c"># active.</span>
    <span class="n">newactive</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getBool</span><span class="p">(</span><span class="s">&quot;http_active&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">newactive</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">http_active</span> <span class="o">=</span> <span class="n">newactive</span>

    <span class="c"># attribute name.</span>
    <span class="n">new_rst2_http_attributename</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getString</span><span class="p">(</span><span class="s">&quot;rst2_http_attributename&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">new_rst2_http_attributename</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">rst2_http_attributename</span> <span class="o">=</span> <span class="n">new_rst2_http_attributename</span>
<span class="c">#@+node:tbrown.20111005140148.18223: ** getGlobalConfiguration</span></div>
<div class="viewcode-block" id="getGlobalConfiguration"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.mod_http.getGlobalConfiguration">[docs]</a><span class="k">def</span> <span class="nf">getGlobalConfiguration</span><span class="p">():</span>

    <span class="sd">&quot;&quot;&quot;read config.&quot;&quot;&quot;</span>

    <span class="c"># timeout.</span>
    <span class="n">newtimeout</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getInt</span><span class="p">(</span><span class="s">&quot;http_timeout&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">newtimeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">http_timeout</span> <span class="o">=</span> <span class="n">newtimeout</span>  <span class="o">/</span> <span class="mf">1000.0</span>
    
    <span class="c"># port.</span>
    <span class="n">newport</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getInt</span><span class="p">(</span><span class="s">&quot;http_port&quot;</span><span class="p">)</span> 
    <span class="k">if</span> <span class="n">newport</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">http_port</span> <span class="o">=</span> <span class="n">newport</span>

    <span class="c"># active.</span>
    <span class="n">newactive</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getBool</span><span class="p">(</span><span class="s">&quot;http_active&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">newactive</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">http_active</span> <span class="o">=</span> <span class="n">newactive</span>

    <span class="c"># attribute name.</span>
    <span class="n">new_rst2_http_attributename</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getString</span><span class="p">(</span><span class="s">&quot;rst2_http_attributename&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">new_rst2_http_attributename</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">rst2_http_attributename</span> <span class="o">=</span> <span class="n">new_rst2_http_attributename</span>
<span class="c">#@-others</span>
<span class="c">#@-leo</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Leo API 4.11dev documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Ed K. Ream.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
  </body>
</html>