<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>leo.plugins.rst3 &mdash; Leo API 4.11dev documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '4.11dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Leo API 4.11dev documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Leo API 4.11dev documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for leo.plugins.rst3</h1><div class="highlight"><pre>
<span class="c">#@+leo-ver=5-thin</span>
<span class="c">#@+node:ekr.20050805162550: * @file rst3.py</span>
<span class="c">#@+&lt;&lt; docstring &gt;&gt;</span>
<span class="c">#@+node:ekr.20050805162550.1: ** &lt;&lt; docstring &gt;&gt;</span>
<span class="sd">&#39;&#39;&#39; Creates output files from Leo outlines containing rST (reStructuredText)</span>
<span class="sd">markup. This plugin has been superseded by Leo&#39;s core rst3 command.</span>

<span class="sd">This is a powerful plugin with many options.  The full documentation is at:</span>
<span class="sd">http://webpages.charter.net/edreamleo/rstplugin3.html</span>

<span class="sd">The rst3 plugin adds the Write Restructured Text command to Leo&#39;s Edit menu. This</span>
<span class="sd">command searches the selected outline looking for **rst root nodes** whose</span>
<span class="sd">headline have the form @rst &lt;filename&gt;. The plugin then creates the named file</span>
<span class="sd">in various ways depending which rst3 options are in effect.</span>

<span class="sd">By default, the rst3 plugin creates rST headings automatically from outlines, so</span>
<span class="sd">the higher-level nodes in the outline correspond to higher-level sections in the</span>
<span class="sd">output. Creating rST headings automatically eliminates one of the most tedious</span>
<span class="sd">chores associated with rST markup.</span>

<span class="sd">To use this plugin effectively, Python&#39;s docutils module must be installed. The</span>
<span class="sd">rst3 plugin will use the SilverCity syntax coloring package if it installed.</span>

<span class="sd">This plugin sends .htm, .html or .tex files to the docutils module for further</span>
<span class="sd">processing. Docutils generates HTML files or LaTeX files depending on the file&#39;s</span>
<span class="sd">extension. HTML files generated by docutils refer to three .css (cascading style</span>
<span class="sd">sheet) files that should exist in the same directory as the generated HTML file.</span>
<span class="sd">You can control the formatting of the HTML file by altering these .css files.</span>

<span class="sd">rst3 options control most aspects of this plugin&#39;s operations. You can set</span>
<span class="sd">options in @settings trees, in headlines and in body text. There are too many</span>
<span class="sd">details to discuss here. For full details see:</span>
<span class="sd">http://webpages.charter.net/edreamleo/rstplugin3.html</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="c">#@-&lt;&lt; docstring &gt;&gt;</span>

<span class="c"># Original rst code by Josef Dalcolmo:</span>
<span class="c"># contributed under the same licensed as Leo.py itself.</span>

<span class="c"># rst3.py based on rst2.py v2.4.</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">generators</span> <span class="c"># To make this plugin work with Python 2.2.</span>

<span class="n">bwm_file</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">bwm_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;bwm_file&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>

<span class="n">__version__</span> <span class="o">=</span> <span class="s">&#39;1.23&#39;</span>

<span class="c">#@+&lt;&lt; imports &gt;&gt;</span>
<span class="c">#@+node:ekr.20050805162550.2: ** &lt;&lt; imports &gt;&gt;</span>
<span class="kn">import</span> <span class="nn">leo.core.leoGlobals</span> <span class="kn">as</span> <span class="nn">g</span>
<span class="kn">import</span> <span class="nn">leo.core.leoTest</span> <span class="kn">as</span> <span class="nn">leoTest</span>

<span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">html.parser</span> <span class="kn">as</span> <span class="nn">HTMLParser</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">HTMLParser</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pprint</span>

<span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">io</span>
    <span class="n">StringIO</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">StringIO</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="c"># Make sure the present directory in in sys.path.</span>
<span class="nb">dir</span><span class="p">,</span><span class="n">junk</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
<span class="k">if</span> <span class="nb">dir</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">mod_http</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">mod_http</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">docutils</span>
    <span class="kn">import</span> <span class="nn">docutils.parsers.rst</span>
    <span class="kn">import</span> <span class="nn">docutils.core</span>
    <span class="kn">import</span> <span class="nn">docutils.io</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="c"># This message given in init.</span>
    <span class="c"># g.pr(&#39;rst3 plugin: can not import docutils&#39;)</span>
    <span class="n">docutils</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">SilverCity</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">if</span> <span class="s">&#39;--silent&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">batchMode</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;rst3 plugin: SilverCity not loaded&#39;</span><span class="p">)</span>
    <span class="n">SilverCity</span> <span class="o">=</span> <span class="bp">None</span>
<span class="c">#@-&lt;&lt; imports &gt;&gt;</span>
<span class="c">#@+&lt;&lt; change log &gt;&gt;</span>
<span class="c">#@+node:ekr.20050805162550.3: ** &lt;&lt; change log &gt;&gt;</span>
<span class="c">#@@nocolor</span>
<span class="c">#@@color</span>
<span class="c">#@+at</span>
<span class="c"># </span>
<span class="c"># 1.14 EKR: processTopTree ignores @rst- nodes so rst3 button works properly when such nodes are selected.</span>
<span class="c"># 1.15 EKR: added support for @rst-doc-only and doc_only_mode.  An important new feature.</span>
<span class="c"># 1.16 EKR: fixed bug that ignored whatever followed @space or @doc in doc-only mode.</span>
<span class="c"># 1.17 EKR:</span>
<span class="c"># - Support show_headlines in doc-only mode.</span>
<span class="c"># - .txt files are now written to default_path directory, just like special files.</span>
<span class="c"># 1.18 BWM: Added support for mod_scripting plugin.</span>
<span class="c"># 1.19 EKR: Fixed crash that happens when invoked from menu.</span>
<span class="c"># 1.20 EKR: Registers the write-restructured-text command.</span>
<span class="c"># 1.21 EKR: Added rst3-publish-argv-for-missing-stylesheets setting.</span>
<span class="c"># 1.22 EKR: Fixed bug that caused the plugin not to find default.css.</span>
<span class="c"># 1.23 EKR: Use g.makeAllNonExistentDirectories instead of os.mkdir.</span>
<span class="c">#@-&lt;&lt; change log &gt;&gt;</span>
<span class="c">#@+&lt;&lt; to do &gt;&gt;</span>
<span class="c">#@+node:ekr.20050806162146: ** &lt;&lt; to do &gt;&gt;</span>
<span class="c">#@@nocolor</span>
<span class="c">#@+at</span>
<span class="c"># </span>
<span class="c"># - Specify option for the spelling of special doc parts.</span>
<span class="c">#     - The present code assumes to much about these commands.</span>
<span class="c"># </span>
<span class="c"># - Warn if option gets set twice in same vnode.</span>
<span class="c"># </span>
<span class="c"># Later or never:</span>
<span class="c">#     - show_context option.</span>
<span class="c">#     - encoding option: can override @encoding directives</span>
<span class="c">#     - Support docutils config files.</span>
<span class="c"># </span>
<span class="c">#@@c</span>

<span class="c">#@+others</span>
<span class="c">#@+node:ekr.20050804081215: *3* More options</span>
<span class="c">#@@nocolor</span>
<span class="c">#@+at</span>
<span class="c"># http://sourceforge.net/forum/message.php?msg_id=3276408</span>
<span class="c"># </span>
<span class="c"># Leo has great potential for smoothing some of the bumps</span>
<span class="c"># outside of learning the details of the markup.</span>
<span class="c"># Here is my wish list;</span>
<span class="c"># </span>
<span class="c"># (done) - Section level handling.</span>
<span class="c">#   - one of the problems with using rst comes when a new</span>
<span class="c">#     section level is inserted into a document. Leo can</span>
<span class="c">#     take care of this effortlessly, providing a correct</span>
<span class="c">#    underline character for each section heading.</span>
<span class="c"># </span>
<span class="c">#     Other than the section management, I want Leo to</span>
<span class="c">#     assume that I&#39;m writing rst, and should be rendered</span>
<span class="c">#     as-is. If I want to include some pretty Python, I put</span>
<span class="c">#     it in a ..  python-code:: block (or some such)</span>
<span class="c"># </span>
<span class="c">#     On top of this base could be built special case</span>
<span class="c">#     handling.</span>
<span class="c"># </span>
<span class="c"># - Assist in viewing rendered output</span>
<span class="c">#   - easy access to the command to render a tree to  html.</span>
<span class="c">#   - I would like an option which automatically inserted</span>
<span class="c">#     a @url node which pointed to the rendered file, or</span>
<span class="c">#     some other trick to make switching between source</span>
<span class="c">#     and output painless.</span>
<span class="c"># </span>
<span class="c"># - Assist in working with the CSS file</span>
<span class="c">#   - a CSS file is now required by docutils. A @setting</span>
<span class="c">#     could specify the file. I would like some kind of</span>
<span class="c">#     sugar which made it easy to edit the CSS file, maybe</span>
<span class="c">#     an option to create a @file node automatically,</span>
<span class="c">#     like the @url node above. Again, I want to be able</span>
<span class="c">#     to effortlessly edit the CSS and see the results.</span>
<span class="c"># </span>
<span class="c"># - The third file of interest when writing rst is the config</span>
<span class="c">#    file which controls many behaviours of the renderer.</span>
<span class="c">#    Again, some intelligence which located it, made it</span>
<span class="c">#    convenient to edit it, maybe even linked to</span>
<span class="c">#    documentation for it, would be very nice.</span>
<span class="c"># </span>
<span class="c"># (done) - I would like a setting which would save the file with the</span>
<span class="c">#   rst markup and make it easy to examine and edit.</span>
<span class="c"># </span>
<span class="c"># - On the someday/maybe list would be a @publish</span>
<span class="c">#   feature, which configured a directory to ftp the rendered</span>
<span class="c">#   file to.</span>
<span class="c">#@-others</span>
<span class="c">#@-&lt;&lt; to do &gt;&gt;</span>

<span class="n">controllers</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># For use by @button rst3 code.</span>

<span class="c">#@+others</span>
<span class="c">#@+node:ekr.20050805162550.4: ** Module level</span>
<span class="c">#@+node:ekr.20050805162550.5: *3*  init</span>
<div class="viewcode-block" id="init"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.init">[docs]</a><span class="k">def</span> <span class="nf">init</span> <span class="p">():</span>

    <span class="n">ok</span> <span class="o">=</span> <span class="n">docutils</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="c"># Ok for unit testing.</span>

    <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">registerHandler</span><span class="p">(</span><span class="s">&#39;after-create-leo-frame&#39;</span><span class="p">,</span> <span class="n">onCreate</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">plugin_signon</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;rst3 plugin not loaded: can not load docutils&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ok</span>
<span class="c">#@+node:ekr.20050805162550.6: *3* onCreate</span></div>
<div class="viewcode-block" id="onCreate"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.onCreate">[docs]</a><span class="k">def</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">keywords</span><span class="p">):</span>

    <span class="n">c</span> <span class="o">=</span> <span class="n">keywords</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;new_c&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">keywords</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;c&#39;</span><span class="p">)</span>

    <span class="c"># g.trace(&#39;(rst3 plugin)&#39;,c)</span>

    <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
        <span class="k">global</span> <span class="n">controllers</span>
        <span class="n">controllers</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">rstClass</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="c"># Warning: Do not return anything but None here!</span>
        <span class="c"># Doing so suppresses the loading of other &#39;new&#39; or &#39;open2&#39; hooks!</span>
<span class="c">#@+node:ekr.20050806101253: *3* code_block</span></div>
<div class="viewcode-block" id="code_block"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.code_block">[docs]</a><span class="k">def</span> <span class="nf">code_block</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">arguments</span><span class="p">,</span><span class="n">options</span><span class="p">,</span><span class="n">content</span><span class="p">,</span><span class="n">lineno</span><span class="p">,</span><span class="n">content_offset</span><span class="p">,</span><span class="n">block_text</span><span class="p">,</span><span class="n">state</span><span class="p">,</span><span class="n">state_machine</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Implement the code-block directive for docutils.&#39;&#39;&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">language</span> <span class="o">=</span> <span class="n">arguments</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c"># g.trace(language)</span>
        <span class="c"># See http://aspn.activestate.com/ASPN/Cookbook/Python/Recipe/252170</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">SilverCity</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">SilverCity</span><span class="p">,</span><span class="n">language</span><span class="p">)</span>
        <span class="n">generator</span> <span class="o">=</span> <span class="n">module</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span><span class="n">language</span><span class="o">+</span><span class="s">&quot;HTMLGenerator&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">generator</span><span class="p">:</span>
            <span class="n">io</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
            <span class="n">generator</span><span class="p">()</span><span class="o">.</span><span class="n">generate_html</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>
            <span class="n">html</span> <span class="o">=</span> <span class="s">&#39;&lt;div class=&quot;code-block&quot;&gt;</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s">&lt;/div&gt;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">io</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">html</span> <span class="o">=</span> <span class="s">&#39;&lt;div class=&quot;code-block&quot;&gt;</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s">&lt;/div&gt;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="s">&#39;&lt;br&gt;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="n">docutils</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">html</span><span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="s">&#39;html&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">raw</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span> <span class="c"># Return html as shown.  Lines are separated by &lt;br&gt; elements.</span>
        <span class="n">g</span><span class="o">.</span><span class="n">es_trace</span><span class="p">(</span><span class="s">&#39;exception in rst3:code_block()&#39;</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span>

<span class="c"># See http://docutils.sourceforge.net/spec/howto/rst-directives.html</span></div>
<span class="n">code_block</span><span class="o">.</span><span class="n">arguments</span> <span class="o">=</span> <span class="p">(</span>
    <span class="mi">1</span><span class="p">,</span> <span class="c"># Number of required arguments.</span>
    <span class="mi">0</span><span class="p">,</span> <span class="c"># Number of optional arguments.</span>
    <span class="mi">0</span><span class="p">)</span> <span class="c"># True if final argument may contain whitespace.</span>

<span class="c"># A mapping from option name to conversion function.</span>
<span class="k">if</span> <span class="n">docutils</span><span class="p">:</span>
    <span class="n">code_block</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;language&#39;</span><span class="p">:</span>
        <span class="n">docutils</span><span class="o">.</span><span class="n">parsers</span><span class="o">.</span><span class="n">rst</span><span class="o">.</span><span class="n">directives</span><span class="o">.</span><span class="n">unchanged</span> <span class="c"># Return the text argument, unchanged.</span>
    <span class="p">}</span>
    <span class="n">code_block</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="mi">1</span> <span class="c"># True if content is allowed.</span>

    <span class="c"># Register the directive with docutils.</span>
    <span class="n">docutils</span><span class="o">.</span><span class="n">parsers</span><span class="o">.</span><span class="n">rst</span><span class="o">.</span><span class="n">directives</span><span class="o">.</span><span class="n">register_directive</span><span class="p">(</span><span class="s">&#39;code-block&#39;</span><span class="p">,</span><span class="n">code_block</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">code_block</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c">#@+node:ekr.20090429055156.63: *3* runUnitTests</span>
<div class="viewcode-block" id="runUnitTests"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.runUnitTests">[docs]</a><span class="k">def</span> <span class="nf">runUnitTests</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>

    <span class="n">controller</span> <span class="o">=</span> <span class="n">rstClass</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">findNodeAnywhere</span><span class="p">(</span><span class="s">&#39;UnitTests&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p</span><span class="p">:</span>
        <span class="n">leoTest</span><span class="o">.</span><span class="n">doTests</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">p</span>
        <span class="p">)</span>

<span class="c">#@+node:ekr.20050805162550.39: ** html parser classes</span>
<span class="c">#@+at</span>
<span class="c"># The parser classes are used to construct the html code for nodes. The algorithm has two phases:</span>
<span class="c">#     1. In the first phase, the html code for each node is identified.</span>
<span class="c">#     2. The second phase identifies all links and checks if these links need to be modified.</span>
<span class="c"># The first phase of scanning is done by the anchor_hmlParserClass. The second phase of this algorithm is</span>
<span class="c"># done with the link_htmlParserClass.</span>
<span class="c">#@@code</span>

<span class="c">#@+&lt;&lt; class linkAnchorParserClass &gt;&gt;</span>
<span class="c">#@+node:ekr.20050805162550.40: *3*  &lt;&lt; class linkAnchorParserClass &gt;&gt; (subclass of HTMLParser.HTMLParser)</span></div>
<div class="viewcode-block" id="linkAnchorParserClass"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.linkAnchorParserClass">[docs]</a><span class="k">class</span> <span class="nc">linkAnchorParserClass</span> <span class="p">(</span><span class="n">HTMLParser</span><span class="o">.</span><span class="n">HTMLParser</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A class to recognize anchors and links in HTML documents.</span>
<span class="sd">    A special marker is the &quot;node_marker&quot; which demarkates the border between </span>
<span class="sd">    node and the next.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20050805162550.41: *4* __init__</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rst</span><span class="p">):</span>

        <span class="n">HTMLParser</span><span class="o">.</span><span class="n">HTMLParser</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="c"># Init the base class.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rst</span> <span class="o">=</span> <span class="n">rst</span>

        <span class="c"># Set ivars from options.  This works only if we don&#39;t change nodes!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_begin_marker</span>      <span class="o">=</span> <span class="n">rst</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;node_begin_marker&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_http_attributes</span>  <span class="o">=</span> <span class="n">rst</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;clear_http_attributes&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_file</span> <span class="o">=</span> <span class="n">rst</span><span class="o">.</span><span class="n">outputFileName</span>
    <span class="c">#@+node:ekr.20050805162550.42: *4* is_anchor</span>
<div class="viewcode-block" id="linkAnchorParserClass.is_anchor"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.linkAnchorParserClass.is_anchor">[docs]</a>    <span class="k">def</span> <span class="nf">is_anchor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the current tag is an anchor.</span>
<span class="sd">        Returns *all* anchors.</span>
<span class="sd">        Works with docutils 0.4</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;a&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_node_marker</span><span class="p">(</span><span class="n">attrs</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="n">tag</span> <span class="o">==</span> <span class="s">&quot;span&quot;</span>
    <span class="c">#@+node:ekr.20050805162550.43: *4* is_link</span></div>
<div class="viewcode-block" id="linkAnchorParserClass.is_link"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.linkAnchorParserClass.is_link">[docs]</a>    <span class="k">def</span> <span class="nf">is_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return True if tag, attrs is represents a link.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">tag</span> <span class="o">!=</span> <span class="s">&#39;a&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="n">result</span> <span class="o">=</span> <span class="s">&#39;href&#39;</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="c">#@+node:ekr.20050815164715: *4* is_node_marker</span></div>
<div class="viewcode-block" id="linkAnchorParserClass.is_node_marker"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.linkAnchorParserClass.is_node_marker">[docs]</a>    <span class="k">def</span> <span class="nf">is_node_marker</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">attrs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return the name of the anchor, if this is an anchor for the beginning of a node,</span>
<span class="sd">        False otherwise.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="s">&#39;id&#39;</span> <span class="ow">in</span> <span class="n">d</span> <span class="ow">and</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_begin_marker</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="c">#@-others</span>
<span class="c">#@-&lt;&lt; class linkAnchorParserClass &gt;&gt;</span>

<span class="c">#@+others</span>
<span class="c">#@+node:ekr.20050805162550.44: *3* class htmlParserClass (linkAnchorParserClass)</span></div></div>
<div class="viewcode-block" id="htmlParserClass"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.htmlParserClass">[docs]</a><span class="k">class</span> <span class="nc">htmlParserClass</span> <span class="p">(</span><span class="n">linkAnchorParserClass</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    The responsibility of the html parser is:</span>
<span class="sd">        1. Find out which html code belongs to which node.</span>
<span class="sd">        2. Keep a stack of open tags which apply to the current node.</span>
<span class="sd">        3. Keep a list of tags which should be included in the nodes, even</span>
<span class="sd">           though they might be closed.</span>
<span class="sd">           The &lt;style&gt; tag is one example of that.</span>

<span class="sd">    Later, we have to relocate inter-file links: if a reference to another location</span>
<span class="sd">    is in a file, we must change the link.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20050805162550.45: *4* __init__</span>
    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rst</span><span class="p">):</span>

        <span class="n">linkAnchorParserClass</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rst</span><span class="p">)</span> <span class="c"># Init the base class.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c"># The stack contains lists of the form:</span>
            <span class="c"># [text1, text2, previous].</span>
            <span class="c"># text1 is the opening tag</span>
            <span class="c"># text2 is the closing tag</span>
            <span class="c"># previous points to the previous stack element</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">node_marker_stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c"># self.node_marker_stack.pop() returns True for a closing</span>
        <span class="c"># tag if the opening tag identified an anchor belonging to a vnode.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">node_code</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c"># Accumulated html code.</span>
            <span class="c"># Once the hmtl code is assigned a vnode, it is deleted here.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">deleted_lines</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># Number of lines deleted in self.node_code</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">endpos_pending</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c"># Do not include self.node_code[0:self.endpos_pending] in the html code.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">last_position</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c"># Last position; we must attach html code to this node.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">last_marker</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20050805162550.46: *4* handle_starttag</span>
<div class="viewcode-block" id="htmlParserClass.handle_starttag"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.htmlParserClass.handle_starttag">[docs]</a>    <span class="k">def</span> <span class="nf">handle_starttag</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tag</span><span class="p">,</span><span class="n">attrs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        1. Find out if the current tag is an achor.</span>
<span class="sd">        2. If it is an anchor, we check if this anchor marks the beginning of a new </span>
<span class="sd">           node</span>
<span class="sd">        3. If a new node begins, then we might have to store html code for the previous</span>
<span class="sd">           node.</span>
<span class="sd">        4. In any case, put the new tag on the stack.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">is_node_marker</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_anchor</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="n">attrs</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_node_marker</span><span class="p">(</span><span class="n">attrs</span><span class="p">):</span>
            <span class="n">is_node_marker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_node_marker</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
            <span class="c"># g.trace(tag,attrs)</span>
            <span class="n">line</span><span class="p">,</span> <span class="n">column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getpos</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_position</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_code</span> <span class="p">[:]</span>
                <span class="n">lines</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">lines</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">startpos</span><span class="p">:]</span>
                <span class="k">del</span> <span class="n">lines</span> <span class="p">[</span><span class="n">line</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">deleted_lines</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
                <span class="c"># g.trace(&#39;Storing in %s...\n%s&#39; % self.last_position, lines)</span>
                <span class="n">mod_http</span><span class="o">.</span><span class="n">get_http_attribute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_position</span><span class="p">)</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                <span class="c">#@+&lt;&lt; trace the unknownAttribute &gt;&gt;</span>
                <span class="c">#@+node:ekr.20050815164715.1: *5* &lt;&lt; trace the unknownAttribute &gt;&gt;</span>
                <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;rst3: unknownAttributes[self.http_attributename]&quot;</span><span class="p">)</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;For:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_position</span><span class="p">)</span>
                    <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">mod_http</span><span class="o">.</span><span class="n">get_http_attribute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_position</span><span class="p">))</span>
                <span class="c">#@-&lt;&lt; trace the unknownAttribute &gt;&gt;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deleted_lines</span> <span class="o">&lt;</span> <span class="n">line</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_code</span> <span class="p">[:</span> <span class="n">line</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">deleted_lines</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">deleted_lines</span> <span class="o">=</span> <span class="n">line</span><span class="o">-</span><span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">endpos_pending</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c"># g.trace(&quot;rst2: handle_starttag:&quot;, tag, attrs, is_node_marker)</span>
        <span class="n">starttag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_starttag_text</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="p">[</span><span class="n">starttag</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_marker_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">is_node_marker</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050805162550.47: *4* handle_endtag</span></div>
<div class="viewcode-block" id="htmlParserClass.handle_endtag"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.htmlParserClass.handle_endtag">[docs]</a>    <span class="k">def</span> <span class="nf">handle_endtag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        1. Set the second element of the current top of stack.</span>
<span class="sd">        2. If this is the end tag for an anchor for a node,</span>
<span class="sd">           store the current stack for that node.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&lt;/&quot;</span> <span class="o">+</span> <span class="n">tag</span> <span class="o">+</span> <span class="s">&quot;&gt;&quot;</span>

        <span class="c"># g.trace(tag,g.listToString(self.stack))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">endpos_pending</span><span class="p">:</span>
            <span class="n">line</span><span class="p">,</span> <span class="n">column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getpos</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_code</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;&gt;&quot;</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">endpos_pending</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="n">is_node_marker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_marker_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">is_node_marker</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">clear_http_attributes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rst</span><span class="o">.</span><span class="n">http_map</span><span class="p">[</span><span class="n">is_node_marker</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">is_node_marker</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_marker</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bwm_file</span><span class="p">:</span> <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">bwm_file</span><span class="p">,</span> <span class="s">&quot;Handle endtag:&quot;</span><span class="p">,</span> <span class="n">is_node_marker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span>
                <span class="n">mod_http</span><span class="o">.</span><span class="n">set_http_attribute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rst</span><span class="o">.</span><span class="n">http_map</span><span class="p">[</span><span class="n">is_node_marker</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_marker</span> <span class="o">=</span> <span class="n">is_node_marker</span>
                <span class="c">#bwm: last_marker is not needed?</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="c">#@+node:ekr.20050805162550.49: *4* feed</span></div>
<div class="viewcode-block" id="htmlParserClass.feed"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.htmlParserClass.feed">[docs]</a>    <span class="k">def</span> <span class="nf">feed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>

        <span class="c"># g.trace(repr(line))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">node_code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="n">HTMLParser</span><span class="o">.</span><span class="n">HTMLParser</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span> <span class="c"># Call the base class&#39;s feed().</span>
    <span class="c">#@-others</span>
<span class="c">#@+node:ekr.20050805162550.50: *3* class anchor_htmlParserClass (linkAnchorParserClass)</span></div></div>
<div class="viewcode-block" id="anchor_htmlParserClass"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.anchor_htmlParserClass">[docs]</a><span class="k">class</span> <span class="nc">anchor_htmlParserClass</span> <span class="p">(</span><span class="n">linkAnchorParserClass</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This htmlparser does the first step of relocating: finding all the anchors within the html nodes.</span>

<span class="sd">    Each anchor is mapped to a tuple:</span>
<span class="sd">        (current_file, position).</span>

<span class="sd">    Filters out markers which mark the beginning of the html code for a node.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20050805162550.51: *4*  __init__</span>
    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rst</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="n">linkAnchorParserClass</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rst</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anchor_map</span> <span class="o">=</span> <span class="n">rst</span><span class="o">.</span><span class="n">anchor_map</span>
    <span class="c">#@+node:ekr.20050805162550.52: *4* handle_starttag</span>
<div class="viewcode-block" id="anchor_htmlParserClass.handle_starttag"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.anchor_htmlParserClass.handle_starttag">[docs]</a>    <span class="k">def</span> <span class="nf">handle_starttag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        1. Find out if the current tag is an achor.</span>
<span class="sd">        2. If the current tag is an anchor, update the mapping;</span>
<span class="sd">             anchor -&gt; (filename, p)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_anchor</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor_map</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">anchor_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_file</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
            <span class="n">simple_name</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_file</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">anchor_map</span><span class="p">[</span><span class="n">simple_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_file</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">bwm_file</span><span class="p">:</span> <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">bwm_file</span><span class="p">,</span> <span class="s">&quot;anchor(1): current_file:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_file</span><span class="p">,</span> <span class="s">&quot;position:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;Simple name:&quot;</span><span class="p">,</span> <span class="n">simple_name</span>
            <span class="c"># Not sure what to do here, exactly. Do I need to manipulate</span>
            <span class="c"># the pathname?</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;name&#39;</span> <span class="ow">or</span> <span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;span&#39;</span> <span class="ow">and</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;id&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_begin_marker</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">bwm_file</span><span class="p">:</span> <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">bwm_file</span><span class="p">,</span> <span class="s">&quot;anchor(2):&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">anchor_map</span><span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
    <span class="c">#@-others</span>
<span class="c">#@+node:ekr.20050805162550.53: *3* class link_htmlParserClass (linkAnchorParserClass)</span></div></div>
<div class="viewcode-block" id="link_htmlparserClass"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.link_htmlparserClass">[docs]</a><span class="k">class</span> <span class="nc">link_htmlparserClass</span> <span class="p">(</span><span class="n">linkAnchorParserClass</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;This html parser does the second step of relocating links:</span>
<span class="sd">    1. It scans the html code for links.</span>
<span class="sd">    2. If there is a link which links to a previously processed file</span>
<span class="sd">       then this link is changed so that it now refers to the node.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20050805162550.54: *4* __init__</span>
    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rst</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="n">linkAnchorParserClass</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rst</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anchor_map</span> <span class="o">=</span> <span class="n">rst</span><span class="o">.</span><span class="n">anchor_map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replacements</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c">#@+node:ekr.20050805162550.55: *4* handle_starttag</span>
<div class="viewcode-block" id="link_htmlparserClass.handle_starttag"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.link_htmlparserClass.handle_starttag">[docs]</a>    <span class="k">def</span> <span class="nf">handle_starttag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        1. Find out if the current tag is an achor.</span>
<span class="sd">        2. If the current tag is an anchor, update the mapping;</span>
<span class="sd">             anchor -&gt; p</span>
<span class="sd">            Update the list of replacements for the document.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">bwm_file</span><span class="p">:</span> <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">bwm_file</span><span class="p">,</span> <span class="s">&quot;Is link?&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_link</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="n">marker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_begin_marker</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;href&#39;</span><span class="p">:</span>
                <span class="n">href</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">href_parts</span> <span class="o">=</span> <span class="n">href</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;#&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">href_parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">href_a</span> <span class="o">=</span> <span class="n">href_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">href_a</span> <span class="o">=</span> <span class="n">href_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">bwm_file</span><span class="p">:</span> <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">bwm_file</span><span class="p">,</span> <span class="s">&quot;link(1):&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">href_a</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">href_a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">marker</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">href_a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor_map</span><span class="p">:</span>
                        <span class="n">href_file</span><span class="p">,</span> <span class="n">href_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor_map</span><span class="p">[</span><span class="n">href_a</span><span class="p">]</span>
                        <span class="n">http_node_ref</span> <span class="o">=</span> <span class="n">mod_http</span><span class="o">.</span><span class="n">node_reference</span><span class="p">(</span><span class="n">href_node</span><span class="p">)</span>
                        <span class="n">line</span><span class="p">,</span> <span class="n">column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getpos</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">bwm_file</span><span class="p">:</span> <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">bwm_file</span><span class="p">,</span> <span class="s">&quot;link(2):&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">href</span><span class="p">,</span> <span class="n">href_file</span><span class="p">,</span> <span class="n">http_node_ref</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">replacements</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">line</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">href</span><span class="p">,</span> <span class="n">href_file</span><span class="p">,</span> <span class="n">http_node_ref</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20050805162550.56: *4* get_replacements</span></div>
<div class="viewcode-block" id="link_htmlparserClass.get_replacements"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.link_htmlparserClass.get_replacements">[docs]</a>    <span class="k">def</span> <span class="nf">get_replacements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">replacements</span>
    <span class="c">#@-others</span>
<span class="c">#@-others</span>
<span class="c">#@+node:ekr.20050805162550.8: ** class rstClass</span></div></div>
<div class="viewcode-block" id="rstClass"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass">[docs]</a><span class="k">class</span> <span class="nc">rstClass</span><span class="p">:</span>

    <span class="sd">&#39;&#39;&#39;A class to write rst markup in Leo outlines.&#39;&#39;&#39;</span>

<span class="c">#@+at This plugin optionally stores information for the http plugin.</span>
<span class="c"># </span>
<span class="c"># Each node can have one additional attribute, with the name rst_http_attributename, which is a list.</span>
<span class="c"># </span>
<span class="c"># The first three elements are stack of tags, the rest is html code.</span>
<span class="c"># </span>
<span class="c"># [&lt;tag n start&gt;, &lt;tag n end&gt;, &lt;other stack elements&gt;, &lt;html line 1&gt;, &lt;html line 2&gt;, ...]</span>
<span class="c"># </span>
<span class="c"># &lt;other stack elements has the same structure:</span>
<span class="c">#     [&lt;tag n-1 start&gt;, &lt;tag n-1 end&gt;, &lt;other stack elements&gt;]</span>
<span class="c">#@@c</span>

    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20050805162550.9: *3*  Birth &amp; init</span>
    <span class="c">#@+node:ekr.20050805162550.10: *4*  ctor (rstClass)</span>
    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>

        <span class="k">global</span> <span class="n">SilverCity</span>

        <span class="c"># g.trace(&#39;rst3.py:rstClass&#39;,g.callers())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">c</span>
        <span class="c">#@+&lt;&lt; init ivars &gt;&gt;</span>
        <span class="c">#@+node:ekr.20050805162550.11: *5* &lt;&lt; init ivars &gt;&gt;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">silverCityWarningGiven</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># The options dictionary.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optionsDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">option_prefix</span> <span class="o">=</span> <span class="s">&#39;@rst-option&#39;</span>

        <span class="c"># Formatting...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code_block_string</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toplevel</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topNode</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_alternate_code_block</span> <span class="o">=</span> <span class="n">SilverCity</span> <span class="ow">is</span> <span class="bp">None</span>

        <span class="c"># Http support...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeNumber</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c"># All nodes are numbered so that unique anchors can be generated.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">http_map</span> <span class="o">=</span> <span class="p">{}</span> 
        <span class="c"># Keys are named hyperlink targets.  Value are positions.</span>
        <span class="c"># The targets mark the beginning of the html code specific</span>
        <span class="c"># for this position.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">anchor_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c"># Maps anchors (generated by this module) to positions</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rst3_all</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c"># Set to True by the button which processes all @rst trees.</span>

        <span class="c"># For writing.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaultEncoding</span> <span class="o">=</span> <span class="s">&#39;utf-8&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leoDirectivesList</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">globalDirectiveList</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaultEncoding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ext</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># The file extension.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputFileName</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># The name of the file being written.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># The open file being written.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="s">&#39;&#39;</span> <span class="c"># The path from any @path directive.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># The written source as a string.</span>
        <span class="c">#@-&lt;&lt; init ivars &gt;&gt;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">createDefaultOptionsDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initOptionsFromSettings</span><span class="p">()</span> <span class="c"># Still needed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initHeadlineCommands</span><span class="p">()</span> <span class="c"># Only needs to be done once.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initSingleNodeOptions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addMenu</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20050805162550.12: *4* addMenu</span>
<div class="viewcode-block" id="rstClass.addMenu"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.addMenu">[docs]</a>    <span class="k">def</span> <span class="nf">addMenu</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">editMenu</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">getMenu</span><span class="p">(</span><span class="s">&#39;Edit&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">rst3PluginCallback</span> <span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processTopTree</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">registerCommand</span><span class="p">(</span><span class="s">&#39;write-restructured-text&#39;</span><span class="p">,</span><span class="n">shortcut</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">func</span><span class="o">=</span><span class="n">rst3PluginCallback</span><span class="p">,</span><span class="n">pane</span><span class="o">=</span><span class="s">&#39;all&#39;</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="n">table</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="s">&quot;-&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
            <span class="c">### (&quot;Write Restructed Text&quot;,&quot;&quot;,rst3PluginCallback),</span>
            <span class="s">&#39;&amp;write-restructured-text&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">createMenuEntries</span><span class="p">(</span><span class="n">editMenu</span><span class="p">,</span><span class="n">table</span><span class="p">,</span><span class="n">dynamicMenu</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050813083007: *4* initHeadlineCommands</span></div>
<div class="viewcode-block" id="rstClass.initHeadlineCommands"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.initHeadlineCommands">[docs]</a>    <span class="k">def</span> <span class="nf">initHeadlineCommands</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Init the list of headline commands used by writeHeadline.&#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">headlineCommands</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;code_prefix&#39;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;doc_only_prefix&#39;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;default_path_prefix&#39;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;rst_prefix&#39;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;ignore_headline_prefix&#39;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;ignore_headlines_prefix&#39;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;ignore_node_prefix&#39;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;ignore_tree_prefix&#39;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;option_prefix&#39;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;options_prefix&#39;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;show_headline_prefix&#39;</span><span class="p">),</span>
            <span class="c"># # Suggested by Hemanth P.S.: prevent @file nodes from creating headings.</span>
            <span class="c"># self.getOption(&#39;keep_at_file_prefix&#39;),</span>
            <span class="c"># self.getOption(&#39;strip_at_file_prefix&#39;),</span>
        <span class="p">]</span>
    <span class="c">#@+node:ekr.20050813085236: *4* initSingleNodeOptions</span></div>
<div class="viewcode-block" id="rstClass.initSingleNodeOptions"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.initSingleNodeOptions">[docs]</a>    <span class="k">def</span> <span class="nf">initSingleNodeOptions</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">singleNodeOptions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s">&#39;ignore_this_headline&#39;</span><span class="p">,</span>
            <span class="s">&#39;ignore_this_node&#39;</span><span class="p">,</span>
            <span class="s">&#39;ignore_this_tree&#39;</span><span class="p">,</span>
            <span class="s">&#39;preformat_this_node&#39;</span><span class="p">,</span>
            <span class="s">&#39;show_this_headline&#39;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="c">#@+node:ekr.20050808072943: *4* munge</span></div>
<div class="viewcode-block" id="rstClass.munge"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.munge">[docs]</a>    <span class="k">def</span> <span class="nf">munge</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Convert an option name to the equivalent ivar name.&#39;&#39;&#39;</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;rst&#39;</span><span class="p">),</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;_&#39;</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">s</span>
    <span class="c">#@+node:ekr.20050812122236: *3* options...</span>
    <span class="c">#@+node:ekr.20050808064245: *4* createDefaultOptionsDict</span></div>
<div class="viewcode-block" id="rstClass.createDefaultOptionsDict"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.createDefaultOptionsDict">[docs]</a>    <span class="k">def</span> <span class="nf">createDefaultOptionsDict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># Warning: changing the names of options changes the names of the corresponding ivars.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">defaultOptionsDict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c"># Http options...</span>
            <span class="s">&#39;rst3_clear_http_attributes&#39;</span><span class="p">:</span>   <span class="bp">False</span><span class="p">,</span>
            <span class="s">&#39;rst3_http_server_support&#39;</span><span class="p">:</span>     <span class="bp">False</span><span class="p">,</span>
            <span class="s">&#39;rst3_http_attributename&#39;</span><span class="p">:</span>      <span class="s">&#39;rst_http_attribute&#39;</span><span class="p">,</span>
            <span class="s">&#39;rst3_node_begin_marker&#39;</span><span class="p">:</span>       <span class="s">&#39;http-node-marker-&#39;</span><span class="p">,</span>
            <span class="c"># Path options...</span>
            <span class="s">&#39;rst3_default_path&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="c"># New in Leo 4.4a4 # Bug fix: must be None, not &#39;&#39;.</span>
            <span class="s">&#39;rst3_stylesheet_name&#39;</span><span class="p">:</span> <span class="s">&#39;default.css&#39;</span><span class="p">,</span>
            <span class="s">&#39;rst3_stylesheet_path&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="c"># Bug fix: must be None, not &#39;&#39;.</span>
            <span class="s">&#39;rst3_publish_argv_for_missing_stylesheets&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
            <span class="c"># Global options...</span>
            <span class="s">&#39;rst3_code_block_string&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
            <span class="s">&#39;rst3_number_code_lines&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="s">&#39;rst3_underline_characters&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;&#39;#=+*^~&quot;&#39;`-:&gt;&lt;_&#39;&#39;&#39;</span><span class="p">,</span>
            <span class="s">&#39;rst3_verbose&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
            <span class="s">&#39;rst3_write_intermediate_file&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="c"># Used only if generate_rst is True.</span>
            <span class="c"># Mode options...</span>
            <span class="s">&#39;rst3_code_mode&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="c"># True: generate rst markup from @code and @doc parts.</span>
            <span class="s">&#39;rst3_doc_only_mode&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="c"># True: generate only from @doc parts.</span>
            <span class="s">&#39;rst3_generate_rst&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="c"># True: generate rst markup.  False: generate plain text.</span>
            <span class="s">&#39;rst3_generate_rst_header_comment&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                <span class="c"># True generate header comment (requires generate_rst option)</span>
            <span class="c"># Formatting options that apply to both code and rst modes....</span>
            <span class="s">&#39;rst3_show_headlines&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>  <span class="c"># Can be set by @rst-no-head headlines.</span>
            <span class="s">&#39;rst3_show_organizer_nodes&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="s">&#39;rst3_show_options_nodes&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="s">&#39;rst3_show_sections&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="s">&#39;rst3_strip_at_file_prefixes&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="s">&#39;rst3_show_doc_parts_in_rst_mode&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="c"># Formatting options that apply only to code mode.</span>
            <span class="s">&#39;rst3_show_doc_parts_as_paragraphs&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="s">&#39;rst3_show_leo_directives&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="s">&#39;rst3_show_markup_doc_parts&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="s">&#39;rst3_show_options_doc_parts&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="c"># *Names* of headline commands...</span>
            <span class="s">&#39;rst3_code_prefix&#39;</span><span class="p">:</span>             <span class="s">&#39;@rst-code&#39;</span><span class="p">,</span>     <span class="c"># Enter code mode.</span>
            <span class="s">&#39;rst3_doc_only_prefix&#39;</span><span class="p">:</span>         <span class="s">&#39;@rst-doc-only&#39;</span><span class="p">,</span> <span class="c"># Enter doc-only mode.</span>
            <span class="s">&#39;rst3_rst_prefix&#39;</span><span class="p">:</span>              <span class="s">&#39;@rst&#39;</span><span class="p">,</span>          <span class="c"># Enter rst mode.</span>
            <span class="s">&#39;rst3_ignore_headline_prefix&#39;</span><span class="p">:</span>  <span class="s">&#39;@rst-no-head&#39;</span><span class="p">,</span>
            <span class="s">&#39;rst3_ignore_headlines_prefix&#39;</span><span class="p">:</span> <span class="s">&#39;@rst-no-headlines&#39;</span><span class="p">,</span>
            <span class="s">&#39;rst3_ignore_node_prefix&#39;</span><span class="p">:</span>      <span class="s">&#39;@rst-ignore-node&#39;</span><span class="p">,</span>
            <span class="s">&#39;rst3_ignore_prefix&#39;</span><span class="p">:</span>           <span class="s">&#39;@rst-ignore&#39;</span><span class="p">,</span>
            <span class="s">&#39;rst3_ignore_tree_prefix&#39;</span><span class="p">:</span>      <span class="s">&#39;@rst-ignore-tree&#39;</span><span class="p">,</span>
            <span class="s">&#39;rst3_option_prefix&#39;</span><span class="p">:</span>           <span class="s">&#39;@rst-option&#39;</span><span class="p">,</span>
            <span class="s">&#39;rst3_options_prefix&#39;</span><span class="p">:</span>          <span class="s">&#39;@rst-options&#39;</span><span class="p">,</span>
            <span class="s">&#39;rst3_preformat_prefix&#39;</span><span class="p">:</span>        <span class="s">&#39;@rst-preformat&#39;</span><span class="p">,</span>
            <span class="s">&#39;rst3_show_headline_prefix&#39;</span><span class="p">:</span>    <span class="s">&#39;@rst-head&#39;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="c">#@+node:ekr.20050812120933: *4* dumpSettings (debugging)</span></div>
<div class="viewcode-block" id="rstClass.dumpSettings"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.dumpSettings">[docs]</a>    <span class="k">def</span> <span class="nf">dumpSettings</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optionsDict</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">keys</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;present settings...&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%20s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)))</span>
    <span class="c">#@+node:ekr.20050814134351: *4* getOption</span></div>
<div class="viewcode-block" id="rstClass.getOption"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.getOption">[docs]</a>    <span class="k">def</span> <span class="nf">getOption</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>

        <span class="n">bwm</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">bwm</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&quot;bwm: getOption self:</span><span class="si">%s</span><span class="s">, name:</span><span class="si">%s</span><span class="s">, value:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">optionsDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">optionsDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20071015110830: *4* initCodeBlockString</span></div>
<div class="viewcode-block" id="rstClass.initCodeBlockString"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.initCodeBlockString">[docs]</a>    <span class="k">def</span> <span class="nf">initCodeBlockString</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="c"># New in Leo 4.4.4: do this here, not in initWrite:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">scanAllDirectives</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">language</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;language&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">language</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">language</span> <span class="o">=</span> <span class="s">&#39;python&#39;</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">language</span> <span class="o">=</span> <span class="n">language</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">syntax</span> <span class="o">=</span> <span class="n">SilverCity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>

        <span class="c"># g.trace(&#39;language&#39;,language,&#39;language.title()&#39;,language.title(),p.h)</span>

        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;code_block_string&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">code_block_string</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">n&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">syntax</span> <span class="ow">and</span> <span class="n">language</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;python&#39;</span><span class="p">,</span><span class="s">&#39;ruby&#39;</span><span class="p">,</span><span class="s">&#39;perl&#39;</span><span class="p">,</span><span class="s">&#39;c&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">code_block_string</span> <span class="o">=</span> <span class="s">&#39;**code**:</span><span class="se">\n\n</span><span class="s">.. code-block:: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">language</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">code_block_string</span> <span class="o">=</span> <span class="s">&#39;**code**:</span><span class="se">\n\n</span><span class="s">.. class:: code</span><span class="se">\n</span><span class="s">..</span><span class="se">\n\n</span><span class="s">::</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="c">#@+node:ekr.20050807120331.1: *4* preprocessTree &amp; helpers</span></div>
<div class="viewcode-block" id="rstClass.preprocessTree"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.preprocessTree">[docs]</a>    <span class="k">def</span> <span class="nf">preprocessTree</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">root</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tnodeOptionDict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c"># Bug fix 12/4/05: must preprocess parents too.</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">parents</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preprocessNode</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">self_and_subtree</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preprocessNode</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tnodeOptionDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">printDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tnodeOptionDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20051204070141: *5* preprocessNode</span></div>
<div class="viewcode-block" id="rstClass.preprocessNode"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.preprocessNode">[docs]</a>    <span class="k">def</span> <span class="nf">preprocessNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tnodeOptionDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanNodeForOptions</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tnodeOptionDict</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
    <span class="c">#@+node:ekr.20050808072943.1: *5* parseOptionLine</span></div>
<div class="viewcode-block" id="rstClass.parseOptionLine"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.parseOptionLine">[docs]</a>    <span class="k">def</span> <span class="nf">parseOptionLine</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Parse a line containing name=val and return (name,value) or None.</span>

<span class="sd">        If no value is found, default to True.&#39;&#39;&#39;</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">):</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c"># Get name.  Names may contain &#39;-&#39; and &#39;_&#39;.</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_id</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">chars</span><span class="o">=</span><span class="s">&#39;-_&#39;</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">s</span> <span class="p">[:</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="s">&#39;=&#39;</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">s</span> <span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c"># g.trace(val)</span>
            <span class="k">return</span> <span class="n">name</span><span class="p">,</span><span class="n">val</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># g.trace(&#39;*True&#39;)</span>
            <span class="k">return</span> <span class="n">name</span><span class="p">,</span><span class="s">&#39;True&#39;</span>
    <span class="c">#@+node:ekr.20050808070018.2: *5* scanForOptionDocParts</span></div>
<div class="viewcode-block" id="rstClass.scanForOptionDocParts"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.scanForOptionDocParts">[docs]</a>    <span class="k">def</span> <span class="nf">scanForOptionDocParts</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return a dictionary containing all options from @rst-options doc parts in p.</span>
<span class="sd">        Multiple @rst-options doc parts are allowed: this code aggregates all options.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="p">;</span> <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;@rst-options&#39;</span><span class="p">,</span><span class="s">&#39;@rst-option&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">kind</span><span class="p">):</span>
                        <span class="c"># Allow options on the same line.</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">kind</span><span class="p">):]</span>
                        <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scanOption</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">line</span><span class="p">))</span>
                        <span class="c"># Add options until the end of the doc part.</span>
                        <span class="k">while</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="p">;</span> <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span> <span class="p">;</span> <span class="n">found</span> <span class="o">=</span> <span class="bp">False</span>
                            <span class="k">for</span> <span class="n">stop</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;@c&#39;</span><span class="p">,</span><span class="s">&#39;@code&#39;</span><span class="p">,</span> <span class="s">&#39;@&#39;</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">stop</span><span class="p">):</span>
                                    <span class="n">found</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">;</span> <span class="k">break</span>
                            <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
                                <span class="k">break</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scanOption</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">line</span><span class="p">))</span>
                        <span class="k">break</span>
        <span class="k">return</span> <span class="n">d</span>
    <span class="c">#@+node:ekr.20050811173750: *5* scanHeadlineForOptions</span></div>
<div class="viewcode-block" id="rstClass.scanHeadlineForOptions"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.scanHeadlineForOptions">[docs]</a>    <span class="k">def</span> <span class="nf">scanHeadlineForOptions</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return a dictionary containing the options implied by p&#39;s headline.&#39;&#39;&#39;</span>

        <span class="n">h</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">topNode</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span> <span class="c"># Don&#39;t mess with the root node.</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;option_prefix&#39;</span><span class="p">)):</span> <span class="c"># &#39;@rst-option&#39;</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">h</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">option_prefix</span><span class="p">):]</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanOption</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;options_prefix&#39;</span><span class="p">)):</span> <span class="c"># &#39;@rst-options&#39;</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanOptions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Careful: can&#39;t use g.match_word because options may have &#39;-&#39; chars.</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_id</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">chars</span><span class="o">=</span><span class="s">&#39;@-&#39;</span><span class="p">)</span>
            <span class="n">word</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">prefix</span><span class="p">,</span><span class="n">ivar</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="p">(</span><span class="s">&#39;code_prefix&#39;</span><span class="p">,</span><span class="s">&#39;code_mode&#39;</span><span class="p">,</span><span class="bp">True</span><span class="p">),</span> <span class="c"># &#39;@rst-code&#39;</span>
                <span class="p">(</span><span class="s">&#39;doc_mode_prefix&#39;</span><span class="p">,</span><span class="s">&#39;doc_only_mode&#39;</span><span class="p">,</span><span class="bp">True</span><span class="p">),</span> <span class="c"># @rst-doc-only.</span>
                <span class="p">(</span><span class="s">&#39;default_path_prefix&#39;</span><span class="p">,</span><span class="s">&#39;default_prefix&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">),</span> <span class="c"># &#39;@rst-default-path&#39;</span>
                <span class="p">(</span><span class="s">&#39;rst_prefix&#39;</span><span class="p">,</span><span class="s">&#39;code_mode&#39;</span><span class="p">,</span><span class="bp">False</span><span class="p">),</span> <span class="c"># &#39;@rst&#39;</span>
                <span class="p">(</span><span class="s">&#39;ignore_headline_prefix&#39;</span><span class="p">,</span><span class="s">&#39;ignore_this_headline&#39;</span><span class="p">,</span><span class="bp">True</span><span class="p">),</span> <span class="c"># &#39;@rst-no-head&#39;</span>
                <span class="p">(</span><span class="s">&#39;show_headline_prefix&#39;</span><span class="p">,</span><span class="s">&#39;show_this_headline&#39;</span><span class="p">,</span><span class="bp">True</span><span class="p">),</span> <span class="c"># &#39;@rst-head&#39;  </span>
                <span class="p">(</span><span class="s">&#39;ignore_headlines_prefix&#39;</span><span class="p">,</span><span class="s">&#39;show_headlines&#39;</span><span class="p">,</span><span class="bp">False</span><span class="p">),</span> <span class="c"># &#39;@rst-no-headlines&#39;</span>
                <span class="p">(</span><span class="s">&#39;ignore_prefix&#39;</span><span class="p">,</span><span class="s">&#39;ignore_this_tree&#39;</span><span class="p">,</span><span class="bp">True</span><span class="p">),</span>      <span class="c"># &#39;@rst-ignore&#39;</span>
                <span class="p">(</span><span class="s">&#39;ignore_node_prefix&#39;</span><span class="p">,</span><span class="s">&#39;ignore_this_node&#39;</span><span class="p">,</span><span class="bp">True</span><span class="p">),</span> <span class="c"># &#39;@rst-ignore-node&#39;</span>
                <span class="p">(</span><span class="s">&#39;ignore_tree_prefix&#39;</span><span class="p">,</span><span class="s">&#39;ignore_this_tree&#39;</span><span class="p">,</span><span class="bp">True</span><span class="p">),</span> <span class="c"># &#39;@rst-ignore-tree&#39;</span>
                <span class="p">(</span><span class="s">&#39;preformat_prefix&#39;</span><span class="p">,</span><span class="s">&#39;preformat_this_node&#39;</span><span class="p">,</span><span class="bp">True</span><span class="p">),</span> <span class="c"># &#39;@rst-preformat</span>
            <span class="p">):</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">prefix</span> <span class="ow">and</span> <span class="n">word</span> <span class="o">==</span> <span class="n">prefix</span><span class="p">:</span> <span class="c"># Do _not_ munge this prefix!</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span> <span class="n">ivar</span><span class="p">:</span> <span class="n">val</span> <span class="p">}</span>
                    <span class="k">if</span> <span class="n">ivar</span> <span class="o">!=</span> <span class="s">&#39;code_mode&#39;</span><span class="p">:</span>
                        <span class="n">d</span> <span class="p">[</span><span class="s">&#39;code_mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># Enter rst mode.</span>
                        <span class="n">d</span> <span class="p">[</span><span class="s">&#39;doc_only_mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="c"># Special case: Treat a bare @rst like @rst-no-head</span>
                    <span class="k">if</span> <span class="n">h</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;rst_prefix&#39;</span><span class="p">):</span>
                        <span class="n">d</span> <span class="p">[</span><span class="s">&#39;ignore_this_headline&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="c"># g.trace(repr(h),repr(prefix),ivar,d)</span>
                    <span class="k">return</span> <span class="n">d</span>

            <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@rst&#39;</span><span class="p">):</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;word&#39;</span><span class="p">,</span><span class="n">word</span><span class="p">,</span><span class="s">&#39;rst_prefix&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;rst_prefix&#39;</span><span class="p">))</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;unknown kind of @rst headline&#39;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">{}</span>
    <span class="c">#@+node:ekr.20050807120331.2: *5* scanNodeForOptions</span></div>
<div class="viewcode-block" id="rstClass.scanNodeForOptions"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.scanNodeForOptions">[docs]</a>    <span class="k">def</span> <span class="nf">scanNodeForOptions</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return a dictionary containing all the option-name:value entries in p.</span>

<span class="sd">        Such entries may arise from @rst-option or @rst-options in the headline,</span>
<span class="sd">        or from @ @rst-options doc parts.&#39;&#39;&#39;</span>

        <span class="n">h</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span>

        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanHeadlineForOptions</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="n">d2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanForOptionDocParts</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>

        <span class="c"># A fine point: body options over-ride headline options.</span>
        <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">d2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">d</span>
    <span class="c">#@+node:ekr.20050808070018: *5* scanOption</span></div>
<div class="viewcode-block" id="rstClass.scanOption"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.scanOption">[docs]</a>    <span class="k">def</span> <span class="nf">scanOption</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return { name:val } if s is a line of the form name=val.</span>
<span class="sd">        Otherwise return {}&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;..&#39;</span><span class="p">):</span> <span class="k">return</span> <span class="p">{}</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseOptionLine</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">name</span><span class="p">,</span><span class="n">val</span> <span class="o">=</span> <span class="n">data</span>
            <span class="n">fullName</span> <span class="o">=</span> <span class="s">&#39;rst3_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">munge</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fullName</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaultOptionsDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span>   <span class="n">val</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;true&#39;</span><span class="p">:</span> <span class="n">val</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">elif</span> <span class="n">val</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;false&#39;</span><span class="p">:</span> <span class="n">val</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="c"># g.trace(&#39;%24s %8s %s&#39; % (self.munge(name),val,p.h))</span>
                <span class="k">return</span> <span class="p">{</span> <span class="bp">self</span><span class="o">.</span><span class="n">munge</span><span class="p">(</span><span class="n">name</span><span class="p">):</span> <span class="n">val</span> <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;ignoring unknown option: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">))</span>
                <span class="k">return</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;bad rst3 option in </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="n">s</span><span class="p">))</span>
            <span class="k">return</span> <span class="p">{}</span>
    <span class="c">#@+node:ekr.20050808070018.1: *5* scanOptions</span></div>
<div class="viewcode-block" id="rstClass.scanOptions"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.scanOptions">[docs]</a>    <span class="k">def</span> <span class="nf">scanOptions</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return a dictionary containing all the options in s.&#39;&#39;&#39;</span>

        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="n">d2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanOption</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">d2</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">d2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">d</span>
    <span class="c">#@+node:ekr.20050808142313.28: *4* scanAllOptions &amp; helpers</span>
    <span class="c"># Once an option is seen, no other related options in ancestor nodes have any effect.</span>
</div>
<div class="viewcode-block" id="rstClass.scanAllOptions"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.scanAllOptions">[docs]</a>    <span class="k">def</span> <span class="nf">scanAllOptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Scan position p and p&#39;s ancestors looking for options,</span>
<span class="sd">        setting corresponding ivars.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initOptionsFromSettings</span><span class="p">()</span> <span class="c"># Must be done on every node.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handleSingleNodeOptions</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">singleNodeOptions</span><span class="p">[:]</span> <span class="c"># Suppress inheritance of single-node options.</span>

        <span class="c"># g.trace(&#39;-&#39;*20)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">self_and_parents</span><span class="p">():</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tnodeOptionDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">,{})</span>
            <span class="c"># g.trace(p.h,d)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">ivar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">munge</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ivar</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                    <span class="n">seen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ivar</span><span class="p">)</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">setOption</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

        <span class="c"># self.dumpSettings()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rst3_all</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setOption</span><span class="p">(</span><span class="s">&quot;generate_rst&quot;</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="s">&quot;rst3_all&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setOption</span><span class="p">(</span><span class="s">&quot;generate_rst_header_comment&quot;</span><span class="p">,</span><span class="bp">True</span><span class="p">,</span> <span class="s">&quot;rst3_all&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setOption</span><span class="p">(</span><span class="s">&quot;http_server_support&quot;</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="s">&quot;rst3_all&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setOption</span><span class="p">(</span><span class="s">&quot;write_intermediate_file&quot;</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="s">&quot;rst3_all&quot;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050805162550.13: *5* initOptionsFromSettings</span></div>
<div class="viewcode-block" id="rstClass.initOptionsFromSettings"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.initOptionsFromSettings">[docs]</a>    <span class="k">def</span> <span class="nf">initOptionsFromSettings</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaultOptionsDict</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">keys</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">getter</span><span class="p">,</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getBool</span><span class="p">,</span><span class="s">&#39;@bool&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getString</span><span class="p">,</span><span class="s">&#39;@string&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">,</span><span class="s">&#39;default&#39;</span><span class="p">),</span>
            <span class="p">):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">getter</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;default&#39;</span> <span class="ow">or</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">setOption</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="s">&#39;initOptionsFromSettings&#39;</span><span class="p">)</span>
                    <span class="k">break</span>
        <span class="c"># Special case.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;http_server_support&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">mod_http</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;No http_server_support: can not import mod_http plugin&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setOption</span><span class="p">(</span><span class="s">&#39;http_server_support&#39;</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050810103731: *5* handleSingleNodeOptions</span></div>
<div class="viewcode-block" id="rstClass.handleSingleNodeOptions"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.handleSingleNodeOptions">[docs]</a>    <span class="k">def</span> <span class="nf">handleSingleNodeOptions</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Init the settings of single-node options from the tnodeOptionsDict.</span>

<span class="sd">        All such options default to False.&#39;&#39;&#39;</span>

        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tnodeOptionDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">,</span> <span class="p">{}</span> <span class="p">)</span>

        <span class="k">for</span> <span class="n">ivar</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">singleNodeOptions</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ivar</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
            <span class="c">#g.trace(&#39;%24s %8s %s&#39; % (ivar,val,p.h))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setOption</span><span class="p">(</span><span class="n">ivar</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

    <span class="c">#@+node:ekr.20050811135526: *4* setOption</span></div>
<div class="viewcode-block" id="rstClass.setOption"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.setOption">[docs]</a>    <span class="k">def</span> <span class="nf">setOption</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">tag</span><span class="p">):</span>

        <span class="n">ivar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">munge</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="n">bwm</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">bwm</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">optionsDict</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">ivar</span><span class="p">):</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;init </span><span class="si">%24s</span><span class="s"> </span><span class="si">%20s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ivar</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">optionsDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ivar</span><span class="p">)</span> <span class="o">!=</span> <span class="n">val</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;set  </span><span class="si">%24s</span><span class="s"> </span><span class="si">%20s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ivar</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">optionsDict</span> <span class="p">[</span><span class="n">ivar</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
    <span class="c">#@+node:ekr.20050809074827: *3* write methods</span>
    <span class="c">#@+node:ekr.20050809082854: *4*  Top-level write code</span>
    <span class="c">#@+node:ekr.20050809075309: *5* initWrite</span></div>
<div class="viewcode-block" id="rstClass.initWrite"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.initWrite">[docs]</a>    <span class="k">def</span> <span class="nf">initWrite</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initOptionsFromSettings</span><span class="p">()</span> <span class="c"># Still needed.</span>

        <span class="c"># Set the encoding from any parent @encoding directive.</span>
        <span class="c"># This can be overridden by @rst-option encoding=whatever.</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">scanAllDirectives</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;encoding&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaultEncoding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;path&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>

        <span class="c"># g.trace(&#39;path:&#39;,self.path)</span>
    <span class="c">#@+node:ekr.20050809080925: *5* writeNormalTree</span></div>
<div class="viewcode-block" id="rstClass.writeNormalTree"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.writeNormalTree">[docs]</a>    <span class="k">def</span> <span class="nf">writeNormalTree</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initWrite</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="c"># Always write to a string first.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeTree</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stringOutput</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>

        <span class="c"># Copy to a file if requested.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">toString</span><span class="p">:</span>
            <span class="c"># Comput the output file name *after* calling writeTree.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputFileName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computeOutputFileName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputFileName</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputFileName</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stringOutput</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">True</span>
    <span class="c">#@+node:ekr.20051121102358: *5* processTopTree</span></div>
<div class="viewcode-block" id="rstClass.processTopTree"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.processTopTree">[docs]</a>    <span class="k">def</span> <span class="nf">processTopTree</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">justOneFile</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">current</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">current</span><span class="o">.</span><span class="n">self_and_parents</span><span class="p">():</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span>
            <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@rst&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">h</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@rst-&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">processTree</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">ext</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">justOneFile</span><span class="o">=</span><span class="n">justOneFile</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processTree</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="n">ext</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">justOneFile</span><span class="o">=</span><span class="n">justOneFile</span><span class="p">)</span>

        <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&#39;done&#39;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050805162550.17: *5* processTree</span></div>
<div class="viewcode-block" id="rstClass.processTree"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.processTree">[docs]</a>    <span class="k">def</span> <span class="nf">processTree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">ext</span><span class="p">,</span><span class="n">toString</span><span class="p">,</span><span class="n">justOneFile</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Process all @rst nodes in a tree.&#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">preprocessTree</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">found</span> <span class="o">=</span> <span class="bp">False</span> <span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">stringOutput</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="p">;</span> <span class="n">after</span><span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">nodeAfterTree</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">after</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;@rst&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputFileName</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputFileName</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFileName</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;-&#39;</span><span class="p">)</span> <span class="ow">or</span>
                    <span class="p">(</span><span class="n">toString</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFileName</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">toplevel</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">level</span><span class="p">()</span> <span class="c"># Define toplevel separately for each rst file.</span>
                    <span class="k">if</span> <span class="n">toString</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ext</span> <span class="o">=</span> <span class="n">ext</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ext</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputFileName</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="c"># g.trace(&#39;ext&#39;,self.ext,self.outputFileName)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ext</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;.htm&#39;</span><span class="p">,</span><span class="s">&#39;.html&#39;</span><span class="p">,</span><span class="s">&#39;.tex&#39;</span><span class="p">,</span><span class="s">&#39;.pdf&#39;</span><span class="p">):</span>
                        <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">writeSpecialTree</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="n">toString</span><span class="p">,</span><span class="n">justOneFile</span><span class="o">=</span><span class="n">justOneFile</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">writeNormalTree</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="n">toString</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">scanAllOptions</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="c"># Restore the top-level verbose setting.</span>
                    <span class="k">if</span> <span class="n">toString</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">stringOutput</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputFileName</span><span class="p">)</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;No @rst nodes in selected tree&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span><span class="p">,</span><span class="bp">None</span>
    <span class="c">#@+node:ekr.20050805162550.21: *5* writeSpecialTree</span></div>
<div class="viewcode-block" id="rstClass.writeSpecialTree"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.writeSpecialTree">[docs]</a>    <span class="k">def</span> <span class="nf">writeSpecialTree</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">toString</span><span class="p">,</span><span class="n">justOneFile</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="n">isHtml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ext</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;.html&#39;</span><span class="p">,</span><span class="s">&#39;.htm&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">isHtml</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">SilverCity</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">silverCityWarningGiven</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">silverCityWarningGiven</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;SilverCity not present so no syntax highlighting&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initWrite</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="c"># was ,encoding=g.choose(isHtml,&#39;utf-8&#39;,&#39;iso-8859-1&#39;))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeTree</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">toString</span><span class="p">:</span>
            <span class="c"># Compute this here for use by intermediate file.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputFileName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computeOutputFileName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputFileName</span><span class="p">)</span>

            <span class="c"># Create the directory if it doesn&#39;t exist.</span>
            <span class="n">theDir</span><span class="p">,</span> <span class="n">junk</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputFileName</span><span class="p">)</span>
            <span class="n">theDir</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">os_path_finalize</span><span class="p">(</span><span class="n">theDir</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">theDir</span><span class="p">):</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">makeAllNonExistentDirectories</span><span class="p">(</span><span class="n">theDir</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">force</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;did not create:&#39;</span><span class="p">,</span><span class="n">theDir</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">False</span>

            <span class="c"># if not os.access(theDir,os.F_OK):</span>
                <span class="c"># os.mkdir(theDir)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;write_intermediate_file&#39;</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFileName</span> <span class="o">+</span> <span class="s">&#39;.txt&#39;</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">writeToDocutils</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;Exception in docutils&#39;</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">isHtml</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">re</span>
                <span class="n">idxTitle</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;&lt;title&gt;&lt;/title&gt;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">idxTitle</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;&lt;h1&gt;([^&lt;]*)&lt;/h1&gt;&#39;</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
                        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;&lt;h1&gt;&lt;[^&gt;]+&gt;([^&lt;]*)&lt;/a&gt;&lt;/h1&gt;&#39;</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                        <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                            <span class="s">&#39;&lt;title&gt;&lt;/title&gt;&#39;</span><span class="p">,</span>
                            <span class="s">&#39;&lt;title&gt;</span><span class="si">%s</span><span class="s">&lt;/title&gt;&#39;</span> <span class="o">%</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="p">)</span>


            <span class="k">if</span> <span class="n">toString</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stringOutput</span> <span class="o">=</span> <span class="n">output</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># Write the file to the directory containing the .leo file.</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputFileName</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">http_endTree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputFileName</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">justOneFile</span><span class="o">=</span><span class="n">justOneFile</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ok</span>
    <span class="c">#@+node:ekr.20050809082854.1: *5* writeToDocutils (sets argv) &amp; helper</span></div>
<div class="viewcode-block" id="rstClass.writeToDocutils"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.writeToDocutils">[docs]</a>    <span class="k">def</span> <span class="nf">writeToDocutils</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Send s to docutils using the writer implied by self.ext and return the result.&#39;&#39;&#39;</span>

        <span class="n">openDirectory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">openDirectory</span>
        <span class="n">overrides</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;output_encoding&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="p">}</span>

        <span class="c"># Compute the args list if the stylesheet path does not exist.</span>
        <span class="n">styleSheetArgsDict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handleMissingStyleSheetArgs</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">ext</span><span class="p">,</span><span class="n">writer</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="p">(</span><span class="s">&#39;.html&#39;</span><span class="p">,</span><span class="s">&#39;html&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;.htm&#39;</span><span class="p">,</span><span class="s">&#39;html&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;.tex&#39;</span><span class="p">,</span><span class="s">&#39;latex&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;.pdf&#39;</span><span class="p">,</span><span class="s">&#39;leo_pdf&#39;</span><span class="p">),</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ext</span> <span class="o">==</span> <span class="n">ext</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;unknown docutils extension: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ext</span><span class="p">))</span>
            <span class="k">return</span> <span class="s">&#39;&#39;</span>

        <span class="c"># Make the stylesheet path relative to the directory containing the output file.</span>
        <span class="n">rel_stylesheet_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;stylesheet_path&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>

        <span class="c"># New in Leo 4.5: The rel_stylesheet_path is relative to the open directory.</span>
        <span class="n">stylesheet_path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">openDirectory</span><span class="p">,</span><span class="n">rel_stylesheet_path</span><span class="p">)</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span>
            <span class="n">stylesheet_path</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;stylesheet_name&#39;</span><span class="p">))</span>

        <span class="n">res</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ext</span> <span class="o">!=</span> <span class="s">&#39;.pdf&#39;</span><span class="p">:</span>
                <span class="n">overrides</span><span class="p">[</span><span class="s">&#39;stylesheet&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
                <span class="n">overrides</span><span class="p">[</span><span class="s">&#39;stylesheet_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">elif</span> <span class="n">styleSheetArgsDict</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;using publish_argv_for_missing_stylesheets&#39;</span><span class="p">,</span>
                <span class="n">styleSheetArgsDict</span><span class="p">)</span>
            <span class="n">overrides</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">styleSheetArgsDict</span><span class="p">)</span>
                <span class="c"># MWC add args to settings</span>
        <span class="k">elif</span> <span class="n">rel_stylesheet_path</span> <span class="o">==</span> <span class="n">stylesheet_path</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;stylesheet not found: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;stylesheet not found</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">:</span><span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;@path:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;open path:&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">openDirectory</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rel_stylesheet_path</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;relative path:&#39;</span><span class="p">,</span> <span class="n">rel_stylesheet_path</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># All paths now come through here.</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">docutils</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">publish_string</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
                    <span class="n">reader_name</span><span class="o">=</span><span class="s">&#39;standalone&#39;</span><span class="p">,</span>
                    <span class="n">parser_name</span><span class="o">=</span><span class="s">&#39;restructuredtext&#39;</span><span class="p">,</span>
                    <span class="n">writer_name</span><span class="o">=</span><span class="n">writer</span><span class="p">,</span>
                    <span class="n">settings_overrides</span><span class="o">=</span><span class="n">overrides</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">docutils</span><span class="o">.</span><span class="n">ApplicationError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;Error (</span><span class="si">%s</span><span class="s">): </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">error</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">res</span>
    <span class="c">#@+node:ekr.20090428082801.64: *6* handleMissingStyleSheetArgs</span></div>
<div class="viewcode-block" id="rstClass.handleMissingStyleSheetArgs"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.handleMissingStyleSheetArgs">[docs]</a>    <span class="k">def</span> <span class="nf">handleMissingStyleSheetArgs</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Parse the publish_argv_for_missing_stylesheets option,</span>
<span class="sd">        returning a dict containing the parsed args.&#39;&#39;&#39;</span>

        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;publish_argv_for_missing_stylesheets&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span> <span class="k">return</span> <span class="n">d</span>

        <span class="n">args</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">args</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">d</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="o">=</span> <span class="n">data</span>
                <span class="n">d</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;bad option: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">s</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="n">d</span>
    <span class="c">#@+node:ekr.20060525102337: *5* writeNodeToString (New in 4.4.1)</span></div>
<div class="viewcode-block" id="rstClass.writeNodeToString"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.writeNodeToString">[docs]</a>    <span class="k">def</span> <span class="nf">writeNodeToString</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">ext</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Scan p&#39;s tree (defaults to presently selected tree) looking for @rst nodes.</span>
<span class="sd">        Convert the first node found to an ouput of the type specified by ext.</span>

<span class="sd">        The @rst may or may not be followed by a filename; the filename is *ignored*,</span>
<span class="sd">        and its type does not affect ext or the output generated in any way.</span>

<span class="sd">        ext should start with a period:  .html, .tex or None (specifies rst output).</span>

<span class="sd">        Returns p, s, where p is the position of the @rst node and s is the converted text.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">current</span> <span class="o">=</span> <span class="n">p</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">current</span><span class="o">.</span><span class="n">self_and_parents</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@rst&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">processTree</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">ext</span><span class="o">=</span><span class="n">ext</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">justOneFile</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">processTree</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="n">ext</span><span class="o">=</span><span class="n">ext</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">justOneFile</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050811154552: *4* getDocPart</span></div>
<div class="viewcode-block" id="rstClass.getDocPart"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.getDocPart">[docs]</a>    <span class="k">def</span> <span class="nf">getDocPart</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>

        <span class="c"># g.trace(&#39;n&#39;,n,repr(&#39;&#39;.join(lines)))</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c">#@+&lt;&lt; Append whatever follows @doc or @space to result &gt;&gt;</span>
        <span class="c">#@+node:ekr.20060610104435: *5* &lt;&lt; Append whatever follows @doc or @space to result &gt;&gt;</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@doc&#39;</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

            <span class="c"># New in Leo 4.4.4: remove these special tags.</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;@rst-options&#39;</span><span class="p">,</span><span class="s">&#39;@rst-option&#39;</span><span class="p">,</span><span class="s">&#39;@rst-markup&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">tag</span><span class="p">):</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">tag</span><span class="p">):]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="c">#@-&lt;&lt; Append whatever follows @doc or @space to result &gt;&gt;</span>
        <span class="k">while</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">lines</span> <span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="p">;</span> <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;@code&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;@c&#39;</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">n</span><span class="p">,</span> <span class="n">result</span>
    <span class="c">#@+node:ekr.20050811102607: *4* skip_literal_block</span></div>
<div class="viewcode-block" id="rstClass.skip_literal_block"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.skip_literal_block">[docs]</a>    <span class="k">def</span> <span class="nf">skip_literal_block</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="p">;</span> <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="p">;</span> <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">indent</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

        <span class="c"># Skip lines until a non-blank line is found with same or less indent.</span>
        <span class="k">while</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="n">indent2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">isspace</span><span class="p">()</span> <span class="ow">and</span> <span class="n">indent2</span> <span class="o">&lt;=</span> <span class="n">indent</span><span class="p">:</span>
                <span class="k">break</span> <span class="c"># We will rescan lines [n]</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="c"># g.printList(result,tag=&#39;literal block&#39;)</span>
        <span class="k">return</span> <span class="n">n</span><span class="p">,</span> <span class="n">result</span>
    <span class="c">#@+node:ekr.20050811101550.1: *4* writeBody &amp; helpers</span></div>
<div class="viewcode-block" id="rstClass.writeBody"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.writeBody">[docs]</a>    <span class="k">def</span> <span class="nf">writeBody</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="c"># remove trailing cruft and split into lines.</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span> 

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;code_mode&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;show_options_doc_parts&#39;</span><span class="p">):</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handleSpecialDocParts</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="s">&#39;@rst-options&#39;</span><span class="p">,</span>
                    <span class="n">retainContents</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;show_markup_doc_parts&#39;</span><span class="p">):</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handleSpecialDocParts</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="s">&#39;@rst-markup&#39;</span><span class="p">,</span>
                    <span class="n">retainContents</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;show_leo_directives&#39;</span><span class="p">):</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">removeLeoDirectives</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handleCodeMode</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;doc_only_mode&#39;</span><span class="p">):</span>
            <span class="c"># New in version 1.15</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handleDocOnlyMode</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handleSpecialDocParts</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="s">&#39;@rst-options&#39;</span><span class="p">,</span>
                <span class="n">retainContents</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handleSpecialDocParts</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="s">&#39;@rst-markup&#39;</span><span class="p">,</span>
                <span class="n">retainContents</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;generate_rst&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;show_doc_parts_in_rst_mode&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">pass</span>  <span class="c"># original behaviour, treat as plain text</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;show_doc_parts_in_rst_mode&#39;</span><span class="p">):</span>
                <span class="c"># use value as class for content</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handleSpecialDocParts</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">retainContents</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">asClass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;show_doc_parts_in_rst_mode&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c"># option evaluates to false, cut them out</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handleSpecialDocParts</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">retainContents</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">removeLeoDirectives</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;generate_rst&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;use_alternate_code_block&#39;</span><span class="p">):</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">replaceCodeBlockDirectives</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="se">\n\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">s</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050811150541: *5* handleCodeMode &amp; helper</span></div>
<div class="viewcode-block" id="rstClass.handleCodeMode"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.handleCodeMode">[docs]</a>    <span class="k">def</span> <span class="nf">handleCodeMode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lines</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Handle the preprocessed body text in code mode as follows:</span>

<span class="sd">        - Blank lines are copied after being cleaned.</span>
<span class="sd">        - @ @rst-markup lines get copied as is.</span>
<span class="sd">        - Everything else gets put into a code-block directive.&#39;&#39;&#39;</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">code</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">lines</span> <span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="p">;</span> <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">isSpecialDocPart</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="s">&#39;@rst-markup&#39;</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;show_doc_parts_as_paragraphs&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">isSpecialDocPart</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="bp">None</span><span class="p">))</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="n">code</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">finishCodePart</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">code</span><span class="p">)</span>
                    <span class="n">code</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                <span class="n">n</span><span class="p">,</span> <span class="n">lines2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDocPart</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lines2</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">code</span><span class="p">:</span>
                <span class="k">pass</span> <span class="c"># Ignore blank lines before the first code block.</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">code</span><span class="p">:</span> <span class="c"># Start the code block.</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code_block_string</span><span class="p">)</span>
                <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="c"># Continue the code block.</span>
                <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">code</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finishCodePart</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">code</span><span class="p">)</span>
            <span class="n">code</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rstripList</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050811152104: *6* formatCodeModeLine</span></div>
<div class="viewcode-block" id="rstClass.formatCodeModeLine"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.formatCodeModeLine">[docs]</a>    <span class="k">def</span> <span class="nf">formatCodeModeLine</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">numberOption</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

        <span class="k">if</span> <span class="n">numberOption</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;</span><span class="se">\t</span><span class="si">%d</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;</span><span class="se">\t</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">s</span>
    <span class="c">#@+node:ekr.20050813155021: *6* rstripList</span></div>
<div class="viewcode-block" id="rstClass.rstripList"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.rstripList">[docs]</a>    <span class="k">def</span> <span class="nf">rstripList</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">theList</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Removed trailing blank lines from theList.&#39;&#39;&#39;</span>

        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">theList</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050813160208: *6* finishCodePart</span></div>
<div class="viewcode-block" id="rstClass.finishCodePart"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.finishCodePart">[docs]</a>    <span class="k">def</span> <span class="nf">finishCodePart</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">code</span><span class="p">):</span>

        <span class="n">numberOption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;number_code_lines&#39;</span><span class="p">)</span>
        <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rstripList</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">code</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formatCodeModeLine</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">numberOption</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20060608094815: *5* handleDocOnlyMode</span></div>
<div class="viewcode-block" id="rstClass.handleDocOnlyMode"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.handleDocOnlyMode">[docs]</a>    <span class="k">def</span> <span class="nf">handleDocOnlyMode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">lines</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Handle the preprocessed body text in doc_only mode as follows:</span>

<span class="sd">        - Blank lines are copied after being cleaned.</span>
<span class="sd">        - @ @rst-markup lines get copied as is.</span>
<span class="sd">        - All doc parts get copied.</span>
<span class="sd">        - All code parts are ignored.&#39;&#39;&#39;</span>

        <span class="n">ignore</span>              <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;ignore_this_headline&#39;</span><span class="p">)</span>
        <span class="n">showHeadlines</span>       <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;show_headlines&#39;</span><span class="p">)</span>
        <span class="n">showThisHeadline</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;show_this_headline&#39;</span><span class="p">)</span>
        <span class="n">showOrganizers</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;show_organizer_nodes&#39;</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">lines</span> <span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="p">;</span> <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isSpecialDocPart</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="s">&#39;@rst-options&#39;</span><span class="p">):</span>
                <span class="n">n</span><span class="p">,</span> <span class="n">lines2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDocPart</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="c"># ignore.</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">isAnyDocPart</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="c"># Handle any other doc part, including @rst-markup.</span>
                <span class="n">n</span><span class="p">,</span> <span class="n">lines2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDocPart</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">lines2</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lines2</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span> <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">showHeadlines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">or</span> <span class="n">showThisHeadline</span> <span class="ow">or</span> <span class="n">showOrganizers</span> <span class="ow">or</span> <span class="n">p</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">topNode</span><span class="p">:</span>
                <span class="c"># g.trace(len(result),p.h)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeHeadlineHelper</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="c">#@+node:ekr.20060608094815.1: *5* isAnyDocPart</span></div>
<div class="viewcode-block" id="rstClass.isAnyDocPart"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.isAnyDocPart">[docs]</a>    <span class="k">def</span> <span class="nf">isAnyDocPart</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@doc&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isspace</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20050811153208: *5* isSpecialDocPart</span></div>
<div class="viewcode-block" id="rstClass.isSpecialDocPart"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.isSpecialDocPart">[docs]</a>    <span class="k">def</span> <span class="nf">isSpecialDocPart</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">kind</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return True if s is a special doc part of the indicated kind.</span>

<span class="sd">        If kind is None, return True if s is any doc part.&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">kind</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">kind</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">kind</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;@doc&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;@&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">return</span> <span class="n">result</span>
    <span class="c">#@+node:ekr.20050811163802: *5* isAnySpecialDocPart</span></div>
<div class="viewcode-block" id="rstClass.isAnySpecialDocPart"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.isAnySpecialDocPart">[docs]</a>    <span class="k">def</span> <span class="nf">isAnySpecialDocPart</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s">&#39;@rst-markup&#39;</span><span class="p">,</span>
            <span class="s">&#39;@rst-option&#39;</span><span class="p">,</span>
            <span class="s">&#39;@rst-options&#39;</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isSpecialDocPart</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">kind</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20050811105438: *5* removeLeoDirectives</span></div>
<div class="viewcode-block" id="rstClass.removeLeoDirectives"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.removeLeoDirectives">[docs]</a>    <span class="k">def</span> <span class="nf">removeLeoDirectives</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lines</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Remove all Leo directives, except within literal blocks.&#39;&#39;&#39;</span>

        <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">lines</span> <span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="p">;</span> <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;::&#39;</span><span class="p">):</span>
                <span class="n">n</span><span class="p">,</span> <span class="n">lit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_literal_block</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lit</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isAnySpecialDocPart</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">leoDirectivesList</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
                        <span class="c"># g.trace(&#39;removing %s&#39; % s)</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>
    <span class="c">#@+node:ekr.20050811105438.1: *5* handleSpecialDocParts</span></div>
<div class="viewcode-block" id="rstClass.handleSpecialDocParts"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.handleSpecialDocParts">[docs]</a>    <span class="k">def</span> <span class="nf">handleSpecialDocParts</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span><span class="n">kind</span><span class="p">,</span><span class="n">retainContents</span><span class="p">,</span><span class="n">asClass</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="c"># g.trace(kind,g.listToString(lines))</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">lines</span> <span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="p">;</span> <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;::&#39;</span><span class="p">):</span>
                <span class="n">n</span><span class="p">,</span> <span class="n">lit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_literal_block</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lit</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">isSpecialDocPart</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">kind</span><span class="p">):</span>
                <span class="n">n</span><span class="p">,</span> <span class="n">lines2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDocPart</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">retainContents</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s">&#39;&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">asClass</span><span class="p">:</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s">&#39;.. container:: &#39;</span><span class="o">+</span><span class="n">asClass</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">])</span>
                        <span class="k">if</span> <span class="s">&#39;literal&#39;</span> <span class="ow">in</span> <span class="n">asClass</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
                            <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s">&#39;  ::&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">l2</span> <span class="ow">in</span> <span class="n">lines2</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;    &#39;</span><span class="o">+</span><span class="n">l2</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lines2</span><span class="p">)</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s">&#39;&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>
    <span class="c">#@+node:ekr.20050805162550.30: *5* replaceCodeBlockDirectives</span></div>
<div class="viewcode-block" id="rstClass.replaceCodeBlockDirectives"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.replaceCodeBlockDirectives">[docs]</a>    <span class="k">def</span> <span class="nf">replaceCodeBlockDirectives</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lines</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Replace code-block directive, but not in literal blocks.&#39;&#39;&#39;</span>

        <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">lines</span> <span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="p">;</span> <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;::&#39;</span><span class="p">):</span>
                <span class="n">n</span><span class="p">,</span> <span class="n">lit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_literal_block</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lit</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;..&#39;</span><span class="p">):</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;code-block&#39;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="mi">1</span><span class="p">:</span> <span class="c"># Create a literal block to hold the code.</span>
                            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;::</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span> <span class="c"># This &#39;annotated&#39; literal block is confusing.</span>
                            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> code::</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="s">&#39;code-block&#39;</span><span class="p">):])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>
    <span class="c">#@+node:ekr.20050805162550.26: *4* writeHeadline &amp; helper</span></div>
<div class="viewcode-block" id="rstClass.writeHeadline"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.writeHeadline">[docs]</a>    <span class="k">def</span> <span class="nf">writeHeadline</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Generate an rST section if options permit it.</span>
<span class="sd">        Remove headline commands from the headline first,</span>
<span class="sd">        and never generate an rST section for @rst-option and @rst-options.&#39;&#39;&#39;</span>

        <span class="n">docOnly</span>             <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;doc_only_mode&#39;</span><span class="p">)</span>
        <span class="n">ignore</span>              <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;ignore_this_headline&#39;</span><span class="p">)</span>
        <span class="n">showHeadlines</span>       <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;show_headlines&#39;</span><span class="p">)</span>
        <span class="n">showThisHeadline</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;show_this_headline&#39;</span><span class="p">)</span>
        <span class="n">showOrganizers</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;show_organizer_nodes&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">p</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">topNode</span> <span class="ow">or</span>
            <span class="n">ignore</span> <span class="ow">or</span>
            <span class="n">docOnly</span> <span class="ow">or</span> <span class="c"># handleDocOnlyMode handles this.</span>
            <span class="ow">not</span> <span class="n">showHeadlines</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">showThisHeadline</span> <span class="ow">or</span>
            <span class="c"># docOnly and not showOrganizers and not thisHeadline or</span>
            <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">showOrganizers</span> <span class="ow">or</span>
            <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">showOrganizers</span>
        <span class="p">):</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">writeHeadlineHelper</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20060608102001: *5* writeHeadlineHelper</span></div>
<div class="viewcode-block" id="rstClass.writeHeadlineHelper"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.writeHeadlineHelper">[docs]</a>    <span class="k">def</span> <span class="nf">writeHeadlineHelper</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="n">h</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c"># Remove any headline command before writing the </span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_id</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">chars</span><span class="o">=</span><span class="s">&#39;@-&#39;</span><span class="p">)</span>
        <span class="n">word</span> <span class="o">=</span> <span class="n">h</span> <span class="p">[:</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">word</span><span class="p">:</span>
            <span class="c"># Never generate a section for @rst-option or @rst-options.</span>
            <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;option_prefix&#39;</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;options_prefix&#39;</span><span class="p">)):</span>
                <span class="k">return</span>
            <span class="c"># Remove all other headline commands from the headline.</span>
            <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">headlineCommands</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">word</span> <span class="o">==</span> <span class="n">prefix</span><span class="p">:</span>
                    <span class="n">h</span> <span class="o">=</span> <span class="n">h</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">):]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">break</span>

            <span class="c"># New in Leo 4.4.4.</span>
            <span class="k">if</span> <span class="n">word</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;strip_at_file_prefixes&#39;</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;@auto&#39;</span><span class="p">,</span><span class="s">&#39;@file&#39;</span><span class="p">,</span><span class="s">&#39;@nosent&#39;</span><span class="p">,</span><span class="s">&#39;@thin&#39;</span><span class="p">,):</span>
                        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">word</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>
                            <span class="n">h</span> <span class="o">=</span> <span class="n">h</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">h</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;show_sections&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;generate_rst&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">underline</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">p</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">h</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">**</span><span class="si">%s</span><span class="s">**</span><span class="se">\n\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">h</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;*&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20050810083057: *4* writeNode</span></div>
<div class="viewcode-block" id="rstClass.writeNode"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.writeNode">[docs]</a>    <span class="k">def</span> <span class="nf">writeNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Format a node according to the options presently in effect.&#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initCodeBlockString</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scanAllOptions</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%24s</span><span class="s"> code_mode </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;code_mode&#39;</span><span class="p">)))</span>

        <span class="n">h</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;preformat_this_node&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">http_addNodeMarker</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writePreformat</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;ignore_this_tree&#39;</span><span class="p">):</span>
            <span class="n">p</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;ignore_this_node&#39;</span><span class="p">):</span>
            <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;@rst-options&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;show_options_nodes&#39;</span><span class="p">):</span>
            <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">http_addNodeMarker</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeHeadline</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeBody</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20071115061253: *4* writePreformat</span></div>
<div class="viewcode-block" id="rstClass.writePreformat"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.writePreformat">[docs]</a>    <span class="k">def</span> <span class="nf">writePreformat</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Write p&#39;s body text lines as if preformatted.</span>

<span class="sd">         ::</span>

<span class="sd">            line 1</span>
<span class="sd">            line 2 etc.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c"># g.trace(p.h,g.callers())</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39; &#39;</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="n">z</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;::</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="se">\n\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">s</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050805162550.23: *4* writeTree</span></div>
<div class="viewcode-block" id="rstClass.writeTree"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.writeTree">[docs]</a>    <span class="k">def</span> <span class="nf">writeTree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Write p&#39;s tree to self.outputFile.&#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scanAllOptions</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="c"># g.trace(self.getOption(&#39;generate_rst_header_comment&#39;))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;generate_rst&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;generate_rst_header_comment&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rstComment</span><span class="p">(</span>
                    <span class="s">&#39;rst3: filename: </span><span class="si">%s</span><span class="se">\n\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFileName</span><span class="p">))</span>

        <span class="c"># We can&#39;t use an iterator because we may skip parts of the tree.</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c"># Only one copy is needed for traversal.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topNode</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c"># Indicate the top of this tree.</span>
        <span class="n">after</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">nodeAfterTree</span><span class="p">()</span>

        <span class="k">while</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">after</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeNode</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050810083314: *3* Utils</span>
    <span class="c">#@+node:ekr.20051202070028: *4* computeOutputFileName</span></div>
<div class="viewcode-block" id="rstClass.computeOutputFileName"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.computeOutputFileName">[docs]</a>    <span class="k">def</span> <span class="nf">computeOutputFileName</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="p">):</span>

        <span class="n">openDirectory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">openDirectory</span>
        <span class="n">default_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;default_path&#39;</span><span class="p">)</span>

        <span class="c"># if default_path:</span>
            <span class="c"># default_path = g.os_path_finalize(default_path)</span>

        <span class="c"># g.trace(&#39;default_path&#39;,default_path,&#39;fileName&#39;,fileName)</span>

        <span class="k">if</span> <span class="n">default_path</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="n">default_path</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">openDirectory</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="n">openDirectory</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">path</span>
    <span class="c">#@+node:ekr.20050805162550.16: *4* encode</span></div>
<div class="viewcode-block" id="rstClass.encode"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.encode">[docs]</a>    <span class="k">def</span> <span class="nf">encode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span><span class="n">reportErrors</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050805162550.20: *4* report</span></div>
<div class="viewcode-block" id="rstClass.report"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.report">[docs]</a>    <span class="k">def</span> <span class="nf">report</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;verbose&#39;</span><span class="p">):</span>

            <span class="n">name</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&#39;wrote: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20050810083856: *4* rstComment</span></div>
<div class="viewcode-block" id="rstClass.rstComment"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.rstComment">[docs]</a>    <span class="k">def</span> <span class="nf">rstComment</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="k">return</span> <span class="s">&#39;.. </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">s</span>
    <span class="c">#@+node:ekr.20050805162550.19: *4* underline</span></div>
<div class="viewcode-block" id="rstClass.underline"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.underline">[docs]</a>    <span class="k">def</span> <span class="nf">underline</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the underlining string to be used at the given level for string s.&#39;&#39;&#39;</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;underline_characters&#39;</span><span class="p">)</span> <span class="c">#  &#39;&#39;&#39;#=+*^~&quot;&#39;`-:&gt;&lt;_&#39;&#39;&#39;</span>

        <span class="n">level</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">level</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">toplevel</span><span class="p">)</span>
        <span class="n">level</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">level</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c"># Reserve the first character for explicit titles.</span>

        <span class="n">ch</span> <span class="o">=</span> <span class="n">u</span> <span class="p">[</span><span class="n">level</span><span class="p">]</span>

        <span class="c"># g.trace(self.toplevel,p.level(),level,repr(ch),p.h)</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">ch</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="c">#@+node:ekr.20050809080031: *4* write</span></div>
<div class="viewcode-block" id="rstClass.write"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050805162550.33: *3* Support for http plugin</span>
    <span class="c">#@+node:ekr.20050815091008.1: *4* http_addNodeMarker</span></div>
<div class="viewcode-block" id="rstClass.http_addNodeMarker"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.http_addNodeMarker">[docs]</a>    <span class="k">def</span> <span class="nf">http_addNodeMarker</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;http_server_support&#39;</span><span class="p">)</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;generate_rst&#39;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodeNumber</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">anchorname</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;node_begin_marker&#39;</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">nodeNumber</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\n\n</span><span class="s">.. _</span><span class="si">%s</span><span class="s">:</span><span class="se">\n\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">anchorname</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">http_map</span> <span class="p">[</span><span class="n">anchorname</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">bwm_file</span><span class="p">:</span> <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">bwm_file</span><span class="p">,</span> <span class="s">&quot;addNodeMarker&quot;</span><span class="p">,</span> <span class="n">anchorname</span><span class="p">,</span> <span class="n">p</span>
    <span class="c">#@+node:ekr.20050805162550.34: *4* http_endTree &amp; helpers</span>
    <span class="c"># Was http_support_main</span>
</div>
<div class="viewcode-block" id="rstClass.http_endTree"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.http_endTree">[docs]</a>    <span class="k">def</span> <span class="nf">http_endTree</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">justOneFile</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Do end-of-tree processing to support the http plugin.&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;http_server_support&#39;</span><span class="p">)</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;generate_rst&#39;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_initial_http_attributes</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">find_anchors</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">justOneFile</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">relocate_references</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">self_and_subtree</span><span class="p">)</span>

            <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&#39;html updated for http plugin&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;clear_http_attributes&#39;</span><span class="p">):</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&quot;http attributes cleared&quot;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050805162550.36: *5* set_initial_http_attributes</span></div>
<div class="viewcode-block" id="rstClass.set_initial_http_attributes"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.set_initial_http_attributes">[docs]</a>    <span class="k">def</span> <span class="nf">set_initial_http_attributes</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">):</span>

        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">htmlParserClass</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20050805162550.38: *5* find_anchors</span></div>
<div class="viewcode-block" id="rstClass.find_anchors"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.find_anchors">[docs]</a>    <span class="k">def</span> <span class="nf">find_anchors</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Find the anchors in all the nodes.&#39;&#39;&#39;</span>

        <span class="k">for</span> <span class="n">p1</span><span class="p">,</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_attribute_iter</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="n">html</span> <span class="o">=</span> <span class="n">mod_http</span><span class="o">.</span><span class="n">reconstruct_html_from_attrs</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
            <span class="c"># g.trace(pprint.pprint(html))</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">anchor_htmlParserClass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">html</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">parser</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="c"># bwm: changed to unicode(line)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">line</span> <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">127</span><span class="p">])</span>
                    <span class="c"># filter out non-ascii characters.</span>
                    <span class="c"># bwm: not quite sure what&#39;s going on here.</span>
                    <span class="n">parser</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>        
        <span class="c"># g.trace(g.dictToString(self.anchor_map,tag=&#39;anchor_map&#39;))</span>
    <span class="c">#@+node:ekr.20050805162550.37: *5* relocate_references</span>
    <span class="c">#@+at Relocate references here if we are only running for one file.</span>
    <span class="c"># </span>
    <span class="c"># Otherwise we must postpone the relocation until we have processed all files.</span>
    <span class="c">#@@c</span>
</div>
<div class="viewcode-block" id="rstClass.relocate_references"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.relocate_references">[docs]</a>    <span class="k">def</span> <span class="nf">relocate_references</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterator_generator</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">iterator_generator</span><span class="p">():</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="n">mod_http</span><span class="o">.</span><span class="n">get_http_attribute</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c"># g.trace(&#39;before&#39;,p.h,attr)</span>
            <span class="k">if</span> <span class="n">bwm_file</span><span class="p">:</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">bwm_file</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">bwm_file</span><span class="p">,</span> <span class="s">&quot;relocate_references(1): Position, attr:&quot;</span>
                <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">((</span><span class="n">p</span><span class="p">,</span> <span class="n">attr</span><span class="p">),</span> <span class="n">bwm_file</span><span class="p">)</span>
            <span class="n">http_lines</span> <span class="o">=</span> <span class="n">attr</span> <span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">link_htmlparserClass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">attr</span> <span class="p">[</span><span class="mi">3</span><span class="p">:]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">parser</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">line</span> <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">127</span><span class="p">])</span>
                    <span class="n">parser</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">replacements</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">get_replacements</span><span class="p">()</span>
            <span class="n">replacements</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">replacements</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">bwm_file</span><span class="p">:</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">bwm_file</span><span class="p">,</span> <span class="s">&quot;relocate_references(2): Replacements:&quot;</span>
                <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">replacements</span><span class="p">,</span> <span class="n">bwm_file</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">href</span><span class="p">,</span> <span class="n">href_file</span><span class="p">,</span> <span class="n">http_node_ref</span> <span class="ow">in</span> <span class="n">replacements</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bwm_file</span><span class="p">:</span> 
                    <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">bwm_file</span><span class="p">,</span> <span class="s">&quot;relocate_references(3): line:&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="s">&quot;Column:&quot;</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="s">&quot;href:&quot;</span><span class="p">,</span> <span class="n">href</span><span class="p">,</span> <span class="s">&quot;href_file:&quot;</span><span class="p">,</span> <span class="n">href_file</span><span class="p">,</span> <span class="s">&quot;http_node_ref:&quot;</span><span class="p">,</span> <span class="n">http_node_ref</span>
                <span class="n">marker_parts</span> <span class="o">=</span> <span class="n">href</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;#&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">marker_parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">marker</span> <span class="o">=</span> <span class="n">marker_parts</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">replacement</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">#</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">http_node_ref</span><span class="p">,</span><span class="n">marker</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">attr</span> <span class="p">[</span><span class="n">line</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr</span> <span class="p">[</span><span class="n">line</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                            <span class="s">&#39;href=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">href</span><span class="p">,</span><span class="s">&#39;href=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">replacement</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;Skipped &quot;</span><span class="p">,</span> <span class="n">attr</span><span class="p">[</span><span class="n">line</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">marker_parts</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">attr</span> <span class="p">[</span><span class="n">line</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr</span> <span class="p">[</span><span class="n">line</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                            <span class="s">&#39;href=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">href</span><span class="p">,</span><span class="s">&#39;href=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">http_node_ref</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;Skipped&quot;</span><span class="p">,</span> <span class="n">attr</span><span class="p">[</span><span class="n">line</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span>
        <span class="c"># g.trace(&#39;after %s\n\n\n&#39;,attr)</span>
    <span class="c">#@+node:ekr.20050805162550.35: *5* http_attribute_iter</span></div>
<div class="viewcode-block" id="rstClass.http_attribute_iter"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.rst3.rstClass.http_attribute_iter">[docs]</a>    <span class="k">def</span> <span class="nf">http_attribute_iter</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Iterator for all the nodes which have html code.</span>
<span class="sd">        Look at the descendents of p.</span>
<span class="sd">        Used for relocation.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">p1</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">self_and_subtree</span><span class="p">():</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="n">mod_http</span><span class="o">.</span><span class="n">get_http_attribute</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">attr</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span><span class="n">attr</span><span class="p">)</span>
    <span class="c">#@-others</span>
<span class="c">#@-others</span>
<span class="c">#@-leo</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Leo API 4.11dev documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Ed K. Ream.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
  </body>
</html>