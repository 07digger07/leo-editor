<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>leo.plugins.screenshots &mdash; Leo API 4.11dev documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '4.11dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Leo API 4.11dev documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Leo API 4.11dev documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for leo.plugins.screenshots</h1><div class="highlight"><pre>
<span class="c">#@+leo-ver=5-thin</span>
<span class="c">#@+node:ekr.20101121031443.5330: * @file screenshots.py</span>
<span class="c">#@+&lt;&lt; docstring &gt;&gt;</span>
<span class="c">#@+node:ekr.20100908115707.5554: ** &lt;&lt; docstring &gt;&gt;</span>
<span class="sd">&quot;&quot;&quot; Creates stand-alone slideshows containing screenshots.</span>

<span class="sd">This plugin defines five commands. The</span>
<span class="sd">**apropos-slides** command prints this message to</span>
<span class="sd">Leo&#39;s log pane. The **slide-show-info** command</span>
<span class="sd">prints the settings in effect.</span>

<span class="sd">The **make-slide** and **make-slide-show**</span>
<span class="sd">commands, collectively called **slide commands**,</span>
<span class="sd">create collections of slides from **@slideshow**</span>
<span class="sd">trees containing **@slide** nodes.</span>

<span class="sd">Slides may link to screenshots. The slide commands</span>
<span class="sd">can generate screenshots from **@screenshot-tree**</span>
<span class="sd">nodes, but this feature has proven to be clumsy</span>
<span class="sd">and inflexible. It is usually more convenient to</span>
<span class="sd">use screenshots taken with a program such as Wink.</span>
<span class="sd">The **meld-slides** command creates references to</span>
<span class="sd">externally-generated screenshots within @slide</span>
<span class="sd">nodes.</span>

<span class="sd">\@slide nodes may contain **@url nodes**. These @url</span>
<span class="sd">nodes serve two purposes. First, they allow you to</span>
<span class="sd">see various files (slides, initial screenshots,</span>
<span class="sd">working files and final screenshots). Second,</span>
<span class="sd">these @url nodes guide the meld script and the</span>
<span class="sd">four commands defined by this plugin (see below).</span>
<span class="sd">By inserting or deleting these @url nodes you (or</span>
<span class="sd">your scripts) can customize how the commands (and</span>
<span class="sd">meld) work. In effect, the @url nodes become</span>
<span class="sd">per-slide settings.</span>

<span class="sd">**Prerequisites**</span>

<span class="sd">Inkscape (Required)</span>
<span class="sd">  An SVG editor: http://www.inkscape.org/</span>
<span class="sd">  Allows the user to edit screenshots.</span>
<span class="sd">  Required to create final output (PNG) files.</span>

<span class="sd">PIL (Optional but highly recommended)</span>
<span class="sd">  The Python Imaging Library,</span>
<span class="sd">  http://www.pythonware.com/products/pil/</span>

<span class="sd">Wink (Optional)</span>
<span class="sd">  A program that creates slideshows and slides.</span>
<span class="sd">  http://www.debugmode.com/wink/</span>

<span class="sd">**Summary**</span>

<span class="sd">@slideshow &lt;slideshow-name&gt;</span>
<span class="sd">  Creates the folder:</span>
<span class="sd">  &lt;sphinx_path&gt;/slides/&lt;slideshow-name&gt;</span>

<span class="sd">@slide &lt;ignored text&gt;</span>
<span class="sd">  Creates slide-&lt;slide-number&gt;.html</span>
<span class="sd">  (in the sphinx _build directory).</span>
<span class="sd">  **Note**: the plugin skips any @slide nodes</span>
<span class="sd">  with empty body text.</span>

<span class="sd">@screenshot</span>
<span class="sd">  Specifies the contents of the screenshot.</span>

<span class="sd">**Options** are child nodes of @slideshow or</span>
<span class="sd">\@slide nodes that control the make-slide and</span>
<span class="sd">make-slide-show commands. See the Options section</span>
<span class="sd">below.</span>

<span class="sd">The make-slide and make-slide-show commands</span>
<span class="sd">create the following @url nodes as children</span>
<span class="sd">of each @slide node:</span>

<span class="sd">@url built slide</span>
<span class="sd">  Contains the absolute path to the final slide in</span>
<span class="sd">  the _build/html subfolder of the slideshow</span>
<span class="sd">  folder. If present, this @url node completely</span>
<span class="sd">  disables rebuilding the slide.</span>

<span class="sd">@url screenshot</span>
<span class="sd">  Contains the absolute path to the original</span>
<span class="sd">  screenshot file. If present, this @url node</span>
<span class="sd">  inhibits taking the screenshot.</span>

<span class="sd">@url working file</span>
<span class="sd">  Contains the absolute path to the working file.</span>
<span class="sd">  If present, this @url node disables taking the</span>
<span class="sd">  screenshot, creating the working file. The final</span>
<span class="sd">  output file will be regenerated if the working</span>
<span class="sd">  file is newer than the final output file.</span>

<span class="sd">@url final output file</span>
<span class="sd">  Contains the absolute path to the final output</span>
<span class="sd">  file.</span>

<span class="sd">Thus, to completely recreate an @slide node, you</span>
<span class="sd">must delete any of the following nodes that appear</span>
<span class="sd">as its children::</span>

<span class="sd">    @url screenshot</span>
<span class="sd">    @url working file</span>
<span class="sd">    @url built slide</span>

<span class="sd">**Making slides**</span>

<span class="sd">For each slide, the make-slide and make-slide-show</span>
<span class="sd">commands do the following:</span>

<span class="sd">1. Create a slide.</span>

<span class="sd">  If the @slide node contains an @screenshot tree,</span>
<span class="sd">  the plugin appends an ``.. image::`` directive</span>
<span class="sd">  referring to the screenshot to the body text of</span>
<span class="sd">  the @slide node. The plugin also creates a child</span>
<span class="sd">  @image node referring to the screenshot.</span>

<span class="sd">2. (Optional) Create a screenshot.</span>

<span class="sd">  The plugin creates a screenshot for an @slide</span>
<span class="sd">  node only if the @slide node contains an</span>
<span class="sd">  @screenshot node as a direct child.</span>

<span class="sd">  **Important**: this step has largely been</span>
<span class="sd">  superseded by the ``@button meld`` script in</span>
<span class="sd">  LeoDocs.leo.</span>

<span class="sd">  Taking a screenshot involves the following steps:</span>

<span class="sd">  A. Create the **target outline**: screenshot-setup.leo.</span>

<span class="sd">    The target outline contains consists of all</span>
<span class="sd">    the children (and their descendants) of the</span>
<span class="sd">    @screenshot node.</span>

<span class="sd">  B. Create the **screenshot**, a bitmap (PNG) file.</span>

<span class="sd">    The slide commands take a screen shot of the</span>
<span class="sd">    target outline. The @pause option opens the</span>
<span class="sd">    target outline but does *not* take the</span>
<span class="sd">    screenshot. The user must take the screenshot</span>
<span class="sd">    manually. For more details, see the the</span>
<span class="sd">    options section below.</span>

<span class="sd">  C. Convert the screenshot file to a **work file**.</span>

<span class="sd">    The work file is an SVG (Scalable Vector</span>
<span class="sd">    Graphics) file: http://www.w3.org/Graphics/SVG/.</span>

<span class="sd">  D. (Optional) Edit the work file.</span>

<span class="sd">    If the @slide node has a child @edit node, the</span>
<span class="sd">    plugin opens Inkscape so that the user can</span>
<span class="sd">    edit the work file.</span>

<span class="sd">  E. Render the **final output file**.</span>

<span class="sd">    The plugin calls Inkscape non-interactively to</span>
<span class="sd">    render the final output file (a PNG image)</span>
<span class="sd">    from the work file. If the Python Imaging</span>
<span class="sd">    Library (PIL) is available, this step will use</span>
<span class="sd">    PIL to improve the quality of the final output</span>
<span class="sd">    file.</span>

<span class="sd">3. Build the slide using Sphinx.</span>

<span class="sd">  After making all files, the plugins runs Sphinx</span>
<span class="sd">  by running &#39;make html&#39; in the slideshow folder.</span>
<span class="sd">  This command creates the final .html files in the</span>
<span class="sd">  _build/html subfolder of the slideshow folder.</span>

<span class="sd">4. Create url nodes.</span>

<span class="sd">  Depending on options, and already-existing @url</span>
<span class="sd">  nodes, the make-slide and make-slide-show</span>
<span class="sd">  commands may create one or more of the following</span>
<span class="sd">  \@url nodes::</span>

<span class="sd">    @url built slide</span>
<span class="sd">    @url screenshot</span>
<span class="sd">    @url working file </span>
<span class="sd">    @url final output file</span>

<span class="sd">**Options and settings**</span>

<span class="sd">You specify options in the headlines of nodes.</span>
<span class="sd">**Global options** appear as direct children of</span>
<span class="sd">\@slideshow nodes and apply to all @slide nodes</span>
<span class="sd">unless overridden by a local option. **Local</span>
<span class="sd">options** appear as direct children of an @slide</span>
<span class="sd">node and apply to only to that @slide node.</span>

<span class="sd">**Global options nodes**</span>

<span class="sd">The following nodes may appear *either* as a</span>
<span class="sd">direct child of the @slideshow node or as the</span>
<span class="sd">direct child of an @slide node.</span>

<span class="sd">@sphinx_path = &lt;path&gt;</span>
<span class="sd">  This directory contains the slides directory,</span>
<span class="sd">  and the following files: &#39;conf.py&#39;,</span>
<span class="sd">  &#39;Leo4-80-border.jpg&#39;, &#39;Makefile&#39; and &#39;make.bat&#39;.</span>

<span class="sd">@screenshot_height = &lt;int&gt;</span>
<span class="sd">  The height in pixels of screenshots.</span>

<span class="sd">@screenshot_width = &lt;int&gt;</span>
<span class="sd">  The height in pixels of screenshots.</span>

<span class="sd">@template_fn = &lt;path&gt;</span>
<span class="sd">  The absolute path to inkscape-template.svg</span>

<span class="sd">@title = &lt;any text&gt;</span>
<span class="sd">  The title to use for one slide or the entire</span>
<span class="sd">  slideshow.</span>

<span class="sd">@title_pattern = &lt;pattern&gt;</span>
<span class="sd">  The pattern used to generate patterns for one</span>
<span class="sd">  slide or the entire slideshow. The title is</span>
<span class="sd">  computed as follows::</span>

<span class="sd">    d = {</span>
<span class="sd">        &#39;slideshow_name&#39;:slideshow_name,</span>
<span class="sd">        &#39;slide_name&#39;:    slide_name,</span>
<span class="sd">        &#39;slide_number&#39;:  sc.slide_number,</span>
<span class="sd">    }</span>
<span class="sd">    title = (pattern % (d)).title()</span>

<span class="sd">  If neither an @title or @title_pattern option</span>
<span class="sd">  node applies, the title is the headline of the</span>
<span class="sd">  \@slide node. If this is empty, the default</span>
<span class="sd">  pattern is::</span>

<span class="sd">    &#39;%(slideshow_name)s:%(slide_number)s&#39;</span>

<span class="sd">\@verbose = True/False</span>
<span class="sd">  True (or true or 1):  generate informational message.</span>
<span class="sd">  False (or false or 0): suppress informational messages.</span>

<span class="sd">\@wink_path = &lt;path&gt;</span>
<span class="sd">  This path contains screenshots created by wink.</span>
<span class="sd">  This is used only by the meld-slides command.</span>

<span class="sd">**Local options nodes**</span>

<span class="sd">The following nodes are valid only as the direct</span>
<span class="sd">child of an @slide node.</span>

<span class="sd">@callout &lt;any text&gt;</span>
<span class="sd">  Generates a text callout in the working .svg file.</span>
<span class="sd">  An @slide node may have several @callout children.</span>

<span class="sd">@edit = True/False</span>
<span class="sd">  If True (or true or 1) the plugin enters</span>
<span class="sd">  Inkscape interactively after taking a</span>
<span class="sd">  screenshot.</span>

<span class="sd">@markers = &lt;list of integers&gt;</span>
<span class="sd">  Generates &#39;numbered balls&#39; in the working .svg file.</span>

<span class="sd">@pause = True/False</span>
<span class="sd">  If True (or true or 1) the user must take the</span>
<span class="sd">  screenshot manually. Otherwise, the plugin takes</span>
<span class="sd">  the screenshot automatically.</span>

<span class="sd">  If the slide node contains an @pause node as one</span>
<span class="sd">  of its directive children, the slide commands</span>
<span class="sd">  open the target node, but do *not* take a screen</span>
<span class="sd">  shot.</span>

<span class="sd">  The user may adjust the screen as desired, for</span>
<span class="sd">  example by selecting menus or showing dialogs.</span>
<span class="sd">  The *user* must then take the screen shot</span>
<span class="sd">  manually. **Important**: the screenshot need not</span>
<span class="sd">  be of Leo--it could be a screenshot of anything</span>
<span class="sd">  on the screen.</span>

<span class="sd">  As soon as the user closes the target</span>
<span class="sd">  outline, the slide commands look for the screen</span>
<span class="sd">  shot on the clipboard. If found, the slide</span>
<span class="sd">  commands save the screenshot to the screenshot</span>
<span class="sd">  file.</span>

<span class="sd">@screenshot</span>
<span class="sd">  The root of a tree that becomes the entire</span>
<span class="sd">  contents of screenshot. No screenshot is taken</span>
<span class="sd">  if this node does not exist.</span>

<span class="sd">@select &lt;headline&gt;</span>
<span class="sd">  Causes the given headline in the @screenshot</span>
<span class="sd">  outline to be selected before taking the screenshot.</span>

<span class="sd">**Settings**</span>

<span class="sd">@string screenshot-bin = &lt;path to inkscape.exe&gt;</span>
<span class="sd">  The full path to the Inkscape program.   </span>

<span class="sd">**File names**</span>

<span class="sd">Suppose the @slide node is the n&#39;th @slide node in</span>
<span class="sd">the @slideshow tree whose sanitized name is</span>
<span class="sd">&#39;name&#39;. The following files will be created in</span>
<span class="sd">(relative to) the slideshow directory::</span>

<span class="sd">    slide-n.html.txt:   the slide&#39;s rST source.</span>
<span class="sd">    screenshot-n.png:   the original screenshot.</span>
<span class="sd">    screenshot-n.svg:   the working file.</span>
<span class="sd">    slide-n.png:        the final output file.</span>
<span class="sd">    _build/html/slide-n.html: the final slide.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c">#@@pagewidth 50</span>
<span class="c">#@-&lt;&lt; docstring &gt;&gt;</span>
<span class="c"># To do: create _static folder.</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s">&#39;1.0.3&#39;</span>
<span class="c">#@+&lt;&lt; imports &gt;&gt;</span>
<span class="c">#@+node:ekr.20100908110845.5604: ** &lt;&lt; imports &gt;&gt;</span>
<span class="kn">import</span> <span class="nn">leo.core.leoGlobals</span> <span class="kn">as</span> <span class="nn">g</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c"># Warnings are given later.</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageChops</span>
    <span class="n">got_pil</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">got_pil</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">PyQt4.QtGui</span>
    <span class="n">got_qt</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">got_qt</span> <span class="o">=</span> <span class="bp">False</span>

<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span>

<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="kn">as</span> <span class="nn">etree</span>
<span class="c">#@-&lt;&lt; imports &gt;&gt;</span>

<span class="c">#@+others</span>
<span class="c">#@+node:ekr.20100914090933.5771: ** Top level</span>
<span class="c">#@+node:ekr.20100908110845.5581: *3* g.command(apropos-slides)</span>
<span class="nd">@g.command</span><span class="p">(</span><span class="s">&#39;apropos-slides&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="apropos_screen_shots"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.apropos_screen_shots">[docs]</a><span class="k">def</span> <span class="nf">apropos_screen_shots</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>

    <span class="c"># Just print the module&#39;s docstring.</span>
    <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="n">__doc__</span><span class="p">)</span>
<span class="c">#@+node:ekr.20100908110845.5583: *3* g.command(make-slide)</span></div>
<span class="nd">@g.command</span><span class="p">(</span><span class="s">&#39;make-slide&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="make_slide_command"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.make_slide_command">[docs]</a><span class="k">def</span> <span class="nf">make_slide_command</span> <span class="p">(</span><span class="n">event</span><span class="p">):</span>

    <span class="n">c</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;c&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="n">ScreenShotController</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">make_slide_command</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">note</span><span class="p">(</span><span class="s">&#39;make-slide finished&#39;</span><span class="p">)</span>
<span class="c">#@+node:ekr.20100911044508.5634: *3* g.command(make-slide-show)</span></div>
<span class="nd">@g.command</span><span class="p">(</span><span class="s">&#39;make-slide-show&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="make_slide_show_command"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.make_slide_show_command">[docs]</a><span class="k">def</span> <span class="nf">make_slide_show_command</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="n">c</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;c&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="n">ScreenShotController</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">make_slide_show_command</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">note</span><span class="p">(</span><span class="s">&#39;make-slide-show finished&#39;</span><span class="p">)</span>
<span class="c">#@+node:ekr.20101113193341.5459: *3* g.command(meld-slides)</span></div>
<span class="nd">@g.command</span><span class="p">(</span><span class="s">&#39;meld-slides&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="meld_slides_command"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.meld_slides_command">[docs]</a><span class="k">def</span> <span class="nf">meld_slides_command</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Meld Wink slides into an @slideshow folder.</span>

<span class="sd">    Copy screenshot files from the wink_dir to slideshow_dir, numbering</span>
<span class="sd">    the destination files to reflect &quot;holes&quot; created by @no-screenshot</span>
<span class="sd">    nodes.</span>

<span class="sd">    This script carefully checks that the number of screenshot files</span>
<span class="sd">    matches the number of screenshots referenced by the @slide nodes.</span>
<span class="sd">    No copying takes place if the numbers are not as expected.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">c</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;c&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="n">ScreenShotController</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">meld_slides_command</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
<span class="c">#@+node:ekr.20101004082701.5733: *3* g.command(slide-show-info)</span></div>
<span class="nd">@g.command</span><span class="p">(</span><span class="s">&#39;slide-show-info&#39;</span><span class="p">)</span>
<div class="viewcode-block" id="slide_show_info_command"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.slide_show_info_command">[docs]</a><span class="k">def</span> <span class="nf">slide_show_info_command</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>

    <span class="n">c</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;c&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="n">ScreenShotController</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">slide_show_info_command</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
<span class="c">#@+node:ekr.20100908110845.5606: *3* init</span></div>
<div class="viewcode-block" id="init"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.init">[docs]</a><span class="k">def</span> <span class="nf">init</span> <span class="p">():</span>

    <span class="n">ok</span> <span class="o">=</span> <span class="n">got_qt</span>

    <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">plugin_signon</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ok</span>
<span class="c">#@+node:ekr.20100914090933.5770: *3* make_screen_shot</span></div>
<div class="viewcode-block" id="make_screen_shot"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.make_screen_shot">[docs]</a><span class="k">def</span> <span class="nf">make_screen_shot</span> <span class="p">(</span><span class="n">path</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Create a screenshot of the present Leo outline and save it to path.</span>
<span class="sd">    This is a callback called from make_screen_shot in runLeo.py&#39;&#39;&#39;</span>

    <span class="c"># g.trace(&#39;screenshots.py:&#39;,path)</span>

    <span class="n">app</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">qtApp</span>
    <span class="n">pix</span> <span class="o">=</span> <span class="n">PyQt4</span><span class="o">.</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QPixmap</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">pix</span><span class="o">.</span><span class="n">grabWindow</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">activeWindow</span><span class="p">()</span><span class="o">.</span><span class="n">winId</span><span class="p">())</span>
    <span class="n">w</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s">&#39;png&#39;</span><span class="p">)</span>
<span class="c">#@+node:ekr.20100908110845.5531: ** class ScreenShotController</span></div>
<div class="viewcode-block" id="ScreenShotController"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController">[docs]</a><span class="k">class</span> <span class="nc">ScreenShotController</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;A class to take screen shots and control Inkscape.</span>

<span class="sd">    apropos-screenshots contains a more complete description.&#39;&#39;&#39;</span>

    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20100908110845.5532: *3*  ctor &amp; helpers</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">c</span>

        <span class="c"># g.trace(&#39;ScreenShotController&#39;)</span>

        <span class="c"># import flags</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageChops</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">got_pil</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">got_pil</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">PyQt4.QtGui</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">got_qt</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">got_qt</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># Defaults.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_screenshot_height</span> <span class="o">=</span> <span class="mi">700</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_screenshot_width</span> <span class="o">=</span> <span class="mi">900</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_slide_pattern</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%(slideshow_name)s</span><span class="s">:</span><span class="si">%(slide_number)s</span><span class="s">&#39;</span>
            <span class="c"># Used with a dict whose keys are &#39;slideshow_name&#39;,&#39;slide_name&#39;,&#39;slide_number&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_verbose_flag</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c"># Options that may be set in @settings nodes.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inkscape_bin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_inkscape_bin</span><span class="p">()</span>
            <span class="c"># The path to the Inkscape executable.</span>

        <span class="c"># Options that may be set in children of</span>
        <span class="c"># *either* the @slideshow node or any @slide node.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">screenshot_height</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">screenshot_width</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slide_pattern</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sphinx_path</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template_fn</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title_pattern</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wink_path</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># Options that may be set only in children of @slide nodes.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callouts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edit_flag</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">markers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_fn</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pause_flag</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">screenshot_tree</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select_node</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># Computed data...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">at_image_fn</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directive_fn</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">screenshot_fn</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">screenshot_tree</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slide_base_name</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slide_fn</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slideshow_node</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slide_node</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slide_number</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slideshow_path</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">working_fn</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># Dimension cache.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dimCache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_reads</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">is_cache</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span>

        <span class="c"># Internal constants.</span>
        <span class="c"># element IDs which should exist in the SVG template</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ids</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s">&quot;co_bc_1&quot;</span><span class="p">,</span>        <span class="c"># 1 digit black circle</span>
            <span class="s">&quot;co_bc_2&quot;</span><span class="p">,</span>        <span class="c"># 2 digit black circle</span>
            <span class="s">&quot;co_bc_text_1&quot;</span><span class="p">,</span>   <span class="c"># text holder for 1 digit black circle</span>
            <span class="s">&quot;co_bc_text_2&quot;</span><span class="p">,</span>   <span class="c"># text holder for 2 digit black circle</span>
            <span class="s">&quot;co_frame&quot;</span><span class="p">,</span>       <span class="c"># frame for speech balloon callout</span>
            <span class="s">&quot;co_g_bc_1&quot;</span><span class="p">,</span>      <span class="c"># group for 1 digit black circle</span>
            <span class="s">&quot;co_g_bc_2&quot;</span><span class="p">,</span>      <span class="c"># group for 2 digit black circle</span>
            <span class="s">&quot;co_g_co&quot;</span><span class="p">,</span>        <span class="c"># group for speech balloon callout</span>
            <span class="s">&quot;co_shot&quot;</span><span class="p">,</span>        <span class="c"># image for screen shot</span>
            <span class="s">&quot;co_text_holder&quot;</span><span class="p">,</span> <span class="c"># text holder for speech balloon callout</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">xlink</span> <span class="o">=</span> <span class="s">&quot;{http://www.w3.org/1999/xlink}&quot;</span>
        <span class="c"># self.namespace = {&#39;svg&#39;: &quot;http://www.w3.org/2000/svg&quot;}</span>
    <span class="c">#@+node:ekr.20100913085058.5657: *4* get_inkscape_bin</span>
<div class="viewcode-block" id="ScreenShotController.get_inkscape_bin"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.get_inkscape_bin">[docs]</a>    <span class="k">def</span> <span class="nf">get_inkscape_bin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="nb">bin</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getString</span><span class="p">(</span><span class="s">&#39;screenshot-bin&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&quot;&#39;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">bin</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="nb">bin</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inkscape_bin</span> <span class="o">=</span> <span class="nb">bin</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Invalid @string screenshot-bin:&#39;</span><span class="p">,</span><span class="nb">bin</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">bin</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Inkscape not found. No editing is possible.&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">bin</span>
    <span class="c">#@+node:ekr.20101004082701.5731: *3* commands</span>
    <span class="c">#@+node:ekr.20101004082701.5732: *4* sc.slide-show-info_command</span></div>
<div class="viewcode-block" id="ScreenShotController.slide_show_info_command"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.slide_show_info_command">[docs]</a>    <span class="k">def</span> <span class="nf">slide_show_info_command</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;sc.init failed&#39;</span><span class="p">)</span>
        <span class="n">table</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">paths...&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;at_image_fn      &#39;</span><span class="p">,</span><span class="n">sc</span><span class="o">.</span><span class="n">at_image_fn</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;directive_fn     &#39;</span><span class="p">,</span><span class="n">sc</span><span class="o">.</span><span class="n">directive_fn</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;output_fn        &#39;</span><span class="p">,</span><span class="n">sc</span><span class="o">.</span><span class="n">output_fn</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;screenshot_fn    &#39;</span><span class="p">,</span><span class="n">sc</span><span class="o">.</span><span class="n">screenshot_fn</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;sphinx_path      &#39;</span><span class="p">,</span><span class="n">sc</span><span class="o">.</span><span class="n">sphinx_path</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;slide_fn         &#39;</span><span class="p">,</span><span class="n">sc</span><span class="o">.</span><span class="n">slide_fn</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;slideshow_path   &#39;</span><span class="p">,</span><span class="n">sc</span><span class="o">.</span><span class="n">slideshow_path</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;template_fn      &#39;</span><span class="p">,</span><span class="n">sc</span><span class="o">.</span><span class="n">template_fn</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;working_fn       &#39;</span><span class="p">,</span><span class="n">sc</span><span class="o">.</span><span class="n">working_fn</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">nodes...&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;screenshot_tree  &#39;</span><span class="p">,</span><span class="n">sc</span><span class="o">.</span><span class="n">screenshot_tree</span> <span class="ow">and</span> <span class="n">sc</span><span class="o">.</span><span class="n">screenshot_tree</span><span class="o">.</span><span class="n">h</span> <span class="ow">or</span> <span class="s">&#39;None&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;select_node      &#39;</span><span class="p">,</span><span class="n">sc</span><span class="o">.</span><span class="n">select_node</span><span class="p">),</span> <span class="c"># A string, not a node!</span>
            <span class="p">(</span><span class="s">&#39;slide_node       &#39;</span><span class="p">,</span><span class="n">sc</span><span class="o">.</span><span class="n">slide_node</span><span class="o">.</span><span class="n">h</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">other args...&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;edit_flag        &#39;</span><span class="p">,</span><span class="n">sc</span><span class="o">.</span><span class="n">edit_flag</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;pause_flag       &#39;</span><span class="p">,</span><span class="n">sc</span><span class="o">.</span><span class="n">pause_flag</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;screenshot_height&#39;</span><span class="p">,</span><span class="n">sc</span><span class="o">.</span><span class="n">screenshot_height</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;screenshot_width &#39;</span><span class="p">,</span><span class="n">sc</span><span class="o">.</span><span class="n">screenshot_width</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;slide_base_name  &#39;</span><span class="p">,</span><span class="n">sc</span><span class="o">.</span><span class="n">slide_base_name</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">tag</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="n">table</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100911044508.5635: *4* sc.make_slide_show_command &amp; helper</span></div>
<div class="viewcode-block" id="ScreenShotController.make_slide_show_command"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.make_slide_show_command">[docs]</a>    <span class="k">def</span> <span class="nf">make_slide_show_command</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Create slides for all slide nodes (direct children)</span>
<span class="sd">        of the @slideshow node p.&#39;&#39;&#39;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sc</span><span class="o">.</span><span class="n">inkscape_bin</span><span class="p">:</span>
            <span class="k">return</span> <span class="c"># The ctor has given the warning.</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sc</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s">&#39;@slideshow&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Not an @slideshow node:&#39;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

        <span class="n">after</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">nodeAfterTree</span><span class="p">()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">firstChild</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">after</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">commandInterruptFlag</span><span class="p">:</span> <span class="k">return</span>
            <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s">&#39;@slide&#39;</span><span class="p">):</span>
                <span class="n">sc</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span> 
            <span class="k">elif</span> <span class="n">sc</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s">&#39;@ignore&#39;</span><span class="p">):</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>

        <span class="n">sc</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20100913085058.5629: *4* sc.make_slide_command</span></div>
<div class="viewcode-block" id="ScreenShotController.make_slide_command"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.make_slide_command">[docs]</a>    <span class="k">def</span> <span class="nf">make_slide_command</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sc</span><span class="o">.</span><span class="n">inkscape_bin</span><span class="p">:</span>
            <span class="k">return</span> <span class="c"># The ctor has given the warning.</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sc</span><span class="o">.</span><span class="n">find_slideshow_node</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Not in slide show:&#39;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

        <span class="n">slide_node</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">find_slide_node</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">remove_built_slide_node</span><span class="p">(</span><span class="n">slide_node</span><span class="p">)</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>

        <span class="c"># Only the make-slide command gives this error.</span>
        <span class="c"># The make-slide-show commands allows dummy nodes.</span>
        <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">slide_node</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sc</span><span class="o">.</span><span class="n">slide_node</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;No body for slide&#39;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20101113193341.5460: *4* sc.meld_slides_command</span></div>
<div class="viewcode-block" id="ScreenShotController.meld_slides_command"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.meld_slides_command">[docs]</a>    <span class="k">def</span> <span class="nf">meld_slides_command</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sc</span><span class="o">.</span><span class="n">inkscape_bin</span><span class="p">:</span>
            <span class="k">return</span> <span class="c"># The ctor has given the warning.</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sc</span><span class="o">.</span><span class="n">find_slideshow_node</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Not in slide show:&#39;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

        <span class="n">sc</span><span class="o">.</span><span class="n">meld</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20101008112639.5628: *4* sc.build</span></div>
<div class="viewcode-block" id="ScreenShotController.build"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.build">[docs]</a>    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Do a complete sphinx build.&#39;&#39;&#39;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">slideshow_path</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;make clean&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;make html&#39;</span><span class="p">)</span>

        <span class="c"># cmd = [&#39;make&#39;,&#39;html&#39;]</span>
        <span class="c"># proc = subprocess.Popen(cmd)</span>
        <span class="c"># proc.communicate() # Wait</span>
    <span class="c">#@+node:ekr.20100915074635.5651: *3* init</span></div>
<div class="viewcode-block" id="ScreenShotController.init"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Initialize from node p.&#39;&#39;&#39;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># Compute essential nodes &amp; values.</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">slideshow_node</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">find_slideshow_node</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sc</span><span class="o">.</span><span class="n">slideshow_node</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">slide_node</span> <span class="o">=</span> <span class="n">p</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">find_slide_node</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">slide_number</span> <span class="o">=</span> <span class="n">n</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get_slide_number</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>

        <span class="c"># Do nothing if p.b is empty.  This is a good flag.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="k">return</span> <span class="bp">False</span>

        <span class="c"># Set the verbose flag.</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get_verbose_flag</span><span class="p">()</span>

        <span class="c"># Compute essential paths.</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">sphinx_path</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get_sphinx_path</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sc</span><span class="o">.</span><span class="n">sphinx_path</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">slideshow_path</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get_slideshow_path</span><span class="p">()</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">slide_base_name</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get_slide_base_name</span><span class="p">()</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">working_fn</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get_working_fn</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sc</span><span class="o">.</span><span class="n">working_fn</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">screenshot_fn</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get_screenshot_fn</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sc</span><span class="o">.</span><span class="n">screenshot_fn</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>

        <span class="c"># Find optional nodes, all relative to the slide node.</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">callouts</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get_callouts</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">markers</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get_markers</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">screenshot_tree</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">find_at_screenshot_node</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">select_node</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">find_select_node</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="c"># Compute paths and file names.</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">output_fn</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get_output_fn</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">template_fn</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get_template_fn</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">wink_path</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get_wink_path</span><span class="p">()</span>

        <span class="c"># Compute these after computing sc.sphinx_path and sc.screenshot_fn...</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">at_image_fn</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get_at_image_fn</span><span class="p">()</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">directive_fn</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get_directive_fn</span><span class="p">()</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">slide_fn</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get_slide_fn</span><span class="p">()</span>

        <span class="c"># Compute simple ivars.</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">screenshot_height</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get_screenshot_height</span><span class="p">()</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">screenshot_width</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get_screenshot_width</span><span class="p">()</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">edit_flag</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get_edit_flag</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="c"># Only an explicit pause now pauses.</span>
            <span class="c"># or bool(sc.callouts or sc.markers)</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">pause_flag</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get_pause_flag</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="c">#@+node:ekr.20100908110845.5533: *3* lxml replacements</span>
    <span class="c">#@+node:ekr.20100908110845.5534: *4* getElementsWithAttrib</span></div>
<div class="viewcode-block" id="ScreenShotController.getElementsWithAttrib"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.getElementsWithAttrib">[docs]</a>    <span class="k">def</span> <span class="nf">getElementsWithAttrib</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">attr_name</span><span class="p">,</span><span class="n">aList</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">aList</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">aList</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">val</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attr_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val</span><span class="p">:</span> <span class="n">aList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">getchildren</span><span class="p">():</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">getElementsWithAttrib</span><span class="p">(</span><span class="n">child</span><span class="p">,</span><span class="n">attr_name</span><span class="p">,</span><span class="n">aList</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">aList</span>
    <span class="c">#@+node:ekr.20100908110845.5535: *4* getElementsWithAttribList (not used)</span></div>
<div class="viewcode-block" id="ScreenShotController.getElementsWithAttribList"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.getElementsWithAttribList">[docs]</a>    <span class="k">def</span> <span class="nf">getElementsWithAttribList</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">attr_names</span><span class="p">,</span><span class="n">aList</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">aList</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">aList</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">attr_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">e</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">aList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">getchildren</span><span class="p">():</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">getElementsWithAttribList</span><span class="p">(</span><span class="n">child</span><span class="p">,</span><span class="n">attr_names</span><span class="p">,</span><span class="n">aList</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">aList</span>
    <span class="c">#@+node:ekr.20100908110845.5536: *4* getIds</span></div>
<div class="viewcode-block" id="ScreenShotController.getIds"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.getIds">[docs]</a>    <span class="k">def</span> <span class="nf">getIds</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">d</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return a dict d. Keys are ids, values are elements.&#39;&#39;&#39;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">aList</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">getElementsWithAttrib</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="s">&#39;id&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">e</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">),</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">])</span>
    <span class="c">#@+node:ekr.20100908110845.5537: *4* getParents</span></div>
<div class="viewcode-block" id="ScreenShotController.getParents"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.getParents">[docs]</a>    <span class="k">def</span> <span class="nf">getParents</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">d</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">d</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">getchildren</span><span class="p">():</span>
            <span class="n">d</span><span class="p">[</span><span class="n">child</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">getParents</span><span class="p">(</span><span class="n">child</span><span class="p">,</span><span class="n">d</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">d</span>
    <span class="c">#@+node:ekr.20100911044508.5630: *3* options &amp; paths</span>
    <span class="c">#@+node:ekr.20101004082701.5734: *4* Finding nodes</span>
    <span class="c">#@+node:ekr.20101008112639.5629: *5* find_node</span></div>
<div class="viewcode-block" id="ScreenShotController.find_node"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.find_node">[docs]</a>    <span class="k">def</span> <span class="nf">find_node</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">h</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the node in p&#39;s direct children whose headline matches h.&#39;&#39;&#39;</span>

        <span class="k">for</span> <span class="n">p2</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">h</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">p2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20100909121239.5742: *5* find_at_screenshot_node</span></div>
<div class="viewcode-block" id="ScreenShotController.find_at_screenshot_node"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.find_at_screenshot_node">[docs]</a>    <span class="k">def</span> <span class="nf">find_at_screenshot_node</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the @screenshot node in a direct child of p.&#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_node</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s">&#39;@screenshot&#39;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100913085058.5660: *5* find_select_node</span></div>
<div class="viewcode-block" id="ScreenShotController.find_select_node"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.find_select_node">[docs]</a>    <span class="k">def</span> <span class="nf">find_select_node</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Find the @select node in a direct child of p.</span>
<span class="sd">        Return whatever follows @select in the headline.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="s">&#39;@select&#39;</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">find_node</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">tag</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">p2</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">tag</span><span class="p">):]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;&#39;</span>
    <span class="c">#@+node:ekr.20100915074635.5652: *5* find_slide_node</span></div>
<div class="viewcode-block" id="ScreenShotController.find_slide_node"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.find_slide_node">[docs]</a>    <span class="k">def</span> <span class="nf">find_slide_node</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the @slide node at or near p.&#39;&#39;&#39;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s">&#39;@slide&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">p</span>

        <span class="c"># Look up the tree.</span>
        <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">self_and_parents</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="s">&#39;@slide&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">parent</span>
            <span class="k">elif</span> <span class="n">sc</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="s">&#39;@slideshow&#39;</span><span class="p">):</span>
                <span class="k">break</span>

        <span class="c"># Look down the tree.</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">firstChild</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">p</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s">&#39;@slide&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">p</span>
            <span class="k">elif</span> <span class="n">sc</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s">&#39;@slideshow&#39;</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>

        <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;No @slide node found:&#39;</span><span class="p">,</span><span class="n">p1</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20100913085058.5654: *5* find_slideshow_node</span></div>
<div class="viewcode-block" id="ScreenShotController.find_slideshow_node"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.find_slideshow_node">[docs]</a>    <span class="k">def</span> <span class="nf">find_slideshow_node</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the nearest ancestor @slideshow node.&#39;&#39;&#39;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">for</span> <span class="n">p2</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">self_and_parents</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;@slideshow&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">p2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20101004082701.5735: *4* Path utils</span>
    <span class="c">#@+node:ekr.20100908110845.5540: *5* finalize</span></div>
<div class="viewcode-block" id="ScreenShotController.finalize"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.finalize">[docs]</a>    <span class="k">def</span> <span class="nf">finalize</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the absolute path to fn in the slideshow folder.&#39;&#39;&#39;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">return</span> <span class="n">sc</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">slideshow_path</span><span class="p">,</span><span class="n">fn</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20100911044508.5632: *5* fix</span></div>
<div class="viewcode-block" id="ScreenShotController.fix"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.fix">[docs]</a>    <span class="k">def</span> <span class="nf">fix</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Fix the case of a file name,</span>
<span class="sd">        especially on Windows the case of drive letters.</span>

<span class="sd">        This method is safe to call at any time:</span>
<span class="sd">        it changes only case and slashes.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normcase</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100913085058.5658: *5* sanitize</span></div>
<div class="viewcode-block" id="ScreenShotController.sanitize"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.sanitize">[docs]</a>    <span class="k">def</span> <span class="nf">sanitize</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">sanitize_filename</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span><span class="s">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">,</span><span class="s">&#39;-&#39;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20101004082701.5736: *4* Computed paths</span>
    <span class="c"># These methods compute final paths.</span>
    <span class="c">#@+node:ekr.20100911044508.5631: *5* get_at_image_fn</span></div>
<div class="viewcode-block" id="ScreenShotController.get_at_image_fn"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.get_at_image_fn">[docs]</a>    <span class="k">def</span> <span class="nf">get_at_image_fn</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return sc.output_fn name **relative to g.app.loadDir**.</span>

<span class="sd">        @image directives are relative to g.app.loadDir.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadDir</span><span class="p">))</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">output_fn</span><span class="p">)</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">base</span><span class="p">)</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fn</span>
    <span class="c">#@+node:ekr.20100909121239.5669: *5* get_directive_fn</span></div>
<div class="viewcode-block" id="ScreenShotController.get_directive_fn"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.get_directive_fn">[docs]</a>    <span class="k">def</span> <span class="nf">get_directive_fn</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Compute the path for use in an .. image:: directive.&#39;&#39;&#39;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">output_fn</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100911044508.5627: *5* get_output_fn</span></div>
<div class="viewcode-block" id="ScreenShotController.get_output_fn"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.get_output_fn">[docs]</a>    <span class="k">def</span> <span class="nf">get_output_fn</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the full, absolute, output file name.</span>

<span class="sd">        An empty filename disables output.</span>

<span class="sd">        The default is &#39;slide-%03d.png&#39; % (sc.slide_number)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c"># Look for any @output nodes in p&#39;s children.</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">tag</span> <span class="o">=</span> <span class="s">&#39;@output&#39;</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">h</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">tag</span><span class="p">):</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">tag</span><span class="p">):]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">fn</span><span class="p">:</span>
                    <span class="n">fn</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fn</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="s">&#39;slide-</span><span class="si">%03d</span><span class="s">.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">slide_number</span><span class="p">)</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fn</span>
    <span class="c">#@+node:ekr.20100911044508.5628: *5* get_screenshot_fn</span></div>
<div class="viewcode-block" id="ScreenShotController.get_screenshot_fn"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.get_screenshot_fn">[docs]</a>    <span class="k">def</span> <span class="nf">get_screenshot_fn</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the full, absolute, screenshot file name.&#39;&#39;&#39;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="c"># fn = &#39;%s-%03d.png&#39; % (sc.slide_base_name,sc.slide_number)</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="s">&#39;screenshot-</span><span class="si">%03d</span><span class="s">.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">slide_number</span><span class="p">)</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fn</span>
    <span class="c">#@+node:ekr.20101004082701.5738: *5* get_slide_base_name</span></div>
<div class="viewcode-block" id="ScreenShotController.get_slide_base_name"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.get_slide_base_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_slide_base_name</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">junk</span><span class="p">,</span><span class="n">name</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_split</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">slideshow_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">name</span>
    <span class="c">#@+node:ekr.20101004082701.5740: *5* get_slide_fn</span></div>
<div class="viewcode-block" id="ScreenShotController.get_slide_fn"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.get_slide_fn">[docs]</a>    <span class="k">def</span> <span class="nf">get_slide_fn</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the absolute path to &#39;slide-%03d.html.txt&#39; % (sc.slide_number).&#39;&#39;&#39;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="c"># fn = &#39;%s-%03d.html.txt&#39; % (sc.slide_base_name,sc.slide_number)</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="s">&#39;slide-</span><span class="si">%03d</span><span class="s">.html.txt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">slide_number</span><span class="p">)</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fn</span>
    <span class="c">#@+node:ekr.20100919075719.5641: *5* get_slideshow_path</span></div>
<div class="viewcode-block" id="ScreenShotController.get_slideshow_path"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.get_slideshow_path">[docs]</a>    <span class="k">def</span> <span class="nf">get_slideshow_path</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return the path to the folder to be used for slides and screenshots.</span>
<span class="sd">        This is sphinx_path/slides/&lt;sanitized-p.h&gt;</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">slideshow_node</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="s">&#39;@slideshow&#39;</span>
        <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">tag</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">tag</span><span class="p">):]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">h</span><span class="p">:</span>
            <span class="n">theDir</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">sanitize</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">sphinx_path</span><span class="p">,</span><span class="s">&#39;slides&#39;</span><span class="p">,</span><span class="n">theDir</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;@slideshow node has no name&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20100911044508.5633: *5* get_sphinx_path</span></div>
<div class="viewcode-block" id="ScreenShotController.get_sphinx_path"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.get_sphinx_path">[docs]</a>    <span class="k">def</span> <span class="nf">get_sphinx_path</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the full, absolute, path to the sphinx directory.</span>

<span class="sd">        By default this will be the leo/doc/html directory.</span>

<span class="sd">        If a relative path is given, it will resolved</span>
<span class="sd">        relative to the directory containing the .leo file.</span>

<span class="sd">        This path will contain the slides directory, and the following files:</span>
<span class="sd">        &#39;conf.py&#39;,&#39;Leo4-80-border.jpg&#39;,&#39;Makefile&#39;,&#39;make.bat&#39;,</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">c</span>

        <span class="n">sphinx_path</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;sphinx_path&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sphinx_path</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_isabs</span><span class="p">(</span><span class="n">sphinx_path</span><span class="p">):</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">sphinx_path</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># The path is relative to the .leo file</span>
                <span class="n">leo_fn</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fileName</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">leo_fn</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;relative sphinx path given but outline not named&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">None</span>
                <span class="n">leo_fn</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadDir</span><span class="p">,</span><span class="n">leo_fn</span><span class="p">)</span>
                <span class="n">base</span><span class="p">,</span><span class="n">junk</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_split</span><span class="p">(</span><span class="n">leo_fn</span><span class="p">)</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span><span class="n">sphinx_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># The default is the leo/doc/html directory.</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadDir</span><span class="p">,</span><span class="s">&#39;..&#39;</span><span class="p">,</span><span class="s">&#39;doc&#39;</span><span class="p">,</span><span class="s">&#39;html&#39;</span><span class="p">)</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">path</span>
    <span class="c">#@+node:ekr.20100908110845.5542: *5* get_template_fn</span></div>
<div class="viewcode-block" id="ScreenShotController.get_template_fn"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.get_template_fn">[docs]</a>    <span class="k">def</span> <span class="nf">get_template_fn</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the full, absolute, template file name.&#39;&#39;&#39;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">c</span>

        <span class="n">template_fn</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;template_fn&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">template_fn</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize</span><span class="p">(</span><span class="n">template_fn</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadDir</span><span class="p">,</span>
                <span class="s">&#39;..&#39;</span><span class="p">,</span><span class="s">&#39;doc&#39;</span><span class="p">,</span><span class="s">&#39;inkscape-template.svg&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">fn</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;template file not found:&#39;</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20100911044508.5626: *5* get_working_fn</span></div>
<div class="viewcode-block" id="ScreenShotController.get_working_fn"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.get_working_fn">[docs]</a>    <span class="k">def</span> <span class="nf">get_working_fn</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the full, absolute, name of the working file.&#39;&#39;&#39;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="c"># fn = &#39;%s-%03d.svg&#39; % (sc.slide_base_name,sc.slide_number)</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="s">&#39;screenshot-</span><span class="si">%03d</span><span class="s">.svg&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">slide_number</span><span class="p">)</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fn</span>
    <span class="c">#@+node:ekr.20101113193341.5461: *5* get_wink_path</span></div>
<div class="viewcode-block" id="ScreenShotController.get_wink_path"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.get_wink_path">[docs]</a>    <span class="k">def</span> <span class="nf">get_wink_path</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the full, absolute, path to the directory containing wink</span>
<span class="sd">        screenshots. If a relative path is given, it will resolved relative to</span>
<span class="sd">        the directory containing the .leo file.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">c</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="s">&#39;@wink_path&#39;</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sc</span><span class="o">.</span><span class="n">slideshow_node</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">tag</span><span class="p">):</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">tag</span><span class="p">):]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">):</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_isabs</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">path</span>

        <span class="c"># The path is relative to the .leo file</span>
        <span class="n">leo_fn</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fileName</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">leo_fn</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;relative wink path given but outline not named&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="n">leo_fn</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadDir</span><span class="p">,</span><span class="n">leo_fn</span><span class="p">)</span>
        <span class="n">base</span><span class="p">,</span><span class="n">junk</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_split</span><span class="p">(</span><span class="n">leo_fn</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span><span class="n">path</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">path</span>
    <span class="c">#@+node:ekr.20101004082701.5737: *4* Options</span>
    <span class="c"># These methods examine the children/descendants of a node for options nodes.</span>
    <span class="c">#@+node:ekr.20100908110845.5596: *5* get_callouts &amp; helper</span></div>
<div class="viewcode-block" id="ScreenShotController.get_callouts"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.get_callouts">[docs]</a>    <span class="k">def</span> <span class="nf">get_callouts</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the list of callouts from the</span>
<span class="sd">        direct children that are @callout nodes.&#39;&#39;&#39;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">aList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;@callout&#39;</span><span class="p">):</span>
                <span class="n">callout</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get_callout</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">callout</span><span class="p">:</span> <span class="n">aList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">callout</span><span class="p">)</span>
        <span class="c"># g.trace(aList)</span>
        <span class="k">return</span> <span class="n">aList</span>
    <span class="c">#@+node:ekr.20100909121239.6096: *6* get_callout</span></div>
<div class="viewcode-block" id="ScreenShotController.get_callout"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.get_callout">[docs]</a>    <span class="k">def</span> <span class="nf">get_callout</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the text of the callout at p.&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span>
            <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;@callout&#39;</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_id</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">chars</span><span class="o">=</span><span class="s">&#39;@&#39;</span><span class="p">)</span>
                <span class="c"># Match @callout or @callouts, etc.</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">s</span>
    <span class="c">#@+node:ekr.20100911044508.5620: *5* get_edit_flag</span></div>
<div class="viewcode-block" id="ScreenShotController.get_edit_flag"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.get_edit_flag">[docs]</a>    <span class="k">def</span> <span class="nf">get_edit_flag</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return True if any of p&#39;s children is an @edit node.&#39;&#39;&#39;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">find_node</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s">&#39;@edit&#39;</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20100908110845.5597: *5* get_markers &amp; helper</span></div>
<div class="viewcode-block" id="ScreenShotController.get_markers"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.get_markers">[docs]</a>    <span class="k">def</span> <span class="nf">get_markers</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the list of markers from all @marker nodes.&#39;&#39;&#39;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">aList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;@marker&#39;</span><span class="p">)</span> <span class="ow">or</span>
                <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;@markers&#39;</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">callout</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get_marker</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">callout</span><span class="p">:</span> <span class="n">aList</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">callout</span><span class="p">)</span>
        <span class="c"># g.trace(aList)</span>
        <span class="k">return</span> <span class="n">aList</span>
    <span class="c">#@+node:ekr.20100909121239.6097: *6* get_marker</span></div>
<div class="viewcode-block" id="ScreenShotController.get_marker"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.get_marker">[docs]</a>    <span class="k">def</span> <span class="nf">get_marker</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return a list of markers at p.&#39;&#39;&#39;</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span>
        <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;@markers&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;marker&#39;</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_id</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">chars</span><span class="o">=</span><span class="s">&#39;@&#39;</span><span class="p">)</span>  
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">z</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)]</span>
    <span class="c">#@+node:ekr.20101006060338.5703: *5* get_option</span></div>
<div class="viewcode-block" id="ScreenShotController.get_option"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.get_option">[docs]</a>    <span class="k">def</span> <span class="nf">get_option</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">option</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Get a local or global option.</span>
<span class="sd">        Global options are children of the @slideshow node.</span>
<span class="sd">        Local options are children of the p, the @slide node.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span><span class="n">option</span><span class="p">)</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="s">&#39;@&#39;</span> <span class="o">+</span> <span class="n">option</span>
        <span class="n">isPath</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;_fn&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;_path&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">slideshow_node</span><span class="p">,</span><span class="n">sc</span><span class="o">.</span><span class="n">slide_node</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">h</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">tag</span><span class="p">):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">tag</span><span class="p">):]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">):</span> <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">isPath</span><span class="p">:</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;1&#39;</span><span class="p">,</span><span class="s">&#39;True&#39;</span><span class="p">,</span><span class="s">&#39;true&#39;</span><span class="p">):</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="k">elif</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;0&#39;</span><span class="p">,</span><span class="s">&#39;False&#39;</span><span class="p">,</span><span class="s">&#39;false&#39;</span><span class="p">):</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="bp">False</span>
                        <span class="k">elif</span> <span class="n">val</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="ow">not</span> <span class="n">val</span><span class="p">:</span>
                            <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;ignoring setting&#39;</span><span class="p">,</span><span class="n">child</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">option</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">val</span> <span class="ow">or</span> <span class="bp">False</span><span class="p">))</span>
                        <span class="k">return</span> <span class="n">val</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;ignoring setting:&#39;</span><span class="p">,</span><span class="n">child</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
                        <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># if trace: g.trace(option,repr(None))</span>
            <span class="k">return</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20100913085058.5630: *5* get_pause_flag</span></div>
<div class="viewcode-block" id="ScreenShotController.get_pause_flag"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.get_pause_flag">[docs]</a>    <span class="k">def</span> <span class="nf">get_pause_flag</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="c"># Look for an @pause nodes in p&#39;s children.</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;@pause&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20100913085058.5628: *5* get_protect_flag</span></div>
<div class="viewcode-block" id="ScreenShotController.get_protect_flag"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.get_protect_flag">[docs]</a>    <span class="k">def</span> <span class="nf">get_protect_flag</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

         <span class="c"># Look for any @protect or @ignore nodes in p&#39;s children.</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;@ignore&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;@protect&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20101006060338.5704: *5* get_screenshot_height/width</span></div>
<div class="viewcode-block" id="ScreenShotController.get_screenshot_height"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.get_screenshot_height">[docs]</a>    <span class="k">def</span> <span class="nf">get_screenshot_height</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;screenshot_height&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">h</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span><span class="n">sc</span><span class="o">.</span><span class="n">default_screenshot_height</span><span class="p">,</span><span class="n">h</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ScreenShotController.get_screenshot_width"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.get_screenshot_width">[docs]</a>    <span class="k">def</span> <span class="nf">get_screenshot_width</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;screenshot_width&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">w</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span><span class="n">sc</span><span class="o">.</span><span class="n">default_screenshot_width</span><span class="p">,</span><span class="n">w</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20101009162803.5632: *5* get_slide_title</span></div>
<div class="viewcode-block" id="ScreenShotController.get_slide_title"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.get_slide_title">[docs]</a>    <span class="k">def</span> <span class="nf">get_slide_title</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">slideshow_name</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">slideshow_node</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s">&#39;@slideshow&#39;</span><span class="p">):]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">slide_name</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">slide_node</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s">&#39;@slide&#39;</span><span class="p">):]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;slideshow_name&#39;</span><span class="p">:</span><span class="n">slideshow_name</span><span class="p">,</span>
            <span class="s">&#39;slide_name&#39;</span><span class="p">:</span>    <span class="n">slide_name</span><span class="p">,</span>
            <span class="s">&#39;slide_number&#39;</span><span class="p">:</span>  <span class="n">sc</span><span class="o">.</span><span class="n">slide_number</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span><span class="s">&#39;title_pattern&#39;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                <span class="c"># g.trace(repr(tag),repr(s))</span>
                <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;@title&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">s</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">s</span> <span class="o">%</span> <span class="n">d</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;bad </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">slide_name</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">slide_name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;((&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">slide_name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">default_slide_pattern</span> <span class="o">%</span> <span class="n">d</span>
                <span class="c"># g.trace(&#39;using default title:&#39;,s)</span>
                <span class="k">return</span> <span class="n">s</span>
    <span class="c">#@+node:ekr.20101006060338.5706: *5* get_verbose_flag</span></div>
<div class="viewcode-block" id="ScreenShotController.get_verbose_flag"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.get_verbose_flag">[docs]</a>    <span class="k">def</span> <span class="nf">get_verbose_flag</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s">&#39;verbose&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">val</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">default_verbose_flag</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100911044508.5618: *3* utilities</span>
    <span class="c">#@+node:ekr.20100908110845.5594: *4* add_image_directive</span></div>
    <span class="k">def</span> <span class="nf">add_image_directive</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Add &quot;.. image:: &lt;sc.directive_fn&gt;&quot; to p.b if it is not already there.&#39;&#39;&#39;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">slide_node</span>

        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;.. image:: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">sc</span><span class="o">.</span><span class="n">directive_fn</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;/&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n\n</span><span class="si">%s</span><span class="se">\n\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100911044508.5637: *4* clear_cache</span>
<div class="viewcode-block" id="ScreenShotController.clear_cache"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.clear_cache">[docs]</a>    <span class="k">def</span> <span class="nf">clear_cache</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Clear the dimension cache.&#39;&#39;&#39;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">dimCache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">is_reads</span><span class="p">,</span><span class="n">sc</span><span class="o">.</span><span class="n">is_cache</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
    <span class="c">#@+node:ekr.20101005193146.5687: *4* copy_files &amp; helper</span>
    <span class="c">#@+at We would like to do sphinx &quot;make&quot; operations only in the top-level sphinx</span>
    <span class="c"># folder (leo/doc/html) so that only a single _build directory tree would exist.</span>
    <span class="c"># </span>
    <span class="c"># Alas, that doesn&#39;t work.  To get links correct, the build must be done in</span>
    <span class="c"># the individual slide folders.  So we *must* copy all the files.</span>
    <span class="c">#@@c</span>
</div>
<div class="viewcode-block" id="ScreenShotController.copy_files"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.copy_files">[docs]</a>    <span class="k">def</span> <span class="nf">copy_files</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">make_toc</span><span class="p">()</span>
        <span class="n">table</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s">&#39;conf.py&#39;</span><span class="p">,</span>
            <span class="c"># &#39;leo_toc.html.txt&#39;, # created by make_toc above.</span>
            <span class="s">&#39;Leo4-80-border.jpg&#39;</span><span class="p">,</span>
            <span class="s">&#39;Makefile&#39;</span><span class="p">,</span>
            <span class="s">&#39;make.bat&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">slide_path</span><span class="p">,</span><span class="n">junk</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_split</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">slide_fn</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">table</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="n">slide_path</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">sc</span><span class="o">.</span><span class="n">copy_file</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">sphinx_path</span><span class="p">,</span><span class="n">slide_path</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20101005193146.5688: *5* copy_file</span></div>
<div class="viewcode-block" id="ScreenShotController.copy_file"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.copy_file">[docs]</a>    <span class="k">def</span> <span class="nf">copy_file</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">src_path</span><span class="p">,</span><span class="n">dst_path</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>

        <span class="n">src_fn</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="n">src_path</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">dst_fn</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="n">dst_path</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">junk</span><span class="p">,</span><span class="n">dst_dir</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_split</span><span class="p">(</span><span class="n">dst_path</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">note</span><span class="p">(</span><span class="s">&#39;creating&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">os_path_join</span><span class="p">(</span><span class="s">&#39;slides&#39;</span><span class="p">,</span><span class="n">dst_dir</span><span class="p">,</span><span class="n">fn</span><span class="p">))</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">src_fn</span><span class="p">,</span><span class="n">dst_fn</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100913085058.5653: *4* get_slide_number</span></div>
<div class="viewcode-block" id="ScreenShotController.get_slide_number"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.get_slide_number">[docs]</a>    <span class="k">def</span> <span class="nf">get_slide_number</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">assert</span> <span class="n">sc</span><span class="o">.</span><span class="n">slideshow_node</span>
        <span class="k">assert</span> <span class="n">p</span> <span class="o">==</span> <span class="n">sc</span><span class="o">.</span><span class="n">slide_node</span>

        <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span> <span class="c"># Slides numbers start at one.</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">slideshow_node</span><span class="o">.</span><span class="n">firstChild</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">p</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="n">p1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">n</span>
            <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;@slide&#39;</span><span class="p">):</span>
                <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c"># Skip the entire tree, including</span>
                <span class="c"># any inner @screenshot trees.</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>

        <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;Can not happen. Not found:&#39;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">666</span>
    <span class="c">#@+node:ekr.20100908110845.5543: *4* give_pil_warning</span></div>
    <span class="n">pil_message_given</span> <span class="o">=</span> <span class="bp">False</span>

<div class="viewcode-block" id="ScreenShotController.give_pil_warning"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.give_pil_warning">[docs]</a>    <span class="k">def</span> <span class="nf">give_pil_warning</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Give a singleton warning that PIL could not be loaded.&#39;&#39;&#39;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">pil_message_given</span><span class="p">:</span>
            <span class="k">return</span> <span class="c"># Warning already given.</span>

        <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">got_pil</span><span class="p">:</span>
            <span class="k">return</span> <span class="c"># The best situation</span>

        <span class="n">sc</span><span class="o">.</span><span class="n">pil_message_given</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">got_qt</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;PIL not found: images may have transparent borders&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;PIL and Qt both not found: images may be less clear&#39;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100908110845.5592: *4* in_slide_show</span></div>
<div class="viewcode-block" id="ScreenShotController.in_slide_show"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.in_slide_show">[docs]</a>    <span class="k">def</span> <span class="nf">in_slide_show</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return True if p is a descendant of an @slideshow node.&#39;&#39;&#39;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">find_slideshow_node</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20101004201006.5685: *4* make_all_directories</span></div>
<div class="viewcode-block" id="ScreenShotController.make_all_directories"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.make_all_directories">[docs]</a>    <span class="k">def</span> <span class="nf">make_all_directories</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># Don&#39;t create path for at_image_fn or directive_fn</span>
        <span class="c"># They are relative paths!</span>
        <span class="n">static_dir</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">slideshow_path</span><span class="p">,</span><span class="s">&#39;_static&#39;</span><span class="p">)</span>
        <span class="n">table</span> <span class="o">=</span> <span class="p">(</span>
            <span class="c"># (&#39;at_image_fn   &#39;,sc.at_image_fn),</span>
            <span class="p">(</span><span class="s">&#39;output_fn     &#39;</span><span class="p">,</span><span class="n">sc</span><span class="o">.</span><span class="n">output_fn</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;screenshot_fn &#39;</span><span class="p">,</span><span class="n">sc</span><span class="o">.</span><span class="n">screenshot_fn</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;sphinx_path   &#39;</span><span class="p">,</span><span class="n">sc</span><span class="o">.</span><span class="n">sphinx_path</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;slide_fn      &#39;</span><span class="p">,</span><span class="n">sc</span><span class="o">.</span><span class="n">slide_fn</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;slideshow_path&#39;</span><span class="p">,</span><span class="n">sc</span><span class="o">.</span><span class="n">slideshow_path</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;template_fn   &#39;</span><span class="p">,</span><span class="n">sc</span><span class="o">.</span><span class="n">template_fn</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;working_fn    &#39;</span><span class="p">,</span><span class="n">sc</span><span class="o">.</span><span class="n">working_fn</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;_static       &#39;</span><span class="p">,</span><span class="n">static_dir</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">tag</span><span class="p">,</span><span class="n">path</span> <span class="ow">in</span> <span class="n">table</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tag</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;fn&#39;</span><span class="p">):</span>
                <span class="n">path</span><span class="p">,</span><span class="n">junk</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_split</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="n">path</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">makeAllNonExistentDirectories</span><span class="p">(</span><span class="n">path</span><span class="p">,</span>
                    <span class="n">c</span><span class="o">=</span><span class="n">sc</span><span class="o">.</span><span class="n">c</span><span class="p">,</span><span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20101008112639.5625: *4* make_at_url_node_for_built_slide</span></div>
<div class="viewcode-block" id="ScreenShotController.make_at_url_node_for_built_slide"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.make_at_url_node_for_built_slide">[docs]</a>    <span class="k">def</span> <span class="nf">make_at_url_node_for_built_slide</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Create an @url node for built slide.&#39;&#39;&#39;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">c</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">slide_node</span>
        <span class="n">h</span> <span class="o">=</span> <span class="s">&#39;@url built slide&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sc</span><span class="o">.</span><span class="n">find_node</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">h</span><span class="p">):</span>
            <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">junk</span><span class="p">,</span><span class="n">fn</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_split</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">slide_fn</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fn</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.txt&#39;</span><span class="p">):</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="n">fn</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">insertAsLastChild</span><span class="p">()</span>
            <span class="n">p2</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="n">h</span>
            <span class="n">p2</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span>
                <span class="n">sc</span><span class="o">.</span><span class="n">slideshow_path</span><span class="p">,</span><span class="s">&#39;_build&#39;</span><span class="p">,</span><span class="s">&#39;html&#39;</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20101008112639.5631: *4* make_at_url_node_for_output_file</span></div>
<div class="viewcode-block" id="ScreenShotController.make_at_url_node_for_output_file"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.make_at_url_node_for_output_file">[docs]</a>    <span class="k">def</span> <span class="nf">make_at_url_node_for_output_file</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Create an @url node for the final output file.&#39;&#39;&#39;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">c</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">slide_node</span>
        <span class="n">h</span> <span class="o">=</span> <span class="s">&#39;@url final output file&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sc</span><span class="o">.</span><span class="n">find_node</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">h</span><span class="p">):</span>
            <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">insertAsLastChild</span><span class="p">()</span>
            <span class="n">p2</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="n">h</span>
            <span class="n">p2</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">output_fn</span>
    <span class="c">#@+node:ekr.20101008112639.5627: *4* make_at_url_node_for_screenshot</span></div>
<div class="viewcode-block" id="ScreenShotController.make_at_url_node_for_screenshot"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.make_at_url_node_for_screenshot">[docs]</a>    <span class="k">def</span> <span class="nf">make_at_url_node_for_screenshot</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Create an @url node for the screenshot file.&#39;&#39;&#39;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">c</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">slide_node</span>
        <span class="n">h</span> <span class="o">=</span> <span class="s">&#39;@url screenshot&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sc</span><span class="o">.</span><span class="n">find_node</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">h</span><span class="p">):</span>
            <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">insertAsLastChild</span><span class="p">()</span>
            <span class="n">p2</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="n">h</span>
            <span class="n">p2</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">screenshot_fn</span>
    <span class="c">#@+node:ekr.20101008112639.5624: *4* make_at_url_node_for_working_file</span></div>
<div class="viewcode-block" id="ScreenShotController.make_at_url_node_for_working_file"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.make_at_url_node_for_working_file">[docs]</a>    <span class="k">def</span> <span class="nf">make_at_url_node_for_working_file</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Create an @url node for the working file.&#39;&#39;&#39;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">c</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">slide_node</span>
        <span class="n">h</span> <span class="o">=</span> <span class="s">&#39;@url working file&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sc</span><span class="o">.</span><span class="n">find_node</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">h</span><span class="p">):</span>
            <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">insertAsLastChild</span><span class="p">()</span>
            <span class="n">p2</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="n">h</span>
            <span class="n">p2</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">working_fn</span>
    <span class="c">#@+node:ekr.20100908110845.5599: *4* make_image_node (not used)</span>
    <span class="c"># def make_image_node (self):</span>

        <span class="c"># &#39;&#39;&#39;Create an @image node as the first child of sc.slide_node.&#39;&#39;&#39;</span>

        <span class="c"># sc = self ; c = sc.c ; p = sc.slide_node</span>

        <span class="c"># h = &#39;@image %s&#39; % sc.at_image_fn</span>

        <span class="c"># # Create the node if it doesn&#39;t exist.</span>
        <span class="c"># for child in p.children():</span>
            <span class="c"># if child.h == h:</span>
                <span class="c"># # print(&#39;already exists: %s&#39; % h)</span>
                <span class="c"># break</span>
        <span class="c"># else:</span>
            <span class="c"># c.selectPosition(p)</span>
            <span class="c"># p2 = p.insertAsNthChild(0)</span>
            <span class="c"># p2.h = h</span>
    <span class="c">#@+node:ekr.20101006060338.5698: *4* make_toc</span></div>
<div class="viewcode-block" id="ScreenShotController.make_toc"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.make_toc">[docs]</a>    <span class="k">def</span> <span class="nf">make_toc</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c">#@+&lt;&lt; define toc_body &gt;&gt;</span>
        <span class="c">#@+node:ekr.20101006060338.5699: *5* &lt;&lt; define toc_body &gt;&gt;</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">slideshow_node</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s">&#39;@slideshow&#39;</span><span class="p">):]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">underline</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">title</span><span class="p">())</span>

        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s">        </span><span class="si">%s</span><span class="s"></span>

<span class="s">        Contents:</span>

<span class="s">        .. toctree::</span>
<span class="s">           :maxdepth: 1</span>
<span class="s">           :glob:</span>

<span class="s">           slide-*</span>
<span class="s">        &#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">title</span><span class="p">)</span> <span class="c">#,sc.slide_base_name)</span>

        <span class="c"># Indices and tables</span>
        <span class="c"># ==================</span>

        <span class="c"># * :ref:`genindex`</span>
        <span class="c"># * :ref:`search`</span>

        <span class="n">toc_body</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">adjustTripleString</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">sc</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">tab_width</span><span class="p">)</span>
        <span class="c">#@-&lt;&lt; define toc_body &gt;&gt;</span>

        <span class="n">fn</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="s">&#39;leo_toc.html.txt&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span> <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">toc_body</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">note</span><span class="p">(</span><span class="s">&#39;wrote:&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;writing&#39;</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20101113193341.5446: *4* match</span></div>
<div class="viewcode-block" id="ScreenShotController.match"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.match">[docs]</a>    <span class="k">def</span> <span class="nf">match</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">pattern</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return True if p.h matches the pattern.&#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">pattern</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100911044508.5636: *4* open_inkscape_with_list (not used)</span>
    <span class="c"># def open_inkscape_with_list (self,aList):</span>

        <span class="c"># &#39;&#39;&#39;Open inkscape with a list of file.&#39;&#39;&#39;</span>

        <span class="c"># sc = self</span>
        <span class="c"># cmd = [sc.inkscape_bin,&quot;--with-gui&quot;]</span>
        <span class="c"># cmd.extend(aList)</span>

        <span class="c"># proc = subprocess.Popen(cmd, stderr=subprocess.PIPE)</span>
        <span class="c"># proc.communicate() # Wait for Inkscape to terminate.</span>
    <span class="c">#@+node:ekr.20101021065622.5633: *4* remove_built_slide_node</span></div>
<div class="viewcode-block" id="ScreenShotController.remove_built_slide_node"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.remove_built_slide_node">[docs]</a>    <span class="k">def</span> <span class="nf">remove_built_slide_node</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">c</span>
        <span class="n">changed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;@url built slide&#39;</span><span class="p">):</span>
                <span class="c"># g.trace(child.b)</span>
                <span class="n">child</span><span class="o">.</span><span class="n">doDelete</span><span class="p">()</span>
                <span class="n">changed</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">changed</span><span class="p">:</span>
            <span class="c"># g.es(&#39;deleted %s nodes&#39; % (changed))</span>
            <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20100909193826.5600: *4* select_at_image_node (not used)</span>
    <span class="c"># def select_at_image_node (self,p):</span>

        <span class="c"># &#39;&#39;&#39;Select the @image node in one of p&#39;s direct children.&#39;&#39;&#39;</span>

        <span class="c"># sc = self ; c = sc.c</span>
        <span class="c"># for child in p.children():</span>
            <span class="c"># if g.match_word(child.h,0,&#39;@image&#39;):</span>
                <span class="c"># c.selectPosition(child)</span>
                <span class="c"># c.redraw_now(child)</span>
                <span class="c"># break</span>
        <span class="c"># else:</span>
            <span class="c"># c.selectPosition(p)</span>
            <span class="c"># c.redraw_now(p)</span>
    <span class="c">#@+node:ekr.20101005193146.5690: *4* underline</span></div>
<div class="viewcode-block" id="ScreenShotController.underline"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.underline">[docs]</a>    <span class="k">def</span> <span class="nf">underline</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return s overlined and underlined with &#39;=&#39; characters.&#39;&#39;&#39;</span>

        <span class="c"># Write longer underlines for non-ascii characters.</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span><span class="n">reportErrors</span><span class="o">=</span><span class="bp">False</span><span class="p">)))</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="s">&#39;=&#39;</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ch</span><span class="o">*</span><span class="n">n</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">ch</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
        <span class="c"># return &#39;%s\n%s\n&#39; % (s,ch*n)</span>
    <span class="c">#@+node:ekr.20100911044508.5616: *3* sc.run &amp; helpers</span></div>
<div class="viewcode-block" id="ScreenShotController.run"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Create a slide from node p.</span>
<span class="sd">        Call Inkscape to edit the slide if requested.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">c</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sc</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">p</span><span class="p">):</span> <span class="k">return</span>

        <span class="c"># Make directories and copy the sphinx build files into them.</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">make_all_directories</span><span class="p">()</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">copy_files</span><span class="p">()</span>

        <span class="c"># &quot;@url built slide&quot; inhibits everything.</span>
        <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">find_node</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">slide_node</span><span class="p">,</span><span class="s">&#39;@url built slide&#39;</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&#39;exists: @url built slide in </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="n">sc</span><span class="o">.</span><span class="n">make_slide</span><span class="p">()</span>

        <span class="c"># &quot;@url final output file&quot; inhibits everything except the build.</span>
        <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">find_node</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">slide_node</span><span class="p">,</span><span class="s">&#39;@url final output file&#39;</span><span class="p">):</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">make_at_url_node_for_built_slide</span><span class="p">()</span>
            <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&#39;exists: @url final output file </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="c"># Do only a build if there is no @screenshot tree.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sc</span><span class="o">.</span><span class="n">screenshot_tree</span><span class="p">:</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">make_at_url_node_for_built_slide</span><span class="p">()</span>
            <span class="k">return</span> <span class="c"># Don&#39;t take any screenshot!</span>

        <span class="c"># &#39;@url screenshot&#39; inhibits taking the screenshot.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sc</span><span class="o">.</span><span class="n">find_node</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">slide_node</span><span class="p">,</span><span class="s">&#39;@url screenshot&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">take_screen_shot</span><span class="p">():</span>
                <span class="n">sc</span><span class="o">.</span><span class="n">make_at_url_node_for_screenshot</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;can not make screen shot:&#39;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
                <span class="n">sc</span><span class="o">.</span><span class="n">make_at_url_node_for_built_slide</span><span class="p">()</span>
                <span class="k">return</span>

        <span class="c"># &quot;@url working file&quot; inhibits making a new working file.</span>
        <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">find_node</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">slide_node</span><span class="p">,</span><span class="s">&#39;@url working file&#39;</span><span class="p">):</span>
            <span class="c"># Make a new output file *only* if the working file is newer.</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">working_fn</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">sc</span><span class="o">.</span><span class="n">output_fn</span> <span class="ow">and</span> 
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">working_fn</span><span class="p">)</span> <span class="o">&gt;</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">output_fn</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">sc</span><span class="o">.</span><span class="n">make_output_file</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># Make sure this has been made.</span>
                <span class="n">sc</span><span class="o">.</span><span class="n">make_at_url_node_for_output_file</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Make the working file and output file</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">make_working_file</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">edit_flag</span><span class="p">:</span>
                <span class="n">sc</span><span class="o">.</span><span class="n">edit_working_file</span><span class="p">()</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">make_output_file</span><span class="p">()</span>

        <span class="c"># Build slide after creating the output file ;-)</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">make_at_url_node_for_built_slide</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20100908110845.5552: *4* edit_working_file &amp; helper</span></div>
<div class="viewcode-block" id="ScreenShotController.edit_working_file"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.edit_working_file">[docs]</a>    <span class="k">def</span> <span class="nf">edit_working_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Invoke Inkscape on the working file.&#39;&#39;&#39;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">g</span><span class="o">.</span><span class="n">red</span><span class="p">(</span><span class="s">&#39;Opening Inkscape...</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">outerUpdate</span><span class="p">()</span>

        <span class="n">sc</span><span class="o">.</span><span class="n">enable_filters</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">working_fn</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">sc</span><span class="o">.</span><span class="n">inkscape_bin</span><span class="p">,</span><span class="s">&quot;--with-gui&quot;</span><span class="p">,</span><span class="n">sc</span><span class="o">.</span><span class="n">working_fn</span><span class="p">]</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>  <span class="c"># Wait for Inkscape to terminate.</span>

        <span class="n">sc</span><span class="o">.</span><span class="n">enable_filters</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">working_fn</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100908110845.5553: *5* enable_filters</span></div>
<div class="viewcode-block" id="ScreenShotController.enable_filters"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.enable_filters">[docs]</a>    <span class="k">def</span> <span class="nf">enable_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">svgfile</span><span class="p">,</span><span class="n">enable</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Disable/enable filters in SVG at the XML level</span>

<span class="sd">        The drop-shadow filter on several objects kills editing performance</span>
<span class="sd">        in inkscape, so this turns them on/off in the XML.  There&#39;s a GUI</span>
<span class="sd">        operation to turn them off in inkscape, but it&#39;s a pain to have to</span>
<span class="sd">        keep using it.</span>

<span class="sd">        Disabling copys the real @style to @__style and changes</span>
<span class="sd">        &quot;filter:url&quot; to &quot;_filter:url&quot; in the active @style, while</span>
<span class="sd">        enabling just copys @__style to @style and deletes @__style.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">svgfile</span><span class="p">)</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">enable</span><span class="p">:</span>
            <span class="c"># copy @__style to @style and deletes @__style.</span>
            <span class="n">aList</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">getElementsWithAttrib</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="s">&#39;__style&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
                <span class="n">i</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;style&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;__style&quot;</span><span class="p">))</span>
                <span class="k">del</span> <span class="n">i</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s">&#39;__style&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">aList3</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">getElementsWithAttrib</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="s">&#39;style&#39;</span><span class="p">)</span>
            <span class="n">aList</span> <span class="o">=</span> <span class="p">[</span><span class="n">z</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">aList3</span>
                <span class="k">if</span> <span class="n">z</span><span class="o">.</span><span class="n">attrib</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;style&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;filter:url(&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c"># copy the real @style to @__style and</span>
            <span class="c"># changes &quot;filter:url&quot; to &quot;_filter:url&quot; in the active @style</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
                <span class="n">i</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;__style&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;style&quot;</span><span class="p">))</span>
                <span class="n">i</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;style&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;style&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                    <span class="s">&#39;filter:url(&#39;</span><span class="p">,</span> <span class="s">&#39;_filter:url(&#39;</span><span class="p">))</span>

        <span class="n">doc</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">svgfile</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20100908110845.5554: *4* make_output_file &amp; helper</span></div>
<div class="viewcode-block" id="ScreenShotController.make_output_file"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.make_output_file">[docs]</a>    <span class="k">def</span> <span class="nf">make_output_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Create the output file from the working file.&#39;&#39;&#39;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sc</span><span class="o">.</span><span class="n">output_fn</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">note</span><span class="p">(</span><span class="s">&#39;no output file&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">inkscape_bin</span><span class="p">,</span>
            <span class="s">&quot;--without-gui&quot;</span><span class="p">,</span>
            <span class="s">&quot;--export-png=&quot;</span><span class="o">+</span><span class="n">sc</span><span class="o">.</span><span class="n">output_fn</span><span class="p">,</span>
            <span class="s">&quot;--export-area-drawing&quot;</span><span class="p">,</span>
            <span class="s">&quot;--export-area-snap&quot;</span><span class="p">,</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">working_fn</span><span class="p">)</span>

        <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span> <span class="c"># Wait for Inkscape to terminate.</span>

        <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">note</span><span class="p">(</span><span class="s">&#39;wrote:  </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">g</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">output_fn</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">got_pil</span><span class="p">:</span> <span class="c"># trim transparent border</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">output_fn</span><span class="p">)</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
                <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">output_fn</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;can not open </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">sc</span><span class="o">.</span><span class="n">output_fn</span><span class="p">)</span>

        <span class="n">sc</span><span class="o">.</span><span class="n">make_at_url_node_for_output_file</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20100908110845.5555: *5* trim</span></div>
<div class="viewcode-block" id="ScreenShotController.trim"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.trim">[docs]</a>    <span class="k">def</span> <span class="nf">trim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">border</span><span class="p">):</span>

        <span class="n">bg</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">border</span><span class="p">)</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">ImageChops</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">bg</span><span class="p">)</span>
        <span class="n">bbox</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">getbbox</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">bbox</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">im</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="n">bbox</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># found no content</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;cannot trim; image was empty&quot;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20101004082701.5739: *4* make_slide &amp; helpers</span>
    <span class="c">#  Don&#39;t call rstCommands.writeToDocutils--we are using sphinx!</span></div>
<div class="viewcode-block" id="ScreenShotController.make_slide"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.make_slide">[docs]</a>    <span class="k">def</span> <span class="nf">make_slide</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Write sc.slide_node.b to &lt;sc.slide_fn&gt;, a .html.txt file.&#39;&#39;&#39;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">slide_fn</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">make_slide_contents</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">note</span><span class="p">(</span><span class="s">&#39;wrote: &#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;writing:&#39;</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20101005193146.5689: *5* make_slide_contents</span></div>
<div class="viewcode-block" id="ScreenShotController.make_slide_contents"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.make_slide_contents">[docs]</a>    <span class="k">def</span> <span class="nf">make_slide_contents</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">slide_number</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get_slide_title</span><span class="p">()</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">slide_node</span><span class="o">.</span><span class="n">b</span>
        <span class="c"># 2010/11/21: Don&#39;t use h.title(): it can produce bad results.</span>
        <span class="c"># title = sc.underline(h.title())</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">underline</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span><span class="n">body</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20101006060338.5702: *4* make_working_file &amp; helpers</span></div>
<div class="viewcode-block" id="ScreenShotController.make_working_file"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.make_working_file">[docs]</a>    <span class="k">def</span> <span class="nf">make_working_file</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">sc</span><span class="o">.</span><span class="n">give_pil_warning</span><span class="p">()</span>

        <span class="c"># Create the working file from the template.</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">make_dom</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">template</span><span class="p">:</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">make_working_file_from_template</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">make_at_url_node_for_working_file</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;can not make template from:&#39;</span><span class="p">,</span><span class="n">template_fn</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100908110845.5546: *5* make_dom &amp; helpers</span></div>
<div class="viewcode-block" id="ScreenShotController.make_dom"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.make_dom">[docs]</a>    <span class="k">def</span> <span class="nf">make_dom</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Create the template dom object.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">True</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get_template</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">template</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
        <span class="n">ids_d</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">getIds</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="n">parents_d</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">getParents</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>

        <span class="c"># make a dict of the groups we&#39;re going to manipulate</span>
        <span class="n">part</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">z</span><span class="p">,</span><span class="n">ids_d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;co_g_co&#39;</span><span class="p">,</span> <span class="s">&#39;co_g_bc_1&#39;</span><span class="p">,</span> <span class="s">&#39;co_g_bc_2&#39;</span><span class="p">)])</span>

        <span class="c"># note where we should place modified copies</span>
        <span class="n">part_parent</span> <span class="o">=</span> <span class="n">parents_d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;co_g_co&#39;</span><span class="p">))</span>

        <span class="c"># remove them from the document</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">part</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">parents_d</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">getParents</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">parents_d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">parent</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">callout</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">callouts</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;callout </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">callout</span><span class="p">))</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">part</span><span class="p">[</span><span class="s">&#39;co_g_co&#39;</span><span class="p">])</span>
            <span class="n">ids_d</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">getIds</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">ids_d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;co_text_holder&#39;</span><span class="p">)</span>
            <span class="n">text</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">callout</span>
            <span class="c"># need distinct IDs on frames/text for sizing</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">ids_d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;co_frame&#39;</span><span class="p">)</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">clear_id</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="c"># let inkscape pick new IDs for other elements</span>

            <span class="c"># A) it&#39;s the flowRoot, not the flowPara, which carries the size info</span>
            <span class="c"># B) Inkscape trashes the IDs on flowParas on load!</span>
            <span class="n">parents_d</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">getParents</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">parents_d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="n">parent</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;co_text_</span><span class="si">%d</span><span class="s">&#39;</span><span class="o">%</span><span class="n">n</span><span class="p">)</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;co_frame_</span><span class="si">%d</span><span class="s">&#39;</span><span class="o">%</span><span class="n">n</span><span class="p">)</span>

            <span class="c"># offset so user can see them all</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">move_element</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="mi">20</span><span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="mi">20</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
            <span class="n">part_parent</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">number</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">markers</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;number </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">number</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">number</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">use_g</span><span class="p">,</span><span class="n">use_t</span> <span class="o">=</span> <span class="s">&#39;co_g_bc_2&#39;</span><span class="p">,</span> <span class="s">&#39;co_bc_text_2&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">use_g</span><span class="p">,</span><span class="n">use_t</span> <span class="o">=</span> <span class="s">&#39;co_g_bc_1&#39;</span><span class="p">,</span> <span class="s">&#39;co_bc_text_1&#39;</span>

            <span class="n">z</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">part</span><span class="p">[</span><span class="n">use_g</span><span class="p">])</span>
            <span class="n">ids_d</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">getIds</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
            <span class="n">bc_text</span> <span class="o">=</span> <span class="n">ids_d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">use_t</span><span class="p">)</span> 
            <span class="n">bc_text</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">move_element</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="mi">20</span><span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="mi">20</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
            <span class="n">part_parent</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

        <span class="c"># point to the right screen shot</span>
        <span class="n">ids_d</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">getIds</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">getroot</span><span class="p">())</span>
        <span class="n">img_element</span> <span class="o">=</span> <span class="n">ids_d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;co_shot&#39;</span><span class="p">)</span>
        <span class="n">img_element</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">xlink</span><span class="o">+</span><span class="s">&#39;href&#39;</span><span class="p">,</span><span class="n">sc</span><span class="o">.</span><span class="n">screenshot_fn</span><span class="p">)</span>

        <span class="c"># adjust screen shot dimensions</span>
        <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">got_pil</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">screenshot_fn</span><span class="p">)</span>
            <span class="n">img_element</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;width&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">img_element</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;height&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="c"># write temp file to get size info</span>
        <span class="n">fh</span><span class="p">,</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
        <span class="n">template</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>

        <span class="c"># could reload file at this point to reflect offsets etc.</span>
        <span class="c"># but don&#39;t need to because of relative position mode in paths</span>

        <span class="c"># resize things to fit text</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">callout</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">callouts</span><span class="p">):</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">resize_curve_box</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span><span class="n">template</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">template</span>
    <span class="c">#@+node:ekr.20100908110845.5547: *6* clear_id</span></div>
<div class="viewcode-block" id="ScreenShotController.clear_id"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.clear_id">[docs]</a>    <span class="k">def</span> <span class="nf">clear_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Recursively clear @id on element x and descendants.&quot;&quot;&quot;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="s">&#39;id&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">del</span> <span class="n">x</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span>

        <span class="n">ids_d</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">getIds</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">objects</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">ids_d</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">z</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">x</span>
    <span class="c">#@+node:ekr.20100908110845.5548: *6* get_template</span></div>
<div class="viewcode-block" id="ScreenShotController.get_template"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.get_template">[docs]</a>    <span class="k">def</span> <span class="nf">get_template</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Load and check the template SVG and return DOM&quot;&quot;&quot;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">infile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">template_fn</span><span class="p">)</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
        <span class="n">ids_d</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">getIds</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">getroot</span><span class="p">())</span>

        <span class="c"># check all IDs we expect are present</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ids_d</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">template</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;template did not include all required IDs:&#39;</span><span class="p">,</span><span class="n">sc</span><span class="o">.</span><span class="n">template_fn</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20100908110845.5549: *6* move_element</span></div>
<div class="viewcode-block" id="ScreenShotController.move_element"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.move_element">[docs]</a>    <span class="k">def</span> <span class="nf">move_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">element</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;transform&#39;</span><span class="p">):</span>
            <span class="n">element</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;transform&#39;</span><span class="p">,</span> <span class="s">&quot;translate(</span><span class="si">%f</span><span class="s">,</span><span class="si">%f</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ox</span><span class="p">,</span><span class="n">oy</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;transform&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">ox</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;(&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">oy</span> <span class="o">=</span> <span class="n">oy</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;)&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">element</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;transform&#39;</span><span class="p">,</span> <span class="s">&quot;translate(</span><span class="si">%f</span><span class="s">,</span><span class="si">%f</span><span class="s">)&quot;</span> <span class="o">%</span>
                <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ox</span><span class="p">)</span><span class="o">+</span><span class="n">x</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">oy</span><span class="p">)</span><span class="o">+</span><span class="n">y</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20100908110845.5550: *6* resize_curve_box &amp; helper</span></div>
<div class="viewcode-block" id="ScreenShotController.resize_curve_box"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.resize_curve_box">[docs]</a>    <span class="k">def</span> <span class="nf">resize_curve_box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span><span class="n">template</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">getIds</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">getroot</span><span class="p">())</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;co_text_</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">))</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;co_frame_</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">))</span>
        <span class="n">text_id</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span>
        <span class="n">frame_id</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span>

        <span class="n">pnts</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;d&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">pnts</span><span class="p">):</span>
            <span class="k">if</span> <span class="s">&#39;,&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pnts</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">type_</span> <span class="o">=</span> <span class="n">pnts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">pnts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pnts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">pnts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)]</span>
                <span class="n">pnts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">type_</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">type_</span> <span class="o">==</span> <span class="s">&#39;m&#39;</span><span class="p">:</span>
                    <span class="n">type_</span> <span class="o">=</span> <span class="s">&#39;l&#39;</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c"># kludge for now</span>
        <span class="n">h0</span> <span class="o">=</span> <span class="mi">12</span>  <span class="c"># index of vertical component going down right side</span>
        <span class="n">h1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span>  <span class="c"># index of vertical component coming up left side</span>
        <span class="n">min_</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c"># must leave this many</span>
        <span class="n">present</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c"># components present initially</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">pnts</span><span class="p">[</span><span class="n">h0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>  <span class="c"># height of one component</span>
        <span class="n">th</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get_dim</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">text_id</span><span class="p">,</span><span class="s">&#39;height&#39;</span><span class="p">)</span>  <span class="c"># text height</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">th</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;no th&#39;</span><span class="p">)</span>
        <span class="c"># g.trace(&#39;  &#39;, present, h, present*h, th)</span>
        <span class="k">while</span> <span class="n">present</span> <span class="o">&gt;</span> <span class="n">min_</span> <span class="ow">and</span> <span class="n">present</span> <span class="o">*</span> <span class="n">h</span> <span class="o">+</span> <span class="mi">15</span> <span class="o">&gt;</span> <span class="n">th</span><span class="p">:</span>
            <span class="c"># g.trace(&#39;  &#39;, present, h, present*h, th)</span>
            <span class="k">del</span> <span class="n">pnts</span><span class="p">[</span><span class="n">h0</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">pnts</span><span class="p">[</span><span class="n">h1</span><span class="p">]</span>
            <span class="n">present</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="n">last</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pnts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">last</span> <span class="o">!=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">last</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">last</span> <span class="o">==</span> <span class="s">&#39;m&#39;</span><span class="p">:</span>
                    <span class="n">last</span> <span class="o">=</span> <span class="s">&#39;l&#39;</span>
                <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="n">d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;z&#39;</span><span class="p">)</span>

        <span class="n">frame</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;d&#39;</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20100908110845.5551: *7* get_dim</span></div>
<div class="viewcode-block" id="ScreenShotController.get_dim"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.get_dim">[docs]</a>    <span class="k">def</span> <span class="nf">get_dim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">Id</span><span class="p">,</span> <span class="n">what</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return dimension of element in fn with @id Id, what is</span>
<span class="sd">        x, y, width, or height</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">hsh</span> <span class="o">=</span> <span class="n">fn</span><span class="o">+</span><span class="n">Id</span><span class="o">+</span><span class="n">what</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;hsh&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">fn</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">Id</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">what</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">hsh</span> <span class="ow">in</span> <span class="n">sc</span><span class="o">.</span><span class="n">dimCache</span><span class="p">:</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">is_cache</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">sc</span><span class="o">.</span><span class="n">dimCache</span><span class="p">[</span><span class="n">hsh</span><span class="p">]</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">sc</span><span class="o">.</span><span class="n">inkscape_bin</span><span class="p">,</span> <span class="s">&#39;--without-gui&#39;</span><span class="p">,</span> <span class="s">&#39;--query-all&#39;</span><span class="p">,</span> <span class="n">fn</span><span class="p">]</span>

        <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span>
            <span class="n">stdout</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">stderr</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>

        <span class="c"># make new pipe for stderr to supress chatter from inkscape.</span>
        <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span> <span class="c"># Wait for Inkscape to terminate.</span>
        <span class="n">s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c"># Necessary for Python 3k.</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;b&#39;&quot;</span><span class="p">):</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;&#39;&quot;</span><span class="p">):</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">aList</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">r&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">n&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="k">continue</span>
            <span class="n">id_</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">h</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">,</span><span class="n">x</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;y&#39;</span><span class="p">,</span><span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;width&#39;</span><span class="p">,</span><span class="n">w</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;height&#39;</span><span class="p">,</span><span class="n">h</span><span class="p">):</span>
                <span class="n">hsh2</span> <span class="o">=</span> <span class="n">fn</span><span class="o">+</span><span class="n">id_</span><span class="o">+</span><span class="n">part</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;hsh2&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">id_</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">part</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">sc</span><span class="o">.</span><span class="n">dimCache</span><span class="p">[</span><span class="n">hsh2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">part</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">is_reads</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">assert</span> <span class="n">sc</span><span class="o">.</span><span class="n">dimCache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">hsh</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sc</span><span class="o">.</span><span class="n">dimCache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">hsh</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100908110845.5545: *5* make_working_file_from_template</span></div>
<div class="viewcode-block" id="ScreenShotController.make_working_file_from_template"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.make_working_file_from_template">[docs]</a>    <span class="k">def</span> <span class="nf">make_working_file_from_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">template</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Create the working file from the template.&#39;&#39;&#39;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">working_fn</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">template</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">note</span><span class="p">(</span><span class="s">&#39;wrote: &#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>
        <span class="n">outfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20100909121239.6117: *4* take_screen_shot &amp; helpers</span></div>
<div class="viewcode-block" id="ScreenShotController.take_screen_shot"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.take_screen_shot">[docs]</a>    <span class="k">def</span> <span class="nf">take_screen_shot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Take the screen shot, create an @image node,</span>
<span class="sd">        and add an .. image:: directive to p.&#39;&#39;&#39;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">slide_node</span>

        <span class="c"># Always create &#39;screenshot-setup.leo&#39; </span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">create_setup_leo_file</span><span class="p">()</span>

        <span class="c"># Always open fn in a separate process.</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">setup_screen_shot</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">note</span><span class="p">(</span><span class="s">&#39;wrote:  </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">g</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">screenshot_fn</span><span class="p">))</span>
                <span class="c"># g.note(&#39;slide node:  %s&#39; % p.h)</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">add_image_directive</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ok</span>
    <span class="c">#@+node:ekr.20100914090933.5643: *5* create_setup_leo_file</span></div>
<div class="viewcode-block" id="ScreenShotController.create_setup_leo_file"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.create_setup_leo_file">[docs]</a>    <span class="k">def</span> <span class="nf">create_setup_leo_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Create an ouline containing all children of sc.screenshot_tree.</span>
<span class="sd">        Do not copy @slide nodes or @slideshow nodes.&#39;&#39;&#39;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="s">&#39;screenshot-setup.leo&#39;</span><span class="p">)</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">newCommander</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">isSlide</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;@slide&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;@slideshow&#39;</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">createFirstTreeNode</span><span class="p">()</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span>

        <span class="c"># Remember the expanded nodes.</span>
        <span class="n">expanded</span> <span class="o">=</span> <span class="p">[</span><span class="n">z</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">sc</span><span class="o">.</span><span class="n">screenshot_tree</span><span class="o">.</span><span class="n">subtree</span><span class="p">()</span> <span class="k">if</span> <span class="n">z</span><span class="o">.</span><span class="n">isExpanded</span><span class="p">()]</span>

        <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">screenshot_tree</span><span class="p">:</span>
            <span class="c"># Copy all descendants of the @screenshot node.</span>
            <span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">z</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">sc</span><span class="o">.</span><span class="n">screenshot_tree</span><span class="o">.</span><span class="n">children</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">isSlide</span><span class="p">(</span><span class="n">z</span><span class="p">)]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">children</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;empty @screenshot tree&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;can not happen. no screenshot tree&#39;</span><span class="p">)</span>

        <span class="n">child1</span> <span class="o">=</span> <span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">child1</span><span class="o">.</span><span class="n">copyTreeFromSelfTo</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">root</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">child2</span> <span class="o">=</span> <span class="n">last</span><span class="o">.</span><span class="n">insertAfter</span><span class="p">()</span>
            <span class="n">child</span><span class="o">.</span><span class="n">copyTreeFromSelfTo</span><span class="p">(</span><span class="n">child2</span><span class="p">)</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">child2</span>

        <span class="c"># Set the expanded bits in the new file.</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">all_unique_positions</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">z2</span> <span class="ow">in</span> <span class="n">expanded</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">z2</span><span class="o">.</span><span class="n">h</span> <span class="o">==</span> <span class="n">z</span><span class="o">.</span><span class="n">h</span><span class="p">:</span>
                    <span class="n">z</span><span class="o">.</span><span class="n">expand</span><span class="p">()</span>
                    <span class="c"># g.trace(&#39;Expanding&#39;,z.h)</span>

        <span class="c"># Save the file silently.</span>
        <span class="n">c</span><span class="o">.</span><span class="n">fileCommands</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fn</span>
    <span class="c">#@+node:ekr.20100913085058.5659: *5* setup_screen_shot &amp; helpers</span></div>
<div class="viewcode-block" id="ScreenShotController.setup_screen_shot"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.setup_screen_shot">[docs]</a>    <span class="k">def</span> <span class="nf">setup_screen_shot</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Take the screen shot after adjusting the window and outline.&#39;&#39;&#39;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># Important: we must *not* have the clipboard open here!</span>
        <span class="c"># Doing so can hang if the user does a clipboard operation</span>
        <span class="c"># in a subprocess.</span>
        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">qtApp</span><span class="o">.</span><span class="n">clipboard</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">cb</span><span class="p">:</span> <span class="n">cb</span><span class="o">.</span><span class="n">clear</span><span class="p">(</span><span class="n">cb</span><span class="o">.</span><span class="n">Clipboard</span><span class="p">)</span> <span class="c"># Does not work anyway.</span>

        <span class="n">ok</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">open_screenshot_app</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ok</span> <span class="ow">and</span> <span class="n">sc</span><span class="o">.</span><span class="n">pause_flag</span><span class="p">:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">save_clipboard_to_screenshot_file</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">ok</span>
    <span class="c">#@+node:ekr.20100913085058.5656: *6* open_screenshot_app</span></div>
<div class="viewcode-block" id="ScreenShotController.open_screenshot_app"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.open_screenshot_app">[docs]</a>    <span class="k">def</span> <span class="nf">open_screenshot_app</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">leo_fn</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Open the screenshot app.</span>
<span class="sd">        Return True if the app exists and can be opened.&#39;&#39;&#39;</span>

        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">c</span>
        <span class="n">launch</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadDir</span><span class="p">,</span>
            <span class="s">&#39;..&#39;</span><span class="p">,</span><span class="s">&#39;..&#39;</span><span class="p">,</span><span class="s">&#39;launchLeo.py&#39;</span><span class="p">)</span>
        <span class="n">python</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">executable</span>

        <span class="n">h</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">screenshot_height</span><span class="p">,</span><span class="n">sc</span><span class="o">.</span><span class="n">screenshot_width</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">python</span><span class="p">,</span><span class="n">launch</span><span class="p">,</span><span class="s">&#39;--window-size=</span><span class="si">%s</span><span class="s">x</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">w</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">select_node</span><span class="p">:</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;--select=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">select_node</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">pause_flag</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">red</span><span class="p">(</span><span class="s">&#39;Pausing:&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">screenshot_fn</span><span class="p">))</span>
            <span class="n">g</span><span class="o">.</span><span class="n">note</span><span class="p">(</span><span class="s">&#39;Please take the screenshot by hand&#39;</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">outerUpdate</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;--screen-shot=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">sc</span><span class="o">.</span><span class="n">screenshot_fn</span><span class="p">)</span>

        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;--file=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">leo_fn</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Eat the output.</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>

        <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span> <span class="c"># Wait for Leo to terminate.</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="c">#@+node:ekr.20100913085058.5655: *6* save_clipboard_to_screenshot_file</span></div>
<div class="viewcode-block" id="ScreenShotController.save_clipboard_to_screenshot_file"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.save_clipboard_to_screenshot_file">[docs]</a>    <span class="k">def</span> <span class="nf">save_clipboard_to_screenshot_file</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Save the clipboard to screenshot_fn.</span>
<span class="sd">        Return True if all went well.&#39;&#39;&#39;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">cb</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">qtApp</span><span class="o">.</span><span class="n">clipboard</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cb</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;no clipboard&#39;</span><span class="p">)</span>

        <span class="n">image</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="n">image</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">image</span><span class="p">:</span>
            <span class="n">image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">screenshot_fn</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;no image on clipboard&#39;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20101113193341.5447: *3* sc.meld &amp; helpers</span></div>
<div class="viewcode-block" id="ScreenShotController.meld"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.meld">[docs]</a>    <span class="k">def</span> <span class="nf">meld</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sc</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">p</span><span class="p">):</span> <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sc</span><span class="o">.</span><span class="n">wink_path</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;No @wink_path node&#39;</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="o">*</span><span class="mi">20</span><span class="p">)</span>

        <span class="n">aList</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get_wink_screenshots</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">aList</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sc</span><span class="o">.</span><span class="n">check_meld</span><span class="p">(</span><span class="n">aList</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="c"># Pass 1: copy files for @slide nodes w/o @no-screenshot nodes.</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">copy_screenshots</span><span class="p">(</span><span class="n">aList</span><span class="p">)</span>

        <span class="c"># Pass 2: adjust children of @slide nodes.</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">adjust_slideshow</span><span class="p">()</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&#39;meld done&#39;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20101113193341.5448: *4* adjust_slideshow &amp; helper</span></div>
<div class="viewcode-block" id="ScreenShotController.adjust_slideshow"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.adjust_slideshow">[docs]</a>    <span class="k">def</span> <span class="nf">adjust_slideshow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Adjust all @slide nodes in the slideshow.&#39;&#39;&#39;</span>

        <span class="c"># Traverse the tree as in the screenshot plugin.</span>
        <span class="c"># That is, ignore @ignore trees and nested @slide nodes.</span>
        <span class="c"># This ensures that the slide number, n, is correct.</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">slideshow_node</span>
        <span class="n">after</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">nodeAfterTree</span><span class="p">()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">firstChild</span><span class="p">()</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">after</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s">&#39;@slide&#39;</span><span class="p">):</span>
                <span class="n">sc</span><span class="o">.</span><span class="n">adjust_slide_node</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
                <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">sc</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s">&#39;@ignore&#39;</span><span class="p">):</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20101113193341.5449: *5* adjust_slide_node &amp; helpers</span></div>
<div class="viewcode-block" id="ScreenShotController.adjust_slide_node"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.adjust_slide_node">[docs]</a>    <span class="k">def</span> <span class="nf">adjust_slide_node</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">slide_number</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Adjust p, an @slide node.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># Delete the first &quot;@url built slide&quot; node.</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">delete_at_url_built_slide_node</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="c"># Do nothing more if there is an @no-screenshot node.</span>
        <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">has_at_no_screenshot_node</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="c"># Add or update the &quot;@url final output file&quot; node.</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">add_at_url_final_output_file</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">slide_number</span><span class="p">)</span>

        <span class="c"># Add the .. image:: directive.</span>
        <span class="n">sc</span><span class="o">.</span><span class="n">add_image_directive</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">slide_number</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20101113193341.5450: *6* add_at_url_final_output_file</span></div>
<div class="viewcode-block" id="ScreenShotController.add_at_url_final_output_file"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.add_at_url_final_output_file">[docs]</a>    <span class="k">def</span> <span class="nf">add_at_url_final_output_file</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">slide_number</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Create or update the &quot;@url final output file&quot; node.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">tag</span> <span class="o">=</span><span class="s">&#39;@url final output file&#39;</span>

        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">child</span><span class="p">,</span><span class="n">tag</span><span class="p">):</span>
                <span class="n">p2</span> <span class="o">=</span> <span class="n">child</span> <span class="p">;</span> <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;add </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">tag</span><span class="p">)</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">insertAsLastChild</span><span class="p">()</span>
            <span class="n">p2</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="n">tag</span>

        <span class="n">p2</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span>
            <span class="s">&#39;slide-</span><span class="si">%03d</span><span class="s">.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">slide_number</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">p2</span>
    <span class="c">#@+node:ekr.20101113193341.5451: *6* add_image_directive</span></div>
<div class="viewcode-block" id="ScreenShotController.add_image_directive"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.add_image_directive">[docs]</a>    <span class="k">def</span> <span class="nf">add_image_directive</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">slide_number</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Add an image directive in p if it is not there.&#39;&#39;&#39;</span>

        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;.. image:: slide-</span><span class="si">%03d</span><span class="s">.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">slide_number</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n\n</span><span class="si">%s</span><span class="se">\n\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20101113193341.5452: *6* delete_at_url_built_slide_node</span></div>
<div class="viewcode-block" id="ScreenShotController.delete_at_url_built_slide_node"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.delete_at_url_built_slide_node">[docs]</a>    <span class="k">def</span> <span class="nf">delete_at_url_built_slide_node</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Delete any &quot;@url built slide&quot; node in p&#39;s children.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="s">&#39;@url built slide&#39;</span>

        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">child</span><span class="p">,</span><span class="n">tag</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;del </span><span class="si">%s</span><span class="s"> in </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">))</span>
                <span class="n">child</span><span class="o">.</span><span class="n">doDelete</span><span class="p">()</span>
                <span class="k">break</span>
    <span class="c">#@+node:ekr.20101113193341.5453: *4* check_meld &amp; helpers</span></div>
<div class="viewcode-block" id="ScreenShotController.check_meld"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.check_meld">[docs]</a>    <span class="k">def</span> <span class="nf">check_meld</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aList</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Check that len(aList) matches the number of @slide nodes in the</span>
<span class="sd">        slideshow. Don&#39;t count @slide nodes containing an @no-screenshot node.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">slideshow_node</span>
        <span class="n">n1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">aList</span><span class="p">)</span>
        <span class="n">n2</span><span class="p">,</span><span class="n">n3</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">count_slide_nodes</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sc</span><span class="o">.</span><span class="n">check_dir</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">wink_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sc</span><span class="o">.</span><span class="n">check_dir</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">slideshow_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sc</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s">&#39;@slideshow&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;not a @slideshow node: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">n1</span> <span class="o">!=</span> <span class="p">(</span><span class="n">n2</span><span class="o">-</span><span class="n">n3</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s">&#39;</span><span class="si">%s</span><span class="s"> wink slides</span><span class="se">\n</span><span class="s">&#39;</span>
                <span class="s">&#39;</span><span class="si">%s</span><span class="s"> @slide nodes</span><span class="se">\n</span><span class="s">&#39;</span>
                <span class="s">&#39;</span><span class="si">%s</span><span class="s"> @no_screenshot nodes&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">True</span>
    <span class="c">#@+node:ekr.20101113193341.5454: *5* check_dir</span></div>
<div class="viewcode-block" id="ScreenShotController.check_dir"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.check_dir">[docs]</a>    <span class="k">def</span> <span class="nf">check_dir</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">theDir</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">theDir</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;not found: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">theDir</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_isdir</span><span class="p">(</span><span class="n">theDir</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;not a directory: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">theDir</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">True</span>
    <span class="c">#@+node:ekr.20101113193341.5455: *5* count_slide_nodes</span></div>
<div class="viewcode-block" id="ScreenShotController.count_slide_nodes"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.count_slide_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">count_slide_nodes</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return n1,n2</span>

<span class="sd">        n1 is the total number of @slide nodes in the @slideshow tree.</span>
<span class="sd">        n2 is number of @slide nodes containing an @no-slideshow child.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">slideshow_node</span>
        <span class="n">after</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">nodeAfterTree</span><span class="p">()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">firstChild</span><span class="p">()</span>
        <span class="n">n1</span><span class="p">,</span><span class="n">n2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
        <span class="k">while</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">after</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s">&#39;@slide&#39;</span><span class="p">):</span>
                <span class="n">n1</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">has_at_no_screenshot_node</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                    <span class="n">n2</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">sc</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s">&#39;@ignore&#39;</span><span class="p">):</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>

        <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">n1</span><span class="p">,</span><span class="n">n2</span>
    <span class="c">#@+node:ekr.20101113193341.5456: *4* copy_screenshots &amp; helper</span></div>
<div class="viewcode-block" id="ScreenShotController.copy_screenshots"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.copy_screenshots">[docs]</a>    <span class="k">def</span> <span class="nf">copy_screenshots</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aList</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Copy files from the wink_path to slideshow_path,</span>
<span class="sd">        numbering the destination files to reflect &quot;holes&quot;</span>
<span class="sd">        created by @no-screenshot nodes.&#39;&#39;&#39;</span>

        <span class="c"># Traverse the tree as in the screenshot plugin.</span>
        <span class="c"># That is, ignore @ignore trees and nested @slide nodes.</span>
        <span class="c"># This ensures that the slide number, n, is correct.</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">slideshow_node</span>
        <span class="n">after</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">nodeAfterTree</span><span class="p">()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">firstChild</span><span class="p">()</span>
        <span class="n">wink_n</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># Wink screenshot numbers start at 0.</span>
        <span class="n">slide_n</span> <span class="o">=</span> <span class="mi">1</span> <span class="c"># Slide numbers start at 1.</span>
        <span class="k">while</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">after</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s">&#39;@slide&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">sc</span><span class="o">.</span><span class="n">has_at_no_screenshot_node</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                    <span class="n">sc</span><span class="o">.</span><span class="n">copy_screenshot</span><span class="p">(</span><span class="n">aList</span><span class="p">,</span><span class="n">slide_n</span><span class="p">,</span><span class="n">wink_n</span><span class="p">)</span>
                    <span class="n">wink_n</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">slide_n</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">sc</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s">&#39;@ignore&#39;</span><span class="p">):</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20101113193341.5457: *5* copy_screenshot</span></div>
<div class="viewcode-block" id="ScreenShotController.copy_screenshot"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.copy_screenshot">[docs]</a>    <span class="k">def</span> <span class="nf">copy_screenshot</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aList</span><span class="p">,</span><span class="n">slide_n</span><span class="p">,</span><span class="n">wink_n</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">wink_n</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">aList</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;can not happen: &#39;</span>
                <span class="s">&#39;len(aList): </span><span class="si">%s</span><span class="s">, n: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">aList</span><span class="p">),</span><span class="n">wink_n</span><span class="p">))</span>

        <span class="n">fn_src</span> <span class="o">=</span> <span class="n">aList</span><span class="p">[</span><span class="n">wink_n</span><span class="p">]</span>
        <span class="n">fn_dst</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="s">&#39;slide-</span><span class="si">%03d</span><span class="s">.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">slide_n</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%7s</span><span class="s"> -&gt; </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">(</span><span class="n">fn_src</span><span class="p">),</span><span class="n">fn_dst</span><span class="p">))</span>

        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">fn_src</span><span class="p">,</span><span class="n">fn_dst</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20101113193341.5458: *4* get_wink_screenshots</span></div>
<div class="viewcode-block" id="ScreenShotController.get_wink_screenshots"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.get_wink_screenshots">[docs]</a>    <span class="k">def</span> <span class="nf">get_wink_screenshots</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the properly sorted list of wink screenshots.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">aList</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">wink_path</span> <span class="o">+</span> <span class="s">&#39;/*.png&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">key</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="n">path</span><span class="p">,</span><span class="n">ext</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_splitext</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">junk</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_split</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="c"># 2010/11/23: allow file names of the form xnnn.png.</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">n</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">while</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">n</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                    <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;wink screenshot file names must end with a number: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">KeyError</span>

        <span class="n">aList</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span> <span class="c"># Essential.</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">aList</span>
    <span class="c">#@+node:ekr.20101113193341.5445: *4* has_at_no_screenshot_node</span></div>
<div class="viewcode-block" id="ScreenShotController.has_at_no_screenshot_node"><a class="viewcode-back" href="../../../leo.plugins.html#leo.plugins.screenshots.ScreenShotController.has_at_no_screenshot_node">[docs]</a>    <span class="k">def</span> <span class="nf">has_at_no_screenshot_node</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s">&#39;@no-screenshot&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="c">#@-others</span>

<span class="c">#@-others</span>
<span class="c">#@-leo</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Leo API 4.11dev documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Ed K. Ream.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
  </body>
</html>