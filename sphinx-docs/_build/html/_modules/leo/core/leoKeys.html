<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>leo.core.leoKeys &mdash; Leo API 4.11dev documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '4.11dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Leo API 4.11dev documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Leo API 4.11dev documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for leo.core.leoKeys</h1><div class="highlight"><pre>
<span class="c">#@+leo-ver=5-thin</span>
<span class="c">#@+node:ekr.20061031131434: * @file leoKeys.py</span>
<span class="sd">&quot;&quot;&quot;Gui-independent keystroke handling for Leo.&quot;&quot;&quot;</span> 

<span class="c">#@@language python</span>
<span class="c">#@@tabwidth -4</span>
<span class="c">#@@pagewidth 70</span>

<span class="c">#@+&lt;&lt; imports &gt;&gt;</span>
<span class="c">#@+node:ekr.20061031131434.1: ** &lt;&lt; imports &gt;&gt; (leoKeys)</span>
<span class="kn">import</span> <span class="nn">leo.core.leoGlobals</span> <span class="kn">as</span> <span class="nn">g</span>

<span class="kn">import</span> <span class="nn">leo.external.codewise</span> <span class="kn">as</span> <span class="nn">codewise</span>

<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="c">#@-&lt;&lt; imports &gt;&gt;</span>
<span class="c">#@+&lt;&lt; about &#39;internal&#39; bindings &gt;&gt;</span>
<span class="c">#@+node:ekr.20061031131434.2: ** &lt;&lt; about &#39;internal&#39; bindings &gt;&gt;</span>
<span class="c">#@@nocolor</span>
<span class="c">#@+at</span>
<span class="c"># </span>
<span class="c"># Here are the rules for translating key bindings (in leoSettings.leo)</span>
<span class="c"># into keys for k.bindingsDict:</span>
<span class="c"># </span>
<span class="c"># 1. The case of plain letters is significant: a is not A.</span>
<span class="c"># </span>
<span class="c"># 2. The Shift- prefix can be applied *only* to letters. Leo will ignore</span>
<span class="c">#    (with a warning) the shift prefix applied to any other binding,</span>
<span class="c">#    e.g., Ctrl-Shift-(</span>
<span class="c"># </span>
<span class="c"># 3. The case of letters prefixed by Ctrl-, Alt-, Key- or Shift- is</span>
<span class="c">#    *not* significant. Thus, the Shift- prefix is required if you want</span>
<span class="c">#    an upper-case letter (with the exception of &#39;bare&#39; uppercase</span>
<span class="c">#    letters.)</span>
<span class="c"># </span>
<span class="c"># The following table illustrates these rules. In each row, the first</span>
<span class="c"># entry is the key (for k.bindingsDict) and the other entries are</span>
<span class="c"># equivalents that the user may specify in leoSettings.leo:</span>
<span class="c"># </span>
<span class="c"># a, Key-a, Key-A</span>
<span class="c"># A, Shift-A</span>
<span class="c"># Alt-a, Alt-A</span>
<span class="c"># Alt-A, Alt-Shift-a, Alt-Shift-A</span>
<span class="c"># Ctrl-a, Ctrl-A</span>
<span class="c"># Ctrl-A, Ctrl-Shift-a, Ctrl-Shift-A</span>
<span class="c"># !, Key-!,Key-exclam,exclam</span>
<span class="c"># </span>
<span class="c"># This table is consistent with how Leo already works (because it is</span>
<span class="c"># consistent with Tk&#39;s key-event specifiers). It is also, I think, the</span>
<span class="c"># least confusing set of rules.</span>
<span class="c">#@-&lt;&lt; about &#39;internal&#39; bindings &gt;&gt;</span>
<span class="c">#@+&lt;&lt; about key dicts &gt;&gt;</span>
<span class="c">#@+node:ekr.20061031131434.3: ** &lt;&lt; about key dicts &gt;&gt;</span>
<span class="c">#@@nocolor</span>
<span class="c">#@+at</span>
<span class="c"># </span>
<span class="c"># ivar                    Keys                Values</span>
<span class="c"># ----                    ----                ------</span>
<span class="c"># c.commandsDict          command names (1)   functions</span>
<span class="c"># k.inverseCommandsDict   func.__name__       command names</span>
<span class="c"># k.bindingsDict          shortcuts           lists of ShortcutInfo objects</span>
<span class="c"># k.masterBindingsDict    scope names (2)     Interior masterBindingDicts (3)</span>
<span class="c"># k.masterGuiBindingsDict strokes             list of widgets in which stoke is bound</span>
<span class="c"># k.settingsNameDict (4)  settings.lower()    &quot;Real&quot; Tk specifiers</span>
<span class="c"># inverseBindingDict (5)  command names       lists of tuples (pane,key)</span>
<span class="c"># modeCommandsDict (6)    command name (7)    inner modeCommandsDicts (8)</span>
<span class="c"># </span>
<span class="c"># Notes:</span>
<span class="c"># </span>
<span class="c"># (1) Command names are minibuffer names (strings)</span>
<span class="c"># (2) Scope names are &#39;all&#39;,&#39;text&#39;,etc.</span>
<span class="c"># (3) Interior masterBindingDicts: Keys are strokes; values are ShortcutInfo objects.</span>
<span class="c"># (4) k.settingsNameDict has no inverse.</span>
<span class="c"># (5) inverseBindingDict is **not** an ivar: it is computed by k.computeInverseBindingDict.</span>
<span class="c"># (6) A global dict: g.app.gui.modeCommandsDict</span>
<span class="c"># (7) enter-x-command</span>
<span class="c"># (8) Keys are command names, values are lists of ShortcutInfo objects.</span>
<span class="c">#@-&lt;&lt; about key dicts &gt;&gt;</span>

<span class="c">#@+others</span>
<span class="c">#@+node:ekr.20061031131434.4: ** class AutoCompleterClass</span>
<div class="viewcode-block" id="AutoCompleterClass"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass">[docs]</a><span class="k">class</span> <span class="nc">AutoCompleterClass</span><span class="p">:</span>

    <span class="sd">&#39;&#39;&#39;A class that inserts autocompleted and calltip text in text widgets.</span>
<span class="sd">    This class shows alternatives in the tabbed log pane.</span>

<span class="sd">    The keyHandler class contains hooks to support these characters:</span>
<span class="sd">    invoke-autocompleter-character (default binding is &#39;.&#39;)</span>
<span class="sd">    invoke-calltips-character (default binding is &#39;(&#39;)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20061031131434.5: *3*  ctor (autocompleter)</span>
    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">k</span><span class="p">):</span>

        <span class="c"># Ivars...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">language</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qw</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># The object that supports qcompletion methods.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tabName</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># The name of the main completion tab.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># True: print all members, regardless of how many there are.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># The widget that gets focus after autocomplete is done.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># Keys are language names.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">klass</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># Codewise pre-computes...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">codewiseSelfList</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c"># The (global) completions for &quot;self.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">completionsDict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c"># Keys are prefixes, values are completion lists.</span>

        <span class="c"># Options...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_tab</span>       <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getBool</span><span class="p">(</span><span class="s">&#39;auto_tab_complete&#39;</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forbid_invalid</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getBool</span><span class="p">(</span><span class="s">&#39;forbid_invalid_completions&#39;</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_qcompleter</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getBool</span><span class="p">(</span><span class="s">&#39;use_qcompleter&#39;</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
            <span class="c"># True: show results in autocompleter tab.</span>
            <span class="c"># False: show results in a QCompleter widget.</span>
    <span class="c">#@+node:ekr.20061031131434.8: *3* Top level (autocompleter)</span>
    <span class="c">#@+node:ekr.20061031131434.9: *4* autoComplete</span>
<div class="viewcode-block" id="AutoCompleterClass.autoComplete"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.autoComplete">[docs]</a>    <span class="k">def</span> <span class="nf">autoComplete</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">force</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;An event handler called from k.masterKeyHanderlerHelper.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span><span class="p">,</span><span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">unboundKeyAction</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">event</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">w</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">get_focus</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="n">force</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">klass</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;insert&#39;</span><span class="p">,</span><span class="s">&#39;overwrite&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;not in insert/overwrite mode&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c"># First, handle the invocation character as usual.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
            <span class="c"># Ctrl-period does *not* insert a period.</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;not force&#39;</span><span class="p">)</span>
            <span class="n">k</span><span class="o">.</span><span class="n">masterCommand</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">)</span>

        <span class="c"># Allow autocompletion only in the body pane.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">widget_name</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;body&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;not body&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">language</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">scanForAtLanguage</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">w</span> <span class="ow">and</span> <span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">enable_autocompleter</span> <span class="ow">or</span> <span class="n">force</span><span class="p">):</span> <span class="c"># self.language == &#39;python&#39;:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;starting&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">w</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;autocompletion not enabled&#39;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20061031131434.10: *4* autoCompleteForce</span></div>
<div class="viewcode-block" id="AutoCompleterClass.autoCompleteForce"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.autoCompleteForce">[docs]</a>    <span class="k">def</span> <span class="nf">autoCompleteForce</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Show autocompletion, even if autocompletion is not presently enabled.&#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoComplete</span><span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20061031131434.12: *4* enable/disable/toggleAutocompleter/Calltips</span></div>
<div class="viewcode-block" id="AutoCompleterClass.disableAutocompleter"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.disableAutocompleter">[docs]</a>    <span class="k">def</span> <span class="nf">disableAutocompleter</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Disable the autocompleter.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">enable_autocompleter</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">showAutocompleterStatus</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="AutoCompleterClass.disableCalltips"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.disableCalltips">[docs]</a>    <span class="k">def</span> <span class="nf">disableCalltips</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Disable calltips.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">enable_calltips</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">showCalltipsStatus</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="AutoCompleterClass.enableAutocompleter"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.enableAutocompleter">[docs]</a>    <span class="k">def</span> <span class="nf">enableAutocompleter</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Enable the autocompleter.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">enable_autocompleter</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">showAutocompleterStatus</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="AutoCompleterClass.enableCalltips"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.enableCalltips">[docs]</a>    <span class="k">def</span> <span class="nf">enableCalltips</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Enable calltips.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">enable_calltips</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">showCalltipsStatus</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="AutoCompleterClass.toggleAutocompleter"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.toggleAutocompleter">[docs]</a>    <span class="k">def</span> <span class="nf">toggleAutocompleter</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Toggle whether the autocompleter is enabled.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">enable_autocompleter</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">enable_autocompleter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">showAutocompleterStatus</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="AutoCompleterClass.toggleCalltips"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.toggleCalltips">[docs]</a>    <span class="k">def</span> <span class="nf">toggleCalltips</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Toggle whether calltips are enabled.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">enable_calltips</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">enable_calltips</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">showCalltipsStatus</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20061031131434.13: *4* showCalltips</span></div>
<div class="viewcode-block" id="AutoCompleterClass.showCalltips"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.showCalltips">[docs]</a>    <span class="k">def</span> <span class="nf">showCalltips</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">force</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Show the calltips at the cursor.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">k</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">k</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">event</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">w</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">w</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">is_headline</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">widget_name</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;head&#39;</span><span class="p">)</span>

        <span class="c"># Insert the calltip if possible, but not in headlines.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">enable_calltips</span> <span class="ow">or</span> <span class="n">force</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_headline</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">w</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calltip</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Just insert the invocation character as usual.</span>
            <span class="n">k</span><span class="o">.</span><span class="n">masterCommand</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20061031131434.14: *4* showCalltipsForce</span></div>
<div class="viewcode-block" id="AutoCompleterClass.showCalltipsForce"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.showCalltipsForce">[docs]</a>    <span class="k">def</span> <span class="nf">showCalltipsForce</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Show the calltips at the cursor, even if calltips are not presently enabled.&#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">showCalltips</span><span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20061031131434.15: *4* showAutocompleter/CalltipsStatus</span></div>
<div class="viewcode-block" id="AutoCompleterClass.showAutocompleterStatus"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.showAutocompleterStatus">[docs]</a>    <span class="k">def</span> <span class="nf">showAutocompleterStatus</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Show the autocompleter status.&#39;&#39;&#39;</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;autocompleter </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">enable_autocompleter</span><span class="p">,</span><span class="s">&#39;On&#39;</span><span class="p">,</span><span class="s">&#39;Off&#39;</span><span class="p">))</span>
            <span class="n">g</span><span class="o">.</span><span class="n">red</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AutoCompleterClass.showCalltipsStatus"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.showCalltipsStatus">[docs]</a>    <span class="k">def</span> <span class="nf">showCalltipsStatus</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Show the autocompleter status.&#39;&#39;&#39;</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;calltips </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">enable_calltips</span><span class="p">,</span><span class="s">&#39;On&#39;</span><span class="p">,</span><span class="s">&#39;Off&#39;</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">red</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20061031131434.16: *3* Helpers</span>
    <span class="c">#@+node:ekr.20110512212836.14469: *4* exit</span></div>
<div class="viewcode-block" id="AutoCompleterClass.exit"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.exit">[docs]</a>    <span class="k">def</span> <span class="nf">exit</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">bodyCtrl</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>

        <span class="n">c</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">keyboardQuit</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_qcompleter</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qw</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">qw</span><span class="o">.</span><span class="n">end_completer</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tabName</span><span class="p">,</span><span class="s">&#39;Modules&#39;</span><span class="p">,</span><span class="s">&#39;Info&#39;</span><span class="p">):</span>
                <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">deleteTab</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="c"># Restore the selection range that may have been destroyed by changing tabs.</span>
        <span class="n">c</span><span class="o">.</span><span class="n">widgetWantsFocusNow</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getSelectionRange</span><span class="p">()</span>
        <span class="n">w</span><span class="o">.</span><span class="n">setSelectionRange</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">insert</span><span class="o">=</span><span class="n">j</span><span class="p">)</span>

        <span class="c"># Was in finish.</span>
        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">onBodyChanged</span><span class="p">(</span><span class="s">&#39;Typing&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">recolor</span><span class="p">()</span>
</div>
    <span class="n">finish</span> <span class="o">=</span> <span class="nb">exit</span>
    <span class="n">abort</span> <span class="o">=</span> <span class="nb">exit</span>
    <span class="c">#@+node:ekr.20061031131434.18: *4* append/begin/popTabName</span>
<div class="viewcode-block" id="AutoCompleterClass.appendTabName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.appendTabName">[docs]</a>    <span class="k">def</span> <span class="nf">appendTabName</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">word</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setTabName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tabName</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">word</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AutoCompleterClass.beginTabName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.beginTabName">[docs]</a>    <span class="k">def</span> <span class="nf">beginTabName</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">word</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setTabName</span><span class="p">(</span><span class="s">&#39;AutoComplete &#39;</span> <span class="o">+</span> <span class="n">word</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AutoCompleterClass.clearTabName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.clearTabName">[docs]</a>    <span class="k">def</span> <span class="nf">clearTabName</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setTabName</span><span class="p">(</span><span class="s">&#39;AutoComplete &#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AutoCompleterClass.popTabName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.popTabName">[docs]</a>    <span class="k">def</span> <span class="nf">popTabName</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tabName</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setTabName</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">])</span>

    <span class="c"># Underscores are not valid in Pmw tab names!</span></div>
<div class="viewcode-block" id="AutoCompleterClass.setTabName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.setTabName">[docs]</a>    <span class="k">def</span> <span class="nf">setTabName</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tabName</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">deleteTab</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tabName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tabName</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">clearTab</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tabName</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20110509064011.14556: *4* attr_matches</span></div>
<div class="viewcode-block" id="AutoCompleterClass.attr_matches"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.attr_matches">[docs]</a>    <span class="k">def</span> <span class="nf">attr_matches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">namespace</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Compute matches when string s is of the form name.name....name.</span>

<span class="sd">        Evaluates s using eval(s,namespace) </span>

<span class="sd">        Assuming the text is of the form NAME.NAME....[NAME], and is evaluatable in</span>
<span class="sd">        the namespace, it will be evaluated and its attributes (as revealed by</span>
<span class="sd">        dir()) are used as possible completions.</span>

<span class="sd">        For class instances, class members are are also considered.)</span>

<span class="sd">        **Warning**: this can still invoke arbitrary C code, if an object</span>
<span class="sd">        with a __getattr__ hook is evaluated.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># Seems to work great. Catches things like &#39;&#39;.&lt;tab&gt;</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">r&quot;(\S+(\.\w+)*)\.(\w*)$&quot;</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">expr</span><span class="p">,</span><span class="n">attr</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">safe_expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strip_brackets</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">safe_expr</span><span class="p">,</span><span class="n">namespace</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c"># Build the result.</span>
        <span class="n">words</span> <span class="o">=</span> <span class="nb">dir</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">attr</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">expr</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">words</span> <span class="k">if</span> <span class="n">w</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="n">attr</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">result</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="c">#@+node:ekr.20061031131434.11: *4* auto_completer_state_handler</span></div>
<div class="viewcode-block" id="AutoCompleterClass.auto_completer_state_handler"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.auto_completer_state_handler">[docs]</a>    <span class="k">def</span> <span class="nf">auto_completer_state_handler</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="s">&#39;auto-complete&#39;</span> <span class="p">;</span> <span class="n">state</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="n">event</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">char</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
        <span class="n">stroke</span> <span class="o">=</span> <span class="n">event</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">stroke</span> <span class="ow">or</span> <span class="bp">None</span>
        <span class="n">is_plain</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">isPlainKey</span><span class="p">(</span><span class="n">stroke</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;state: </span><span class="si">%s</span><span class="s">, ch: </span><span class="si">%s</span><span class="s">, stroke: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">state</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">ch</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">stroke</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">clearTab</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tabName</span><span class="p">)</span>
            <span class="n">common_prefix</span><span class="p">,</span><span class="n">prefix</span><span class="p">,</span><span class="n">tabList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_completion_list</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">tabList</span><span class="p">:</span>
                <span class="n">k</span><span class="o">.</span><span class="n">setState</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">handler</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">auto_completer_state_handler</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;abort: not tabList&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;Return&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;Escape&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;Tab&#39;</span><span class="p">):</span>
            <span class="n">k</span><span class="o">.</span><span class="n">doTabCompletion</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;</span><span class="se">\b</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;BackSpace&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_backspace</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;.&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_completion_list</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;?&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;!&#39;</span><span class="p">:</span>
            <span class="c"># Toggle between verbose and brief listing.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>
            <span class="n">kind</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span><span class="s">&#39;ON&#39;</span><span class="p">,</span><span class="s">&#39;OFF&#39;</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">putStatusLine</span><span class="p">(</span><span class="s">&#39;verbose completions </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">kind</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;red&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_completion_list</span><span class="p">()</span>
        <span class="c"># elif ch == &#39;Down&#39; and hasattr(self,&#39;onDown&#39;):</span>
            <span class="c"># self.onDown()</span>
        <span class="c"># elif ch == &#39;Up&#39; and hasattr(self,&#39;onUp&#39;):</span>
            <span class="c"># self.onUp()</span>
        <span class="k">elif</span> <span class="n">is_plain</span> <span class="ow">and</span> <span class="n">ch</span> <span class="ow">and</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">printable</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">insert_general_char</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">stroke</span> <span class="o">==</span> <span class="n">k</span><span class="o">.</span><span class="n">autoCompleteForceKey</span><span class="p">:</span>
                <span class="c"># This is probably redundant because completions will exist.</span>
                <span class="c"># However, it doesn&#39;t hurt, and it may be useful rarely.</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;auto-complete-force&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">stroke</span><span class="p">))</span>
                <span class="n">common_prefix</span><span class="p">,</span><span class="n">prefix</span><span class="p">,</span><span class="n">tabList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_completion_list</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">tabList</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">show_completion_list</span><span class="p">(</span><span class="n">common_prefix</span><span class="p">,</span><span class="n">prefix</span><span class="p">,</span><span class="n">tabList</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;No completions&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;ignore non plain key&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">stroke</span><span class="p">),</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">abort</span><span class="p">()</span> <span class="c"># 2011/06/17.</span>
                <span class="k">return</span> <span class="s">&#39;do-standard-keys&#39;</span>
    <span class="c">#@+node:ekr.20061031131434.20: *4* calltip &amp; helpers</span></div>
<div class="viewcode-block" id="AutoCompleterClass.calltip"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.calltip">[docs]</a>    <span class="k">def</span> <span class="nf">calltip</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Show the calltips for the present prefix.</span>
<span class="sd">        ch is &#39;(&#39; if the user has just typed it.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">obj</span><span class="p">,</span><span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">obj</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calltip_success</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calltip_fail</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20110512090917.14468: *5* calltip_fail</span></div>
<div class="viewcode-block" id="AutoCompleterClass.calltip_fail"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.calltip_fail">[docs]</a>    <span class="k">def</span> <span class="nf">calltip_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">prefix</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Evaluation of prefix failed.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;eval failed for &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">prefix</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="s">&#39;(&#39;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20110512090917.14469: *5* calltip_success</span></div>
<div class="viewcode-block" id="AutoCompleterClass.calltip_success"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.calltip_success">[docs]</a>    <span class="k">def</span> <span class="nf">calltip_success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">prefix</span><span class="p">,</span><span class="n">obj</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c"># Get the parenthesized argument list.</span>
            <span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">,</span><span class="n">s3</span><span class="p">,</span><span class="n">s4</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">formatargspec</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">,</span><span class="n">s3</span><span class="p">,</span><span class="n">s4</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;inspect failed. obj: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="s">&#39;(&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c"># Clean s and insert it: don&#39;t include the opening &quot;(&quot;.</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;self,&#39;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;self&#39;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="s">&quot;(&quot;</span><span class="p">,</span><span class="n">select</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">select</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20061031131434.28: *4* compute_completion_list &amp; helper</span></div>
<div class="viewcode-block" id="AutoCompleterClass.compute_completion_list"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.compute_completion_list">[docs]</a>    <span class="k">def</span> <span class="nf">compute_completion_list</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="c"># True: report hits and misses.</span>
            <span class="c"># False: report misses.</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">klass</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="c"># something later on eats the first char, not sure what</span>
            <span class="n">options</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;^&#39;</span><span class="o">+</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_methods</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klass</span><span class="p">)],</span><span class="bp">None</span><span class="p">)]</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">: </span><span class="si">%d</span><span class="s"> options&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klass</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">options</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">klass</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_autocompleter_prefix</span><span class="p">()</span>
            <span class="n">key</span><span class="p">,</span><span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cached_options</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">options</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;**prefix hit: </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">key</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;**prefix miss: </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">key</span><span class="p">))</span>
                <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_completions</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>

        <span class="n">tabList</span><span class="p">,</span><span class="n">common_prefix</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">itemsMatchingPrefixInList</span><span class="p">(</span>
            <span class="n">prefix</span><span class="p">,</span><span class="n">options</span><span class="p">,</span><span class="n">matchEmptyPrefix</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">common_prefix</span><span class="p">:</span>
            <span class="n">tabList</span><span class="p">,</span><span class="n">common_prefix</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">itemsMatchingPrefixInList</span><span class="p">(</span>
                <span class="n">prefix</span><span class="p">,</span><span class="n">options</span><span class="p">,</span><span class="n">matchEmptyPrefix</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;prefix: </span><span class="si">%s</span><span class="s">, common: </span><span class="si">%s</span><span class="s">, len(tabList): </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">prefix</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">common_prefix</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">tabList</span><span class="p">)))</span>
            <span class="c"># if verbose: g.trace(&#39;options[:10]...\n&#39;,</span>
                <span class="c"># g.listToString(options[:10],sort=True))</span>

        <span class="k">if</span> <span class="n">tabList</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">show_completion_list</span><span class="p">(</span><span class="n">common_prefix</span><span class="p">,</span><span class="n">prefix</span><span class="p">,</span><span class="n">tabList</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">common_prefix</span><span class="p">,</span><span class="n">prefix</span><span class="p">,</span><span class="n">tabList</span>
    <span class="c">#@+node:ekr.20110514051607.14524: *5* get_cached_options</span></div>
<div class="viewcode-block" id="AutoCompleterClass.get_cached_options"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.get_cached_options">[docs]</a>    <span class="k">def</span> <span class="nf">get_cached_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">prefix</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">completionsDict</span>

        <span class="c"># Search the completions Dict for shorter and shorter prefixes.</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">prefix</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
            <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="c"># Make sure we report hits only of real objects.</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;== period: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">key</span><span class="p">,[]</span>
            <span class="n">options</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">options</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;== hit: </span><span class="si">%s</span><span class="s"> len: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">key</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">options</span><span class="p">)))</span>
                <span class="k">return</span> <span class="n">key</span><span class="p">,</span><span class="n">options</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;== miss: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">None</span><span class="p">,[]</span>
    <span class="c">#@+node:ekr.20061031131434.29: *4* do_backspace</span></div>
<div class="viewcode-block" id="AutoCompleterClass.do_backspace"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.do_backspace">[docs]</a>    <span class="k">def</span> <span class="nf">do_backspace</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Delete the character and recompute the completion list.&#39;&#39;&#39;</span>

        <span class="n">c</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span>
        <span class="n">c</span><span class="o">.</span><span class="n">bodyWantsFocusNow</span><span class="p">()</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getInsertPoint</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="n">w</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="n">w</span><span class="o">.</span><span class="n">setInsertPoint</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Update the list. Abort if there is no prefix.</span>
            <span class="n">common_prefix</span><span class="p">,</span><span class="n">prefix</span><span class="p">,</span><span class="n">tabList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_completion_list</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">prefix</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20110510133719.14548: *4* do_qcompleter_tab</span></div>
<div class="viewcode-block" id="AutoCompleterClass.do_qcompleter_tab"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.do_qcompleter_tab">[docs]</a>    <span class="k">def</span> <span class="nf">do_qcompleter_tab</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">prefix</span><span class="p">,</span><span class="n">options</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the longest common prefix of all the options.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

        <span class="n">matches</span><span class="p">,</span><span class="n">common_prefix</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">itemsMatchingPrefixInList</span><span class="p">(</span>
            <span class="n">prefix</span><span class="p">,</span><span class="n">options</span><span class="p">,</span><span class="n">matchEmptyPrefix</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">common_prefix</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">common_prefix</span>
    <span class="c">#@+node:ekr.20110509064011.14561: *4* get_autocompleter_prefix</span></div>
<div class="viewcode-block" id="AutoCompleterClass.get_autocompleter_prefix"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.get_autocompleter_prefix">[docs]</a>    <span class="k">def</span> <span class="nf">get_autocompleter_prefix</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

        <span class="c"># Only the body pane supports auto-completion.</span>
        <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getAllText</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#39;&#39;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getInsertPoint</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">i1</span> <span class="o">=</span> <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">isalnum</span><span class="p">()</span> <span class="ow">or</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="s">&#39;._&#39;</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">prefix</span><span class="p">),</span><span class="s">&#39;ins&#39;</span><span class="p">,</span><span class="n">s</span><span class="p">[</span><span class="n">i1</span><span class="p">:])</span>
        <span class="k">return</span> <span class="n">prefix</span>
    <span class="c">#@+node:ekr.20110512212836.14471: *4* get_completions &amp; helpers</span></div>
<div class="viewcode-block" id="AutoCompleterClass.get_completions"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.get_completions">[docs]</a>    <span class="k">def</span> <span class="nf">get_completions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">prefix</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># True: report hits and misses.  False: report misses.</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">completionsDict</span>

        <span class="c"># Precompute the codewise completions for &#39;.self&#39;.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">codewiseSelfList</span><span class="p">:</span>
            <span class="n">aList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_codewise_completions</span><span class="p">(</span><span class="s">&#39;self.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">codewiseSelfList</span> <span class="o">=</span> <span class="p">[</span><span class="n">z</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">]</span>
            <span class="n">d</span> <span class="p">[</span><span class="s">&#39;self.&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">codewiseSelfList</span>

        <span class="c"># Use the cached list if it exists.</span>
        <span class="n">aList</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">aList</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;**cache hit: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">aList</span>

        <span class="c"># elif self.use_codewise:</span>
            <span class="c"># aList = self.get_codewise_completions(prefix)</span>
        <span class="c"># else:</span>
            <span class="c"># aList = self.get_leo_completions(prefix)</span>

        <span class="c"># Always try the Leo completions first.</span>
        <span class="c"># Fall back to the codewise completions.</span>
        <span class="n">aList</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_leo_completions</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="ow">or</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_codewise_completions</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;**cash miss: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">))</span>
        <span class="n">d</span> <span class="p">[</span><span class="n">prefix</span><span class="p">]</span> <span class="o">=</span> <span class="n">aList</span>
        <span class="k">return</span> <span class="n">aList</span>
    <span class="c">#@+node:ekr.20110510120621.14539: *5* get_codewise_completions &amp; helpers</span></div>
<div class="viewcode-block" id="AutoCompleterClass.get_codewise_completions"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.get_codewise_completions">[docs]</a>    <span class="k">def</span> <span class="nf">get_codewise_completions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">prefix</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Use codewise to generate a list of hits.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>

        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">r&quot;(\S+(\.\w+)*)\.(\w*)$&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">varname</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ivar</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">kind</span><span class="p">,</span><span class="n">aList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">guess_class</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">varname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kind</span><span class="p">,</span><span class="n">aList</span> <span class="o">=</span> <span class="s">&#39;none&#39;</span><span class="p">,[]</span>
            <span class="n">varname</span><span class="p">,</span><span class="n">ivar</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span><span class="bp">None</span>

        <span class="k">if</span> <span class="n">aList</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;class&#39;</span><span class="p">:</span>
                <span class="n">hits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_methods</span><span class="p">(</span><span class="n">aList</span><span class="p">,</span><span class="n">ivar</span><span class="p">)</span>
                <span class="n">hits</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">codewiseSelfList</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;module&#39;</span><span class="p">:</span>
                <span class="n">hits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_modules</span><span class="p">(</span><span class="n">aList</span><span class="p">,</span><span class="n">ivar</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">aList2</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">aList2</span><span class="p">:</span>
                <span class="n">func</span> <span class="o">=</span> <span class="n">aList2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">hits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_functions</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hits</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="mi">1</span><span class="p">:</span> <span class="c"># A kludge: add the prefix to each hit.</span>
            <span class="n">hits</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">varname</span><span class="p">,</span><span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">hits</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;kind&#39;</span><span class="p">,</span><span class="n">kind</span><span class="p">,</span><span class="s">&#39;varname&#39;</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="s">&#39;ivar&#39;</span><span class="p">,</span><span class="n">ivar</span><span class="p">,</span><span class="s">&#39;prefix&#39;</span><span class="p">,</span><span class="n">prefix</span><span class="p">)</span>
            <span class="c"># g.trace(&#39;prefix&#39;,prefix,&#39;kind&#39;,kind,&#39;varname&#39;,varname,&#39;ivar&#39;,ivar,&#39;len(hits)&#39;,len(hits))</span>
            <span class="c"># g.trace(&#39;hits[:10]&#39;,g.listToString(hits[:10],sort=False))</span>

        <span class="k">return</span> <span class="n">hits</span>
    <span class="c">#@+node:ekr.20110510120621.14540: *6* clean</span></div>
<div class="viewcode-block" id="AutoCompleterClass.clean"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.clean">[docs]</a>    <span class="k">def</span> <span class="nf">clean</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">hits</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Clean up hits, a list of ctags patterns, for use in completion lists.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

        <span class="c"># Just take the function name: ignore the signature &amp; file.</span>
        <span class="n">aList</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">hits</span><span class="p">]))</span>
        <span class="n">aList</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
            <span class="c"># g.trace(&#39;hits[:50]&#39;,g.listToString(hits[:50],sort=False))</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;aList[:50]&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">listToString</span><span class="p">(</span><span class="n">aList</span><span class="p">[:</span><span class="mi">50</span><span class="p">],</span><span class="n">sort</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">aList</span>
    <span class="c">#@+node:ekr.20110512232915.14481: *6* clean_for_display (not used)</span></div>
<div class="viewcode-block" id="AutoCompleterClass.clean_for_display"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.clean_for_display">[docs]</a>    <span class="k">def</span> <span class="nf">clean_for_display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">hits</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Clean up hits, a list of ctags patterns, for display purposes.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">aList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hits</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c"># Display oriented: no good for completion list.</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">fn</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">):</span>
                <span class="n">sig</span> <span class="o">=</span> <span class="n">fn</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sig</span> <span class="o">=</span> <span class="n">fn</span>
            <span class="n">aList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">sig</span><span class="p">))</span>

        <span class="n">aList</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">aList</span><span class="p">))</span>
        <span class="n">aList</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
            <span class="c"># g.trace(&#39;hits[:50]&#39;,g.listToString(hits[:50],sort=False))</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;aList[:50]&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">listToString</span><span class="p">(</span><span class="n">aList</span><span class="p">[:</span><span class="mi">50</span><span class="p">],</span><span class="n">sort</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">aList</span>
    <span class="c">#@+node:ekr.20110510120621.14542: *6* guess_class</span></div>
<div class="viewcode-block" id="AutoCompleterClass.guess_class"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.guess_class">[docs]</a>    <span class="k">def</span> <span class="nf">guess_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">varname</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return kind, class_list&#39;&#39;&#39;</span>

        <span class="c"># if varname == &#39;g&#39;:</span>
            <span class="c"># return &#39;module&#39;,[&#39;leoGlobals&#39;]</span>
        <span class="k">if</span> <span class="n">varname</span> <span class="o">==</span> <span class="s">&#39;p&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;class&#39;</span><span class="p">,[</span><span class="s">&#39;position&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">varname</span> <span class="o">==</span> <span class="s">&#39;c&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;class&#39;</span><span class="p">,[</span><span class="s">&#39;Commands&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">varname</span> <span class="o">==</span> <span class="s">&#39;self&#39;</span><span class="p">:</span>
            <span class="c"># Return the nearest enclosing class.</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">parents</span><span class="p">():</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;class\s+(\w+)&#39;</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s">&#39;class&#39;</span><span class="p">,[</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span>

        <span class="k">if</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">aList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># This is not needed now that we add the completions for &#39;self&#39;.</span>
            <span class="n">aList</span> <span class="o">=</span> <span class="n">ContextSniffer</span><span class="p">()</span><span class="o">.</span><span class="n">get_classes</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="p">,</span><span class="n">varname</span><span class="p">)</span>

        <span class="k">return</span> <span class="s">&#39;class&#39;</span><span class="p">,</span><span class="n">aList</span>
    <span class="c">#@+node:ekr.20110510120621.14543: *6* lookup_functions/methods/modules</span></div>
<div class="viewcode-block" id="AutoCompleterClass.lookup_functions"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.lookup_functions">[docs]</a>    <span class="k">def</span> <span class="nf">lookup_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">prefix</span><span class="p">):</span>

        <span class="n">aList</span> <span class="o">=</span> <span class="n">codewise</span><span class="o">.</span><span class="n">cmd_functions</span><span class="p">([</span><span class="n">prefix</span><span class="p">])</span>
        <span class="n">hits</span> <span class="o">=</span> <span class="p">[</span><span class="n">z</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">aList</span> <span class="k">if</span> <span class="n">z</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="n">hits</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AutoCompleterClass.lookup_methods"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.lookup_methods">[docs]</a>    <span class="k">def</span> <span class="nf">lookup_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aList</span><span class="p">,</span><span class="n">prefix</span><span class="p">):</span> <span class="c"># prefix not used, only aList[0] used.</span>

        <span class="n">aList</span> <span class="o">=</span> <span class="n">codewise</span><span class="o">.</span><span class="n">cmd_members</span><span class="p">([</span><span class="n">aList</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">hits</span> <span class="o">=</span> <span class="p">[</span><span class="n">z</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">aList</span> <span class="k">if</span> <span class="n">z</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="n">hits</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="AutoCompleterClass.lookup_modules"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.lookup_modules">[docs]</a>    <span class="k">def</span> <span class="nf">lookup_modules</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aList</span><span class="p">,</span><span class="n">prefix</span><span class="p">):</span> <span class="c"># prefix not used, only aList[0] used.</span>

        <span class="n">aList</span> <span class="o">=</span> <span class="n">codewise</span><span class="o">.</span><span class="n">cmd_functions</span><span class="p">([</span><span class="n">aList</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">hits</span> <span class="o">=</span> <span class="p">[</span><span class="n">z</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">aList</span> <span class="k">if</span> <span class="n">z</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="n">hits</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20110509064011.14557: *5* get_leo_completions</span></div>
<div class="viewcode-block" id="AutoCompleterClass.get_leo_completions"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.get_leo_completions">[docs]</a>    <span class="k">def</span> <span class="nf">get_leo_completions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">prefix</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return completions in an environment defining c, g and p.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_leo_namespace</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

        <span class="n">aList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attr_matches</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">d</span><span class="p">)</span>
        <span class="n">aList</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;prefix&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">prefix</span><span class="p">),</span><span class="s">&#39;aList...</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">listToString</span><span class="p">(</span><span class="n">aList</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;len(aList): </span><span class="si">%3s</span><span class="s">, prefix: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aList</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">prefix</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">aList</span>
    <span class="c">#@+node:ekr.20110512090917.14466: *4* get_leo_namespace</span></div>
<div class="viewcode-block" id="AutoCompleterClass.get_leo_namespace"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.get_leo_namespace">[docs]</a>    <span class="k">def</span> <span class="nf">get_leo_namespace</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">prefix</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return an environment in which to evaluate prefix.</span>

<span class="sd">        Add some common standard library modules as needed.&#39;&#39;&#39;</span>


        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;c&#39;</span><span class="p">:</span><span class="n">k</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="s">&#39;p&#39;</span><span class="p">:</span><span class="n">k</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="s">&#39;g&#39;</span><span class="p">:</span><span class="n">g</span><span class="p">}</span>

        <span class="n">aList</span> <span class="o">=</span> <span class="n">prefix</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aList</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">aList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">=</span> <span class="n">m</span>

        <span class="c"># g.trace(list(d.keys()))</span>
        <span class="k">return</span> <span class="n">d</span>
    <span class="c">#@+node:ekr.20110512170111.14472: *4* get_object</span></div>
<div class="viewcode-block" id="AutoCompleterClass.get_object"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.get_object">[docs]</a>    <span class="k">def</span> <span class="nf">get_object</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the object corresponding to the current prefix.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

        <span class="n">common_prefix</span><span class="p">,</span><span class="n">prefix1</span><span class="p">,</span><span class="n">aList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_completion_list</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aList</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;no completion list for: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix1</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span><span class="n">prefix1</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">aList</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">aList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">common_prefix</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">prefix</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_leo_namespace</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
            <span class="n">safe_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strip_brackets</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">safe_prefix</span><span class="p">,</span><span class="n">d</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">except</span> <span class="ne">SyntaxError</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">return</span> <span class="n">obj</span><span class="p">,</span><span class="n">prefix</span>
    <span class="c">#@+node:ekr.20061031131434.38: *4* info</span></div>
<div class="viewcode-block" id="AutoCompleterClass.info"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.info">[docs]</a>    <span class="k">def</span> <span class="nf">info</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>

        <span class="n">obj</span><span class="p">,</span><span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>

        <span class="n">doc</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getdoc</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">doc</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">clearTab</span><span class="p">(</span><span class="s">&#39;Info&#39;</span><span class="p">,</span><span class="n">wrap</span><span class="o">=</span><span class="s">&#39;word&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">doc</span><span class="p">,</span><span class="n">tabName</span><span class="o">=</span><span class="s">&#39;Info&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;no docstring for&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">prefix</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20110510071925.14586: *4* init_qcompleter</span></div>
<div class="viewcode-block" id="AutoCompleterClass.init_qcompleter"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.init_qcompleter">[docs]</a>    <span class="k">def</span> <span class="nf">init_qcompleter</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

        <span class="c"># Compute the prefix and the list of options.</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_autocompleter_prefix</span><span class="p">()</span>
        <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_completions</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;prefix: </span><span class="si">%s</span><span class="s">, len(options): </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">prefix</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">options</span><span class="p">)))</span>

        <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">bodyCtrl</span><span class="o">.</span><span class="n">widget</span>
            <span class="c"># A LeoQTextBrowser.  May be none for unit tests.</span>

        <span class="k">if</span> <span class="n">w</span> <span class="ow">and</span> <span class="n">options</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qw</span> <span class="o">=</span> <span class="n">w</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qcompleter</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">init_completer</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auto_completer_state_handler</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;No completions&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20110511133940.14552: *4* init_tabcompleter</span></div>
<div class="viewcode-block" id="AutoCompleterClass.init_tabcompleter"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.init_tabcompleter">[docs]</a>    <span class="k">def</span> <span class="nf">init_tabcompleter</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="c"># Compute the prefix and the list of options.</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_autocompleter_prefix</span><span class="p">()</span>
        <span class="n">options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_completions</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">options</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clearTabName</span><span class="p">()</span> <span class="c"># Creates the tabbed pane.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auto_completer_state_handler</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;No completions&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20061031131434.39: *4* insert_general_char</span></div>
<div class="viewcode-block" id="AutoCompleterClass.insert_general_char"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.insert_general_char">[docs]</a>    <span class="k">def</span> <span class="nf">insert_general_char</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ch</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span><span class="p">,</span><span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="p">;</span> <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">ch</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isWordChar</span><span class="p">(</span><span class="n">ch</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
            <span class="n">common_prefix</span><span class="p">,</span><span class="n">prefix</span><span class="p">,</span><span class="n">aList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_completion_list</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;ch&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">ch</span><span class="p">),</span><span class="s">&#39;prefix&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">prefix</span><span class="p">),</span><span class="s">&#39;len(aList)&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">aList</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">aList</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">forbid_invalid</span><span class="p">:</span> <span class="c"># 2011/06/17.</span>
                    <span class="c"># Delete the character we just inserted.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">do_backspace</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_tab</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">common_prefix</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
                <span class="n">extend</span> <span class="o">=</span> <span class="n">common_prefix</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">):]</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;*** extend&#39;</span><span class="p">,</span><span class="n">extend</span><span class="p">)</span>
                <span class="n">ins</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getInsertPoint</span><span class="p">()</span>
                <span class="n">w</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">ins</span><span class="p">,</span><span class="n">extend</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;(&#39;</span> <span class="ow">and</span> <span class="n">k</span><span class="o">.</span><span class="n">enable_calltips</span><span class="p">:</span>
                <span class="c"># This calls self.exit if the &#39;(&#39; is valid.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calltip</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;ch&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">ch</span><span class="p">),</span><span class="s">&#39;calling exit&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">insert_string</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20061031131434.31: *4* insert_string</span></div>
<div class="viewcode-block" id="AutoCompleterClass.insert_string"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.insert_string">[docs]</a>    <span class="k">def</span> <span class="nf">insert_string</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">select</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Insert s at the insertion point.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w</span>

        <span class="n">c</span><span class="o">.</span><span class="n">widgetWantsFocusNow</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getInsertPoint</span><span class="p">()</span>
        <span class="n">w</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">select</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">w</span><span class="o">.</span><span class="n">setSelectionRange</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">insert</span><span class="o">=</span><span class="n">j</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">onBodyChanged</span><span class="p">(</span><span class="s">&#39;Typing&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_qcompleter</span><span class="p">:</span>
            <span class="c"># g.trace(self.qw.leo_qc)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qw</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">widgetWantsFocusNow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qw</span><span class="o">.</span><span class="n">leo_qc</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20110314115639.14269: *4* is_leo_source_file</span></div>
<div class="viewcode-block" id="AutoCompleterClass.is_leo_source_file"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.is_leo_source_file">[docs]</a>    <span class="k">def</span> <span class="nf">is_leo_source_file</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return True if this is one of Leo&#39;s source files.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>

        <span class="n">table</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s">&#39;leoDocs.leo&#39;</span><span class="p">,</span>
            <span class="s">&#39;leoGui.leo&#39;</span><span class="p">,</span>       <span class="s">&#39;leoGuiPluginsRef.leo&#39;</span><span class="p">,</span>
            <span class="s">&#39;leoPlugins.leo&#39;</span><span class="p">,</span>   <span class="s">&#39;leoPluginsRef.leo&#39;</span><span class="p">,</span>
            <span class="s">&#39;leoPy.leo&#39;</span><span class="p">,</span>        <span class="s">&#39;leoPyRef.leo&#39;</span><span class="p">,</span>
            <span class="s">&#39;myLeoSettings.leo&#39;</span><span class="p">,</span> <span class="s">&#39;leoSettings.leo&#39;</span><span class="p">,</span>
            <span class="s">&#39;ekr.leo&#39;</span><span class="p">,</span>
            <span class="c"># &#39;test.leo&#39;,</span>
        <span class="p">))</span>

        <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">table</span>
    <span class="c">#@+node:ekr.20101101175644.5891: *4* put</span></div>
<div class="viewcode-block" id="AutoCompleterClass.put"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.put">[docs]</a>    <span class="k">def</span> <span class="nf">put</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Put s to the given tab.</span>

<span class="sd">        May be overridden in subclasses.&#39;&#39;&#39;</span>

        <span class="c"># print(&#39;autoCompleter.put&#39;,args,keys)</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20110511133940.14561: *4* show_completion_list &amp; helpers</span></div>
<div class="viewcode-block" id="AutoCompleterClass.show_completion_list"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.show_completion_list">[docs]</a>    <span class="k">def</span> <span class="nf">show_completion_list</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">common_prefix</span><span class="p">,</span><span class="n">prefix</span><span class="p">,</span><span class="n">tabList</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>

        <span class="n">aList</span> <span class="o">=</span> <span class="n">common_prefix</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">aList</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c"># g.trace(self.use_qcompleter,len(tabList))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_qcompleter</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">tabList</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="n">tabList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_completion_list</span><span class="p">(</span><span class="n">header</span><span class="p">,</span><span class="n">tabList</span><span class="p">,)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tabList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_summary_list</span><span class="p">(</span><span class="n">header</span><span class="p">,</span><span class="n">tabList</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_qcompleter</span><span class="p">:</span>
            <span class="c"># Put the completions in the QListView.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qw</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">qw</span><span class="o">.</span><span class="n">show_completions</span><span class="p">(</span><span class="n">tabList</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Update the tab name, creating the tab if necessary.</span>
            <span class="n">c</span><span class="o">.</span><span class="n">widgetWantsFocus</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">clearTab</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tabName</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">beginTabName</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">header</span><span class="p">,</span><span class="n">header</span><span class="o">+</span><span class="s">&#39;.&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">))</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tabList</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">tabName</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tabName</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20110513104728.14453: *5* clean_completion_list</span></div>
<div class="viewcode-block" id="AutoCompleterClass.clean_completion_list"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.clean_completion_list">[docs]</a>    <span class="k">def</span> <span class="nf">clean_completion_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">header</span><span class="p">,</span><span class="n">tabList</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return aList with header removed from the start of each list item.&#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">header</span><span class="p">),</span><span class="n">z</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:],</span><span class="n">z</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">tabList</span><span class="p">]</span>
    <span class="c">#@+node:ekr.20110513104728.14454: *5* get_summary_list</span></div>
<div class="viewcode-block" id="AutoCompleterClass.get_summary_list"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.get_summary_list">[docs]</a>    <span class="k">def</span> <span class="nf">get_summary_list</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">header</span><span class="p">,</span><span class="n">tabList</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Show the possible starting letters,</span>
<span class="sd">        but only if there are more than one.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">tabList</span><span class="p">:</span>
            <span class="n">tail</span> <span class="o">=</span> <span class="n">z</span> <span class="ow">and</span> <span class="n">z</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">):]</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
            <span class="k">if</span> <span class="n">tail</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">):</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">tail</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="n">tail</span> <span class="ow">and</span> <span class="n">tail</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
            <span class="k">if</span> <span class="n">ch</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">d</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">aList</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ch</span><span class="p">,</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ch</span><span class="p">))</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">d</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aList</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">tabList</span> <span class="o">=</span> <span class="n">aList</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tabList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean_completion_list</span><span class="p">(</span><span class="n">header</span><span class="p">,</span><span class="n">tabList</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tabList</span>
    <span class="c">#@+node:ekr.20061031131434.46: *4* start</span></div>
<div class="viewcode-block" id="AutoCompleterClass.start"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>

        <span class="c"># We don&#39;t need to clear this now that we don&#39;t use ContextSniffer.</span>
        <span class="c"># self.completionsDict = {}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_qcompleter</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_qcompleter</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_tabcompleter</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20110512170111.14471: *4* strip_brackets</span></div>
<div class="viewcode-block" id="AutoCompleterClass.strip_brackets"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.AutoCompleterClass.strip_brackets">[docs]</a>    <span class="k">def</span> <span class="nf">strip_brackets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return s with all brackets removed.</span>

<span class="sd">        This (mostly) ensures that eval will not execute function calls, etc.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="s">&#39;[]{}()&#39;</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">s</span>
    <span class="c">#@-others</span>
<span class="c">#@+node:ekr.20110312162243.14260: ** class ContextSniffer</span></div></div>
<div class="viewcode-block" id="ContextSniffer"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.ContextSniffer">[docs]</a><span class="k">class</span> <span class="nc">ContextSniffer</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot; Class to analyze surrounding context and guess class</span>

<span class="sd">    For simple dynamic code completion engines.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vars</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c"># Keys are var names; values are list of classes</span>

    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20110312162243.14261: *3* get_classes</span>
<div class="viewcode-block" id="ContextSniffer.get_classes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.ContextSniffer.get_classes">[docs]</a>    <span class="k">def</span> <span class="nf">get_classes</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">varname</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return a list of classes for string s.&#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">push_declarations</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="n">aList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">varname</span><span class="p">,[])</span>   

        <span class="k">return</span> <span class="n">aList</span>
    <span class="c">#@+node:ekr.20110312162243.14262: *3* set_small_context</span>
    <span class="c"># def set_small_context(self, body):</span>

        <span class="c"># &quot;&quot;&quot; Set immediate function &quot;&quot;&quot;</span>

        <span class="c"># self.push_declarations(body)</span>
    <span class="c">#@+node:ekr.20110312162243.14263: *3* push_declarations &amp; helper</span></div>
<div class="viewcode-block" id="ContextSniffer.push_declarations"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.ContextSniffer.push_declarations">[docs]</a>    <span class="k">def</span> <span class="nf">push_declarations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="p">)</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">parts</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">declare</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span><span class="n">b</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="c">#@+node:ekr.20110312162243.14264: *4* declare</span></div>
<div class="viewcode-block" id="ContextSniffer.declare"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.ContextSniffer.declare">[docs]</a>    <span class="k">def</span> <span class="nf">declare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">klass</span><span class="p">):</span>

        <span class="c"># g.trace(var,klass) # Very large trace.</span>

        <span class="nb">vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">vars</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vars</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="nb">vars</span>

        <span class="nb">vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">klass</span><span class="p">)</span>
    <span class="c">#@-others</span>
<span class="c">#@+node:ekr.20061031131434.74: ** class keyHandlerClass</span></div></div>
<div class="viewcode-block" id="keyHandlerClass"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass">[docs]</a><span class="k">class</span> <span class="nc">keyHandlerClass</span><span class="p">:</span>

    <span class="sd">&#39;&#39;&#39;A class to support emacs-style commands.&#39;&#39;&#39;</span>

    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20061031131434.75: *3*  k.Birth</span>
    <span class="c">#@+node:ekr.20061031131434.76: *4* k.__init__</span>
    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Create a key handler for c.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="p">(</span><span class="bp">False</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">trace_startup</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;k.__init__&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispatchEvent</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inited</span> <span class="o">=</span> <span class="bp">False</span>         <span class="c"># Set at end of finishCreate.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">swap_mac_keys</span> <span class="o">=</span> <span class="bp">False</span>  <span class="c">#### How to init this ????</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="c"># Note: will be None for nullGui.</span>

        <span class="c"># Generalize...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_hasNumeric</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;sort-lines&#39;</span><span class="p">,</span><span class="s">&#39;sort-fields&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">altX_prompt</span> <span class="o">=</span> <span class="s">&#39;full-command: &#39;</span>

        <span class="c"># Access to data types defined in leoKeys.py</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">KeyStroke</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">KeyStroke</span>

        <span class="c"># Define all ivars...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defineExternallyVisibleIvars</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defineInternalIvars</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defineSettingsIvars</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">new_modes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">modeController</span> <span class="o">=</span> <span class="n">ModeController</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">defineTkNames</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defineSpecialKeys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defineSingleLineCommands</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defineMultiLineCommands</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autoCompleter</span> <span class="o">=</span> <span class="n">AutoCompleterClass</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qcompleter</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># Set by AutoCompleter.start.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setDefaultUnboundKeyAction</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setDefaultEditingAction</span><span class="p">()</span> <span class="c"># 2011/02/09</span>
    <span class="c">#@+node:ekr.20061031131434.78: *4* k.defineExternallyVisibleIvars</span>
<div class="viewcode-block" id="keyHandlerClass.defineExternallyVisibleIvars"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.defineExternallyVisibleIvars">[docs]</a>    <span class="k">def</span> <span class="nf">defineExternallyVisibleIvars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">abbrevOn</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="c"># True: abbreviations are on.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arg</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="c"># The value returned by k.getArg.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">argSelectedText</span> <span class="o">=</span> <span class="s">&#39;&#39;</span> <span class="c"># The selected text in state 0.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commandName</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># The name of the command being executed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">funcReturn</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># For k.simulateCommand</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getArgEscape</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># A signal that the user escaped getArg in an unusual way.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">givenArgs</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># New in Leo 4.4.8: arguments specified after the command name in k.simulateCommand.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputModeBindings</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputModeName</span> <span class="o">=</span> <span class="s">&#39;&#39;</span> <span class="c"># The name of the input mode, or None.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inverseCommandsDict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c"># Completed in k.finishCreate, but leoCommands.getPublicCommands adds entries first.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modePrompt</span> <span class="o">=</span> <span class="s">&#39;&#39;</span> <span class="c"># The mode promopt.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">negativeArg</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newMinibufferWidget</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># Usually the minibuffer restores focus.  This overrides this default.</span>
        <span class="c"># self.regx = g.bunch(iter=None,key=None)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repeatCount</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">bunch</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">handler</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20061031131434.79: *4* k.defineInternalIvars</span></div>
<div class="viewcode-block" id="keyHandlerClass.defineInternalIvars"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.defineInternalIvars">[docs]</a>    <span class="k">def</span> <span class="nf">defineInternalIvars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">abbreviationsDict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c"># Abbreviations created by @alias nodes.</span>

        <span class="c"># Previously defined bindings...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bindingsDict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c"># Keys are Tk key names, values are lists of ShortcutInfo&#39;s.</span>
        <span class="c"># Previously defined binding tags.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bindtagsDict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c"># Keys are strings (the tag), values are &#39;True&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">masterBindingsDict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c"># Keys are scope names: &#39;all&#39;,&#39;text&#39;,etc. or mode names.</span>
            <span class="c"># Values are dicts: keys are strokes, values are ShortcutInfo&#39;s.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">masterGuiBindingsDict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c"># Keys are strokes; value is True;</span>

        <span class="c"># Special bindings for k.fullCommand...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mb_copyKey</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mb_pasteKey</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mb_cutKey</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mb_help</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># Keys whose bindings are computed by initSpecialIvars...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abortAllModesKey</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autoCompleteForceKey</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fullCommandKey</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">universalArgKey</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># Keepting track of the characters in the mini-buffer...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arg_completion</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mb_event</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mb_history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mb_prefix</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mb_tabListPrefix</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mb_tabList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mb_tabListIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mb_prompt</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stroke</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># For onIdleTime...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idleCount</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c"># For modes...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">afterGetArgState</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">argTabList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getArgEscapes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modeBindingsDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modeWidget</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">silentMode</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20080509064108.7: *4* k.defineMultiLineCommands</span></div>
<div class="viewcode-block" id="keyHandlerClass.defineMultiLineCommands"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.defineMultiLineCommands">[docs]</a>    <span class="k">def</span> <span class="nf">defineMultiLineCommands</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">k</span><span class="o">.</span><span class="n">multiLineCommandList</span> <span class="o">=</span> <span class="p">[</span>
            <span class="c"># editCommandsClass</span>
            <span class="s">&#39;add-space-to-lines&#39;</span><span class="p">,</span>
            <span class="s">&#39;add-tab-to-lines&#39;</span><span class="p">,</span>
            <span class="s">&#39;back-page&#39;</span><span class="p">,</span>
            <span class="s">&#39;back-page-extend-selection&#39;</span><span class="p">,</span>
            <span class="s">&#39;back-paragraph&#39;</span><span class="p">,</span>
            <span class="s">&#39;back-paragraph-extend-selection&#39;</span><span class="p">,</span>
            <span class="s">&#39;back-sentence&#39;</span><span class="p">,</span>
            <span class="s">&#39;back-sentence-extend-selection&#39;</span><span class="p">,</span>
            <span class="s">&#39;backward-kill-paragraph&#39;</span><span class="p">,</span>
            <span class="s">&#39;beginning-of-buffer&#39;</span><span class="p">,</span>
            <span class="s">&#39;beginning-of-buffer-extend-selection&#39;</span><span class="p">,</span>
            <span class="s">&#39;center-line&#39;</span><span class="p">,</span>
            <span class="s">&#39;center-region&#39;</span><span class="p">,</span>
            <span class="s">&#39;clean-all-lines&#39;</span><span class="p">,</span>
            <span class="s">&#39;clean-lines&#39;</span><span class="p">,</span>
            <span class="s">&#39;downcase-region&#39;</span><span class="p">,</span>
            <span class="s">&#39;end-of-buffer&#39;</span><span class="p">,</span>
            <span class="s">&#39;end-of-buffer-extend-selection&#39;</span><span class="p">,</span>
            <span class="s">&#39;extend-to-paragraph&#39;</span><span class="p">,</span>
            <span class="s">&#39;extend-to-sentence&#39;</span><span class="p">,</span>
            <span class="s">&#39;fill-paragraph&#39;</span><span class="p">,</span>
            <span class="s">&#39;fill-region&#39;</span><span class="p">,</span>
            <span class="s">&#39;fill-region-as-paragraph&#39;</span><span class="p">,</span>
            <span class="s">&#39;flush-lines&#39;</span><span class="p">,</span>
            <span class="s">&#39;forward-page&#39;</span><span class="p">,</span>
            <span class="s">&#39;forward-page-extend-selection&#39;</span><span class="p">,</span>
            <span class="s">&#39;forward-paragraph&#39;</span><span class="p">,</span>
            <span class="s">&#39;forward-paragraph-extend-selection&#39;</span><span class="p">,</span>
            <span class="s">&#39;forward-sentence&#39;</span><span class="p">,</span>
            <span class="s">&#39;forward-sentence-extend-selection&#39;</span><span class="p">,</span>
            <span class="s">&#39;indent-relative&#39;</span><span class="p">,</span>
            <span class="s">&#39;indent-rigidly&#39;</span><span class="p">,</span>
            <span class="s">&#39;indent-to-comment-column&#39;</span><span class="p">,</span>
            <span class="s">&#39;move-lines-down&#39;</span><span class="p">,</span>
            <span class="s">&#39;move-lines-up&#39;</span><span class="p">,</span>
            <span class="s">&#39;next-line&#39;</span><span class="p">,</span>
            <span class="s">&#39;next-line-extend-selection&#39;</span><span class="p">,</span>
            <span class="s">&#39;previous-line&#39;</span><span class="p">,</span>
            <span class="s">&#39;previous-line-extend-selection&#39;</span><span class="p">,</span>
            <span class="s">&#39;remove-blank-lines&#39;</span><span class="p">,</span>
            <span class="s">&#39;remove-space-from-lines&#39;</span><span class="p">,</span>
            <span class="s">&#39;remove-tab-from-lines&#39;</span><span class="p">,</span>
            <span class="s">&#39;reverse-region&#39;</span><span class="p">,</span>
            <span class="s">&#39;reverse-sort-lines&#39;</span><span class="p">,</span>
            <span class="s">&#39;reverse-sort-lines-ignoring-case&#39;</span><span class="p">,</span>
            <span class="s">&#39;scroll-down-half-page&#39;</span><span class="p">,</span>
            <span class="s">&#39;scroll-down-line&#39;</span><span class="p">,</span>
            <span class="s">&#39;scroll-down-page&#39;</span><span class="p">,</span>
            <span class="s">&#39;scroll-up-half-page&#39;</span><span class="p">,</span>
            <span class="s">&#39;scroll-up-line&#39;</span><span class="p">,</span>
            <span class="s">&#39;scroll-up-page&#39;</span><span class="p">,</span>
            <span class="s">&#39;simulate-begin-drag&#39;</span><span class="p">,</span>
            <span class="s">&#39;simulate-end-drag&#39;</span><span class="p">,</span>
            <span class="s">&#39;sort-columns&#39;</span><span class="p">,</span>
            <span class="s">&#39;sort-fields&#39;</span><span class="p">,</span>
            <span class="s">&#39;sort-lines&#39;</span><span class="p">,</span>
            <span class="s">&#39;sort-lines-ignoring-case&#39;</span><span class="p">,</span>
            <span class="s">&#39;split-line&#39;</span><span class="p">,</span>
            <span class="s">&#39;tabify&#39;</span><span class="p">,</span>
            <span class="s">&#39;transpose-lines&#39;</span><span class="p">,</span>
            <span class="s">&#39;untabify&#39;</span><span class="p">,</span>
            <span class="s">&#39;upcase-region&#39;</span><span class="p">,</span>
            <span class="c"># keyHandlerCommandsClass</span>
            <span class="s">&#39;repeat-complex-command&#39;</span><span class="p">,</span>
            <span class="c"># killBufferCommandsClass</span>
            <span class="s">&#39;backward-kill-sentence&#39;</span><span class="p">,</span>
            <span class="s">&#39;kill-sentence&#39;</span><span class="p">,</span>
            <span class="s">&#39;kill-region&#39;</span><span class="p">,</span>
            <span class="s">&#39;kill-region-save&#39;</span><span class="p">,</span>
            <span class="c"># queryReplaceCommandsClass</span>
            <span class="s">&#39;query-replace&#39;</span><span class="p">,</span>
            <span class="s">&#39;query-replace-regex&#39;</span><span class="p">,</span>
            <span class="c"># rectangleCommandsClass</span>
            <span class="s">&#39;clear-rectangle&#39;</span><span class="p">,</span>
            <span class="s">&#39;close-rectangle&#39;</span><span class="p">,</span>
            <span class="s">&#39;delete-rectangle&#39;</span><span class="p">,</span>
            <span class="s">&#39;kill-rectangle&#39;</span><span class="p">,</span>
            <span class="s">&#39;open-rectangle&#39;</span><span class="p">,</span>
            <span class="s">&#39;string-rectangle&#39;</span><span class="p">,</span>
            <span class="s">&#39;yank-rectangle&#39;</span><span class="p">,</span>
            <span class="c"># registerCommandsClass</span>
            <span class="s">&#39;jump-to-register&#39;</span><span class="p">,</span>
            <span class="s">&#39;point-to-register&#39;</span><span class="p">,</span>
            <span class="c"># searchCommandsClass</span>
            <span class="s">&#39;change&#39;</span><span class="p">,</span>
            <span class="s">&#39;change-then-find&#39;</span><span class="p">,</span>
            <span class="s">&#39;find-next&#39;</span><span class="p">,</span>
            <span class="s">&#39;find-prev&#39;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="c">#@+node:ekr.20120217070122.10479: *4* k.defineSettingIvars</span></div>
<div class="viewcode-block" id="keyHandlerClass.defineSettingsIvars"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.defineSettingsIvars">[docs]</a>    <span class="k">def</span> <span class="nf">defineSettingsIvars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># Part 1: These were in the ctor.</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="n">getBool</span>  <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getBool</span>
        <span class="n">getColor</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getColor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_autocompleter</span>           <span class="o">=</span> <span class="n">getBool</span><span class="p">(</span><span class="s">&#39;enable_autocompleter_initially&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_calltips</span>                <span class="o">=</span> <span class="n">getBool</span><span class="p">(</span><span class="s">&#39;enable_calltips_initially&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_caps_lock</span>               <span class="o">=</span> <span class="n">getBool</span><span class="p">(</span><span class="s">&#39;ignore_caps_lock&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_unbound_non_ascii_keys</span>  <span class="o">=</span> <span class="n">getBool</span><span class="p">(</span><span class="s">&#39;ignore_unbound_non_ascii_keys&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minibuffer_background_color</span>    <span class="o">=</span> <span class="n">getColor</span><span class="p">(</span><span class="s">&#39;minibuffer_background_color&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;lightblue&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minibuffer_foreground_color</span>    <span class="o">=</span> <span class="n">getColor</span><span class="p">(</span><span class="s">&#39;minibuffer_foreground_color&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;black&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minibuffer_warning_color</span>       <span class="o">=</span> <span class="n">getColor</span><span class="p">(</span><span class="s">&#39;minibuffer_warning_color&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;lightgrey&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minibuffer_error_color</span>         <span class="o">=</span> <span class="n">getColor</span><span class="p">(</span><span class="s">&#39;minibuffer_error_color&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;red&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">swap_mac_keys</span>                  <span class="o">=</span> <span class="n">getBool</span><span class="p">(</span><span class="s">&#39;swap_mac_keys&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">warn_about_redefined_shortcuts</span> <span class="o">=</span> <span class="n">getBool</span><span class="p">(</span><span class="s">&#39;warn_about_redefined_shortcuts&#39;</span><span class="p">)</span>
        <span class="c"># Has to be disabled (default) for AltGr support on Windows</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enable_alt_ctrl_bindings</span>       <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getBool</span><span class="p">(</span><span class="s">&#39;enable_alt_ctrl_bindings&#39;</span><span class="p">)</span>

        <span class="c"># Part 2: These were in finishCreate.</span>

        <span class="c"># Set mode colors used by k.setInputState.</span>
        <span class="n">bg</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getColor</span><span class="p">(</span><span class="s">&#39;body_text_background_color&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;white&#39;</span>
        <span class="n">fg</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getColor</span><span class="p">(</span><span class="s">&#39;body_text_foreground_color&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;black&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">command_mode_bg_color</span>    <span class="o">=</span> <span class="n">getColor</span><span class="p">(</span><span class="s">&#39;command_mode_bg_color&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">bg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">command_mode_fg_color</span>    <span class="o">=</span> <span class="n">getColor</span><span class="p">(</span><span class="s">&#39;command_mode_fg_color&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">fg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert_mode_bg_color</span>     <span class="o">=</span> <span class="n">getColor</span><span class="p">(</span><span class="s">&#39;insert_mode_bg_color&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">bg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insert_mode_fg_color</span>     <span class="o">=</span> <span class="n">getColor</span><span class="p">(</span><span class="s">&#39;insert_mode_fg_color&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">fg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overwrite_mode_bg_color</span>  <span class="o">=</span> <span class="n">getColor</span><span class="p">(</span><span class="s">&#39;overwrite_mode_bg_color&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">bg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overwrite_mode_fg_color</span>  <span class="o">=</span> <span class="n">getColor</span><span class="p">(</span><span class="s">&#39;overwrite_mode_fg_color&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">fg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unselected_body_bg_color</span> <span class="o">=</span> <span class="n">getColor</span><span class="p">(</span><span class="s">&#39;unselected_body_bg_color&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">bg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unselected_body_fg_color</span> <span class="o">=</span> <span class="n">getColor</span><span class="p">(</span><span class="s">&#39;unselected_body_fg_color&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">bg</span>

        <span class="c"># g.trace(self.c.shortFileName())</span>
    <span class="c">#@+node:ekr.20080509064108.6: *4* k.defineSingleLineCommands</span></div>
<div class="viewcode-block" id="keyHandlerClass.defineSingleLineCommands"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.defineSingleLineCommands">[docs]</a>    <span class="k">def</span> <span class="nf">defineSingleLineCommands</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># These commands can be executed in the minibuffer.</span>
        <span class="n">k</span><span class="o">.</span><span class="n">singleLineCommandList</span> <span class="o">=</span> <span class="p">[</span>
            <span class="c"># editCommandsClass</span>
            <span class="s">&#39;back-to-indentation&#39;</span><span class="p">,</span>
            <span class="s">&#39;back-to-home&#39;</span><span class="p">,</span> <span class="c"># 2010/02/01</span>
            <span class="s">&#39;back-char&#39;</span><span class="p">,</span>
            <span class="s">&#39;back-char-extend-selection&#39;</span><span class="p">,</span>
            <span class="s">&#39;back-word&#39;</span><span class="p">,</span>
            <span class="s">&#39;back-word-extend-selection&#39;</span><span class="p">,</span>
            <span class="s">&#39;backward-delete-char&#39;</span><span class="p">,</span>
            <span class="s">&#39;backward-find-character&#39;</span><span class="p">,</span>
            <span class="s">&#39;backward-find-character-extend-selection&#39;</span><span class="p">,</span>
            <span class="s">&#39;beginning-of-line&#39;</span><span class="p">,</span>
            <span class="s">&#39;beginning-of-line-extend-selection&#39;</span><span class="p">,</span>
            <span class="s">&#39;capitalize-word&#39;</span><span class="p">,</span>
            <span class="s">&#39;delete-char&#39;</span><span class="p">,</span>
            <span class="s">&#39;delete-indentation&#39;</span><span class="p">,</span>
            <span class="s">&#39;delete-spaces&#39;</span><span class="p">,</span>
            <span class="s">&#39;downcase-word&#39;</span><span class="p">,</span>
            <span class="s">&#39;end-of-line&#39;</span><span class="p">,</span>
            <span class="s">&#39;end-of-line-extend-selection&#39;</span><span class="p">,</span>
            <span class="s">&#39;escape&#39;</span><span class="p">,</span>
            <span class="s">&#39;exchange-point-mark&#39;</span><span class="p">,</span>
            <span class="s">&#39;extend-to-line&#39;</span><span class="p">,</span>
            <span class="s">&#39;extend-to-word&#39;</span><span class="p">,</span>
            <span class="s">&#39;find-character&#39;</span><span class="p">,</span>
            <span class="s">&#39;find-character-extend-selection&#39;</span><span class="p">,</span>
            <span class="s">&#39;find-word&#39;</span><span class="p">,</span>
            <span class="s">&#39;find-word-in-line&#39;</span><span class="p">,</span>
            <span class="s">&#39;forward-char&#39;</span><span class="p">,</span>
            <span class="s">&#39;forward-char-extend-selection&#39;</span><span class="p">,</span>
            <span class="s">&#39;forward-end-word&#39;</span><span class="p">,</span>
            <span class="s">&#39;forward-end-word-extend-selection&#39;</span><span class="p">,</span>
            <span class="s">&#39;forward-word&#39;</span><span class="p">,</span>
            <span class="s">&#39;forward-word-extend-selection&#39;</span><span class="p">,</span>
            <span class="s">&#39;insert-newline&#39;</span><span class="p">,</span>
            <span class="s">&#39;insert-parentheses&#39;</span><span class="p">,</span>
            <span class="s">&#39;move-past-close&#39;</span><span class="p">,</span>
            <span class="s">&#39;move-past-close-extend-selection&#39;</span><span class="p">,</span>
            <span class="s">&#39;newline-and-indent&#39;</span><span class="p">,</span>
            <span class="s">&#39;select-all&#39;</span><span class="p">,</span>
            <span class="s">&#39;transpose-chars&#39;</span><span class="p">,</span>
            <span class="s">&#39;transpose-words&#39;</span><span class="p">,</span>
            <span class="s">&#39;upcase-word&#39;</span><span class="p">,</span>
            <span class="c"># keyHandlerCommandsClass</span>
            <span class="c"># &#39;auto-complete&#39;,</span>
            <span class="s">&#39;negative-argument&#39;</span><span class="p">,</span>
            <span class="s">&#39;number-command&#39;</span><span class="p">,</span>
            <span class="s">&#39;number-command-0&#39;</span><span class="p">,</span>
            <span class="s">&#39;number-command-1&#39;</span><span class="p">,</span>
            <span class="s">&#39;number-command-2&#39;</span><span class="p">,</span>
            <span class="s">&#39;number-command-3&#39;</span><span class="p">,</span>
            <span class="s">&#39;number-command-4&#39;</span><span class="p">,</span>
            <span class="s">&#39;number-command-5&#39;</span><span class="p">,</span>
            <span class="s">&#39;number-command-6&#39;</span><span class="p">,</span>
            <span class="s">&#39;number-command-7&#39;</span><span class="p">,</span>
            <span class="s">&#39;number-command-8&#39;</span><span class="p">,</span>
            <span class="s">&#39;universal-argument&#39;</span><span class="p">,</span>
            <span class="c"># killBufferCommandsClass</span>
            <span class="s">&#39;backward-kill-word&#39;</span><span class="p">,</span>
            <span class="s">&#39;kill-line&#39;</span><span class="p">,</span>
            <span class="s">&#39;kill-word&#39;</span><span class="p">,</span>
            <span class="s">&#39;kill-ws&#39;</span><span class="p">,</span>
            <span class="s">&#39;yank&#39;</span><span class="p">,</span>
            <span class="s">&#39;yank-pop&#39;</span><span class="p">,</span>
            <span class="s">&#39;zap-to-character&#39;</span><span class="p">,</span>
            <span class="c"># leoCommands</span>
            <span class="s">&#39;cut-text&#39;</span><span class="p">,</span>
            <span class="s">&#39;copy-text&#39;</span><span class="p">,</span>
            <span class="s">&#39;paste-text&#39;</span><span class="p">,</span>
            <span class="c"># macroCommandsClass</span>
            <span class="s">&#39;call-last-kbd-macro&#39;</span><span class="p">,</span>
            <span class="c"># search commands</span>
            <span class="c"># &#39;replace-string&#39;, # A special case so Shift-Ctrl-r will work after Ctrl-f.</span>
            <span class="s">&#39;set-find-everywhere&#39;</span><span class="p">,</span>              <span class="c"># 2011/06/07</span>
            <span class="s">&#39;set-find-node-only&#39;</span><span class="p">,</span>               <span class="c"># 2011/06/07</span>
            <span class="s">&#39;set-find-suboutline-only&#39;</span><span class="p">,</span>         <span class="c"># 2011/06/07</span>
            <span class="s">&#39;toggle-find-collapses_nodes&#39;</span><span class="p">,</span>
            <span class="s">&#39;toggle-find-ignore-case-option&#39;</span><span class="p">,</span>
            <span class="s">&#39;toggle-find-in-body-option&#39;</span><span class="p">,</span>
            <span class="s">&#39;toggle-find-in-headline-option&#39;</span><span class="p">,</span>
            <span class="s">&#39;toggle-find-mark-changes-option&#39;</span><span class="p">,</span>
            <span class="s">&#39;toggle-find-mark-finds-option&#39;</span><span class="p">,</span>
            <span class="s">&#39;toggle-find-regex-option&#39;</span><span class="p">,</span>
            <span class="s">&#39;toggle-find-reverse-option&#39;</span><span class="p">,</span>
            <span class="s">&#39;toggle-find-word-option&#39;</span><span class="p">,</span>
            <span class="s">&#39;toggle-find-wrap-around-option&#39;</span><span class="p">,</span>
            <span class="c"># registerCommandsClass</span>
            <span class="s">&#39;append-to-register&#39;</span><span class="p">,</span>
            <span class="s">&#39;copy-to-register&#39;</span><span class="p">,</span>
            <span class="s">&#39;insert-register&#39;</span><span class="p">,</span>
            <span class="s">&#39;prepend-to-register&#39;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="c">#@+node:ekr.20070123085931: *4* k.defineSpecialKeys</span></div>
<div class="viewcode-block" id="keyHandlerClass.defineSpecialKeys"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.defineSpecialKeys">[docs]</a>    <span class="k">def</span> <span class="nf">defineSpecialKeys</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Define k.guiBindNamesDict and k.guiBindNamesInverseDict.</span>

<span class="sd">        Important: all gui&#39;s use these dictionaries because bindings in</span>
<span class="sd">        leoSettings.leo use these representations.&#39;&#39;&#39;</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># These are defined at http://tcl.activestate.com/man/tcl8.4/TkCmd/keysyms.htm.</span>
        <span class="c"># Important: only the inverse dict is actually used in the new key binding scheme.</span>
        <span class="c"># Tk may return the *values* of this dict in event.keysym fields.</span>
        <span class="c"># Leo will warn if it gets a event whose keysym not in values of this table.</span>
        <span class="n">k</span><span class="o">.</span><span class="n">guiBindNamesDict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&quot;&amp;&quot;</span> <span class="p">:</span> <span class="s">&quot;ampersand&quot;</span><span class="p">,</span>
            <span class="s">&quot;^&quot;</span> <span class="p">:</span> <span class="s">&quot;asciicircum&quot;</span><span class="p">,</span>
            <span class="s">&quot;~&quot;</span> <span class="p">:</span> <span class="s">&quot;asciitilde&quot;</span><span class="p">,</span>
            <span class="s">&quot;*&quot;</span> <span class="p">:</span> <span class="s">&quot;asterisk&quot;</span><span class="p">,</span>
            <span class="s">&quot;@&quot;</span> <span class="p">:</span> <span class="s">&quot;at&quot;</span><span class="p">,</span>
            <span class="s">&quot;</span><span class="se">\\</span><span class="s">&quot;</span><span class="p">:</span> <span class="s">&quot;backslash&quot;</span><span class="p">,</span>
            <span class="s">&quot;|&quot;</span> <span class="p">:</span> <span class="s">&quot;bar&quot;</span><span class="p">,</span>
            <span class="s">&quot;{&quot;</span> <span class="p">:</span> <span class="s">&quot;braceleft&quot;</span><span class="p">,</span>
            <span class="s">&quot;}&quot;</span> <span class="p">:</span> <span class="s">&quot;braceright&quot;</span><span class="p">,</span>
            <span class="s">&quot;[&quot;</span> <span class="p">:</span> <span class="s">&quot;bracketleft&quot;</span><span class="p">,</span>
            <span class="s">&quot;]&quot;</span> <span class="p">:</span> <span class="s">&quot;bracketright&quot;</span><span class="p">,</span>
            <span class="s">&quot;:&quot;</span> <span class="p">:</span> <span class="s">&quot;colon&quot;</span><span class="p">,</span>      <span class="c"># removed from code.</span>
            <span class="s">&quot;,&quot;</span> <span class="p">:</span> <span class="s">&quot;comma&quot;</span><span class="p">,</span>
            <span class="s">&quot;$&quot;</span> <span class="p">:</span> <span class="s">&quot;dollar&quot;</span><span class="p">,</span>
            <span class="s">&quot;=&quot;</span> <span class="p">:</span> <span class="s">&quot;equal&quot;</span><span class="p">,</span>
            <span class="s">&quot;!&quot;</span> <span class="p">:</span> <span class="s">&quot;exclam&quot;</span><span class="p">,</span>     <span class="c"># removed from code.</span>
            <span class="s">&quot;&gt;&quot;</span> <span class="p">:</span> <span class="s">&quot;greater&quot;</span><span class="p">,</span>
            <span class="s">&quot;&lt;&quot;</span> <span class="p">:</span> <span class="s">&quot;less&quot;</span><span class="p">,</span>
            <span class="s">&quot;-&quot;</span> <span class="p">:</span> <span class="s">&quot;minus&quot;</span><span class="p">,</span>
            <span class="s">&quot;#&quot;</span> <span class="p">:</span> <span class="s">&quot;numbersign&quot;</span><span class="p">,</span>
            <span class="s">&#39;&quot;&#39;</span> <span class="p">:</span> <span class="s">&quot;quotedbl&quot;</span><span class="p">,</span>
            <span class="s">&quot;&#39;&quot;</span> <span class="p">:</span> <span class="s">&quot;quoteright&quot;</span><span class="p">,</span>
            <span class="s">&quot;(&quot;</span> <span class="p">:</span> <span class="s">&quot;parenleft&quot;</span><span class="p">,</span>
            <span class="s">&quot;)&quot;</span> <span class="p">:</span> <span class="s">&quot;parenright&quot;</span><span class="p">,</span> <span class="c"># removed from code.</span>
            <span class="s">&quot;%&quot;</span> <span class="p">:</span> <span class="s">&quot;percent&quot;</span><span class="p">,</span>
            <span class="s">&quot;.&quot;</span> <span class="p">:</span> <span class="s">&quot;period&quot;</span><span class="p">,</span>     <span class="c"># removed from code.</span>
            <span class="s">&quot;+&quot;</span> <span class="p">:</span> <span class="s">&quot;plus&quot;</span><span class="p">,</span>
            <span class="s">&quot;?&quot;</span> <span class="p">:</span> <span class="s">&quot;question&quot;</span><span class="p">,</span>
            <span class="s">&quot;`&quot;</span> <span class="p">:</span> <span class="s">&quot;quoteleft&quot;</span><span class="p">,</span>
            <span class="s">&quot;;&quot;</span> <span class="p">:</span> <span class="s">&quot;semicolon&quot;</span><span class="p">,</span>
            <span class="s">&quot;/&quot;</span> <span class="p">:</span> <span class="s">&quot;slash&quot;</span><span class="p">,</span>
            <span class="s">&quot; &quot;</span> <span class="p">:</span> <span class="s">&quot;space&quot;</span><span class="p">,</span>      <span class="c"># removed from code.</span>
            <span class="s">&quot;_&quot;</span> <span class="p">:</span> <span class="s">&quot;underscore&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c"># No translation.</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">k</span><span class="o">.</span><span class="n">tkNamesList</span><span class="p">:</span>
            <span class="n">k</span><span class="o">.</span><span class="n">guiBindNamesDict</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>

        <span class="c"># Create the inverse dict.</span>
        <span class="n">k</span><span class="o">.</span><span class="n">guiBindNamesInverseDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">k</span><span class="o">.</span><span class="n">guiBindNamesDict</span><span class="p">:</span>
            <span class="n">k</span><span class="o">.</span><span class="n">guiBindNamesInverseDict</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">guiBindNamesDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">key</span>
    <span class="c">#@+node:ekr.20070123143428: *4* k.defineTkNames</span></div>
<div class="viewcode-block" id="keyHandlerClass.defineTkNames"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.defineTkNames">[docs]</a>    <span class="k">def</span> <span class="nf">defineTkNames</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># These are the key names used in Leo&#39;s core *regardless* of the gui actually in effect.</span>
        <span class="c"># The gui is responsible for translating gui-dependent keycodes into these values.</span>
        <span class="n">k</span><span class="o">.</span><span class="n">tkNamesList</span> <span class="o">=</span> <span class="p">(</span>
            <span class="c"># Arrow keys.</span>
            <span class="s">&#39;Left&#39;</span><span class="p">,</span><span class="s">&#39;Right&#39;</span><span class="p">,</span><span class="s">&#39;Up&#39;</span><span class="p">,</span><span class="s">&#39;Down&#39;</span><span class="p">,</span>
            <span class="c"># Page up/down keys.</span>
            <span class="s">&#39;Next&#39;</span><span class="p">,</span><span class="s">&#39;Prior&#39;</span><span class="p">,</span>
            <span class="c"># Home end keys.</span>
            <span class="s">&#39;Home&#39;</span><span class="p">,</span><span class="s">&#39;End&#39;</span>
            <span class="c"># Modifier keys.</span>
            <span class="s">&#39;Caps_Lock&#39;</span><span class="p">,</span><span class="s">&#39;Num_Lock&#39;</span><span class="p">,</span>
            <span class="c"># F-keys.</span>
            <span class="s">&#39;F1&#39;</span><span class="p">,</span><span class="s">&#39;F2&#39;</span><span class="p">,</span><span class="s">&#39;F3&#39;</span><span class="p">,</span><span class="s">&#39;F4&#39;</span><span class="p">,</span><span class="s">&#39;F5&#39;</span><span class="p">,</span><span class="s">&#39;F6&#39;</span><span class="p">,</span><span class="s">&#39;F7&#39;</span><span class="p">,</span><span class="s">&#39;F8&#39;</span><span class="p">,</span><span class="s">&#39;F9&#39;</span><span class="p">,</span><span class="s">&#39;F10&#39;</span><span class="p">,</span><span class="s">&#39;F11&#39;</span><span class="p">,</span><span class="s">&#39;F12&#39;</span><span class="p">,</span>
            <span class="c"># All others.</span>
            <span class="s">&#39;Begin&#39;</span><span class="p">,</span><span class="s">&#39;Break&#39;</span><span class="p">,</span><span class="s">&#39;Clear&#39;</span><span class="p">,</span><span class="s">&#39;Delete&#39;</span><span class="p">,</span><span class="s">&#39;Escape&#39;</span><span class="p">,</span>
            <span class="c"># Dubious: these are ascii characters!</span>
            <span class="c"># But there is no harm in retaining these in Leo&#39;s core.</span>
            <span class="s">&#39;BackSpace&#39;</span><span class="p">,</span><span class="s">&#39;Linefeed&#39;</span><span class="p">,</span><span class="s">&#39;Return&#39;</span><span class="p">,</span><span class="s">&#39;Tab&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c"># These keys settings that may be specied in leoSettings.leo.</span>
        <span class="c"># Keys are lowercase, so that case is not significant *for these items only* in leoSettings.leo.</span>
        <span class="n">k</span><span class="o">.</span><span class="n">settingsNameDict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;bksp&#39;</span>    <span class="p">:</span> <span class="s">&#39;BackSpace&#39;</span><span class="p">,</span> <span class="c"># Dubious: should be &#39;\b&#39;</span>
            <span class="s">&#39;dnarrow&#39;</span> <span class="p">:</span> <span class="s">&#39;Down&#39;</span><span class="p">,</span>
            <span class="s">&#39;esc&#39;</span>     <span class="p">:</span> <span class="s">&#39;Escape&#39;</span><span class="p">,</span>
            <span class="s">&#39;ltarrow&#39;</span> <span class="p">:</span> <span class="s">&#39;Left&#39;</span><span class="p">,</span>
            <span class="s">&#39;pageup&#39;</span>  <span class="p">:</span> <span class="s">&#39;Prior&#39;</span><span class="p">,</span>
            <span class="s">&#39;pagedn&#39;</span>  <span class="p">:</span> <span class="s">&#39;Next&#39;</span><span class="p">,</span>
            <span class="s">&#39;rtarrow&#39;</span> <span class="p">:</span> <span class="s">&#39;Right&#39;</span><span class="p">,</span>
            <span class="s">&#39;uparrow&#39;</span> <span class="p">:</span> <span class="s">&#39;Up&#39;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c"># Add lowercase version of special keys.</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">k</span><span class="o">.</span><span class="n">tkNamesList</span><span class="p">:</span>
            <span class="n">k</span><span class="o">.</span><span class="n">settingsNameDict</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span> <span class="o">=</span> <span class="n">s</span>

    <span class="c">#@+at</span>
    <span class="c"># The following are not translated, so what appears in the menu is the</span>
    <span class="c"># same as what is passed to the gui. Case is significant. Note: the Tk</span>
    <span class="c"># documentation states that not all of these may be available on all</span>
    <span class="c"># platforms.</span>
    <span class="c"># </span>
    <span class="c"># Num_Lock, Pause, Scroll_Lock, Sys_Req,</span>
    <span class="c"># KP_Add, KP_Decimal, KP_Divide, KP_Enter, KP_Equal,</span>
    <span class="c"># KP_Multiply, KP_Separator,KP_Space, KP_Subtract, KP_Tab,</span>
    <span class="c"># KP_F1,KP_F2,KP_F3,KP_F4,</span>
    <span class="c"># KP_0,KP_1,KP_2,KP_3,KP_4,KP_5,KP_6,KP_7,KP_8,KP_9,</span>
    <span class="c"># Insert</span>
    <span class="c">#@+node:ekr.20061031131434.80: *4* k.finishCreate &amp; helpers</span></div>
<div class="viewcode-block" id="keyHandlerClass.finishCreate"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.finishCreate">[docs]</a>    <span class="k">def</span> <span class="nf">finishCreate</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Complete the construction of the keyHandler class.</span>
<span class="sd">        c.commandsDict has been created when this is called.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="p">(</span><span class="bp">False</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">trace_startup</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;k.finishCreate&#39;</span><span class="p">)</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">miniBufferWidget</span>
            <span class="c"># Will be None for nullGui.</span>

        <span class="n">k</span><span class="o">.</span><span class="n">createInverseCommandsDict</span><span class="p">()</span>
        <span class="n">k</span><span class="o">.</span><span class="n">makeAllBindings</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inited</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="n">k</span><span class="o">.</span><span class="n">setDefaultInputState</span><span class="p">()</span>
        <span class="n">k</span><span class="o">.</span><span class="n">resetLabel</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20061031131434.81: *5* createInverseCommandsDict</span></div>
<div class="viewcode-block" id="keyHandlerClass.createInverseCommandsDict"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.createInverseCommandsDict">[docs]</a>    <span class="k">def</span> <span class="nf">createInverseCommandsDict</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Add entries to k.inverseCommandsDict using c.commandDict.</span>

<span class="sd">        c.commandsDict:        keys are command names, values are funcions f.</span>
<span class="sd">        k.inverseCommandsDict: keys are f.__name__, values are minibuffer command names.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">commandsDict</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">commandsDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">k</span><span class="o">.</span><span class="n">inverseCommandsDict</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
                <span class="c"># g.trace(&#39;%24s = %s&#39; % (f.__name__,name))</span>

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">name</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">f</span><span class="p">),</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>
    <span class="c">#@+node:ekr.20061101071425: *4* oops</span></div>
<div class="viewcode-block" id="keyHandlerClass.oops"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.oops">[docs]</a>    <span class="k">def</span> <span class="nf">oops</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;Should be defined in subclass:&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20110209093958.15413: *4* setDefaultEditingKeyAction (New)</span></div>
<div class="viewcode-block" id="keyHandlerClass.setDefaultEditingAction"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.setDefaultEditingAction">[docs]</a>    <span class="k">def</span> <span class="nf">setDefaultEditingAction</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>

        <span class="n">action</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getString</span><span class="p">(</span><span class="s">&#39;default_editing_state&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;insert&#39;</span>
        <span class="n">action</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">action</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;command&#39;</span><span class="p">,</span><span class="s">&#39;insert&#39;</span><span class="p">,</span><span class="s">&#39;overwrite&#39;</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;ignoring default_editing_state: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">action</span><span class="p">))</span>
            <span class="n">action</span> <span class="o">=</span> <span class="s">&#39;insert&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">defaultEditingAction</span> <span class="o">=</span> <span class="n">action</span>
    <span class="c">#@+node:ekr.20061031131434.82: *4* setDefaultUnboundKeyAction</span></div>
<div class="viewcode-block" id="keyHandlerClass.setDefaultUnboundKeyAction"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.setDefaultUnboundKeyAction">[docs]</a>    <span class="k">def</span> <span class="nf">setDefaultUnboundKeyAction</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">allowCommandState</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>

        <span class="c"># g.trace(g.callers())</span>

        <span class="n">defaultAction</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getString</span><span class="p">(</span><span class="s">&#39;top_level_unbound_key_action&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;insert&#39;</span>
        <span class="n">defaultAction</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">defaultAction</span> <span class="o">==</span> <span class="s">&#39;command&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">allowCommandState</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unboundKeyAction</span> <span class="o">=</span> <span class="s">&#39;insert&#39;</span>
        <span class="k">elif</span> <span class="n">defaultAction</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;command&#39;</span><span class="p">,</span><span class="s">&#39;insert&#39;</span><span class="p">,</span><span class="s">&#39;overwrite&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unboundKeyAction</span> <span class="o">=</span> <span class="n">defaultAction</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;ignoring top_level_unbound_key_action setting: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">defaultAction</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unboundKeyAction</span> <span class="o">=</span> <span class="s">&#39;insert&#39;</span>

        <span class="c"># g.trace(self.unboundKeyAction)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">defaultUnboundKeyAction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unboundKeyAction</span>

        <span class="n">k</span><span class="o">.</span><span class="n">setInputState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defaultUnboundKeyAction</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20061031131434.88: *3* k.Binding</span>
    <span class="c">#@+node:ekr.20061031131434.89: *4* k.bindKey &amp; helpers</span></div>
<div class="viewcode-block" id="keyHandlerClass.bindKey"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.bindKey">[docs]</a>    <span class="k">def</span> <span class="nf">bindKey</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pane</span><span class="p">,</span><span class="n">shortcut</span><span class="p">,</span><span class="n">callback</span><span class="p">,</span><span class="n">commandName</span><span class="p">,</span><span class="n">modeFlag</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">tag</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Bind the indicated shortcut (a Tk keystroke) to the callback.</span>

<span class="sd">        No actual gui bindings are made: only entries in k.masterBindingsDict.</span>

<span class="sd">        tag gives the source of the binding.</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">check_bind_key</span><span class="p">(</span><span class="n">commandName</span><span class="p">,</span><span class="n">pane</span><span class="p">,</span><span class="n">shortcut</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">aList</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">bindingsDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">shortcut</span><span class="p">,[])</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="c">#  or shortcut == &#39;Ctrl+q&#39;:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%7s</span><span class="s"> </span><span class="si">%20s</span><span class="s"> </span><span class="si">%17s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pane</span><span class="p">,</span><span class="n">shortcut</span><span class="p">,</span><span class="n">tag</span><span class="p">,</span><span class="n">commandName</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">shortcut</span><span class="p">:</span>
                <span class="n">stroke</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">isStroke</span><span class="p">(</span><span class="n">shortcut</span><span class="p">):</span>
                <span class="n">stroke</span> <span class="o">=</span> <span class="n">shortcut</span>
                <span class="k">assert</span> <span class="n">stroke</span><span class="o">.</span><span class="n">s</span><span class="p">,</span><span class="n">stroke</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stroke</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">strokeFromSetting</span><span class="p">(</span><span class="n">shortcut</span><span class="p">)</span>

            <span class="n">si</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">ShortcutInfo</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="n">tag</span><span class="p">,</span><span class="n">pane</span><span class="o">=</span><span class="n">pane</span><span class="p">,</span>
                <span class="n">func</span><span class="o">=</span><span class="n">callback</span><span class="p">,</span><span class="n">commandName</span><span class="o">=</span><span class="n">commandName</span><span class="p">,</span><span class="n">stroke</span><span class="o">=</span><span class="n">stroke</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">shortcut</span><span class="p">:</span> <span class="c">#####</span>
                <span class="n">k</span><span class="o">.</span><span class="n">bindKeyToDict</span><span class="p">(</span><span class="n">pane</span><span class="p">,</span><span class="n">shortcut</span><span class="p">,</span><span class="n">si</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">shortcut</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">modeFlag</span><span class="p">:</span>
                <span class="n">aList</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">remove_conflicting_definitions</span><span class="p">(</span>
                    <span class="n">aList</span><span class="p">,</span><span class="n">commandName</span><span class="p">,</span><span class="n">pane</span><span class="p">,</span><span class="n">shortcut</span><span class="p">)</span>
                <span class="c"># 2013/03/02: a real bug fix.</span>
            <span class="n">aList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">si</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">shortcut</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">stroke</span>
                <span class="n">k</span><span class="o">.</span><span class="n">bindingsDict</span> <span class="p">[</span><span class="n">stroke</span><span class="p">]</span> <span class="o">=</span> <span class="n">aList</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">shortcut</span><span class="p">,</span><span class="n">aList</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span> <span class="c"># Could be a user error.</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">menuWarningsGiven</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;exception binding&#39;</span><span class="p">,</span><span class="n">shortcut</span><span class="p">,</span><span class="s">&#39;to&#39;</span><span class="p">,</span><span class="n">commandName</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es_print_exception</span><span class="p">()</span>
                <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">menuWarningsGiven</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">return</span> <span class="bp">False</span>
</div>
    <span class="n">bindShortcut</span> <span class="o">=</span> <span class="n">bindKey</span> <span class="c"># For compatibility</span>
    <span class="c">#@+node:ekr.20120130074511.10228: *5* k.check_bind_key</span>
<div class="viewcode-block" id="keyHandlerClass.check_bind_key"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.check_bind_key">[docs]</a>    <span class="k">def</span> <span class="nf">check_bind_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">commandName</span><span class="p">,</span><span class="n">pane</span><span class="p">,</span><span class="n">shortcut</span><span class="p">):</span>

         <span class="c">#k = self</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">shortcut</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isStroke</span><span class="p">(</span><span class="n">shortcut</span><span class="p">)</span>

        <span class="c"># Give warning and return if we try to bind to Enter or Leave.</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;enter&#39;</span><span class="p">,</span><span class="s">&#39;leave&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">shortcut</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;ignoring invalid key binding:&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">commandName</span><span class="p">,</span><span class="n">shortcut</span><span class="p">))</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">pane</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;-mode&#39;</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;oops: ignoring mode binding&#39;</span><span class="p">,</span><span class="n">shortcut</span><span class="p">,</span><span class="n">commandName</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
    <span class="c">#@+node:ekr.20120130074511.10227: *5* k.kill_one_shortcut</span></div>
<div class="viewcode-block" id="keyHandlerClass.kill_one_shortcut"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.kill_one_shortcut">[docs]</a>    <span class="k">def</span> <span class="nf">kill_one_shortcut</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">stroke</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Update the dicts so that c.config.getShortcut(name) will return None</span>
<span class="sd">        for all names *presently* bound to the stroke.&#39;&#39;&#39;</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>
        <span class="n">lm</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadManager</span>
        <span class="c"># A crucial shortcut: inverting and uninverting dictionaries is slow.</span>
        <span class="c"># Important: the comparison is valid regardless of the type of stroke.</span>
        <span class="k">if</span> <span class="n">stroke</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="s">&#39;None&#39;</span><span class="p">,</span><span class="s">&#39;none&#39;</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isStroke</span><span class="p">(</span><span class="n">stroke</span><span class="p">),</span><span class="n">stroke</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">shortcutsDict</span>
        <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">TypedDictOfLists</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s">&#39;empty shortcuts dict&#39;</span><span class="p">,</span>
                <span class="n">keyType</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="s">&#39;commandName&#39;</span><span class="p">),</span>
                <span class="n">valType</span><span class="o">=</span><span class="n">g</span><span class="o">.</span><span class="n">ShortcutInfo</span><span class="p">)</span>
        <span class="n">inv_d</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="c"># aList = inv_d.get(stroke,[])</span>
        <span class="n">inv_d</span><span class="p">[</span><span class="n">stroke</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">shortcutsDict</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">uninvert</span><span class="p">(</span><span class="n">inv_d</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20061031131434.92: *5* k.remove_conflicting_definitions</span></div>
<div class="viewcode-block" id="keyHandlerClass.remove_conflicting_definitions"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.remove_conflicting_definitions">[docs]</a>    <span class="k">def</span> <span class="nf">remove_conflicting_definitions</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aList</span><span class="p">,</span><span class="n">commandName</span><span class="p">,</span><span class="n">pane</span><span class="p">,</span><span class="n">shortcut</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isShortcutInfo</span><span class="p">(</span><span class="n">si</span><span class="p">),</span><span class="n">si</span>
            <span class="k">if</span> <span class="n">pane</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;button&#39;</span><span class="p">,</span><span class="s">&#39;all&#39;</span><span class="p">,</span><span class="n">si</span><span class="o">.</span><span class="n">pane</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
                    <span class="c"># This is too annoying to report here. See bug 951921.</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;c for </span><span class="si">%s</span><span class="s"> in </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">si</span><span class="o">.</span><span class="n">stroke</span><span class="p">,</span><span class="n">k</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">()))</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;previous: </span><span class="si">%s</span><span class="s"> new: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">si</span><span class="o">.</span><span class="n">commandName</span><span class="p">,</span><span class="n">commandName</span><span class="p">))</span>
                <span class="n">k</span><span class="o">.</span><span class="n">kill_one_shortcut</span><span class="p">(</span><span class="n">shortcut</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">si</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="c">#@+node:ekr.20061031131434.93: *5* k.bindKeyToDict</span></div>
<div class="viewcode-block" id="keyHandlerClass.bindKeyToDict"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.bindKeyToDict">[docs]</a>    <span class="k">def</span> <span class="nf">bindKeyToDict</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pane</span><span class="p">,</span><span class="n">stroke</span><span class="p">,</span><span class="n">si</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Update k.masterBindingsDict for the stroke.&#39;&#39;&#39;</span>

        <span class="c"># New in Leo 4.4.1: Allow redefintions.</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isStroke</span><span class="p">(</span><span class="n">stroke</span><span class="p">),</span><span class="n">stroke</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">masterBindingsDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pane</span><span class="p">,{})</span>
        <span class="n">d</span><span class="p">[</span><span class="n">stroke</span><span class="p">]</span> <span class="o">=</span> <span class="n">si</span>
        <span class="n">k</span><span class="o">.</span><span class="n">masterBindingsDict</span> <span class="p">[</span><span class="n">pane</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
    <span class="c">#@+node:ekr.20061031131434.94: *5* k.bindOpenWith</span></div>
<div class="viewcode-block" id="keyHandlerClass.bindOpenWith"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.bindOpenWith">[docs]</a>    <span class="k">def</span> <span class="nf">bindOpenWith</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">d</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Register an open-with command.&#39;&#39;&#39;</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>

        <span class="n">shortcut</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;shortcut&#39;</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span>

        <span class="c"># g.trace(d)</span>

        <span class="c"># The first parameter must be event, and it must default to None.</span>
        <span class="k">def</span> <span class="nf">openWithCallback</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="o">=</span><span class="n">d</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">openWith</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>

        <span class="c"># Use k.registerCommand to set the shortcuts in the various binding dicts.</span>
        <span class="n">commandName</span> <span class="o">=</span> <span class="s">&#39;open-with-</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">k</span><span class="o">.</span><span class="n">registerCommand</span><span class="p">(</span><span class="n">commandName</span><span class="p">,</span><span class="n">shortcut</span><span class="p">,</span><span class="n">openWithCallback</span><span class="p">,</span><span class="n">pane</span><span class="o">=</span><span class="s">&#39;all&#39;</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20061031131434.95: *4* k.checkBindings</span></div>
<div class="viewcode-block" id="keyHandlerClass.checkBindings"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.checkBindings">[docs]</a>    <span class="k">def</span> <span class="nf">checkBindings</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Print warnings if commands do not have any @shortcut entry.</span>
<span class="sd">        The entry may be `None`, of course.&#39;&#39;&#39;</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getBool</span><span class="p">(</span><span class="s">&#39;warn_about_missing_settings&#39;</span><span class="p">):</span> <span class="k">return</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">commandsDict</span><span class="p">):</span>
            <span class="n">abbrev</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">abbreviationsDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">canonicalizeMenuName</span><span class="p">(</span><span class="n">abbrev</span> <span class="ow">or</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&amp;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="s">&#39;shortcut&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">abbrev</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;No shortcut for abbrev </span><span class="si">%s</span><span class="s"> -&gt; </span><span class="si">%s</span><span class="s"> = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">name</span><span class="p">,</span><span class="n">abbrev</span><span class="p">,</span><span class="n">key</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;No shortcut for </span><span class="si">%s</span><span class="s"> = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">key</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20061031131434.97: *4* k.completeAllBindings</span></div>
<div class="viewcode-block" id="keyHandlerClass.completeAllBindings"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.completeAllBindings">[docs]</a>    <span class="k">def</span> <span class="nf">completeAllBindings</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">w</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;New in 4.4b3: make an actual binding in *all* the standard places.</span>

<span class="sd">        The event will go to k.masterKeyHandler as always, so nothing really changes.</span>
<span class="sd">        except that k.masterKeyHandler will know the proper stroke.&#39;&#39;&#39;</span>

        <span class="c"># g.trace(w)</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">for</span> <span class="n">stroke</span> <span class="ow">in</span> <span class="n">k</span><span class="o">.</span><span class="n">bindingsDict</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isStroke</span><span class="p">(</span><span class="n">stroke</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">stroke</span><span class="p">)</span>
            <span class="n">k</span><span class="o">.</span><span class="n">makeMasterGuiBinding</span><span class="p">(</span><span class="n">stroke</span><span class="p">,</span><span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20061031131434.96: *4* k.completeAllBindingsForWidget</span></div>
<div class="viewcode-block" id="keyHandlerClass.completeAllBindingsForWidget"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.completeAllBindingsForWidget">[docs]</a>    <span class="k">def</span> <span class="nf">completeAllBindingsForWidget</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">w</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># g.trace(&#39;w&#39;,w,&#39;Alt+Key-4&#39; in d)</span>

        <span class="k">for</span> <span class="n">stroke</span> <span class="ow">in</span> <span class="n">k</span><span class="o">.</span><span class="n">bindingsDict</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isStroke</span><span class="p">(</span><span class="n">stroke</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">stroke</span><span class="p">)</span>
            <span class="n">k</span><span class="o">.</span><span class="n">makeMasterGuiBinding</span><span class="p">(</span><span class="n">stroke</span><span class="p">,</span><span class="n">w</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20070218130238: *4* k.dumpMasterBindingsDict</span></div>
<div class="viewcode-block" id="keyHandlerClass.dumpMasterBindingsDict"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.dumpMasterBindingsDict">[docs]</a>    <span class="k">def</span> <span class="nf">dumpMasterBindingsDict</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">d</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">masterBindingsDict</span>

        <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">k.masterBindingsDict...</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
            <span class="n">d2</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key2</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">d2</span><span class="p">):</span>
                <span class="n">si</span> <span class="o">=</span> <span class="n">d2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key2</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isShortcutInfo</span><span class="p">(</span><span class="n">si</span><span class="p">),</span><span class="n">si</span>
                <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%20s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key2</span><span class="p">,</span><span class="n">si</span><span class="o">.</span><span class="n">commandName</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20061031131434.99: *4* k.initAbbrev</span></div>
<div class="viewcode-block" id="keyHandlerClass.initAbbrev"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.initAbbrev">[docs]</a>    <span class="k">def</span> <span class="nf">initAbbrev</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">d</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getAbbrevDict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">d</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                <span class="n">commandName</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">commandName</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;press-&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">commandName</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;-button&#39;</span><span class="p">):</span>
                    <span class="k">pass</span> <span class="c"># Must be done later in k.registerCommand.</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">initOneAbbrev</span><span class="p">(</span><span class="n">commandName</span><span class="p">,</span><span class="n">key</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="keyHandlerClass.initOneAbbrev"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.initOneAbbrev">[docs]</a>    <span class="k">def</span> <span class="nf">initOneAbbrev</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">commandName</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">commandsDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;ignoring duplicate abbrev: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span><span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">commandsDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">commandName</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">func</span><span class="p">:</span>
                <span class="c"># g.trace(key,commandName,func.__name__)</span>
                <span class="n">c</span><span class="o">.</span><span class="n">commandsDict</span> <span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
                <span class="c"># k.inverseCommandsDict[func.__name__] = key</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;bad abbrev:&#39;</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="s">&#39;unknown command name:&#39;</span><span class="p">,</span><span class="n">commandName</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20061031131434.101: *4* k.initSpecialIvars</span></div>
<div class="viewcode-block" id="keyHandlerClass.initSpecialIvars"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.initSpecialIvars">[docs]</a>    <span class="k">def</span> <span class="nf">initSpecialIvars</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Set ivars for special keystrokes from previously-existing bindings.&#39;&#39;&#39;</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getBool</span><span class="p">(</span><span class="s">&#39;trace_bindings_verbose&#39;</span><span class="p">)</span>
        <span class="n">warn</span>  <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getBool</span><span class="p">(</span><span class="s">&#39;warn_about_missing_settings&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ivar</span><span class="p">,</span><span class="n">commandName</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="p">(</span><span class="s">&#39;fullCommandKey&#39;</span><span class="p">,</span>  <span class="s">&#39;full-command&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;abortAllModesKey&#39;</span><span class="p">,</span><span class="s">&#39;keyboard-quit&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;universalArgKey&#39;</span><span class="p">,</span> <span class="s">&#39;universal-argument&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;autoCompleteForceKey&#39;</span><span class="p">,</span><span class="s">&#39;auto-complete-force&#39;</span><span class="p">),</span>
        <span class="p">):</span>
            <span class="n">junk</span><span class="p">,</span> <span class="n">aList</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getShortcut</span><span class="p">(</span><span class="n">commandName</span><span class="p">)</span>
            <span class="n">aList</span><span class="p">,</span><span class="n">found</span> <span class="o">=</span> <span class="n">aList</span> <span class="ow">or</span> <span class="p">[],</span> <span class="bp">False</span>
            <span class="k">for</span> <span class="n">pane</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;text&#39;</span><span class="p">,</span><span class="s">&#39;all&#39;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isShortcutInfo</span><span class="p">(</span><span class="n">si</span><span class="p">),</span><span class="n">si</span>
                    <span class="k">if</span> <span class="n">si</span><span class="o">.</span><span class="n">pane</span> <span class="o">==</span> <span class="n">pane</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">commandName</span><span class="p">,</span><span class="n">si</span><span class="o">.</span><span class="n">stroke</span><span class="p">)</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">ivar</span><span class="p">,</span><span class="n">si</span><span class="o">.</span><span class="n">stroke</span><span class="p">)</span>
                        <span class="n">found</span> <span class="o">=</span> <span class="bp">True</span><span class="p">;</span> <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span> <span class="ow">and</span> <span class="n">warn</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;no setting for </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">commandName</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20061031131434.98: *4* k.makeAllBindings</span></div>
<div class="viewcode-block" id="keyHandlerClass.makeAllBindings"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.makeAllBindings">[docs]</a>    <span class="k">def</span> <span class="nf">makeAllBindings</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>

        <span class="c"># g.trace(c.shortFileName())</span>

        <span class="n">k</span><span class="o">.</span><span class="n">bindingsDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">new_modes</span><span class="p">:</span>
            <span class="n">k</span><span class="o">.</span><span class="n">modeController</span><span class="o">.</span><span class="n">addModeCommands</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">k</span><span class="o">.</span><span class="n">addModeCommands</span><span class="p">()</span> 
        <span class="n">k</span><span class="o">.</span><span class="n">makeBindingsFromCommandsDict</span><span class="p">()</span>
        <span class="n">k</span><span class="o">.</span><span class="n">initSpecialIvars</span><span class="p">()</span>
        <span class="n">k</span><span class="o">.</span><span class="n">initAbbrev</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">createBindings</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">setTabBindings</span><span class="p">(</span><span class="s">&#39;Log&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">statusLine</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">statusLine</span><span class="o">.</span><span class="n">setBindings</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">setBindings</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">setMinibufferBindings</span><span class="p">()</span>
        <span class="n">k</span><span class="o">.</span><span class="n">completeAllBindings</span><span class="p">()</span>
        <span class="n">k</span><span class="o">.</span><span class="n">checkBindings</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20061031131434.102: *4* k.makeBindingsFromCommandsDict &amp; helper</span></div>
<div class="viewcode-block" id="keyHandlerClass.makeBindingsFromCommandsDict"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.makeBindingsFromCommandsDict">[docs]</a>    <span class="k">def</span> <span class="nf">makeBindingsFromCommandsDict</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Add bindings for all entries in c.commandDict.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;makeBindingsFromCommandsDict entry&#39;</span><span class="p">)</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c"># Step 1: Create d2.</span>
        <span class="c"># Keys are strokes. Values are lists of si with si.stroke == stroke.</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">commandsDict</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">TypedDictOfLists</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s">&#39;makeBindingsFromCommandsDict helper dict&#39;</span><span class="p">,</span>
            <span class="n">keyType</span><span class="o">=</span><span class="n">g</span><span class="o">.</span><span class="n">KeyStroke</span><span class="p">,</span><span class="n">valType</span><span class="o">=</span><span class="n">g</span><span class="o">.</span><span class="n">ShortcutInfo</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">commandName</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">command</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">commandName</span><span class="p">)</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">aList</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getShortcut</span><span class="p">(</span><span class="n">commandName</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">si</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">ShortcutInfo</span><span class="p">)</span>
                <span class="c"># Important: si.stroke is already canonicalized.</span>
                <span class="n">stroke</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">stroke</span>
                <span class="n">si</span><span class="o">.</span><span class="n">commandName</span> <span class="o">=</span> <span class="n">commandName</span>
                <span class="k">if</span> <span class="n">stroke</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isStroke</span><span class="p">(</span><span class="n">stroke</span><span class="p">)</span>
                    <span class="n">d2</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">stroke</span><span class="p">,</span><span class="n">si</span><span class="p">)</span>

        <span class="c"># Step 2: make the bindings.</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">stroke</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">d2</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">aList2</span> <span class="o">=</span> <span class="n">d2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stroke</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="n">aList2</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">si</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">ShortcutInfo</span><span class="p">)</span>
                <span class="n">commandName</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">commandName</span>
                <span class="n">command</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">commandsDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">commandName</span><span class="p">)</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">kind</span>
                <span class="n">pane</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">pane</span>
                <span class="k">if</span> <span class="n">stroke</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pane</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;-mode&#39;</span><span class="p">):</span>
                    <span class="n">k</span><span class="o">.</span><span class="n">bindKey</span><span class="p">(</span><span class="n">pane</span><span class="p">,</span><span class="n">stroke</span><span class="p">,</span><span class="n">command</span><span class="p">,</span><span class="n">commandName</span><span class="p">,</span><span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
            <span class="n">t3</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%0.2f</span><span class="s">sec&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">))</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%0.2f</span><span class="s">sec&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t3</span><span class="o">-</span><span class="n">t2</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20061031131434.103: *4* k.makeMasterGuiBinding</span></div>
<div class="viewcode-block" id="keyHandlerClass.makeMasterGuiBinding"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.makeMasterGuiBinding">[docs]</a>    <span class="k">def</span> <span class="nf">makeMasterGuiBinding</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">stroke</span><span class="p">,</span><span class="n">w</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Make a master gui binding for stroke in pane w, or in all the standard widgets.&#39;&#39;&#39;</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span>

        <span class="k">if</span> <span class="n">w</span><span class="p">:</span>
            <span class="n">widgets</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># New in Leo 4.5: we *must* make the binding in the binding widget.</span>
            <span class="n">bindingWidget</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">tree</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">tree</span><span class="p">,</span><span class="s">&#39;bindingWidget&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">bindingWidget</span> <span class="ow">or</span> <span class="bp">None</span>
            <span class="n">bodyCtrl</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">body</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">body</span><span class="p">,</span><span class="s">&#39;bodyCtrl&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">bodyCtrl</span> <span class="ow">or</span> <span class="bp">None</span>
            <span class="n">canvas</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">tree</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">tree</span><span class="p">,</span><span class="s">&#39;canvas&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">canvas</span>   <span class="ow">or</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># Canvas and bindingWidget bindings are now set in tree.setBindings.</span>
                <span class="n">widgets</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">miniBufferWidget</span><span class="p">,</span><span class="n">bodyCtrl</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">widgets</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">miniBufferWidget</span><span class="p">,</span><span class="n">bodyCtrl</span><span class="p">,</span><span class="n">canvas</span><span class="p">,</span><span class="n">bindingWidget</span><span class="p">)</span>

        <span class="c"># This is the only real key callback.</span>
        <span class="k">def</span> <span class="nf">masterBindKeyCallback</span> <span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="n">stroke</span><span class="o">=</span><span class="n">stroke</span><span class="p">):</span>
            <span class="c"># g.trace(stroke,event.w)</span>
            <span class="k">return</span> <span class="n">k</span><span class="o">.</span><span class="n">masterKeyHandler</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="c"># ,stroke=stroke)</span>

        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">widgets</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">w</span><span class="p">:</span> <span class="k">continue</span>
            <span class="c"># Make the binding only if no binding for the stroke exists in the widget.</span>
            <span class="n">aList</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">masterGuiBindingsDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stroke</span><span class="p">,[])</span>
            <span class="k">if</span> <span class="n">w</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
                <span class="n">aList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
                <span class="n">k</span><span class="o">.</span><span class="n">masterGuiBindingsDict</span> <span class="p">[</span><span class="n">stroke</span><span class="p">]</span> <span class="o">=</span> <span class="n">aList</span>
    <span class="c">#@+node:ekr.20061031131434.104: *3* k.Dispatching</span>
    <span class="c">#@+node:ekr.20061031131434.111: *4* fullCommand (alt-x) &amp; helper</span></div>
<div class="viewcode-block" id="keyHandlerClass.fullCommand"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.fullCommand">[docs]</a>    <span class="k">def</span> <span class="nf">fullCommand</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">,</span><span class="n">specialStroke</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">specialFunc</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">help</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">helpHandler</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Handle &#39;full-command&#39; (alt-x) mode.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>
        <span class="n">recording</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">macroCommands</span><span class="o">.</span><span class="n">recordingMacro</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="s">&#39;full-command&#39;</span><span class="p">)</span>
        <span class="n">helpPrompt</span> <span class="o">=</span> <span class="s">&#39;Help for command: &#39;</span>
        <span class="n">c</span><span class="o">.</span><span class="n">check_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="n">char</span> <span class="o">=</span> <span class="n">event</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">char</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
        <span class="n">stroke</span> <span class="o">=</span> <span class="n">event</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">stroke</span> <span class="ow">or</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;recording&#39;</span><span class="p">,</span><span class="n">recording</span><span class="p">,</span><span class="s">&#39;state&#39;</span><span class="p">,</span><span class="n">state</span><span class="p">,</span><span class="n">char</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">recording</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">macroCommands</span><span class="o">.</span><span class="n">startRecordingMacro</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">k</span><span class="o">.</span><span class="n">setLossage</span><span class="p">(</span><span class="n">char</span><span class="p">,</span><span class="n">stroke</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">k</span><span class="o">.</span><span class="n">mb_event</span> <span class="o">=</span> <span class="n">event</span> <span class="c"># Save the full event for later.</span>
            <span class="n">k</span><span class="o">.</span><span class="n">setState</span><span class="p">(</span><span class="s">&#39;full-command&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">handler</span><span class="o">=</span><span class="n">k</span><span class="o">.</span><span class="n">fullCommand</span><span class="p">)</span>
            <span class="n">prompt</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">help</span><span class="p">,</span><span class="n">helpPrompt</span><span class="p">,</span><span class="n">k</span><span class="o">.</span><span class="n">altX_prompt</span><span class="p">)</span>
            <span class="n">k</span><span class="o">.</span><span class="n">setLabelBlue</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prompt</span><span class="p">),</span><span class="n">protect</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="c"># Init mb_ ivars. This prevents problems with an initial backspace.</span>
            <span class="n">k</span><span class="o">.</span><span class="n">mb_prompt</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">mb_tabListPrefix</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">mb_prefix</span> <span class="o">=</span> <span class="n">prompt</span>
            <span class="n">k</span><span class="o">.</span><span class="n">mb_tabList</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">;</span> <span class="n">k</span><span class="o">.</span><span class="n">mb_tabListIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">k</span><span class="o">.</span><span class="n">mb_help</span> <span class="o">=</span> <span class="n">help</span>
            <span class="n">k</span><span class="o">.</span><span class="n">mb_helpHandler</span> <span class="o">=</span> <span class="n">helpHandler</span>
            <span class="n">c</span><span class="o">.</span><span class="n">minibufferWantsFocus</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;Ins&#39;</span> <span class="ow">or</span> <span class="n">k</span><span class="o">.</span><span class="n">isFKey</span><span class="p">(</span><span class="n">char</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;Escape&#39;</span><span class="p">:</span>
            <span class="n">k</span><span class="o">.</span><span class="n">keyboardQuit</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">char</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;Return&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;***Return&#39;</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">deleteTab</span><span class="p">(</span><span class="s">&#39;Completion&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">mb_help</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">getLabel</span><span class="p">()</span>
                <span class="n">commandName</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">helpPrompt</span><span class="p">):]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">k</span><span class="o">.</span><span class="n">clearState</span><span class="p">()</span>
                <span class="n">k</span><span class="o">.</span><span class="n">resetLabel</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">mb_helpHandler</span><span class="p">:</span> <span class="n">k</span><span class="o">.</span><span class="n">mb_helpHandler</span><span class="p">(</span><span class="n">commandName</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">k</span><span class="o">.</span><span class="n">callAltXFunction</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">mb_event</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">char</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;Tab&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;***Tab&#39;</span><span class="p">)</span>
            <span class="n">k</span><span class="o">.</span><span class="n">doTabCompletion</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">commandsDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span><span class="n">allow_empty_completion</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">minibufferWantsFocus</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">char</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;</span><span class="se">\b</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;BackSpace&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;***BackSpace&#39;</span><span class="p">)</span>
            <span class="n">k</span><span class="o">.</span><span class="n">doBackSpace</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">commandsDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="n">c</span><span class="o">.</span><span class="n">minibufferWantsFocus</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">k</span><span class="o">.</span><span class="n">ignore_unbound_non_ascii_keys</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c"># g.trace(&#39;non-ascii&#39;)</span>
            <span class="k">if</span> <span class="n">specialStroke</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">specialStroke</span><span class="p">)</span>
                <span class="n">specialFunc</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">minibufferWantsFocus</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Clear the list, any other character besides tab indicates that a new prefix is in effect.</span>
            <span class="n">k</span><span class="o">.</span><span class="n">mb_tabList</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">k</span><span class="o">.</span><span class="n">updateLabel</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="n">k</span><span class="o">.</span><span class="n">mb_tabListPrefix</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">getLabel</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">minibufferWantsFocus</span><span class="p">()</span>
            <span class="c"># g.trace(&#39;new prefix&#39;,k.mb_tabListPrefix)</span>
    <span class="c">#@+node:ekr.20061031131434.112: *5* callAltXFunction</span></div>
<div class="viewcode-block" id="keyHandlerClass.callAltXFunction"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.callAltXFunction">[docs]</a>    <span class="k">def</span> <span class="nf">callAltXFunction</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">s</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">getLabel</span><span class="p">()</span>
        <span class="n">k</span><span class="o">.</span><span class="n">mb_tabList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">commandName</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">mb_prefix</span><span class="p">):]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">commandsDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">commandName</span><span class="p">)</span>
        <span class="n">k</span><span class="o">.</span><span class="n">newMinibufferWidget</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># g.trace(func and func.__name__,&#39;mb_event&#39;,event and event.widget.widgetName)</span>
        <span class="k">if</span> <span class="n">func</span><span class="p">:</span>
            <span class="c"># These must be done *after* getting the command.</span>
            <span class="n">k</span><span class="o">.</span><span class="n">clearState</span><span class="p">()</span>
            <span class="n">k</span><span class="o">.</span><span class="n">resetLabel</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">commandName</span> <span class="o">!=</span> <span class="s">&#39;repeat-complex-command&#39;</span><span class="p">:</span>
                <span class="n">k</span><span class="o">.</span><span class="n">mb_history</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">commandName</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">event</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">widget</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="s">&#39;permanent&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">w</span><span class="o">.</span><span class="n">permanent</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;Can not execute commands from headlines&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">widgetWantsFocusNow</span><span class="p">(</span><span class="n">event</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">widget</span><span class="p">)</span> <span class="c"># Important, so cut-text works, e.g.</span>
                <span class="n">func</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="n">k</span><span class="o">.</span><span class="n">endCommand</span><span class="p">(</span><span class="n">commandName</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">1</span><span class="p">:</span> <span class="c"># Useful.</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;*** tab completion&#39;</span><span class="p">)</span>
                <span class="n">k</span><span class="o">.</span><span class="n">doTabCompletion</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">commandsDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="k">else</span><span class="p">:</span> <span class="c"># Annoying.</span>
                <span class="n">k</span><span class="o">.</span><span class="n">keyboardQuit</span><span class="p">()</span>
                <span class="n">k</span><span class="o">.</span><span class="n">setLabel</span><span class="p">(</span><span class="s">&#39;Command does not exist: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">commandName</span><span class="p">)</span>
                <span class="n">c</span><span class="o">.</span><span class="n">bodyWantsFocus</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20061031131434.113: *4* k.endCommand</span></div>
<div class="viewcode-block" id="keyHandlerClass.endCommand"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.endCommand">[docs]</a>    <span class="k">def</span> <span class="nf">endCommand</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">commandName</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Make sure Leo updates the widget following a command.</span>

<span class="sd">        Never changes the minibuffer label: individual commands must do that.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>
        <span class="c"># The command may have closed the window.</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">quitting</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span> <span class="k">return</span>

        <span class="c"># Set the best possible undoType: prefer explicit commandName to k.commandName.</span>
        <span class="n">commandName</span> <span class="o">=</span> <span class="n">commandName</span> <span class="ow">or</span> <span class="n">k</span><span class="o">.</span><span class="n">commandName</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
        <span class="n">k</span><span class="o">.</span><span class="n">commandName</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">commandName</span> <span class="ow">or</span> <span class="n">commandName</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">commandName</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">inState</span><span class="p">():</span>
                <span class="n">k</span><span class="o">.</span><span class="n">commandName</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">c</span><span class="o">.</span><span class="n">editCommandsManager</span><span class="o">.</span><span class="n">initAllEditCommanders</span><span class="p">()</span>
            <span class="k">if</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># Do *not* call this by default.  It interferes with undo.</span>
                <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">onBodyChanged</span><span class="p">(</span><span class="n">undoType</span><span class="o">=</span><span class="s">&#39;Typing&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">newMinibufferWidget</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">widgetWantsFocusNow</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">newMinibufferWidget</span><span class="p">)</span>
                <span class="c"># g.pr(&#39;endCommand&#39;, g.app.gui.widget_name(k.newMinibufferWidget),g.callers())</span>
                <span class="n">k</span><span class="o">.</span><span class="n">newMinibufferWidget</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20061031131434.114: *3* k.Externally visible commands</span>
    <span class="c">#@+node:ekr.20061031131434.115: *4* digitArgument &amp; universalArgument</span></div>
<div class="viewcode-block" id="keyHandlerClass.universalArgument"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.universalArgument">[docs]</a>    <span class="k">def</span> <span class="nf">universalArgument</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Prompt for a universal argument.&#39;&#39;&#39;</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">k</span><span class="o">.</span><span class="n">setLabelBlue</span><span class="p">(</span><span class="s">&#39;Universal Argument: &#39;</span><span class="p">,</span><span class="n">protect</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">k</span><span class="o">.</span><span class="n">universalDispatcher</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="keyHandlerClass.digitArgument"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.digitArgument">[docs]</a>    <span class="k">def</span> <span class="nf">digitArgument</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Prompt for a digit argument.&#39;&#39;&#39;</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">k</span><span class="o">.</span><span class="n">setLabelBlue</span><span class="p">(</span><span class="s">&#39;Digit Argument: &#39;</span><span class="p">,</span><span class="n">protect</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">k</span><span class="o">.</span><span class="n">universalDispatcher</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20070613133500: *4* k.menuCommandKey</span></div>
<div class="viewcode-block" id="keyHandlerClass.menuCommandKey"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.menuCommandKey">[docs]</a>    <span class="k">def</span> <span class="nf">menuCommandKey</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="c"># This method must exist, but it never gets called.</span>
        <span class="k">pass</span> 
    <span class="c">#@+node:ekr.20061031131434.117: *4* negativeArgument (redo?)</span></div>
<div class="viewcode-block" id="keyHandlerClass.negativeArgument"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.negativeArgument">[docs]</a>    <span class="k">def</span> <span class="nf">negativeArgument</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Prompt for a negative digit argument.&#39;&#39;&#39;</span>

        <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;not ready yet&#39;</span><span class="p">)</span>

        <span class="c"># k = self ; state = k.getState(&#39;neg-arg&#39;)</span>

        <span class="c"># if state == 0:</span>
            <span class="c"># k.setLabelBlue(&#39;Negative Argument: &#39;,protect=True)</span>
            <span class="c"># k.setState(&#39;neg-arg&#39;,1,k.negativeArgument)</span>
        <span class="c"># else:</span>
            <span class="c"># k.clearState()</span>
            <span class="c"># k.resetLabel()</span>
            <span class="c"># func = k.negArgFunctions.get(k.stroke)</span>
            <span class="c"># if func:</span>
                <span class="c"># func(event)</span>
    <span class="c">#@+node:ekr.20061031131434.118: *4* numberCommand</span></div>
<div class="viewcode-block" id="keyHandlerClass.numberCommand"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.numberCommand">[docs]</a>    <span class="k">def</span> <span class="nf">numberCommand</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">,</span><span class="n">stroke</span><span class="p">,</span><span class="n">number</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Enter a number prefix for commands.&#39;&#39;&#39;</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="n">k</span><span class="o">.</span><span class="n">stroke</span> <span class="o">=</span> <span class="n">stroke</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">event</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">widget</span>
        <span class="n">k</span><span class="o">.</span><span class="n">universalDispatcher</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">event_generate</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="nb">chr</span><span class="p">(</span><span class="n">number</span><span class="p">),</span><span class="nb">chr</span><span class="p">(</span><span class="n">number</span><span class="p">),</span><span class="n">w</span><span class="p">)</span>
        <span class="k">return</span>
</div>
<div class="viewcode-block" id="keyHandlerClass.numberCommand0"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.numberCommand0">[docs]</a>    <span class="k">def</span> <span class="nf">numberCommand0</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Execute command number 0.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberCommand</span> <span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="keyHandlerClass.numberCommand1"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.numberCommand1">[docs]</a>    <span class="k">def</span> <span class="nf">numberCommand1</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Execute command number 1.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberCommand</span> <span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="keyHandlerClass.numberCommand2"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.numberCommand2">[docs]</a>    <span class="k">def</span> <span class="nf">numberCommand2</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Execute command number 2.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberCommand</span> <span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="keyHandlerClass.numberCommand3"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.numberCommand3">[docs]</a>    <span class="k">def</span> <span class="nf">numberCommand3</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Execute command number 3.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberCommand</span> <span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="keyHandlerClass.numberCommand4"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.numberCommand4">[docs]</a>    <span class="k">def</span> <span class="nf">numberCommand4</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Execute command number 4.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberCommand</span> <span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="keyHandlerClass.numberCommand5"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.numberCommand5">[docs]</a>    <span class="k">def</span> <span class="nf">numberCommand5</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Execute command number 5.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberCommand</span> <span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="keyHandlerClass.numberCommand6"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.numberCommand6">[docs]</a>    <span class="k">def</span> <span class="nf">numberCommand6</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Execute command number 6.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberCommand</span> <span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="keyHandlerClass.numberCommand7"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.numberCommand7">[docs]</a>    <span class="k">def</span> <span class="nf">numberCommand7</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Execute command number 7.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberCommand</span> <span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="keyHandlerClass.numberCommand8"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.numberCommand8">[docs]</a>    <span class="k">def</span> <span class="nf">numberCommand8</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Execute command number 8.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberCommand</span> <span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="keyHandlerClass.numberCommand9"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.numberCommand9">[docs]</a>    <span class="k">def</span> <span class="nf">numberCommand9</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Execute command number 9.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">numberCommand</span> <span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20061031131434.119: *4* k.printBindings &amp; helper</span></div>
<div class="viewcode-block" id="keyHandlerClass.printBindings"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.printBindings">[docs]</a>    <span class="k">def</span> <span class="nf">printBindings</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Print all the bindings presently in effect.&#39;&#39;&#39;</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">bindingsDict</span> <span class="p">;</span> <span class="n">tabName</span> <span class="o">=</span> <span class="s">&#39;Bindings&#39;</span>
        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">clearTab</span><span class="p">(</span><span class="n">tabName</span><span class="p">)</span>
        <span class="n">legend</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s">    legend:</span>
<span class="s">    [ ] leoSettings.leo</span>
<span class="s">    [D] default binding</span>
<span class="s">    [F] loaded .leo File</span>
<span class="s">    [M] myLeoSettings.leo</span>
<span class="s">    [@] mode</span>

<span class="s">    &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">d</span><span class="p">:</span> <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;no bindings&#39;</span><span class="p">)</span>
        <span class="n">legend</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">adjustTripleString</span><span class="p">(</span><span class="n">legend</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">tab_width</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">stroke</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isStroke</span><span class="p">(</span><span class="n">stroke</span><span class="p">),</span><span class="n">stroke</span>
            <span class="n">aList</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stroke</span><span class="p">,[])</span>
            <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isShortcutInfo</span><span class="p">(</span><span class="n">si</span><span class="p">),</span><span class="n">si</span>
                <span class="n">s1</span> <span class="o">=</span> <span class="s">&#39;&#39;</span> <span class="k">if</span> <span class="n">si</span><span class="o">.</span><span class="n">pane</span><span class="o">==</span><span class="s">&#39;all&#39;</span> <span class="k">else</span> <span class="n">si</span><span class="o">.</span><span class="n">pane</span>
                <span class="n">s2</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">prettyPrintKey</span><span class="p">(</span><span class="n">stroke</span><span class="p">)</span>
                <span class="n">s3</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">commandName</span>
                <span class="n">s4</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">kind</span> <span class="ow">or</span> <span class="s">&#39;&lt;no hash&gt;&#39;</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">,</span><span class="n">s3</span><span class="p">,</span><span class="n">s4</span><span class="p">),)</span>

        <span class="c"># Print keys by type:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">+</span><span class="n">legend</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s">&#39;Alt+Ctrl+Shift&#39;</span><span class="p">,</span><span class="s">&#39;Alt+Ctrl&#39;</span><span class="p">,</span><span class="s">&#39;Alt+Shift&#39;</span><span class="p">,</span><span class="s">&#39;Alt&#39;</span><span class="p">,</span> <span class="c"># &#39;Alt+Key&#39;: done by Alt.</span>
            <span class="s">&#39;Ctrl+Meta+Shift&#39;</span><span class="p">,</span><span class="s">&#39;Ctrl+Meta&#39;</span><span class="p">,</span><span class="s">&#39;Ctrl+Shift&#39;</span><span class="p">,</span><span class="s">&#39;Ctrl&#39;</span><span class="p">,</span> <span class="c"># Ctrl+Key: done by Ctrl.</span>
            <span class="s">&#39;Meta+Key&#39;</span><span class="p">,</span><span class="s">&#39;Meta+Shift&#39;</span><span class="p">,</span><span class="s">&#39;Meta&#39;</span><span class="p">,</span>
            <span class="s">&#39;Shift&#39;</span><span class="p">,</span>
            <span class="c"># Careful: longer prefixes must come before shorter prefixes.</span>
        <span class="p">):</span>
            <span class="n">data2</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">,</span><span class="n">s3</span><span class="p">,</span><span class="n">s4</span> <span class="o">=</span> <span class="n">item</span>
                <span class="k">if</span> <span class="n">s2</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
                    <span class="n">data2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;***** </span><span class="si">%s</span><span class="s">...</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">prefix</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">printBindingsHelper</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">data2</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>
            <span class="c"># Remove all the items in data2 from data.</span>
            <span class="c"># This must be done outside the iterator on data.</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data2</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="c"># Print all plain bindings.</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;***** Plain Keys...</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">printBindingsHelper</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">),</span><span class="n">tabName</span><span class="o">=</span><span class="n">tabName</span><span class="p">)</span>
        <span class="n">k</span><span class="o">.</span><span class="n">showStateAndMode</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span> <span class="c"># for unit test.</span>
    <span class="c">#@+node:ekr.20061031131434.120: *5* printBindingsHelper</span></div>
<div class="viewcode-block" id="keyHandlerClass.printBindingsHelper"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.printBindingsHelper">[docs]</a>    <span class="k">def</span> <span class="nf">printBindingsHelper</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">prefix</span><span class="p">):</span>

        <span class="n">lm</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadManager</span>

        <span class="n">data</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">data2</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="p">[],</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">pane</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">commandName</span><span class="p">,</span><span class="n">kind</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;+Key&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="c"># g.trace(key,kind)</span>
            <span class="n">letter</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">computeBindingLetter</span><span class="p">(</span><span class="n">kind</span><span class="p">)</span>
            <span class="n">pane</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pane</span><span class="p">)</span> <span class="k">if</span> <span class="n">pane</span> <span class="k">else</span> <span class="s">&#39;&#39;</span>
            <span class="n">left</span> <span class="o">=</span> <span class="n">pane</span><span class="o">+</span><span class="n">key</span> <span class="c"># pane and shortcut fields</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">left</span><span class="p">))</span>
            <span class="n">data2</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">letter</span><span class="p">,</span><span class="n">left</span><span class="p">,</span><span class="n">commandName</span><span class="p">),)</span>

        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">data2</span><span class="p">:</span>
            <span class="n">letter</span><span class="p">,</span><span class="n">left</span><span class="p">,</span><span class="n">commandName</span> <span class="o">=</span> <span class="n">z</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%*s</span><span class="s"> </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">letter</span><span class="p">,</span><span class="o">-</span><span class="n">n</span><span class="p">,</span><span class="n">left</span><span class="p">,</span><span class="n">commandName</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20120520174745.9867: *4* k.printButtons</span></div>
<div class="viewcode-block" id="keyHandlerClass.printButtons"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.printButtons">[docs]</a>    <span class="k">def</span> <span class="nf">printButtons</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Print all @button and @command commands, their bindings and their source.&#39;&#39;&#39;</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>
        <span class="n">tabName</span> <span class="o">=</span> <span class="s">&#39;@buttons &amp;&amp; @commands&#39;</span>
        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">clearTab</span><span class="p">(</span><span class="n">tabName</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">tabName</span><span class="o">=</span><span class="n">tabName</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">aList</span> <span class="ow">in</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getButtons</span><span class="p">(),</span><span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getCommands</span><span class="p">()]:</span>
            <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
                <span class="n">p</span><span class="p">,</span><span class="n">script</span> <span class="o">=</span> <span class="n">z</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">context</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="s">&#39;M&#39;</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;myLeoSettings.leo&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s">&#39;G&#39;</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="n">tag</span><span class="p">),)</span>

        <span class="k">for</span> <span class="n">aList</span> <span class="ow">in</span> <span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">atLocalButtonsList</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">atLocalCommandsList</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="s">&#39;L&#39;</span><span class="p">),)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data</span><span class="p">)]</span>
        <span class="n">put</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>

        <span class="n">legend</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span><span class="se">\</span>

<span class="s">    legend:</span>
<span class="s">    G leoSettings.leo</span>
<span class="s">    L local .leo File</span>
<span class="s">    M myLeoSettings.leo</span>
<span class="s">    &#39;&#39;&#39;</span>
        <span class="n">legend</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">adjustTripleString</span><span class="p">(</span><span class="n">legend</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">tab_width</span><span class="p">)</span>
        <span class="n">put</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">legend</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20061031131434.121: *4* k.printCommands</span></div>
<div class="viewcode-block" id="keyHandlerClass.printCommands"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.printCommands">[docs]</a>    <span class="k">def</span> <span class="nf">printCommands</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Print all the known commands and their bindings, if any.&#39;&#39;&#39;</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">tabName</span> <span class="o">=</span> <span class="s">&#39;Commands&#39;</span>

        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">clearTab</span><span class="p">(</span><span class="n">tabName</span><span class="p">)</span>

        <span class="n">inverseBindingDict</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">computeInverseBindingDict</span><span class="p">()</span>
        <span class="n">data</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="p">[],</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">commandName</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">commandsDict</span><span class="p">):</span>
            <span class="n">dataList</span> <span class="o">=</span> <span class="n">inverseBindingDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">commandName</span><span class="p">,[(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">),])</span>
            <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">dataList</span><span class="p">:</span>
                <span class="n">pane</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">z</span>
                <span class="n">pane</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pane</span><span class="p">)</span> <span class="k">if</span> <span class="n">pane</span> <span class="o">!=</span> <span class="s">&#39;all:&#39;</span> <span class="k">else</span> <span class="s">&#39;&#39;</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">prettyPrintKey</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;+Key&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                <span class="n">s1</span> <span class="o">=</span> <span class="n">pane</span> <span class="o">+</span> <span class="n">key</span>
                <span class="n">s2</span> <span class="o">=</span> <span class="n">commandName</span>
                <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">s1</span><span class="p">))</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">),)</span>

        <span class="c"># This isn&#39;t perfect in variable-width fonts.</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;</span><span class="si">%*s</span><span class="s"> </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="o">-</span><span class="n">n</span><span class="p">,</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">)</span> <span class="k">for</span> <span class="n">s1</span><span class="p">,</span><span class="n">s2</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span><span class="n">tabName</span><span class="o">=</span><span class="n">tabName</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20061031131434.122: *4* repeatComplexCommand &amp; helper</span></div>
<div class="viewcode-block" id="keyHandlerClass.repeatComplexCommand"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.repeatComplexCommand">[docs]</a>    <span class="k">def</span> <span class="nf">repeatComplexCommand</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Repeat the previously executed minibuffer command.&#39;&#39;&#39;</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">mb_history</span><span class="p">:</span>
            <span class="n">k</span><span class="o">.</span><span class="n">setState</span><span class="p">(</span><span class="s">&#39;last-full-command&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">handler</span><span class="o">=</span><span class="n">k</span><span class="o">.</span><span class="n">repeatComplexCommandHelper</span><span class="p">)</span>
            <span class="n">k</span><span class="o">.</span><span class="n">setLabelBlue</span><span class="p">(</span><span class="s">&quot;Redo: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">mb_history</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;no previous command&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="keyHandlerClass.repeatComplexCommandHelper"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.repeatComplexCommandHelper">[docs]</a>    <span class="k">def</span> <span class="nf">repeatComplexCommandHelper</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>
        <span class="n">char</span> <span class="o">=</span> <span class="n">event</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">char</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">char</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;Return&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">k</span><span class="o">.</span><span class="n">mb_history</span><span class="p">:</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">mb_history</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">k</span><span class="o">.</span><span class="n">resetLabel</span><span class="p">()</span>
            <span class="n">k</span><span class="o">.</span><span class="n">clearState</span><span class="p">()</span> <span class="c"># Bug fix.</span>
            <span class="n">c</span><span class="o">.</span><span class="n">commandsDict</span> <span class="p">[</span><span class="n">last</span><span class="p">](</span><span class="n">event</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># g.trace(&#39;oops&#39;)</span>
            <span class="k">return</span> <span class="n">k</span><span class="o">.</span><span class="n">keyboardQuit</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20061031131434.123: *4* set-xxx-State</span></div>
<div class="viewcode-block" id="keyHandlerClass.setCommandState"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.setCommandState">[docs]</a>    <span class="k">def</span> <span class="nf">setCommandState</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Enter the &#39;command&#39; editing state.&#39;&#39;&#39;</span>
        <span class="c"># g.trace(g.callers())</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">k</span><span class="o">.</span><span class="n">setInputState</span><span class="p">(</span><span class="s">&#39;command&#39;</span><span class="p">,</span><span class="n">set_border</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c"># This command is also valid in headlines.</span>
        <span class="c"># k.c.bodyWantsFocus()</span>
        <span class="n">k</span><span class="o">.</span><span class="n">showStateAndMode</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="keyHandlerClass.setInsertState"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.setInsertState">[docs]</a>    <span class="k">def</span> <span class="nf">setInsertState</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Enter the &#39;insert&#39; editing state.&#39;&#39;&#39;</span>
        <span class="c"># g.trace(g.callers())</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">k</span><span class="o">.</span><span class="n">setInputState</span><span class="p">(</span><span class="s">&#39;insert&#39;</span><span class="p">,</span><span class="n">set_border</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c"># This command is also valid in headlines.</span>
        <span class="c"># k.c.bodyWantsFocus()</span>
        <span class="n">k</span><span class="o">.</span><span class="n">showStateAndMode</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="keyHandlerClass.setOverwriteState"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.setOverwriteState">[docs]</a>    <span class="k">def</span> <span class="nf">setOverwriteState</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Enter the &#39;overwrite&#39; editing state.&#39;&#39;&#39;</span>
        <span class="c"># g.trace(g.callers())</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">k</span><span class="o">.</span><span class="n">setInputState</span><span class="p">(</span><span class="s">&#39;overwrite&#39;</span><span class="p">,</span><span class="n">set_border</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c"># This command is also valid in headlines.</span>
        <span class="c"># k.c.bodyWantsFocus()</span>
        <span class="n">k</span><span class="o">.</span><span class="n">showStateAndMode</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20061031131434.124: *4* toggle-input-state</span></div>
<div class="viewcode-block" id="keyHandlerClass.toggleInputState"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.toggleInputState">[docs]</a>    <span class="k">def</span> <span class="nf">toggleInputState</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;The toggle-input-state command.&#39;&#39;&#39;</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>
        <span class="n">default</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getString</span><span class="p">(</span><span class="s">&#39;top_level_unbound_key_action&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;insert&#39;</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">unboundKeyAction</span>

        <span class="k">if</span> <span class="n">default</span> <span class="o">==</span> <span class="s">&#39;insert&#39;</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">state</span><span class="o">==</span><span class="s">&#39;insert&#39;</span><span class="p">,</span><span class="s">&#39;command&#39;</span><span class="p">,</span><span class="s">&#39;insert&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">default</span> <span class="o">==</span> <span class="s">&#39;overwrite&#39;</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">state</span><span class="o">==</span><span class="s">&#39;overwrite&#39;</span><span class="p">,</span><span class="s">&#39;command&#39;</span><span class="p">,</span><span class="s">&#39;overwrite&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">state</span><span class="o">==</span><span class="s">&#39;command&#39;</span><span class="p">,</span><span class="s">&#39;insert&#39;</span><span class="p">,</span><span class="s">&#39;command&#39;</span><span class="p">)</span> <span class="c"># prefer insert to overwrite.</span>

        <span class="n">k</span><span class="o">.</span><span class="n">setInputState</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="n">k</span><span class="o">.</span><span class="n">showStateAndMode</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20061031131434.125: *3* k.Externally visible helpers</span>
    <span class="c">#@+node:ekr.20061031131434.128: *4* k.getArg</span></div>
<div class="viewcode-block" id="keyHandlerClass.getArg"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.getArg">[docs]</a>    <span class="k">def</span> <span class="nf">getArg</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">,</span>
        <span class="n">returnKind</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">returnState</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">handler</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">prefix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">tabList</span><span class="o">=</span><span class="p">[],</span><span class="n">completion</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">oneCharacter</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">stroke</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="c"># New in 4.4.1.</span>
        <span class="n">useMinibuffer</span><span class="o">=</span><span class="bp">True</span> <span class="c"># New in 4.4.1</span>
    <span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Accumulate an argument until the user hits return (or control-g).</span>
<span class="sd">        Enter the given return state when done.</span>
<span class="sd">        The prefix does not form the arg.  The prefix defaults to the k.getLabel().</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="s">&#39;getArg&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">check_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="c"># 2011/06/06: remember these events also.</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">macroCommands</span><span class="o">.</span><span class="n">recordingMacro</span> <span class="ow">and</span> <span class="n">state</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">macroCommands</span><span class="o">.</span><span class="n">startRecordingMacro</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="n">char</span> <span class="o">=</span> <span class="n">event</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">char</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">k</span><span class="o">.</span><span class="n">setLossage</span><span class="p">(</span><span class="n">char</span><span class="p">,</span><span class="n">stroke</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
            <span class="s">&#39;state&#39;</span><span class="p">,</span><span class="n">state</span><span class="p">,</span><span class="s">&#39;char&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">char</span><span class="p">),</span><span class="s">&#39;stroke&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">stroke</span><span class="p">),</span>
            <span class="s">&#39;isPlain&#39;</span><span class="p">,</span><span class="n">k</span><span class="o">.</span><span class="n">isPlainKey</span><span class="p">(</span><span class="n">stroke</span><span class="p">),</span>
            <span class="s">&#39;escapes&#39;</span><span class="p">,</span><span class="n">k</span><span class="o">.</span><span class="n">getArgEscapes</span><span class="p">,</span>
            <span class="s">&#39;completion&#39;</span><span class="p">,</span><span class="n">state</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">completion</span> <span class="ow">or</span> <span class="n">state</span><span class="o">!=</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">k</span><span class="o">.</span><span class="n">arg_completion</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">k</span><span class="o">.</span><span class="n">arg</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="c">#@+&lt;&lt; init altX vars &gt;&gt;</span>
            <span class="c">#@+node:ekr.20061031131434.129: *5* &lt;&lt; init altX vars &gt;&gt;</span>
            <span class="n">k</span><span class="o">.</span><span class="n">argSelectedText</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">bodyCtrl</span><span class="o">.</span><span class="n">getSelectedText</span><span class="p">()</span>
                <span class="c"># 2010/09/01: remember the selected text for abbreviations.</span>
            <span class="n">k</span><span class="o">.</span><span class="n">argTabList</span> <span class="o">=</span> <span class="n">tabList</span> <span class="ow">and</span> <span class="n">tabList</span><span class="p">[:]</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="n">k</span><span class="o">.</span><span class="n">arg_completion</span> <span class="o">=</span> <span class="n">completion</span>
            <span class="c"># g.trace(&#39;completion&#39;,completion,&#39;tabList&#39;,tabList)</span>

            <span class="n">k</span><span class="o">.</span><span class="n">mb_prefix</span> <span class="o">=</span> <span class="n">prefix</span> <span class="ow">or</span> <span class="n">k</span><span class="o">.</span><span class="n">getLabel</span><span class="p">()</span>
            <span class="n">k</span><span class="o">.</span><span class="n">mb_prompt</span> <span class="o">=</span> <span class="n">prefix</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
            <span class="n">k</span><span class="o">.</span><span class="n">mb_tabList</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c"># Clear the list: any non-tab indicates that a new prefix is in effect.</span>
            <span class="n">k</span><span class="o">.</span><span class="n">mb_tabListPrefix</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">getLabel</span><span class="p">()</span>
            <span class="n">k</span><span class="o">.</span><span class="n">oneCharacterArg</span> <span class="o">=</span> <span class="n">oneCharacter</span>
            <span class="c">#@-&lt;&lt; init altX vars &gt;&gt;</span>
            <span class="c"># Set the states.</span>
            <span class="n">bodyCtrl</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">bodyCtrl</span>
            <span class="n">c</span><span class="o">.</span><span class="n">widgetWantsFocus</span><span class="p">(</span><span class="n">bodyCtrl</span><span class="p">)</span>
            <span class="n">k</span><span class="o">.</span><span class="n">afterGetArgState</span><span class="o">=</span><span class="n">returnKind</span><span class="p">,</span><span class="n">returnState</span><span class="p">,</span><span class="n">handler</span>
            <span class="n">k</span><span class="o">.</span><span class="n">setState</span><span class="p">(</span><span class="s">&#39;getArg&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="o">.</span><span class="n">getArg</span><span class="p">)</span>
            <span class="n">k</span><span class="o">.</span><span class="n">afterArgWidget</span> <span class="o">=</span> <span class="n">event</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">widget</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">bodyCtrl</span>
            <span class="k">if</span> <span class="n">useMinibuffer</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">minibufferWantsFocus</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;Escape&#39;</span><span class="p">:</span>
            <span class="n">k</span><span class="o">.</span><span class="n">keyboardQuit</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">char</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;Return&#39;</span><span class="p">,)</span> <span class="ow">or</span> <span class="n">k</span><span class="o">.</span><span class="n">oneCharacterArg</span> <span class="ow">or</span> <span class="p">(</span><span class="n">stroke</span> <span class="ow">and</span> <span class="n">stroke</span> <span class="ow">in</span> <span class="n">k</span><span class="o">.</span><span class="n">getArgEscapes</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">stroke</span> <span class="ow">and</span> <span class="n">stroke</span> <span class="ow">in</span> <span class="n">k</span><span class="o">.</span><span class="n">getArgEscapes</span><span class="p">:</span>
                <span class="n">k</span><span class="o">.</span><span class="n">getArgEscape</span> <span class="o">=</span> <span class="n">stroke</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">oneCharacterArg</span><span class="p">:</span>
                <span class="n">k</span><span class="o">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">char</span> <span class="c">##</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">k</span><span class="o">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">getLabel</span><span class="p">(</span><span class="n">ignorePrompt</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">kind</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">handler</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">afterGetArgState</span>
            <span class="k">if</span> <span class="n">kind</span><span class="p">:</span> <span class="n">k</span><span class="o">.</span><span class="n">setState</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">handler</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">deleteTab</span><span class="p">(</span><span class="s">&#39;Completion&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;kind&#39;</span><span class="p">,</span><span class="n">kind</span><span class="p">,</span><span class="s">&#39;n&#39;</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="s">&#39;handler&#39;</span><span class="p">,</span><span class="n">handler</span> <span class="ow">and</span> <span class="n">handler</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">handler</span><span class="p">:</span> <span class="n">handler</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">char</span> <span class="ow">in</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;Tab&#39;</span><span class="p">):</span>
            <span class="n">k</span><span class="o">.</span><span class="n">doTabCompletion</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">argTabList</span><span class="p">,</span><span class="n">k</span><span class="o">.</span><span class="n">arg_completion</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">char</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;</span><span class="se">\b</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;BackSpace&#39;</span><span class="p">):</span>
            <span class="n">k</span><span class="o">.</span><span class="n">doBackSpace</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">argTabList</span><span class="p">,</span><span class="n">k</span><span class="o">.</span><span class="n">arg_completion</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">minibufferWantsFocus</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">k</span><span class="o">.</span><span class="n">isFKey</span><span class="p">(</span><span class="n">stroke</span><span class="p">):</span>
            <span class="k">pass</span>
            <span class="c"># 2011/03/01: ignore F-keys. Ignoring all except plain keys would kill unicode searches.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Clear the list, any other character besides tab indicates that a new prefix is in effect.</span>
            <span class="n">k</span><span class="o">.</span><span class="n">mb_tabList</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">k</span><span class="o">.</span><span class="n">updateLabel</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="n">k</span><span class="o">.</span><span class="n">mb_tabListPrefix</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">getLabel</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20061031131434.130: *4* k.keyboardQuit</span></div>
<div class="viewcode-block" id="keyHandlerClass.keyboardQuit"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.keyboardQuit">[docs]</a>    <span class="k">def</span> <span class="nf">keyboardQuit</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">setFocus</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">mouseClick</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;This method clears the state and the minibuffer label.</span>

<span class="sd">        k.endCommand handles all other end-of-command chores.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">quitting</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c"># 2011/05/30: We may be called from Qt event handlers.</span>
        <span class="c"># Make sure to end editing!</span>
        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span> 

        <span class="c"># Completely clear the mode.</span>
        <span class="k">if</span> <span class="n">setFocus</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">deleteTab</span><span class="p">(</span><span class="s">&#39;Mode&#39;</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">hideTab</span><span class="p">(</span><span class="s">&#39;Completion&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">inputModeName</span><span class="p">:</span>
            <span class="n">k</span><span class="o">.</span><span class="n">endMode</span><span class="p">()</span>

        <span class="c"># Complete clear the state.</span>
        <span class="n">k</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">k</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">k</span><span class="o">.</span><span class="n">clearState</span><span class="p">()</span>
        <span class="n">k</span><span class="o">.</span><span class="n">resetLabel</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">setFocus</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">bodyWantsFocus</span><span class="p">()</span>

        <span class="c"># At present, only the auto-completer suppresses this.</span>
        <span class="n">k</span><span class="o">.</span><span class="n">setDefaultInputState</span><span class="p">()</span>
        <span class="c"># This was what caused the unwanted scrolling.</span>
        <span class="n">k</span><span class="o">.</span><span class="n">showStateAndMode</span><span class="p">(</span><span class="n">setFocus</span><span class="o">=</span><span class="n">setFocus</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20061031131434.126: *4* k.manufactureKeyPressForCommandName (changed)</span></div>
<div class="viewcode-block" id="keyHandlerClass.manufactureKeyPressForCommandName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.manufactureKeyPressForCommandName">[docs]</a>    <span class="k">def</span> <span class="nf">manufactureKeyPressForCommandName</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">commandName</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Implement a command by passing a keypress to the gui.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>

        <span class="n">stroke</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">getShortcutForCommandName</span><span class="p">(</span><span class="n">commandName</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">stroke</span><span class="p">:</span>
            <span class="n">shortcut</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">isStroke</span><span class="p">(</span><span class="n">stroke</span><span class="p">):</span>
            <span class="n">shortcut</span> <span class="o">=</span> <span class="n">stroke</span><span class="o">.</span><span class="n">s</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stroke</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">strokeFromSetting</span><span class="p">(</span><span class="n">stroke</span><span class="p">)</span>
            <span class="n">shortcut</span> <span class="o">=</span> <span class="n">stroke</span><span class="o">.</span><span class="n">s</span>

        <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isString</span><span class="p">(</span><span class="n">shortcut</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">shortcut</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
            <span class="s">&#39;shortcut&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">shortcut</span><span class="p">),</span><span class="s">&#39;commandName&#39;</span><span class="p">,</span><span class="n">commandName</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">shortcut</span> <span class="ow">and</span> <span class="n">w</span><span class="p">:</span>
            <span class="c"># g.trace(stroke)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">set_focus</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">w</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">event_generate</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="n">shortcut</span><span class="p">,</span><span class="n">w</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s">&#39;no shortcut for </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">commandName</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20071212104050: *4* k.overrideCommand</span></div>
<div class="viewcode-block" id="keyHandlerClass.overrideCommand"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.overrideCommand">[docs]</a>    <span class="k">def</span> <span class="nf">overrideCommand</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">commandName</span><span class="p">,</span><span class="n">func</span><span class="p">):</span>

        <span class="c"># Override entries in c.k.masterBindingsDict</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">masterBindingsDict</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="n">d2</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key2</span> <span class="ow">in</span> <span class="n">d2</span><span class="p">:</span>
                <span class="n">si</span> <span class="o">=</span> <span class="n">d2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key2</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isShortcutInfo</span><span class="p">(</span><span class="n">si</span><span class="p">),</span><span class="n">si</span>
                <span class="k">if</span> <span class="n">si</span><span class="o">.</span><span class="n">commandName</span> <span class="o">==</span> <span class="n">commandName</span><span class="p">:</span>
                    <span class="n">si</span><span class="o">.</span><span class="n">func</span><span class="o">=</span><span class="n">func</span>
                    <span class="n">d2</span><span class="p">[</span><span class="n">key2</span><span class="p">]</span> <span class="o">=</span> <span class="n">si</span>
    <span class="c">#@+node:ekr.20061031131434.131: *4* k.registerCommand</span></div>
<div class="viewcode-block" id="keyHandlerClass.registerCommand"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.registerCommand">[docs]</a>    <span class="k">def</span> <span class="nf">registerCommand</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">commandName</span><span class="p">,</span><span class="n">shortcut</span><span class="p">,</span><span class="n">func</span><span class="p">,</span>
        <span class="n">pane</span><span class="o">=</span><span class="s">&#39;all&#39;</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Make the function available as a minibuffer command,</span>
<span class="sd">        and optionally attempt to bind a shortcut.</span>

<span class="sd">        You can wrap any method in a callback function, so the</span>
<span class="sd">        restriction to functions is not significant.</span>

<span class="sd">        If wrap is True then func will be wrapped with c.universalCallback.</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span> <span class="p">;</span> <span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">commandName</span><span class="p">,</span><span class="n">shortcut</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">wrap</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">universalCallback</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">commandsDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">commandName</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">f</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">__name__</span> <span class="o">!=</span> <span class="s">&#39;dummyCallback&#39;</span> <span class="ow">and</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;redefining&#39;</span><span class="p">,</span><span class="n">commandName</span><span class="p">)</span>

        <span class="k">assert</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">isStroke</span><span class="p">(</span><span class="n">shortcut</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">commandsDict</span> <span class="p">[</span><span class="n">commandName</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">__name__</span>
        <span class="n">k</span><span class="o">.</span><span class="n">inverseCommandsDict</span> <span class="p">[</span><span class="n">fname</span><span class="p">]</span> <span class="o">=</span> <span class="n">commandName</span>
        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">fname</span> <span class="o">!=</span> <span class="s">&#39;minibufferCallback&#39;</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;leoCommands </span><span class="si">%24s</span><span class="s"> = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="n">commandName</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">shortcut</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;shortcut&#39;</span><span class="p">,</span><span class="n">shortcut</span><span class="p">)</span>
            <span class="n">stroke</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">strokeFromSetting</span><span class="p">(</span><span class="n">shortcut</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">commandName</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;shortcut&#39;</span><span class="p">:</span> <span class="c"># Causes problems.</span>
            <span class="n">stroke</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Try to get a stroke from leoSettings.leo.</span>
            <span class="n">stroke</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">junk</span><span class="p">,</span><span class="n">aList</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getShortcut</span><span class="p">(</span><span class="n">commandName</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isShortcutInfo</span><span class="p">(</span><span class="n">si</span><span class="p">),</span><span class="n">si</span>
                <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isStrokeOrNone</span><span class="p">(</span><span class="n">si</span><span class="o">.</span><span class="n">stroke</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">si</span><span class="o">.</span><span class="n">stroke</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">si</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;-mode&#39;</span><span class="p">):</span>
                    <span class="c"># if trace: g.trace(&#39;*** found&#39;,si)</span>
                    <span class="n">stroke</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">stroke</span>
                    <span class="k">break</span>

        <span class="k">if</span> <span class="n">stroke</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;stroke&#39;</span><span class="p">,</span><span class="n">stroke</span><span class="p">,</span><span class="s">&#39;pane&#39;</span><span class="p">,</span><span class="n">pane</span><span class="p">,</span><span class="n">commandName</span><span class="p">)</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">bindKey</span> <span class="p">(</span><span class="n">pane</span><span class="p">,</span><span class="n">stroke</span><span class="p">,</span><span class="n">func</span><span class="p">,</span><span class="n">commandName</span><span class="p">,</span><span class="n">tag</span><span class="o">=</span><span class="s">&#39;register-command&#39;</span><span class="p">)</span> <span class="c"># Must be a stroke.</span>
            <span class="n">k</span><span class="o">.</span><span class="n">makeMasterGuiBinding</span><span class="p">(</span><span class="n">stroke</span><span class="p">)</span> <span class="c"># Must be a stroke.</span>
            <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="n">ok</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">silentMode</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;@command: </span><span class="si">%s</span><span class="s"> = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">commandName</span><span class="p">,</span><span class="n">k</span><span class="o">.</span><span class="n">prettyPrintKey</span><span class="p">(</span><span class="n">stroke</span><span class="p">)))</span>
                <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">masterBindingsDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;button&#39;</span><span class="p">,{})</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">print_dict</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">setBindings</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">silentMode</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;@command: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">commandName</span><span class="p">))</span>

        <span class="c"># Fixup any previous abbreviation to press-x-button commands.</span>
        <span class="k">if</span> <span class="n">commandName</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;press-&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">commandName</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;-button&#39;</span><span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getAbbrevDict</span><span class="p">()</span>
                <span class="c"># Keys are full command names, values are abbreviations.</span>
            <span class="k">if</span> <span class="n">commandName</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="n">commandName</span><span class="p">:</span>
                        <span class="n">c</span><span class="o">.</span><span class="n">commandsDict</span> <span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">commandsDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">commandName</span><span class="p">)</span>
                        <span class="k">break</span>
    <span class="c">#@+node:ekr.20061031131434.127: *4* k.simulateCommand</span></div>
<div class="viewcode-block" id="keyHandlerClass.simulateCommand"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.simulateCommand">[docs]</a>    <span class="k">def</span> <span class="nf">simulateCommand</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">commandName</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>

        <span class="n">commandName</span> <span class="o">=</span> <span class="n">commandName</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">commandName</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">aList</span> <span class="o">=</span> <span class="n">commandName</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aList</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">k</span><span class="o">.</span><span class="n">givenArgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">commandName</span> <span class="o">=</span> <span class="n">aList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">k</span><span class="o">.</span><span class="n">givenArgs</span> <span class="o">=</span> <span class="n">aList</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="c"># g.trace(commandName,k.givenArgs)</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">commandsDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">commandName</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">func</span><span class="p">:</span>
            <span class="c"># g.trace(commandName,func.__name__)</span>
            <span class="k">if</span> <span class="n">commandName</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;specialCallback&#39;</span><span class="p">):</span>
                <span class="n">event</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># A legacy function.</span>
            <span class="k">else</span><span class="p">:</span> <span class="c"># Create a dummy event as a signal.</span>
                <span class="n">event</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">create_key_event</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>

            <span class="n">k</span><span class="o">.</span><span class="n">masterCommand</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">,</span><span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">k</span><span class="o">.</span><span class="n">funcReturn</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;simulateCommand: no command for </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">commandName</span><span class="p">))</span>
                <span class="k">return</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20061031131434.145: *3* k.Master event handlers</span>
    <span class="c">#@+node:ekr.20061031131434.105: *4* k.masterCommand &amp; helpers</span></div>
<div class="viewcode-block" id="keyHandlerClass.masterCommand"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.masterCommand">[docs]</a>    <span class="k">def</span> <span class="nf">masterCommand</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">commandName</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">func</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">stroke</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;This is the central dispatching method.</span>
<span class="sd">        All commands and keystrokes pass through here.&#39;&#39;&#39;</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="p">(</span><span class="bp">False</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">trace_masterCommand</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">traceGC</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">traceGC</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">printNewObjects</span><span class="p">(</span><span class="s">&#39;masterCom 1&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">event</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">check_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">setLog</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">startRedrawCount</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">redrawCount</span>
        <span class="n">k</span><span class="o">.</span><span class="n">stroke</span> <span class="o">=</span> <span class="n">stroke</span> <span class="c"># Set this global for general use.</span>
        <span class="n">char</span> <span class="o">=</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">event</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">char</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>

        <span class="c"># 2011/10/28: compute func if not given.</span>
        <span class="k">if</span> <span class="n">commandName</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">func</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">commandsDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">commandName</span><span class="p">)</span>
        <span class="c"># Important: it is *not* an error for func to be None.</span>
        <span class="n">k</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
        <span class="n">commandName</span> <span class="o">=</span> <span class="n">commandName</span> <span class="ow">or</span> <span class="n">func</span> <span class="ow">and</span> <span class="n">func</span><span class="o">.</span><span class="n">__name__</span> <span class="ow">or</span> <span class="s">&#39;&lt;no function&gt;&#39;</span>
        <span class="n">k</span><span class="o">.</span><span class="n">funcReturn</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># For unit testing.</span>
        <span class="c">#@+&lt;&lt; define specialKeysyms &gt;&gt;</span>
        <span class="c">#@+node:ekr.20061031131434.106: *5* &lt;&lt; define specialKeysyms &gt;&gt;</span>
        <span class="n">specialKeysyms</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s">&#39;Alt_L&#39;</span><span class="p">,</span><span class="s">&#39;Alt_R&#39;</span><span class="p">,</span>
            <span class="s">&#39;Meta_L&#39;</span><span class="p">,</span><span class="s">&#39;Meta_R&#39;</span><span class="p">,</span> <span class="c"># Meta support.</span>
            <span class="s">&#39;Caps_Lock&#39;</span><span class="p">,</span><span class="s">&#39;Control_L&#39;</span><span class="p">,</span><span class="s">&#39;Control_R&#39;</span><span class="p">,</span>
            <span class="s">&#39;Num_Lock&#39;</span><span class="p">,</span>
            <span class="s">&#39;Shift_L&#39;</span><span class="p">,</span><span class="s">&#39;Shift_R&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c">#@-&lt;&lt; define specialKeysyms &gt;&gt;</span>
        <span class="n">special</span> <span class="o">=</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">specialKeysyms</span>
        <span class="n">inserted</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">special</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="c"># Useful.</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;stroke: </span><span class="si">%s</span><span class="s"> ch: </span><span class="si">%s</span><span class="s"> func: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">stroke</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">ch</span><span class="p">),</span><span class="n">func</span> <span class="ow">and</span> <span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">inserted</span><span class="p">:</span>
            <span class="n">k</span><span class="o">.</span><span class="n">setLossage</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span><span class="n">stroke</span><span class="p">)</span>

        <span class="c"># We *must not* interfere with the global state in the macro class.</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">macroCommands</span><span class="o">.</span><span class="n">recordingMacro</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">macroCommands</span><span class="o">.</span><span class="n">startRecordingMacro</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="c"># 2011/06/06: Show the key, if possible.</span>

        <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">abortAllModesKey</span> <span class="ow">and</span> <span class="n">stroke</span> <span class="o">==</span> <span class="n">k</span><span class="o">.</span><span class="n">abortAllModesKey</span><span class="p">:</span> <span class="c"># &#39;Control-g&#39;</span>
            <span class="n">k</span><span class="o">.</span><span class="n">keyboardQuit</span><span class="p">()</span>
            <span class="n">k</span><span class="o">.</span><span class="n">endCommand</span><span class="p">(</span><span class="n">commandName</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">special</span><span class="p">:</span> <span class="c"># Don&#39;t pass these on.</span>
            <span class="k">return</span>
        <span class="c"># if k.regx.iter:</span>
            <span class="c"># try:</span>
                <span class="c"># k.regXKey = char</span>
                <span class="c"># k.regx.iter.next() # EKR: next() may throw StopIteration.</span>
            <span class="c"># except StopIteration:</span>
                <span class="c"># pass</span>
            <span class="c"># return</span>
        <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">abbrevOn</span><span class="p">:</span>
            <span class="n">expanded</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">abbrevCommands</span><span class="o">.</span><span class="n">expandAbbrev</span><span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="n">stroke</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">expanded</span><span class="p">:</span> <span class="k">return</span>

        <span class="k">if</span> <span class="n">func</span><span class="p">:</span> <span class="c"># Func is an argument.</span>
            <span class="k">if</span> <span class="n">commandName</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;specialCallback&#39;</span><span class="p">):</span>
                <span class="c"># The callback function will call c.doCommand</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;calling specialCallback for&#39;</span><span class="p">,</span><span class="n">commandName</span><span class="p">)</span>
                <span class="c"># if commandName != &#39;repeat-complex-command&#39;: # 2010/01/11</span>
                    <span class="c"># k.mb_history.insert(0,commandName)</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                <span class="c"># k.simulateCommand uses k.funcReturn.</span>
                <span class="n">k</span><span class="o">.</span><span class="n">funcReturn</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">funcReturn</span> <span class="ow">or</span> <span class="n">val</span> <span class="c"># For unit tests.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># Call c.doCommand directly</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;calling command directly&#39;</span><span class="p">,</span><span class="n">commandName</span><span class="p">)</span>
                <span class="n">c</span><span class="o">.</span><span class="n">doCommand</span><span class="p">(</span><span class="n">func</span><span class="p">,</span><span class="n">commandName</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
                <span class="n">k</span><span class="o">.</span><span class="n">endCommand</span><span class="p">(</span><span class="n">commandName</span><span class="p">)</span>
                <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">updateStatusLine</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">traceGC</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">printNewObjects</span><span class="p">(</span><span class="s">&#39;masterCom 2&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">k</span><span class="o">.</span><span class="n">inState</span><span class="p">():</span>
            <span class="k">pass</span> <span class="c">#Ignore unbound keys in a state.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">traceGC</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">printNewObjects</span><span class="p">(</span><span class="s">&#39;masterCom 3&#39;</span><span class="p">)</span>
            <span class="n">k</span><span class="o">.</span><span class="n">handleDefaultChar</span><span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="n">stroke</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">updateStatusLine</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">traceGC</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">printNewObjects</span><span class="p">(</span><span class="s">&#39;masterCom 4&#39;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20061031131434.110: *5* k.handleDefaultChar</span></div>
<div class="viewcode-block" id="keyHandlerClass.handleDefaultChar"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.handleDefaultChar">[docs]</a>    <span class="k">def</span> <span class="nf">handleDefaultChar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">,</span><span class="n">stroke</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">event</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">widget</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">widget_name</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;widget_name&#39;</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="s">&#39;stroke&#39;</span><span class="p">,</span><span class="n">stroke</span><span class="p">,</span><span class="s">&#39;enable alt-ctrl&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">enable_alt_ctrl_bindings</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">stroke</span> <span class="ow">and</span>
            <span class="ow">not</span> <span class="n">stroke</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;Alt+Ctrl&#39;</span><span class="p">)</span> <span class="ow">and</span>
            <span class="c"># not k.enable_alt_ctrl_bindings and # Old code: this isn&#39;t an alt-ctrl key!</span>
            <span class="n">k</span><span class="o">.</span><span class="n">ignore_unbound_non_ascii_keys</span> <span class="ow">and</span> <span class="c"># Bug fix: 2011/11/23</span>
            <span class="p">(</span><span class="n">stroke</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;Ctrl&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">stroke</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;Alt&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;*** ignoring unbound ctrl/alt key:&#39;</span><span class="p">,</span><span class="n">stroke</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTestDict</span><span class="p">[</span><span class="s">&#39;handleUnboundChar-ignore-alt-or-ctrl&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;body&#39;</span><span class="p">):</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">unboundKeyAction</span>
            <span class="k">if</span> <span class="n">action</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;insert&#39;</span><span class="p">,</span><span class="s">&#39;overwrite&#39;</span><span class="p">):</span>
                <span class="n">c</span><span class="o">.</span><span class="n">editCommands</span><span class="o">.</span><span class="n">selfInsertCommand</span><span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="c"># Ignore the key</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;ignoring&#39;</span><span class="p">,</span><span class="n">stroke</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;head&#39;</span><span class="p">):</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">onHeadlineKey</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;canvas&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">stroke</span><span class="p">:</span> <span class="c"># Not exactly right, but it seems to be good enough.</span>
                <span class="n">c</span><span class="o">.</span><span class="n">onCanvasKey</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="c"># New in Leo 4.4.2</span>
        <span class="k">elif</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;log&#39;</span><span class="p">):</span>
            <span class="c"># Bug fix: 2011/11/21: Because of universal bindings</span>
            <span class="c"># we may not be able to insert anything into w.</span>
            <span class="kn">import</span> <span class="nn">leo.core.leoFrame</span> <span class="kn">as</span> <span class="nn">leoFrame</span>
            <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span><span class="n">leoFrame</span><span class="o">.</span><span class="n">HighLevelInterface</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">logCtrl</span><span class="o">.</span><span class="n">getInsertPoint</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">stroke</span><span class="p">:</span>
                    <span class="n">stroke</span> <span class="o">=</span> <span class="n">event</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">stroke</span>
                <span class="k">if</span> <span class="n">stroke</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">stroke</span><span class="o">.</span><span class="n">toGuiChar</span><span class="p">()</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">logCtrl</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;Not a HighLevelInterface object&#39;</span><span class="p">,</span><span class="n">w</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c"># Let the widget handle the event.</span>
    <span class="c">#@+node:ekr.20061031131434.146: *4* k.masterKeyHandler &amp; helpers</span></div>
    <span class="n">master_key_count</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="keyHandlerClass.masterKeyHandler"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.masterKeyHandler">[docs]</a>    <span class="k">def</span> <span class="nf">masterKeyHandler</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;This is the handler for almost all key bindings.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="p">(</span><span class="bp">False</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">trace_masterKeyHandler</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">traceGC</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">trace_masterKeyHandlerGC</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">k</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="n">c</span><span class="o">.</span><span class="n">check_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="c">#@+&lt;&lt; define vars &gt;&gt;</span>
        <span class="c">#@+node:ekr.20061031131434.147: *5* &lt;&lt; define vars &gt;&gt;</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">event</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">widget</span>
        <span class="n">char</span> <span class="o">=</span> <span class="n">event</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">char</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
        <span class="n">stroke</span> <span class="o">=</span> <span class="n">event</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">stroke</span> <span class="ow">or</span> <span class="bp">None</span>
        <span class="c"># w_name = c.widget_name(w)</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">kind</span>
        <span class="n">special_keys</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s">&#39;Alt_L&#39;</span><span class="p">,</span><span class="s">&#39;Alt_R&#39;</span><span class="p">,</span>
            <span class="s">&#39;Caps_Lock&#39;</span><span class="p">,</span><span class="s">&#39;Control_L&#39;</span><span class="p">,</span><span class="s">&#39;Control_R&#39;</span><span class="p">,</span>
            <span class="s">&#39;Meta_L&#39;</span><span class="p">,</span><span class="s">&#39;Meta_R&#39;</span><span class="p">,</span> <span class="c"># Meta support.</span>
            <span class="s">&#39;Num_Lock&#39;</span><span class="p">,</span>
            <span class="s">&#39;Shift_L&#39;</span><span class="p">,</span><span class="s">&#39;Shift_R&#39;</span><span class="p">,</span>
            <span class="s">&#39;Win_L&#39;</span><span class="p">,</span><span class="s">&#39;Win_R&#39;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">master_key_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">isPlain</span> <span class="o">=</span>  <span class="n">k</span><span class="o">.</span><span class="n">isPlainKey</span><span class="p">(</span><span class="n">stroke</span><span class="p">)</span>
        <span class="c">#@-&lt;&lt; define vars &gt;&gt;</span>
        <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isStrokeOrNone</span><span class="p">(</span><span class="n">stroke</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">special_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;char&#39;</span><span class="p">,</span><span class="n">char</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">traceGC</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">printNewObjects</span><span class="p">(</span><span class="s">&#39;masterKey 1&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;stroke:&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">stroke</span><span class="p">),</span><span class="s">&#39;char:&#39;</span><span class="p">,</span>
            <span class="nb">repr</span><span class="p">(</span><span class="n">event</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">char</span><span class="p">),</span>
            <span class="s">&#39;ch:&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">event</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">char</span><span class="p">),</span>
            <span class="s">&#39;state&#39;</span><span class="p">,</span><span class="n">state</span><span class="p">,</span><span class="s">&#39;state2&#39;</span><span class="p">,</span><span class="n">k</span><span class="o">.</span><span class="n">unboundKeyAction</span><span class="p">)</span>

        <span class="c"># Handle keyboard-quit first.</span>
        <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">abortAllModesKey</span> <span class="ow">and</span> <span class="n">stroke</span> <span class="o">==</span> <span class="n">k</span><span class="o">.</span><span class="n">abortAllModesKey</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&#39;screenCastController&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">screenCastController</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">screenCastController</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">macroCommands</span><span class="o">.</span><span class="n">recordingMacro</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">macroCommands</span><span class="o">.</span><span class="n">endMacro</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">k</span><span class="o">.</span><span class="n">masterCommand</span><span class="p">(</span><span class="n">commandName</span><span class="o">=</span><span class="s">&#39;keyboard-quit&#39;</span><span class="p">,</span>
                    <span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">,</span><span class="n">func</span><span class="o">=</span><span class="n">k</span><span class="o">.</span><span class="n">keyboardQuit</span><span class="p">,</span><span class="n">stroke</span><span class="o">=</span><span class="n">stroke</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">inState</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;   state </span><span class="si">%-15s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="n">stroke</span><span class="p">))</span>
            <span class="n">done</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">doMode</span><span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="n">state</span><span class="p">,</span><span class="n">stroke</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">done</span><span class="p">:</span> <span class="k">return</span>

        <span class="k">if</span> <span class="n">traceGC</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">printNewObjects</span><span class="p">(</span><span class="s">&#39;masterKey 2&#39;</span><span class="p">)</span>

        <span class="c"># 2011/02/08: An important simplification.</span>
        <span class="k">if</span> <span class="n">isPlain</span> <span class="ow">and</span> <span class="n">k</span><span class="o">.</span><span class="n">unboundKeyAction</span> <span class="o">!=</span> <span class="s">&#39;command&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isAutoCompleteChar</span><span class="p">(</span><span class="n">stroke</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;autocomplete key&#39;</span><span class="p">,</span><span class="n">stroke</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;inserted </span><span class="si">%-10s</span><span class="s"> (insert/overwrite mode)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">stroke</span><span class="p">))</span>
                <span class="n">k</span><span class="o">.</span><span class="n">handleUnboundKeys</span><span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="n">char</span><span class="p">,</span><span class="n">stroke</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="c"># 2011/02/08: Use getPandBindings for *all* keys.</span>
        <span class="n">si</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">getPaneBinding</span><span class="p">(</span><span class="n">stroke</span><span class="p">,</span><span class="n">w</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">si</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isShortcutInfo</span><span class="p">(</span><span class="n">si</span><span class="p">),</span><span class="n">si</span>
            <span class="k">if</span> <span class="n">traceGC</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">printNewObjects</span><span class="p">(</span><span class="s">&#39;masterKey 3&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;   bound&#39;</span><span class="p">,</span><span class="n">stroke</span><span class="p">,</span><span class="n">si</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
            <span class="n">k</span><span class="o">.</span><span class="n">masterCommand</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">,</span>
                <span class="n">commandName</span><span class="o">=</span><span class="n">si</span><span class="o">.</span><span class="n">commandName</span><span class="p">,</span><span class="n">func</span><span class="o">=</span><span class="n">si</span><span class="o">.</span><span class="n">func</span><span class="p">,</span><span class="n">stroke</span><span class="o">=</span><span class="n">si</span><span class="o">.</span><span class="n">stroke</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">traceGC</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">printNewObjects</span><span class="p">(</span><span class="s">&#39;masterKey 4&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39; unbound&#39;</span><span class="p">,</span><span class="n">stroke</span><span class="p">)</span>
            <span class="n">k</span><span class="o">.</span><span class="n">handleUnboundKeys</span><span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="n">char</span><span class="p">,</span><span class="n">stroke</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20061031131434.108: *5* callStateFunction</span></div>
<div class="viewcode-block" id="keyHandlerClass.callStateFunction"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.callStateFunction">[docs]</a>    <span class="k">def</span> <span class="nf">callStateFunction</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">val</span> <span class="o">=</span> <span class="bp">None</span> 
        <span class="n">ch</span> <span class="o">=</span> <span class="n">event</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">char</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
        <span class="n">stroke</span> <span class="o">=</span> <span class="n">event</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">stroke</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span><span class="s">&#39;ch&#39;</span><span class="p">,</span><span class="n">ch</span><span class="p">,</span><span class="s">&#39;stroke&#39;</span><span class="p">,</span><span class="n">stroke</span><span class="p">,</span>
            <span class="s">&#39;ignore_unbound_non_ascii_keys&#39;</span><span class="p">,</span><span class="n">k</span><span class="o">.</span><span class="n">ignore_unbound_non_ascii_keys</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;auto-complete&#39;</span><span class="p">:</span>
            <span class="c"># 2011/06/17.</span>
            <span class="c"># k.auto_completer_state_handler returns &#39;do-standard-keys&#39; for control keys.</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;auto-complete returns&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">val</span>
        <span class="k">elif</span> <span class="n">k</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">kind</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">k</span><span class="o">.</span><span class="n">ignore_unbound_non_ascii_keys</span> <span class="ow">and</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="c"># 2011/04/01</span>
                <span class="n">ch</span> <span class="ow">and</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;</span><span class="se">\b</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\r</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)</span> <span class="ow">and</span>
                <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">32</span> <span class="ow">or</span> <span class="nb">ord</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="c"># g.trace(&#39;non-ascii&#39;,ord(ch))</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">k</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">handler</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="s">&#39;continue&#39;</span><span class="p">:</span>
                    <span class="n">k</span><span class="o">.</span><span class="n">endCommand</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">commandName</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;callStateFunction: no state function for&#39;</span><span class="p">,</span><span class="n">k</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">kind</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">val</span>
    <span class="c">#@+node:ekr.20091230094319.6244: *5* doMode</span></div>
<div class="viewcode-block" id="keyHandlerClass.doMode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.doMode">[docs]</a>    <span class="k">def</span> <span class="nf">doMode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">,</span><span class="n">state</span><span class="p">,</span><span class="n">stroke</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># First, honor minibuffer bindings for all except user modes.</span>
        <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;getArg&#39;</span><span class="p">,</span><span class="s">&#39;getFileName&#39;</span><span class="p">,</span><span class="s">&#39;full-command&#39;</span><span class="p">,</span><span class="s">&#39;auto-complete&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">handleMiniBindings</span><span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="n">state</span><span class="p">,</span><span class="n">stroke</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>

        <span class="c"># Second, honor general modes.</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="s">&#39;getArg&#39;</span><span class="p">:</span>
            <span class="n">k</span><span class="o">.</span><span class="n">getArg</span><span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="n">stroke</span><span class="o">=</span><span class="n">stroke</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="s">&#39;getFileName&#39;</span><span class="p">:</span>
            <span class="n">k</span><span class="o">.</span><span class="n">getFileName</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">state</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;full-command&#39;</span><span class="p">,</span><span class="s">&#39;auto-complete&#39;</span><span class="p">):</span>
            <span class="c"># Do the default state action.</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;calling state function&#39;</span><span class="p">,</span><span class="n">k</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">kind</span><span class="p">)</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">callStateFunction</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="c"># Calls end-command.</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;state function returns&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">val</span> <span class="o">!=</span> <span class="s">&#39;do-standard-keys&#39;</span>

        <span class="c"># Third, pass keys to user modes.</span>
        <span class="n">d</span> <span class="o">=</span>  <span class="n">k</span><span class="o">.</span><span class="n">masterBindingsDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isStrokeOrNone</span><span class="p">(</span><span class="n">stroke</span><span class="p">)</span>
            <span class="n">si</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stroke</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">si</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isShortcutInfo</span><span class="p">(</span><span class="n">si</span><span class="p">),</span><span class="n">si</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;calling generalModeHandler&#39;</span><span class="p">,</span><span class="n">stroke</span><span class="p">)</span>
                <span class="n">k</span><span class="o">.</span><span class="n">generalModeHandler</span> <span class="p">(</span><span class="n">event</span><span class="p">,</span>
                    <span class="n">commandName</span><span class="o">=</span><span class="n">si</span><span class="o">.</span><span class="n">commandName</span><span class="p">,</span><span class="n">func</span><span class="o">=</span><span class="n">si</span><span class="o">.</span><span class="n">func</span><span class="p">,</span>
                    <span class="n">modeName</span><span class="o">=</span><span class="n">state</span><span class="p">,</span><span class="n">nextMode</span><span class="o">=</span><span class="n">si</span><span class="o">.</span><span class="n">nextMode</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># New in Leo 4.5: unbound keys end mode.</span>
                <span class="c"># if trace: g.trace(&#39;unbound key ends mode&#39;,stroke,state)</span>
                <span class="k">if</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># 2012/05/20: I dislike this warning.</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;unbound key ends mode&#39;</span><span class="p">,</span><span class="n">stroke</span><span class="p">)</span> <span class="c"># 2011/02/02</span>
                <span class="n">k</span><span class="o">.</span><span class="n">endMode</span><span class="p">()</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># New in 4.4b4.</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">getStateHandler</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">handler</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;handler&#39;</span><span class="p">,</span><span class="n">handler</span><span class="p">)</span>
                <span class="n">handler</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;No state handler for </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">state</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
    <span class="c">#@+node:ekr.20091230094319.6240: *5* getPaneBinding</span></div>
<div class="viewcode-block" id="keyHandlerClass.getPaneBinding"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.getPaneBinding">[docs]</a>    <span class="k">def</span> <span class="nf">getPaneBinding</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">stroke</span><span class="p">,</span><span class="n">w</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">w_name</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">widget_name</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="c"># keyStatesTuple = (&#39;command&#39;,&#39;insert&#39;,&#39;overwrite&#39;)</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">unboundKeyAction</span>

        <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isStroke</span><span class="p">(</span><span class="n">stroke</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;w_name&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">w_name</span><span class="p">),</span><span class="s">&#39;stroke&#39;</span><span class="p">,</span><span class="n">stroke</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">,</span><span class="n">w</span><span class="p">,</span>
            <span class="s">&#39;isTextWidget(w)&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">isTextWidget</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="c"># Order here is similar to bindtags order.</span>
            <span class="p">(</span><span class="s">&#39;command&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;insert&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;overwrite&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;button&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;body&#39;</span><span class="p">,</span><span class="s">&#39;body&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;text&#39;</span><span class="p">,</span><span class="s">&#39;head&#39;</span><span class="p">),</span> <span class="c"># Important: text bindings in head before tree bindings.</span>
            <span class="p">(</span><span class="s">&#39;tree&#39;</span><span class="p">,</span><span class="s">&#39;head&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;tree&#39;</span><span class="p">,</span><span class="s">&#39;canvas&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;log&#39;</span><span class="p">,</span> <span class="s">&#39;log&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;text&#39;</span><span class="p">,</span><span class="s">&#39;log&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;text&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;all&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="c"># key in keyStatesTuple and isPlain and k.unboundKeyAction == key or</span>
                <span class="n">name</span> <span class="ow">and</span> <span class="n">w_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">or</span>
                <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;command&#39;</span><span class="p">,</span><span class="s">&#39;insert&#39;</span><span class="p">,</span><span class="s">&#39;overwrite&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">state</span> <span class="o">==</span> <span class="n">key</span> <span class="ow">or</span> <span class="c"># 2010/02/09</span>
                <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;text&#39;</span><span class="p">,</span><span class="s">&#39;all&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">isTextWidget</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="ow">or</span>
                <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;button&#39;</span><span class="p">,</span><span class="s">&#39;all&#39;</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">masterBindingsDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,{})</span>
                <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="c"># g.trace(&#39;key&#39;,key,&#39;name&#39;,name,&#39;stroke&#39;,stroke,&#39;stroke in d.keys&#39;,stroke in d)</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;key: </span><span class="si">%7s</span><span class="s"> name: </span><span class="si">%6s</span><span class="s"> stroke: </span><span class="si">%10s</span><span class="s"> in keys: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">stroke</span><span class="p">,</span><span class="n">stroke</span> <span class="ow">in</span> <span class="n">d</span><span class="p">))</span>
                    <span class="c"># g.trace(key,&#39;keys&#39;,g.listToString(list(d.keys()),sort=True)) # [:5])</span>
                <span class="k">if</span> <span class="n">d</span><span class="p">:</span>
                    <span class="n">si</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stroke</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">si</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="n">si</span><span class="o">.</span><span class="n">stroke</span> <span class="o">==</span> <span class="n">stroke</span><span class="p">,</span><span class="s">&#39;si: </span><span class="si">%s</span><span class="s"> stroke: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">si</span><span class="p">,</span><span class="n">stroke</span><span class="p">)</span>
                            <span class="c"># masterBindingsDict: keys are KeyStrokes</span>
                        <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isShortcutInfo</span><span class="p">(</span><span class="n">si</span><span class="p">),</span><span class="n">si</span>
                        <span class="n">table</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;previous-line&#39;</span><span class="p">,</span><span class="s">&#39;next-line&#39;</span><span class="p">,)</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;text&#39;</span> <span class="ow">and</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;head&#39;</span> <span class="ow">and</span> <span class="n">si</span><span class="o">.</span><span class="n">commandName</span> <span class="ow">in</span> <span class="n">table</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;***** special case&#39;</span><span class="p">,</span><span class="n">si</span><span class="o">.</span><span class="n">commandName</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;key: </span><span class="si">%7s</span><span class="s"> name: </span><span class="si">%6s</span><span class="s">  found </span><span class="si">%s</span><span class="s"> = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">key</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">si</span><span class="o">.</span><span class="n">stroke</span><span class="p">),</span><span class="n">si</span><span class="o">.</span><span class="n">commandName</span><span class="p">))</span>
                            <span class="k">return</span> <span class="n">si</span>

        <span class="k">return</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20061031131434.152: *5* handleMiniBindings</span></div>
<div class="viewcode-block" id="keyHandlerClass.handleMiniBindings"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.handleMiniBindings">[docs]</a>    <span class="k">def</span> <span class="nf">handleMiniBindings</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">,</span><span class="n">state</span><span class="p">,</span><span class="n">stroke</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="p">(</span><span class="bp">False</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">trace_masterKeyHandler</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span>

        <span class="c"># Special case for bindings handled in k.getArg:</span>

        <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isStroke</span><span class="p">(</span><span class="n">stroke</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;getArg&#39;</span><span class="p">,</span><span class="s">&#39;full-command&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">stroke</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;</span><span class="se">\b</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;BackSpace&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\r</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;Linefeed&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;Return&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;Tab&#39;</span><span class="p">,</span><span class="s">&#39;Escape&#39;</span><span class="p">,):</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">isFKey</span><span class="p">(</span><span class="n">stroke</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;auto-&#39;</span><span class="p">):</span>
            <span class="c"># New in Leo 4.5: ignore plain key binding in the minibuffer.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">stroke</span> <span class="ow">or</span> <span class="n">k</span><span class="o">.</span><span class="n">isPlainKey</span><span class="p">(</span><span class="n">stroke</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;plain key&#39;</span><span class="p">,</span><span class="n">stroke</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="c"># New in Leo 4.5: The minibuffer inherits &#39;text&#39; and &#39;all&#39; bindings</span>
            <span class="c"># for all single-line editing commands.</span>
            <span class="k">for</span> <span class="n">pane</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;mini&#39;</span><span class="p">,</span><span class="s">&#39;all&#39;</span><span class="p">,</span><span class="s">&#39;text&#39;</span><span class="p">):</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">masterBindingsDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pane</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">d</span><span class="p">:</span>
                    <span class="n">si</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stroke</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">si</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="n">si</span><span class="o">.</span><span class="n">stroke</span> <span class="o">==</span> <span class="n">stroke</span><span class="p">,</span><span class="s">&#39;si: </span><span class="si">%s</span><span class="s"> stroke: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">si</span><span class="p">,</span><span class="n">stroke</span><span class="p">)</span>
                            <span class="c"># masterBindingsDict: keys are KeyStrokes</span>
                        <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isShortcutInfo</span><span class="p">(</span><span class="n">si</span><span class="p">),</span><span class="n">si</span>
                        <span class="k">if</span> <span class="n">si</span><span class="o">.</span><span class="n">commandName</span> <span class="o">==</span> <span class="s">&#39;replace-string&#39;</span> <span class="ow">and</span> <span class="n">state</span> <span class="o">==</span> <span class="s">&#39;getArg&#39;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> binding for replace-string&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pane</span><span class="p">),</span><span class="n">stroke</span><span class="p">)</span>
                            <span class="k">return</span> <span class="bp">False</span> <span class="c"># Let getArg handle it.</span>
                        <span class="k">elif</span> <span class="n">si</span><span class="o">.</span><span class="n">commandName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">k</span><span class="o">.</span><span class="n">singleLineCommandList</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> binding terminates minibuffer&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">pane</span><span class="p">),</span><span class="n">si</span><span class="o">.</span><span class="n">commandName</span><span class="p">,</span><span class="n">stroke</span><span class="p">)</span>
                            <span class="n">k</span><span class="o">.</span><span class="n">keyboardQuit</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">stroke</span><span class="p">),</span><span class="s">&#39;mini binding&#39;</span><span class="p">,</span><span class="n">si</span><span class="o">.</span><span class="n">commandName</span><span class="p">)</span>
                            <span class="n">c</span><span class="o">.</span><span class="n">minibufferWantsFocus</span><span class="p">()</span> <span class="c"># New in Leo 4.5.</span>
                        <span class="c"># Pass this on for macro recording.</span>
                        <span class="n">k</span><span class="o">.</span><span class="n">masterCommand</span><span class="p">(</span><span class="n">commandName</span><span class="o">=</span><span class="n">si</span><span class="o">.</span><span class="n">commandName</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">,</span><span class="n">func</span><span class="o">=</span><span class="n">si</span><span class="o">.</span><span class="n">func</span><span class="p">,</span><span class="n">stroke</span><span class="o">=</span><span class="n">stroke</span><span class="p">)</span>
                        <span class="c"># Careful: the command could exit.</span>
                        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">exists</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">silentMode</span><span class="p">:</span>
                            <span class="n">c</span><span class="o">.</span><span class="n">minibufferWantsFocus</span><span class="p">()</span>
                        <span class="k">return</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20110209083917.16004: *5* isAutoCompleteChar</span></div>
<div class="viewcode-block" id="keyHandlerClass.isAutoCompleteChar"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.isAutoCompleteChar">[docs]</a>    <span class="k">def</span> <span class="nf">isAutoCompleteChar</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">stroke</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return True if stroke is bound to the auto-complete in</span>
<span class="sd">        the insert or overwrite state.&#39;&#39;&#39;</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">state</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">unboundKeyAction</span>

        <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isStrokeOrNone</span><span class="p">(</span><span class="n">stroke</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stroke</span> <span class="ow">and</span> <span class="n">state</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;insert&#39;</span><span class="p">,</span><span class="s">&#39;overwrite&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="s">&#39;body&#39;</span><span class="p">,</span><span class="s">&#39;log&#39;</span><span class="p">,</span><span class="s">&#39;text&#39;</span><span class="p">,</span><span class="s">&#39;all&#39;</span><span class="p">):</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">masterBindingsDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,{})</span>
                <span class="k">if</span> <span class="n">d</span><span class="p">:</span>
                    <span class="n">si</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stroke</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">si</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="n">si</span><span class="o">.</span><span class="n">stroke</span> <span class="o">==</span> <span class="n">stroke</span><span class="p">,</span><span class="s">&#39;si: </span><span class="si">%s</span><span class="s"> stroke: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">si</span><span class="p">,</span><span class="n">stroke</span><span class="p">)</span>
                        <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isShortcutInfo</span><span class="p">(</span><span class="n">si</span><span class="p">),</span><span class="n">si</span>
                        <span class="k">if</span> <span class="n">si</span><span class="o">.</span><span class="n">commandName</span> <span class="o">==</span> <span class="s">&#39;auto-complete&#39;</span><span class="p">:</span>
                            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20080510095819.1: *5* k.handleUnboundKeys</span></div>
<div class="viewcode-block" id="keyHandlerClass.handleUnboundKeys"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.handleUnboundKeys">[docs]</a>    <span class="k">def</span> <span class="nf">handleUnboundKeys</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">,</span><span class="n">char</span><span class="p">,</span><span class="n">stroke</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>
        <span class="n">modesTuple</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;insert&#39;</span><span class="p">,</span><span class="s">&#39;overwrite&#39;</span><span class="p">)</span>
        <span class="c"># g.trace(&#39;self.enable_alt_ctrl_bindings&#39;,self.enable_alt_ctrl_bindings)</span>
        <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isStroke</span><span class="p">(</span><span class="n">stroke</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;ch: </span><span class="si">%s</span><span class="s">, stroke </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">repr</span><span class="p">(</span><span class="n">event</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">char</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">stroke</span><span class="p">)))</span>
        <span class="c"># g.trace(&#39;stroke&#39;,repr(stroke),&#39;isFKey&#39;,k.isFKey(stroke))</span>

        <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">unboundKeyAction</span> <span class="o">==</span> <span class="s">&#39;command&#39;</span><span class="p">:</span>
            <span class="c"># Ignore all unbound characters in command mode.</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">get_focus</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">w</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">widget_name</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;canvas&#39;</span><span class="p">):</span>
                <span class="n">c</span><span class="o">.</span><span class="n">onCanvasKey</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;ignoring unbound character in command mode&#39;</span><span class="p">,</span><span class="n">stroke</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">elif</span> <span class="n">stroke</span><span class="o">.</span><span class="n">isFKey</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;ignoring F-key&#39;</span><span class="p">,</span><span class="n">stroke</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">elif</span> <span class="n">stroke</span> <span class="ow">and</span> <span class="n">k</span><span class="o">.</span><span class="n">isPlainKey</span><span class="p">(</span><span class="n">stroke</span><span class="p">)</span> <span class="ow">and</span> <span class="n">k</span><span class="o">.</span><span class="n">unboundKeyAction</span> <span class="ow">in</span> <span class="n">modesTuple</span><span class="p">:</span>
            <span class="c"># insert/overwrite normal character.  &lt;Return&gt; is *not* a normal character.</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;plain key in insert mode&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">stroke</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">k</span><span class="o">.</span><span class="n">masterCommand</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">,</span><span class="n">stroke</span><span class="o">=</span><span class="n">stroke</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_alt_ctrl_bindings</span> <span class="ow">and</span>
            <span class="p">(</span><span class="n">stroke</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;Alt+&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">stroke</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;Ctrl+&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="c"># 2011/02/11: Always ignore unbound Alt/Ctrl keys.</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;ignoring unbound Alt/Ctrl key&#39;</span><span class="p">,</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">char</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">stroke</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">elif</span> <span class="n">k</span><span class="o">.</span><span class="n">ignore_unbound_non_ascii_keys</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">char</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span>
            <span class="n">char</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">printable</span> <span class="c"># 2011/06/10: risky test?</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;ignoring unbound non-ascii key&#39;</span><span class="p">,</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">char</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">stroke</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="n">stroke</span> <span class="ow">and</span> <span class="n">stroke</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;Escape&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span>
            <span class="n">stroke</span> <span class="ow">and</span> <span class="n">stroke</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;Insert&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="p">):</span>
            <span class="c"># Never insert escape or insert characters.</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;ignore Escape/Ignore&#39;</span><span class="p">,</span><span class="n">stroke</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;no func&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">char</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">stroke</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">k</span><span class="o">.</span><span class="n">masterCommand</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">,</span><span class="n">stroke</span><span class="o">=</span><span class="n">stroke</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20061031170011.3: *3* k.Minibuffer</span>
    <span class="c"># These may be overridden, but this code is now gui-independent.</span>
    <span class="c">#@+node:ekr.20061031131434.135: *4* k.minibufferWantsFocus</span>
    <span class="c"># def minibufferWantsFocus(self):</span>

        <span class="c"># c = self.c</span>
        <span class="c"># c.widgetWantsFocus(c.miniBufferWidget)</span>
    <span class="c">#@+node:ekr.20061031170011.5: *4* k.getLabel</span></div>
<div class="viewcode-block" id="keyHandlerClass.getLabel"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.getLabel">[docs]</a>    <span class="k">def</span> <span class="nf">getLabel</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ignorePrompt</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">w</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#39;&#39;</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getAllText</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">ignorePrompt</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">mb_prefix</span><span class="p">):]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
    <span class="c">#@+node:ekr.20080408060320.791: *4* k.killLine</span></div>
<div class="viewcode-block" id="keyHandlerClass.killLine"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.killLine">[docs]</a>    <span class="k">def</span> <span class="nf">killLine</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">protect</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">w</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getAllText</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">mb_prefix</span><span class="p">)]</span>
        <span class="n">w</span><span class="o">.</span><span class="n">setAllText</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">w</span><span class="o">.</span><span class="n">setSelectionRange</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">insert</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">protect</span><span class="p">:</span>
            <span class="n">k</span><span class="o">.</span><span class="n">mb_prefix</span> <span class="o">=</span> <span class="n">s</span>
    <span class="c">#@+node:ekr.20061031170011.6: *4* k.protectLabel</span></div>
<div class="viewcode-block" id="keyHandlerClass.protectLabel"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.protectLabel">[docs]</a>    <span class="k">def</span> <span class="nf">protectLabel</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">w</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">k</span><span class="o">.</span><span class="n">mb_prefix</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getAllText</span><span class="p">()</span>

    <span class="c">#@+node:ekr.20061031170011.7: *4* k.resetLabel</span></div>
<div class="viewcode-block" id="keyHandlerClass.resetLabel"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.resetLabel">[docs]</a>    <span class="k">def</span> <span class="nf">resetLabel</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w</span>
        <span class="n">k</span><span class="o">.</span><span class="n">setLabelGrey</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">k</span><span class="o">.</span><span class="n">mb_prefix</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

        <span class="k">if</span> <span class="n">w</span><span class="p">:</span>    
            <span class="n">w</span><span class="o">.</span><span class="n">setSelectionRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">insert</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">unboundKeyAction</span>
            <span class="n">k</span><span class="o">.</span><span class="n">setLabelBlue</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> State&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()),</span><span class="n">protect</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20061031170011.8: *4* k.setLabel</span></div>
<div class="viewcode-block" id="keyHandlerClass.setLabel"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.setLabel">[docs]</a>    <span class="k">def</span> <span class="nf">setLabel</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">protect</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="p">(</span><span class="bp">False</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">trace_minibuffer</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">w</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">w</span><span class="p">:</span> <span class="k">return</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">),</span><span class="n">w</span><span class="p">)</span>
        <span class="n">w</span><span class="o">.</span><span class="n">setAllText</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">w</span><span class="o">.</span><span class="n">setSelectionRange</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">insert</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">protect</span><span class="p">:</span>
            <span class="n">k</span><span class="o">.</span><span class="n">mb_prefix</span> <span class="o">=</span> <span class="n">s</span>
    <span class="c">#@+node:ekr.20061031170011.9: *4* k.extendLabel</span></div>
<div class="viewcode-block" id="keyHandlerClass.extendLabel"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.extendLabel">[docs]</a>    <span class="k">def</span> <span class="nf">extendLabel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">select</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">protect</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">w</span> <span class="ow">and</span> <span class="n">s</span><span class="p">):</span> <span class="k">return</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">widgetWantsFocusNow</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

        <span class="n">w</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="s">&#39;end&#39;</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">select</span><span class="p">:</span>
            <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">getEditableTextRange</span><span class="p">()</span>
            <span class="n">w</span><span class="o">.</span><span class="n">setSelectionRange</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">insert</span><span class="o">=</span><span class="n">j</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">protect</span><span class="p">:</span>
            <span class="n">k</span><span class="o">.</span><span class="n">protectLabel</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20080408060320.790: *4* k.selectAll</span></div>
<div class="viewcode-block" id="keyHandlerClass.selectAll"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.selectAll">[docs]</a>    <span class="k">def</span> <span class="nf">selectAll</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Select all the user-editable text of the minibuffer.&#39;&#39;&#39;</span>

        <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w</span>
        <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getEditableTextRange</span><span class="p">()</span>
        <span class="n">w</span><span class="o">.</span><span class="n">setSelectionRange</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">insert</span><span class="o">=</span><span class="n">j</span><span class="p">)</span>


    <span class="c">#@+node:ekr.20061031170011.10: *4* k.setLabelBlue</span></div>
<div class="viewcode-block" id="keyHandlerClass.setLabelBlue"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.setLabelBlue">[docs]</a>    <span class="k">def</span> <span class="nf">setLabelBlue</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">protect</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">w</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">w</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">w</span><span class="p">:</span> <span class="k">return</span>

        <span class="c"># w.setBackgroundColor(self.minibuffer_background_color) # &#39;lightblue&#39;)</span>

        <span class="n">w</span><span class="o">.</span><span class="n">setBothColors</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">minibuffer_background_color</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">minibuffer_foreground_color</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">k</span><span class="o">.</span><span class="n">setLabel</span><span class="p">(</span><span class="n">label</span><span class="p">,</span><span class="n">protect</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20061031170011.11: *4* k.setLabelGrey</span></div>
<div class="viewcode-block" id="keyHandlerClass.setLabelGrey"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.setLabelGrey">[docs]</a>    <span class="k">def</span> <span class="nf">setLabelGrey</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">w</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">w</span><span class="o">.</span><span class="n">setBackgroundColor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minibuffer_warning_color</span><span class="p">)</span> <span class="c"># &#39;lightgrey&#39;)</span>

        <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">k</span><span class="o">.</span><span class="n">setLabel</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</div>
    <span class="n">setLabelGray</span> <span class="o">=</span> <span class="n">setLabelGrey</span>
    <span class="c">#@+node:ekr.20080510153327.2: *4* k.setLabelRed</span>
<div class="viewcode-block" id="keyHandlerClass.setLabelRed"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.setLabelRed">[docs]</a>    <span class="k">def</span> <span class="nf">setLabelRed</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">protect</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">w</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">w</span><span class="o">.</span><span class="n">setBothColors</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">minibuffer_warning_color</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">minibuffer_error_color</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">k</span><span class="o">.</span><span class="n">setLabel</span><span class="p">(</span><span class="n">label</span><span class="p">,</span><span class="n">protect</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20061031170011.12: *4* k.updateLabel</span></div>
<div class="viewcode-block" id="keyHandlerClass.updateLabel"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.updateLabel">[docs]</a>    <span class="k">def</span> <span class="nf">updateLabel</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Mimic what would happen with the keyboard and a Text editor</span>
<span class="sd">        instead of plain accumalation.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">trace_minibuffer</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="p">(</span><span class="n">event</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">char</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;ch&#39;</span><span class="p">,</span><span class="n">ch</span><span class="p">,</span><span class="s">&#39;k.stroke&#39;</span><span class="p">,</span><span class="n">k</span><span class="o">.</span><span class="n">stroke</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ch</span> <span class="ow">and</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\r</span><span class="s">&#39;</span><span class="p">):</span>
            <span class="n">c</span><span class="o">.</span><span class="n">widgetWantsFocusNow</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
            <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getSelectionRange</span><span class="p">()</span>
            <span class="n">ins</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getInsertPoint</span><span class="p">()</span>
            <span class="c"># g.trace(i,j,ins)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">j</span><span class="p">:</span>
                <span class="n">w</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\b</span><span class="s">&#39;</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getAllText</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">mb_prefix</span><span class="p">):</span>
                    <span class="n">w</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">i</span><span class="o">-=</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">w</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">ins</span><span class="p">,</span><span class="n">ch</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">ins</span><span class="o">+</span><span class="mi">1</span>
    <span class="c">#@+node:ekr.20061031170011.13: *4* k.getEditableTextRange</span></div>
<div class="viewcode-block" id="keyHandlerClass.getEditableTextRange"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.getEditableTextRange">[docs]</a>    <span class="k">def</span> <span class="nf">getEditableTextRange</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getAllText</span><span class="p">()</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">mb_prefix</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span>
    <span class="c">#@+node:ekr.20120208064440.10190: *3* k.Modes (no change)</span>
    <span class="c">#@+node:ekr.20061031131434.100: *4* k.addModeCommands (enterModeCallback)</span></div>
<div class="viewcode-block" id="keyHandlerClass.addModeCommands"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.addModeCommands">[docs]</a>    <span class="k">def</span> <span class="nf">addModeCommands</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Add commands created by @mode settings to c.commandsDict and k.inverseCommandsDict.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;(k)&#39;</span><span class="p">)</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">modeCommandsDict</span> <span class="c"># Keys are command names: enter-x-mode.</span>

        <span class="c"># Create the callback functions and update c.commandsDict and k.inverseCommandsDict.</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

            <span class="k">def</span> <span class="nf">enterModeCallback</span> <span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">key</span><span class="p">):</span>
                <span class="n">k</span><span class="o">.</span><span class="n">enterNamedMode</span><span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

            <span class="n">c</span><span class="o">.</span><span class="n">commandsDict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span> <span class="o">=</span> <span class="n">enterModeCallback</span>
            <span class="n">k</span><span class="o">.</span><span class="n">inverseCommandsDict</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="s">&#39;len(c.commandsDict.keys())&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">commandsDict</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
    <span class="c">#@+node:ekr.20061031131434.157: *4* k.badMode</span></div>
<div class="viewcode-block" id="keyHandlerClass.badMode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.badMode">[docs]</a>    <span class="k">def</span> <span class="nf">badMode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">modeName</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">k</span><span class="o">.</span><span class="n">clearState</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">modeName</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;-mode&#39;</span><span class="p">):</span> <span class="n">modeName</span> <span class="o">=</span> <span class="n">modeName</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">k</span><span class="o">.</span><span class="n">setLabelGrey</span><span class="p">(</span><span class="s">&#39;@mode </span><span class="si">%s</span><span class="s"> is not defined (or is empty)&#39;</span> <span class="o">%</span> <span class="n">modeName</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20061031131434.158: *4* k.createModeBindings</span></div>
<div class="viewcode-block" id="keyHandlerClass.createModeBindings"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.createModeBindings">[docs]</a>    <span class="k">def</span> <span class="nf">createModeBindings</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">modeName</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">w</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Create mode bindings for the named mode using dictionary d for w, a text widget.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>
        <span class="k">assert</span> <span class="n">d</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;-mode&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">commandName</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">commandName</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;*entry-commands*&#39;</span><span class="p">,</span><span class="s">&#39;*command-prompt*&#39;</span><span class="p">):</span>
                <span class="c"># These are special-purpose dictionary entries.</span>
                <span class="k">continue</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">commandsDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">commandName</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">func</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;no such command:&#39;</span><span class="p">,</span><span class="n">commandName</span><span class="p">,</span><span class="s">&#39;Referenced from&#39;</span><span class="p">,</span><span class="n">modeName</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">aList</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">commandName</span><span class="p">,[])</span>
            <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isShortcutInfo</span><span class="p">(</span><span class="n">si</span><span class="p">),</span><span class="n">si</span>
                <span class="n">stroke</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">stroke</span>
                <span class="c"># Important: si.val is canonicalized.</span>
                <span class="k">if</span> <span class="n">stroke</span> <span class="ow">and</span> <span class="n">stroke</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;None&#39;</span><span class="p">,</span><span class="s">&#39;none&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
                            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">widget_name</span><span class="p">(</span><span class="n">w</span><span class="p">),</span> <span class="n">modeName</span><span class="p">,</span>
                            <span class="s">&#39;</span><span class="si">%10s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">stroke</span><span class="p">),</span>
                            <span class="s">&#39;</span><span class="si">%20s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">commandName</span><span class="p">),</span>
                            <span class="n">si</span><span class="o">.</span><span class="n">nextMode</span><span class="p">)</span>

                    <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isStroke</span><span class="p">(</span><span class="n">stroke</span><span class="p">)</span>

                    <span class="n">k</span><span class="o">.</span><span class="n">makeMasterGuiBinding</span><span class="p">(</span><span class="n">stroke</span><span class="p">)</span>

                    <span class="c"># Create the entry for the mode in k.masterBindingsDict.</span>
                    <span class="c"># Important: this is similar, but not the same as k.bindKeyToDict.</span>
                    <span class="c"># Thus, we should **not** call k.bindKey here!</span>
                    <span class="n">d2</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">masterBindingsDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">modeName</span><span class="p">,{})</span>
                    <span class="n">d2</span> <span class="p">[</span><span class="n">stroke</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">ShortcutInfo</span><span class="p">(</span>
                        <span class="n">kind</span> <span class="o">=</span> <span class="s">&#39;mode&lt;</span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">modeName</span><span class="p">),</span> <span class="c"># 2012/01/23</span>
                        <span class="n">commandName</span><span class="o">=</span><span class="n">commandName</span><span class="p">,</span>
                        <span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="p">,</span>
                        <span class="n">nextMode</span><span class="o">=</span><span class="n">si</span><span class="o">.</span><span class="n">nextMode</span><span class="p">,</span>
                        <span class="n">stroke</span><span class="o">=</span><span class="n">stroke</span><span class="p">)</span>
                    <span class="n">k</span><span class="o">.</span><span class="n">masterBindingsDict</span> <span class="p">[</span> <span class="n">modeName</span> <span class="p">]</span> <span class="o">=</span> <span class="n">d2</span>
    <span class="c">#@+node:ekr.20120208064440.10179: *4* k.endMode</span></div>
<div class="viewcode-block" id="keyHandlerClass.endMode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.endMode">[docs]</a>    <span class="k">def</span> <span class="nf">endMode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>

        <span class="n">w</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">get_focus</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">w</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">deleteTab</span><span class="p">(</span><span class="s">&#39;Mode&#39;</span><span class="p">)</span> <span class="c"># Changes focus to the body pane</span>

        <span class="n">k</span><span class="o">.</span><span class="n">endCommand</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">stroke</span><span class="p">)</span>
        <span class="n">k</span><span class="o">.</span><span class="n">inputModeName</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">k</span><span class="o">.</span><span class="n">clearState</span><span class="p">()</span>
        <span class="n">k</span><span class="o">.</span><span class="n">resetLabel</span><span class="p">()</span>
        <span class="n">k</span><span class="o">.</span><span class="n">showStateAndMode</span><span class="p">()</span> <span class="c"># Restores focus.</span>

        <span class="k">if</span> <span class="n">w</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">widgetWantsFocusNow</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20061031131434.160: *4* k.enterNamedMode</span></div>
<div class="viewcode-block" id="keyHandlerClass.enterNamedMode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.enterNamedMode">[docs]</a>    <span class="k">def</span> <span class="nf">enterNamedMode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">,</span><span class="n">commandName</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>
        <span class="n">modeName</span> <span class="o">=</span> <span class="n">commandName</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span>
        <span class="n">c</span><span class="o">.</span><span class="n">inCommand</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># Allow inner commands in the mode.</span>
        <span class="n">k</span><span class="o">.</span><span class="n">generalModeHandler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="n">modeName</span><span class="o">=</span><span class="n">modeName</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20061031131434.161: *4* k.exitNamedMode</span></div>
<div class="viewcode-block" id="keyHandlerClass.exitNamedMode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.exitNamedMode">[docs]</a>    <span class="k">def</span> <span class="nf">exitNamedMode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Exit an input mode.&#39;&#39;&#39;</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">inState</span><span class="p">():</span>
            <span class="n">k</span><span class="o">.</span><span class="n">endMode</span><span class="p">()</span>

        <span class="n">k</span><span class="o">.</span><span class="n">showStateAndMode</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20061031131434.165: *4* k.modeHelp &amp; helper (revise helper)</span></div>
<div class="viewcode-block" id="keyHandlerClass.modeHelp"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.modeHelp">[docs]</a>    <span class="k">def</span> <span class="nf">modeHelp</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;The mode-help command.</span>

<span class="sd">        A possible convention would be to bind &lt;Tab&gt; to this command in most modes,</span>
<span class="sd">        by analogy with tab completion.&#39;&#39;&#39;</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>
        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span>
        <span class="c"># g.trace(k.inputModeName)</span>
        <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">inputModeName</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">modeCommandsDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;enter-&#39;</span><span class="o">+</span><span class="n">k</span><span class="o">.</span><span class="n">inputModeName</span><span class="p">)</span>
            <span class="n">k</span><span class="o">.</span><span class="n">modeHelpHelper</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">silentMode</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">minibufferWantsFocus</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20061031131434.166: *5* modeHelpHelper</span></div>
<div class="viewcode-block" id="keyHandlerClass.modeHelpHelper"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.modeHelpHelper">[docs]</a>    <span class="k">def</span> <span class="nf">modeHelpHelper</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">d</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">tabName</span> <span class="o">=</span> <span class="s">&#39;Mode&#39;</span>
        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">clearTab</span><span class="p">(</span><span class="n">tabName</span><span class="p">)</span>
        <span class="n">data</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="p">[],</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;*entry-commands*&#39;</span><span class="p">,</span><span class="s">&#39;*command-prompt*&#39;</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">aList</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isShortcutInfo</span><span class="p">(</span><span class="n">si</span><span class="p">),</span><span class="n">si</span>
                    <span class="n">stroke</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">stroke</span>
                    <span class="k">if</span> <span class="n">stroke</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="s">&#39;None&#39;</span><span class="p">):</span>
                        <span class="n">s1</span> <span class="o">=</span> <span class="n">key</span>
                        <span class="n">s2</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">prettyPrintKey</span><span class="p">(</span><span class="n">stroke</span><span class="p">)</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">s1</span><span class="p">))</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">),)</span>

        <span class="n">data</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">modeName</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">inputModeName</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="s">&#39; &#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">modeName</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;mode&#39;</span><span class="p">):</span>
            <span class="n">modeName</span> <span class="o">=</span> <span class="n">modeName</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="n">prompt</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;*command-prompt*&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prompt</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%s</span><span class="se">\n\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prompt</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">strip</span><span class="p">()),</span><span class="n">tabName</span><span class="o">=</span><span class="n">tabName</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> mode</span><span class="se">\n\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">modeName</span><span class="p">,</span><span class="n">tabName</span><span class="o">=</span><span class="n">tabName</span><span class="p">)</span>

        <span class="c"># This isn&#39;t perfect in variable-width fonts.</span>
        <span class="k">for</span> <span class="n">s1</span><span class="p">,</span><span class="n">s2</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%*s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">),</span><span class="n">tabName</span><span class="o">=</span><span class="n">tabName</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20061031131434.164: *4* k.reinitMode (call k.createModeBindings???)</span></div>
<div class="viewcode-block" id="keyHandlerClass.reinitMode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.reinitMode">[docs]</a>    <span class="k">def</span> <span class="nf">reinitMode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">modeName</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">modeBindingsDict</span>
        <span class="n">k</span><span class="o">.</span><span class="n">inputModeName</span> <span class="o">=</span> <span class="n">modeName</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">silentMode</span><span class="p">,</span><span class="n">k</span><span class="o">.</span><span class="n">modeWidget</span><span class="p">,</span><span class="n">k</span><span class="o">.</span><span class="n">w</span><span class="p">)</span>
        <span class="n">k</span><span class="o">.</span><span class="n">createModeBindings</span><span class="p">(</span><span class="n">modeName</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">w</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">silentMode</span><span class="p">:</span>
            <span class="n">k</span><span class="o">.</span><span class="n">showStateAndMode</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Do not set the status line here.</span>
            <span class="n">k</span><span class="o">.</span><span class="n">setLabelBlue</span><span class="p">(</span><span class="n">modeName</span><span class="o">+</span><span class="s">&#39;: &#39;</span><span class="p">,</span><span class="n">protect</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20120208064440.10199: *4* k.generalModeHandler (OLD)</span></div>
<div class="viewcode-block" id="keyHandlerClass.generalModeHandler"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.generalModeHandler">[docs]</a>    <span class="k">def</span> <span class="nf">generalModeHandler</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">,</span>
        <span class="n">commandName</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">func</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">modeName</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">nextMode</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">prompt</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Handle a mode defined by an @mode node in leoSettings.leo.&#39;&#39;&#39;</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">modeName</span><span class="p">)</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="p">(</span><span class="bp">False</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">trace_modes</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">modeName</span><span class="p">,</span><span class="s">&#39;state&#39;</span><span class="p">,</span><span class="n">state</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">k</span><span class="o">.</span><span class="n">inputModeName</span> <span class="o">=</span> <span class="n">modeName</span>
            <span class="n">k</span><span class="o">.</span><span class="n">modePrompt</span> <span class="o">=</span> <span class="n">prompt</span> <span class="ow">or</span> <span class="n">modeName</span>
            <span class="n">k</span><span class="o">.</span><span class="n">modeWidget</span> <span class="o">=</span> <span class="n">event</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">widget</span>
            <span class="n">k</span><span class="o">.</span><span class="n">setState</span><span class="p">(</span><span class="n">modeName</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">handler</span><span class="o">=</span><span class="n">k</span><span class="o">.</span><span class="n">generalModeHandler</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initMode</span><span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="n">modeName</span><span class="p">)</span>
            <span class="c"># Careful: k.initMode can execute commands that will destroy a commander.</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">quitting</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span> <span class="k">return</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">silentMode</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getBool</span><span class="p">(</span><span class="s">&#39;showHelpWhenEnteringModes&#39;</span><span class="p">):</span>
                    <span class="n">k</span><span class="o">.</span><span class="n">modeHelp</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">hideTab</span><span class="p">(</span><span class="s">&#39;Mode&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">func</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;No func: improper key binding&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">commandName</span> <span class="o">==</span> <span class="s">&#39;mode-help&#39;</span><span class="p">:</span>
                <span class="n">func</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">endMode</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">trace</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getBool</span><span class="p">(</span><span class="s">&#39;trace_doCommand&#39;</span><span class="p">):</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
                <span class="c"># New in 4.4.1 b1: pass an event describing the original widget.</span>
                <span class="k">if</span> <span class="n">event</span><span class="p">:</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">widget</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">modeWidget</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">event</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">create_key_event</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="n">k</span><span class="o">.</span><span class="n">modeWidget</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">modeName</span><span class="p">,</span><span class="s">&#39;state&#39;</span><span class="p">,</span><span class="n">state</span><span class="p">,</span><span class="n">commandName</span><span class="p">,</span><span class="s">&#39;nextMode&#39;</span><span class="p">,</span><span class="n">nextMode</span><span class="p">)</span>
                <span class="n">func</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">quitting</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="n">nextMode</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="s">&#39;none&#39;</span><span class="p">):</span>
                    <span class="c"># Do *not* clear k.inputModeName or the focus here.</span>
                    <span class="c"># func may have put us in *another* mode.</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="n">nextMode</span> <span class="o">==</span> <span class="s">&#39;same&#39;</span><span class="p">:</span>
                    <span class="n">silent</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">silentMode</span>
                    <span class="n">k</span><span class="o">.</span><span class="n">setState</span><span class="p">(</span><span class="n">modeName</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">handler</span><span class="o">=</span><span class="n">k</span><span class="o">.</span><span class="n">generalModeHandler</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reinitMode</span><span class="p">(</span><span class="n">modeName</span><span class="p">)</span> <span class="c"># Re-enter this mode.</span>
                    <span class="n">k</span><span class="o">.</span><span class="n">silentMode</span> <span class="o">=</span> <span class="n">silent</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">k</span><span class="o">.</span><span class="n">silentMode</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># All silent modes must do --&gt; set-silent-mode.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">initMode</span><span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="n">nextMode</span><span class="p">)</span> <span class="c"># Enter another mode.</span>
    <span class="c">#@+node:ekr.20061031131434.156: *3* k.Modes (changed)</span>
    <span class="c">#@+node:ekr.20061031131434.163: *4* k.initMode (changed)</span></div>
<div class="viewcode-block" id="keyHandlerClass.initMode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.initMode">[docs]</a>    <span class="k">def</span> <span class="nf">initMode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">,</span><span class="n">modeName</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="p">(</span><span class="bp">False</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">trace_modes</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">modeName</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;oops: no modeName&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">new_modes</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">modeController</span><span class="o">.</span><span class="n">getMode</span><span class="p">(</span><span class="n">modeName</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mode</span><span class="p">:</span>
                <span class="n">mode</span><span class="o">.</span><span class="n">initMode</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;***** oops: no mode&#39;</span><span class="p">,</span><span class="n">modeName</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">modeCommandsDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;enter-&#39;</span><span class="o">+</span><span class="n">modeName</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">d</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">badMode</span><span class="p">(</span><span class="n">modeName</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">k</span><span class="o">.</span><span class="n">modeBindingsDict</span> <span class="o">=</span> <span class="n">d</span>
                <span class="n">si</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;*command-prompt*&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">si</span><span class="p">:</span>
                    <span class="n">prompt</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">kind</span> <span class="c"># A kludge.</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">prompt</span> <span class="o">=</span> <span class="n">modeName</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;modeName: </span><span class="si">%s</span><span class="s"> prompt: </span><span class="si">%s</span><span class="s"> d.keys(): </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">modeName</span><span class="p">,</span><span class="n">prompt</span><span class="p">,</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">()))))</span>

            <span class="n">k</span><span class="o">.</span><span class="n">inputModeName</span> <span class="o">=</span> <span class="n">modeName</span>
            <span class="n">k</span><span class="o">.</span><span class="n">silentMode</span> <span class="o">=</span> <span class="bp">False</span>

            <span class="n">aList</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;*entry-commands*&#39;</span><span class="p">,[])</span>
            <span class="k">if</span> <span class="n">aList</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isShortcutInfo</span><span class="p">(</span><span class="n">si</span><span class="p">),</span><span class="n">si</span>
                    <span class="n">commandName</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">commandName</span>
                    <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;entry command:&#39;</span><span class="p">,</span><span class="n">commandName</span><span class="p">)</span>
                    <span class="n">k</span><span class="o">.</span><span class="n">simulateCommand</span><span class="p">(</span><span class="n">commandName</span><span class="p">)</span>
                    <span class="c"># Careful, the command can kill the commander.</span>
                    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">quitting</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span> <span class="k">return</span>
                    <span class="c"># New in Leo 4.5: a startup command can immediately transfer to another mode.</span>
                    <span class="k">if</span> <span class="n">commandName</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;enter-&#39;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;redirect to mode&#39;</span><span class="p">,</span><span class="n">commandName</span><span class="p">)</span>
                        <span class="k">return</span>

            <span class="c"># Create bindings after we know whether we are in silent mode.</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">silentMode</span><span class="p">,</span><span class="n">k</span><span class="o">.</span><span class="n">modeWidget</span><span class="p">,</span><span class="n">k</span><span class="o">.</span><span class="n">w</span><span class="p">)</span>
            <span class="n">k</span><span class="o">.</span><span class="n">createModeBindings</span><span class="p">(</span><span class="n">modeName</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">w</span><span class="p">)</span>
            <span class="n">k</span><span class="o">.</span><span class="n">showStateAndMode</span><span class="p">(</span><span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20120208064440.10201: *4* k.NEWgeneralModeHandler (NEW MODES)</span></div>
<div class="viewcode-block" id="keyHandlerClass.NEWgeneralModeHandler"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.NEWgeneralModeHandler">[docs]</a>    <span class="k">def</span> <span class="nf">NEWgeneralModeHandler</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">,</span>
        <span class="n">commandName</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">func</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">modeName</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">nextMode</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">prompt</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Handle a mode defined by an @mode node in leoSettings.leo.&#39;&#39;&#39;</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">modeName</span><span class="p">)</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="p">(</span><span class="bp">False</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">trace_modes</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">modeName</span><span class="p">,</span><span class="s">&#39;state&#39;</span><span class="p">,</span><span class="n">state</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">k</span><span class="o">.</span><span class="n">inputModeName</span> <span class="o">=</span> <span class="n">modeName</span>
            <span class="n">k</span><span class="o">.</span><span class="n">modePrompt</span> <span class="o">=</span> <span class="n">prompt</span> <span class="ow">or</span> <span class="n">modeName</span>
            <span class="n">k</span><span class="o">.</span><span class="n">modeWidget</span> <span class="o">=</span> <span class="n">event</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">widget</span>
            <span class="n">k</span><span class="o">.</span><span class="n">setState</span><span class="p">(</span><span class="n">modeName</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">handler</span><span class="o">=</span><span class="n">k</span><span class="o">.</span><span class="n">generalModeHandler</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initMode</span><span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="n">modeName</span><span class="p">)</span>
            <span class="c"># Careful: k.initMode can execute commands that will destroy a commander.</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">quitting</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span> <span class="k">return</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">silentMode</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getBool</span><span class="p">(</span><span class="s">&#39;showHelpWhenEnteringModes&#39;</span><span class="p">):</span>
                    <span class="n">k</span><span class="o">.</span><span class="n">modeHelp</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">hideTab</span><span class="p">(</span><span class="s">&#39;Mode&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">func</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;No func: improper key binding&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">commandName</span> <span class="o">==</span> <span class="s">&#39;mode-help&#39;</span><span class="p">:</span>
                <span class="n">func</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">endMode</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">trace</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getBool</span><span class="p">(</span><span class="s">&#39;trace_doCommand&#39;</span><span class="p">):</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
                <span class="c"># New in 4.4.1 b1: pass an event describing the original widget.</span>
                <span class="k">if</span> <span class="n">event</span><span class="p">:</span>
                    <span class="n">event</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">widget</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">modeWidget</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">event</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">create_key_event</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="n">k</span><span class="o">.</span><span class="n">modeWidget</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">modeName</span><span class="p">,</span><span class="s">&#39;state&#39;</span><span class="p">,</span><span class="n">state</span><span class="p">,</span><span class="n">commandName</span><span class="p">,</span><span class="s">&#39;nextMode&#39;</span><span class="p">,</span><span class="n">nextMode</span><span class="p">)</span>
                <span class="n">func</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">quitting</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="n">nextMode</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="s">&#39;none&#39;</span><span class="p">):</span>
                    <span class="c"># Do *not* clear k.inputModeName or the focus here.</span>
                    <span class="c"># func may have put us in *another* mode.</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="n">nextMode</span> <span class="o">==</span> <span class="s">&#39;same&#39;</span><span class="p">:</span>
                    <span class="n">silent</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">silentMode</span>
                    <span class="n">k</span><span class="o">.</span><span class="n">setState</span><span class="p">(</span><span class="n">modeName</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">handler</span><span class="o">=</span><span class="n">k</span><span class="o">.</span><span class="n">generalModeHandler</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">reinitMode</span><span class="p">(</span><span class="n">modeName</span><span class="p">)</span> <span class="c"># Re-enter this mode.</span>
                    <span class="n">k</span><span class="o">.</span><span class="n">silentMode</span> <span class="o">=</span> <span class="n">silent</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">k</span><span class="o">.</span><span class="n">silentMode</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># All silent modes must do --&gt; set-silent-mode.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">initMode</span><span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="n">nextMode</span><span class="p">)</span> <span class="c"># Enter another mode.</span>
                    <span class="c"># Careful: k.initMode can execute commands that will destroy a commander.</span>
                    <span class="c"># if g.app.quitting or not c.exists: return</span>
    <span class="c">#@+node:ekr.20061031131434.167: *3* k.Shared helpers</span>
    <span class="c">#@+node:ekr.20061031131434.175: *4* k.computeCompletionList</span>
    <span class="c"># Important: this code must not change mb_tabListPrefix.  Only doBackSpace should do that.</span>
</div>
<div class="viewcode-block" id="keyHandlerClass.computeCompletionList"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.computeCompletionList">[docs]</a>    <span class="k">def</span> <span class="nf">computeCompletionList</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">defaultTabList</span><span class="p">,</span><span class="n">backspace</span><span class="p">,</span><span class="n">allow_empty_completion</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">s</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">getLabel</span><span class="p">()</span> <span class="p">;</span> <span class="n">tabName</span> <span class="o">=</span> <span class="s">&#39;Completion&#39;</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">s</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">mb_prompt</span><span class="p">):]</span>
            <span class="c"># s always includes prefix, so command is well defined.</span>

        <span class="n">k</span><span class="o">.</span><span class="n">mb_tabList</span><span class="p">,</span><span class="n">common_prefix</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">itemsMatchingPrefixInList</span><span class="p">(</span><span class="n">command</span><span class="p">,</span><span class="n">defaultTabList</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">clearTab</span><span class="p">(</span><span class="n">tabName</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;command&#39;</span><span class="p">,</span><span class="n">command</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;common_prefix&#39;</span><span class="p">,</span><span class="n">common_prefix</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;k.mb_tabList&#39;</span><span class="p">,</span><span class="n">k</span><span class="o">.</span><span class="n">mb_tabList</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">mb_tabList</span> <span class="ow">and</span> <span class="n">allow_empty_completion</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">command</span><span class="p">:</span>
                <span class="c"># 2012/05/20: Put up an *empty* list as a visual cue.</span>
                <span class="n">k</span><span class="o">.</span><span class="n">mb_tabList</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="n">tabName</span><span class="o">=</span><span class="n">tabName</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># 2012/05/20: Return *all* completions if the command is empty.</span>
                <span class="n">k</span><span class="o">.</span><span class="n">mb_tabList</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">defaultTabList</span><span class="p">)</span>
                <span class="n">common_prefix</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

        <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">mb_tabList</span><span class="p">:</span>
            <span class="n">k</span><span class="o">.</span><span class="n">mb_tabListIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c"># The next item will be item 0.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">backspace</span><span class="p">:</span>
                <span class="n">k</span><span class="o">.</span><span class="n">setLabel</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">mb_prompt</span> <span class="o">+</span> <span class="n">common_prefix</span><span class="p">)</span>

            <span class="n">inverseBindingDict</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">computeInverseBindingDict</span><span class="p">()</span>
            <span class="n">data</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="p">[],</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">commandName</span> <span class="ow">in</span> <span class="n">k</span><span class="o">.</span><span class="n">mb_tabList</span><span class="p">:</span>
                <span class="n">dataList</span> <span class="o">=</span> <span class="n">inverseBindingDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">commandName</span><span class="p">,[(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">),])</span>
                <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">dataList</span><span class="p">:</span>
                    <span class="n">pane</span><span class="p">,</span><span class="n">key</span> <span class="o">=</span> <span class="n">z</span>
                    <span class="n">s1a</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pane</span><span class="p">)</span> <span class="k">if</span> <span class="n">pane</span> <span class="o">!=</span> <span class="s">&#39;all:&#39;</span> <span class="k">else</span> <span class="s">&#39;&#39;</span>
                    <span class="n">s1b</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">prettyPrintKey</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="n">s1</span> <span class="o">=</span> <span class="n">s1a</span> <span class="o">+</span> <span class="n">s1b</span>
                    <span class="n">s2</span> <span class="o">=</span> <span class="n">commandName</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">),)</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">s1</span><span class="p">))</span>
            <span class="n">aList</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;</span><span class="si">%*s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="o">-</span><span class="n">n</span><span class="p">,</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">)</span> <span class="k">for</span> <span class="n">s1</span><span class="p">,</span><span class="n">s2</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">aList</span><span class="p">),</span><span class="n">tabName</span><span class="o">=</span><span class="n">tabName</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">bodyWantsFocus</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20061031131434.177: *4* k.doBackSpace</span>
    <span class="c"># Used by getArg and fullCommand.</span>
</div>
<div class="viewcode-block" id="keyHandlerClass.doBackSpace"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.doBackSpace">[docs]</a>    <span class="k">def</span> <span class="nf">doBackSpace</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">defaultCompletionList</span><span class="p">,</span><span class="n">completion</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Cut back to previous prefix and update prefix.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">w</span>
        <span class="n">ins</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getInsertPoint</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
            <span class="s">&#39;ins&#39;</span><span class="p">,</span><span class="n">ins</span><span class="p">,</span><span class="s">&#39;k.mb_prefix&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">mb_prefix</span><span class="p">),</span><span class="s">&#39;w&#39;</span><span class="p">,</span><span class="n">w</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ins</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">mb_prefix</span><span class="p">):</span>
            <span class="c"># g.trace(&#39;at start&#39;)</span>
            <span class="k">return</span>
            
        <span class="c"># Step 1: actually delete the character.</span>
        <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getSelectionRange</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
            <span class="n">ins</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">w</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">ins</span><span class="p">)</span>
            <span class="n">w</span><span class="o">.</span><span class="n">setSelectionRange</span><span class="p">(</span><span class="n">ins</span><span class="p">,</span><span class="n">ins</span><span class="p">,</span><span class="n">insert</span><span class="o">=</span><span class="n">ins</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ins</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">w</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
            <span class="n">w</span><span class="o">.</span><span class="n">setSelectionRange</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">insert</span><span class="o">=</span><span class="n">ins</span><span class="p">)</span>

        <span class="c"># Step 2: compute completions.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">completion</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">k</span><span class="o">.</span><span class="n">mb_tabListPrefix</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getAllText</span><span class="p">()</span>
        <span class="n">k</span><span class="o">.</span><span class="n">computeCompletionList</span><span class="p">(</span><span class="n">defaultCompletionList</span><span class="p">,</span><span class="n">backspace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20061031131434.178: *4* k.doTabCompletion</span>
    <span class="c"># Used by getArg and fullCommand.</span>
</div>
<div class="viewcode-block" id="keyHandlerClass.doTabCompletion"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.doTabCompletion">[docs]</a>    <span class="k">def</span> <span class="nf">doTabCompletion</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">defaultTabList</span><span class="p">,</span><span class="n">redraw</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">allow_empty_completion</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Handle tab completion when the user hits a tab.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">s</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">getLabel</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">mb_tabList</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">mb_tabListPrefix</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;cycle&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
            <span class="c"># Set the label to the next item on the tab list.</span>
            <span class="n">k</span><span class="o">.</span><span class="n">mb_tabListIndex</span> <span class="o">+=</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">mb_tabListIndex</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">mb_tabList</span><span class="p">):</span>
                <span class="n">k</span><span class="o">.</span><span class="n">mb_tabListIndex</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">k</span><span class="o">.</span><span class="n">setLabel</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">mb_prompt</span> <span class="o">+</span> <span class="n">k</span><span class="o">.</span><span class="n">mb_tabList</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">mb_tabListIndex</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">redraw</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;** recomputing default completions&#39;</span><span class="p">)</span>
                <span class="n">k</span><span class="o">.</span><span class="n">computeCompletionList</span><span class="p">(</span><span class="n">defaultTabList</span><span class="p">,</span>
                    <span class="n">backspace</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                    <span class="n">allow_empty_completion</span><span class="o">=</span><span class="n">allow_empty_completion</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">minibufferWantsFocus</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20061031131434.168: *4* k.getFileName &amp; helpers</span></div>
<div class="viewcode-block" id="keyHandlerClass.getFileName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.getFileName">[docs]</a>    <span class="k">def</span> <span class="nf">getFileName</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">handler</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">filterExt</span><span class="o">=</span><span class="s">&#39;.leo&#39;</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Similar to k.getArg, but uses completion to indicate files on the file system.&#39;&#39;&#39;</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="s">&#39;getFileName&#39;</span> <span class="p">;</span> <span class="n">state</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
        <span class="n">tabName</span> <span class="o">=</span> <span class="s">&#39;Completion&#39;</span>

        <span class="n">char</span> <span class="o">=</span> <span class="n">event</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">char</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
        <span class="c"># g.trace(&#39;state&#39;,state,&#39;char&#39;,char)</span>

        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">k</span><span class="o">.</span><span class="n">arg</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="c">#@+&lt;&lt; init altX vars &gt;&gt;</span>
            <span class="c">#@+node:ekr.20061031131434.169: *5* &lt;&lt; init altX vars &gt;&gt;</span>
            <span class="n">k</span><span class="o">.</span><span class="n">filterExt</span> <span class="o">=</span> <span class="n">filterExt</span>
            <span class="n">k</span><span class="o">.</span><span class="n">mb_prefix</span> <span class="o">=</span> <span class="p">(</span><span class="n">prefix</span> <span class="ow">or</span> <span class="n">k</span><span class="o">.</span><span class="n">getLabel</span><span class="p">())</span>
            <span class="n">k</span><span class="o">.</span><span class="n">mb_prompt</span> <span class="o">=</span> <span class="n">prefix</span> <span class="ow">or</span> <span class="n">k</span><span class="o">.</span><span class="n">getLabel</span><span class="p">()</span>
            <span class="n">k</span><span class="o">.</span><span class="n">mb_tabList</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c"># Clear the list: any non-tab indicates that a new prefix is in effect.</span>
            <span class="n">theDir</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">)</span>
            <span class="n">k</span><span class="o">.</span><span class="n">extendLabel</span><span class="p">(</span><span class="n">theDir</span><span class="p">,</span><span class="n">select</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">protect</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

            <span class="n">k</span><span class="o">.</span><span class="n">mb_tabListPrefix</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">getLabel</span><span class="p">()</span>
            <span class="c">#@-&lt;&lt; init altX vars &gt;&gt;</span>
            <span class="c"># Set the states.</span>
            <span class="n">k</span><span class="o">.</span><span class="n">getFileNameHandler</span> <span class="o">=</span> <span class="n">handler</span>
            <span class="n">k</span><span class="o">.</span><span class="n">setState</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="o">.</span><span class="n">getFileName</span><span class="p">)</span>
            <span class="n">k</span><span class="o">.</span><span class="n">afterArgWidget</span> <span class="o">=</span> <span class="n">event</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">widget</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">bodyCtrl</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">clearTab</span><span class="p">(</span><span class="n">tabName</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">minibufferWantsFocus</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">char</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;Return&#39;</span><span class="p">):</span>
            <span class="n">k</span><span class="o">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">getLabel</span><span class="p">(</span><span class="n">ignorePrompt</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">getFileNameHandler</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">deleteTab</span><span class="p">(</span><span class="n">tabName</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">handler</span><span class="p">:</span> <span class="n">handler</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">char</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;Tab&#39;</span><span class="p">):</span>
            <span class="n">k</span><span class="o">.</span><span class="n">doFileNameTab</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">minibufferWantsFocus</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">char</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;</span><span class="se">\b</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;BackSpace&#39;</span><span class="p">):</span>
            <span class="n">k</span><span class="o">.</span><span class="n">doFileNameBackSpace</span><span class="p">()</span> 
            <span class="n">c</span><span class="o">.</span><span class="n">minibufferWantsFocus</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">k</span><span class="o">.</span><span class="n">doFileNameChar</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20061031131434.170: *5* k.doFileNameBackSpace</span></div>
<div class="viewcode-block" id="keyHandlerClass.doFileNameBackSpace"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.doFileNameBackSpace">[docs]</a>    <span class="k">def</span> <span class="nf">doFileNameBackSpace</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Cut back to previous prefix and update prefix.&#39;&#39;&#39;</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">mb_tabListPrefix</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">mb_prefix</span><span class="p">),</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">mb_tabListPrefix</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">mb_prefix</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">mb_tabListPrefix</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">mb_prefix</span><span class="p">):</span>
            <span class="n">k</span><span class="o">.</span><span class="n">mb_tabListPrefix</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">mb_tabListPrefix</span> <span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">k</span><span class="o">.</span><span class="n">setLabel</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">mb_tabListPrefix</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20061031131434.171: *5* k.doFileNameChar</span></div>
<div class="viewcode-block" id="keyHandlerClass.doFileNameChar"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.doFileNameChar">[docs]</a>    <span class="k">def</span> <span class="nf">doFileNameChar</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># Clear the list, any other character besides tab indicates that a new prefix is in effect.</span>
        <span class="n">k</span><span class="o">.</span><span class="n">mb_tabList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">k</span><span class="o">.</span><span class="n">updateLabel</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="n">k</span><span class="o">.</span><span class="n">mb_tabListPrefix</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">getLabel</span><span class="p">()</span>

        <span class="n">common_prefix</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">computeFileNameCompletionList</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">mb_tabList</span><span class="p">:</span>
            <span class="n">k</span><span class="o">.</span><span class="n">setLabel</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">mb_prompt</span> <span class="o">+</span> <span class="n">common_prefix</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Restore everything.</span>
            <span class="n">old</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">getLabel</span><span class="p">(</span><span class="n">ignorePrompt</span><span class="o">=</span><span class="bp">True</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">k</span><span class="o">.</span><span class="n">setLabel</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">mb_prompt</span> <span class="o">+</span> <span class="n">old</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20061031131434.172: *5* k.doFileNameTab</span></div>
<div class="viewcode-block" id="keyHandlerClass.doFileNameTab"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.doFileNameTab">[docs]</a>    <span class="k">def</span> <span class="nf">doFileNameTab</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">common_prefix</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">computeFileNameCompletionList</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">mb_tabList</span><span class="p">:</span>
            <span class="n">k</span><span class="o">.</span><span class="n">setLabel</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">mb_prompt</span> <span class="o">+</span> <span class="n">common_prefix</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20061031131434.173: *5* k.computeFileNameCompletionList</span>
    <span class="c"># This code must not change mb_tabListPrefix.</span></div>
<div class="viewcode-block" id="keyHandlerClass.computeFileNameCompletionList"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.computeFileNameCompletionList">[docs]</a>    <span class="k">def</span> <span class="nf">computeFileNameCompletionList</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">tabName</span> <span class="o">=</span> <span class="s">&#39;Completion&#39;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">getLabel</span><span class="p">(</span><span class="n">ignorePrompt</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">sep</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span>
        <span class="n">tabList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">path</span><span class="o">+</span><span class="s">&#39;*&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_isdir</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="n">tabList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span> <span class="o">+</span> <span class="n">sep</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">junk</span><span class="p">,</span><span class="n">ext</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_splitext</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ext</span> <span class="ow">or</span> <span class="n">ext</span> <span class="o">==</span> <span class="n">k</span><span class="o">.</span><span class="n">filterExt</span><span class="p">:</span>
                    <span class="n">tabList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">k</span><span class="o">.</span><span class="n">mb_tabList</span> <span class="o">=</span> <span class="n">tabList</span>
        <span class="n">junk</span><span class="p">,</span><span class="n">common_prefix</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">itemsMatchingPrefixInList</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">tabList</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tabList</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">clearTab</span><span class="p">(</span><span class="n">tabName</span><span class="p">)</span>
            <span class="n">k</span><span class="o">.</span><span class="n">showFileNameTabList</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">common_prefix</span>
    <span class="c">#@+node:ekr.20061031131434.174: *5* k.showFileNameTabList</span></div>
<div class="viewcode-block" id="keyHandlerClass.showFileNameTabList"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.showFileNameTabList">[docs]</a>    <span class="k">def</span> <span class="nf">showFileNameTabList</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">tabName</span> <span class="o">=</span> <span class="s">&#39;Completion&#39;</span>

        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">k</span><span class="o">.</span><span class="n">mb_tabList</span><span class="p">:</span>
            <span class="n">theDir</span><span class="p">,</span><span class="n">fileName</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_split</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">),</span><span class="n">theDir</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">fileName</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_basename</span><span class="p">(</span><span class="n">theDir</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">tabName</span><span class="o">=</span><span class="n">tabName</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20110609161752.16459: *4* k.setLossage</span></div>
<div class="viewcode-block" id="keyHandlerClass.setLossage"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.setLossage">[docs]</a>    <span class="k">def</span> <span class="nf">setLossage</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ch</span><span class="p">,</span><span class="n">stroke</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="c"># k = self</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">stroke</span><span class="p">),</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">ch</span> <span class="ow">or</span> <span class="n">stroke</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">lossage</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">99</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">lossage</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="c"># This looks like a memory leak, but isn&#39;t.</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">lossage</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,(</span><span class="n">ch</span><span class="p">,</span><span class="n">stroke</span><span class="p">),)</span>
    <span class="c">#@+node:ekr.20061031131434.180: *4* k.traceBinding (not used)</span></div>
<div class="viewcode-block" id="keyHandlerClass.traceBinding"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.traceBinding">[docs]</a>    <span class="k">def</span> <span class="nf">traceBinding</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">si</span><span class="p">,</span><span class="n">shortcut</span><span class="p">,</span><span class="n">w</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">gui</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getBool</span><span class="p">(</span><span class="s">&#39;trace_bindings&#39;</span><span class="p">):</span> <span class="k">return</span>

        <span class="n">theFilter</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getString</span><span class="p">(</span><span class="s">&#39;trace_bindings_filter&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">theFilter</span> <span class="ow">and</span> <span class="n">shortcut</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">theFilter</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">pane_filter</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getString</span><span class="p">(</span><span class="s">&#39;trace_bindings_pane_filter&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pane_filter</span> <span class="ow">or</span> <span class="n">pane_filter</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">si</span><span class="o">.</span><span class="n">pane</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">si</span><span class="o">.</span><span class="n">pane</span><span class="p">,</span><span class="n">shortcut</span><span class="p">,</span><span class="n">si</span><span class="o">.</span><span class="n">commandName</span><span class="p">,</span><span class="n">gui</span><span class="o">.</span><span class="n">widget_name</span><span class="p">(</span><span class="n">w</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20061031131434.181: *3* k.Shortcuts &amp; bindings</span>
    <span class="c">#@+node:ekr.20061031131434.176: *4* k.computeInverseBindingDict</span></div>
<div class="viewcode-block" id="keyHandlerClass.computeInverseBindingDict"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.computeInverseBindingDict">[docs]</a>    <span class="k">def</span> <span class="nf">computeInverseBindingDict</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c"># keys are minibuffer command names, values are shortcuts.</span>
        <span class="k">for</span> <span class="n">stroke</span> <span class="ow">in</span> <span class="n">k</span><span class="o">.</span><span class="n">bindingsDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isStroke</span><span class="p">(</span><span class="n">stroke</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">stroke</span><span class="p">)</span>
            <span class="n">aList</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">bindingsDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stroke</span><span class="p">,[])</span>
            <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isShortcutInfo</span><span class="p">(</span><span class="n">si</span><span class="p">),</span><span class="n">si</span>
                <span class="n">shortcutList</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">si</span><span class="o">.</span><span class="n">commandName</span><span class="p">,[])</span>

                <span class="c"># The shortcutList consists of tuples (pane,stroke).</span>
                <span class="c"># k.inverseBindingDict has values consisting of these tuples.</span>
                <span class="n">aList</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">bindingsDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stroke</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">ShortcutInfo</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;dummy&#39;</span><span class="p">,</span><span class="n">pane</span><span class="o">=</span><span class="s">&#39;all&#39;</span><span class="p">))</span>
                        <span class="c"># Important: only si.pane is required below.</span>
                <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isShortcutInfo</span><span class="p">(</span><span class="n">si</span><span class="p">),</span><span class="n">si</span>
                    <span class="n">pane</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">:&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">si</span><span class="o">.</span><span class="n">pane</span><span class="p">)</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">pane</span><span class="p">,</span><span class="n">stroke</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">data</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">shortcutList</span><span class="p">:</span>
                        <span class="n">shortcutList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

                <span class="n">d</span> <span class="p">[</span><span class="n">si</span><span class="o">.</span><span class="n">commandName</span><span class="p">]</span> <span class="o">=</span> <span class="n">shortcutList</span>

        <span class="k">return</span> <span class="n">d</span>
    <span class="c">#@+node:ekr.20061031131434.179: *4* k.getShortcutForCommand/Name</span></div>
<div class="viewcode-block" id="keyHandlerClass.getShortcutForCommandName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.getShortcutForCommandName">[docs]</a>    <span class="k">def</span> <span class="nf">getShortcutForCommandName</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">commandName</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">commandsDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">commandName</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">command</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">stroke</span> <span class="ow">in</span> <span class="n">k</span><span class="o">.</span><span class="n">bindingsDict</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isStroke</span><span class="p">(</span><span class="n">stroke</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">stroke</span><span class="p">)</span>
                <span class="n">aList</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">bindingsDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stroke</span><span class="p">,[])</span>
                <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isShortcutInfo</span><span class="p">(</span><span class="n">si</span><span class="p">),</span><span class="n">si</span>
                    <span class="k">if</span> <span class="n">si</span><span class="o">.</span><span class="n">commandName</span> <span class="o">==</span> <span class="n">commandName</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">stroke</span>
        <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="keyHandlerClass.getShortcutForCommand"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.getShortcutForCommand">[docs]</a>    <span class="k">def</span> <span class="nf">getShortcutForCommand</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">command</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">command</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">stroke</span> <span class="ow">in</span> <span class="n">k</span><span class="o">.</span><span class="n">bindingsDict</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isStroke</span><span class="p">(</span><span class="n">stroke</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">stroke</span><span class="p">)</span>
                <span class="n">aList</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">bindingsDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stroke</span><span class="p">,[])</span>
                <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isShortcutInfo</span><span class="p">(</span><span class="n">si</span><span class="p">),</span><span class="n">si</span>
                    <span class="k">if</span> <span class="n">si</span><span class="o">.</span><span class="n">commandName</span> <span class="o">==</span> <span class="n">command</span><span class="o">.</span><span class="n">__name__</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">stroke</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20090518072506.8494: *4* k.isFKey</span></div>
<div class="viewcode-block" id="keyHandlerClass.isFKey"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.isFKey">[docs]</a>    <span class="k">def</span> <span class="nf">isFKey</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">stroke</span><span class="p">):</span>

        <span class="c"># k = self</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">stroke</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>
        <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isString</span><span class="p">(</span><span class="n">stroke</span><span class="p">)</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">isStroke</span><span class="p">(</span><span class="n">stroke</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">stroke</span><span class="o">.</span><span class="n">s</span> <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isStroke</span><span class="p">(</span><span class="n">stroke</span><span class="p">)</span> <span class="k">else</span> <span class="n">stroke</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;f&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20061031131434.182: *4* k.isPlainKey</span></div>
<div class="viewcode-block" id="keyHandlerClass.isPlainKey"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.isPlainKey">[docs]</a>    <span class="k">def</span> <span class="nf">isPlainKey</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">stroke</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return true if the shortcut refers to a plain (non-Alt,non-Ctl) key.&#39;&#39;&#39;</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">stroke</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>

        <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isString</span><span class="p">(</span><span class="n">stroke</span><span class="p">)</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">isStroke</span><span class="p">(</span><span class="n">stroke</span><span class="p">)</span>
        <span class="n">shortcut</span> <span class="o">=</span> <span class="n">stroke</span><span class="o">.</span><span class="n">s</span> <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isStroke</span><span class="p">(</span><span class="n">stroke</span><span class="p">)</span> <span class="k">else</span> <span class="n">stroke</span>

        <span class="c"># altgr combos (Alt+Ctrl) are always plain keys</span>
        <span class="k">if</span> <span class="n">shortcut</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;Alt+Ctrl+&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_alt_ctrl_bindings</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;Alt&#39;</span><span class="p">,</span><span class="s">&#39;Ctrl&#39;</span><span class="p">,</span><span class="s">&#39;Command&#39;</span><span class="p">,</span><span class="s">&#39;Meta&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">shortcut</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>            
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Careful, allow bare angle brackets for unit tests.</span>
            <span class="k">if</span> <span class="n">shortcut</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;&lt;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">shortcut</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;&gt;&#39;</span><span class="p">):</span>
                <span class="n">shortcut</span> <span class="o">=</span> <span class="n">shortcut</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">isPlain</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">shortcut</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">guiBindNamesInverseDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">shortcut</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span>
                <span class="c"># A hack: allow Return to be bound to command.</span>
                <span class="n">shortcut</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;Tab&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c"># g.trace(isPlain,repr(shortcut))</span>
            <span class="k">return</span> <span class="n">isPlain</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isFKey</span><span class="p">(</span><span class="n">shortcut</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20061031131434.191: *4* k.prettyPrintKey</span></div>
<div class="viewcode-block" id="keyHandlerClass.prettyPrintKey"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.prettyPrintKey">[docs]</a>    <span class="k">def</span> <span class="nf">prettyPrintKey</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">stroke</span><span class="p">,</span><span class="n">brief</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">stroke</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">isStroke</span><span class="p">(</span><span class="n">stroke</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">stroke</span><span class="o">.</span><span class="n">s</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">stroke</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#39;&#39;</span>

        <span class="n">shift</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;shift&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;shft&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>

        <span class="c"># Replace all minus signs by plus signs, except a trailing minus:</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">):</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="s">&#39;+&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;-&#39;</span>
        <span class="k">else</span><span class="p">:</span>               <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="s">&#39;+&#39;</span><span class="p">)</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;+&#39;</span><span class="p">)</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">fields</span> <span class="ow">and</span> <span class="n">fields</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;fields&#39;</span><span class="p">,</span><span class="n">fields</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">last</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">last</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">prev</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">last</span><span class="o">.</span><span class="n">isalpha</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">last</span><span class="o">.</span><span class="n">isupper</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">shift</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">prev</span> <span class="o">+</span> <span class="s">&#39;Shift+&#39;</span> <span class="o">+</span> <span class="n">last</span>
                <span class="k">elif</span> <span class="n">last</span><span class="o">.</span><span class="n">islower</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">prev</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">last</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">prev</span> <span class="o">+</span> <span class="n">last</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">guiBindNamesInverseDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">last</span><span class="p">,</span><span class="n">last</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fields</span> <span class="ow">and</span> <span class="n">fields</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">+</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;+&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fields</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="n">last</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">last</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;Space&#39;</span> <span class="c"># 2010/11/06</span>

        <span class="k">return</span> <span class="n">s</span>
    <span class="c">#@+node:ekr.20061031131434.184: *4* k.strokeFromSetting</span></div>
<div class="viewcode-block" id="keyHandlerClass.strokeFromSetting"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.strokeFromSetting">[docs]</a>    <span class="k">def</span> <span class="nf">strokeFromSetting</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">setting</span><span class="p">,</span><span class="n">addKey</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span> <span class="c"># and setting.lower().find(&#39;ctrl-x&#39;) &gt; -1</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">setting</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isString</span><span class="p">(</span><span class="n">setting</span><span class="p">)</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">stripBrackets</span><span class="p">(</span><span class="n">setting</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="c">#@+&lt;&lt; define cmd, ctrl, alt, shift &gt;&gt;</span>
        <span class="c">#@+node:ekr.20061031131434.185: *5* &lt;&lt; define cmd, ctrl, alt, shift &gt;&gt;</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="n">cmd</span>   <span class="o">=</span> <span class="n">s2</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;cmd&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>     <span class="ow">or</span> <span class="n">s2</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;command&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="n">ctrl</span>  <span class="o">=</span> <span class="n">s2</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;control&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">s2</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;ctrl&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="n">alt</span>   <span class="o">=</span> <span class="n">s2</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;alt&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="n">s2</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;shift&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>   <span class="ow">or</span> <span class="n">s2</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;shft&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="n">meta</span>  <span class="o">=</span> <span class="n">s2</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;meta&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="c">#@-&lt;&lt; define cmd, ctrl, alt, shift &gt;&gt;</span>
        <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">swap_mac_keys</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;darwin&quot;</span><span class="p">:</span>
            <span class="c">#@+&lt;&lt; swap cmd and ctrl keys &gt;&gt;</span>
            <span class="c">#@+node:ekr.20061031131434.186: *5* &lt;&lt; swap cmd and ctrl keys &gt;&gt;</span>
            <span class="k">if</span> <span class="n">ctrl</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cmd</span><span class="p">:</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">;</span> <span class="n">ctrl</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="n">alt</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ctrl</span><span class="p">:</span>
                <span class="n">ctrl</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">;</span> <span class="n">alt</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="c">#@-&lt;&lt; swap cmd and ctrl keys &gt;&gt;</span>
        <span class="c">#@+&lt;&lt; convert minus signs to plus signs &gt;&gt;</span>
        <span class="c">#@+node:ekr.20061031131434.187: *5* &lt;&lt; convert minus signs to plus signs &gt;&gt;</span>
        <span class="c"># Replace all minus signs by plus signs, except a trailing minus:</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="s">&#39;+&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;-&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="s">&#39;+&#39;</span><span class="p">)</span>
        <span class="c">#@-&lt;&lt; convert minus signs to plus signs &gt;&gt;</span>
        <span class="c">#@+&lt;&lt; compute the last field &gt;&gt;</span>
        <span class="c">#@+node:ekr.20061031131434.188: *5* &lt;&lt; compute the last field &gt;&gt;</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;+&#39;</span><span class="p">):</span>
            <span class="n">last</span> <span class="o">=</span> <span class="s">&#39;+&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;+&#39;</span><span class="p">)</span> <span class="c"># Don&#39;t lower this field.</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">fields</span> <span class="ow">and</span> <span class="n">fields</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">last</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">menuWarningsGiven</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;bad shortcut specifier:&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">setting</span><span class="p">))</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>
                <span class="k">return</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">last</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">last2</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">guiBindNamesDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">last</span><span class="p">)</span> <span class="c"># Fix new bug introduced in 4.4b2.</span>
            <span class="k">if</span> <span class="n">last2</span><span class="p">:</span>
                <span class="n">last</span> <span class="o">=</span> <span class="n">last2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">last</span><span class="o">.</span><span class="n">isalpha</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">shift</span><span class="p">:</span>
                        <span class="n">last</span> <span class="o">=</span> <span class="n">last</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                        <span class="n">shift</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># It is Ctrl-A, not Ctrl-Shift-A.</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">last</span> <span class="o">=</span> <span class="n">last</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="c"># New in Leo 4.4.2: Alt-2 is not a key event!</span>
                <span class="k">if</span> <span class="n">addKey</span> <span class="ow">and</span> <span class="n">last</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                    <span class="n">last</span> <span class="o">=</span> <span class="s">&#39;Key-&#39;</span> <span class="o">+</span> <span class="n">last</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Translate from a made-up (or lowercase) name to &#39;official&#39; Tk binding name.</span>
            <span class="c"># This is a *one-way* translation, done only here.</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">settingsNameDict</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">last</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span><span class="n">last</span><span class="p">)</span>
        <span class="c">#@-&lt;&lt; compute the last field &gt;&gt;</span>
        <span class="c">#@+&lt;&lt; compute shortcut &gt;&gt;</span>
        <span class="c">#@+node:ekr.20061031131434.189: *5* &lt;&lt; compute shortcut &gt;&gt;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">alt</span><span class="p">,</span> <span class="s">&#39;Alt+&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">ctrl</span><span class="p">,</span><span class="s">&#39;Ctrl+&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&#39;Command+&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">meta</span><span class="p">,</span><span class="s">&#39;Meta+&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">shift</span><span class="p">,</span><span class="s">&#39;Shift+&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">last</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c"># new in 4.4b3: convert all characters to unicode first.</span>
        <span class="n">shortcut</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">g</span><span class="o">.</span><span class="n">toUnicode</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">flag</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">table</span> <span class="k">if</span> <span class="n">flag</span><span class="p">])</span>
        <span class="c">#@-&lt;&lt; compute shortcut &gt;&gt;</span>

        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%20s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">setting</span><span class="p">,</span><span class="n">shortcut</span><span class="p">),</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">KeyStroke</span><span class="p">(</span><span class="n">shortcut</span><span class="p">)</span> <span class="k">if</span> <span class="n">shortcut</span> <span class="k">else</span> <span class="bp">None</span>
</div>
    <span class="n">canonicalizeShortcut</span> <span class="o">=</span> <span class="n">strokeFromSetting</span> <span class="c"># For compatibility.</span>
    <span class="c">### strokeFromSetting = shortcutFromSetting</span>
    <span class="c">#@+node:ekr.20110606004638.16929: *4* k.stroke2char</span>
<div class="viewcode-block" id="keyHandlerClass.stroke2char"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.stroke2char">[docs]</a>    <span class="k">def</span> <span class="nf">stroke2char</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">stroke</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Convert a stroke to an (insertable) char.</span>

<span class="sd">        This method allows Leo to use strokes everywhere.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">stroke</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#39;&#39;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">stroke</span><span class="o">.</span><span class="n">s</span>

        <span class="c"># Allow bare angle brackets for unit tests.</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;&lt;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;&gt;&#39;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="n">s</span>

        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;Alt&#39;</span><span class="p">,</span><span class="s">&#39;Ctrl&#39;</span><span class="p">,</span><span class="s">&#39;Command&#39;</span><span class="p">,</span><span class="s">&#39;Meta&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>            
                <span class="k">return</span> <span class="s">&#39;&#39;</span>
                <span class="c"># This is not accurate: leoQtEventFilter retains</span>
                <span class="c"># the spelling of Alt-Ctrl keys because of the</span>
                <span class="c"># @bool enable_alt_ctrl_bindings setting.</span>

        <span class="c"># Special case the gang of four, plus &#39;Escape&#39;,</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;BackSpace&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="se">\b</span><span class="s">&#39;</span><span class="p">,</span>
            <span class="s">&#39;Escape&#39;</span><span class="p">:</span><span class="s">&#39;Escape&#39;</span><span class="p">,</span>
            <span class="s">&#39;Linefeed&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="se">\r</span><span class="s">&#39;</span><span class="p">,</span>
            <span class="s">&#39;Return&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span>
            <span class="s">&#39;Tab&#39;</span><span class="p">:</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ch</span><span class="p">:</span> <span class="k">return</span> <span class="n">ch</span>

        <span class="c"># First, do the common translations.</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">guiBindNamesInverseDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ch</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">stroke</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">ch</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">ch</span>

        <span class="c"># A much-simplified form of code in k.strokeFromSetting.</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;Shift+&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;Shift-&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;Shift+&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;Shift-&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>

        <span class="n">last</span> <span class="o">=</span> <span class="n">s</span> <span class="c">#  Everything should have been stripped.</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">isalpha</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">shift</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">last</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">last</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="n">val</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">stroke</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="c"># &#39;shift&#39;,shift,</span>
        <span class="k">return</span> <span class="n">val</span>
    <span class="c">#@+node:ekr.20061031131434.193: *3* k.States</span>
    <span class="c">#@+node:ekr.20061031131434.194: *4* clearState</span></div>
<div class="viewcode-block" id="keyHandlerClass.clearState"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.clearState">[docs]</a>    <span class="k">def</span> <span class="nf">clearState</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">k</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">k</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">k</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">handler</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20061031131434.196: *4* getState</span></div>
<div class="viewcode-block" id="keyHandlerClass.getState"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.getState">[docs]</a>    <span class="k">def</span> <span class="nf">getState</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">kind</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">kind</span><span class="p">,</span><span class="n">k</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">n</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="c"># g.trace(state,&#39;returns&#39;,val)</span>
        <span class="k">return</span> <span class="n">val</span>
    <span class="c">#@+node:ekr.20061031131434.195: *4* getStateHandler</span></div>
<div class="viewcode-block" id="keyHandlerClass.getStateHandler"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.getStateHandler">[docs]</a>    <span class="k">def</span> <span class="nf">getStateHandler</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">handler</span>
    <span class="c">#@+node:ekr.20061031131434.197: *4* getStateKind</span></div>
<div class="viewcode-block" id="keyHandlerClass.getStateKind"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.getStateKind">[docs]</a>    <span class="k">def</span> <span class="nf">getStateKind</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">kind</span>
    <span class="c">#@+node:ekr.20061031131434.198: *4* inState</span></div>
<div class="viewcode-block" id="keyHandlerClass.inState"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.inState">[docs]</a>    <span class="k">def</span> <span class="nf">inState</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">kind</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">k</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">kind</span> <span class="ow">and</span> <span class="n">k</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">n</span> <span class="o">!=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">k</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">kind</span> <span class="ow">and</span> <span class="n">k</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">n</span> <span class="o">!=</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20080511122507.4: *4* setDefaultInputState</span></div>
<div class="viewcode-block" id="keyHandlerClass.setDefaultInputState"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.setDefaultInputState">[docs]</a>    <span class="k">def</span> <span class="nf">setDefaultInputState</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">state</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">defaultUnboundKeyAction</span>

        <span class="c"># g.trace(state)</span>

        <span class="n">k</span><span class="o">.</span><span class="n">setInputState</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20110209093958.15411: *4* setEditingState</span></div>
<div class="viewcode-block" id="keyHandlerClass.setEditingState"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.setEditingState">[docs]</a>    <span class="k">def</span> <span class="nf">setEditingState</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">state</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">defaultEditingAction</span>

        <span class="c"># g.trace(state)</span>

        <span class="n">k</span><span class="o">.</span><span class="n">setInputState</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20061031131434.133: *4* setInputState</span></div>
<div class="viewcode-block" id="keyHandlerClass.setInputState"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.setInputState">[docs]</a>    <span class="k">def</span> <span class="nf">setInputState</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">state</span><span class="p">,</span><span class="n">set_border</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="n">c</span><span class="p">,</span><span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">,</span><span class="bp">self</span>
        <span class="n">k</span><span class="o">.</span><span class="n">unboundKeyAction</span> <span class="o">=</span> <span class="n">state</span>

        <span class="k">if</span> <span class="n">set_border</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">bodyCtrl</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="s">&#39;widget&#39;</span><span class="p">):</span>
                <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">add_border</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">w</span><span class="o">.</span><span class="n">widget</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20061031131434.199: *4* setState</span></div>
<div class="viewcode-block" id="keyHandlerClass.setState"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.setState">[docs]</a>    <span class="k">def</span> <span class="nf">setState</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">kind</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">handler</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">kind</span> <span class="ow">and</span> <span class="n">n</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;**** setting </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">kind</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">handler</span> <span class="ow">and</span> <span class="n">handler</span><span class="o">.</span><span class="n">__name__</span><span class="p">),</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>
            <span class="n">k</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="n">kind</span>
            <span class="n">k</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">n</span>
            <span class="k">if</span> <span class="n">handler</span><span class="p">:</span>
                <span class="n">k</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">handler</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;clearing&#39;</span><span class="p">)</span>
            <span class="n">k</span><span class="o">.</span><span class="n">clearState</span><span class="p">()</span>

        <span class="c"># k.showStateAndMode()</span>
    <span class="c">#@+node:ekr.20061031131434.192: *4* k.showStateAndMode</span></div>
<div class="viewcode-block" id="keyHandlerClass.showStateAndMode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.showStateAndMode">[docs]</a>    <span class="k">def</span> <span class="nf">showStateAndMode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">w</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">prompt</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">setFocus</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">unboundKeyAction</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">getStateKind</span><span class="p">()</span>
        <span class="n">inOutline</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">w</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">get_focus</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">w</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">isText</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">isTextWidget</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

        <span class="c"># This fixes a problem with the tk gui plugin.</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">and</span> <span class="n">mode</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;isearch&#39;</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="n">wname</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">widget_name</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="c"># 2011/02/12: get the wrapper for the headline widget.</span>
        <span class="k">if</span> <span class="n">wname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;head&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">tree</span><span class="p">,</span><span class="s">&#39;getWrapper&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="s">&#39;widget&#39;</span><span class="p">):</span> <span class="n">w2</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">widget</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">w2</span> <span class="o">=</span> <span class="n">w</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">getWrapper</span><span class="p">(</span><span class="n">w2</span><span class="p">,</span><span class="n">item</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
                <span class="n">isText</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="c"># A benign hack.</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;state: </span><span class="si">%s</span><span class="s">, text?: </span><span class="si">%s</span><span class="s">, w: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">state</span><span class="p">,</span><span class="n">isText</span><span class="p">,</span><span class="n">w</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">mode</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;getArg&#39;</span><span class="p">,</span><span class="s">&#39;getFileName&#39;</span><span class="p">,</span><span class="s">&#39;full-command&#39;</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">elif</span> <span class="n">prompt</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">prompt</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;-mode&#39;</span><span class="p">):</span>
                    <span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> Mode&#39;</span> <span class="o">%</span> <span class="n">mode</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> State&#39;</span> <span class="o">%</span> <span class="n">state</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">editCommands</span><span class="o">.</span><span class="n">extendMode</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="s">&#39; (Extend Mode)&#39;</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;w&#39;</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="s">&#39;s&#39;</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">k</span><span class="o">.</span><span class="n">setLabelBlue</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">s</span><span class="p">,</span><span class="n">protect</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">w</span> <span class="ow">and</span> <span class="n">isText</span><span class="p">:</span>
            <span class="n">k</span><span class="o">.</span><span class="n">showStateColors</span><span class="p">(</span><span class="n">inOutline</span><span class="p">,</span><span class="n">w</span><span class="p">)</span>
            <span class="n">k</span><span class="o">.</span><span class="n">showStateCursor</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="n">w</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20080512115455.1: *4* k.showStateColors (changed)</span></div>
<div class="viewcode-block" id="keyHandlerClass.showStateColors"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.showStateColors">[docs]</a>    <span class="k">def</span> <span class="nf">showStateColors</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">inOutline</span><span class="p">,</span><span class="n">w</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">use_focus_border</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c"># This is now deprecated.</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">unboundKeyAction</span>
        <span class="k">if</span> <span class="n">state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;insert&#39;</span><span class="p">,</span><span class="s">&#39;command&#39;</span><span class="p">,</span><span class="s">&#39;overwrite&#39;</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;bad input state&#39;</span><span class="p">,</span><span class="n">state</span><span class="p">)</span>

        <span class="n">w_name</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">widget_name</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">w_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;body&#39;</span><span class="p">):</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span>
        <span class="k">elif</span> <span class="n">w_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;head&#39;</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Don&#39;t recolor the minibuffer, log panes, etc.</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;not body or head&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="s">&#39;insert&#39;</span><span class="p">:</span>
            <span class="n">bg</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">insert_mode_bg_color</span>
            <span class="n">fg</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">insert_mode_fg_color</span>
        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="s">&#39;command&#39;</span><span class="p">:</span>
            <span class="n">bg</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">command_mode_bg_color</span>
            <span class="n">fg</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">command_mode_fg_color</span>
        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="s">&#39;overwrite&#39;</span><span class="p">:</span>
            <span class="n">bg</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">overwrite_mode_bg_color</span>
            <span class="n">fg</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">overwrite_mode_fg_color</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bg</span> <span class="o">=</span> <span class="n">fg</span> <span class="o">=</span> <span class="s">&#39;red&#39;</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="s">&#39;setEditorColors&#39;</span><span class="p">):</span>
            <span class="c"># Note: fg color has no effect on Qt at present.</span>
            <span class="n">w</span><span class="o">.</span><span class="n">setEditorColors</span><span class="p">(</span><span class="n">bg</span><span class="o">=</span><span class="n">bg</span><span class="p">,</span><span class="n">fg</span><span class="o">=</span><span class="n">fg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">w</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">bg</span><span class="o">=</span><span class="n">bg</span><span class="p">,</span><span class="n">fg</span><span class="o">=</span><span class="n">fg</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span> <span class="c"># g.es_exception()</span>
    <span class="c">#@+node:ekr.20110202111105.15439: *4* showStateCursor</span></div>
<div class="viewcode-block" id="keyHandlerClass.showStateCursor"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.showStateCursor">[docs]</a>    <span class="k">def</span> <span class="nf">showStateCursor</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">state</span><span class="p">,</span><span class="n">w</span><span class="p">):</span>

        <span class="c"># g.trace(state,w)</span>

        <span class="k">pass</span>


    <span class="c">#@+node:ekr.20061031131434.200: *3* k.universalDispatcher &amp; helpers</span></div>
<div class="viewcode-block" id="keyHandlerClass.universalDispatcher"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.universalDispatcher">[docs]</a>    <span class="k">def</span> <span class="nf">universalDispatcher</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Handle accumulation of universal argument.&#39;&#39;&#39;</span>

        <span class="c">#@+&lt;&lt; about repeat counts &gt;&gt;</span>
        <span class="c">#@+node:ekr.20061031131434.201: *4* &lt;&lt; about repeat counts &gt;&gt;</span>
        <span class="c">#@@nocolor</span>

        <span class="c">#@+at  Any Emacs command can be given a numeric argument. Some commands interpret the</span>
        <span class="c"># argument as a repetition count. For example, giving an argument of ten to the</span>
        <span class="c"># key C-f (the command forward-char, move forward one character) moves forward ten</span>
        <span class="c"># characters. With these commands, no argument is equivalent to an argument of</span>
        <span class="c"># one. Negative arguments are allowed. Often they tell a command to move or act</span>
        <span class="c"># backwards.</span>
        <span class="c"># </span>
        <span class="c"># If your keyboard has a META key, the easiest way to specify a numeric argument</span>
        <span class="c"># is to type digits and/or a minus sign while holding down the the META key. For</span>
        <span class="c"># example,</span>
        <span class="c"># </span>
        <span class="c"># M-5 C-n</span>
        <span class="c"># </span>
        <span class="c"># moves down five lines. The characters Meta-1, Meta-2, and so on, as well as</span>
        <span class="c"># Meta--, do this because they are keys bound to commands (digit-argument and</span>
        <span class="c"># negative-argument) that are defined to contribute to an argument for the next</span>
        <span class="c"># command.</span>
        <span class="c"># </span>
        <span class="c"># Another way of specifying an argument is to use the C-u (universal-argument)</span>
        <span class="c"># command followed by the digits of the argument. With C-u, you can type the</span>
        <span class="c"># argument digits without holding down shift keys. To type a negative argument,</span>
        <span class="c"># start with a minus sign. Just a minus sign normally means -1. C-u works on all</span>
        <span class="c"># terminals.</span>
        <span class="c"># </span>
        <span class="c"># C-u followed by a character which is neither a digit nor a minus sign has the</span>
        <span class="c"># special meaning of &quot;multiply by four&quot;. It multiplies the argument for the next</span>
        <span class="c"># command by four. C-u twice multiplies it by sixteen. Thus, C-u C-u C-f moves</span>
        <span class="c"># forward sixteen characters. This is a good way to move forward &quot;fast&quot;, since it</span>
        <span class="c"># moves about 1/5 of a line in the usual size screen. Other useful combinations</span>
        <span class="c"># are C-u C-n, C-u C-u C-n (move down a good fraction of a screen), C-u C-u C-o</span>
        <span class="c"># (make &quot;a lot&quot; of blank lines), and C-u C-k (kill four lines).</span>
        <span class="c"># </span>
        <span class="c"># Some commands care only about whether there is an argument and not about its</span>
        <span class="c"># value. For example, the command M-q (fill-paragraph) with no argument fills</span>
        <span class="c"># text; with an argument, it justifies the text as well. (See section Filling</span>
        <span class="c"># Text, for more information on M-q.) Just C-u is a handy way of providing an</span>
        <span class="c"># argument for such commands.</span>
        <span class="c"># </span>
        <span class="c"># Some commands use the value of the argument as a repeat count, but do something</span>
        <span class="c"># peculiar when there is no argument. For example, the command C-k (kill-line)</span>
        <span class="c"># with argument n kills n lines, including their terminating newlines. But C-k</span>
        <span class="c"># with no argument is special: it kills the text up to the next newline, or, if</span>
        <span class="c"># point is right at the end of the line, it kills the newline itself. Thus, two</span>
        <span class="c"># C-k commands with no arguments can kill a non-blank line, just like C-k with an</span>
        <span class="c"># argument of one. (See section Deletion and Killing, for more information on</span>
        <span class="c"># C-k.)</span>
        <span class="c"># </span>
        <span class="c"># A few commands treat a plain C-u differently from an ordinary argument. A few</span>
        <span class="c"># others may treat an argument of just a minus sign differently from an argument</span>
        <span class="c"># of -1. These unusual cases will be described when they come up; they are always</span>
        <span class="c"># to make the individual command more convenient to use.</span>
        <span class="c">#@-&lt;&lt; about repeat counts &gt;&gt;</span>
        <span class="n">c</span><span class="p">,</span><span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">,</span><span class="bp">self</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">getState</span><span class="p">(</span><span class="s">&#39;u-arg&#39;</span><span class="p">)</span>
        <span class="n">stroke</span> <span class="o">=</span> <span class="n">event</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">stroke</span> <span class="ow">or</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">k</span><span class="o">.</span><span class="n">dispatchEvent</span> <span class="o">=</span> <span class="n">event</span>
            <span class="c"># The call should set the label.</span>
            <span class="n">k</span><span class="o">.</span><span class="n">setState</span><span class="p">(</span><span class="s">&#39;u-arg&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="o">.</span><span class="n">universalDispatcher</span><span class="p">)</span>
            <span class="n">k</span><span class="o">.</span><span class="n">repeatCount</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c"># stroke = k.stroke # Warning: k.stroke is always Alt-u</span>
            <span class="n">char</span> <span class="o">=</span> <span class="n">event</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">char</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
            <span class="c"># g.trace(state,char)</span>
            <span class="k">if</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;Escape&#39;</span><span class="p">:</span>
                <span class="n">k</span><span class="o">.</span><span class="n">keyboardQuit</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="n">k</span><span class="o">.</span><span class="n">universalArgKey</span><span class="p">:</span>
                <span class="n">k</span><span class="o">.</span><span class="n">repeatCount</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">repeatCount</span> <span class="o">*</span> <span class="mi">4</span>
            <span class="k">elif</span> <span class="n">char</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">or</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;-&#39;</span><span class="p">:</span>
                <span class="n">k</span><span class="o">.</span><span class="n">updateLabel</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">char</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="s">&#39;Alt_L&#39;</span><span class="p">,</span><span class="s">&#39;Alt_R&#39;</span><span class="p">,</span>
                <span class="s">&#39;Control_L&#39;</span><span class="p">,</span><span class="s">&#39;Control_R&#39;</span><span class="p">,</span>
                <span class="s">&#39;Meta_L&#39;</span><span class="p">,</span><span class="s">&#39;Meta_R&#39;</span><span class="p">,</span>
                <span class="s">&#39;Shift_L&#39;</span><span class="p">,</span><span class="s">&#39;Shift_R&#39;</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="n">k</span><span class="o">.</span><span class="n">updateLabel</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># *Anything* other than C-u, &#39;-&#39; or a numeral is taken to be a command.</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">getLabel</span><span class="p">(</span><span class="n">ignorePrompt</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>                <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">*</span> <span class="n">k</span><span class="o">.</span><span class="n">repeatCount</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>  <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">k</span><span class="o">.</span><span class="n">clearState</span><span class="p">()</span>
                <span class="n">event</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">dispatchEvent</span>
                <span class="n">k</span><span class="o">.</span><span class="n">executeNTimes</span><span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
                <span class="n">k</span><span class="o">.</span><span class="n">keyboardQuit</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">k</span><span class="o">.</span><span class="n">doControlU</span><span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="n">stroke</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20061031131434.202: *4* k.executeNTimes</span></div>
<div class="viewcode-block" id="keyHandlerClass.executeNTimes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.executeNTimes">[docs]</a>    <span class="k">def</span> <span class="nf">executeNTimes</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span><span class="p">,</span><span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">,</span><span class="bp">self</span>

        <span class="n">w</span> <span class="o">=</span> <span class="n">event</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">widget</span>

        <span class="n">stroke</span> <span class="o">=</span> <span class="n">event</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">stroke</span> <span class="ow">or</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">stroke</span><span class="p">:</span> <span class="k">return</span>

        <span class="k">if</span> <span class="n">stroke</span> <span class="o">==</span> <span class="n">k</span><span class="o">.</span><span class="n">fullCommandKey</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="n">k</span><span class="o">.</span><span class="n">fullCommand</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">si</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">getPaneBinding</span><span class="p">(</span><span class="n">stroke</span><span class="p">,</span><span class="n">event</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">widget</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">si</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isShortcutInfo</span><span class="p">(</span><span class="n">si</span><span class="p">),</span><span class="n">si</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;repeat&#39;</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="s">&#39;method&#39;</span><span class="p">,</span><span class="n">si</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span>
                    <span class="s">&#39;stroke&#39;</span><span class="p">,</span><span class="n">stroke</span><span class="p">,</span><span class="s">&#39;widget&#39;</span><span class="p">,</span><span class="n">w</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                    <span class="n">event</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">create_key_event</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="n">stroke</span><span class="p">,</span><span class="n">w</span><span class="p">)</span>
                    <span class="n">k</span><span class="o">.</span><span class="n">masterCommand</span><span class="p">(</span><span class="n">commandName</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">,</span><span class="n">func</span><span class="o">=</span><span class="n">si</span><span class="o">.</span><span class="n">func</span><span class="p">,</span><span class="n">stroke</span><span class="o">=</span><span class="n">stroke</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                    <span class="n">k</span><span class="o">.</span><span class="n">masterKeyHandler</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20061031131434.203: *4* doControlU</span></div>
<div class="viewcode-block" id="keyHandlerClass.doControlU"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.keyHandlerClass.doControlU">[docs]</a>    <span class="k">def</span> <span class="nf">doControlU</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">,</span><span class="n">stroke</span><span class="p">):</span>

        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">c</span>

        <span class="n">ch</span> <span class="o">=</span> <span class="n">event</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">char</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>

        <span class="n">k</span><span class="o">.</span><span class="n">setLabelBlue</span><span class="p">(</span><span class="s">&#39;Control-u </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">g</span><span class="o">.</span><span class="n">stripBrackets</span><span class="p">(</span><span class="n">stroke</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;(&#39;</span><span class="p">:</span>
            <span class="n">k</span><span class="o">.</span><span class="n">clearState</span><span class="p">()</span>
            <span class="n">k</span><span class="o">.</span><span class="n">resetLabel</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">macroCommands</span><span class="o">.</span><span class="n">startKbdMacro</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">macroCommands</span><span class="o">.</span><span class="n">callLastKeyboardMacro</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="c">#@-others</span>
<span class="c">#@+node:ekr.20120208064440.10148: ** class ModeController</span></div></div>
<div class="viewcode-block" id="ModeController"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.ModeController">[docs]</a><span class="k">class</span> <span class="nc">ModeController</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># Keys are command names, values are modes.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">k</span>
        <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&lt;ModeController </span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">()</span>

    <span class="n">__str__</span> <span class="o">=</span> <span class="n">__repr__</span>

    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20120208064440.10161: *3* addModeCommands (ModeController)</span>
<div class="viewcode-block" id="ModeController.addModeCommands"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.ModeController.addModeCommands">[docs]</a>    <span class="k">def</span> <span class="nf">addModeCommands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">mode</span><span class="o">.</span><span class="n">createModeCommand</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20120208064440.10163: *3* getMode (ModeController)</span></div>
<div class="viewcode-block" id="ModeController.getMode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.ModeController.getMode">[docs]</a>    <span class="k">def</span> <span class="nf">getMode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">modeName</span><span class="p">):</span>

        <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">modeName</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">modeName</span><span class="p">,</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mode</span>

    <span class="c">#@+node:ekr.20120208064440.10164: *3* makeMode (ModeController)</span></div>
<div class="viewcode-block" id="ModeController.makeMode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.ModeController.makeMode">[docs]</a>    <span class="k">def</span> <span class="nf">makeMode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">aList</span><span class="p">):</span>


        <span class="n">mode</span> <span class="o">=</span> <span class="n">ModeInfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">aList</span><span class="p">)</span>

        <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">mode</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">mode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">mode</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mode</span>

    <span class="c">#@-others</span>
<span class="c">#@+node:ekr.20120208064440.10150: ** class ModeInfo</span></div></div>
<div class="viewcode-block" id="ModeInfo"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.ModeInfo">[docs]</a><span class="k">class</span> <span class="nc">ModeInfo</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&lt;ModeInfo </span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="n">__str__</span> <span class="o">=</span> <span class="n">__repr__</span>

    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20120208064440.10193: *3*  ctor (ModeInfo)</span>
    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">aList</span><span class="p">):</span>

        <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">aList</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># The bindings in effect for this mode.</span>
            <span class="c"># Keys are names of (valid) command names, values are ShortcutInfo objects.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entryCommands</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c"># A list of ShortcutInfo objects.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computeModeName</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computeModePrompt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">aList</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20120208064440.10152: *3* computeModeName (ModeInfo)</span>
<div class="viewcode-block" id="ModeInfo.computeModeName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.ModeInfo.computeModeName">[docs]</a>    <span class="k">def</span> <span class="nf">computeModeName</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">j</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;mode&#39;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;::&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="c"># The actual mode name is everything up to the &quot;::&quot;</span>
            <span class="c"># The prompt is everything after the prompt.</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">s</span> <span class="o">+</span> <span class="s">&#39;-mode&#39;</span>
    <span class="c">#@+node:ekr.20120208064440.10156: *3* computeModePrompt (ModeInfo)</span></div>
<div class="viewcode-block" id="ModeInfo.computeModePrompt"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.ModeInfo.computeModePrompt">[docs]</a>    <span class="k">def</span> <span class="nf">computeModePrompt</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>

        <span class="k">assert</span> <span class="n">name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;enter-&#39;</span> <span class="o">+</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;-&#39;</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;::&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="c"># The prompt is everything after the &#39;::&#39;</span>
            <span class="n">prompt</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prompt</span> <span class="o">=</span> <span class="n">s</span>

        <span class="k">return</span> <span class="n">prompt</span>
    <span class="c">#@+node:ekr.20120208064440.10160: *3* createModeBindings (ModeInfo) (NOT USED)</span>
    <span class="c">##### k.createModeBindings is used instead????</span>
</div>
<div class="viewcode-block" id="ModeInfo.createModeBindings"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.ModeInfo.createModeBindings">[docs]</a>    <span class="k">def</span> <span class="nf">createModeBindings</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">w</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Create mode bindings for w, a text widget.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">modeName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">for</span> <span class="n">commandName</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">commandsDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">commandName</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">func</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;no such command: </span><span class="si">%s</span><span class="s"> Referenced from </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">commandName</span><span class="p">,</span><span class="n">modeName</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="n">aList</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">commandName</span><span class="p">,[])</span>
            <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isShortcutInfo</span><span class="p">(</span><span class="n">si</span><span class="p">),</span><span class="n">si</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">si</span><span class="p">)</span>
                <span class="n">stroke</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">stroke</span>
                <span class="c"># Important: si.val is canonicalized.</span>
                <span class="k">if</span> <span class="n">stroke</span> <span class="ow">and</span> <span class="n">stroke</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;None&#39;</span><span class="p">,</span><span class="s">&#39;none&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
                            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">widget_name</span><span class="p">(</span><span class="n">w</span><span class="p">),</span> <span class="n">modeName</span><span class="p">,</span>
                            <span class="s">&#39;</span><span class="si">%10s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">stroke</span><span class="p">),</span>
                            <span class="s">&#39;</span><span class="si">%20s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">commandName</span><span class="p">),</span>
                            <span class="n">si</span><span class="o">.</span><span class="n">nextMode</span><span class="p">)</span>

                    <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isStroke</span><span class="p">(</span><span class="n">stroke</span><span class="p">)</span>
                    <span class="n">k</span><span class="o">.</span><span class="n">makeMasterGuiBinding</span><span class="p">(</span><span class="n">stroke</span><span class="p">)</span>

                    <span class="c"># Create the entry for the mode in k.masterBindingsDict.</span>
                    <span class="c"># Important: this is similar, but not the same as k.bindKeyToDict.</span>
                    <span class="c"># Thus, we should **not** call k.bindKey here!</span>
                    <span class="n">d2</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">masterBindingsDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">modeName</span><span class="p">,{})</span>
                    <span class="n">d2</span> <span class="p">[</span><span class="n">stroke</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">ShortcutInfo</span><span class="p">(</span>
                        <span class="n">kind</span> <span class="o">=</span> <span class="s">&#39;mode&lt;</span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">modeName</span><span class="p">),</span> <span class="c"># 2012/01/23</span>
                        <span class="n">commandName</span><span class="o">=</span><span class="n">commandName</span><span class="p">,</span>
                        <span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="p">,</span>
                        <span class="n">nextMode</span><span class="o">=</span><span class="n">si</span><span class="o">.</span><span class="n">nextMode</span><span class="p">,</span>
                        <span class="n">stroke</span><span class="o">=</span><span class="n">stroke</span><span class="p">)</span>
                    <span class="n">k</span><span class="o">.</span><span class="n">masterBindingsDict</span><span class="p">[</span><span class="n">modeName</span><span class="p">]</span> <span class="o">=</span> <span class="n">d2</span>
                    <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">modeName</span><span class="p">,</span><span class="n">d2</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20120208064440.10195: *3* createModeCommand (ModeInfo)</span></div>
<div class="viewcode-block" id="ModeInfo.createModeCommand"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.ModeInfo.createModeCommand">[docs]</a>    <span class="k">def</span> <span class="nf">createModeCommand</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">c</span><span class="p">,</span><span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;enter-&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;-&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">enterModeCallback</span> <span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enterMode</span><span class="p">()</span>

        <span class="n">c</span><span class="o">.</span><span class="n">commandsDict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span> <span class="o">=</span> <span class="n">enterModeCallback</span>
        <span class="n">k</span><span class="o">.</span><span class="n">inverseCommandsDict</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span>

        <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;(ModeInfo)&#39;</span><span class="p">,</span><span class="n">f</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="s">&#39;len(c.commandsDict.keys())&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">commandsDict</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
    <span class="c">#@+node:ekr.20120208064440.10180: *3* enterMode (ModeInfo)</span></div>
<div class="viewcode-block" id="ModeInfo.enterMode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.ModeInfo.enterMode">[docs]</a>    <span class="k">def</span> <span class="nf">enterMode</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;(ModeInfo)&#39;</span><span class="p">)</span>

        <span class="n">c</span><span class="p">,</span><span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span>
        <span class="n">c</span><span class="o">.</span><span class="n">inCommand</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="c"># Allow inner commands in the mode.</span>
        <span class="n">event</span><span class="o">=</span><span class="bp">None</span> <span class="c">####</span>
        <span class="n">k</span><span class="o">.</span><span class="n">generalModeHandler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="n">modeName</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20120208064440.10153: *3* init (ModeInfo) (Can we check command names here??)</span></div>
<div class="viewcode-block" id="ModeInfo.init"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.ModeInfo.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">dataList</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;aList is a list of tuples (commandName,si).&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">modeName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">k</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">si</span> <span class="ow">in</span> <span class="n">dataList</span><span class="p">:</span>

            <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isShortcutInfo</span><span class="p">(</span><span class="n">si</span><span class="p">),</span><span class="n">si</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;entry command&#39;</span><span class="p">,</span><span class="n">si</span><span class="p">)</span>
                <span class="c">#### An entry command: put it in the special *entry-commands* key.</span>
                <span class="c">#### d.add(&#39;*entry-commands*&#39;,si)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">entryCommands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">si</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">si</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c"># A regular shortcut.</span>
                <span class="n">si</span><span class="o">.</span><span class="n">pane</span> <span class="o">=</span> <span class="n">modeName</span>
                <span class="n">aList</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,[])</span>
                <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isShortcutInfo</span><span class="p">(</span><span class="n">z</span><span class="p">),</span><span class="n">z</span>
                <span class="c"># Important: use previous bindings if possible.</span>
                <span class="n">key2</span><span class="p">,</span><span class="n">aList2</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getShortcut</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">aList2</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isShortcutInfo</span><span class="p">(</span><span class="n">z</span><span class="p">),</span><span class="n">z</span>
                <span class="n">aList3</span> <span class="o">=</span> <span class="p">[</span><span class="n">z</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">aList2</span> <span class="k">if</span> <span class="n">z</span><span class="o">.</span><span class="n">pane</span> <span class="o">!=</span> <span class="n">modeName</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">aList3</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;inheriting&#39;</span><span class="p">,[</span><span class="n">si</span><span class="o">.</span><span class="n">val</span> <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="n">aList3</span><span class="p">])</span>
                    <span class="n">aList</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">aList3</span><span class="p">)</span>
                <span class="n">aList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">si</span><span class="p">)</span>
                <span class="n">d</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">aList</span>
    <span class="c">#@+node:ekr.20120208064440.10158: *3* initMode (ModeInfo)</span></div>
<div class="viewcode-block" id="ModeInfo.initMode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoKeys.ModeInfo.initMode">[docs]</a>    <span class="k">def</span> <span class="nf">initMode</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span><span class="p">,</span><span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">k</span>

        <span class="c">####</span>
        <span class="c"># d = g.app.config.modeCommandsDict.get(&#39;enter-&#39;+modeName)</span>
        <span class="c"># if not d:</span>
            <span class="c"># self.badMode(modeName)</span>
            <span class="c"># return</span>
        <span class="c"># else:</span>
            <span class="c"># k.modeBindingsDict = d</span>
            <span class="c"># si = d.get(&#39;*command-prompt*&#39;)</span>
            <span class="c"># if si:</span>
                <span class="c"># prompt = si.kind # A kludge.</span>
            <span class="c"># else:</span>
                <span class="c"># prompt = modeName</span>
            <span class="c"># if trace: g.trace(&#39;modeName&#39;,modeName,prompt,&#39;d.keys()&#39;,list(d.keys()))</span>

        <span class="n">k</span><span class="o">.</span><span class="n">inputModeName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">k</span><span class="o">.</span><span class="n">silentMode</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c">#### aList = d.get(&#39;*entry-commands*&#39;,[])</span>
        <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">entryCommands</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isShortcutInfo</span><span class="p">(</span><span class="n">si</span><span class="p">),</span><span class="n">si</span>
            <span class="n">commandName</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">commandName</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;entry command:&#39;</span><span class="p">,</span><span class="n">commandName</span><span class="p">)</span>
            <span class="n">k</span><span class="o">.</span><span class="n">simulateCommand</span><span class="p">(</span><span class="n">commandName</span><span class="p">)</span>
            <span class="c"># Careful, the command can kill the commander.</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">quitting</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span> <span class="k">return</span>
            <span class="c"># New in Leo 4.5: a startup command can immediately transfer to another mode.</span>
            <span class="k">if</span> <span class="n">commandName</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;enter-&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;redirect to mode&#39;</span><span class="p">,</span><span class="n">commandName</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="c"># Create bindings after we know whether we are in silent mode.</span>
        <span class="c"># w = g.choose(k.silentMode,k.modeWidget,k.w)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">modeWidget</span> <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">silentMode</span> <span class="k">else</span> <span class="n">k</span><span class="o">.</span><span class="n">w</span>
        <span class="n">k</span><span class="o">.</span><span class="n">createModeBindings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">,</span><span class="n">w</span><span class="p">)</span>
        <span class="c">#### self.createModeBindings(w)</span>
        <span class="n">k</span><span class="o">.</span><span class="n">showStateAndMode</span><span class="p">(</span><span class="n">prompt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="c">#@-others</span>

<span class="c">#@-others</span>
<span class="c">#@-leo</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Leo API 4.11dev documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Ed K. Ream.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
  </body>
</html>