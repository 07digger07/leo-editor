<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>leo.core.leoNodes &mdash; Leo API 4.11dev documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '4.11dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Leo API 4.11dev documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Leo API 4.11dev documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for leo.core.leoNodes</h1><div class="highlight"><pre>
<span class="c">#@+leo-ver=5-thin</span>
<span class="c">#@+node:ekr.20031218072017.3320: * @file leoNodes.py</span>
<span class="c">#@@language python</span>
<span class="c">#@@tabwidth -4</span>
<span class="c">#@@pagewidth 70</span>

<span class="n">use_zodb</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c">#@+&lt;&lt; imports &gt;&gt;</span>
<span class="c">#@+node:ekr.20060904165452.1: ** &lt;&lt; imports &gt;&gt; (leoNodes)</span>
<span class="kn">import</span> <span class="nn">leo.core.leoGlobals</span> <span class="kn">as</span> <span class="nn">g</span>

<span class="c"># if g.app and g.app.use_psyco:</span>
    <span class="c"># # g.pr(&quot;enabled psyco classes&quot;,__file__)</span>
    <span class="c"># try: from psyco.classes import *</span>
    <span class="c"># except ImportError: pass</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">itertools</span>

<span class="k">if</span> <span class="n">use_zodb</span><span class="p">:</span>
    <span class="c"># It may be important to import ZODB first.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">ZODB</span>
        <span class="kn">import</span> <span class="nn">ZODB.FileStorage</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">ZODB</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">ZODB</span> <span class="o">=</span> <span class="bp">None</span>



<span class="c">#@-&lt;&lt; imports &gt;&gt;</span>

<span class="c">#@+others</span>
<span class="c">#@+node:ekr.20031218072017.1991: ** class nodeIndices</span>
<span class="c"># Indices are Python dicts containing &#39;id&#39;,&#39;loc&#39;,&#39;time&#39; and &#39;n&#39; keys.</span>

<div class="viewcode-block" id="nodeIndices"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.nodeIndices">[docs]</a><span class="k">class</span> <span class="nc">nodeIndices</span> <span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;A class to implement global node indices (gnx&#39;s).&quot;&quot;&quot;</span>

    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20031218072017.1992: *3* nodeIndices.__init__</span>
    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="nb">id</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;ctor for nodeIndices class&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">userId</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaultId</span> <span class="o">=</span> <span class="nb">id</span>

        <span class="c"># A Major simplification: Only assign the timestamp once.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setTimeStamp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastIndex</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c">#@+node:ekr.20031218072017.1993: *3* areEqual (no longer used)</span>
<div class="viewcode-block" id="nodeIndices.areEqual"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.nodeIndices.areEqual">[docs]</a>    <span class="k">def</span> <span class="nf">areEqual</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">gnx1</span><span class="p">,</span><span class="n">gnx2</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Return True if all fields of gnx1 and gnx2 are equal&quot;&quot;&quot;</span>

        <span class="c"># works whatever the format of gnx1 and gnx2.</span>
        <span class="c"># This should never throw an exception.</span>
        <span class="k">return</span> <span class="n">gnx1</span> <span class="o">==</span> <span class="n">gnx2</span>
    <span class="c">#@+node:ekr.20031218072017.1994: *3* get/setDefaultId</span>
    <span class="c"># These are used by the fileCommands read/write code.</span>
</div>
<div class="viewcode-block" id="nodeIndices.getDefaultId"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.nodeIndices.getDefaultId">[docs]</a>    <span class="k">def</span> <span class="nf">getDefaultId</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Return the id to be used by default in all gnx&#39;s&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaultId</span>
</div>
<div class="viewcode-block" id="nodeIndices.setDefaultId"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.nodeIndices.setDefaultId">[docs]</a>    <span class="k">def</span> <span class="nf">setDefaultId</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">theId</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Set the id to be used by default in all gnx&#39;s&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaultId</span> <span class="o">=</span> <span class="n">theId</span>
    <span class="c">#@+node:ekr.20031218072017.1995: *3* getNewIndex</span></div>
<div class="viewcode-block" id="nodeIndices.getNewIndex"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.nodeIndices.getNewIndex">[docs]</a>    <span class="k">def</span> <span class="nf">getNewIndex</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Create a new gnx.&#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lastIndex</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">userId</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">timeString</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">lastIndex</span><span class="p">)</span>
        <span class="c"># g.trace(d)</span>
        <span class="k">return</span> <span class="n">d</span>
    <span class="c">#@+node:ekr.20031218072017.1996: *3* isGnx (not used)</span></div>
<div class="viewcode-block" id="nodeIndices.isGnx"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.nodeIndices.isGnx">[docs]</a>    <span class="k">def</span> <span class="nf">isGnx</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">gnx</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">theId</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">gnx</span>
            <span class="k">return</span> <span class="n">t</span> <span class="o">!=</span> <span class="bp">None</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20031218072017.1997: *3* scanGnx</span></div>
<div class="viewcode-block" id="nodeIndices.scanGnx"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.nodeIndices.scanGnx">[docs]</a>    <span class="k">def</span> <span class="nf">scanGnx</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Create a gnx from its string representation&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">isString</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;scanGnx: unexpected index type:&quot;</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">),</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="n">theId</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span>
        <span class="n">i</span><span class="p">,</span><span class="n">theId</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_to_char</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;.&#39;</span><span class="p">):</span>
            <span class="n">i</span><span class="p">,</span><span class="n">t</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_to_char</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;.&#39;</span><span class="p">):</span>
                <span class="n">i</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_to_char</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
        <span class="c"># Use self.defaultId for missing id entries.</span>
        <span class="k">if</span> <span class="n">theId</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">theId</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">theId</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaultId</span>
        <span class="c"># Convert n to int.</span>
        <span class="k">if</span> <span class="n">n</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span> <span class="k">pass</span>

        <span class="k">return</span> <span class="n">theId</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">n</span>
    <span class="c">#@+node:ekr.20031218072017.1998: *3* setTimeStamp</span></div>
<div class="viewcode-block" id="nodeIndices.setTimestamp"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.nodeIndices.setTimestamp">[docs]</a>    <span class="k">def</span> <span class="nf">setTimestamp</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Set the timestamp string to be used by getNewIndex until further notice&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">timeString</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span>
            <span class="s">&quot;%Y%m</span><span class="si">%d</span><span class="s">%H%M%S&quot;</span><span class="p">,</span> <span class="c"># Help comparisons; avoid y2k problems.</span>
            <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">())</span>

        <span class="c"># g.trace(self.timeString,self.lastIndex,g.callers(4))</span>
</div>
    <span class="n">setTimeStamp</span> <span class="o">=</span> <span class="n">setTimestamp</span>
    <span class="c">#@+node:ekr.20031218072017.1999: *3* toString</span>
<div class="viewcode-block" id="nodeIndices.toString"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.nodeIndices.toString">[docs]</a>    <span class="k">def</span> <span class="nf">toString</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">index</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Convert a gnx (a tuple) to its string representation&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">theId</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">index</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,):</span>
                <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">theId</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">.</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">theId</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;unusual gnx&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">index</span><span class="p">),</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span> 
            <span class="k">try</span><span class="p">:</span>
                <span class="n">theId</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNewIndex</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,):</span>
                    <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">theId</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">.</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">theId</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;double exception: returning original index&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
    <span class="c">#@-others</span>
<span class="c">#@+node:ekr.20031218072017.889: ** class position</span>
<span class="c">#@+&lt;&lt; about the position class &gt;&gt;</span>
<span class="c">#@+node:ekr.20031218072017.890: *3* &lt;&lt; about the position class &gt;&gt;</span>
<span class="c">#@@killcolor</span>
<span class="c">#@+at</span>
<span class="c"># </span>
<span class="c"># A position marks the spot in a tree traversal. A position p consists of a vnode</span>
<span class="c"># p.v, a child index p._childIndex, and a stack of tuples (v,childIndex), one for</span>
<span class="c"># each ancestor **at the spot in tree traversal. Positions p has a unique set of</span>
<span class="c"># parents.</span>
<span class="c"># </span>
<span class="c"># The p.moveToX methods may return a null (invalid) position p with p.v = None.</span>
<span class="c"># </span>
<span class="c"># The tests &quot;if p&quot; or &quot;if not p&quot; are the _only_ correct way to test whether a</span>
<span class="c"># position p is valid. In particular, tests like &quot;if p is None&quot; or &quot;if p is not</span>
<span class="c"># None&quot; will not work properly.</span>
<span class="c">#@-&lt;&lt; about the position class &gt;&gt;</span>

<span class="c"># Positions should *never* be saved by the ZOBD.</span></div></div>
<div class="viewcode-block" id="position"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position">[docs]</a><span class="k">class</span> <span class="nc">position</span> <span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20040228094013: *3*  p.ctor &amp; other special methods...</span>
    <span class="c">#@+node:ekr.20080416161551.190: *4*  p.__init__</span>
    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">childIndex</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">stack</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">trace</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Create a new position with the given childIndex and parent stack.&#39;&#39;&#39;</span>

        <span class="c"># To support ZODB the code must set v._p_changed = 1</span>
        <span class="c"># whenever any mutable vnode object changes.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_childIndex</span> <span class="o">=</span> <span class="n">childIndex</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">v</span>

        <span class="c"># New in Leo 4.5: stack entries are tuples (v,childIndex).</span>
        <span class="k">if</span> <span class="n">stack</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[:]</span> <span class="c"># Creating a copy here is safest and best.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">positions</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">txtOffset</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># see self.textOffset()</span>
    <span class="c">#@+node:ekr.20080920052058.3: *4* p.__eq__ &amp; __ne__</span>
    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p2</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Return True if two postions are equivalent.&quot;&quot;&quot;</span>

        <span class="n">p1</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># Don&#39;t use g.trace: it might call p.__eq__ or p.__ne__.</span>
        <span class="c"># print (&#39;p.__eq__: %s %s&#39; % (</span>
            <span class="c"># p1 and p1.v and p1.h,p2 and p2.v and p2.h))</span>

        <span class="k">if</span> <span class="n">p2</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">p2</span><span class="o">.</span><span class="n">v</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">p1</span><span class="o">.</span><span class="n">v</span> <span class="ow">is</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span> <span class="n">p1</span><span class="o">.</span><span class="n">v</span> <span class="o">==</span> <span class="n">p2</span><span class="o">.</span><span class="n">v</span> <span class="ow">and</span>
                <span class="n">p1</span><span class="o">.</span><span class="n">_childIndex</span> <span class="o">==</span> <span class="n">p2</span><span class="o">.</span><span class="n">_childIndex</span> <span class="ow">and</span>
                <span class="n">p1</span><span class="o">.</span><span class="n">stack</span> <span class="o">==</span> <span class="n">p2</span><span class="o">.</span><span class="n">stack</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p2</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Return True if two postions are not equivalent.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__eq__</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span> <span class="c"># For possible use in Python 2.x.</span>
    <span class="c">#@+node:ekr.20091210082012.6230: *4* p.__ge__ &amp; __le__&amp; __lt__</span>
    <span class="k">def</span> <span class="nf">__ge__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">__gt__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__le__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">__lt__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__lt__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>

        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__gt__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20091210082012.6233: *4* p.__gt__</span>
    <span class="k">def</span> <span class="nf">__gt__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return True if self appears after other in outline order.&#39;&#39;&#39;</span>

        <span class="n">stack1</span><span class="p">,</span><span class="n">stack2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">,</span><span class="n">other</span><span class="o">.</span><span class="n">stack</span>
        <span class="n">n1</span><span class="p">,</span><span class="n">n2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack1</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">stack2</span><span class="p">)</span> <span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">)</span>
        <span class="c"># Compare the common part of the stacks.</span>
        <span class="k">for</span> <span class="n">item1</span><span class="p">,</span><span class="n">item2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">stack1</span><span class="p">,</span><span class="n">stack2</span><span class="p">):</span>
            <span class="n">v1</span><span class="p">,</span><span class="n">x1</span> <span class="o">=</span> <span class="n">item1</span> <span class="p">;</span> <span class="n">v2</span><span class="p">,</span><span class="n">x2</span> <span class="o">=</span> <span class="n">item2</span>
            <span class="k">if</span> <span class="n">x1</span> <span class="o">&gt;</span> <span class="n">x2</span><span class="p">:</span> <span class="k">return</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">x1</span> <span class="o">&lt;</span> <span class="n">x2</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>
        <span class="c"># Finish the comparison.</span>
        <span class="k">if</span> <span class="n">n1</span> <span class="o">==</span> <span class="n">n2</span><span class="p">:</span>
            <span class="n">x1</span><span class="p">,</span><span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_childIndex</span><span class="p">,</span><span class="n">other</span><span class="o">.</span><span class="n">_childIndex</span>
            <span class="k">return</span> <span class="n">x1</span> <span class="o">&gt;</span> <span class="n">x2</span>
        <span class="k">elif</span> <span class="n">n1</span> <span class="o">&lt;</span> <span class="n">n2</span><span class="p">:</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_childIndex</span><span class="p">;</span> <span class="n">v2</span><span class="p">,</span><span class="n">x2</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">x1</span> <span class="o">&gt;</span> <span class="n">x2</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># n1 &gt; n2</span>
            <span class="c"># 2011/07/28: Bug fix suggested by SegundoBob.</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">_childIndex</span><span class="p">;</span> <span class="n">v2</span><span class="p">,</span><span class="n">x2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">x2</span> <span class="o">&gt;=</span> <span class="n">x1</span>
    <span class="c">#@+node:ekr.20040117170612: *4* p.__getattr__ (no longer used)</span>
    <span class="c"># No longer used.  All code must now be aware of the one-node world.</span>

    <span class="c"># def __getattr__ (self,attr):</span>

        <span class="c"># &quot;&quot;&quot;Convert references to p.t into references to p.v.&quot;&quot;&quot;</span>

        <span class="c"># if attr==&quot;t&quot;:</span>
            <span class="c"># return self.v</span>
        <span class="c"># else:</span>
            <span class="c"># # New in 4.3: _silently_ raise the attribute error.</span>
            <span class="c"># # This allows plugin code to use hasattr(p,attr) !</span>
            <span class="c"># if 0:</span>
                <span class="c"># print(&quot;unknown position attribute: %s&quot; % attr)</span>
                <span class="c"># import traceback ; traceback.print_stack()</span>
            <span class="c"># raise AttributeError(attr)</span>
    <span class="c">#@+node:ekr.20040117173448: *4* p.__nonzero__ &amp; __bool__</span>
    <span class="c">#@+at</span>
    <span class="c"># Tests such as &#39;if p&#39; or &#39;if not p&#39; are the _only_ correct ways to test</span>
    <span class="c"># whether a position p is valid. In particular, tests like &#39;if p is</span>
    <span class="c"># None&#39; or &#39;if p is not None&#39; will not work properly.</span>
    <span class="c">#@@c</span>

    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">__bool__</span> <span class="p">(</span> <span class="bp">self</span><span class="p">):</span>

            <span class="sd">&quot;&quot;&quot;Return True if a position is valid.&quot;&quot;&quot;</span>

            <span class="c"># Tracing this appears to cause unbounded prints.</span>
            <span class="c"># print(&quot;__bool__&quot;,self.v and self.v.cleanHeadString())</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">__nonzero__</span> <span class="p">(</span> <span class="bp">self</span><span class="p">):</span>

            <span class="sd">&quot;&quot;&quot;Return True if a position is valid.&quot;&quot;&quot;</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20040301205720: *4* p.__str__ and p.__repr__</span>
    <span class="k">def</span> <span class="nf">__str__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">:</span>
            <span class="c"># return &quot;&lt;pos %d childIndex: %d lvl: %d [%d] %s&gt;&quot; % (</span>
                <span class="c"># id(p),p._childIndex,p.level(),len(p.stack),p.cleanHeadString())</span>
            <span class="k">return</span> <span class="s">&quot;&lt;pos </span><span class="si">%d</span><span class="s"> childIndex: </span><span class="si">%d</span><span class="s"> lvl: </span><span class="si">%d</span><span class="s"> key: </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">id</span><span class="p">(</span><span class="n">p</span><span class="p">),</span><span class="n">p</span><span class="o">.</span><span class="n">_childIndex</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">level</span><span class="p">(),</span><span class="n">p</span><span class="o">.</span><span class="n">key</span><span class="p">(),</span><span class="n">p</span><span class="o">.</span><span class="n">cleanHeadString</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;&lt;pos </span><span class="si">%d</span><span class="s"> [</span><span class="si">%d</span><span class="s">] None&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">p</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stack</span><span class="p">))</span>

    <span class="n">__repr__</span> <span class="o">=</span> <span class="n">__str__</span>
    <span class="c">#@+node:ekr.20061006092649: *4* p.archivedPosition</span>
<div class="viewcode-block" id="position.archivedPosition"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.archivedPosition">[docs]</a>    <span class="k">def</span> <span class="nf">archivedPosition</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">root_p</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return a representation of a position suitable for use in .leo files.&#39;&#39;&#39;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">root_p</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">aList</span> <span class="o">=</span> <span class="p">[</span><span class="n">z</span><span class="o">.</span><span class="n">_childIndex</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">self_and_parents</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">aList</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">self_and_parents</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">z</span> <span class="o">==</span> <span class="n">root_p</span><span class="p">:</span>
                    <span class="n">aList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">aList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">_childIndex</span><span class="p">)</span>
            <span class="c"># g.trace(aList)</span>

        <span class="n">aList</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">aList</span>
    <span class="c">#@+node:ekr.20040117171654: *4* p.copy</span>
    <span class="c"># Using this routine can generate huge numbers of temporary positions during a tree traversal.</span>
</div>
<div class="viewcode-block" id="position.copy"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;&quot;Return an independent copy of a position.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">position</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_childIndex</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">,</span><span class="n">trace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20040310153624: *4* p.dump</span></div>
<div class="viewcode-block" id="position.dumpLink"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.dumpLink">[docs]</a>    <span class="k">def</span> <span class="nf">dumpLink</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">link</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">link</span><span class="p">,</span><span class="n">link</span><span class="p">,</span><span class="s">&quot;&lt;none&gt;&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="position.dump"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.dump">[docs]</a>    <span class="k">def</span> <span class="nf">dump</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">dump</span><span class="p">()</span> <span class="c"># Don&#39;t print a label</span>
    <span class="c">#@+node:ekr.20080416161551.191: *4* p.key</span></div>
<div class="viewcode-block" id="position.key"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.key">[docs]</a>    <span class="k">def</span> <span class="nf">key</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># For unified nodes we must include a complete key,</span>
        <span class="c"># so we can distinguish between clones.</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">stack</span><span class="p">:</span>
            <span class="n">v</span><span class="p">,</span><span class="n">childIndex</span> <span class="o">=</span> <span class="n">z</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">v</span><span class="p">),</span><span class="n">childIndex</span><span class="p">))</span>

        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">),</span><span class="n">p</span><span class="o">.</span><span class="n">_childIndex</span><span class="p">))</span>

        <span class="k">return</span> <span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20090128083459.74: *3* p.Properties</span>
    <span class="c">#@+node:ekr.20090128083459.75: *4* p.b property</span></div>
    <span class="k">def</span> <span class="nf">__get_b</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">bodyString</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__set_b</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">val</span><span class="p">):</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">context</span>
        <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">setBodyString</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
            <span class="c"># Don&#39;t redraw the screen: p.b must be fast.</span>
            <span class="c"># c.redraw_after_icons_changed()</span>

    <span class="n">b</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span>
        <span class="n">__get_b</span><span class="p">,</span> <span class="n">__set_b</span><span class="p">,</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="s">&quot;position body string property&quot;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20090128083459.76: *4* p.h property</span>
    <span class="k">def</span> <span class="nf">__get_h</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">headString</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__set_h</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">val</span><span class="p">):</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">context</span>
        <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">setHeadString</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>
            <span class="c"># Don&#39;t redraw the screen: p.h must be fast.</span>
            <span class="c"># c.redraw_after_head_changed()</span>

    <span class="n">h</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span>
        <span class="n">__get_h</span><span class="p">,</span> <span class="n">__set_h</span><span class="p">,</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="s">&quot;position headline string property&quot;</span><span class="p">)</span>  
    <span class="c">#@+node:ekr.20090215165030.3: *4* p.gnx property</span>
    <span class="k">def</span> <span class="nf">__get_gnx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">nodeIndices</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">fileIndex</span><span class="p">)</span>

    <span class="n">gnx</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span>
        <span class="n">__get_gnx</span><span class="p">,</span> <span class="c"># __set_gnx,</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="s">&quot;position gnx property&quot;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20040306212636: *3* p.Getters</span>
    <span class="c">#@+node:ekr.20040306210951: *4* p.vnode proxies</span>
    <span class="c">#@+node:ekr.20040306211032: *5* p.Comparisons</span>
<div class="viewcode-block" id="position.anyAtFileNodeName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.anyAtFileNodeName">[docs]</a>    <span class="k">def</span> <span class="nf">anyAtFileNodeName</span>         <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">anyAtFileNodeName</span><span class="p">()</span></div>
<div class="viewcode-block" id="position.atAutoNodeName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.atAutoNodeName">[docs]</a>    <span class="k">def</span> <span class="nf">atAutoNodeName</span>            <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">atAutoNodeName</span><span class="p">()</span></div>
<div class="viewcode-block" id="position.atEditNodeName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.atEditNodeName">[docs]</a>    <span class="k">def</span> <span class="nf">atEditNodeName</span>            <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">atEditNodeName</span><span class="p">()</span></div>
<div class="viewcode-block" id="position.atFileNodeName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.atFileNodeName">[docs]</a>    <span class="k">def</span> <span class="nf">atFileNodeName</span>            <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">atFileNodeName</span><span class="p">()</span></div>
<div class="viewcode-block" id="position.atNoSentinelsFileNodeName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.atNoSentinelsFileNodeName">[docs]</a>    <span class="k">def</span> <span class="nf">atNoSentinelsFileNodeName</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">atNoSentinelsFileNodeName</span><span class="p">()</span>
    <span class="c"># def atRawFileNodeName         (self): return self.v.atRawFileNodeName()</span></div>
<div class="viewcode-block" id="position.atShadowFileNodeName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.atShadowFileNodeName">[docs]</a>    <span class="k">def</span> <span class="nf">atShadowFileNodeName</span>      <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">atShadowFileNodeName</span><span class="p">()</span></div>
<div class="viewcode-block" id="position.atSilentFileNodeName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.atSilentFileNodeName">[docs]</a>    <span class="k">def</span> <span class="nf">atSilentFileNodeName</span>      <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">atSilentFileNodeName</span><span class="p">()</span></div>
<div class="viewcode-block" id="position.atThinFileNodeName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.atThinFileNodeName">[docs]</a>    <span class="k">def</span> <span class="nf">atThinFileNodeName</span>        <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">atThinFileNodeName</span><span class="p">()</span>

    <span class="c"># New names, less confusing</span></div>
    <span class="n">atNoSentFileNodeName</span>  <span class="o">=</span> <span class="n">atNoSentinelsFileNodeName</span>
    <span class="n">atAsisFileNodeName</span>    <span class="o">=</span> <span class="n">atSilentFileNodeName</span>

<div class="viewcode-block" id="position.isAnyAtFileNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.isAnyAtFileNode">[docs]</a>    <span class="k">def</span> <span class="nf">isAnyAtFileNode</span>         <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">isAnyAtFileNode</span><span class="p">()</span></div>
<div class="viewcode-block" id="position.isAtAllNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.isAtAllNode">[docs]</a>    <span class="k">def</span> <span class="nf">isAtAllNode</span>             <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">isAtAllNode</span><span class="p">()</span></div>
<div class="viewcode-block" id="position.isAtAutoNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.isAtAutoNode">[docs]</a>    <span class="k">def</span> <span class="nf">isAtAutoNode</span>            <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">isAtAutoNode</span><span class="p">()</span></div>
<div class="viewcode-block" id="position.isAtAutoOtlNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.isAtAutoOtlNode">[docs]</a>    <span class="k">def</span> <span class="nf">isAtAutoOtlNode</span>         <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">isAtAutoOtlNode</span><span class="p">()</span></div>
<div class="viewcode-block" id="position.isAtAutoRstNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.isAtAutoRstNode">[docs]</a>    <span class="k">def</span> <span class="nf">isAtAutoRstNode</span>         <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">isAtAutoRstNode</span><span class="p">()</span></div>
<div class="viewcode-block" id="position.isAtEditNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.isAtEditNode">[docs]</a>    <span class="k">def</span> <span class="nf">isAtEditNode</span>            <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">isAtEditNode</span><span class="p">()</span></div>
<div class="viewcode-block" id="position.isAtFileNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.isAtFileNode">[docs]</a>    <span class="k">def</span> <span class="nf">isAtFileNode</span>            <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">isAtFileNode</span><span class="p">()</span></div>
<div class="viewcode-block" id="position.isAtIgnoreNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.isAtIgnoreNode">[docs]</a>    <span class="k">def</span> <span class="nf">isAtIgnoreNode</span>          <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">isAtIgnoreNode</span><span class="p">()</span></div>
<div class="viewcode-block" id="position.isAtNoSentinelsFileNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.isAtNoSentinelsFileNode">[docs]</a>    <span class="k">def</span> <span class="nf">isAtNoSentinelsFileNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">isAtNoSentinelsFileNode</span><span class="p">()</span></div>
<div class="viewcode-block" id="position.isAtOthersNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.isAtOthersNode">[docs]</a>    <span class="k">def</span> <span class="nf">isAtOthersNode</span>          <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">isAtOthersNode</span><span class="p">()</span>
    <span class="c"># def isAtRawFileNode         (self): return self.v.isAtRawFileNode()</span></div>
<div class="viewcode-block" id="position.isAtSilentFileNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.isAtSilentFileNode">[docs]</a>    <span class="k">def</span> <span class="nf">isAtSilentFileNode</span>      <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">isAtSilentFileNode</span><span class="p">()</span></div>
<div class="viewcode-block" id="position.isAtShadowFileNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.isAtShadowFileNode">[docs]</a>    <span class="k">def</span> <span class="nf">isAtShadowFileNode</span>      <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">isAtShadowFileNode</span><span class="p">()</span></div>
<div class="viewcode-block" id="position.isAtThinFileNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.isAtThinFileNode">[docs]</a>    <span class="k">def</span> <span class="nf">isAtThinFileNode</span>        <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">isAtThinFileNode</span><span class="p">()</span>

    <span class="c"># New names, less confusing:</span></div>
    <span class="n">isAtNoSentFileNode</span> <span class="o">=</span> <span class="n">isAtNoSentinelsFileNode</span>
    <span class="n">isAtAsisFileNode</span>   <span class="o">=</span> <span class="n">isAtSilentFileNode</span>

    <span class="c"># Utilities.</span>
<div class="viewcode-block" id="position.matchHeadline"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.matchHeadline">[docs]</a>    <span class="k">def</span> <span class="nf">matchHeadline</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pattern</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">matchHeadline</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20040306220230: *5* p.Headline &amp; body strings</span></div>
<div class="viewcode-block" id="position.bodyString"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.bodyString">[docs]</a>    <span class="k">def</span> <span class="nf">bodyString</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">bodyString</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="position.headString"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.headString">[docs]</a>    <span class="k">def</span> <span class="nf">headString</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">headString</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="position.cleanHeadString"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.cleanHeadString">[docs]</a>    <span class="k">def</span> <span class="nf">cleanHeadString</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">cleanHeadString</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20040306214401: *5* p.Status bits</span></div>
<div class="viewcode-block" id="position.isDirty"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.isDirty">[docs]</a>    <span class="k">def</span> <span class="nf">isDirty</span>     <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">isDirty</span><span class="p">()</span></div>
<div class="viewcode-block" id="position.isExpanded"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.isExpanded">[docs]</a>    <span class="k">def</span> <span class="nf">isExpanded</span>  <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">isExpanded</span><span class="p">()</span></div>
<div class="viewcode-block" id="position.isMarked"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.isMarked">[docs]</a>    <span class="k">def</span> <span class="nf">isMarked</span>    <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">isMarked</span><span class="p">()</span></div>
<div class="viewcode-block" id="position.isOrphan"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.isOrphan">[docs]</a>    <span class="k">def</span> <span class="nf">isOrphan</span>    <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">isOrphan</span><span class="p">()</span></div>
<div class="viewcode-block" id="position.isSelected"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.isSelected">[docs]</a>    <span class="k">def</span> <span class="nf">isSelected</span>  <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">isSelected</span><span class="p">()</span></div>
<div class="viewcode-block" id="position.isTopBitSet"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.isTopBitSet">[docs]</a>    <span class="k">def</span> <span class="nf">isTopBitSet</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">isTopBitSet</span><span class="p">()</span></div>
<div class="viewcode-block" id="position.isVisited"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.isVisited">[docs]</a>    <span class="k">def</span> <span class="nf">isVisited</span>   <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">isVisited</span><span class="p">()</span></div>
<div class="viewcode-block" id="position.status"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.status">[docs]</a>    <span class="k">def</span> <span class="nf">status</span>      <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">status</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20040306214240.2: *4* p.children &amp; parents</span>
    <span class="c">#@+node:ekr.20040326064330: *5* p.childIndex</span>
    <span class="c"># This used to be time-critical code.</span>
</div>
<div class="viewcode-block" id="position.childIndex"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.childIndex">[docs]</a>    <span class="k">def</span> <span class="nf">childIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">_childIndex</span>
    <span class="c">#@+node:ekr.20040323160302: *5* p.directParents</span></div>
<div class="viewcode-block" id="position.directParents"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.directParents">[docs]</a>    <span class="k">def</span> <span class="nf">directParents</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">directParents</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20040306214240.3: *5* p.hasChildren &amp; p.numberOfChildren</span></div>
<div class="viewcode-block" id="position.hasChildren"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.hasChildren">[docs]</a>    <span class="k">def</span> <span class="nf">hasChildren</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">children</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</div>
    <span class="n">hasFirstChild</span> <span class="o">=</span> <span class="n">hasChildren</span>

<div class="viewcode-block" id="position.numberOfChildren"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.numberOfChildren">[docs]</a>    <span class="k">def</span> <span class="nf">numberOfChildren</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.915: *4* p.getX &amp; vnode compatibility traversal routines</span>
    <span class="c"># These methods are useful abbreviations.</span>
    <span class="c"># Warning: they make copies of positions, so they should be used _sparingly_</span>
</div>
<div class="viewcode-block" id="position.getBack"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.getBack">[docs]</a>    <span class="k">def</span> <span class="nf">getBack</span>          <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">moveToBack</span><span class="p">()</span></div>
<div class="viewcode-block" id="position.getFirstChild"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.getFirstChild">[docs]</a>    <span class="k">def</span> <span class="nf">getFirstChild</span>    <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">moveToFirstChild</span><span class="p">()</span></div>
<div class="viewcode-block" id="position.getLastChild"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.getLastChild">[docs]</a>    <span class="k">def</span> <span class="nf">getLastChild</span>     <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">moveToLastChild</span><span class="p">()</span></div>
<div class="viewcode-block" id="position.getLastNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.getLastNode">[docs]</a>    <span class="k">def</span> <span class="nf">getLastNode</span>      <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">moveToLastNode</span><span class="p">()</span>
    <span class="c"># def getLastVisible   (self): return self.copy().moveToLastVisible()</span></div>
<div class="viewcode-block" id="position.getNext"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.getNext">[docs]</a>    <span class="k">def</span> <span class="nf">getNext</span>          <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">moveToNext</span><span class="p">()</span></div>
<div class="viewcode-block" id="position.getNodeAfterTree"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.getNodeAfterTree">[docs]</a>    <span class="k">def</span> <span class="nf">getNodeAfterTree</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span></div>
<div class="viewcode-block" id="position.getNthChild"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.getNthChild">[docs]</a>    <span class="k">def</span> <span class="nf">getNthChild</span>    <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">moveToNthChild</span><span class="p">(</span><span class="n">n</span><span class="p">)</span></div>
<div class="viewcode-block" id="position.getParent"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.getParent">[docs]</a>    <span class="k">def</span> <span class="nf">getParent</span>        <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">moveToParent</span><span class="p">()</span></div>
<div class="viewcode-block" id="position.getThreadBack"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.getThreadBack">[docs]</a>    <span class="k">def</span> <span class="nf">getThreadBack</span>    <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">moveToThreadBack</span><span class="p">()</span></div>
<div class="viewcode-block" id="position.getThreadNext"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.getThreadNext">[docs]</a>    <span class="k">def</span> <span class="nf">getThreadNext</span>    <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>

    <span class="c"># New in Leo 4.4.3 b2: add c args.</span></div>
<div class="viewcode-block" id="position.getVisBack"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.getVisBack">[docs]</a>    <span class="k">def</span> <span class="nf">getVisBack</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">moveToVisBack</span><span class="p">(</span><span class="n">c</span><span class="p">)</span></div>
<div class="viewcode-block" id="position.getVisNext"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.getVisNext">[docs]</a>    <span class="k">def</span> <span class="nf">getVisNext</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">moveToVisNext</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

    <span class="c"># These are efficient enough now that iterators are the normal way to traverse the tree!</span>
</div>
    <span class="n">back</span>          <span class="o">=</span> <span class="n">getBack</span>
    <span class="n">firstChild</span>    <span class="o">=</span> <span class="n">getFirstChild</span>
    <span class="n">lastChild</span>     <span class="o">=</span> <span class="n">getLastChild</span>
    <span class="n">lastNode</span>      <span class="o">=</span> <span class="n">getLastNode</span>
    <span class="c"># lastVisible   = getLastVisible # New in 4.2 (was in tk tree code).</span>
    <span class="nb">next</span>          <span class="o">=</span> <span class="n">getNext</span>
    <span class="n">nodeAfterTree</span> <span class="o">=</span> <span class="n">getNodeAfterTree</span>
    <span class="n">nthChild</span>      <span class="o">=</span> <span class="n">getNthChild</span>
    <span class="n">parent</span>        <span class="o">=</span> <span class="n">getParent</span>
    <span class="n">threadBack</span>    <span class="o">=</span> <span class="n">getThreadBack</span>
    <span class="n">threadNext</span>    <span class="o">=</span> <span class="n">getThreadNext</span>
    <span class="n">visBack</span>       <span class="o">=</span> <span class="n">getVisBack</span>
    <span class="n">visNext</span>       <span class="o">=</span> <span class="n">getVisNext</span>

    <span class="c"># New in Leo 4.4.3:</span>
    <span class="n">hasVisBack</span> <span class="o">=</span> <span class="n">visBack</span>
    <span class="n">hasVisNext</span> <span class="o">=</span> <span class="n">visNext</span>
    <span class="c">#@+node:tbrown.20111010104549.26758: *4* p.get_UNL</span>
<div class="viewcode-block" id="position.get_UNL"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.get_UNL">[docs]</a>    <span class="k">def</span> <span class="nf">get_UNL</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_file</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">with_proto</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="n">UNL</span> <span class="o">=</span> <span class="s">&#39;--&gt;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">reversed</span><span class="p">([</span>
            <span class="n">i</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;--&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;--</span><span class="si">%3E</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">self_and_parents</span><span class="p">()</span>
        <span class="p">]))</span>  

        <span class="k">if</span> <span class="n">with_proto</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s">&quot;file://</span><span class="si">%s</span><span class="s">#</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">fileName</span><span class="p">(),</span> <span class="n">UNL</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span> <span class="s">&#39;%20&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">with_file</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">#</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">fileName</span><span class="p">(),</span> <span class="n">UNL</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">UNL</span>
    <span class="c">#@+node:ekr.20080416161551.192: *4* p.hasX</span></div>
<div class="viewcode-block" id="position.hasBack"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.hasBack">[docs]</a>    <span class="k">def</span> <span class="nf">hasBack</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">_childIndex</span> <span class="o">&gt;</span> <span class="mi">0</span>
</div>
<div class="viewcode-block" id="position.hasNext"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.hasNext">[docs]</a>    <span class="k">def</span> <span class="nf">hasNext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">parent_v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">_parentVnode</span><span class="p">()</span>
                <span class="c"># Returns None if p.v is None.</span>
            <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="ow">and</span> <span class="n">parent_v</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">_childIndex</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">parent_v</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;*** Unexpected exception&#39;</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="position.hasParent"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.hasParent">[docs]</a>    <span class="k">def</span> <span class="nf">hasParent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</div>
<div class="viewcode-block" id="position.hasThreadBack"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.hasThreadBack">[docs]</a>    <span class="k">def</span> <span class="nf">hasThreadBack</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">hasParent</span><span class="p">()</span> <span class="ow">or</span> <span class="n">p</span><span class="o">.</span><span class="n">hasBack</span><span class="p">()</span> <span class="c"># Much cheaper than computing the actual value.</span>
    <span class="c">#@+node:ekr.20080416161551.193: *5* hasThreadNext (the only complex hasX method)</span></div>
<div class="viewcode-block" id="position.hasThreadNext"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.hasThreadNext">[docs]</a>    <span class="k">def</span> <span class="nf">hasThreadNext</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">hasChildren</span><span class="p">()</span> <span class="ow">or</span> <span class="n">p</span><span class="o">.</span><span class="n">hasNext</span><span class="p">():</span> <span class="k">return</span> <span class="bp">True</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">while</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">v</span><span class="p">,</span><span class="n">childIndex</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="c"># See how many children v&#39;s parent has.</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">parent_v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">hiddenRootNode</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parent_v</span><span class="p">,</span><span class="n">junk</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parent_v</span><span class="o">.</span><span class="n">children</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">childIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
                <span class="c"># v has a next sibling.</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="n">n</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20060920203352: *4* p.findRootPosition</span></div>
<div class="viewcode-block" id="position.findRootPosition"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.findRootPosition">[docs]</a>    <span class="k">def</span> <span class="nf">findRootPosition</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># 2011/02/25: always use c.rootPosition</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">context</span>
        <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20080416161551.194: *4* p.isAncestorOf</span></div>
<div class="viewcode-block" id="position.isAncestorOf"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.isAncestorOf">[docs]</a>    <span class="k">def</span> <span class="nf">isAncestorOf</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p2</span><span class="p">):</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span>

        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">p2</span><span class="o">.</span><span class="n">stack</span><span class="p">:</span>
            <span class="n">v2</span><span class="p">,</span><span class="n">junk</span> <span class="o">=</span> <span class="n">z</span>
            <span class="k">if</span> <span class="n">v2</span> <span class="o">==</span> <span class="n">v</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20040306215056: *4* p.isCloned</span></div>
<div class="viewcode-block" id="position.isCloned"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.isCloned">[docs]</a>    <span class="k">def</span> <span class="nf">isCloned</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">isCloned</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20040307104131.2: *4* p.isRoot</span></div>
<div class="viewcode-block" id="position.isRoot"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.isRoot">[docs]</a>    <span class="k">def</span> <span class="nf">isRoot</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">return</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">hasParent</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">hasBack</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20080416161551.196: *4* p.isVisible</span></div>
<div class="viewcode-block" id="position.isVisible"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.isVisible">[docs]</a>    <span class="k">def</span> <span class="nf">isVisible</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">limit</span><span class="p">,</span><span class="n">limitIsVisible</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">visLimit</span><span class="p">()</span>
        <span class="n">limit_v</span> <span class="o">=</span> <span class="n">limit</span> <span class="ow">and</span> <span class="n">limit</span><span class="o">.</span><span class="n">v</span> <span class="ow">or</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="o">==</span> <span class="n">limit_v</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;*** at limit&#39;</span><span class="p">,</span><span class="s">&#39;limitIsVisible&#39;</span><span class="p">,</span><span class="n">limitIsVisible</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">limitIsVisible</span>

        <span class="c"># It&#39;s much easier with a full stack.</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">while</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="n">n</span>
            <span class="c"># v,n = p.vParentWithStack(v,p.stack,n)</span>
            <span class="n">v</span><span class="p">,</span><span class="n">junk</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">limit_v</span><span class="p">:</span>  <span class="c"># We are at a descendant of limit.</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;*** descendant of limit&#39;</span><span class="p">,</span>
                    <span class="s">&#39;limitIsVisible&#39;</span><span class="p">,</span><span class="n">limitIsVisible</span><span class="p">,</span>
                    <span class="s">&#39;limit.isExpanded()&#39;</span><span class="p">,</span><span class="n">limit</span><span class="o">.</span><span class="n">isExpanded</span><span class="p">(),</span><span class="s">&#39;v&#39;</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">limitIsVisible</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">limit</span><span class="o">.</span><span class="n">isExpanded</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span> <span class="c"># Ignore the expansion state of @chapter nodes.</span>
                    <span class="k">return</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">isExpanded</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;*** non-limit parent is not expanded:&#39;</span><span class="p">,</span><span class="n">v</span><span class="o">.</span><span class="n">_headString</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="n">n</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">assert</span> <span class="n">progress</span> <span class="o">&gt;</span> <span class="n">n</span>

        <span class="k">return</span> <span class="bp">True</span>
    <span class="c">#@+node:ekr.20080416161551.197: *4* p.level &amp; simpleLevel</span></div>
<div class="viewcode-block" id="position.level"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.level">[docs]</a>    <span class="k">def</span> <span class="nf">level</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the number of p&#39;s parents.&#39;&#39;&#39;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span>
</div>
    <span class="n">simpleLevel</span> <span class="o">=</span> <span class="n">level</span>
    <span class="c">#@+node:ekr.20111005152227.15566: *4* p.positionAfterDeletedTree</span>
<div class="viewcode-block" id="position.positionAfterDeletedTree"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.positionAfterDeletedTree">[docs]</a>    <span class="k">def</span> <span class="nf">positionAfterDeletedTree</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the position corresponding to p.nodeAfterTree() after this node is</span>
<span class="sd">        deleted. This will be p.nodeAfterTree() unless p.next() exists.</span>

<span class="sd">        This method allows scripts to traverse an outline, deleting nodes during the</span>
<span class="sd">        traversal. The pattern is::</span>

<span class="sd">            p = c.rootPosition()</span>
<span class="sd">            while p:</span>
<span class="sd">            if &lt;delete p?&gt;:</span>
<span class="sd">                next = p.positionAfterDeletedTree()</span>
<span class="sd">                p.doDelete()</span>
<span class="sd">                p = next</span>
<span class="sd">            else:</span>
<span class="sd">                p.moveToThreadNext()</span>

<span class="sd">        This method also allows scripts to *move* nodes during a traversal, **provided**</span>
<span class="sd">        that nodes are moved to a &quot;safe&quot; spot so that moving a node does not change the</span>
<span class="sd">        position of any other nodes.</span>

<span class="sd">        For example, the move-marked-nodes command first creates a **move node**, called</span>
<span class="sd">        &#39;Clones of marked nodes&#39;. All moved nodes become children of this move node.</span>
<span class="sd">        **Inserting** these nodes as children of the &quot;move node&quot; does not change the</span>
<span class="sd">        positions of other nodes. **Deleting** these nodes *may* change the position of</span>
<span class="sd">        nodes, but the pattern above handles this complication cleanly.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="nb">next</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">next</span><span class="p">:</span>
            <span class="c"># The new position will be the same as p, except for p.v.</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="nb">next</span><span class="o">.</span><span class="n">v</span>
            <span class="k">return</span> <span class="n">p</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">nodeAfterTree</span><span class="p">()</span>
    <span class="c">#@+node:shadow.20080825171547.2: *4* p.textOffset</span></div>
<div class="viewcode-block" id="position.textOffset"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.textOffset">[docs]</a>    <span class="k">def</span> <span class="nf">textOffset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            See http://tinyurl.com/5nescw for details</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># caching of p.textOffset, we need to calculate it only once</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">txtOffset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">txtOffset</span>

        <span class="n">p</span><span class="o">.</span><span class="n">txtOffset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c"># walk back from the current position</span>
        <span class="k">for</span> <span class="n">cursor</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">self_and_parents</span><span class="p">():</span>
            <span class="c"># we also need the parent, the &quot;text offset&quot; is relative to it</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">parent</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> <span class="c"># root reached</span>
                <span class="k">break</span>
            <span class="n">parent_bodyString</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">b</span>
            <span class="k">if</span> <span class="n">parent_bodyString</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span> <span class="c"># organizer node</span>
                <span class="k">continue</span>
            <span class="n">parent_lines</span> <span class="o">=</span> <span class="n">parent_bodyString</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="c"># check out if the cursor node is a section</span>
            <span class="n">cursor_is_section</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">cursor_headString</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">h</span>
            <span class="k">if</span> <span class="n">cursor_headString</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;&lt;&lt;&#39;</span><span class="p">):</span>
                <span class="n">cursor_is_section</span> <span class="o">=</span> <span class="bp">True</span> <span class="c"># section node</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">parent_lines</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cursor_is_section</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="c"># find out the section in the bodyString of the parent</span>
                    <span class="n">pos</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">cursor_headString</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># otherwise find the &quot;@others&quot; directive in the bodyString of the parent</span>
                    <span class="n">pos</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;@others&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c"># break the iteration over lines if something is found </span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">pos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">txtOffset</span> <span class="o">+=</span> <span class="n">pos</span>
            <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">isAnyAtFileNode</span><span class="p">():</span> <span class="c"># do not scan upper</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">txtOffset</span>         
    <span class="c">#@+node:ekr.20040305222924: *3* p.Setters</span>
    <span class="c">#@+node:ekr.20040306220634: *4* p.Vnode proxies</span>
    <span class="c">#@+node:ekr.20040306220634.9: *5* p.Status bits</span>
    <span class="c"># Clone bits are no longer used.</span>
    <span class="c"># Dirty bits are handled carefully by the position class.</span>
</div>
<div class="viewcode-block" id="position.clearMarked"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.clearMarked">[docs]</a>    <span class="k">def</span> <span class="nf">clearMarked</span>  <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">clearMarked</span><span class="p">()</span></div>
<div class="viewcode-block" id="position.clearOrphan"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.clearOrphan">[docs]</a>    <span class="k">def</span> <span class="nf">clearOrphan</span>  <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">clearOrphan</span><span class="p">()</span></div>
<div class="viewcode-block" id="position.clearVisited"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.clearVisited">[docs]</a>    <span class="k">def</span> <span class="nf">clearVisited</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">clearVisited</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="position.contract"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.contract">[docs]</a>    <span class="k">def</span> <span class="nf">contract</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">contract</span><span class="p">()</span></div>
<div class="viewcode-block" id="position.expand"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.expand">[docs]</a>    <span class="k">def</span> <span class="nf">expand</span>   <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">expand</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="position.initExpandedBit"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.initExpandedBit">[docs]</a>    <span class="k">def</span> <span class="nf">initExpandedBit</span>    <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">initExpandedBit</span><span class="p">()</span></div>
<div class="viewcode-block" id="position.initMarkedBit"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.initMarkedBit">[docs]</a>    <span class="k">def</span> <span class="nf">initMarkedBit</span>      <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">initMarkedBit</span><span class="p">()</span></div>
<div class="viewcode-block" id="position.initStatus"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.initStatus">[docs]</a>    <span class="k">def</span> <span class="nf">initStatus</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">initStatus</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="position.setMarked"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.setMarked">[docs]</a>    <span class="k">def</span> <span class="nf">setMarked</span>   <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">setMarked</span><span class="p">()</span></div>
<div class="viewcode-block" id="position.setOrphan"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.setOrphan">[docs]</a>    <span class="k">def</span> <span class="nf">setOrphan</span>   <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">setOrphan</span><span class="p">()</span></div>
<div class="viewcode-block" id="position.setSelected"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.setSelected">[docs]</a>    <span class="k">def</span> <span class="nf">setSelected</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">setSelected</span><span class="p">()</span></div>
<div class="viewcode-block" id="position.setVisited"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.setVisited">[docs]</a>    <span class="k">def</span> <span class="nf">setVisited</span>  <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">setVisited</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20040306220634.8: *5* p.computeIcon &amp; p.setIcon</span></div>
<div class="viewcode-block" id="position.computeIcon"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.computeIcon">[docs]</a>    <span class="k">def</span> <span class="nf">computeIcon</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">computeIcon</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="position.setIcon"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.setIcon">[docs]</a>    <span class="k">def</span> <span class="nf">setIcon</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">pass</span> <span class="c"># Compatibility routine for old scripts</span>
    <span class="c">#@+node:ekr.20040306220634.29: *5* p.setSelection</span></div>
<div class="viewcode-block" id="position.setSelection"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.setSelection">[docs]</a>    <span class="k">def</span> <span class="nf">setSelection</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">start</span><span class="p">,</span><span class="n">length</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">setSelection</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">length</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100303074003.5637: *5* p.restore/saveCursorAndScroll</span></div>
<div class="viewcode-block" id="position.restoreCursorAndScroll"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.restoreCursorAndScroll">[docs]</a>    <span class="k">def</span> <span class="nf">restoreCursorAndScroll</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">restoreCursorAndScroll</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="position.saveCursorAndScroll"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.saveCursorAndScroll">[docs]</a>    <span class="k">def</span> <span class="nf">saveCursorAndScroll</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">saveCursorAndScroll</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20040315034158: *4* p.setBodyString &amp; setHeadString</span></div>
<div class="viewcode-block" id="position.setBodyString"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.setBodyString">[docs]</a>    <span class="k">def</span> <span class="nf">setBodyString</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">setBodyString</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</div>
    <span class="n">initBodyString</span> <span class="o">=</span> <span class="n">setBodyString</span>
    <span class="n">setTnodeText</span> <span class="o">=</span> <span class="n">setBodyString</span>
    <span class="n">scriptSetBodyString</span> <span class="o">=</span> <span class="n">setBodyString</span>

<div class="viewcode-block" id="position.initHeadString"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.initHeadString">[docs]</a>    <span class="k">def</span> <span class="nf">initHeadString</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">initHeadString</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="position.setHeadString"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.setHeadString">[docs]</a>    <span class="k">def</span> <span class="nf">setHeadString</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">initHeadString</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="c"># Note: p.setDirty is expensive.</span>
        <span class="c"># We can&#39;t change this because Leo&#39;s core uses</span>
        <span class="c"># p.setDirty and c.setDirty interchangeably.</span>
        <span class="n">p</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20040312015908: *4* p.Visited bits</span>
    <span class="c">#@+node:ekr.20040306220634.17: *5* p.clearVisitedInTree</span>
    <span class="c"># Compatibility routine for scripts.</span>
</div>
<div class="viewcode-block" id="position.clearVisitedInTree"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.clearVisitedInTree">[docs]</a>    <span class="k">def</span> <span class="nf">clearVisitedInTree</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">self_and_subtree</span><span class="p">():</span>
            <span class="n">p</span><span class="o">.</span><span class="n">clearVisited</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.3388: *5* p.clearAllVisitedInTree</span></div>
<div class="viewcode-block" id="position.clearAllVisitedInTree"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.clearAllVisitedInTree">[docs]</a>    <span class="k">def</span> <span class="nf">clearAllVisitedInTree</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">self_and_subtree</span><span class="p">():</span>
            <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">clearVisited</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">clearWriteBit</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20040305162628: *4* p.Dirty bits</span>
    <span class="c">#@+node:ekr.20040311113514: *5* p.clearDirty</span></div>
<div class="viewcode-block" id="position.clearDirty"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.clearDirty">[docs]</a>    <span class="k">def</span> <span class="nf">clearDirty</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">clearDirty</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20040318125934: *5* p.findAllPotentiallyDirtyNodes</span></div>
<div class="viewcode-block" id="position.findAllPotentiallyDirtyNodes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.findAllPotentiallyDirtyNodes">[docs]</a>    <span class="k">def</span> <span class="nf">findAllPotentiallyDirtyNodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">findAllPotentiallyDirtyNodes</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20040702104823: *5* p.inAtIgnoreRange</span></div>
<div class="viewcode-block" id="position.inAtIgnoreRange"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.inAtIgnoreRange">[docs]</a>    <span class="k">def</span> <span class="nf">inAtIgnoreRange</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Returns True if position p or one of p&#39;s parents is an @ignore node.&quot;&quot;&quot;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">self_and_parents</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtIgnoreNode</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20040303214038: *5* p.setAllAncestorAtFileNodesDirty</span></div>
<div class="viewcode-block" id="position.setAllAncestorAtFileNodesDirty"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.setAllAncestorAtFileNodesDirty">[docs]</a>    <span class="k">def</span> <span class="nf">setAllAncestorAtFileNodesDirty</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">setDescendentsDirty</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># Calculate all nodes that are joined to p or parents of such nodes.</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">findAllPotentiallyDirtyNodes</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">setDescendentsDirty</span><span class="p">:</span>
            <span class="c"># **Important**: only mark _direct_ descendents of nodes.</span>
            <span class="c"># Using the findAllPotentiallyDirtyNodes algorithm would mark way too many nodes.</span>
            <span class="k">for</span> <span class="n">p2</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">subtree</span><span class="p">():</span>
                <span class="c"># Only @thin nodes need to be marked.</span>
                <span class="k">if</span> <span class="n">p2</span><span class="o">.</span><span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nodes</span> <span class="ow">and</span> <span class="n">p2</span><span class="o">.</span><span class="n">isAnyAtFileNode</span><span class="p">():</span>
                        <span class="c"># Bug fix: 2011/07/05: was p2.isAtThinFileNode():</span>
                    <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                <span class="k">print</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">isDirty</span><span class="p">(),</span><span class="n">v</span><span class="o">.</span><span class="n">isAnyAtFileNode</span><span class="p">(),</span><span class="n">v</span><span class="p">)</span>
        <span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">nodes</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">isDirty</span><span class="p">()</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">isAnyAtFileNode</span><span class="p">()]</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dirtyVnodeList</span><span class="p">:</span>
            <span class="n">v</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&quot;position&quot;</span><span class="p">,</span><span class="n">dirtyVnodeList</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">dirtyVnodeList</span>
    <span class="c">#@+node:ekr.20040303163330: *5* p.setDirty</span></div>
<div class="viewcode-block" id="position.setDirty"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.setDirty">[docs]</a>    <span class="k">def</span> <span class="nf">setDirty</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">setDescendentsDirty</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Mark a node and all ancestor @file nodes dirty.&#39;&#39;&#39;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># g.trace(&#39;dirty: %s, setDescendentsDirty: %s&#39; % (</span>
            <span class="c"># p.v.isDirty(),setDescendentsDirty),p.h)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">isDirty</span><span class="p">():</span>
            <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span>
            <span class="n">dirtyVnodeList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>

        <span class="c"># Important: this must be called even if p.v is already dirty.</span>
        <span class="c"># Typing can change the @ignore state!</span>
        <span class="n">dirtyVnodeList2</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">setAllAncestorAtFileNodesDirty</span><span class="p">(</span><span class="n">setDescendentsDirty</span><span class="p">)</span>
        <span class="n">dirtyVnodeList</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">dirtyVnodeList2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dirtyVnodeList</span>
    <span class="c">#@+node:ekr.20040315023430: *3* p.File Conversion</span>
    <span class="c">#@+at</span>
    <span class="c"># - convertTreeToString and moreHead can&#39;t be vnode methods because they uses level().</span>
    <span class="c"># - moreBody could be anywhere: it may as well be a postion method.</span>
    <span class="c">#@+node:ekr.20040315023430.1: *4* p.convertTreeToString</span></div>
<div class="viewcode-block" id="position.convertTreeToString"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.convertTreeToString">[docs]</a>    <span class="k">def</span> <span class="nf">convertTreeToString</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Convert a positions  suboutline to a string in MORE format.&quot;&quot;&quot;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">level1</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">level</span><span class="p">()</span>

        <span class="n">array</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">self_and_subtree</span><span class="p">():</span>
            <span class="n">array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">moreHead</span><span class="p">(</span><span class="n">level1</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="n">body</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">moreBody</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">body</span><span class="p">:</span>
                <span class="n">array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20040315023430.2: *4* p.moreHead</span></div>
<div class="viewcode-block" id="position.moreHead"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.moreHead">[docs]</a>    <span class="k">def</span> <span class="nf">moreHead</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">firstLevel</span><span class="p">,</span><span class="n">useVerticalBar</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Return the headline string in MORE format.&quot;&quot;&quot;</span>

        <span class="c"># useVerticalBar is unused, but it would be useful in over-ridden methods.</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="p">()</span> <span class="o">-</span> <span class="n">firstLevel</span>
        <span class="n">plusMinus</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">hasChildren</span><span class="p">(),</span> <span class="s">&quot;+&quot;</span><span class="p">,</span> <span class="s">&quot;-&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="o">*</span><span class="n">level</span><span class="p">,</span><span class="n">plusMinus</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20040315023430.3: *4* p.moreBody</span>
    <span class="c">#@+at </span>
    <span class="c">#     + test line</span>
    <span class="c">#     - test line</span>
    <span class="c">#     \ test line</span>
    <span class="c">#     test line +</span>
    <span class="c">#     test line -</span>
    <span class="c">#     test line \</span>
    <span class="c">#     More lines...</span>
    <span class="c">#@@c</span>
</div>
<div class="viewcode-block" id="position.moreBody"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.moreBody">[docs]</a>    <span class="k">def</span> <span class="nf">moreBody</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Returns the body string in MORE format.  </span>

<span class="sd">        Inserts a backslash before any leading plus, minus or backslash.&quot;&quot;&quot;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">array</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;+&#39;</span><span class="p">,</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>
            <span class="n">array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20091001141621.6060: *3* p.generators</span>
    <span class="c">#@+node:ekr.20091001141621.6055: *4* p.children</span></div>
<div class="viewcode-block" id="position.children"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.children">[docs]</a>    <span class="k">def</span> <span class="nf">children</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return all children of p.&#39;&#39;&#39;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">firstChild</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">p</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">p</span>
            <span class="n">p</span><span class="o">.</span><span class="n">moveToNext</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">StopIteration</span>

    <span class="c"># Compatibility with old code.</span></div>
    <span class="n">children_iter</span> <span class="o">=</span> <span class="n">children</span>
    <span class="c">#@+node:ekr.20091002083910.6102: *4* p.following_siblings</span>
<div class="viewcode-block" id="position.following_siblings"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.following_siblings">[docs]</a>    <span class="k">def</span> <span class="nf">following_siblings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return all siblings that follow p, not including p.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c"># Always include the original node.</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">p</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">p</span>
            <span class="n">p</span><span class="o">.</span><span class="n">moveToNext</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">StopIteration</span>

    <span class="c"># Compatibility with old code.</span></div>
    <span class="n">following_siblings_iter</span> <span class="o">=</span> <span class="n">following_siblings</span>
    <span class="c">#@+node:ekr.20091002083910.6104: *4* p.nodes</span>
<div class="viewcode-block" id="position.nodes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.nodes">[docs]</a>    <span class="k">def</span> <span class="nf">nodes</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">p</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span>
            <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>

    <span class="c"># Compatibility with old code.</span></div>
    <span class="n">tnodes_iter</span> <span class="o">=</span> <span class="n">nodes</span>
    <span class="n">vnodes_iter</span> <span class="o">=</span> <span class="n">nodes</span>
    <span class="c">#@+node:ekr.20091001141621.6058: *4* p.parents</span>
<div class="viewcode-block" id="position.parents"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.parents">[docs]</a>    <span class="k">def</span> <span class="nf">parents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return all parents of p.&#39;&#39;&#39;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">p</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">p</span>
            <span class="n">p</span><span class="o">.</span><span class="n">moveToParent</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">StopIteration</span>

    <span class="c"># Compatibility with old code.</span></div>
    <span class="n">parents_iter</span> <span class="o">=</span> <span class="n">parents</span>
    <span class="c">#@+node:ekr.20091002083910.6099: *4* p.self_and_parents</span>
<div class="viewcode-block" id="position.self_and_parents"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.self_and_parents">[docs]</a>    <span class="k">def</span> <span class="nf">self_and_parents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return p and all parents of p.&#39;&#39;&#39;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">p</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">p</span>
            <span class="n">p</span><span class="o">.</span><span class="n">moveToParent</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">StopIteration</span>

    <span class="c"># Compatibility with old code.</span></div>
    <span class="n">self_and_parents_iter</span> <span class="o">=</span> <span class="n">self_and_parents</span>
    <span class="c">#@+node:ekr.20091001141621.6057: *4* p.self_and_siblings</span>
<div class="viewcode-block" id="position.self_and_siblings"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.self_and_siblings">[docs]</a>    <span class="k">def</span> <span class="nf">self_and_siblings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return all siblings of p including p.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">p</span><span class="o">.</span><span class="n">hasBack</span><span class="p">():</span>
            <span class="n">p</span><span class="o">.</span><span class="n">moveToBack</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">p</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">p</span>
            <span class="n">p</span><span class="o">.</span><span class="n">moveToNext</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">StopIteration</span>

    <span class="c"># Compatibility with old code.</span></div>
    <span class="n">self_and_siblings_iter</span> <span class="o">=</span> <span class="n">self_and_siblings</span>
    <span class="c">#@+node:ekr.20091001141621.6066: *4* p.self_and_subtree</span>
<div class="viewcode-block" id="position.self_and_subtree"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.self_and_subtree">[docs]</a>    <span class="k">def</span> <span class="nf">self_and_subtree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return p&#39;s entire subtree, including p.&#39;&#39;&#39;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">after</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">nodeAfterTree</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">after</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">p</span>
            <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">StopIteration</span>

    <span class="c"># Compatibility with old code.</span></div>
    <span class="n">self_and_subtree_iter</span> <span class="o">=</span> <span class="n">self_and_subtree</span>
    <span class="c">#@+node:ekr.20091001141621.6056: *4* p.subtree</span>
<div class="viewcode-block" id="position.subtree"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.subtree">[docs]</a>    <span class="k">def</span> <span class="nf">subtree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return all descendants of p, not including p.&#39;&#39;&#39;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">after</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">nodeAfterTree</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">after</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">p</span>
            <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">StopIteration</span>

    <span class="c"># Compatibility with old code.</span></div>
    <span class="n">subtree_iter</span> <span class="o">=</span> <span class="n">subtree</span>
    <span class="c">#@+node:ekr.20091002083910.6105: *4* p.unique_nodes</span>
<div class="viewcode-block" id="position.unique_nodes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.unique_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">unique_nodes</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">after</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">nodeAfterTree</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">after</span><span class="p">:</span> <span class="c"># 2011/05/02</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">StopIteration</span>

    <span class="c"># Compatibility with old code.</span></div>
    <span class="n">unique_tnodes_iter</span> <span class="o">=</span> <span class="n">unique_nodes</span>
    <span class="n">unique_vnodes_iter</span> <span class="o">=</span> <span class="n">unique_nodes</span>
    <span class="c">#@+node:ekr.20091002083910.6103: *4* p.unique_subtree</span>
<div class="viewcode-block" id="position.unique_subtree"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.unique_subtree">[docs]</a>    <span class="k">def</span> <span class="nf">unique_subtree</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return unique positions in p&#39;s entire subtree, including p.&#39;&#39;&#39;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">after</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">nodeAfterTree</span><span class="p">()</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">after</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">p</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">StopIteration</span>

    <span class="c"># Compatibility with old code.</span></div>
    <span class="n">subtree_with_unique_tnodes_iter</span> <span class="o">=</span> <span class="n">unique_subtree</span>
    <span class="n">subtree_with_unique_vnodes_iter</span> <span class="o">=</span> <span class="n">unique_subtree</span>
    <span class="c">#@+node:ekr.20040303175026: *3* p.Moving, Inserting, Deleting, Cloning, Sorting</span>
    <span class="c">#@+node:ekr.20040303175026.8: *4* p.clone</span>
<div class="viewcode-block" id="position.clone"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.clone">[docs]</a>    <span class="k">def</span> <span class="nf">clone</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Create a clone of back.</span>

<span class="sd">        Returns the newly created position.&quot;&quot;&quot;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c"># Do *not* copy the vnode!</span>
        <span class="n">p2</span><span class="o">.</span><span class="n">_linkAfter</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="c"># This should &quot;just work&quot;</span>
        <span class="k">return</span> <span class="n">p2</span>
    <span class="c">#@+node:ekr.20040303175026.9: *4* p.copyTreeAfter, copyTreeTo</span>
    <span class="c"># These used by unit tests and by the group_operations plugin.</span>
</div>
<div class="viewcode-block" id="position.copyTreeAfter"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.copyTreeAfter">[docs]</a>    <span class="k">def</span> <span class="nf">copyTreeAfter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">insertAfter</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">copyTreeFromSelfTo</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">p2</span>
</div>
<div class="viewcode-block" id="position.copyTreeFromSelfTo"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.copyTreeFromSelfTo">[docs]</a>    <span class="k">def</span> <span class="nf">copyTreeFromSelfTo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p2</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">p2</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">_headString</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span>
        <span class="n">p2</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">_bodyString</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span>

        <span class="c"># 2009/10/02: no need to copy arg to iter</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
            <span class="n">child2</span> <span class="o">=</span> <span class="n">p2</span><span class="o">.</span><span class="n">insertAsLastChild</span><span class="p">()</span>
            <span class="n">child</span><span class="o">.</span><span class="n">copyTreeFromSelfTo</span><span class="p">(</span><span class="n">child2</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100802121531.5804: *4* p.deletePositionsInList</span></div>
<div class="viewcode-block" id="position.deletePositionsInList"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.deletePositionsInList">[docs]</a>    <span class="k">def</span> <span class="nf">deletePositionsInList</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aList</span><span class="p">,</span><span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Traverse the tree starting from self until all nodes in aList have been</span>
<span class="sd">        found.</span>

<span class="sd">        This method calls the callback for any position in aList found in the range,</span>
<span class="sd">        excluding any node whose ancestor has already been passed to the callback.</span>

<span class="sd">        The callback takes one explicit argument, p. As usual, the callback can bind</span>
<span class="sd">        values using keyword arguments. The callback may delete p or move p out of</span>
<span class="sd">        the range. The callback **must not** move p within range of the traversal.</span>
<span class="sd">        If no callback is given, this method deletes all found nodes.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">callback</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">callback_f</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                <span class="n">p</span><span class="o">.</span><span class="n">doDelete</span><span class="p">(</span><span class="n">newNode</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">callback_f</span> <span class="o">=</span> <span class="n">callback</span> <span class="c"># To keep pylint happy.</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">aList</span><span class="p">:</span>
            <span class="c"># g.trace(repr(p))</span>
            <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
                <span class="n">aList</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isAncestorOf</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
                        <span class="n">aList</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
                <span class="nb">next</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">nodeAfterTree</span><span class="p">()</span>
                <span class="n">callback_f</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
                <span class="n">p</span> <span class="o">=</span> <span class="nb">next</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20040303175026.2: *4* p.doDelete</span>
    <span class="c">#@+at This is the main delete routine.</span>
    <span class="c"># It deletes the receiver&#39;s entire tree from the screen.</span>
    <span class="c"># Because of the undo command we never actually delete vnodes or tnodes.</span>
    <span class="c">#@@c</span>
</div>
<div class="viewcode-block" id="position.doDelete"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.doDelete">[docs]</a>    <span class="k">def</span> <span class="nf">doDelete</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">newNode</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Deletes position p from the outline.&quot;&quot;&quot;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">p</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span> <span class="c"># Mark @file nodes dirty!</span>

        <span class="c"># Adjust newNode._childIndex if newNode is a following sibling of p.</span>
        <span class="n">sib</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">sib</span><span class="o">.</span><span class="n">hasNext</span><span class="p">():</span>
            <span class="n">sib</span><span class="o">.</span><span class="n">moveToNext</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">sib</span> <span class="o">==</span> <span class="n">newNode</span><span class="p">:</span>
                <span class="n">newNode</span><span class="o">.</span><span class="n">_childIndex</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">break</span>

        <span class="n">p</span><span class="o">.</span><span class="n">_unlink</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20040303175026.3: *4* p.insertAfter</span></div>
<div class="viewcode-block" id="position.insertAfter"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.insertAfter">[docs]</a>    <span class="k">def</span> <span class="nf">insertAfter</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Inserts a new position after self.</span>

<span class="sd">        Returns the newly created position.&quot;&quot;&quot;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">context</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">context</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">p2</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">vnode</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
        <span class="n">p2</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">iconVal</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">p2</span><span class="o">.</span><span class="n">_linkAfter</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">p2</span>
    <span class="c">#@+node:ekr.20040303175026.4: *4* p.insertAsLastChild</span></div>
<div class="viewcode-block" id="position.insertAsLastChild"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.insertAsLastChild">[docs]</a>    <span class="k">def</span> <span class="nf">insertAsLastChild</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Inserts a new vnode as the last child of self.</span>

<span class="sd">        Returns the newly created position.&quot;&quot;&quot;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">numberOfChildren</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">insertAsNthChild</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20040303175026.5: *4* p.insertAsNthChild</span></div>
<div class="viewcode-block" id="position.insertAsNthChild"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.insertAsNthChild">[docs]</a>    <span class="k">def</span> <span class="nf">insertAsNthChild</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Inserts a new node as the the nth child of self.</span>
<span class="sd">        self must have at least n-1 children.</span>

<span class="sd">        Returns the newly created position.&quot;&quot;&quot;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">context</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">context</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">p2</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">vnode</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
        <span class="n">p2</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">iconVal</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">p2</span><span class="o">.</span><span class="n">_linkAsNthChild</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">p2</span>
    <span class="c">#@+node:ekr.20040310062332.1: *4* p.invalidOutline</span></div>
<div class="viewcode-block" id="position.invalidOutline"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.invalidOutline">[docs]</a>    <span class="k">def</span> <span class="nf">invalidOutline</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">hasParent</span><span class="p">():</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">p</span>

        <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">alert</span><span class="p">(</span><span class="s">&quot;invalid outline: </span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">message</span><span class="p">,</span><span class="n">node</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20040303175026.10: *4* p.moveAfter</span></div>
<div class="viewcode-block" id="position.moveAfter"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.moveAfter">[docs]</a>    <span class="k">def</span> <span class="nf">moveAfter</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">a</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Move a position after position a.&quot;&quot;&quot;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span> <span class="c"># Do NOT copy the position!</span>

        <span class="c"># g.trace(&#39;before&#39;,&#39;p&#39;,p,p.stack,&#39;\na&#39;,a,a.stack)</span>

        <span class="n">a</span><span class="o">.</span><span class="n">_adjustPositionBeforeUnlink</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">_unlink</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">_linkAfter</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

        <span class="c"># g.trace(&#39;before&#39;,&#39;p&#39;,p,p.stack,&#39;\na&#39;,a,a.stack)</span>

        <span class="k">return</span> <span class="n">p</span>
    <span class="c">#@+node:ekr.20040306060312: *4* p.moveToFirst/LastChildOf</span></div>
<div class="viewcode-block" id="position.moveToFirstChildOf"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.moveToFirstChildOf">[docs]</a>    <span class="k">def</span> <span class="nf">moveToFirstChildOf</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Move a position to the first child of parent.&quot;&quot;&quot;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span> <span class="c"># Do NOT copy the position!</span>
        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">moveToNthChildOf</span> <span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>  <span class="c"># Major bug fix: 2011/12/04</span>
</div>
<div class="viewcode-block" id="position.moveToLastChildOf"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.moveToLastChildOf">[docs]</a>    <span class="k">def</span> <span class="nf">moveToLastChildOf</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Move a position to the last child of parent.&quot;&quot;&quot;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span> <span class="c"># Do NOT copy the position!</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">numberOfChildren</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span> <span class="o">==</span> <span class="n">parent</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">-=</span> <span class="mi">1</span> <span class="c"># 2011/12/10: Another bug fix.</span>
        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">moveToNthChildOf</span> <span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="c"># Major bug fix: 2011/12/04</span>
    <span class="c">#@+node:ekr.20040303175026.11: *4* p.moveToNthChildOf</span></div>
<div class="viewcode-block" id="position.moveToNthChildOf"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.moveToNthChildOf">[docs]</a>    <span class="k">def</span> <span class="nf">moveToNthChildOf</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Move a position to the nth child of parent.&quot;&quot;&quot;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span> <span class="c"># Do NOT copy the position!</span>

        <span class="n">parent</span><span class="o">.</span><span class="n">_adjustPositionBeforeUnlink</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">_unlink</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">_linkAsNthChild</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">p</span>
    <span class="c">#@+node:ekr.20040303175026.6: *4* p.moveToRoot</span></div>
<div class="viewcode-block" id="position.moveToRoot"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.moveToRoot">[docs]</a>    <span class="k">def</span> <span class="nf">moveToRoot</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">oldRoot</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Moves a position to the root position.</span>

<span class="sd">        Important: oldRoot must the previous root position if it exists.&#39;&#39;&#39;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span> <span class="c"># Do NOT copy the position!</span>
        <span class="k">if</span> <span class="n">oldRoot</span><span class="p">:</span>
            <span class="n">oldRoot</span><span class="o">.</span><span class="n">_adjustPositionBeforeUnlink</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">_unlink</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">_linkAsRoot</span><span class="p">(</span><span class="n">oldRoot</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">p</span>
    <span class="c">#@+node:ekr.20040303175026.13: *4* p.validateOutlineWithParent</span>
    <span class="c"># This routine checks the structure of the receiver&#39;s tree.</span>
</div>
<div class="viewcode-block" id="position.validateOutlineWithParent"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.validateOutlineWithParent">[docs]</a>    <span class="k">def</span> <span class="nf">validateOutlineWithParent</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pv</span><span class="p">):</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">True</span> <span class="c"># optimists get only unpleasant surprises.</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">getParent</span><span class="p">()</span>
        <span class="n">childIndex</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">_childIndex</span>

        <span class="c"># g.trace(p,parent,pv)</span>
        <span class="c">#@+&lt;&lt; validate parent ivar &gt;&gt;</span>
        <span class="c">#@+node:ekr.20040303175026.14: *5* &lt;&lt; validate parent ivar &gt;&gt;</span>
        <span class="k">if</span> <span class="n">parent</span> <span class="o">!=</span> <span class="n">pv</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">invalidOutline</span><span class="p">(</span> <span class="s">&quot;Invalid parent link: &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">parent</span><span class="p">))</span>
        <span class="c">#@-&lt;&lt; validate parent ivar &gt;&gt;</span>
        <span class="c">#@+&lt;&lt; validate childIndex ivar &gt;&gt;</span>
        <span class="c">#@+node:ekr.20040303175026.15: *5* &lt;&lt; validate childIndex ivar &gt;&gt;</span>
        <span class="k">if</span> <span class="n">pv</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">childIndex</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">invalidOutline</span> <span class="p">(</span> <span class="s">&quot;missing childIndex&quot;</span> <span class="o">+</span> <span class="n">childIndex</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="n">childIndex</span> <span class="o">&gt;=</span> <span class="n">pv</span><span class="o">.</span><span class="n">numberOfChildren</span><span class="p">():</span>
                <span class="n">p</span><span class="o">.</span><span class="n">invalidOutline</span> <span class="p">(</span> <span class="s">&quot;missing children entry for index: &quot;</span> <span class="o">+</span> <span class="n">childIndex</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="n">childIndex</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">invalidOutline</span> <span class="p">(</span> <span class="s">&quot;negative childIndex&quot;</span> <span class="o">+</span> <span class="n">childIndex</span> <span class="p">)</span>
        <span class="c">#@-&lt;&lt; validate childIndex ivar &gt;&gt;</span>
        <span class="c">#@+&lt;&lt; validate x ivar &gt;&gt;</span>
        <span class="c">#@+node:ekr.20040303175026.16: *5* &lt;&lt; validate x ivar &gt;&gt;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="ow">and</span> <span class="n">pv</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">invalidOutline</span> <span class="p">(</span> <span class="s">&quot;Empty t&quot;</span> <span class="p">)</span>
        <span class="c">#@-&lt;&lt; validate x ivar &gt;&gt;</span>

        <span class="c"># Recursively validate all the children.</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">validateOutlineWithParent</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="p">:</span> <span class="n">result</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">return</span> <span class="n">result</span>
    <span class="c">#@+node:ekr.20080416161551.199: *3* p.moveToX</span>
    <span class="c">#@+at These routines change self to a new position &quot;in place&quot;.</span>
    <span class="c"># That is, these methods must _never_ call p.copy().</span>
    <span class="c"># </span>
    <span class="c"># When moving to a nonexistent position, these routines simply set p.v = None,</span>
    <span class="c"># leaving the p.stack unchanged. This allows the caller to &quot;undo&quot; the effect of</span>
    <span class="c"># the invalid move by simply restoring the previous value of p.v.</span>
    <span class="c"># </span>
    <span class="c"># These routines all return self on exit so the following kind of code will work:</span>
    <span class="c">#     after = p.copy().moveToNodeAfterTree()</span>
    <span class="c">#@+node:ekr.20080416161551.200: *4* p.moveToBack</span></div>
<div class="viewcode-block" id="position.moveToBack"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.moveToBack">[docs]</a>    <span class="k">def</span> <span class="nf">moveToBack</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Move self to its previous sibling.&quot;&quot;&quot;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">_childIndex</span>

        <span class="n">parent_v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">_parentVnode</span><span class="p">()</span>
            <span class="c"># Returns None if p.v is None.</span>

        <span class="c"># Do not assume n is in range: this is used by positionExists.</span>
        <span class="k">if</span> <span class="n">parent_v</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parent_v</span><span class="o">.</span><span class="n">children</span><span class="p">):</span>
            <span class="n">p</span><span class="o">.</span><span class="n">_childIndex</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">parent_v</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">return</span> <span class="n">p</span>
    <span class="c">#@+node:ekr.20080416161551.201: *4* p.moveToFirstChild</span></div>
<div class="viewcode-block" id="position.moveToFirstChild"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.moveToFirstChild">[docs]</a>    <span class="k">def</span> <span class="nf">moveToFirstChild</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Move a position to it&#39;s first child&#39;s position.&quot;&quot;&quot;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">_childIndex</span><span class="p">),)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">p</span><span class="o">.</span><span class="n">_childIndex</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">return</span> <span class="n">p</span>
    <span class="c">#@+node:ekr.20080416161551.202: *4* p.moveToLastChild</span></div>
<div class="viewcode-block" id="position.moveToLastChild"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.moveToLastChild">[docs]</a>    <span class="k">def</span> <span class="nf">moveToLastChild</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Move a position to it&#39;s last child&#39;s position.&quot;&quot;&quot;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">_childIndex</span><span class="p">),)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">p</span><span class="o">.</span><span class="n">_childIndex</span> <span class="o">=</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">return</span> <span class="n">p</span>
    <span class="c">#@+node:ekr.20080416161551.203: *4* p.moveToLastNode</span></div>
<div class="viewcode-block" id="position.moveToLastNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.moveToLastNode">[docs]</a>    <span class="k">def</span> <span class="nf">moveToLastNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Move a position to last node of its tree.</span>

<span class="sd">        N.B. Returns p if p has no children.&quot;&quot;&quot;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># Huge improvement for 4.2.</span>
        <span class="k">while</span> <span class="n">p</span><span class="o">.</span><span class="n">hasChildren</span><span class="p">():</span>
            <span class="n">p</span><span class="o">.</span><span class="n">moveToLastChild</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">p</span>
    <span class="c">#@+node:ekr.20080416161551.204: *4* p.moveToNext</span></div>
<div class="viewcode-block" id="position.moveToNext"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.moveToNext">[docs]</a>    <span class="k">def</span> <span class="nf">moveToNext</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Move a position to its next sibling.&quot;&quot;&quot;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">_childIndex</span>

        <span class="n">parent_v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">_parentVnode</span><span class="p">()</span>
            <span class="c"># Returns None if p.v is None.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;parent_v&#39;</span><span class="p">,</span><span class="n">parent_v</span><span class="p">,</span><span class="s">&#39;p.v&#39;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="ow">and</span> <span class="n">parent_v</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">parent_v</span><span class="o">.</span><span class="n">children</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">_childIndex</span> <span class="o">=</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">parent_v</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">return</span> <span class="n">p</span>
    <span class="c">#@+node:ekr.20080416161551.205: *4* p.moveToNodeAfterTree</span></div>
<div class="viewcode-block" id="position.moveToNodeAfterTree"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.moveToNodeAfterTree">[docs]</a>    <span class="k">def</span> <span class="nf">moveToNodeAfterTree</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Move a position to the node after the position&#39;s tree.&quot;&quot;&quot;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">while</span> <span class="n">p</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">hasNext</span><span class="p">():</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToNext</span><span class="p">()</span>
                <span class="k">break</span>
            <span class="n">p</span><span class="o">.</span><span class="n">moveToParent</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">p</span>
    <span class="c">#@+node:ekr.20080416161551.206: *4* p.moveToNthChild</span></div>
<div class="viewcode-block" id="position.moveToNthChild"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.moveToNthChild">[docs]</a>    <span class="k">def</span> <span class="nf">moveToNthChild</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">children</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">_childIndex</span><span class="p">),)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="n">p</span><span class="o">.</span><span class="n">_childIndex</span> <span class="o">=</span> <span class="n">n</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">return</span> <span class="n">p</span>
    <span class="c">#@+node:ekr.20080416161551.207: *4* p.moveToParent</span></div>
<div class="viewcode-block" id="position.moveToParent"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.moveToParent">[docs]</a>    <span class="k">def</span> <span class="nf">moveToParent</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Move a position to its parent position.&quot;&quot;&quot;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">stack</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">_childIndex</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">return</span> <span class="n">p</span>
    <span class="c">#@+node:ekr.20080416161551.208: *4* p.moveToThreadBack</span></div>
<div class="viewcode-block" id="position.moveToThreadBack"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.moveToThreadBack">[docs]</a>    <span class="k">def</span> <span class="nf">moveToThreadBack</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Move a position to it&#39;s threadBack position.&quot;&quot;&quot;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">hasBack</span><span class="p">():</span>
            <span class="n">p</span><span class="o">.</span><span class="n">moveToBack</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">moveToLastNode</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">moveToParent</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">p</span>
    <span class="c">#@+node:ekr.20080416161551.209: *4* p.moveToThreadNext</span></div>
<div class="viewcode-block" id="position.moveToThreadNext"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.moveToThreadNext">[docs]</a>    <span class="k">def</span> <span class="nf">moveToThreadNext</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Move a position to threadNext position.&quot;&quot;&quot;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToFirstChild</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">hasNext</span><span class="p">():</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToNext</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToParent</span><span class="p">()</span>
                <span class="k">while</span> <span class="n">p</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">hasNext</span><span class="p">():</span>
                        <span class="n">p</span><span class="o">.</span><span class="n">moveToNext</span><span class="p">()</span>
                        <span class="k">break</span> <span class="c">#found</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">moveToParent</span><span class="p">()</span>
                <span class="c"># not found.</span>

        <span class="k">return</span> <span class="n">p</span>
    <span class="c">#@+node:ekr.20080416161551.210: *4* p.moveToVisBack</span></div>
<div class="viewcode-block" id="position.moveToVisBack"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.moveToVisBack">[docs]</a>    <span class="k">def</span> <span class="nf">moveToVisBack</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Move a position to the position of the previous visible node.&quot;&quot;&quot;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">limit</span><span class="p">,</span><span class="n">limitIsVisible</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">visLimit</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s">&#39;limit&#39;</span><span class="p">,</span><span class="n">limit</span><span class="p">,</span><span class="s">&#39;limitIsVisible&#39;</span><span class="p">,</span><span class="n">limitIsVisible</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;***entry&#39;</span><span class="p">,</span><span class="s">&#39;parent&#39;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">parent</span><span class="p">(),</span><span class="s">&#39;p&#39;</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
        <span class="k">while</span> <span class="n">p</span><span class="p">:</span>
            <span class="c"># Short-circuit if possible.</span>
            <span class="n">back</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">back</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
                <span class="s">&#39;back&#39;</span><span class="p">,</span><span class="n">back</span><span class="p">,</span><span class="s">&#39;hasChildren&#39;</span><span class="p">,</span><span class="nb">bool</span><span class="p">(</span><span class="n">back</span> <span class="ow">and</span> <span class="n">back</span><span class="o">.</span><span class="n">hasChildren</span><span class="p">()),</span>
                <span class="s">&#39;isExpanded&#39;</span><span class="p">,</span><span class="nb">bool</span><span class="p">(</span><span class="n">back</span> <span class="ow">and</span> <span class="n">back</span><span class="o">.</span><span class="n">isExpanded</span><span class="p">()))</span>

            <span class="k">if</span> <span class="n">back</span> <span class="ow">and</span> <span class="n">back</span><span class="o">.</span><span class="n">hasChildren</span><span class="p">()</span> <span class="ow">and</span> <span class="n">back</span><span class="o">.</span><span class="n">isExpanded</span><span class="p">():</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadBack</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">back</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToBack</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToParent</span><span class="p">()</span> <span class="c"># Same as p.moveToThreadBack()</span>
            <span class="c"># if back and (not back.hasChildren() or not back.isExpanded()):</span>
                <span class="c"># p.moveToBack()</span>
            <span class="c"># else:</span>
                <span class="c"># p.moveToThreadBack()</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">parent</span><span class="p">(),</span><span class="n">p</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;**p&#39;</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
                <span class="n">done</span><span class="p">,</span><span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkVisBackLimit</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span><span class="n">limitIsVisible</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;done&#39;</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">val</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isVisible</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;isVisible&#39;</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">p</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># assert not p.</span>
            <span class="k">return</span> <span class="n">p</span>
    <span class="c">#@+node:ekr.20090715145956.6166: *5* checkVisBackLimit</span></div>
<div class="viewcode-block" id="position.checkVisBackLimit"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.checkVisBackLimit">[docs]</a>    <span class="k">def</span> <span class="nf">checkVisBackLimit</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">limit</span><span class="p">,</span><span class="n">limitIsVisible</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return done, return-val&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">context</span>

        <span class="k">if</span> <span class="n">limit</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">limit</span> <span class="o">==</span> <span class="n">p</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;at limit&#39;</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">limitIsVisible</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">isVisible</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
                    <span class="k">return</span> <span class="bp">True</span><span class="p">,</span><span class="n">p</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">True</span><span class="p">,</span><span class="bp">None</span>
                <span class="c">#return True,g.choose(limitIsVisible and p.isVisible(c),p,None)</span>
            <span class="k">elif</span> <span class="n">limit</span><span class="o">.</span><span class="n">isAncestorOf</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">False</span><span class="p">,</span><span class="bp">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;outside limit tree&#39;</span><span class="p">,</span><span class="n">limit</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">True</span><span class="p">,</span><span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span><span class="p">,</span><span class="bp">None</span>
    <span class="c">#@+node:ekr.20080416161551.211: *4* p.moveToVisNext</span></div>
<div class="viewcode-block" id="position.moveToVisNext"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.moveToVisNext">[docs]</a>    <span class="k">def</span> <span class="nf">moveToVisNext</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Move a position to the position of the next visible node.&quot;&quot;&quot;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">limit</span><span class="p">,</span><span class="n">limitIsVisible</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">visLimit</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">p</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;1&#39;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
            <span class="c"># Short-circuit if possible.</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">hasNext</span><span class="p">()</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">hasChildren</span><span class="p">()</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">isExpanded</span><span class="p">():</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToFirstChild</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">hasNext</span><span class="p">():</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToNext</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;2&#39;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p</span><span class="p">:</span>
                <span class="n">done</span><span class="p">,</span><span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkVisNextLimit</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">done</span><span class="p">:</span> <span class="k">return</span> <span class="n">val</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isVisible</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">p</span>
    <span class="c">#@+node:ekr.20090715145956.6167: *5* checkVisNextLimit</span></div>
<div class="viewcode-block" id="position.checkVisNextLimit"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.checkVisNextLimit">[docs]</a>    <span class="k">def</span> <span class="nf">checkVisNextLimit</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">limit</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return done, return-val&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

        <span class="k">if</span> <span class="n">limit</span><span class="p">:</span>
            <span class="c"># Unlike moveToVisBack, being at the limit does not terminate.</span>
            <span class="k">if</span> <span class="n">limit</span> <span class="o">==</span> <span class="n">p</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span>
            <span class="k">elif</span> <span class="n">limit</span><span class="o">.</span><span class="n">isAncestorOf</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">False</span><span class="p">,</span><span class="bp">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;outside limit tree&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">True</span><span class="p">,</span><span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span><span class="p">,</span><span class="bp">None</span>
    <span class="c">#@+node:ekr.20080423062035.1: *3* p.Low level methods</span>
    <span class="c"># These methods are only for the use of low-level code</span>
    <span class="c"># in leoNodes.py, leoFileCommands.py and leoUndo.py.</span>
    <span class="c">#@+node:ekr.20080427062528.4: *4* p._adjustPositionBeforeUnlink</span></div>
    <span class="k">def</span> <span class="nf">_adjustPositionBeforeUnlink</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p2</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Adjust position p before unlinking p2.&#39;&#39;&#39;</span>

        <span class="c"># p will change if p2 is a previous sibling of p or</span>
        <span class="c"># p2 is a previous sibling of any ancestor of p.</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">sib</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;entry&#39;</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;p &#39;</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;p2&#39;</span><span class="p">,</span><span class="n">p2</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;p.stack&#39;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span>

        <span class="c"># A special case for previous siblings.</span>
        <span class="c"># Adjust p._childIndex, not the stack&#39;s childIndex.</span>
        <span class="k">while</span> <span class="n">sib</span><span class="o">.</span><span class="n">hasBack</span><span class="p">():</span>
            <span class="n">sib</span><span class="o">.</span><span class="n">moveToBack</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">sib</span> <span class="o">==</span> <span class="n">p2</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">_childIndex</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;***new index: </span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">stack</span><span class="p">))</span>
                <span class="k">return</span>

        <span class="c"># Adjust p&#39;s stack.</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">;</span> <span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span> <span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">stack</span><span class="p">):</span>
            <span class="n">v</span><span class="p">,</span><span class="n">childIndex</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">p3</span> <span class="o">=</span> <span class="n">position</span><span class="p">(</span><span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span><span class="n">childIndex</span><span class="o">=</span><span class="n">childIndex</span><span class="p">,</span><span class="n">stack</span><span class="o">=</span><span class="n">stack</span><span class="p">[:</span><span class="n">i</span><span class="p">])</span>
            <span class="k">while</span> <span class="n">p3</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p2</span> <span class="o">==</span> <span class="n">p3</span><span class="p">:</span>
                    <span class="c"># 2011/02/25: compare full positions, not just vnodes.</span>
                    <span class="c"># A match with the to-be-moved node.</span>
                    <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">v</span><span class="p">,</span><span class="n">childIndex</span><span class="o">-</span><span class="mi">1</span><span class="p">),)</span>
                    <span class="n">changed</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">break</span> <span class="c"># terminate only the inner loop.</span>
                <span class="n">p3</span><span class="o">.</span><span class="n">moveToBack</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">v</span><span class="p">,</span><span class="n">childIndex</span><span class="p">),)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">changed</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;***new stack: </span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="n">stack</span><span class="p">))</span>
            <span class="n">p</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="n">stack</span>
    <span class="c">#@+node:ekr.20080416161551.214: *4* p._linkAfter</span>
    <span class="k">def</span> <span class="nf">_linkAfter</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p_after</span><span class="p">,</span><span class="n">adjust</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Link self after p_after.&#39;&#39;&#39;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">parent_v</span> <span class="o">=</span> <span class="n">p_after</span><span class="o">.</span><span class="n">_parentVnode</span><span class="p">()</span>
            <span class="c"># Returns None if p.v is None</span>

        <span class="c"># Init the ivars.</span>
        <span class="n">p</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="n">p_after</span><span class="o">.</span><span class="n">stack</span><span class="p">[:]</span>
        <span class="n">p</span><span class="o">.</span><span class="n">_childIndex</span> <span class="o">=</span> <span class="n">p_after</span><span class="o">.</span><span class="n">_childIndex</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c"># Set the links.</span>
        <span class="n">child</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">p_after</span><span class="o">.</span><span class="n">_childIndex</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">child</span><span class="o">.</span><span class="n">_addLink</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">parent_v</span><span class="p">,</span><span class="n">adjust</span><span class="o">=</span><span class="n">adjust</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20080416161551.215: *4* p._linkAsNthChild</span>
    <span class="k">def</span> <span class="nf">_linkAsNthChild</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">adjust</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">parent_v</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">v</span>

        <span class="c"># Init the ivars.</span>
        <span class="n">p</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">stack</span><span class="p">[:]</span>
        <span class="n">p</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">parent_v</span><span class="p">,</span><span class="n">parent</span><span class="o">.</span><span class="n">_childIndex</span><span class="p">),)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">_childIndex</span> <span class="o">=</span> <span class="n">n</span>

        <span class="n">child</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span>
        <span class="n">child</span><span class="o">.</span><span class="n">_addLink</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">parent_v</span><span class="p">,</span><span class="n">adjust</span><span class="o">=</span><span class="n">adjust</span><span class="p">)</span>

    <span class="c">#@+node:ekr.20080416161551.212: *4* p._parentVnode</span>
    <span class="k">def</span> <span class="nf">_parentVnode</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the parent vnode.</span>
<span class="sd">        Return the hiddenRootNode if there is no other parent.&#39;&#39;&#39;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">stack</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">v</span><span class="p">,</span> <span class="n">junk</span> <span class="o">=</span> <span class="n">data</span>
                <span class="k">return</span> <span class="n">v</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">hiddenRootNode</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20080416161551.216: *4* p._linkAsRoot</span>
    <span class="k">def</span> <span class="nf">_linkAsRoot</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">oldRoot</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Link self as the root node.&quot;&quot;&quot;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
        <span class="n">hiddenRootNode</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">hiddenRootNode</span>
        <span class="c"># if oldRoot: oldRootNode = oldRoot.v</span>
        <span class="c"># else:       oldRootNode = None</span>

        <span class="c"># Init the ivars.</span>
        <span class="n">p</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">p</span><span class="o">.</span><span class="n">_childIndex</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">parent_v</span> <span class="o">=</span> <span class="n">hiddenRootNode</span>
        <span class="n">child</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">oldRoot</span><span class="p">:</span> <span class="n">parent_v</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">child</span><span class="o">.</span><span class="n">_addLink</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">parent_v</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">p</span>
    <span class="c">#@+node:ekr.20080416161551.217: *4* p._unlink</span>
    <span class="k">def</span> <span class="nf">_unlink</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Unlink the receiver p from the tree.&#39;&#39;&#39;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">_childIndex</span>
        <span class="n">parent_v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">_parentVnode</span><span class="p">()</span>
            <span class="c"># returns None if p.v is None</span>
        <span class="n">child</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">parent_v</span><span class="p">)</span>

        <span class="c"># Delete the child.</span>
        <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">parent_v</span><span class="o">.</span><span class="n">children</span><span class="p">)</span> <span class="ow">and</span>
            <span class="n">parent_v</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="n">child</span>
        <span class="p">):</span>
            <span class="c"># This is the only call to v._cutlink.</span>
            <span class="n">child</span><span class="o">.</span><span class="n">_cutLink</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">parent_v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">badUnlink</span><span class="p">(</span><span class="n">parent_v</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">child</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20090706171333.6226: *5* p.badUnlink</span>
<div class="viewcode-block" id="position.badUnlink"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.position.badUnlink">[docs]</a>    <span class="k">def</span> <span class="nf">badUnlink</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent_v</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">child</span><span class="p">):</span>

        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">parent_v</span><span class="o">.</span><span class="n">children</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;**can not happen: children[</span><span class="si">%s</span><span class="s">] != p.v&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">))</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;parent_v.children...</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span>
                <span class="n">g</span><span class="o">.</span><span class="n">listToString</span><span class="p">(</span><span class="n">parent_v</span><span class="o">.</span><span class="n">children</span><span class="p">))</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;parent_v&#39;</span><span class="p">,</span><span class="n">parent_v</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;parent_v.children[n]&#39;</span><span class="p">,</span><span class="n">parent_v</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;child&#39;</span><span class="p">,</span><span class="n">child</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;** callers:&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span> <span class="k">assert</span> <span class="bp">False</span><span class="p">,</span> <span class="s">&#39;children[</span><span class="si">%s</span><span class="s">] != p.v&#39;</span>
        <span class="k">else</span><span class="p">:</span>   
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;**can not happen: bad child index: </span><span class="si">%s</span><span class="s">, len(children): </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">n</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">parent_v</span><span class="o">.</span><span class="n">children</span><span class="p">)))</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;parent_v.children...</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span>
                <span class="n">g</span><span class="o">.</span><span class="n">listToString</span><span class="p">(</span><span class="n">parent_v</span><span class="o">.</span><span class="n">children</span><span class="p">))</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;parent_v&#39;</span><span class="p">,</span><span class="n">parent_v</span><span class="p">,</span><span class="s">&#39;child&#39;</span><span class="p">,</span><span class="n">child</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;** callers:&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span> <span class="k">assert</span> <span class="bp">False</span><span class="p">,</span> <span class="s">&#39;bad child index: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="c">#@-others</span>
<span class="c">#@+node:ville.20090311190405.68: ** class poslist</span></div></div>
<div class="viewcode-block" id="poslist"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.poslist">[docs]</a><span class="k">class</span> <span class="nc">poslist</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="c">#@+&lt;&lt; poslist doc &gt;&gt;</span>
    <span class="c">#@+node:bob.20101215134608.5898: *3* &lt;&lt; poslist doc &gt;&gt;</span>
    <span class="c">#@@nocolor-node</span>
    <span class="c">#@+at </span>
    <span class="c"># List of positions </span>
    <span class="c"># </span>
    <span class="c"># Functions find_h() and find_b() both return an instance of poslist.</span>
    <span class="c"># </span>
    <span class="c"># Methods filter_h() and filter_b() refine a poslist.</span>
    <span class="c"># </span>
    <span class="c"># Method children() generates a new poslist by descending one level from</span>
    <span class="c"># all the nodes in a poslist.</span>
    <span class="c"># </span>
    <span class="c"># A chain of poslist method calls must begin with find_h() or find_b().</span>
    <span class="c"># The rest of the chain can be any combination of filter_h(),</span>
    <span class="c"># filter_b(), and children(). For example:</span>
    <span class="c"># </span>
    <span class="c">#     pl = c.find_h(&#39;@file.*py&#39;).children().filter_h(&#39;class.*&#39;).filter_b(&#39;import (.*)&#39;)</span>
    <span class="c"># </span>
    <span class="c"># For each position, pos, in the poslist returned, find_h() and</span>
    <span class="c"># filter_h() set attribute pos.mo to the match object (see Python</span>
    <span class="c"># Regular Expression documentation) for the pattern match.</span>
    <span class="c"># </span>
    <span class="c"># Caution: The pattern given to find_h() or filter_h() must match zero</span>
    <span class="c"># or more characters at the beginning of the headline.</span>
    <span class="c"># </span>
    <span class="c"># For each position, pos, the postlist returned, find_b() and filter_b()</span>
    <span class="c"># set attribute pos.matchiter to an iterator that will return a match</span>
    <span class="c"># object for each of the non-overlapping matches of the pattern in the</span>
    <span class="c"># body of the node.</span>
    <span class="c">#@-&lt;&lt; poslist doc &gt;&gt;</span>

    <span class="c">#@+others</span>
    <span class="c">#@+node:bob.20101215134608.5897: *3* children</span>
<div class="viewcode-block" id="poslist.children"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.poslist.children">[docs]</a>    <span class="k">def</span> <span class="nf">children</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a poslist instance containing pointers to</span>
<span class="sd">        all the immediate children of nodes in poslist self.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">poslist</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">child_p</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child_p</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>            
        <span class="k">return</span> <span class="n">res</span>
    <span class="c">#@+node:ville.20090311190405.69: *3* filter_h</span></div>
<div class="viewcode-block" id="poslist.filter_h"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.poslist.filter_h">[docs]</a>    <span class="k">def</span> <span class="nf">filter_h</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regex</span><span class="p">,</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Find all the nodes in poslist self where zero or more characters at</span>
<span class="sd">        the beginning of the headline match regex</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">poslist</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">mo</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mo</span><span class="p">:</span>
                <span class="n">pc</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">pc</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="n">mo</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>
    <span class="c">#@+node:ville.20090311195550.1: *3* filter_b</span></div>
<div class="viewcode-block" id="poslist.filter_b"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.poslist.filter_b">[docs]</a>    <span class="k">def</span> <span class="nf">filter_b</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regex</span><span class="p">,</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Find all the nodes in poslist self where body matches regex</span>
<span class="sd">        one or more times.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">poslist</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
            <span class="n">t1</span><span class="p">,</span><span class="n">t2</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">tee</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
                    <span class="n">t1</span><span class="o">.</span><span class="n">__next__</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">t1</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="c"># if does not raise StopIteration...</span>
                <span class="n">pc</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">pc</span><span class="o">.</span><span class="n">matchiter</span> <span class="o">=</span> <span class="n">t2</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pc</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="c">#@-others</span>
<span class="c">#@+node:ekr.20031218072017.3341: ** class vnode</span></div></div>
<span class="k">if</span> <span class="n">use_zodb</span> <span class="ow">and</span> <span class="n">ZODB</span><span class="p">:</span>
    <span class="k">class</span> <span class="nc">baseVnode</span> <span class="p">(</span><span class="n">ZODB</span><span class="o">.</span><span class="n">Persistence</span><span class="o">.</span><span class="n">Persistent</span><span class="p">):</span>
        <span class="k">pass</span>
<span class="k">else</span><span class="p">:</span>
<div class="viewcode-block" id="baseVnode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.baseVnode">[docs]</a>    <span class="k">class</span> <span class="nc">baseVnode</span> <span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="vnode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode">[docs]</a><span class="k">class</span> <span class="nc">vnode</span> <span class="p">(</span><span class="n">baseVnode</span><span class="p">):</span>
    <span class="c">#@+&lt;&lt; vnode constants &gt;&gt;</span>
    <span class="c">#@+node:ekr.20031218072017.951: *3* &lt;&lt; vnode constants &gt;&gt;</span>
    <span class="c"># Define the meaning of status bits in new vnodes.</span>

    <span class="c"># Archived...</span>
    <span class="n">clonedBit</span>   <span class="o">=</span> <span class="mh">0x01</span> <span class="c"># True: vnode has clone mark.</span>
    <span class="c"># unused      0x02</span>
    <span class="n">expandedBit</span> <span class="o">=</span> <span class="mh">0x04</span> <span class="c"># True: vnode is expanded.</span>
    <span class="n">markedBit</span>   <span class="o">=</span> <span class="mh">0x08</span> <span class="c"># True: vnode is marked</span>
    <span class="n">orphanBit</span>   <span class="o">=</span> <span class="mh">0x10</span> <span class="c"># True: vnode saved in .leo file, not derived file.</span>
    <span class="n">selectedBit</span> <span class="o">=</span> <span class="mh">0x20</span> <span class="c"># True: vnode is current vnode.</span>
    <span class="n">topBit</span>      <span class="o">=</span> <span class="mh">0x40</span> <span class="c"># True: vnode was top vnode when saved.</span>

    <span class="c"># Not archived...</span>
    <span class="n">richTextBit</span> <span class="o">=</span> <span class="mh">0x080</span> <span class="c"># Determines whether we use &lt;bt&gt; or &lt;btr&gt; tags.</span>
    <span class="n">visitedBit</span>  <span class="o">=</span> <span class="mh">0x100</span>
    <span class="n">dirtyBit</span>    <span class="o">=</span> <span class="mh">0x200</span>
    <span class="n">writeBit</span>    <span class="o">=</span> <span class="mh">0x400</span>
    <span class="c">#@-&lt;&lt; vnode constants &gt;&gt;</span>
    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20031218072017.3342: *3* v.Birth &amp; death</span>
    <span class="c">#@+node:ekr.20031218072017.3344: *4* v.__init</span>
    <span class="c"># To support ZODB, the code must set v._p_changed = 1 whenever</span>
    <span class="c"># v.unknownAttributes or any mutable vnode object changes.</span>

    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">context</span><span class="p">):</span>

        <span class="c"># The primary data: headline and body text.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_headString</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">u</span><span class="p">(</span><span class="s">&#39;newHeadline&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bodyString</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">u</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>

        <span class="c"># Structure data...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># Ordered list of all children of this node.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parents</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># Unordered list of all parents of this node.</span>

        <span class="c"># Other essential data...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fileIndex</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">nodeIndices</span><span class="o">.</span><span class="n">getNewIndex</span><span class="p">()</span>
            <span class="c"># The immutable file index for this vnode.</span>
            <span class="c"># New in Leo 4.6 b2: allocate gnx (fileIndex) immediately.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iconVal</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># The present value of the node&#39;s icon.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusBits</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># status bits</span>

        <span class="c"># v.t no longer exists.  All code must now be aware of the one-node world.</span>
        <span class="c"># self.t = self # For compatibility with scripts and plugins.</span>

        <span class="c"># Information that is never written to any file...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span> <span class="c"># The context containing context.hiddenRootNode.</span>
            <span class="c"># Required so we can compute top-level siblings.</span>
            <span class="c"># It is named .context rather than .c to emphasize its limited usage.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">insertSpot</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># Location of previous insert point.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scrollBarSpot</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># Previous value of scrollbar position.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selectionLength</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># The length of the selected body text.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selectionStart</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># The start of the selected body text.</span>
    <span class="c">#@+node:ekr.20031218072017.3345: *4* v.__repr__ &amp; v.__str__</span>
    <span class="k">def</span> <span class="nf">__repr__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="s">&quot;&lt;vnode </span><span class="si">%d</span><span class="s">:&#39;</span><span class="si">%s</span><span class="s">&#39;&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">cleanHeadString</span><span class="p">())</span>

    <span class="n">__str__</span> <span class="o">=</span> <span class="n">__repr__</span>
    <span class="c">#@+node:ekr.20040312145256: *4* v.dump</span>
<div class="viewcode-block" id="vnode.dumpLink"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.dumpLink">[docs]</a>    <span class="k">def</span> <span class="nf">dumpLink</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">link</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">link</span><span class="p">,</span><span class="n">link</span><span class="p">,</span><span class="s">&quot;&lt;none&gt;&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="vnode.dump"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.dump">[docs]</a>    <span class="k">def</span> <span class="nf">dump</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>

        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;-&#39;</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span><span class="n">label</span><span class="p">,</span><span class="n">v</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;len(parents) </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">parents</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;len(children) </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">children</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;parents </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">g</span><span class="o">.</span><span class="n">listToString</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">parents</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;children</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">g</span><span class="o">.</span><span class="n">listToString</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">children</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20060910100316: *4* v.__hash__ (only for zodb)</span></div>
    <span class="k">if</span> <span class="n">use_zodb</span> <span class="ow">and</span> <span class="n">ZODB</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__hash__</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.3346: *3* v.Comparisons</span>
    <span class="c">#@+node:ekr.20040705201018: *4* v.findAtFileName</span>
<div class="viewcode-block" id="vnode.findAtFileName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.findAtFileName">[docs]</a>    <span class="k">def</span> <span class="nf">findAtFileName</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">names</span><span class="p">,</span><span class="n">h</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Return the name following one of the names in nameList.</span>
<span class="sd">        Return an empty string.&quot;&quot;&quot;</span>

        <span class="c"># Allow h argument for unit testing.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">h</span><span class="p">:</span> <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headString</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;@&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;&quot;</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_id</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;-&#39;</span><span class="p">)</span>
        <span class="n">word</span> <span class="o">=</span> <span class="n">h</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">names</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">word</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c"># g.trace(repr(word),repr(name))</span>
            <span class="k">return</span> <span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;&quot;</span>
    <span class="c">#@+node:ekr.20031218072017.3350: *4* anyAtFileNodeName</span></div>
<div class="viewcode-block" id="vnode.anyAtFileNodeName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.anyAtFileNodeName">[docs]</a>    <span class="k">def</span> <span class="nf">anyAtFileNodeName</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Return the file name following an @file node or an empty string.&quot;&quot;&quot;</span>

        <span class="n">names</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s">&quot;@auto&quot;</span><span class="p">,</span>
            <span class="s">&quot;@auto-otl&quot;</span><span class="p">,</span>
            <span class="s">&quot;@auto-rst&quot;</span><span class="p">,</span>
            <span class="s">&quot;@edit&quot;</span><span class="p">,</span>
            <span class="s">&quot;@file&quot;</span><span class="p">,</span>
            <span class="s">&quot;@thin&quot;</span><span class="p">,</span>   <span class="s">&quot;@file-thin&quot;</span><span class="p">,</span>   <span class="s">&quot;@thinfile&quot;</span><span class="p">,</span>
            <span class="s">&quot;@asis&quot;</span><span class="p">,</span>   <span class="s">&quot;@file-asis&quot;</span><span class="p">,</span>   <span class="s">&quot;@silentfile&quot;</span><span class="p">,</span>
            <span class="s">&quot;@nosent&quot;</span><span class="p">,</span> <span class="s">&quot;@file-nosent&quot;</span><span class="p">,</span> <span class="s">&quot;@nosentinelsfile&quot;</span><span class="p">,</span>
            <span class="s">&quot;@shadow&quot;</span><span class="p">,)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">findAtFileName</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.3348: *4* at...FileNodeName</span>
    <span class="c"># These return the filename following @xxx, in v.headString.</span>
    <span class="c"># Return the the empty string if v is not an @xxx node.</span>
</div>
<div class="viewcode-block" id="vnode.atAutoNodeName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.atAutoNodeName">[docs]</a>    <span class="k">def</span> <span class="nf">atAutoNodeName</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">h</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c"># # Prevent conflicts with autotrees plugin: don&#39;t allow @auto-whatever to match.</span>
        <span class="c"># return g.match_word(h,0,tag) and not g.match(h,0,tag+&#39;-&#39;) and h[len(tag):].strip()</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;@auto&quot;</span><span class="p">,</span><span class="s">&quot;@auto-otl&quot;</span><span class="p">,</span><span class="s">&quot;@auto-rst&quot;</span><span class="p">,)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">findAtFileName</span><span class="p">(</span><span class="n">names</span><span class="p">,</span><span class="n">h</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="vnode.atAutoOtlNodeName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.atAutoOtlNodeName">[docs]</a>    <span class="k">def</span> <span class="nf">atAutoOtlNodeName</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">h</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;@auto-otl&quot;</span><span class="p">,)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">findAtFileName</span><span class="p">(</span><span class="n">names</span><span class="p">,</span><span class="n">h</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="vnode.atAutoRstNodeName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.atAutoRstNodeName">[docs]</a>    <span class="k">def</span> <span class="nf">atAutoRstNodeName</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">h</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;@auto-rst&quot;</span><span class="p">,)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">findAtFileName</span><span class="p">(</span><span class="n">names</span><span class="p">,</span><span class="n">h</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="vnode.atEditNodeName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.atEditNodeName">[docs]</a>    <span class="k">def</span> <span class="nf">atEditNodeName</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;@edit&quot;</span><span class="p">,)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">findAtFileName</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="vnode.atFileNodeName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.atFileNodeName">[docs]</a>    <span class="k">def</span> <span class="nf">atFileNodeName</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;@file&quot;</span><span class="p">,)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">findAtFileName</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="vnode.atNoSentinelsFileNodeName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.atNoSentinelsFileNodeName">[docs]</a>    <span class="k">def</span> <span class="nf">atNoSentinelsFileNodeName</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;@nosent&quot;</span><span class="p">,</span> <span class="s">&quot;@file-nosent&quot;</span><span class="p">,</span> <span class="s">&quot;@nosentinelsfile&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">findAtFileName</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="vnode.atShadowFileNodeName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.atShadowFileNodeName">[docs]</a>    <span class="k">def</span> <span class="nf">atShadowFileNodeName</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;@shadow&quot;</span><span class="p">,)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">findAtFileName</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="vnode.atSilentFileNodeName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.atSilentFileNodeName">[docs]</a>    <span class="k">def</span> <span class="nf">atSilentFileNodeName</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;@asis&quot;</span><span class="p">,</span> <span class="s">&quot;@file-asis&quot;</span><span class="p">,</span> <span class="s">&quot;@silentfile&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">findAtFileName</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="vnode.atThinFileNodeName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.atThinFileNodeName">[docs]</a>    <span class="k">def</span> <span class="nf">atThinFileNodeName</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;@thin&quot;</span><span class="p">,</span> <span class="s">&quot;@file-thin&quot;</span><span class="p">,</span> <span class="s">&quot;@thinfile&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">findAtFileName</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>

    <span class="c"># New names, less confusing</span></div>
    <span class="n">atNoSentFileNodeName</span>  <span class="o">=</span> <span class="n">atNoSentinelsFileNodeName</span>
    <span class="n">atAsisFileNodeName</span>    <span class="o">=</span> <span class="n">atSilentFileNodeName</span>
    <span class="c">#@+node:EKR.20040430152000: *4* isAtAllNode</span>
<div class="viewcode-block" id="vnode.isAtAllNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.isAtAllNode">[docs]</a>    <span class="k">def</span> <span class="nf">isAtAllNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Returns True if the receiver contains @others in its body at the start of a line.&quot;&quot;&quot;</span>

        <span class="n">flag</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">is_special</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bodyString</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;@all&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">flag</span>
    <span class="c">#@+node:ekr.20040326031436: *4* isAnyAtFileNode</span></div>
<div class="viewcode-block" id="vnode.isAnyAtFileNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.isAnyAtFileNode">[docs]</a>    <span class="k">def</span> <span class="nf">isAnyAtFileNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Return True if v is any kind of @file or related node.&quot;&quot;&quot;</span>

        <span class="c"># This routine should be as fast as possible.</span>
        <span class="c"># It is called once for every vnode when writing a file.</span>

        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headString</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">h</span> <span class="ow">and</span> <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;@&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">anyAtFileNodeName</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20040325073709: *4* isAt...FileNode (vnode)</span></div>
<div class="viewcode-block" id="vnode.isAtAutoNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.isAtAutoNode">[docs]</a>    <span class="k">def</span> <span class="nf">isAtAutoNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atAutoNodeName</span><span class="p">(),</span><span class="bp">True</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="vnode.isAtAutoOtlNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.isAtAutoOtlNode">[docs]</a>    <span class="k">def</span> <span class="nf">isAtAutoOtlNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atAutoOtlNodeName</span><span class="p">(),</span><span class="bp">True</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="vnode.isAtAutoRstNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.isAtAutoRstNode">[docs]</a>    <span class="k">def</span> <span class="nf">isAtAutoRstNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atAutoRstNodeName</span><span class="p">(),</span><span class="bp">True</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="vnode.isAtEditNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.isAtEditNode">[docs]</a>    <span class="k">def</span> <span class="nf">isAtEditNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atEditNodeName</span><span class="p">(),</span><span class="bp">True</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="vnode.isAtFileNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.isAtFileNode">[docs]</a>    <span class="k">def</span> <span class="nf">isAtFileNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atFileNodeName</span><span class="p">(),</span><span class="bp">True</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="vnode.isAtNoSentinelsFileNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.isAtNoSentinelsFileNode">[docs]</a>    <span class="k">def</span> <span class="nf">isAtNoSentinelsFileNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atNoSentinelsFileNodeName</span><span class="p">(),</span><span class="bp">True</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="vnode.isAtSilentFileNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.isAtSilentFileNode">[docs]</a>    <span class="k">def</span> <span class="nf">isAtSilentFileNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c"># @file-asis</span>
        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atSilentFileNodeName</span><span class="p">(),</span><span class="bp">True</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="vnode.isAtShadowFileNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.isAtShadowFileNode">[docs]</a>    <span class="k">def</span> <span class="nf">isAtShadowFileNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atShadowFileNodeName</span><span class="p">(),</span><span class="bp">True</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="vnode.isAtThinFileNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.isAtThinFileNode">[docs]</a>    <span class="k">def</span> <span class="nf">isAtThinFileNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atThinFileNodeName</span><span class="p">(),</span><span class="bp">True</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>

    <span class="c"># New names, less confusing:</span></div>
    <span class="n">isAtNoSentFileNode</span> <span class="o">=</span> <span class="n">isAtNoSentinelsFileNode</span>
    <span class="n">isAtAsisFileNode</span>   <span class="o">=</span> <span class="n">isAtSilentFileNode</span>
    <span class="c">#@+node:ekr.20031218072017.3351: *4* isAtIgnoreNode</span>
<div class="viewcode-block" id="vnode.isAtIgnoreNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.isAtIgnoreNode">[docs]</a>    <span class="k">def</span> <span class="nf">isAtIgnoreNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Returns True if the receiver contains @ignore in its body at the start of a line.</span>

<span class="sd">        or if the headline starts with @ignore.&quot;&quot;&quot;</span>

        <span class="c"># v = self</span>

        <span class="c"># 2011/10/08: honor @ignore in headlines.  Sheesh.</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_headString</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;@ignore&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flag</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">is_special</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bodyString</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="s">&quot;@ignore&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">flag</span>
    <span class="c">#@+node:ekr.20031218072017.3352: *4* isAtOthersNode</span></div>
<div class="viewcode-block" id="vnode.isAtOthersNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.isAtOthersNode">[docs]</a>    <span class="k">def</span> <span class="nf">isAtOthersNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Returns True if the receiver contains @others in its body at the start of a line.&quot;&quot;&quot;</span>

        <span class="n">flag</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">is_special</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bodyString</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;@others&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">flag</span>
    <span class="c">#@+node:ekr.20031218072017.3353: *4* v.matchHeadline</span></div>
<div class="viewcode-block" id="vnode.matchHeadline"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.matchHeadline">[docs]</a>    <span class="k">def</span> <span class="nf">matchHeadline</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pattern</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Returns True if the headline matches the pattern ignoring whitespace and case.</span>

<span class="sd">        The headline may contain characters following the successfully matched pattern.&quot;&quot;&quot;</span>

        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicode</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">headString</span><span class="p">())</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span> <span class="c"># 2013/04/05. Allow leading period before section names.</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicode</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">h</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.3359: *3* v.Getters</span>
    <span class="c">#@+node:ekr.20031218072017.3378: *4* v.bodyString</span></div>
<div class="viewcode-block" id="vnode.bodyString"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.bodyString">[docs]</a>    <span class="k">def</span> <span class="nf">bodyString</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># This message should never be printed and we want to avoid crashing here!</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isUnicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bodyString</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bodyString</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">internalError</span><span class="p">(</span><span class="s">&#39;not unicode:&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bodyString</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bodyString</span><span class="p">)</span>
</div>
    <span class="n">getBody</span> <span class="o">=</span> <span class="n">bodyString</span>
    <span class="c">#@+node:ekr.20031218072017.3360: *4* v.Children</span>
    <span class="c">#@+node:ekr.20031218072017.3362: *5* v.firstChild</span>
<div class="viewcode-block" id="vnode.firstChild"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.firstChild">[docs]</a>    <span class="k">def</span> <span class="nf">firstChild</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">children</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c">#@+node:ekr.20040307085922: *5* v.hasChildren &amp; hasFirstChild</span></div>
<div class="viewcode-block" id="vnode.hasChildren"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.hasChildren">[docs]</a>    <span class="k">def</span> <span class="nf">hasChildren</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">children</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</div>
    <span class="n">hasFirstChild</span> <span class="o">=</span> <span class="n">hasChildren</span>
    <span class="c">#@+node:ekr.20031218072017.3364: *5* v.lastChild</span>
<div class="viewcode-block" id="vnode.lastChild"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.lastChild">[docs]</a>    <span class="k">def</span> <span class="nf">lastChild</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">children</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20031218072017.3365: *5* v.nthChild</span>
    <span class="c"># childIndex and nthChild are zero-based.</span>
</div>
<div class="viewcode-block" id="vnode.nthChild"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.nthChild">[docs]</a>    <span class="k">def</span> <span class="nf">nthChild</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>

        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">children</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20031218072017.3366: *5* v.numberOfChildren</span></div>
<div class="viewcode-block" id="vnode.numberOfChildren"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.numberOfChildren">[docs]</a>    <span class="k">def</span> <span class="nf">numberOfChildren</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20040323100443: *4* v.directParents</span></div>
<div class="viewcode-block" id="vnode.directParents"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.directParents">[docs]</a>    <span class="k">def</span> <span class="nf">directParents</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;(New in 4.2) Return a list of all direct parent vnodes of a vnode.</span>

<span class="sd">        This is NOT the same as the list of ancestors of the vnode.&quot;&quot;&quot;</span>

        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">parents</span>
    <span class="c">#@+node:ekr.20080429053831.6: *4* v.hasBody</span></div>
<div class="viewcode-block" id="vnode.hasBody"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.hasBody">[docs]</a>    <span class="k">def</span> <span class="nf">hasBody</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return True if this vnode contains body text.&#39;&#39;&#39;</span>

        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bodyString</span>

        <span class="k">return</span> <span class="n">s</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="c">#@+node:ekr.20031218072017.1581: *4* v.headString &amp; v.cleanHeadString</span></div>
<div class="viewcode-block" id="vnode.headString"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.headString">[docs]</a>    <span class="k">def</span> <span class="nf">headString</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Return the headline string.&quot;&quot;&quot;</span>

        <span class="c"># This message should never be printed and we want to avoid crashing here!</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">isUnicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_headString</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">internalError</span><span class="p">(</span><span class="s">&#39;not unicode&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_headString</span><span class="p">))</span>

        <span class="c"># Make _sure_ we return a unicode string.</span>
        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_headString</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="vnode.cleanHeadString"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.cleanHeadString">[docs]</a>    <span class="k">def</span> <span class="nf">cleanHeadString</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_headString</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="s">&quot;ascii&quot;</span><span class="p">)</span> <span class="c"># Replaces non-ascii characters by &#39;?&#39;</span>
    <span class="c">#@+node:ekr.20031218072017.3367: *4* v.Status Bits</span>
    <span class="c">#@+node:ekr.20031218072017.3368: *5* v.isCloned</span></div>
<div class="viewcode-block" id="vnode.isCloned"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.isCloned">[docs]</a>    <span class="k">def</span> <span class="nf">isCloned</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parents</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
    <span class="c">#@+node:ekr.20031218072017.3369: *5* v.isDirty</span></div>
<div class="viewcode-block" id="vnode.isDirty"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.isDirty">[docs]</a>    <span class="k">def</span> <span class="nf">isDirty</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statusBits</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirtyBit</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="c">#@+node:ekr.20031218072017.3370: *5* v.isExpanded</span></div>
<div class="viewcode-block" id="vnode.isExpanded"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.isExpanded">[docs]</a>    <span class="k">def</span> <span class="nf">isExpanded</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># g.trace( ( self.statusBits &amp; self.expandedBit ) != 0, g.callers())</span>

        <span class="k">return</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusBits</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">expandedBit</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="c">#@+node:ekr.20031218072017.3371: *5* v.isMarked</span></div>
<div class="viewcode-block" id="vnode.isMarked"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.isMarked">[docs]</a>    <span class="k">def</span> <span class="nf">isMarked</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusBits</span> <span class="o">&amp;</span> <span class="n">vnode</span><span class="o">.</span><span class="n">markedBit</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="c">#@+node:ekr.20031218072017.3372: *5* v.isOrphan</span></div>
<div class="viewcode-block" id="vnode.isOrphan"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.isOrphan">[docs]</a>    <span class="k">def</span> <span class="nf">isOrphan</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusBits</span> <span class="o">&amp;</span> <span class="n">vnode</span><span class="o">.</span><span class="n">orphanBit</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="c">#@+node:ekr.20031218072017.3373: *5* v.isSelected</span></div>
<div class="viewcode-block" id="vnode.isSelected"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.isSelected">[docs]</a>    <span class="k">def</span> <span class="nf">isSelected</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusBits</span> <span class="o">&amp;</span> <span class="n">vnode</span><span class="o">.</span><span class="n">selectedBit</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="c">#@+node:ekr.20031218072017.3374: *5* v.isTopBitSet</span></div>
<div class="viewcode-block" id="vnode.isTopBitSet"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.isTopBitSet">[docs]</a>    <span class="k">def</span> <span class="nf">isTopBitSet</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusBits</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">topBit</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="c">#@+node:ekr.20031218072017.3376: *5* v.isVisited</span></div>
<div class="viewcode-block" id="vnode.isVisited"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.isVisited">[docs]</a>    <span class="k">def</span> <span class="nf">isVisited</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusBits</span> <span class="o">&amp;</span> <span class="n">vnode</span><span class="o">.</span><span class="n">visitedBit</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="c">#@+node:ekr.20080429053831.10: *5* v.isWriteBit</span></div>
<div class="viewcode-block" id="vnode.isWriteBit"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.isWriteBit">[docs]</a>    <span class="k">def</span> <span class="nf">isWriteBit</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">statusBits</span> <span class="o">&amp;</span> <span class="n">v</span><span class="o">.</span><span class="n">writeBit</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="c">#@+node:ekr.20031218072017.3377: *5* v.status</span></div>
<div class="viewcode-block" id="vnode.status"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.status">[docs]</a>    <span class="k">def</span> <span class="nf">status</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">statusBits</span>
    <span class="c">#@+node:ekr.20031218072017.3384: *3* v.Setters</span>
    <span class="c">#@+node:ekr.20090830051712.6151: *4*  v.Dirty bits</span>
    <span class="c">#@+node:ekr.20031218072017.3390: *5* v.clearDirty</span></div>
<div class="viewcode-block" id="vnode.clearDirty"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.clearDirty">[docs]</a>    <span class="k">def</span> <span class="nf">clearDirty</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="c"># g.trace(v,g.callers())</span>
        <span class="n">v</span><span class="o">.</span><span class="n">statusBits</span> <span class="o">&amp;=</span> <span class="o">~</span> <span class="n">v</span><span class="o">.</span><span class="n">dirtyBit</span>

    <span class="c">#@+node:ekr.20090830051712.6153: *5* v.findAllPotentiallyDirtyNodes</span></div>
<div class="viewcode-block" id="vnode.findAllPotentiallyDirtyNodes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.findAllPotentiallyDirtyNodes">[docs]</a>    <span class="k">def</span> <span class="nf">findAllPotentiallyDirtyNodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">context</span>

        <span class="c"># Set the starting nodes.</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">newNodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span>

        <span class="c"># Add nodes until no more are added.</span>
        <span class="k">while</span> <span class="n">newNodes</span><span class="p">:</span>
            <span class="n">addedNodes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">nodes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">newNodes</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">newNodes</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">v2</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">parents</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">v2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nodes</span> <span class="ow">and</span> <span class="n">v2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">addedNodes</span><span class="p">:</span>
                        <span class="n">addedNodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>
            <span class="n">newNodes</span> <span class="o">=</span> <span class="n">addedNodes</span><span class="p">[:]</span>

        <span class="c"># Remove the hidden vnode.</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">hiddenRootNode</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;removing hidden root&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">hiddenRootNode</span><span class="p">)</span>
            <span class="n">nodes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">hiddenRootNode</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nodes</span>
    <span class="c">#@+node:ekr.20090830051712.6157: *5* v.setAllAncestorAtFileNodesDirty</span>
    <span class="c"># Unlike p.setAllAncestorAtFileNodesDirty,</span>
    <span class="c"># there is no setDescendentsDirty arg.</span>
</div>
<div class="viewcode-block" id="vnode.setAllAncestorAtFileNodesDirty"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.setAllAncestorAtFileNodesDirty">[docs]</a>    <span class="k">def</span> <span class="nf">setAllAncestorAtFileNodesDirty</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># Calculate all nodes that are joined to p or parents of such nodes.</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">findAllPotentiallyDirtyNodes</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                <span class="k">print</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">isDirty</span><span class="p">(),</span><span class="n">v</span><span class="o">.</span><span class="n">isAnyAtFileNode</span><span class="p">(),</span><span class="n">v</span><span class="p">)</span>
        <span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">nodes</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">isDirty</span><span class="p">()</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">isAnyAtFileNode</span><span class="p">()]</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dirtyVnodeList</span><span class="p">:</span>
            <span class="n">v</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span> <span class="c"># Do not call p.setDirty here!</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">dirtyVnodeList</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dirtyVnodeList</span>
    <span class="c">#@+node:ekr.20080429053831.12: *5* v.setDirty</span></div>
<div class="viewcode-block" id="vnode.setDirty"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.setDirty">[docs]</a>    <span class="k">def</span> <span class="nf">setDirty</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">statusBits</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dirtyBit</span>
    <span class="c">#@+node:ekr.20031218072017.3386: *4*  v.Status bits</span>
    <span class="c">#@+node:ekr.20031218072017.3389: *5* v.clearClonedBit</span></div>
<div class="viewcode-block" id="vnode.clearClonedBit"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.clearClonedBit">[docs]</a>    <span class="k">def</span> <span class="nf">clearClonedBit</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">statusBits</span> <span class="o">&amp;=</span> <span class="o">~</span> <span class="bp">self</span><span class="o">.</span><span class="n">clonedBit</span>
    <span class="c">#@+node:ekr.20031218072017.3391: *5* v.clearMarked</span></div>
<div class="viewcode-block" id="vnode.clearMarked"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.clearMarked">[docs]</a>    <span class="k">def</span> <span class="nf">clearMarked</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">statusBits</span> <span class="o">&amp;=</span> <span class="o">~</span> <span class="bp">self</span><span class="o">.</span><span class="n">markedBit</span>
    <span class="c">#@+node:ekr.20080429053831.8: *5* v.clearWriteBit</span></div>
<div class="viewcode-block" id="vnode.clearWriteBit"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.clearWriteBit">[docs]</a>    <span class="k">def</span> <span class="nf">clearWriteBit</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusBits</span> <span class="o">&amp;=</span> <span class="o">~</span> <span class="bp">self</span><span class="o">.</span><span class="n">writeBit</span>
    <span class="c">#@+node:ekr.20031218072017.3392: *5* v.clearOrphan</span></div>
<div class="viewcode-block" id="vnode.clearOrphan"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.clearOrphan">[docs]</a>    <span class="k">def</span> <span class="nf">clearOrphan</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># if self.h.startswith(&#39;@file&#39;): g.trace(self.h,g.callers())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">statusBits</span> <span class="o">&amp;=</span> <span class="o">~</span> <span class="bp">self</span><span class="o">.</span><span class="n">orphanBit</span>
    <span class="c">#@+node:ekr.20031218072017.3393: *5* v.clearVisited</span></div>
<div class="viewcode-block" id="vnode.clearVisited"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.clearVisited">[docs]</a>    <span class="k">def</span> <span class="nf">clearVisited</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">statusBits</span> <span class="o">&amp;=</span> <span class="o">~</span> <span class="bp">self</span><span class="o">.</span><span class="n">visitedBit</span>
    <span class="c">#@+node:ekr.20031218072017.3395: *5* v.contract &amp; expand &amp; initExpandedBit</span></div>
<div class="viewcode-block" id="vnode.contract"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.contract">[docs]</a>    <span class="k">def</span> <span class="nf">contract</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># if self.context.p.v == self: g.trace(self,g.callers(4))</span>
        <span class="c"># if self.isExpanded(): g.trace(self,g.callers())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">statusBits</span> <span class="o">&amp;=</span> <span class="o">~</span> <span class="bp">self</span><span class="o">.</span><span class="n">expandedBit</span>
</div>
<div class="viewcode-block" id="vnode.expand"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.expand">[docs]</a>    <span class="k">def</span> <span class="nf">expand</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># g.trace(self,g.callers(4))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">statusBits</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expandedBit</span>
</div>
<div class="viewcode-block" id="vnode.initExpandedBit"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.initExpandedBit">[docs]</a>    <span class="k">def</span> <span class="nf">initExpandedBit</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># g.trace(self._headString)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">statusBits</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expandedBit</span>
    <span class="c">#@+node:ekr.20031218072017.3396: *5* v.initStatus</span></div>
<div class="viewcode-block" id="vnode.initStatus"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.initStatus">[docs]</a>    <span class="k">def</span> <span class="nf">initStatus</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">statusBits</span> <span class="o">=</span> <span class="n">status</span>
    <span class="c">#@+node:ekr.20031218072017.3397: *5* v.setClonedBit &amp; initClonedBit</span></div>
<div class="viewcode-block" id="vnode.setClonedBit"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.setClonedBit">[docs]</a>    <span class="k">def</span> <span class="nf">setClonedBit</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">statusBits</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clonedBit</span>
</div>
<div class="viewcode-block" id="vnode.initClonedBit"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.initClonedBit">[docs]</a>    <span class="k">def</span> <span class="nf">initClonedBit</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statusBits</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clonedBit</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">statusBits</span> <span class="o">&amp;=</span> <span class="o">~</span> <span class="bp">self</span><span class="o">.</span><span class="n">clonedBit</span>
    <span class="c">#@+node:ekr.20031218072017.3398: *5* v.setMarked &amp; initMarkedBit</span></div>
<div class="viewcode-block" id="vnode.setMarked"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.setMarked">[docs]</a>    <span class="k">def</span> <span class="nf">setMarked</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">statusBits</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">markedBit</span>
</div>
<div class="viewcode-block" id="vnode.initMarkedBit"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.initMarkedBit">[docs]</a>    <span class="k">def</span> <span class="nf">initMarkedBit</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">statusBits</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">markedBit</span>
    <span class="c">#@+node:ekr.20031218072017.3399: *5* v.setOrphan</span></div>
<div class="viewcode-block" id="vnode.setOrphan"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.setOrphan">[docs]</a>    <span class="k">def</span> <span class="nf">setOrphan</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># if self.h.startswith(&#39;@file&#39;): g.trace(self.h,g.callers())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">statusBits</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orphanBit</span>
    <span class="c">#@+node:ekr.20031218072017.3400: *5* v.setSelected</span>
    <span class="c"># This only sets the selected bit.</span>
</div>
<div class="viewcode-block" id="vnode.setSelected"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.setSelected">[docs]</a>    <span class="k">def</span> <span class="nf">setSelected</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">statusBits</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selectedBit</span>
    <span class="c">#@+node:ekr.20031218072017.3401: *5* v.setVisited</span>
    <span class="c"># Compatibility routine for scripts</span>
</div>
<div class="viewcode-block" id="vnode.setVisited"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.setVisited">[docs]</a>    <span class="k">def</span> <span class="nf">setVisited</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">statusBits</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visitedBit</span>
    <span class="c">#@+node:ekr.20080429053831.9: *5* v.setWriteBit</span></div>
<div class="viewcode-block" id="vnode.setWriteBit"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.setWriteBit">[docs]</a>    <span class="k">def</span> <span class="nf">setWriteBit</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statusBits</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">writeBit</span>
    <span class="c">#@+node:ekr.20031218072017.3385: *4* v.computeIcon &amp; setIcon</span></div>
<div class="viewcode-block" id="vnode.computeIcon"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.computeIcon">[docs]</a>    <span class="k">def</span> <span class="nf">computeIcon</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">hasBody</span><span class="p">():</span> <span class="n">val</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">isMarked</span><span class="p">():</span> <span class="n">val</span> <span class="o">+=</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">isCloned</span><span class="p">():</span> <span class="n">val</span> <span class="o">+=</span> <span class="mi">4</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">isDirty</span><span class="p">():</span> <span class="n">val</span> <span class="o">+=</span> <span class="mi">8</span>
        <span class="k">return</span> <span class="n">val</span>
</div>
<div class="viewcode-block" id="vnode.setIcon"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.setIcon">[docs]</a>    <span class="k">def</span> <span class="nf">setIcon</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">pass</span> <span class="c"># Compatibility routine for old scripts</span>
    <span class="c">#@+node:ekr.20100303074003.5636: *4* v.restoreCursorAndScroll</span>
    <span class="c"># Called only by leoTree.selectHelper.</span>
</div>
<div class="viewcode-block" id="vnode.restoreCursorAndScroll"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.restoreCursorAndScroll">[docs]</a>    <span class="k">def</span> <span class="nf">restoreCursorAndScroll</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="p">(</span><span class="bp">False</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">trace_scroll</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span>
        <span class="n">ins</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">insertSpot</span>
        <span class="n">start</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">selectionStart</span><span class="p">,</span><span class="n">v</span><span class="o">.</span><span class="n">selectionLength</span>
        <span class="n">spot</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">scrollBarSpot</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span>

        <span class="c"># Fix bug 981849: incorrect body content shown.</span>
        <span class="k">if</span> <span class="n">ins</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">ins</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">w</span><span class="o">.</span><span class="n">setInsertPoint</span><span class="p">(</span><span class="n">ins</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">no_scroll</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c"># Override any changes to the scrollbar setting that might</span>
        <span class="c"># have been done above by w.setSelectionRange or w.setInsertPoint.</span>
        <span class="k">if</span> <span class="n">spot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">w</span><span class="o">.</span><span class="n">setYScrollPosition</span><span class="p">(</span><span class="n">spot</span><span class="p">)</span>
        <span class="n">v</span><span class="o">.</span><span class="n">scrollBarSpot</span> <span class="o">=</span> <span class="n">spot</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">spot</span><span class="p">,</span><span class="n">v</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

        <span class="c"># Never call w.see here.</span>
    <span class="c">#@+node:ekr.20100303074003.5638: *4* v.saveCursorAndScroll</span></div>
<div class="viewcode-block" id="vnode.saveCursorAndScroll"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.saveCursorAndScroll">[docs]</a>    <span class="k">def</span> <span class="nf">saveCursorAndScroll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="p">(</span><span class="bp">False</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">trace_scroll</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">context</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">w</span><span class="p">:</span> <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">v</span><span class="o">.</span><span class="n">scrollBarSpot</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getYScrollPosition</span><span class="p">()</span>
            <span class="n">v</span><span class="o">.</span><span class="n">insertSpot</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getInsertPoint</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">scrollBarSpot</span><span class="p">,</span><span class="n">v</span><span class="o">.</span><span class="n">insertSpot</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c"># 2011/03/21: w may not support the high-level interface.</span>
            <span class="k">pass</span>
    <span class="c">#@+node:ekr.20040315032144: *4* v.setBodyString &amp; v.setHeadString</span></div>
<div class="viewcode-block" id="vnode.setBodyString"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.setBodyString">[docs]</a>    <span class="k">def</span> <span class="nf">setBodyString</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="c"># trace = False and not g.unitTesting</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="c"># if trace and v._bodyString != s:</span>
            <span class="c"># g.trace(&#39;v %s %s -&gt; %s %s\nold: %s\nnew: %s&#39; % (</span>
                <span class="c"># v.h, len(v._bodyString),len(s),g.callers(5),</span>
                <span class="c"># v._bodyString,s))</span>
        <span class="n">v</span><span class="o">.</span><span class="n">_bodyString</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">reportErrors</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="vnode.setHeadString"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.setHeadString">[docs]</a>    <span class="k">def</span> <span class="nf">setHeadString</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">v</span><span class="o">.</span><span class="n">_headString</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">reportErrors</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
    <span class="n">initBodyString</span> <span class="o">=</span> <span class="n">setBodyString</span>
    <span class="n">initHeadString</span> <span class="o">=</span> <span class="n">setHeadString</span>
    <span class="n">setHeadText</span> <span class="o">=</span> <span class="n">setHeadString</span>
    <span class="n">setTnodeText</span> <span class="o">=</span> <span class="n">setBodyString</span>
    <span class="c">#@+node:ekr.20080429053831.13: *4* v.setFileIndex</span>
<div class="viewcode-block" id="vnode.setFileIndex"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.setFileIndex">[docs]</a>    <span class="k">def</span> <span class="nf">setFileIndex</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fileIndex</span> <span class="o">=</span> <span class="n">index</span>
    <span class="c">#@+node:ekr.20031218072017.3402: *4* v.setSelection</span></div>
<div class="viewcode-block" id="vnode.setSelection"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.setSelection">[docs]</a>    <span class="k">def</span> <span class="nf">setSelection</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>

        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">v</span><span class="o">.</span><span class="n">selectionStart</span> <span class="o">=</span> <span class="n">start</span>
        <span class="n">v</span><span class="o">.</span><span class="n">selectionLength</span> <span class="o">=</span> <span class="n">length</span>
    <span class="c">#@+node:ville.20120502221057.7498: *4* v.contentModified</span></div>
<div class="viewcode-block" id="vnode.contentModified"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.contentModified">[docs]</a>    <span class="k">def</span> <span class="nf">contentModified</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">g</span><span class="o">.</span><span class="n">contentModifiedSet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="c">#@+node:ville.20120502221057.7499: *4* v.childrenModified</span></div>
<div class="viewcode-block" id="vnode.childrenModified"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoNodes.vnode.childrenModified">[docs]</a>    <span class="k">def</span> <span class="nf">childrenModified</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">g</span><span class="o">.</span><span class="n">childrenModifiedSet</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20080427062528.9: *3* v.Low level methods</span>
    <span class="c">#@+node:ekr.20090706110836.6135: *4* v._addLink &amp; helper</span></div>
    <span class="k">def</span> <span class="nf">_addLink</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">childIndex</span><span class="p">,</span><span class="n">parent_v</span><span class="p">,</span><span class="n">adjust</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Adjust links after adding a link to v.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">parent_v</span><span class="o">.</span><span class="n">childrenModified</span><span class="p">()</span>    
        <span class="c"># Update parent_v.children &amp; v.parents.</span>
        <span class="n">parent_v</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">childIndex</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
        <span class="n">v</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parent_v</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;*** added parent&#39;</span><span class="p">,</span><span class="n">parent_v</span><span class="p">,</span><span class="s">&#39;to&#39;</span><span class="p">,</span><span class="n">v</span><span class="p">,</span>
            <span class="s">&#39;len(parents)&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">parents</span><span class="p">))</span>

        <span class="c"># Set zodb changed flags.</span>
        <span class="n">v</span><span class="o">.</span><span class="n">_p_changed</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">parent_v</span><span class="o">.</span><span class="n">_p_changed</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c"># If v has only one parent, we adjust all</span>
        <span class="c"># the parents links in the descendant tree.</span>
        <span class="c"># This handles clones properly when undoing a delete.</span>
        <span class="k">if</span> <span class="n">adjust</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">parents</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                    <span class="n">child</span><span class="o">.</span><span class="n">_addParentLinks</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20090804184658.6129: *5* v._addParentLinks</span>
    <span class="k">def</span> <span class="nf">_addParentLinks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent</span><span class="p">):</span> 

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">v</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
            <span class="s">&#39;*** added parent&#39;</span><span class="p">,</span><span class="n">parent</span><span class="p">,</span><span class="s">&#39;to&#39;</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;len(parents)&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">parents</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">parents</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="n">child</span><span class="o">.</span><span class="n">_addParentLinks</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20090804184658.6128: *4* v._cutLink</span>
    <span class="k">def</span> <span class="nf">_cutLink</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">childIndex</span><span class="p">,</span><span class="n">parent_v</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Adjust links after cutting a link to v.&#39;&#39;&#39;</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">parent_v</span><span class="o">.</span><span class="n">childrenModified</span><span class="p">()</span>    
        <span class="k">assert</span> <span class="n">parent_v</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">childIndex</span><span class="p">]</span><span class="o">==</span><span class="n">v</span>
        <span class="k">del</span> <span class="n">parent_v</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">childIndex</span><span class="p">]</span>
        <span class="n">v</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">parent_v</span><span class="p">)</span>
        <span class="n">v</span><span class="o">.</span><span class="n">_p_changed</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">parent_v</span><span class="o">.</span><span class="n">_p_changed</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c"># If v has no more parents, we adjust all</span>
        <span class="c"># the parent links in the descendant tree.</span>
        <span class="c"># This handles clones properly when deleting a tree.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">parents</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="n">child</span><span class="o">.</span><span class="n">_cutParentLinks</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20090804190529.6133: *5* v._cutParentLinks</span>
    <span class="k">def</span> <span class="nf">_cutParentLinks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;parent&#39;</span><span class="p">,</span><span class="n">parent</span><span class="p">,</span><span class="s">&#39;v&#39;</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
        <span class="n">v</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">parents</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="n">child</span><span class="o">.</span><span class="n">_cutParentLinks</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.3425: *4* v._linkAsNthChild (used by 4.x read logic)</span>
    <span class="k">def</span> <span class="nf">_linkAsNthChild</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent_v</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Links self as the n&#39;th child of vnode pv&quot;&quot;&quot;</span>

        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span> <span class="c"># The child node.</span>
        <span class="n">v</span><span class="o">.</span><span class="n">_addLink</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">parent_v</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20090130065000.1: *3* v.Properties</span>
    <span class="c">#@+node:ekr.20090130114732.5: *4* v.b Property</span>
    <span class="k">def</span> <span class="nf">__get_b</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">bodyString</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__set_b</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">val</span><span class="p">):</span>

        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">v</span><span class="o">.</span><span class="n">setBodyString</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

    <span class="n">b</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span>
        <span class="n">__get_b</span><span class="p">,</span> <span class="n">__set_b</span><span class="p">,</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="s">&quot;vnode body string property&quot;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20090130125002.1: *4* v.h property</span>
    <span class="k">def</span> <span class="nf">__get_h</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">headString</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__set_h</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">val</span><span class="p">):</span>

        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">v</span><span class="o">.</span><span class="n">setHeadString</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

    <span class="n">h</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span>
        <span class="n">__get_h</span><span class="p">,</span> <span class="n">__set_h</span><span class="p">,</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="s">&quot;vnode headline string property&quot;</span><span class="p">)</span>  
    <span class="c">#@+node:ekr.20090130114732.6: *4* v.u Property</span>
    <span class="k">def</span> <span class="nf">__get_u</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;unknownAttributes&#39;</span><span class="p">):</span>
            <span class="n">v</span><span class="o">.</span><span class="n">unknownAttributes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">unknownAttributes</span>

    <span class="k">def</span> <span class="nf">__set_u</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">val</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;unknownAttributes&#39;</span><span class="p">):</span>
                <span class="nb">delattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;unknownAttributes&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">({}):</span>
            <span class="n">v</span><span class="o">.</span><span class="n">unknownAttributes</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>

    <span class="n">u</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span>
        <span class="n">__get_u</span><span class="p">,</span> <span class="n">__set_u</span><span class="p">,</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="s">&quot;vnode unknownAttribute property&quot;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20090215165030.1: *4* v.gnx Property</span>
    <span class="k">def</span> <span class="nf">__get_gnx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">nodeIndices</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">fileIndex</span><span class="p">)</span>

    <span class="n">gnx</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span>
        <span class="n">__get_gnx</span><span class="p">,</span> <span class="c"># __set_gnx,</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="s">&quot;vnode gnx property&quot;</span><span class="p">)</span>
    <span class="c">#@-others</span>
<span class="c">#@-others</span>
<span class="c">#@-leo</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Leo API 4.11dev documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Ed K. Ream.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
  </body>
</html>