<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>leo.core.leoShadow &mdash; Leo API 4.11dev documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '4.11dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Leo API 4.11dev documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Leo API 4.11dev documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for leo.core.leoShadow</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="c">#@+leo-ver=5-thin</span>
<span class="c">#@+node:ekr.20080708094444.1: * @file leoShadow.py</span>
<span class="c">#@@first</span>

<span class="c">#@+&lt;&lt; docstring &gt;&gt;</span>
<span class="c">#@+node:ekr.20080708094444.78: ** &lt;&lt; docstring &gt;&gt;</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">leoShadow.py</span>


<span class="sd">This code allows users to use Leo with files which contain no sentinels</span>
<span class="sd">and still have information flow in both directions between outlines and</span>
<span class="sd">derived files.</span>

<span class="sd">Private files contain sentinels: they live in the Leo-shadow subdirectory.</span>
<span class="sd">Public files contain no sentinels: they live in the parent (main) directory.</span>

<span class="sd">When Leo first reads an @shadow we create a file without sentinels in the regular directory.</span>

<span class="sd">The slightly hard thing to do is to pick up changes from the file without</span>
<span class="sd">sentinels, and put them into the file with sentinels.</span>



<span class="sd">Settings:</span>
<span class="sd">- @string shadow_subdir (default: .leo_shadow): name of the shadow directory.</span>

<span class="sd">- @string shadow_prefix (default: x): prefix of shadow files.</span>
<span class="sd">  This prefix allows the shadow file and the original file to have different names.</span>
<span class="sd">  This is useful for name-based tools like py.test.</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="c">#@-&lt;&lt; docstring &gt;&gt;</span>
<span class="c">#@+&lt;&lt; imports &gt;&gt;</span>
<span class="c">#@+node:ekr.20080708094444.52: ** &lt;&lt; imports &gt;&gt; (leoShadow)</span>
<span class="kn">import</span> <span class="nn">leo.core.leoGlobals</span> <span class="kn">as</span> <span class="nn">g</span>

<span class="kn">import</span> <span class="nn">difflib</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="c">#@-&lt;&lt; imports &gt;&gt;</span>

<span class="c">#@@language python</span>
<span class="c">#@@tabwidth -4</span>
<span class="c">#@@pagewidth 70</span>

<span class="c">#@+others</span>
<span class="c">#@+node:ekr.20080708094444.80: ** class shadowController</span>
<div class="viewcode-block" id="shadowController"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController">[docs]</a><span class="k">class</span> <span class="nc">shadowController</span><span class="p">:</span>

    <span class="sd">&#39;&#39;&#39;A class to manage @shadow files&#39;&#39;&#39;</span>

    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20080708094444.79: *3*  x.ctor</span>
    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">trace</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">trace_writers</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">c</span>

        <span class="c"># File encoding.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">default_derived_file_encoding</span>
            <span class="c"># 2011/09/08</span>

        <span class="c"># Configuration...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shadow_subdir</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getString</span><span class="p">(</span><span class="s">&#39;shadow_subdir&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;.leo_shadow&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shadow_prefix</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getString</span><span class="p">(</span><span class="s">&#39;shadow_prefix&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shadow_in_home_dir</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getBool</span><span class="p">(</span><span class="s">&#39;shadow_in_home_dir&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="c"># Munch shadow_subdir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shadow_subdir</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_normpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shadow_subdir</span><span class="p">)</span>

        <span class="c"># Error handling...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_error</span>  <span class="o">=</span> <span class="s">&#39;&#39;</span> <span class="c"># The last error message, regardless of whether it was actually shown.</span>

        <span class="c"># Support for goto-line.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line_mapping</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c">#@+node:ekr.20080711063656.1: *3* x.File utils</span>
    <span class="c">#@+node:ekr.20080711063656.7: *4* x.baseDirName</span>
<div class="viewcode-block" id="shadowController.baseDirName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.baseDirName">[docs]</a>    <span class="k">def</span> <span class="nf">baseDirName</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fileName</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_dirname</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">os_path_finalize</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Can not compute shadow path: .leo file has not been saved&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20080711063656.4: *4* x.dirName and pathName</span></div>
<div class="viewcode-block" id="shadowController.dirName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.dirName">[docs]</a>    <span class="k">def</span> <span class="nf">dirName</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the directory for filename.&#39;&#39;&#39;</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_dirname</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">pathName</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="shadowController.pathName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.pathName">[docs]</a>    <span class="k">def</span> <span class="nf">pathName</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the full path name of filename.&#39;&#39;&#39;</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">theDir</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">baseDirName</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">theDir</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="n">theDir</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20080712080505.3: *4* x.isSignificantPublicFile</span></div>
<div class="viewcode-block" id="shadowController.isSignificantPublicFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.isSignificantPublicFile">[docs]</a>    <span class="k">def</span> <span class="nf">isSignificantPublicFile</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;This tells the atFile.read logic whether to import a public file</span>
<span class="sd">        or use an existing public file.&#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="ow">and</span>
            <span class="n">g</span><span class="o">.</span><span class="n">os_path_isfile</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="ow">and</span>
            <span class="n">g</span><span class="o">.</span><span class="n">os_path_getsize</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span>
        <span class="p">)</span>
    <span class="c">#@+node:ekr.20080710082231.19: *4* x.makeShadowDirectory</span></div>
<div class="viewcode-block" id="shadowController.makeShadowDirectory"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.makeShadowDirectory">[docs]</a>    <span class="k">def</span> <span class="nf">makeShadowDirectory</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Make a shadow directory for the **public** fn.&#39;&#39;&#39;</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">path</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shadowDirName</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>

            <span class="c"># Force the creation of the directories.</span>
            <span class="n">g</span><span class="o">.</span><span class="n">makeAllNonExistentDirectories</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_isdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20080713091247.1: *4* x.replaceFileWithString (@shadow)</span></div>
<div class="viewcode-block" id="shadowController.replaceFileWithString"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.replaceFileWithString">[docs]</a>    <span class="k">def</span> <span class="nf">replaceFileWithString</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Replace the file with s if s is different from theFile&#39;s contents.</span>

<span class="sd">        Return True if theFile was changed.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span> <span class="p">;</span> <span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">exists</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">exists</span><span class="p">:</span>
            <span class="c"># Read the file.  Return if it is the same.</span>
            <span class="n">s2</span><span class="p">,</span><span class="n">e</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">readFileIntoString</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s2</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="n">s2</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;unchanged:&#39;</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>

        <span class="c"># Issue warning if directory does not exist.</span>
        <span class="n">theDir</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_dirname</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">theDir</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">theDir</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                <span class="n">x</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;not written: </span><span class="si">%s</span><span class="s"> directory not found&#39;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="c"># Replace the file.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="s">&#39;wb&#39;</span><span class="p">)</span>
            <span class="c"># 2011/09/09: Use self.encoding.</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;encoding&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;fn&#39;</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span>
                    <span class="s">&#39;</span><span class="se">\n</span><span class="s">lines...</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">listToString</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">s</span><span class="p">))),</span>
                    <span class="s">&#39;</span><span class="se">\n</span><span class="s">callers&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                <span class="c"># g.trace(&#39;created:&#39;,fn,g.callers())</span>
                <span class="k">if</span> <span class="n">exists</span><span class="p">:</span>  <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;wrote:&#39;</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>       <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;created:&#39;</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="n">x</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;unexpected exception writing file: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fn</span><span class="p">))</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20080711063656.6: *4* x.shadowDirName and shadowPathName</span></div>
<div class="viewcode-block" id="shadowController.shadowDirName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.shadowDirName">[docs]</a>    <span class="k">def</span> <span class="nf">shadowDirName</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the directory for the shadow file corresponding to filename.&#39;&#39;&#39;</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_dirname</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shadowPathName</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="shadowController.shadowPathName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.shadowPathName">[docs]</a>    <span class="k">def</span> <span class="nf">shadowPathName</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the full path name of filename, resolved using c.fileName()&#39;&#39;&#39;</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">c</span>

        <span class="n">baseDir</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">baseDirName</span><span class="p">()</span>
        <span class="n">fileDir</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="c"># 2011/01/26: bogomil: redirect shadow dir</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shadow_in_home_dir</span><span class="p">:</span>

            <span class="c"># Each .leo file has a separate shadow_cache in base dir</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="s">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">))[</span><span class="mi">0</span><span class="p">],</span><span class="s">&quot;shadow_cache&quot;</span><span class="p">])</span>

            <span class="c"># On Windows incorporate the drive letter to the private file path</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&quot;nt&quot;</span><span class="p">:</span>
                <span class="n">fileDir</span> <span class="o">=</span> <span class="n">fileDir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">,</span><span class="s">&#39;%&#39;</span><span class="p">)</span>

            <span class="c"># build the chache path as a subdir of the base dir            </span>
            <span class="n">fileDir</span> <span class="o">=</span> <span class="s">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">baseDir</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">fileDir</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">baseDir</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span>
                <span class="n">baseDir</span><span class="p">,</span>
                <span class="n">fileDir</span><span class="p">,</span> <span class="c"># Bug fix: honor any directories specified in filename.</span>
                <span class="n">x</span><span class="o">.</span><span class="n">shadow_subdir</span><span class="p">,</span>
                <span class="n">x</span><span class="o">.</span><span class="n">shadow_prefix</span> <span class="o">+</span> <span class="n">g</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20080711063656.3: *4* x.unlink</span></div>
<div class="viewcode-block" id="shadowController.unlink"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.unlink">[docs]</a>    <span class="k">def</span> <span class="nf">unlink</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span><span class="n">silent</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Unlink filename from the file system.</span>
<span class="sd">        Give an error on failure.&#39;&#39;&#39;</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">ok</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">utils_remove</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="ow">not</span> <span class="n">silent</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
            <span class="n">x</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;can not delete </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">),</span><span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ok</span>
    <span class="c">#@+node:ekr.20080708192807.1: *3* x.Propagation</span>
    <span class="c">#@+node:ekr.20080708094444.35: *4* x.check_the_final_output</span></div>
<div class="viewcode-block" id="shadowController.check_the_final_output"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.check_the_final_output">[docs]</a>    <span class="k">def</span> <span class="nf">check_the_final_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_private_lines</span><span class="p">,</span> <span class="n">new_public_lines</span><span class="p">,</span> <span class="n">sentinel_lines</span><span class="p">,</span> <span class="n">marker</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that we produced a valid output.</span>

<span class="sd">        Input:</span>
<span class="sd">            new_targetlines:   the lines with sentinels which produce changed_lines_without_sentinels.</span>
<span class="sd">            sentinels:         new_targetlines should include all the lines from sentinels.</span>

<span class="sd">        checks:</span>
<span class="sd">            1. new_targetlines without sentinels must equal changed_lines_without_sentinels.</span>
<span class="sd">            2. the sentinel lines of new_targetlines must match &#39;sentinels&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_public_lines2</span><span class="p">,</span> <span class="n">new_sentinel_lines2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">separate_sentinels</span><span class="p">(</span>
            <span class="n">new_private_lines</span><span class="p">,</span> <span class="n">marker</span><span class="p">)</span>

        <span class="n">lines1</span> <span class="o">=</span> <span class="n">new_public_lines</span>
        <span class="n">lines2</span> <span class="o">=</span> <span class="n">new_public_lines2</span>
        <span class="n">sents1</span> <span class="o">=</span> <span class="n">sentinel_lines</span>
        <span class="n">sents2</span> <span class="o">=</span> <span class="n">new_sentinel_lines2</span>
        <span class="k">if</span> <span class="mi">1</span><span class="p">:</span> <span class="c"># Ignore trailing ws:</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines1</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
            <span class="n">s2</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines2</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
            <span class="n">lines1</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">s1</span><span class="p">)</span>
            <span class="n">lines2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span>
        <span class="k">if</span> <span class="mi">1</span><span class="p">:</span> <span class="c"># Ignore trailing ws on every line.</span>
            <span class="n">lines1</span> <span class="o">=</span> <span class="p">[</span><span class="n">z</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">lines1</span><span class="p">]</span>
            <span class="n">lines2</span> <span class="o">=</span> <span class="p">[</span><span class="n">z</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">lines2</span><span class="p">]</span>
            <span class="n">sents1</span> <span class="o">=</span> <span class="p">[</span><span class="n">z</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">sents1</span><span class="p">]</span>
            <span class="n">sents2</span> <span class="o">=</span> <span class="p">[</span><span class="n">z</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">sents2</span><span class="p">]</span>
        <span class="n">lines_ok</span> <span class="o">=</span> <span class="n">lines1</span> <span class="o">==</span> <span class="n">lines2</span>
        <span class="n">sents_ok</span> <span class="o">=</span> <span class="n">sents1</span> <span class="o">==</span> <span class="n">sents2</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
            <span class="c"># The unit test will report the error.</span>
            <span class="k">return</span> <span class="n">lines_ok</span> <span class="ow">and</span> <span class="n">sents_ok</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">lines_ok</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">Differ</span><span class="p">()</span>
                <span class="c"># g.trace(&#39;Different!!&#39;,d)</span>
                <span class="n">aList</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">new_public_lines2</span><span class="p">,</span><span class="n">new_public_lines</span><span class="p">))</span>
                <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">aList</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">show_error</span><span class="p">(</span>
                    <span class="n">lines1</span> <span class="o">=</span> <span class="n">new_public_lines2</span><span class="p">,</span>
                    <span class="n">lines2</span> <span class="o">=</span> <span class="n">new_public_lines</span><span class="p">,</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;Error in updating public file!&quot;</span><span class="p">,</span>
                    <span class="n">lines1_message</span> <span class="o">=</span> <span class="s">&quot;new public lines (derived from new private lines)&quot;</span><span class="p">,</span>
                    <span class="n">lines2_message</span> <span class="o">=</span> <span class="s">&quot;new public lines&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sents_ok</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">show_error</span><span class="p">(</span>
                <span class="n">lines1</span> <span class="o">=</span> <span class="n">sentinel_lines</span><span class="p">,</span>
                <span class="n">lines2</span> <span class="o">=</span> <span class="n">new_sentinel_lines2</span><span class="p">,</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;Sentinals not preserved!&quot;</span><span class="p">,</span>
                <span class="n">lines1_message</span> <span class="o">=</span> <span class="s">&quot;old sentinels&quot;</span><span class="p">,</span>
                <span class="n">lines2_message</span> <span class="o">=</span> <span class="s">&quot;new sentinels&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">lines_ok</span> <span class="ow">and</span> <span class="n">sents_ok</span>
    <span class="c">#@+node:ekr.20080708094444.37: *4* x.copy_sentinels</span></div>
<div class="viewcode-block" id="shadowController.copy_sentinels"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.copy_sentinels">[docs]</a>    <span class="k">def</span> <span class="nf">copy_sentinels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">reader</span><span class="p">,</span><span class="n">writer</span><span class="p">,</span><span class="n">marker</span><span class="p">,</span><span class="n">limit</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Copy sentinels from reader to writer while reader.index() &lt; limit.&#39;&#39;&#39;</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">index</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">reader</span><span class="o">.</span><span class="n">index</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">marker</span><span class="o">.</span><span class="n">isSentinel</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">marker</span><span class="o">.</span><span class="n">isVerbatimSentinel</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                    <span class="c"># We are *deleting* non-sentinel lines, so we must delete @verbatim sentinels!</span>
                    <span class="c"># We must **extend** the limit to get the next line.</span>
                    <span class="k">if</span> <span class="n">reader</span><span class="o">.</span><span class="n">index</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">limit</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c"># Skip the next line, whatever it is.</span>
                        <span class="c"># Important: this **deletes** the @verbatim sentinel,</span>
                        <span class="c"># so this is a exception to the rule that sentinels are preserved.</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">x</span><span class="o">.</span><span class="n">verbatim_error</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># g.trace(&#39;put line&#39;,repr(line))</span>
                    <span class="n">writer</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="n">tag</span><span class="o">=</span><span class="s">&#39;copy sent </span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">limit</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20080708094444.38: *4* x.propagate_changed_lines</span></div>
<div class="viewcode-block" id="shadowController.propagate_changed_lines"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.propagate_changed_lines">[docs]</a>    <span class="k">def</span> <span class="nf">propagate_changed_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">new_public_lines</span><span class="p">,</span><span class="n">old_private_lines</span><span class="p">,</span><span class="n">marker</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Propagate changes from &#39;new_public_lines&#39; to &#39;old_private_lines.</span>

<span class="sd">        We compare the old and new public lines, create diffs and</span>
<span class="sd">        propagate the diffs to the new private lines, copying sentinels as well.</span>

<span class="sd">        We have two invariants:</span>
<span class="sd">        1. We *never* delete any sentinels.</span>
<span class="sd">           New at 2010/01/07: Replacements preserve sentinel locations.</span>
<span class="sd">        2. Insertions that happen at the boundary between nodes will be put at</span>
<span class="sd">           the end of a node.  However, insertions must always be done within sentinels.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="c"># mapping tells which line of old_private_lines each line of old_public_lines comes from.</span>
        <span class="n">old_public_lines</span><span class="p">,</span> <span class="n">mapping</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strip_sentinels_with_map</span><span class="p">(</span><span class="n">old_private_lines</span><span class="p">,</span><span class="n">marker</span><span class="p">)</span>

        <span class="c">#@+&lt;&lt; init vars &gt;&gt;</span>
        <span class="c">#@+node:ekr.20080708094444.40: *5* &lt;&lt; init vars &gt;&gt;</span>
        <span class="n">new_private_lines_wtr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sourcewriter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c"># collects the contents of the new file.</span>

        <span class="n">new_public_lines_rdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sourcereader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">new_public_lines</span><span class="p">)</span>
            <span class="c"># Contains the changed source code.</span>

        <span class="n">old_public_lines_rdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sourcereader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">old_public_lines</span><span class="p">)</span>
            <span class="c"># this is compared to new_public_lines_rdr to find out the changes.</span>

        <span class="n">old_private_lines_rdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sourcereader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">old_private_lines</span><span class="p">)</span> <span class="c"># lines_with_sentinels)</span>
            <span class="c"># This is the file which is currently produced by Leo, with sentinels.</span>

        <span class="c"># Check that all ranges returned by get_opcodes() are contiguous</span>
        <span class="n">old_old_j</span><span class="p">,</span> <span class="n">old_i2_modified_lines</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span>

        <span class="n">tag</span> <span class="o">=</span> <span class="n">old_i</span> <span class="o">=</span> <span class="n">old_j</span> <span class="o">=</span> <span class="n">new_i</span> <span class="o">=</span> <span class="n">new_j</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c">#@-&lt;&lt; init vars &gt;&gt;</span>
        <span class="c">#@+&lt;&lt; define print_tags &gt;&gt;</span>
        <span class="c">#@+node:ekr.20080708094444.39: *5* &lt;&lt; define print_tags &gt;&gt;</span>
        <span class="k">def</span> <span class="nf">print_tags</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">old_i</span><span class="p">,</span> <span class="n">old_j</span><span class="p">,</span> <span class="n">new_i</span><span class="p">,</span> <span class="n">new_j</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>

            <span class="n">sep1</span> <span class="o">=</span> <span class="s">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">10</span> <span class="p">;</span> <span class="n">sep2</span> <span class="o">=</span> <span class="s">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">20</span>

            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="n">sep1</span><span class="p">,</span><span class="n">message</span><span class="p">,</span><span class="n">sep1</span><span class="p">,</span><span class="n">p</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="si">%s</span><span class="s">: old[</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">] new[</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="n">old_i</span><span class="p">,</span><span class="n">old_j</span><span class="p">,</span><span class="n">new_i</span><span class="p">,</span><span class="n">new_j</span><span class="p">))</span>

            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="n">sep2</span><span class="p">)</span>

            <span class="n">table</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">old_private_lines_rdr</span><span class="p">,</span><span class="s">&#39;old private lines&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="n">old_public_lines_rdr</span><span class="p">,</span><span class="s">&#39;old public lines&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="n">new_public_lines_rdr</span><span class="p">,</span><span class="s">&#39;new public lines&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="n">new_private_lines_wtr</span><span class="p">,</span><span class="s">&#39;new private lines&#39;</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">f</span><span class="p">,</span><span class="n">tag</span> <span class="ow">in</span> <span class="n">table</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="n">sep2</span><span class="p">)</span>


        <span class="c">#@-&lt;&lt; define print_tags &gt;&gt;</span>

        <span class="n">delim1</span><span class="p">,</span><span class="n">delim2</span> <span class="o">=</span> <span class="n">marker</span><span class="o">.</span><span class="n">getDelims</span><span class="p">()</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">SequenceMatcher</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="n">old_public_lines</span><span class="p">,</span><span class="n">new_public_lines</span><span class="p">)</span>
        <span class="n">prev_old_j</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">prev_new_j</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">tag</span><span class="p">,</span><span class="n">old_i</span><span class="p">,</span><span class="n">old_j</span><span class="p">,</span><span class="n">new_i</span><span class="p">,</span><span class="n">new_j</span> <span class="ow">in</span> <span class="n">sm</span><span class="o">.</span><span class="n">get_opcodes</span><span class="p">():</span>

            <span class="c">#@+&lt;&lt; About this loop &gt;&gt;</span>
            <span class="c">#@+node:ekr.20080708192807.2: *5* &lt;&lt; about this loop &gt;&gt;</span>
            <span class="c">#@+at This loop writes all output lines using a single writer:</span>
            <span class="c"># new_private_lines_wtr.</span>
            <span class="c"># </span>
            <span class="c"># The output lines come from two, and *only* two readers:</span>
            <span class="c"># </span>
            <span class="c"># 1. old_private_lines_rdr delivers the complete original sources. All</span>
            <span class="c">#    sentinels and unchanged regular lines come from this reader.</span>
            <span class="c"># </span>
            <span class="c"># 2. new_public_lines_rdr delivers the new, changed sources. All inserted or</span>
            <span class="c">#    replacement text comes from this reader.</span>
            <span class="c"># </span>
            <span class="c"># Each time through the loop, the following are true:</span>
            <span class="c"># </span>
            <span class="c"># - old_i is the index into old_public_lines of the start of the present</span>
            <span class="c">#   SequenceMatcher opcode.</span>
            <span class="c"># </span>
            <span class="c"># - mapping[old_i] is the index into old_private_lines of the start of</span>
            <span class="c">#   the same opcode.</span>
            <span class="c"># </span>
            <span class="c"># At the start of the loop, the call to copy_sentinels effectively skips</span>
            <span class="c"># (deletes) all previously unwritten non-sentinel lines in</span>
            <span class="c"># old_private_lines_rdr whose index is less than mapping[old_i].</span>
            <span class="c"># </span>
            <span class="c"># As a result, the opcode handlers do not need to delete elements from</span>
            <span class="c"># the old_private_lines_rdr explicitly. This explains why opcode</span>
            <span class="c"># handlers for the &#39;insert&#39; and &#39;delete&#39; opcodes are identical.</span>
            <span class="c">#@-&lt;&lt; About this loop &gt;&gt;</span>

            <span class="c"># Verify that SequenceMatcher never leaves gaps.</span>
            <span class="k">if</span> <span class="n">old_i</span> <span class="o">!=</span> <span class="n">prev_old_j</span><span class="p">:</span> <span class="c"># assert old_i == prev_old_j</span>
                <span class="n">x</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;can not happen: gap in old: </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">old_i</span><span class="p">,</span><span class="n">prev_old_j</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">new_i</span> <span class="o">!=</span> <span class="n">prev_new_j</span><span class="p">:</span> <span class="c"># assert new_i == prev_new_j</span>
                <span class="n">x</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;can not happen: gap in new: </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">new_i</span><span class="p">,</span><span class="n">prev_new_j</span><span class="p">))</span>

            <span class="c">#@+&lt;&lt; Handle the opcode &gt;&gt;</span>
            <span class="c">#@+node:ekr.20080708192807.5: *5* &lt;&lt; Handle the opcode &gt;&gt;</span>
            <span class="c"># Do not copy sentinels if a) we are inserting and b) limit is at the end of the old_private_lines.</span>
            <span class="c"># In this special case, we must do the insert before the sentinels.</span>
            <span class="n">limit</span><span class="o">=</span><span class="n">mapping</span><span class="p">[</span><span class="n">old_i</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;tag&#39;</span><span class="p">,</span><span class="n">tag</span><span class="p">,</span><span class="s">&#39;old_i&#39;</span><span class="p">,</span><span class="n">old_i</span><span class="p">,</span><span class="s">&#39;limit&#39;</span><span class="p">,</span><span class="n">limit</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;equal&#39;</span><span class="p">:</span>
                <span class="c"># Copy sentinels up to the limit = mapping[old_i]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">copy_sentinels</span><span class="p">(</span><span class="n">old_private_lines_rdr</span><span class="p">,</span><span class="n">new_private_lines_wtr</span><span class="p">,</span><span class="n">marker</span><span class="p">,</span><span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>

                <span class="c"># Copy all lines (including sentinels) from the old private file to the new private file.</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">old_private_lines_rdr</span><span class="o">.</span><span class="n">index</span><span class="p">()</span> <span class="c"># Only used for tag.</span>
                <span class="k">while</span> <span class="n">old_private_lines_rdr</span><span class="o">.</span><span class="n">index</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">mapping</span><span class="p">[</span><span class="n">old_j</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">old_private_lines_rdr</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                    <span class="n">new_private_lines_wtr</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="n">tag</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">tag</span><span class="p">,</span><span class="n">start</span><span class="p">,</span><span class="n">mapping</span><span class="p">[</span><span class="n">old_j</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

                <span class="c"># Ignore all new lines up to new_j: the same lines (with sentinels) have just been written.</span>
                <span class="n">new_public_lines_rdr</span><span class="o">.</span><span class="n">sync</span><span class="p">(</span><span class="n">new_j</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;insert&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">limit</span> <span class="o">&lt;</span> <span class="n">old_private_lines_rdr</span><span class="o">.</span><span class="n">size</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">copy_sentinels</span><span class="p">(</span><span class="n">old_private_lines_rdr</span><span class="p">,</span><span class="n">new_private_lines_wtr</span><span class="p">,</span><span class="n">marker</span><span class="p">,</span><span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
                <span class="c"># All unwritten lines from old_private_lines_rdr up to mapping[old_i] have already been ignored.</span>
                <span class="c"># Copy lines from new_public_lines_rdr up to new_j.</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">new_public_lines_rdr</span><span class="o">.</span><span class="n">index</span><span class="p">()</span> <span class="c"># Only used for tag.</span>
                <span class="k">while</span> <span class="n">new_public_lines_rdr</span><span class="o">.</span><span class="n">index</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">new_j</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">new_public_lines_rdr</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">marker</span><span class="o">.</span><span class="n">isSentinel</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                        <span class="n">new_private_lines_wtr</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                            <span class="s">&#39;</span><span class="si">%s</span><span class="s">@verbatim</span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">delim1</span><span class="p">,</span><span class="n">delim2</span><span class="p">),</span>
                            <span class="n">tag</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;new sent&#39;</span><span class="p">,</span><span class="n">start</span><span class="p">,</span><span class="n">new_j</span><span class="p">))</span>
                    <span class="n">new_private_lines_wtr</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="n">tag</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="n">start</span><span class="p">,</span><span class="n">new_j</span><span class="p">))</span>

            <span class="k">elif</span> <span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;replace&#39;</span><span class="p">:</span>
                <span class="c"># This case is new: it was the same as the &#39;insert&#39; case.</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">old_private_lines_rdr</span><span class="o">.</span><span class="n">index</span><span class="p">()</span> <span class="c"># Only used for tag.</span>
                <span class="k">while</span> <span class="p">(</span>
                    <span class="n">old_private_lines_rdr</span><span class="o">.</span><span class="n">index</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">mapping</span><span class="p">[</span><span class="n">old_j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="ow">and</span> <span class="n">new_public_lines_rdr</span><span class="o">.</span><span class="n">index</span><span class="p">()</span> <span class="o">&lt;</span>  <span class="n">new_j</span>
                        <span class="c"># 2010/10/22: the replacement lines can be shorter.</span>
                <span class="p">):</span>
                    <span class="n">old_line</span> <span class="o">=</span> <span class="n">old_private_lines_rdr</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">marker</span><span class="o">.</span><span class="n">isSentinel</span><span class="p">(</span><span class="n">old_line</span><span class="p">):</span>
                        <span class="c"># Important: this should work for @verbatim sentinels</span>
                        <span class="c"># because the next line will also be replaced.</span>
                        <span class="n">new_private_lines_wtr</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">old_line</span><span class="p">,</span><span class="n">tag</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="s">&#39;replace: copy sentinel&#39;</span><span class="p">,</span><span class="n">start</span><span class="p">,</span><span class="n">new_j</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_line</span> <span class="o">=</span> <span class="n">new_public_lines_rdr</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                        <span class="n">new_private_lines_wtr</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">new_line</span><span class="p">,</span><span class="n">tag</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="s">&#39;replace: new line&#39;</span><span class="p">,</span><span class="n">start</span><span class="p">,</span><span class="n">new_j</span><span class="p">))</span>

                <span class="c"># 2010/10/22: The replacement lines can be longer: same as &#39;insert&#39; code above.</span>
                <span class="k">while</span> <span class="n">new_public_lines_rdr</span><span class="o">.</span><span class="n">index</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">new_j</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">new_public_lines_rdr</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">marker</span><span class="o">.</span><span class="n">isSentinel</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                        <span class="n">new_private_lines_wtr</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                            <span class="s">&#39;</span><span class="si">%s</span><span class="s">@verbatim</span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">delim1</span><span class="p">,</span><span class="n">delim2</span><span class="p">),</span>
                            <span class="n">tag</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;new sent&#39;</span><span class="p">,</span><span class="n">start</span><span class="p">,</span><span class="n">new_j</span><span class="p">))</span>
                    <span class="n">new_private_lines_wtr</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="n">tag</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="n">start</span><span class="p">,</span><span class="n">new_j</span><span class="p">))</span>

            <span class="k">elif</span> <span class="n">tag</span><span class="o">==</span><span class="s">&#39;delete&#39;</span><span class="p">:</span>
                <span class="c"># Copy sentinels up to the limit = mapping[old_i]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">copy_sentinels</span><span class="p">(</span><span class="n">old_private_lines_rdr</span><span class="p">,</span><span class="n">new_private_lines_wtr</span><span class="p">,</span><span class="n">marker</span><span class="p">,</span><span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
                <span class="c"># Leave new_public_lines_rdr unchanged.</span>

            <span class="k">else</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;can not happen: unknown difflib.SequenceMather tag: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">tag</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">print_tags</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">old_i</span><span class="p">,</span> <span class="n">old_j</span><span class="p">,</span> <span class="n">new_i</span><span class="p">,</span> <span class="n">new_j</span><span class="p">,</span> <span class="s">&quot;After tag&quot;</span><span class="p">)</span>
            <span class="c">#@-&lt;&lt; Handle the opcode &gt;&gt;</span>

            <span class="c"># Remember the ends of the previous tag ranges.</span>
            <span class="n">prev_old_j</span> <span class="o">=</span> <span class="n">old_j</span>
            <span class="n">prev_new_j</span> <span class="o">=</span> <span class="n">new_j</span>

        <span class="c"># Copy all unwritten sentinels.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">copy_sentinels</span><span class="p">(</span>
            <span class="n">old_private_lines_rdr</span><span class="p">,</span>
            <span class="n">new_private_lines_wtr</span><span class="p">,</span>
            <span class="n">marker</span><span class="p">,</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="n">old_private_lines_rdr</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>

        <span class="c"># Get the result.</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">new_private_lines_wtr</span><span class="o">.</span><span class="n">getlines</span><span class="p">()</span>
        <span class="k">if</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c">#@+&lt;&lt; do final correctness check&gt;&gt;</span>
            <span class="c">#@+node:ekr.20080708094444.45: *5* &lt;&lt; do final correctness check &gt;&gt;</span>
            <span class="n">t_sourcelines</span><span class="p">,</span> <span class="n">t_sentinel_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">separate_sentinels</span><span class="p">(</span>
                <span class="n">new_private_lines_wtr</span><span class="o">.</span><span class="n">lines</span><span class="p">,</span> <span class="n">marker</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">check_the_final_output</span><span class="p">(</span>
                <span class="n">new_private_lines</span>   <span class="o">=</span> <span class="n">result</span><span class="p">,</span>
                <span class="n">new_public_lines</span>    <span class="o">=</span> <span class="n">new_public_lines</span><span class="p">,</span>
                <span class="n">sentinel_lines</span>      <span class="o">=</span> <span class="n">t_sentinel_lines</span><span class="p">,</span>
                <span class="n">marker</span>              <span class="o">=</span> <span class="n">marker</span><span class="p">)</span>
            <span class="c">#@-&lt;&lt; do final correctness check&gt;&gt;</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="c">#@+node:ekr.20080708094444.36: *4* x.propagate_changes</span></div>
<div class="viewcode-block" id="shadowController.propagate_changes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.propagate_changes">[docs]</a>    <span class="k">def</span> <span class="nf">propagate_changes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_public_file</span><span class="p">,</span> <span class="n">old_private_file</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Propagate the changes from the public file (without_sentinels)</span>
<span class="sd">        to the private file (with_sentinels)&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">atFileCommands</span>
        <span class="n">at</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c"># A massive klude: read the file private file just to read the encoding.</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">old_private_file</span><span class="p">,</span><span class="s">&#39;rb&#39;</span><span class="p">)</span>
            <span class="c"># 2011/10/21: read in &#39;rb&#39; mode.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">scanHeader</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">old_private_file</span><span class="p">)</span> <span class="c"># sets at.encoding</span>
        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;*** header scanned: encoding:&#39;</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">encoding</span>
        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">old_public_lines</span>  <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">old_public_file</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;UnicodeDecodeError reading </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">old_public_file</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">old_private_lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">old_private_file</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;UnicodeDecodeError reading </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">old_private_file</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">old_public_lines</span>  <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">old_public_file</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;UnicodeDecodeError reading </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">old_public_file</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">old_private_lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">old_private_file</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;UnicodeDecodeError reading </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">old_private_file</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">None</span>

            <span class="c"># 2011/09/09: convert each line to unicode.</span>
            <span class="k">def</span> <span class="nf">cvt</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">isUnicode</span><span class="p">(</span><span class="n">s</span><span class="p">),</span><span class="n">s</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">toUnicode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">))</span>

            <span class="n">old_public_lines</span>  <span class="o">=</span> <span class="p">[</span><span class="n">cvt</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">old_public_lines</span><span class="p">]</span>
            <span class="n">old_private_lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">cvt</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">old_private_lines</span><span class="p">]</span>

        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">private lines...</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">old_private_file</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">old_private_lines</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">),</span><span class="n">g</span><span class="o">.</span><span class="n">isUnicode</span><span class="p">(</span><span class="n">s</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">public lines...</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">old_public_file</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">old_public_lines</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">),</span><span class="n">g</span><span class="o">.</span><span class="n">isUnicode</span><span class="p">(</span><span class="n">s</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>

        <span class="n">marker</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">markerFromFileLines</span><span class="p">(</span><span class="n">old_private_lines</span><span class="p">,</span><span class="n">old_private_file</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
                <span class="s">&#39;marker&#39;</span><span class="p">,</span><span class="n">marker</span><span class="p">,</span>
                <span class="s">&#39;</span><span class="se">\n</span><span class="s">public_file&#39;</span><span class="p">,</span><span class="n">old_public_file</span><span class="p">,</span>
                <span class="s">&#39;</span><span class="se">\n</span><span class="s">public lines...</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span><span class="p">(</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">listToString</span><span class="p">(</span><span class="n">old_public_lines</span><span class="p">,</span><span class="n">toRepr</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                <span class="s">&#39;</span><span class="se">\n</span><span class="s">private_file&#39;</span><span class="p">,</span><span class="n">old_private_file</span><span class="p">,</span>
                <span class="s">&#39;</span><span class="se">\n</span><span class="s">private lines...</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span><span class="p">(</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">listToString</span><span class="p">(</span><span class="n">old_private_lines</span><span class="p">,</span><span class="n">toRepr</span><span class="o">=</span><span class="bp">True</span><span class="p">)))</span>

        <span class="n">new_private_lines</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">propagate_changed_lines</span><span class="p">(</span>
            <span class="n">old_public_lines</span><span class="p">,</span><span class="n">old_private_lines</span><span class="p">,</span><span class="n">marker</span><span class="p">)</span>

        <span class="c"># Important bug fix: Never create the private file here!</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">old_private_file</span>
        <span class="n">exists</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">different</span> <span class="o">=</span> <span class="n">new_private_lines</span> <span class="o">!=</span> <span class="n">old_private_lines</span>
        <span class="n">copy</span> <span class="o">=</span> <span class="n">exists</span> <span class="ow">and</span> <span class="n">different</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">exists&#39;</span><span class="p">,</span><span class="n">exists</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span><span class="s">&#39;different&#39;</span><span class="p">,</span><span class="n">different</span><span class="p">,</span><span class="s">&#39;errors&#39;</span><span class="p">,</span><span class="n">x</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>

        <span class="c"># 2010/01/07: check at.errors also.</span>
        <span class="k">if</span> <span class="n">copy</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">errors</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">at</span><span class="o">.</span><span class="n">errors</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_private_lines</span><span class="p">)</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">replaceFileWithString</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;ok&#39;</span><span class="p">,</span><span class="n">ok</span><span class="p">,</span><span class="s">&#39;writing private file&#39;</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">copy</span>
    <span class="c">#@+node:ekr.20080708094444.34: *4* x.strip_sentinels_with_map</span></div>
<div class="viewcode-block" id="shadowController.strip_sentinels_with_map"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.strip_sentinels_with_map">[docs]</a>    <span class="k">def</span> <span class="nf">strip_sentinels_with_map</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">marker</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Strip sentinels from lines, a list of lines with sentinels.</span>

<span class="sd">        Return (results,mapping)</span>

<span class="sd">        &#39;lines&#39;:     A list of lines containing sentinels.</span>
<span class="sd">        &#39;results&#39;:   The list of non-sentinel lines.</span>
<span class="sd">        &#39;mapping&#39;:   A list mapping each line in results to the original list.</span>
<span class="sd">                    results[i] comes from line mapping[i] of the original lines.&#39;&#39;&#39;</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">;</span> <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">marker</span><span class="o">.</span><span class="n">isSentinel</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">marker</span><span class="o">.</span><span class="n">isVerbatimSentinel</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
                        <span class="c"># Not a sentinel, whatever it looks like.</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="c"># g.trace(&#39;not a sentinel&#39;,repr(line))</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                        <span class="n">mapping</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">x</span><span class="o">.</span><span class="n">verbatim_error</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">mapping</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">mapping</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span> <span class="c"># To terminate loops.</span>
        <span class="k">return</span> <span class="n">results</span><span class="p">,</span> <span class="n">mapping</span> 
    <span class="c">#@+node:bwmulder.20041231170726: *4* x.updatePublicAndPrivateFiles</span></div>
<div class="viewcode-block" id="shadowController.updatePublicAndPrivateFiles"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.updatePublicAndPrivateFiles">[docs]</a>    <span class="k">def</span> <span class="nf">updatePublicAndPrivateFiles</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">root</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span><span class="n">shadow_fn</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;handle crucial @shadow read logic.</span>

<span class="sd">        This will be called only if the public and private files both exist.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">isSignificantPublicFile</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="c"># Update the private shadow file from the public file.</span>
            <span class="n">written</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">propagate_changes</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">shadow_fn</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">written</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s">&quot;updated private </span><span class="si">%s</span><span class="s"> from public </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">shadow_fn</span><span class="p">,</span> <span class="n">fn</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">no change to </span><span class="si">%s</span><span class="s"> = </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">shadow_fn</span><span class="p">,</span><span class="n">fn</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;not significant&#39;</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
            <span class="c"># Don&#39;t write *anything*.</span>
            <span class="c"># if 0: # This causes considerable problems.</span>
                <span class="c"># # Create the public file from the private shadow file.</span>
                <span class="c"># x.copy_file_removing_sentinels(shadow_fn,fn)</span>
                <span class="c"># x.message(&quot;created public %s from private %s &quot; % (fn, shadow_fn))</span>
    <span class="c">#@+node:ekr.20080708094444.89: *3* x.Utils...</span>
    <span class="c">#@+node:ekr.20080708094444.85: *4* x.error &amp; message &amp; verbatim_error</span></div>
<div class="viewcode-block" id="shadowController.error"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.error">[docs]</a>    <span class="k">def</span> <span class="nf">error</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">silent</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="c"># For unit testing.</span>
        <span class="n">x</span><span class="o">.</span><span class="n">last_error</span> <span class="o">=</span> <span class="n">s</span>
        <span class="n">x</span><span class="o">.</span><span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>
</div>
<div class="viewcode-block" id="shadowController.message"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.message">[docs]</a>    <span class="k">def</span> <span class="nf">message</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&#39;orange&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="shadowController.verbatim_error"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.verbatim_error">[docs]</a>    <span class="k">def</span> <span class="nf">verbatim_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">x</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;file syntax error: nothing follows verbatim sentinel&#39;</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>
    <span class="c">#@+node:ekr.20090529125512.6122: *4* x.markerFromFileLines &amp; helper</span></div>
<div class="viewcode-block" id="shadowController.markerFromFileLines"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.markerFromFileLines">[docs]</a>    <span class="k">def</span> <span class="nf">markerFromFileLines</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>  <span class="c"># fn used only for traces.</span>

        <span class="sd">&#39;&#39;&#39;Return the sentinel delimiter comment to be used for filename.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">at</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">atFileCommands</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">findLeoLine</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">ok</span><span class="p">,</span><span class="n">junk</span><span class="p">,</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">,</span><span class="n">junk</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">parseLeoSentinel</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">end</span><span class="p">:</span>
            <span class="n">delims</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">start</span><span class="p">,</span><span class="n">end</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">delims</span> <span class="o">=</span> <span class="n">start</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;delim1 </span><span class="si">%s</span><span class="s"> delim2 </span><span class="si">%s</span><span class="s"> delim3 </span><span class="si">%s</span><span class="s"> fn </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">delims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">delims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">delims</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">fn</span><span class="p">))</span>

        <span class="n">marker</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">markerClass</span><span class="p">(</span><span class="n">delims</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">marker</span>
    <span class="c">#@+node:ekr.20090529125512.6125: *5* x.findLeoLine</span></div>
<div class="viewcode-block" id="shadowController.findLeoLine"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.findLeoLine">[docs]</a>    <span class="k">def</span> <span class="nf">findLeoLine</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lines</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the @+leo line, or &#39;&#39;.&#39;&#39;&#39;</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;@+leo&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">line</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;&#39;</span>
    <span class="c">#@+node:ekr.20080708094444.9: *4* x.markerFromFileName</span></div>
<div class="viewcode-block" id="shadowController.markerFromFileName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.markerFromFileName">[docs]</a>    <span class="k">def</span> <span class="nf">markerFromFileName</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the sentinel delimiter comment to be used for filename.&#39;&#39;&#39;</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="n">root</span><span class="p">,</span><span class="n">ext</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ext</span><span class="o">==</span><span class="s">&#39;.tmp&#39;</span><span class="p">:</span>
            <span class="n">root</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>

        <span class="n">delims</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">comment_delims_from_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">markerClass</span><span class="p">(</span><span class="n">delims</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">marker</span>
    <span class="c">#@+node:ekr.20080708094444.30: *4* x.push_filter_mapping</span></div>
<div class="viewcode-block" id="shadowController.push_filter_mapping"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.push_filter_mapping">[docs]</a>    <span class="k">def</span> <span class="nf">push_filter_mapping</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span> <span class="n">marker</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given the lines of a file, filter out all</span>
<span class="sd">        Leo sentinels, and return a mapping:</span>

<span class="sd">          stripped file -&gt; original file</span>

<span class="sd">        Filtering should be the same as</span>
<span class="sd">        separate_sentinels</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">mapping</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">marker</span><span class="o">.</span><span class="n">isSentinel</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">marker</span><span class="o">.</span><span class="n">isVerbatimSentinel</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
                        <span class="n">mapping</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">x</span><span class="o">.</span><span class="n">verbatim_error</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mapping</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">mapping</span> 
    <span class="c">#@+node:ekr.20080708094444.29: *4* x.separate_sentinels</span></div>
<div class="viewcode-block" id="shadowController.separate_sentinels"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.separate_sentinels">[docs]</a>    <span class="k">def</span> <span class="nf">separate_sentinels</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">marker</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Separates regular lines from sentinel lines.</span>

<span class="sd">        Returns (regular_lines, sentinel_lines)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">regular_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sentinel_lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">marker</span><span class="o">.</span><span class="n">isSentinel</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                <span class="n">sentinel_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">marker</span><span class="o">.</span><span class="n">isVerbatimSentinel</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">regular_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">x</span><span class="o">.</span><span class="n">verbatim_error</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">regular_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">regular_lines</span><span class="p">,</span> <span class="n">sentinel_lines</span> 
    <span class="c">#@+node:ekr.20080708094444.33: *4* x.show_error &amp; helper</span></div>
<div class="viewcode-block" id="shadowController.show_error"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.show_error">[docs]</a>    <span class="k">def</span> <span class="nf">show_error</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines1</span><span class="p">,</span> <span class="n">lines2</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">lines1_message</span><span class="p">,</span> <span class="n">lines2_message</span><span class="p">):</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">banner1</span> <span class="o">=</span> <span class="s">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">30</span>
        <span class="n">banner2</span> <span class="o">=</span> <span class="s">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">30</span>
        <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">banner1</span><span class="p">,</span><span class="n">message</span><span class="p">,</span><span class="n">banner1</span><span class="p">,</span><span class="n">lines1_message</span><span class="p">,</span><span class="n">banner2</span><span class="p">))</span>

        <span class="n">x</span><span class="o">.</span><span class="n">show_error_lines</span><span class="p">(</span><span class="n">lines1</span><span class="p">,</span><span class="s">&#39;shadow_errors.tmp1&#39;</span><span class="p">)</span>

        <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">banner1</span><span class="p">,</span><span class="n">lines2_message</span><span class="p">,</span><span class="n">banner1</span><span class="p">))</span>

        <span class="n">x</span><span class="o">.</span><span class="n">show_error_lines</span><span class="p">(</span><span class="n">lines2</span><span class="p">,</span><span class="s">&#39;shadow_errors.tmp2&#39;</span><span class="p">)</span>

        <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">@shadow did not pick up the external changes correctly&#39;</span><span class="p">)</span>

        <span class="c"># g.es_print(&#39;Please check shadow.tmp1 and shadow.tmp2 for differences&#39;)</span>
    <span class="c">#@+node:ekr.20080822065427.4: *5* show_error_lines</span></div>
<div class="viewcode-block" id="shadowController.show_error_lines"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.show_error_lines">[docs]</a>    <span class="k">def</span> <span class="nf">show_error_lines</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span><span class="n">fileName</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%3s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">line</span><span class="p">)))</span>

        <span class="k">if</span> <span class="bp">False</span><span class="p">:</span> <span class="c"># Only for major debugging.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">f1</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span> <span class="c"># 2010/08/27</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span><span class="n">reportErrors</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">f1</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
                <span class="n">f1</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;can not open&#39;</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20080709062932.2: *3* atShadowTestCase</span></div>
<div class="viewcode-block" id="shadowController.atShadowTestCase"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.atShadowTestCase">[docs]</a>    <span class="k">class</span> <span class="nc">atShadowTestCase</span> <span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Support @shadow-test nodes.</span>

<span class="sd">        These nodes should have two descendant nodes: &#39;before&#39; and &#39;after&#39;.</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c">#@+others</span>
        <span class="c">#@+node:ekr.20080709062932.6: *4* __init__ (atShadowTestCase)</span>
        <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">shadowController</span><span class="p">,</span><span class="n">lax</span><span class="p">,</span><span class="n">trace</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

             <span class="c"># Init the base class.</span>
            <span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">c</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lax</span> <span class="o">=</span> <span class="n">lax</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shadowController</span><span class="o">=</span><span class="n">shadowController</span>

            <span class="c"># Hard value for now.</span>
            <span class="n">delims</span> <span class="o">=</span> <span class="s">&#39;#&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">marker</span> <span class="o">=</span> <span class="n">shadowController</span><span class="o">.</span><span class="n">markerClass</span><span class="p">(</span><span class="n">delims</span><span class="p">)</span>

            <span class="c"># For teardown...</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ok</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c">#@+node:ekr.20080709062932.7: *4*  fail (atShadowTestCase)</span>
<div class="viewcode-block" id="shadowController.atShadowTestCase.fail"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.atShadowTestCase.fail">[docs]</a>        <span class="k">def</span> <span class="nf">fail</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">msg</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

            <span class="sd">&quot;&quot;&quot;Mark a unit test as having failed.&quot;&quot;&quot;</span>

            <span class="kn">import</span> <span class="nn">leo.core.leoGlobals</span> <span class="kn">as</span> <span class="nn">g</span>

            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTestDict</span><span class="p">[</span><span class="s">&quot;fail&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">()</span>
        <span class="c">#@+node:ekr.20080709062932.8: *4* setUp &amp; helpers</span></div>
<div class="viewcode-block" id="shadowController.atShadowTestCase.setUp"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.atShadowTestCase.setUp">[docs]</a>        <span class="k">def</span> <span class="nf">setUp</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span>
            <span class="c"># x = self.shadowController</span>
            <span class="n">old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findNode</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="s">&#39;old&#39;</span><span class="p">)</span>
            <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findNode</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="s">&#39;new&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">old_private_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makePrivateLines</span><span class="p">(</span><span class="n">old</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_private_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makePrivateLines</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">old_public_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makePublicLines</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_private_lines</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">new_public_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makePublicLines</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_private_lines</span><span class="p">)</span>

            <span class="c"># We must change node:new to node:old</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">expected_private_lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mungePrivateLines</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_private_lines</span><span class="p">,</span><span class="s">&#39;node:new&#39;</span><span class="p">,</span><span class="s">&#39;node:old&#39;</span><span class="p">)</span>

        <span class="c">#@+node:ekr.20080709062932.19: *5* findNode</span></div>
<div class="viewcode-block" id="shadowController.atShadowTestCase.findNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.atShadowTestCase.findNode">[docs]</a>        <span class="k">def</span> <span class="nf">findNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">headline</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">findNodeInTree</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">headline</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;can not find&#39;</span><span class="p">,</span><span class="n">headline</span><span class="p">)</span>
                <span class="k">assert</span> <span class="bp">False</span>
            <span class="k">return</span> <span class="n">p</span>
        <span class="c">#@+node:ekr.20080709062932.20: *5* createSentinelNode</span></div>
<div class="viewcode-block" id="shadowController.atShadowTestCase.createSentinelNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.atShadowTestCase.createSentinelNode">[docs]</a>        <span class="k">def</span> <span class="nf">createSentinelNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">root</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

            <span class="sd">&#39;&#39;&#39;Write p&#39;s tree to a string, as if to a file.&#39;&#39;&#39;</span>

            <span class="n">h</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">insertAsLastChild</span><span class="p">()</span>
            <span class="n">p2</span><span class="o">.</span><span class="n">setHeadString</span><span class="p">(</span><span class="n">h</span> <span class="o">+</span> <span class="s">&#39;-sentinels&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">p2</span>

        <span class="c">#@+node:ekr.20080709062932.21: *5* makePrivateLines</span></div>
<div class="viewcode-block" id="shadowController.atShadowTestCase.makePrivateLines"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.atShadowTestCase.makePrivateLines">[docs]</a>        <span class="k">def</span> <span class="nf">makePrivateLines</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">at</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">atFileCommands</span>

            <span class="n">at</span><span class="o">.</span><span class="n">write</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span>
                <span class="n">nosentinels</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
                <span class="n">thinFile</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>  <span class="c"># Debatable.</span>
                <span class="n">scriptWrite</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                <span class="n">toString</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>

            <span class="n">s</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">stringOutput</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="c">#@+node:ekr.20080709062932.22: *5* makePublicLines</span></div>
<div class="viewcode-block" id="shadowController.atShadowTestCase.makePublicLines"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.atShadowTestCase.makePublicLines">[docs]</a>        <span class="k">def</span> <span class="nf">makePublicLines</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lines</span><span class="p">):</span>

            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shadowController</span>

            <span class="n">lines</span><span class="p">,</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">strip_sentinels_with_map</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">marker</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">lines</span>
        <span class="c">#@+node:ekr.20080709062932.23: *5* mungePrivateLines</span></div>
<div class="viewcode-block" id="shadowController.atShadowTestCase.mungePrivateLines"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.atShadowTestCase.mungePrivateLines">[docs]</a>        <span class="k">def</span> <span class="nf">mungePrivateLines</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span><span class="n">find</span><span class="p">,</span><span class="n">replace</span><span class="p">):</span>

            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shadowController</span> <span class="p">;</span> <span class="n">marker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">marker</span>

            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="p">;</span> <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">marker</span><span class="o">.</span><span class="n">isSentinel</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                    <span class="n">new_line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">find</span><span class="p">,</span><span class="n">replace</span><span class="p">)</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_line</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">marker</span><span class="o">.</span><span class="n">isVerbatimSentinel</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">x</span><span class="o">.</span><span class="n">verbatim_error</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">return</span> <span class="n">results</span>
        <span class="c">#@+node:ekr.20080709062932.9: *4* tearDown</span></div>
<div class="viewcode-block" id="shadowController.atShadowTestCase.tearDown"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.atShadowTestCase.tearDown">[docs]</a>        <span class="k">def</span> <span class="nf">tearDown</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="k">pass</span>

            <span class="c"># No change is made to the outline.</span>
            <span class="c"># self.c.redraw()</span>
        <span class="c">#@+node:ekr.20080709062932.10: *4* runTest (atShadowTestCase)</span></div>
<div class="viewcode-block" id="shadowController.atShadowTestCase.runTest"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.atShadowTestCase.runTest">[docs]</a>        <span class="k">def</span> <span class="nf">runTest</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">define_g</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>

            <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shadowController</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="n">results</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">propagate_changed_lines</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">new_public_lines</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">old_private_lines</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">marker</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">lax</span> <span class="ow">and</span> <span class="n">results</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_private_lines</span><span class="p">:</span>

                <span class="c"># g.pr(&#39;%s\natShadowTestCase.runTest:failure\n%s&#39; % (&#39;*&#39; * 40,p.h))</span>
                <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">aList</span><span class="p">,</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">results</span><span class="p">,</span><span class="s">&#39;results&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expected_private_lines</span><span class="p">,</span><span class="s">&#39;expected_private_lines&#39;</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">...&#39;</span> <span class="o">%</span> <span class="n">tag</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">aList</span><span class="p">):</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%3s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">line</span><span class="p">)))</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>

                <span class="k">assert</span> <span class="n">results</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_private_lines</span>

            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ok</span>
        <span class="c">#@+node:ekr.20080709062932.11: *4* shortDescription</span></div>
<div class="viewcode-block" id="shadowController.atShadowTestCase.shortDescription"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.atShadowTestCase.shortDescription">[docs]</a>        <span class="k">def</span> <span class="nf">shortDescription</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">h</span> <span class="ow">or</span> <span class="s">&#39;@test-shadow: no self.p&#39;</span>
        <span class="c">#@-others</span>

    <span class="c">#@+node:ekr.20090529061522.5727: *3* class marker</span></div></div>
<div class="viewcode-block" id="shadowController.markerClass"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.markerClass">[docs]</a>    <span class="k">class</span> <span class="nc">markerClass</span><span class="p">:</span>

        <span class="sd">&#39;&#39;&#39;A class representing comment delims in @shadow files.&#39;&#39;&#39;</span>

        <span class="c">#@+others</span>
        <span class="c">#@+node:ekr.20090529061522.6257: *4* markerClass.ctor &amp; repr</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">delims</span><span class="p">):</span>

            <span class="n">delim1</span><span class="p">,</span><span class="n">delim2</span><span class="p">,</span><span class="n">delim3</span> <span class="o">=</span> <span class="n">delims</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delim1</span> <span class="o">=</span> <span class="n">delim1</span> <span class="c"># Single-line comment delim.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delim2</span> <span class="o">=</span> <span class="n">delim2</span> <span class="c"># Block comment starting delim.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delim3</span> <span class="o">=</span> <span class="n">delim3</span> <span class="c"># Block comment ending delim.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">delim1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">delim2</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delim1</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">language_delims_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;unknown_language&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">__repr__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delim1</span><span class="p">:</span>
                <span class="n">delims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delim1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">delims</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delim2</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">delim2</span><span class="p">)</span>

            <span class="k">return</span> <span class="s">&#39;&lt;markerClass: delims: </span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">delims</span><span class="p">)</span>
        <span class="c">#@+node:ekr.20090529061522.6258: *4* getDelims</span>
<div class="viewcode-block" id="shadowController.markerClass.getDelims"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.markerClass.getDelims">[docs]</a>        <span class="k">def</span> <span class="nf">getDelims</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delim1</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">delim1</span><span class="p">,</span><span class="s">&#39;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">delim2</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">delim3</span>
        <span class="c">#@+node:ekr.20090529061522.6259: *4* isSentinel</span></div>
<div class="viewcode-block" id="shadowController.markerClass.isSentinel"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.markerClass.isSentinel">[docs]</a>        <span class="k">def</span> <span class="nf">isSentinel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">suffix</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;Return True is line s contains a valid sentinel comment.&#39;&#39;&#39;</span>

            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delim1</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delim1</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delim1</span><span class="o">+</span><span class="s">&#39;@&#39;</span><span class="o">+</span><span class="n">suffix</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">delim2</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delim2</span><span class="o">+</span><span class="s">&#39;@&#39;</span><span class="o">+</span><span class="n">suffix</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delim3</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="c">#@+node:ekr.20090529061522.6260: *4* isVerbatimSentinel</span></div>
<div class="viewcode-block" id="shadowController.markerClass.isVerbatimSentinel"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.markerClass.isVerbatimSentinel">[docs]</a>        <span class="k">def</span> <span class="nf">isVerbatimSentinel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">isSentinel</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">suffix</span><span class="o">=</span><span class="s">&#39;verbatim&#39;</span><span class="p">)</span>
        <span class="c">#@-others</span>

    <span class="c">#@+node:ekr.20080708094444.12: *3* class sourcereader</span></div></div>
<div class="viewcode-block" id="shadowController.sourcereader"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.sourcereader">[docs]</a>    <span class="k">class</span> <span class="nc">sourcereader</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A class to read lines sequentially.</span>

<span class="sd">        The class keeps an internal index, so that each</span>
<span class="sd">        call to get returns the next line.</span>

<span class="sd">        Index returns the internal index, and sync</span>
<span class="sd">        advances the index to the the desired line.</span>

<span class="sd">        The index is the *next* line to be returned.</span>

<span class="sd">        The line numbering starts from 0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#@+others</span>
        <span class="c">#@+node:ekr.20080708094444.13: *4* __init__ (sourcereader)</span>
        <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">shadowController</span><span class="p">,</span><span class="n">lines</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="n">lines</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shadowController</span><span class="o">=</span><span class="n">shadowController</span>
        <span class="c">#@+node:ekr.20080708094444.14: *4* index</span>
<div class="viewcode-block" id="shadowController.sourcereader.index"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.sourcereader.index">[docs]</a>        <span class="k">def</span> <span class="nf">index</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span>
        <span class="c">#@+node:ekr.20080708094444.15: *4* get</span></div>
<div class="viewcode-block" id="shadowController.sourcereader.get"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.sourcereader.get">[docs]</a>        <span class="k">def</span> <span class="nf">get</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="sd">&#39;&#39;&#39;Return the next line.&#39;&#39;&#39;</span>

            <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

            <span class="k">if</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># Old code: crashed.</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># A simple-minded guard.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">):</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">result</span> 
        <span class="c">#@+node:ekr.20080708094444.16: *4* sync</span></div>
<div class="viewcode-block" id="shadowController.sourcereader.sync"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.sourcereader.sync">[docs]</a>        <span class="k">def</span> <span class="nf">sync</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="n">i</span> 
        <span class="c">#@+node:ekr.20080708094444.17: *4* size</span></div>
<div class="viewcode-block" id="shadowController.sourcereader.size"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.sourcereader.size">[docs]</a>        <span class="k">def</span> <span class="nf">size</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span> 
        <span class="c">#@+node:ekr.20080708094444.18: *4* atEnd</span></div>
<div class="viewcode-block" id="shadowController.sourcereader.atEnd"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.sourcereader.atEnd">[docs]</a>        <span class="k">def</span> <span class="nf">atEnd</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span>
        <span class="c">#@+node:ekr.20080708094444.19: *4* clone (not used)</span>
        <span class="c"># def clone(self):</span>
            <span class="c"># sr = self.shadowController.sourcereader(shadowController,self.lines)</span>
            <span class="c"># sr.i = self.i</span>
            <span class="c"># return sr</span>
        <span class="c">#@+node:ekr.20080708094444.20: *4* dump</span></div>
<div class="viewcode-block" id="shadowController.sourcereader.dump"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.sourcereader.dump">[docs]</a>        <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span>

            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
            <span class="c"># g.pr(&#39;self.i&#39;,self.i)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">):</span>
                <span class="n">marker</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;**&#39;</span><span class="p">,</span><span class="s">&#39;  &#39;</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> </span><span class="si">%3s</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">marker</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">line</span><span class="p">)),)</span>
        <span class="c">#@-others</span>
    <span class="c">#@+node:ekr.20080708094444.21: *3* class sourcewriter</span></div></div>
<div class="viewcode-block" id="shadowController.sourcewriter"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.sourcewriter">[docs]</a>    <span class="k">class</span> <span class="nc">sourcewriter</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience class to capture output to a file.</span>

<span class="sd">        Similar to class sourcereader.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#@+others</span>
        <span class="c">#@+node:ekr.20080708094444.22: *4* __init__ (sourcewriter)</span>
        <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">shadowController</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span><span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shadowController</span><span class="o">=</span><span class="n">shadowController</span>
        <span class="c">#@+node:ekr.20080708094444.23: *4* put</span>
<div class="viewcode-block" id="shadowController.sourcewriter.put"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.sourcewriter.put">[docs]</a>        <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>

            <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

            <span class="c"># An important hack.  Make sure *all* lines end with a newline.</span>
            <span class="c"># This will cause a mismatch later in check_the_final_output,</span>
            <span class="c"># and a special case has been inserted to forgive this newline.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;adding newline&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="o">+=</span><span class="mi">1</span>

            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%30s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">line</span><span class="p">)))</span>
        <span class="c">#@+node:ekr.20080708094444.24: *4* index</span></div>
<div class="viewcode-block" id="shadowController.sourcewriter.index"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.sourcewriter.index">[docs]</a>        <span class="k">def</span> <span class="nf">index</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span> 
        <span class="c">#@+node:ekr.20080708094444.25: *4* getlines</span></div>
<div class="viewcode-block" id="shadowController.sourcewriter.getlines"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.sourcewriter.getlines">[docs]</a>        <span class="k">def</span> <span class="nf">getlines</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> 
        <span class="c">#@+node:ekr.20080708094444.26: *4* dump</span></div>
<div class="viewcode-block" id="shadowController.sourcewriter.dump"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoShadow.shadowController.sourcewriter.dump">[docs]</a>        <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span>

            <span class="sd">&#39;&#39;&#39;Dump lines for debugging.&#39;&#39;&#39;</span>

            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">):</span>
                <span class="n">marker</span> <span class="o">=</span> <span class="s">&#39;  &#39;</span>
                <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> </span><span class="si">%3s</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">marker</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">line</span><span class="p">)),</span><span class="n">newline</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="c">#@-others</span>
    <span class="c">#@-others</span>
<span class="c">#@-others</span>
<span class="c">#@-leo</span></div></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Leo API 4.11dev documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Ed K. Ream.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
  </body>
</html>