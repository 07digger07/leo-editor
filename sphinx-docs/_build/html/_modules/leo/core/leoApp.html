<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>leo.core.leoApp &mdash; Leo API 4.11dev documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '4.11dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Leo API 4.11dev documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Leo API 4.11dev documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for leo.core.leoApp</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="c">#@+leo-ver=5-thin</span>
<span class="c">#@+node:ekr.20031218072017.2608: * @file leoApp.py</span>
<span class="c">#@@first</span>

<span class="c">#@@language python</span>
<span class="c">#@@tabwidth -4</span>
<span class="c">#@@pagewidth 60</span>

<span class="c">#@+&lt;&lt; imports &gt;&gt;</span>
<span class="c">#@+node:ekr.20120219194520.10463: ** &lt;&lt; imports &gt;&gt; (leoApp)</span>
<span class="kn">import</span> <span class="nn">leo.core.leoGlobals</span> <span class="kn">as</span> <span class="nn">g</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">optparse</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">zipfile</span>

<span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">io</span>
    <span class="n">StringIO</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">cStringIO</span>
    <span class="n">StringIO</span> <span class="o">=</span> <span class="n">cStringIO</span><span class="o">.</span><span class="n">StringIO</span>
<span class="c">#@-&lt;&lt; imports &gt;&gt;</span>

<span class="c">#@+others</span>
<span class="c">#@+node:ekr.20120209051836.10241: ** class LeoApp</span>
<div class="viewcode-block" id="LeoApp"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LeoApp">[docs]</a><span class="k">class</span> <span class="nc">LeoApp</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;A class representing the Leo application itself.</span>

<span class="sd">    Ivars of this class are Leo&#39;s global variables.&quot;&quot;&quot;</span>

    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20031218072017.1416: *3* app.__init__</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="p">(</span><span class="bp">False</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">trace_startup</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;leoApp.__init__&#39;</span><span class="p">)</span>

        <span class="c"># These ivars are Leo&#39;s global vars.</span>
        <span class="c"># leoGlobals.py contains global switches to be set by hand.</span>

        <span class="c"># Command-line arguments...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batchMode</span> <span class="o">=</span> <span class="bp">False</span>          <span class="c"># True: run in batch mode.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enablePlugins</span> <span class="o">=</span> <span class="bp">True</span>       <span class="c"># True: run start1 hook to load plugins. --no-plugins</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gui</span> <span class="o">=</span> <span class="bp">None</span>                 <span class="c"># The gui class.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">guiArgName</span> <span class="o">=</span> <span class="bp">None</span>          <span class="c"># The gui name given in --gui option.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qt_use_tabs</span> <span class="o">=</span> <span class="bp">False</span>        <span class="c"># True: allow tabbed main window.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restore_session</span> <span class="o">=</span> <span class="bp">False</span>    <span class="c"># True: restore session on startup.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_session</span> <span class="o">=</span> <span class="bp">False</span>       <span class="c"># True: save session on close.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">silentMode</span> <span class="o">=</span> <span class="bp">False</span>         <span class="c"># True: no signon.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_fullscreen</span> <span class="o">=</span> <span class="bp">False</span>   <span class="c"># For qtGui plugin.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_maximized</span> <span class="o">=</span> <span class="bp">False</span>    <span class="c"># For qtGui plugin.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_minimized</span> <span class="o">=</span> <span class="bp">False</span>    <span class="c"># For qtGui plugin.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">translateToUpperCase</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># Never set to True.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">useIpython</span> <span class="o">=</span> <span class="bp">False</span>         <span class="c"># True: add support for IPython.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_psyco</span> <span class="o">=</span> <span class="bp">False</span>          <span class="c"># True: use psyco optimization.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_splash_screen</span> <span class="o">=</span> <span class="bp">True</span>   <span class="c"># True: put up a splash screen.</span>

        <span class="c"># Debugging &amp; statistics...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>                  <span class="c"># General purpose debugging count.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="bp">False</span>              <span class="c"># Enable debugging. (Can be slow.)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debugSwitch</span> <span class="o">=</span> <span class="mi">0</span>            <span class="c"># 0: Brief; 1: Full.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disable_redraw</span> <span class="o">=</span> <span class="bp">False</span>     <span class="c"># True: disable all redraws.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disableSave</span> <span class="o">=</span> <span class="bp">False</span>        <span class="c"># May be set by plugins.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positions</span> <span class="o">=</span> <span class="mi">0</span>              <span class="c"># The number of positions generated.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scanErrors</span> <span class="o">=</span> <span class="mi">0</span>             <span class="c"># The number of errors seen by g.scanError.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statsDict</span> <span class="o">=</span> <span class="p">{}</span>             <span class="c"># dict used by g.stat, g.clear_stats, g.print_stats.</span>

        <span class="c"># Error messages...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atPathInBodyWarning</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># Set by get_directives_dict.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">menuWarningsGiven</span> <span class="o">=</span> <span class="bp">False</span>  <span class="c"># True: supress warnings in menu code.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unicodeErrorGiven</span> <span class="o">=</span> <span class="bp">True</span>   <span class="c"># True: suppres unicode tracebacks.</span>

        <span class="c"># Global directories...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extensionsDir</span> <span class="o">=</span> <span class="bp">None</span>   <span class="c"># The leo/extensions directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">globalConfigDir</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># leo/config directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">globalOpenDir</span> <span class="o">=</span> <span class="bp">None</span>   <span class="c"># The directory last used to open a file.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">homeDir</span> <span class="o">=</span> <span class="bp">None</span>         <span class="c"># The user&#39;s home directory.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">homeLeoDir</span> <span class="o">=</span> <span class="bp">None</span>      <span class="c"># The user&#39;s home/.leo directory.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadDir</span> <span class="o">=</span> <span class="bp">None</span>         <span class="c"># The leo/core directory.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">machineDir</span> <span class="o">=</span> <span class="bp">None</span>      <span class="c"># The machine-specific directory.</span>

        <span class="c"># Global data...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">globalKillBuffer</span> <span class="o">=</span> <span class="p">[]</span>      <span class="c"># The global kill buffer.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">globalRegisters</span> <span class="o">=</span> <span class="p">{}</span>       <span class="c"># The global register list.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leoID</span> <span class="o">=</span> <span class="bp">None</span>               <span class="c"># The id part of gnx&#39;s.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lossage</span> <span class="o">=</span> <span class="p">[]</span>               <span class="c"># List of last 100 keystrokes.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numberOfUntitledWindows</span><span class="o">=</span><span class="mi">0</span>  <span class="c"># Number of opened untitled windows.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">windowList</span> <span class="o">=</span> <span class="p">[]</span>            <span class="c"># Global list of all frames.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">realMenuNameDict</span> <span class="o">=</span> <span class="p">{}</span>      <span class="c"># Translations of menu names.</span>

        <span class="c"># Global controller/manager objects...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="bp">None</span>              <span class="c"># The singleton leoConfig instance.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="bp">None</span>                  <span class="c"># The singleton leoCacher instance.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadManager</span> <span class="o">=</span> <span class="bp">None</span>         <span class="c"># The singleton LoadManager instance.</span>
        <span class="c"># self.logManager = None        # The singleton LogManager instance.</span>
        <span class="c"># self.openWithManager = None   # The singleton OpenWithManager instance.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeIndices</span> <span class="o">=</span> <span class="bp">None</span>         <span class="c"># The singleton nodeIndices instance.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pluginsController</span> <span class="o">=</span> <span class="bp">None</span>   <span class="c"># The singleton PluginsManager instance.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sessionManager</span> <span class="o">=</span> <span class="bp">None</span>      <span class="c"># The singleton SessionManager instance.</span>

        <span class="c"># Global status vars...</span>

        <span class="k">if</span> <span class="mi">1</span><span class="p">:</span> <span class="c">#### To be moved to the Commands class...</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commandName</span> <span class="o">=</span> <span class="bp">None</span>         <span class="c"># The name of the command being executed.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commandInterruptFlag</span><span class="o">=</span><span class="bp">False</span> <span class="c"># True: command within a command.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dragging</span> <span class="o">=</span> <span class="bp">False</span>           <span class="c"># True: dragging.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inBridge</span> <span class="o">=</span> <span class="bp">False</span>           <span class="c"># True: running from leoBridge module.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inScript</span> <span class="o">=</span> <span class="bp">False</span>           <span class="c"># True: executing a script.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initing</span>  <span class="o">=</span> <span class="bp">True</span>            <span class="c"># True: we are initiing the app.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">killed</span>   <span class="o">=</span> <span class="bp">False</span>           <span class="c"># True: we are about to destroy the root window.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preReadFlag</span> <span class="o">=</span> <span class="bp">False</span>        <span class="c"># True: we are pre-reading a settings file.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quitting</span> <span class="o">=</span> <span class="bp">False</span>           <span class="c"># True: quitting.  Locks out some events.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reverting</span> <span class="o">=</span> <span class="bp">False</span>          <span class="c"># True: executing the revert command.</span>

        <span class="c">#### To be moved to the LogManager.</span>

        <span class="c"># The global log...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="bp">None</span>                 <span class="c"># The LeoFrame containing the present log.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logInited</span> <span class="o">=</span> <span class="bp">False</span>          <span class="c"># False: all log message go to logWaiting list.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logIsLocked</span> <span class="o">=</span> <span class="bp">False</span>        <span class="c"># True: no changes to log are allowed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logWaiting</span> <span class="o">=</span> <span class="p">[]</span>            <span class="c"># List of messages waiting to go to a log.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">printWaiting</span> <span class="o">=</span> <span class="p">[]</span>          <span class="c"># Queue of messages to be sent to the printer.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signon</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signon2</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signon_printed</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># Global types.</span>
        <span class="kn">import</span> <span class="nn">leo.core.leoFrame</span> <span class="kn">as</span> <span class="nn">leoFrame</span>
        <span class="kn">import</span> <span class="nn">leo.core.leoGui</span> <span class="kn">as</span> <span class="nn">leoGui</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nullGui</span> <span class="o">=</span> <span class="n">leoGui</span><span class="o">.</span><span class="n">nullGui</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nullLog</span> <span class="o">=</span> <span class="n">leoFrame</span><span class="o">.</span><span class="n">nullLog</span><span class="p">()</span>

        <span class="c">#### To be moved to OpenWithManager.</span>

        <span class="c"># Open with data...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hasOpenWithMenu</span> <span class="o">=</span> <span class="bp">False</span>    <span class="c"># True: open with plugin has been loaded.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">openWithFiles</span> <span class="o">=</span> <span class="p">[]</span>         <span class="c"># List of data used by Open With command.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">openWithFileNum</span> <span class="o">=</span> <span class="mi">0</span>        <span class="c"># Number of Open-With temp file names.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">openWithTable</span> <span class="o">=</span> <span class="bp">None</span>       <span class="c"># Passed to createOpenWithMenuFromTable.</span>

        <span class="c">#### To be moved to to the pluginsController.</span>

        <span class="c"># Plugins and event handlers...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">afterHandler</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hookError</span> <span class="o">=</span> <span class="bp">False</span>      <span class="c"># True: suppress further calls to hooks.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hookFunction</span> <span class="o">=</span> <span class="bp">None</span>    <span class="c"># Application wide hook function.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idle_imported</span> <span class="o">=</span> <span class="bp">False</span>  <span class="c"># True: we have done an import idle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idleTimeDelay</span> <span class="o">=</span> <span class="mi">100</span>    <span class="c"># Delay in msec between calls to &quot;idle time&quot; hook.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idleTimeHook</span> <span class="o">=</span> <span class="bp">False</span>   <span class="c"># True: the global idleTimeHookHandler will reshedule itself.</span>

        <span class="c"># Support for scripting...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">searchDict</span> <span class="o">=</span> <span class="p">{}</span>          <span class="c"># For communication between find/change scripts.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scriptDict</span> <span class="o">=</span> <span class="p">{}</span>          <span class="c"># For use by scripts. Cleared before running each script.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">permanentScriptDict</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># For use by scrips. Never cleared automatically.</span>

        <span class="c"># Unit testing...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isExternalUnitTest</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># True: we are running a unit test externally.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runningAllUnitTests</span> <span class="o">=</span> <span class="bp">False</span><span class="c"># True: we are running all unit tests (Only for local tests).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unitTestDict</span> <span class="o">=</span> <span class="p">{}</span>          <span class="c"># For communication between unit tests and code.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unitTestGui</span> <span class="o">=</span> <span class="bp">None</span>         <span class="c"># A way to override the gui in external unit tests.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unitTesting</span> <span class="o">=</span> <span class="bp">False</span>        <span class="c"># True if unit testing.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unitTestMenusDict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c"># Created in leoMenu.createMenuEntries for a unit test.</span>
            <span class="c"># keys are command names. values are sets of strokes.</span>

        <span class="c"># Define all global data.        </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">define_global_constants</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">define_language_delims_dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">define_language_extension_dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">define_extension_dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_commands_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ipk</span> <span class="o">=</span> <span class="bp">None</span>   <span class="c"># python kernel instance</span>
    <span class="c">#@+node:ekr.20031218072017.1417: *4* app.define_global_constants</span>
<div class="viewcode-block" id="LeoApp.define_global_constants"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LeoApp.define_global_constants">[docs]</a>    <span class="k">def</span> <span class="nf">define_global_constants</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># self.prolog_string = &quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;UTF-8\&quot;?&gt;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">prolog_prefix_string</span> <span class="o">=</span> <span class="s">&quot;&lt;?xml version=</span><span class="se">\&quot;</span><span class="s">1.0</span><span class="se">\&quot;</span><span class="s"> encoding=&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prolog_postfix_string</span> <span class="o">=</span> <span class="s">&quot;?&gt;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prolog_namespace_string</span> <span class="o">=</span> \
            <span class="s">&#39;xmlns:leo=&quot;http://edreamleo.org/namespaces/leo-python-editor/1.1&quot;&#39;</span>
    <span class="c">#@+node:ekr.20120522160137.9909: *4* app.define_language_delims_dict</span></div>
<div class="viewcode-block" id="LeoApp.define_language_delims_dict"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LeoApp.define_language_delims_dict">[docs]</a>    <span class="k">def</span> <span class="nf">define_language_delims_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">language_delims_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c"># Internally, lower case is used for all language names.</span>
            <span class="c"># Keys are languages, values are 1,2 or 3-tuples of delims.</span>
            <span class="s">&quot;actionscript&quot;</span>       <span class="p">:</span> <span class="s">&quot;// /* */&quot;</span><span class="p">,</span> <span class="c">#jason 2003-07-03</span>
            <span class="s">&quot;ada&quot;</span>                <span class="p">:</span> <span class="s">&quot;--&quot;</span><span class="p">,</span>
            <span class="s">&quot;ada95&quot;</span>              <span class="p">:</span> <span class="s">&quot;--&quot;</span><span class="p">,</span>
            <span class="s">&quot;ahk&quot;</span>                <span class="p">:</span> <span class="s">&quot;;&quot;</span><span class="p">,</span>
            <span class="s">&quot;antlr&quot;</span>              <span class="p">:</span> <span class="s">&quot;// /* */&quot;</span><span class="p">,</span>
            <span class="s">&quot;apacheconf&quot;</span>         <span class="p">:</span> <span class="s">&quot;#&quot;</span><span class="p">,</span>
            <span class="s">&quot;apdl&quot;</span>               <span class="p">:</span> <span class="s">&quot;!&quot;</span><span class="p">,</span>
            <span class="s">&quot;applescript&quot;</span>        <span class="p">:</span> <span class="s">&quot;-- (* *)&quot;</span><span class="p">,</span>
            <span class="s">&quot;asp&quot;</span>                <span class="p">:</span> <span class="s">&quot;&lt;!-- --&gt;&quot;</span><span class="p">,</span>
            <span class="s">&quot;aspect_j&quot;</span>           <span class="p">:</span> <span class="s">&quot;// /* */&quot;</span><span class="p">,</span>
            <span class="s">&quot;assembly_macro32&quot;</span>   <span class="p">:</span> <span class="s">&quot;;&quot;</span><span class="p">,</span>
            <span class="s">&quot;assembly_mcs51&quot;</span>     <span class="p">:</span> <span class="s">&quot;;&quot;</span><span class="p">,</span>
            <span class="s">&quot;assembly_parrot&quot;</span>    <span class="p">:</span> <span class="s">&quot;#&quot;</span><span class="p">,</span>
            <span class="s">&quot;assembly_r2000&quot;</span>     <span class="p">:</span> <span class="s">&quot;#&quot;</span><span class="p">,</span>
            <span class="s">&quot;assembly_x86&quot;</span>       <span class="p">:</span> <span class="s">&quot;;&quot;</span><span class="p">,</span>
            <span class="s">&quot;autohotkey&quot;</span>         <span class="p">:</span> <span class="s">&quot;; /* */&quot;</span><span class="p">,</span> <span class="c">#TL - AutoHotkey language</span>
            <span class="s">&quot;awk&quot;</span>                <span class="p">:</span> <span class="s">&quot;#&quot;</span><span class="p">,</span>
            <span class="s">&quot;b&quot;</span>                  <span class="p">:</span> <span class="s">&quot;// /* */&quot;</span><span class="p">,</span>
            <span class="s">&quot;batch&quot;</span>              <span class="p">:</span> <span class="s">&quot;REM_&quot;</span><span class="p">,</span> <span class="c"># Use the REM hack.</span>
            <span class="s">&quot;bbj&quot;</span>                <span class="p">:</span> <span class="s">&quot;/* */&quot;</span><span class="p">,</span>
            <span class="s">&quot;bcel&quot;</span>               <span class="p">:</span> <span class="s">&quot;// /* */&quot;</span><span class="p">,</span>
            <span class="s">&quot;bibtex&quot;</span>             <span class="p">:</span> <span class="s">&quot;%&quot;</span><span class="p">,</span>
            <span class="s">&quot;c&quot;</span>                  <span class="p">:</span> <span class="s">&quot;// /* */&quot;</span><span class="p">,</span> <span class="c"># C, C++ or objective C.</span>
            <span class="s">&quot;chill&quot;</span>              <span class="p">:</span> <span class="s">&quot;/* */&quot;</span><span class="p">,</span>
            <span class="s">&quot;cobol&quot;</span>              <span class="p">:</span> <span class="s">&quot;*&quot;</span><span class="p">,</span>
            <span class="s">&quot;coldfusion&quot;</span>         <span class="p">:</span> <span class="s">&quot;&lt;!-- --&gt;&quot;</span><span class="p">,</span>
            <span class="s">&quot;config&quot;</span>             <span class="p">:</span> <span class="s">&quot;#&quot;</span><span class="p">,</span> <span class="c"># Leo 4.5.1</span>
            <span class="s">&quot;cplusplus&quot;</span>          <span class="p">:</span> <span class="s">&quot;// /* */&quot;</span><span class="p">,</span>
            <span class="s">&quot;cpp&quot;</span>                <span class="p">:</span> <span class="s">&quot;// /* */&quot;</span><span class="p">,</span><span class="c"># C++.</span>
            <span class="s">&quot;csharp&quot;</span>             <span class="p">:</span> <span class="s">&quot;// /* */&quot;</span><span class="p">,</span> <span class="c"># C#</span>
            <span class="s">&quot;css&quot;</span>                <span class="p">:</span> <span class="s">&quot;/* */&quot;</span><span class="p">,</span> <span class="c"># 4/1/04</span>
            <span class="s">&quot;cweb&quot;</span>               <span class="p">:</span> <span class="s">&quot;@q@ @&gt;&quot;</span><span class="p">,</span> <span class="c"># Use the &quot;cweb hack&quot;</span>
            <span class="s">&quot;cython&quot;</span>             <span class="p">:</span> <span class="s">&quot;#&quot;</span><span class="p">,</span>
            <span class="s">&quot;d&quot;</span>                  <span class="p">:</span> <span class="s">&quot;// /* */&quot;</span><span class="p">,</span>
            <span class="s">&quot;doxygen&quot;</span>            <span class="p">:</span> <span class="s">&quot;#&quot;</span><span class="p">,</span>
            <span class="s">&quot;eiffel&quot;</span>             <span class="p">:</span> <span class="s">&quot;--&quot;</span><span class="p">,</span>
            <span class="s">&quot;elisp&quot;</span>              <span class="p">:</span> <span class="s">&quot;;&quot;</span><span class="p">,</span>
            <span class="s">&quot;erlang&quot;</span>             <span class="p">:</span> <span class="s">&quot;%&quot;</span><span class="p">,</span>
            <span class="s">&quot;factor&quot;</span>             <span class="p">:</span> <span class="s">&quot;! ( )&quot;</span><span class="p">,</span>
            <span class="s">&quot;forth&quot;</span>              <span class="p">:</span> <span class="s">&quot;</span><span class="se">\\</span><span class="s">_ _(_ _)&quot;</span><span class="p">,</span> <span class="c"># Use the &quot;REM hack&quot;</span>
            <span class="s">&quot;fortran&quot;</span>            <span class="p">:</span> <span class="s">&quot;C&quot;</span><span class="p">,</span>
            <span class="s">&quot;fortran90&quot;</span>          <span class="p">:</span> <span class="s">&quot;!&quot;</span><span class="p">,</span>
            <span class="s">&quot;foxpro&quot;</span>             <span class="p">:</span> <span class="s">&quot;&amp;&amp;&quot;</span><span class="p">,</span>
            <span class="s">&quot;gettext&quot;</span>            <span class="p">:</span> <span class="s">&quot;# &quot;</span><span class="p">,</span>
            <span class="s">&quot;groovy&quot;</span>             <span class="p">:</span> <span class="s">&quot;// /* */&quot;</span><span class="p">,</span>
            <span class="s">&quot;haskell&quot;</span>            <span class="p">:</span> <span class="s">&quot;--_ {-_ _-}&quot;</span><span class="p">,</span>
            <span class="s">&quot;haxe&quot;</span>               <span class="p">:</span> <span class="s">&quot;// /* */&quot;</span><span class="p">,</span>
            <span class="s">&quot;html&quot;</span>               <span class="p">:</span> <span class="s">&quot;&lt;!-- --&gt;&quot;</span><span class="p">,</span>
            <span class="s">&quot;i4gl&quot;</span>               <span class="p">:</span> <span class="s">&quot;-- { }&quot;</span><span class="p">,</span>
            <span class="s">&quot;icon&quot;</span>               <span class="p">:</span> <span class="s">&quot;#&quot;</span><span class="p">,</span>
            <span class="s">&quot;idl&quot;</span>                <span class="p">:</span> <span class="s">&quot;// /* */&quot;</span><span class="p">,</span>
            <span class="s">&quot;inform&quot;</span>             <span class="p">:</span> <span class="s">&quot;!&quot;</span><span class="p">,</span>
            <span class="s">&quot;ini&quot;</span>                <span class="p">:</span> <span class="s">&quot;;&quot;</span><span class="p">,</span>
            <span class="s">&quot;inno_setup&quot;</span>         <span class="p">:</span> <span class="s">&quot;;&quot;</span><span class="p">,</span>
            <span class="s">&quot;interlis&quot;</span>           <span class="p">:</span> <span class="s">&quot;/* */&quot;</span><span class="p">,</span>
            <span class="s">&quot;io&quot;</span>                 <span class="p">:</span> <span class="s">&quot;// */&quot;</span><span class="p">,</span>
            <span class="s">&quot;java&quot;</span>               <span class="p">:</span> <span class="s">&quot;// /* */&quot;</span><span class="p">,</span>
            <span class="s">&quot;javascript&quot;</span>         <span class="p">:</span> <span class="s">&quot;// /* */&quot;</span><span class="p">,</span> <span class="c"># EKR: 2011/11/12: For javascript import test.</span>
            <span class="s">&quot;javaserverpage&quot;</span>     <span class="p">:</span> <span class="s">&quot;&lt;</span><span class="si">%-- --%</span><span class="s">&gt;&quot;</span><span class="p">,</span> <span class="c"># EKR: 2011/11/25 (See also, jsp)</span>
            <span class="s">&quot;jhtml&quot;</span>              <span class="p">:</span> <span class="s">&quot;&lt;!-- --&gt;&quot;</span><span class="p">,</span>
            <span class="s">&quot;jmk&quot;</span>                <span class="p">:</span> <span class="s">&quot;#&quot;</span><span class="p">,</span>
            <span class="s">&quot;jsp&quot;</span>                <span class="p">:</span> <span class="s">&quot;&lt;</span><span class="si">%-- --%</span><span class="s">&gt;&quot;</span><span class="p">,</span>
            <span class="s">&quot;kshell&quot;</span>             <span class="p">:</span> <span class="s">&quot;#&quot;</span><span class="p">,</span> <span class="c"># Leo 4.5.1.</span>
            <span class="s">&quot;latex&quot;</span>              <span class="p">:</span> <span class="s">&quot;%&quot;</span><span class="p">,</span>
            <span class="s">&quot;lilypond&quot;</span>           <span class="p">:</span> <span class="s">&quot;</span><span class="si">% %</span><span class="s">{ %}&quot;</span><span class="p">,</span>
            <span class="s">&quot;lisp&quot;</span>               <span class="p">:</span> <span class="s">&quot;;&quot;</span><span class="p">,</span> <span class="c"># EKR: 2010/09/29</span>
            <span class="s">&quot;lotos&quot;</span>              <span class="p">:</span> <span class="s">&quot;(* *)&quot;</span><span class="p">,</span>
            <span class="s">&quot;lua&quot;</span>                <span class="p">:</span> <span class="s">&quot;--&quot;</span><span class="p">,</span> <span class="c"># ddm 13/02/06</span>
            <span class="s">&quot;mail&quot;</span>               <span class="p">:</span> <span class="s">&quot;&gt;&quot;</span><span class="p">,</span>
            <span class="s">&quot;makefile&quot;</span>           <span class="p">:</span> <span class="s">&quot;#&quot;</span><span class="p">,</span>
            <span class="s">&quot;maple&quot;</span>              <span class="p">:</span> <span class="s">&quot;//&quot;</span><span class="p">,</span>
            <span class="s">&quot;matlab&quot;</span>             <span class="p">:</span> <span class="s">&quot;%&quot;</span><span class="p">,</span> <span class="c"># EKR: 2011/10/21</span>
            <span class="s">&quot;md&quot;</span>                 <span class="p">:</span> <span class="s">&quot;&lt;!-- --&gt;&quot;</span><span class="p">,</span> <span class="c"># PeckJ: 2013/02/08</span>
            <span class="s">&quot;ml&quot;</span>                 <span class="p">:</span> <span class="s">&quot;(* *)&quot;</span><span class="p">,</span>
            <span class="s">&quot;modula3&quot;</span>            <span class="p">:</span> <span class="s">&quot;(* *)&quot;</span><span class="p">,</span>
            <span class="s">&quot;moin&quot;</span>               <span class="p">:</span> <span class="s">&quot;##&quot;</span><span class="p">,</span>
            <span class="s">&quot;mqsc&quot;</span>               <span class="p">:</span> <span class="s">&quot;*&quot;</span><span class="p">,</span>
            <span class="s">&quot;netrexx&quot;</span>            <span class="p">:</span> <span class="s">&quot;-- /* */&quot;</span><span class="p">,</span>
            <span class="s">&quot;noweb&quot;</span>              <span class="p">:</span> <span class="s">&quot;%&quot;</span><span class="p">,</span> <span class="c"># EKR: 2009-01-30. Use Latex for doc chunks.</span>
            <span class="s">&quot;nqc&quot;</span>                <span class="p">:</span> <span class="s">&quot;// /* */&quot;</span><span class="p">,</span>
            <span class="s">&quot;nsi&quot;</span>                <span class="p">:</span> <span class="s">&quot;;&quot;</span><span class="p">,</span> <span class="c"># EKR: 2010/10/27</span>
            <span class="s">&quot;nsis2&quot;</span>              <span class="p">:</span> <span class="s">&quot;;&quot;</span><span class="p">,</span>
            <span class="s">&quot;objective_c&quot;</span>        <span class="p">:</span> <span class="s">&quot;// /* */&quot;</span><span class="p">,</span>
            <span class="s">&quot;objectrexx&quot;</span>         <span class="p">:</span> <span class="s">&quot;-- /* */&quot;</span><span class="p">,</span>
            <span class="s">&quot;occam&quot;</span>              <span class="p">:</span> <span class="s">&quot;--&quot;</span><span class="p">,</span>
            <span class="s">&quot;omnimark&quot;</span>           <span class="p">:</span> <span class="s">&quot;;&quot;</span><span class="p">,</span>
            <span class="s">&quot;pascal&quot;</span>             <span class="p">:</span> <span class="s">&quot;// { }&quot;</span><span class="p">,</span>
            <span class="s">&quot;perl&quot;</span>               <span class="p">:</span> <span class="s">&quot;#&quot;</span><span class="p">,</span>
            <span class="s">&quot;perlpod&quot;</span>            <span class="p">:</span> <span class="s">&quot;# __=pod__ __=cut__&quot;</span><span class="p">,</span> <span class="c"># 9/25/02: The perlpod hack.</span>
            <span class="s">&quot;php&quot;</span>                <span class="p">:</span> <span class="s">&quot;// /* */&quot;</span><span class="p">,</span> <span class="c"># 6/23/07: was &quot;//&quot;,</span>
            <span class="s">&quot;pike&quot;</span>               <span class="p">:</span> <span class="s">&quot;// /* */&quot;</span><span class="p">,</span>
            <span class="s">&quot;pl1&quot;</span>                <span class="p">:</span> <span class="s">&quot;/* */&quot;</span><span class="p">,</span>
            <span class="s">&quot;plain&quot;</span>              <span class="p">:</span> <span class="s">&quot;#&quot;</span><span class="p">,</span> <span class="c"># We must pick something.</span>
            <span class="s">&quot;plsql&quot;</span>              <span class="p">:</span> <span class="s">&quot;-- /* */&quot;</span><span class="p">,</span> <span class="c"># SQL scripts qt02537 2005-05-27</span>
            <span class="s">&quot;pop11&quot;</span>              <span class="p">:</span> <span class="s">&quot;;;; /* */&quot;</span><span class="p">,</span>
            <span class="s">&quot;postscript&quot;</span>         <span class="p">:</span> <span class="s">&quot;%&quot;</span><span class="p">,</span>
            <span class="s">&quot;povray&quot;</span>             <span class="p">:</span> <span class="s">&quot;// /* */&quot;</span><span class="p">,</span>
            <span class="s">&quot;powerdynamo&quot;</span>        <span class="p">:</span> <span class="s">&quot;// &lt;!-- --&gt;&quot;</span><span class="p">,</span>
            <span class="s">&quot;prolog&quot;</span>             <span class="p">:</span> <span class="s">&quot;% /* */&quot;</span><span class="p">,</span>
            <span class="s">&quot;psp&quot;</span>                <span class="p">:</span> <span class="s">&quot;&lt;!-- --&gt;&quot;</span><span class="p">,</span>
            <span class="s">&quot;ptl&quot;</span>                <span class="p">:</span> <span class="s">&quot;#&quot;</span><span class="p">,</span>
            <span class="s">&quot;pvwave&quot;</span>             <span class="p">:</span> <span class="s">&quot;;&quot;</span><span class="p">,</span>
            <span class="s">&quot;pyrex&quot;</span>              <span class="p">:</span> <span class="s">&quot;#&quot;</span><span class="p">,</span>
            <span class="s">&quot;python&quot;</span>             <span class="p">:</span> <span class="s">&quot;#&quot;</span><span class="p">,</span>
            <span class="s">&quot;r&quot;</span>                  <span class="p">:</span> <span class="s">&quot;#&quot;</span><span class="p">,</span>
            <span class="s">&quot;rapidq&quot;</span>             <span class="p">:</span> <span class="s">&quot;&#39;&quot;</span><span class="p">,</span> <span class="c"># fil 2004-march-11</span>
            <span class="s">&quot;rebol&quot;</span>              <span class="p">:</span> <span class="s">&quot;;&quot;</span><span class="p">,</span> <span class="c"># jason 2003-07-03</span>
            <span class="s">&quot;redcode&quot;</span>            <span class="p">:</span> <span class="s">&quot;;&quot;</span><span class="p">,</span>
            <span class="s">&quot;rest&quot;</span>               <span class="p">:</span> <span class="s">&quot;.._&quot;</span><span class="p">,</span>
            <span class="s">&quot;rhtml&quot;</span>              <span class="p">:</span> <span class="s">&quot;&lt;</span><span class="si">%# %</span><span class="s">&gt;&quot;</span><span class="p">,</span>
            <span class="s">&quot;rib&quot;</span>                <span class="p">:</span> <span class="s">&quot;#&quot;</span><span class="p">,</span>
            <span class="s">&quot;rpmspec&quot;</span>            <span class="p">:</span> <span class="s">&quot;#&quot;</span><span class="p">,</span>
            <span class="s">&quot;rst&quot;</span>                <span class="p">:</span> <span class="s">&quot;.._&quot;</span><span class="p">,</span>
            <span class="s">&quot;ruby&quot;</span>               <span class="p">:</span> <span class="s">&quot;#&quot;</span><span class="p">,</span> <span class="c"># thyrsus 2008-11-05</span>
            <span class="s">&quot;rview&quot;</span>              <span class="p">:</span> <span class="s">&quot;// /* */&quot;</span><span class="p">,</span>
            <span class="s">&quot;sas&quot;</span>                <span class="p">:</span> <span class="s">&quot;* /* */&quot;</span><span class="p">,</span>
            <span class="s">&quot;scala&quot;</span>              <span class="p">:</span> <span class="s">&quot;// /* */&quot;</span><span class="p">,</span>
            <span class="s">&quot;scheme&quot;</span>             <span class="p">:</span> <span class="s">&quot;; #| |#&quot;</span><span class="p">,</span>
            <span class="s">&quot;sdl_pr&quot;</span>             <span class="p">:</span> <span class="s">&quot;/* */&quot;</span><span class="p">,</span>
            <span class="s">&quot;sgml&quot;</span>               <span class="p">:</span> <span class="s">&quot;&lt;!-- --&gt;&quot;</span><span class="p">,</span>
            <span class="s">&quot;shell&quot;</span>              <span class="p">:</span> <span class="s">&quot;#&quot;</span><span class="p">,</span>     <span class="c"># shell scripts</span>
            <span class="s">&quot;shellscript&quot;</span>        <span class="p">:</span> <span class="s">&quot;#&quot;</span><span class="p">,</span>
            <span class="s">&quot;shtml&quot;</span>              <span class="p">:</span> <span class="s">&quot;&lt;!-- --&gt;&quot;</span><span class="p">,</span>
            <span class="s">&quot;smalltalk&quot;</span>          <span class="p">:</span> <span class="s">&#39;&quot; &quot;&#39;</span><span class="p">,</span> <span class="c"># Comments are enclosed in double quotes(!!)</span>
            <span class="s">&quot;smi_mib&quot;</span>            <span class="p">:</span> <span class="s">&quot;--&quot;</span><span class="p">,</span>
            <span class="s">&quot;splus&quot;</span>              <span class="p">:</span> <span class="s">&quot;#&quot;</span><span class="p">,</span>
            <span class="s">&quot;sqr&quot;</span>                <span class="p">:</span> <span class="s">&quot;!&quot;</span><span class="p">,</span>
            <span class="s">&quot;squidconf&quot;</span>          <span class="p">:</span> <span class="s">&quot;#&quot;</span><span class="p">,</span>
            <span class="s">&quot;ssharp&quot;</span>             <span class="p">:</span> <span class="s">&quot;#&quot;</span><span class="p">,</span>
            <span class="s">&quot;swig&quot;</span>               <span class="p">:</span> <span class="s">&quot;// /* */&quot;</span><span class="p">,</span>
            <span class="s">&quot;tcl&quot;</span>                <span class="p">:</span> <span class="s">&quot;#&quot;</span><span class="p">,</span>
            <span class="s">&quot;tcltk&quot;</span>              <span class="p">:</span> <span class="s">&quot;#&quot;</span><span class="p">,</span>
            <span class="s">&quot;tex&quot;</span>                <span class="p">:</span> <span class="s">&quot;%&quot;</span><span class="p">,</span> <span class="c"># Bug fix: 2008-1-30: Fixed Mark Edginton&#39;s bug.</span>
            <span class="s">&quot;text&quot;</span>               <span class="p">:</span> <span class="s">&quot;#&quot;</span><span class="p">,</span> <span class="c"># We must pick something.</span>
            <span class="s">&quot;texinfo&quot;</span>            <span class="p">:</span> <span class="s">&quot;@c&quot;</span><span class="p">,</span>
            <span class="s">&quot;tpl&quot;</span>                <span class="p">:</span> <span class="s">&quot;&lt;!-- --&gt;&quot;</span><span class="p">,</span>
            <span class="s">&quot;tsql&quot;</span>               <span class="p">:</span> <span class="s">&quot;-- /* */&quot;</span><span class="p">,</span>
            <span class="s">&quot;typescript&quot;</span>         <span class="p">:</span> <span class="s">&quot;// /* */&quot;</span><span class="p">,</span> <span class="c"># For typescript import test.</span>
            <span class="s">&quot;unknown&quot;</span>            <span class="p">:</span> <span class="s">&quot;#&quot;</span><span class="p">,</span> <span class="c"># Set when @comment is seen.</span>
            <span class="s">&quot;unknown_language&quot;</span>   <span class="p">:</span> <span class="s">&#39;#--unknown-language--&#39;</span><span class="p">,</span> <span class="c"># For unknown extensions in @shadow files.</span>
            <span class="s">&quot;uscript&quot;</span>            <span class="p">:</span> <span class="s">&quot;// /* */&quot;</span><span class="p">,</span>
            <span class="s">&quot;vbscript&quot;</span>           <span class="p">:</span> <span class="s">&quot;&#39;&quot;</span><span class="p">,</span>
            <span class="s">&quot;velocity&quot;</span>           <span class="p">:</span> <span class="s">&quot;## #* *#&quot;</span><span class="p">,</span>
            <span class="s">&quot;verilog&quot;</span>            <span class="p">:</span> <span class="s">&quot;// /* */&quot;</span><span class="p">,</span>
            <span class="s">&quot;vhdl&quot;</span>               <span class="p">:</span> <span class="s">&quot;--&quot;</span><span class="p">,</span>
            <span class="s">&quot;vim&quot;</span>                <span class="p">:</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span>
            <span class="s">&quot;vimoutline&quot;</span>         <span class="p">:</span> <span class="s">&quot;#&quot;</span><span class="p">,</span> <span class="c">#TL 8/25/08 Vim&#39;s outline plugin</span>
            <span class="s">&quot;xml&quot;</span>                <span class="p">:</span> <span class="s">&quot;&lt;!-- --&gt;&quot;</span><span class="p">,</span>
            <span class="s">&quot;xsl&quot;</span>                <span class="p">:</span> <span class="s">&quot;&lt;!-- --&gt;&quot;</span><span class="p">,</span>
            <span class="s">&quot;xslt&quot;</span>               <span class="p">:</span> <span class="s">&quot;&lt;!-- --&gt;&quot;</span><span class="p">,</span>
            <span class="s">&quot;zpt&quot;</span>                <span class="p">:</span> <span class="s">&quot;&lt;!-- --&gt;&quot;</span><span class="p">,</span>

            <span class="c"># These aren&#39;t real languages, or have no delims...</span>
            <span class="c"># &quot;cvs_commit&quot;         : &quot;&quot;,</span>
            <span class="c"># &quot;dsssl&quot;              : &quot;; &lt;!-- --&gt;&quot;,</span>
            <span class="c"># &quot;embperl&quot;            : &quot;&lt;!-- --&gt;&quot;,  # Internal colorizing state.</span>
            <span class="c"># &quot;freemarker&quot;         : &quot;&quot;,</span>
            <span class="c"># &quot;hex&quot;                : &quot;&quot;,</span>
            <span class="c"># &quot;jcl&quot;                : &quot;&quot;,</span>
            <span class="c"># &quot;patch&quot;              : &quot;&quot;,</span>
            <span class="c"># &quot;phpsection&quot;         : &quot;&lt;!-- --&gt;&quot;,  # Internal colorizing state.</span>
            <span class="c"># &quot;props&quot;              : &quot;#&quot;,         # Unknown language.</span>
            <span class="c"># &quot;pseudoplain&quot;        : &quot;&quot;,</span>
            <span class="c"># &quot;relax_ng_compact&quot;   : &quot;#&quot;,         # An xml schema.</span>
            <span class="c"># &quot;rtf&quot;                : &quot;&quot;,</span>
            <span class="c"># &quot;svn_commit&quot;         : &quot;&quot;,</span>
        <span class="p">}</span>
    <span class="c">#@+node:ekr.20120522160137.9910: *4* app.define_language_extension_dict</span></div>
<div class="viewcode-block" id="LeoApp.define_language_extension_dict"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LeoApp.define_language_extension_dict">[docs]</a>    <span class="k">def</span> <span class="nf">define_language_extension_dict</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># Used only by c.getOpenWithExt.</span>

        <span class="c"># Keys are languages, values are extensions.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">language_extension_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&quot;actionscript&quot;</span>  <span class="p">:</span> <span class="s">&quot;as&quot;</span><span class="p">,</span> <span class="c">#jason 2003-07-03</span>
            <span class="s">&quot;ada&quot;</span>           <span class="p">:</span> <span class="s">&quot;ada&quot;</span><span class="p">,</span>
            <span class="s">&quot;ada95&quot;</span>         <span class="p">:</span> <span class="s">&quot;ada&quot;</span><span class="p">,</span>
            <span class="s">&quot;ahk&quot;</span>           <span class="p">:</span> <span class="s">&quot;ahk&quot;</span><span class="p">,</span>
            <span class="s">&quot;antlr&quot;</span>         <span class="p">:</span> <span class="s">&quot;g&quot;</span><span class="p">,</span>
            <span class="s">&quot;apacheconf&quot;</span>    <span class="p">:</span> <span class="s">&quot;conf&quot;</span><span class="p">,</span>
            <span class="s">&quot;apdl&quot;</span>          <span class="p">:</span> <span class="s">&quot;apdl&quot;</span><span class="p">,</span>
            <span class="s">&quot;applescript&quot;</span>   <span class="p">:</span> <span class="s">&quot;scpt&quot;</span><span class="p">,</span>
            <span class="s">&quot;asp&quot;</span>           <span class="p">:</span> <span class="s">&quot;asp&quot;</span><span class="p">,</span>
            <span class="s">&quot;aspect_j&quot;</span>      <span class="p">:</span> <span class="s">&quot;aj&quot;</span><span class="p">,</span>
            <span class="s">&quot;autohotkey&quot;</span>    <span class="p">:</span> <span class="s">&quot;ahk&quot;</span><span class="p">,</span> <span class="c">#TL - AutoHotkey language</span>
            <span class="s">&quot;awk&quot;</span>           <span class="p">:</span> <span class="s">&quot;awk&quot;</span><span class="p">,</span>
            <span class="s">&quot;b&quot;</span>             <span class="p">:</span> <span class="s">&quot;b&quot;</span><span class="p">,</span>
            <span class="s">&quot;batch&quot;</span>         <span class="p">:</span> <span class="s">&quot;bat&quot;</span><span class="p">,</span> <span class="c"># Leo 4.5.1.</span>
            <span class="s">&quot;bbj&quot;</span>           <span class="p">:</span> <span class="s">&quot;bbj&quot;</span><span class="p">,</span>
            <span class="s">&quot;bcel&quot;</span>          <span class="p">:</span> <span class="s">&quot;bcel&quot;</span><span class="p">,</span>
            <span class="s">&quot;bibtex&quot;</span>        <span class="p">:</span> <span class="s">&quot;bib&quot;</span><span class="p">,</span>
            <span class="s">&quot;c&quot;</span>             <span class="p">:</span> <span class="s">&quot;c&quot;</span><span class="p">,</span>
            <span class="s">&quot;chill&quot;</span>         <span class="p">:</span> <span class="s">&quot;ch&quot;</span><span class="p">,</span>  <span class="c"># Only one extension is valid: .c186, .c286</span>
            <span class="s">&quot;cobol&quot;</span>         <span class="p">:</span> <span class="s">&quot;cbl&quot;</span><span class="p">,</span> <span class="c"># Only one extension is valid: .cob</span>
            <span class="s">&quot;coldfusion&quot;</span>    <span class="p">:</span> <span class="s">&quot;cfm&quot;</span><span class="p">,</span>
            <span class="s">&quot;config&quot;</span>        <span class="p">:</span> <span class="s">&quot;cfg&quot;</span><span class="p">,</span>
            <span class="s">&quot;cplusplus&quot;</span>     <span class="p">:</span> <span class="s">&quot;c++&quot;</span><span class="p">,</span>
            <span class="s">&quot;cpp&quot;</span>           <span class="p">:</span> <span class="s">&quot;cpp&quot;</span><span class="p">,</span>
            <span class="s">&quot;css&quot;</span>           <span class="p">:</span> <span class="s">&quot;css&quot;</span><span class="p">,</span> <span class="c"># 4/1/04</span>
            <span class="s">&quot;cweb&quot;</span>          <span class="p">:</span> <span class="s">&quot;w&quot;</span><span class="p">,</span>
            <span class="s">&quot;cython&quot;</span>        <span class="p">:</span> <span class="s">&quot;pyx&quot;</span><span class="p">,</span> <span class="c"># Only one extension is valid at present: .pyi, .pyd.</span>
            <span class="s">&quot;d&quot;</span>             <span class="p">:</span> <span class="s">&quot;d&quot;</span><span class="p">,</span>
            <span class="s">&quot;eiffel&quot;</span>        <span class="p">:</span> <span class="s">&quot;e&quot;</span><span class="p">,</span>
            <span class="s">&quot;elisp&quot;</span>         <span class="p">:</span> <span class="s">&quot;el&quot;</span><span class="p">,</span>
            <span class="s">&quot;erlang&quot;</span>        <span class="p">:</span> <span class="s">&quot;erl&quot;</span><span class="p">,</span>
            <span class="s">&quot;factor&quot;</span>        <span class="p">:</span> <span class="s">&quot;factor&quot;</span><span class="p">,</span>
            <span class="s">&quot;forth&quot;</span>         <span class="p">:</span> <span class="s">&quot;forth&quot;</span><span class="p">,</span>
            <span class="s">&quot;fortran&quot;</span>       <span class="p">:</span> <span class="s">&quot;f&quot;</span><span class="p">,</span>
            <span class="s">&quot;fortran90&quot;</span>     <span class="p">:</span> <span class="s">&quot;f90&quot;</span><span class="p">,</span>
            <span class="s">&quot;foxpro&quot;</span>        <span class="p">:</span> <span class="s">&quot;prg&quot;</span><span class="p">,</span>
            <span class="s">&quot;gettext&quot;</span>       <span class="p">:</span> <span class="s">&quot;po&quot;</span><span class="p">,</span>
            <span class="s">&quot;groovy&quot;</span>        <span class="p">:</span> <span class="s">&quot;groovy&quot;</span><span class="p">,</span>
            <span class="s">&quot;haskell&quot;</span>       <span class="p">:</span> <span class="s">&quot;hs&quot;</span><span class="p">,</span>
            <span class="s">&quot;haxe&quot;</span>          <span class="p">:</span> <span class="s">&quot;hx&quot;</span><span class="p">,</span>
            <span class="s">&quot;html&quot;</span>          <span class="p">:</span> <span class="s">&quot;html&quot;</span><span class="p">,</span>
            <span class="s">&quot;i4gl&quot;</span>          <span class="p">:</span> <span class="s">&quot;i4gl&quot;</span><span class="p">,</span>
            <span class="s">&quot;icon&quot;</span>          <span class="p">:</span> <span class="s">&quot;icn&quot;</span><span class="p">,</span>
            <span class="s">&quot;idl&quot;</span>           <span class="p">:</span> <span class="s">&quot;idl&quot;</span><span class="p">,</span>
            <span class="s">&quot;inform&quot;</span>        <span class="p">:</span> <span class="s">&quot;inf&quot;</span><span class="p">,</span>
            <span class="s">&quot;ini&quot;</span>           <span class="p">:</span> <span class="s">&quot;ini&quot;</span><span class="p">,</span>
            <span class="s">&quot;inno_setup&quot;</span>    <span class="p">:</span> <span class="s">&quot;iss&quot;</span><span class="p">,</span>
            <span class="s">&quot;io&quot;</span>            <span class="p">:</span> <span class="s">&quot;io&quot;</span><span class="p">,</span>
            <span class="s">&quot;java&quot;</span>          <span class="p">:</span> <span class="s">&quot;java&quot;</span><span class="p">,</span>
            <span class="s">&quot;javascript&quot;</span>    <span class="p">:</span> <span class="s">&quot;js&quot;</span><span class="p">,</span> <span class="c"># EKR: 2011/11/12: For javascript import test.</span>
            <span class="s">&quot;javaserverpage&quot;</span><span class="p">:</span> <span class="s">&quot;jsp&quot;</span><span class="p">,</span> <span class="c"># EKR: 2011/11/25</span>
            <span class="s">&quot;jhtml&quot;</span>         <span class="p">:</span> <span class="s">&quot;jhtml&quot;</span><span class="p">,</span>
            <span class="s">&quot;jmk&quot;</span>           <span class="p">:</span> <span class="s">&quot;jmk&quot;</span><span class="p">,</span>
            <span class="s">&quot;jsp&quot;</span>           <span class="p">:</span> <span class="s">&quot;jsp&quot;</span><span class="p">,</span>
            <span class="s">&quot;kshell&quot;</span>        <span class="p">:</span> <span class="s">&quot;ksh&quot;</span><span class="p">,</span> <span class="c"># Leo 4.5.1.</span>
            <span class="s">&quot;latex&quot;</span>         <span class="p">:</span> <span class="s">&quot;tex&quot;</span><span class="p">,</span> <span class="c"># 1/8/04</span>
            <span class="s">&quot;lilypond&quot;</span>      <span class="p">:</span> <span class="s">&quot;ly&quot;</span><span class="p">,</span>
            <span class="s">&quot;lua&quot;</span>           <span class="p">:</span> <span class="s">&quot;lua&quot;</span><span class="p">,</span> <span class="c"># ddm 13/02/06</span>
            <span class="s">&quot;mail&quot;</span>          <span class="p">:</span> <span class="s">&quot;eml&quot;</span><span class="p">,</span>
            <span class="s">&quot;makefile&quot;</span>      <span class="p">:</span> <span class="s">&quot;mak&quot;</span><span class="p">,</span>
            <span class="s">&quot;maple&quot;</span>         <span class="p">:</span> <span class="s">&quot;mpl&quot;</span><span class="p">,</span>
            <span class="s">&quot;matlab&quot;</span>        <span class="p">:</span> <span class="s">&quot;m&quot;</span><span class="p">,</span>
            <span class="s">&quot;md&quot;</span>            <span class="p">:</span> <span class="s">&quot;md&quot;</span><span class="p">,</span> <span class="c"># PeckJ: 2013/02/07</span>
            <span class="s">&quot;ml&quot;</span>            <span class="p">:</span> <span class="s">&quot;ml&quot;</span><span class="p">,</span>
            <span class="s">&quot;modula3&quot;</span>       <span class="p">:</span> <span class="s">&quot;mod&quot;</span><span class="p">,</span>
            <span class="s">&quot;moin&quot;</span>          <span class="p">:</span> <span class="s">&quot;wiki&quot;</span><span class="p">,</span>
            <span class="s">&quot;mqsc&quot;</span>          <span class="p">:</span> <span class="s">&quot;mqsc&quot;</span><span class="p">,</span>
            <span class="s">&quot;noweb&quot;</span>         <span class="p">:</span> <span class="s">&quot;nw&quot;</span><span class="p">,</span>
            <span class="s">&quot;nqc&quot;</span>           <span class="p">:</span> <span class="s">&quot;nqc&quot;</span><span class="p">,</span>
            <span class="s">&quot;nsi&quot;</span>           <span class="p">:</span> <span class="s">&quot;nsi&quot;</span><span class="p">,</span> <span class="c"># EKR: 2010/10/27</span>
            <span class="s">&quot;nsis2&quot;</span>         <span class="p">:</span> <span class="s">&quot;nsi&quot;</span><span class="p">,</span>
            <span class="s">&quot;objective_c&quot;</span>   <span class="p">:</span> <span class="s">&quot;mm&quot;</span><span class="p">,</span> <span class="c"># Only one extension is valid: .m</span>
            <span class="s">&quot;objectrexx&quot;</span>    <span class="p">:</span> <span class="s">&quot;rex&quot;</span><span class="p">,</span>
            <span class="s">&quot;occam&quot;</span>         <span class="p">:</span> <span class="s">&quot;occ&quot;</span><span class="p">,</span>
            <span class="s">&quot;omnimark&quot;</span>      <span class="p">:</span> <span class="s">&quot;xom&quot;</span><span class="p">,</span>
            <span class="s">&quot;pascal&quot;</span>        <span class="p">:</span> <span class="s">&quot;p&quot;</span><span class="p">,</span>
            <span class="s">&quot;perl&quot;</span>          <span class="p">:</span> <span class="s">&quot;pl&quot;</span><span class="p">,</span>
            <span class="s">&quot;perlpod&quot;</span>       <span class="p">:</span> <span class="s">&quot;pod&quot;</span><span class="p">,</span>
            <span class="s">&quot;php&quot;</span>           <span class="p">:</span> <span class="s">&quot;php&quot;</span><span class="p">,</span>
            <span class="s">&quot;pike&quot;</span>          <span class="p">:</span> <span class="s">&quot;pike&quot;</span><span class="p">,</span>
            <span class="s">&quot;pl1&quot;</span>           <span class="p">:</span> <span class="s">&quot;pl1&quot;</span><span class="p">,</span>
            <span class="s">&quot;plain&quot;</span>         <span class="p">:</span> <span class="s">&quot;txt&quot;</span><span class="p">,</span>
            <span class="s">&quot;plsql&quot;</span>         <span class="p">:</span> <span class="s">&quot;sql&quot;</span><span class="p">,</span> <span class="c"># qt02537 2005-05-27</span>
            <span class="c"># &quot;pop11&quot;       : &quot;p&quot;, # Conflicts with pascall.</span>
            <span class="s">&quot;postscript&quot;</span>    <span class="p">:</span> <span class="s">&quot;ps&quot;</span><span class="p">,</span>
            <span class="s">&quot;povray&quot;</span>        <span class="p">:</span> <span class="s">&quot;pov&quot;</span><span class="p">,</span>
            <span class="s">&quot;prolog&quot;</span>        <span class="p">:</span> <span class="s">&quot;pro&quot;</span><span class="p">,</span>
            <span class="s">&quot;psp&quot;</span>           <span class="p">:</span> <span class="s">&quot;psp&quot;</span><span class="p">,</span>
            <span class="s">&quot;ptl&quot;</span>           <span class="p">:</span> <span class="s">&quot;ptl&quot;</span><span class="p">,</span>
            <span class="s">&quot;pyrex&quot;</span>         <span class="p">:</span> <span class="s">&quot;pyx&quot;</span><span class="p">,</span>
            <span class="s">&quot;python&quot;</span>        <span class="p">:</span> <span class="s">&quot;py&quot;</span><span class="p">,</span>
            <span class="s">&quot;r&quot;</span>             <span class="p">:</span> <span class="s">&quot;r&quot;</span><span class="p">,</span>
            <span class="s">&quot;rapidq&quot;</span>        <span class="p">:</span> <span class="s">&quot;bas&quot;</span><span class="p">,</span> <span class="c"># fil 2004-march-11</span>
            <span class="s">&quot;rebol&quot;</span>         <span class="p">:</span> <span class="s">&quot;r&quot;</span><span class="p">,</span> <span class="c"># jason 2003-07-03</span>
            <span class="s">&quot;rhtml&quot;</span>         <span class="p">:</span> <span class="s">&quot;rhtml&quot;</span><span class="p">,</span>
            <span class="s">&quot;rib&quot;</span>           <span class="p">:</span> <span class="s">&quot;rib&quot;</span><span class="p">,</span>
            <span class="s">&quot;rst&quot;</span>           <span class="p">:</span> <span class="s">&quot;rest&quot;</span><span class="p">,</span>
            <span class="s">&quot;ruby&quot;</span>          <span class="p">:</span> <span class="s">&quot;rb&quot;</span><span class="p">,</span> <span class="c"># thyrsus 2008-11-05</span>
            <span class="s">&quot;sas&quot;</span>           <span class="p">:</span> <span class="s">&quot;sas&quot;</span><span class="p">,</span>
            <span class="s">&quot;scala&quot;</span>         <span class="p">:</span> <span class="s">&quot;scala&quot;</span><span class="p">,</span>
            <span class="s">&quot;scheme&quot;</span>        <span class="p">:</span> <span class="s">&quot;scm&quot;</span><span class="p">,</span>
            <span class="s">&quot;sgml&quot;</span>          <span class="p">:</span> <span class="s">&quot;sgml&quot;</span><span class="p">,</span>
            <span class="s">&quot;shell&quot;</span>         <span class="p">:</span> <span class="s">&quot;sh&quot;</span><span class="p">,</span> <span class="c"># DS 4/1/04</span>
            <span class="s">&quot;shellscript&quot;</span>   <span class="p">:</span> <span class="s">&quot;sh&quot;</span><span class="p">,</span>
            <span class="s">&quot;shtml&quot;</span>         <span class="p">:</span> <span class="s">&quot;ssi&quot;</span><span class="p">,</span> <span class="c"># Only one extension is valid: .shtml</span>
            <span class="s">&quot;smalltalk&quot;</span>     <span class="p">:</span> <span class="s">&quot;sm&quot;</span><span class="p">,</span>
            <span class="s">&quot;splus&quot;</span>         <span class="p">:</span> <span class="s">&quot;splus&quot;</span><span class="p">,</span>
            <span class="s">&quot;sqr&quot;</span>           <span class="p">:</span> <span class="s">&quot;sqr&quot;</span><span class="p">,</span>
            <span class="s">&quot;ssharp&quot;</span>        <span class="p">:</span> <span class="s">&quot;ss&quot;</span><span class="p">,</span>
            <span class="s">&quot;swig&quot;</span>          <span class="p">:</span> <span class="s">&quot;i&quot;</span><span class="p">,</span>
            <span class="s">&quot;tcl&quot;</span>           <span class="p">:</span> <span class="s">&quot;tcl&quot;</span><span class="p">,</span>
            <span class="s">&quot;tcltk&quot;</span>         <span class="p">:</span> <span class="s">&quot;tcl&quot;</span><span class="p">,</span>
            <span class="s">&quot;tex&quot;</span>           <span class="p">:</span> <span class="s">&quot;tex&quot;</span><span class="p">,</span>
            <span class="s">&quot;texinfo&quot;</span>       <span class="p">:</span> <span class="s">&quot;info&quot;</span><span class="p">,</span>
            <span class="s">&quot;text&quot;</span>          <span class="p">:</span> <span class="s">&quot;txt&quot;</span><span class="p">,</span>
            <span class="s">&quot;tpl&quot;</span>           <span class="p">:</span> <span class="s">&quot;tpl&quot;</span><span class="p">,</span>
            <span class="s">&quot;tsql&quot;</span>          <span class="p">:</span> <span class="s">&quot;sql&quot;</span><span class="p">,</span> <span class="c"># A guess.</span>
            <span class="s">&quot;typescript&quot;</span>    <span class="p">:</span> <span class="s">&quot;ts&quot;</span><span class="p">,</span>
            <span class="s">&quot;unknown&quot;</span>       <span class="p">:</span> <span class="s">&quot;txt&quot;</span><span class="p">,</span> <span class="c"># Set when @comment is seen.</span>
            <span class="s">&quot;uscript&quot;</span>       <span class="p">:</span> <span class="s">&quot;uc&quot;</span><span class="p">,</span>
            <span class="s">&quot;vbscript&quot;</span>      <span class="p">:</span> <span class="s">&quot;vbs&quot;</span><span class="p">,</span>
            <span class="s">&quot;velocity&quot;</span>      <span class="p">:</span> <span class="s">&quot;vtl&quot;</span><span class="p">,</span>
            <span class="s">&quot;verilog&quot;</span>       <span class="p">:</span> <span class="s">&quot;v&quot;</span><span class="p">,</span>
            <span class="s">&quot;vhdl&quot;</span>          <span class="p">:</span> <span class="s">&quot;vhd&quot;</span><span class="p">,</span> <span class="c"># Only one extension is valid: .vhdl</span>
            <span class="s">&quot;vim&quot;</span>           <span class="p">:</span> <span class="s">&quot;vim&quot;</span><span class="p">,</span>
            <span class="s">&quot;vimoutline&quot;</span>    <span class="p">:</span> <span class="s">&quot;otl&quot;</span><span class="p">,</span> <span class="c">#TL 8/25/08 Vim&#39;s outline plugin</span>
            <span class="s">&quot;xml&quot;</span>           <span class="p">:</span> <span class="s">&quot;xml&quot;</span><span class="p">,</span>
            <span class="s">&quot;xsl&quot;</span>           <span class="p">:</span> <span class="s">&quot;xsl&quot;</span><span class="p">,</span>
            <span class="s">&quot;xslt&quot;</span>          <span class="p">:</span> <span class="s">&quot;xsl&quot;</span><span class="p">,</span>
            <span class="s">&quot;zpt&quot;</span>           <span class="p">:</span> <span class="s">&quot;zpt&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c"># These aren&#39;t real languages, or have no delims...</span>
            <span class="c"># cvs_commit, dsssl, embperl, freemarker, hex, jcl,</span>
            <span class="c"># patch, phpsection, progress, props, pseudoplain,</span>
            <span class="c"># relax_ng_compact, rtf, svn_commit.</span>

        <span class="c"># These have extensions which conflict with other languages.</span>
            <span class="c"># assembly_macro32: .asm or .a</span>
            <span class="c"># assembly_mcs51:   .asm or .a</span>
            <span class="c"># assembly_parrot:  .asm or .a</span>
            <span class="c"># assembly_r2000:   .asm or .a</span>
            <span class="c"># assembly_x86:     .asm or .a</span>
            <span class="c"># squidconf:        .conf</span>
            <span class="c"># rpmspec:          .rpm</span>
    <span class="c">#@+node:ekr.20120522160137.9911: *4* app.define_extension_dict</span></div>
<div class="viewcode-block" id="LeoApp.define_extension_dict"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LeoApp.define_extension_dict">[docs]</a>    <span class="k">def</span> <span class="nf">define_extension_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># Keys are extensions, values are languages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extension_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c"># &quot;ada&quot;:    &quot;ada&quot;,</span>
            <span class="s">&quot;ada&quot;</span><span class="p">:</span>      <span class="s">&quot;ada95&quot;</span><span class="p">,</span> <span class="c"># modes/ada95.py exists.</span>
            <span class="s">&quot;ahk&quot;</span><span class="p">:</span>      <span class="s">&quot;autohotkey&quot;</span><span class="p">,</span>
            <span class="s">&quot;aj&quot;</span><span class="p">:</span>       <span class="s">&quot;aspect_j&quot;</span><span class="p">,</span>
            <span class="s">&quot;apdl&quot;</span><span class="p">:</span>     <span class="s">&quot;apdl&quot;</span><span class="p">,</span>
            <span class="s">&quot;as&quot;</span><span class="p">:</span>       <span class="s">&quot;actionscript&quot;</span><span class="p">,</span> <span class="c">#jason 2003-07-03</span>
            <span class="s">&quot;asp&quot;</span><span class="p">:</span>      <span class="s">&quot;asp&quot;</span><span class="p">,</span>
            <span class="s">&quot;awk&quot;</span><span class="p">:</span>      <span class="s">&quot;awk&quot;</span><span class="p">,</span>
            <span class="s">&quot;b&quot;</span><span class="p">:</span>        <span class="s">&quot;b&quot;</span><span class="p">,</span>
            <span class="s">&quot;bas&quot;</span><span class="p">:</span>      <span class="s">&quot;rapidq&quot;</span><span class="p">,</span> <span class="c"># fil 2004-march-11</span>
            <span class="s">&quot;bat&quot;</span><span class="p">:</span>      <span class="s">&quot;batch&quot;</span><span class="p">,</span>
            <span class="s">&quot;bbj&quot;</span><span class="p">:</span>      <span class="s">&quot;bbj&quot;</span><span class="p">,</span>
            <span class="s">&quot;bcel&quot;</span><span class="p">:</span>     <span class="s">&quot;bcel&quot;</span><span class="p">,</span>
            <span class="s">&quot;bib&quot;</span><span class="p">:</span>      <span class="s">&quot;bibtex&quot;</span><span class="p">,</span>
            <span class="s">&quot;c&quot;</span><span class="p">:</span>        <span class="s">&quot;c&quot;</span><span class="p">,</span>
            <span class="s">&quot;c++&quot;</span><span class="p">:</span>      <span class="s">&quot;cplusplus&quot;</span><span class="p">,</span>
            <span class="s">&quot;cbl&quot;</span><span class="p">:</span>      <span class="s">&quot;cobol&quot;</span><span class="p">,</span> <span class="c"># Only one extension is valid: .cob</span>
            <span class="s">&quot;cfg&quot;</span><span class="p">:</span>      <span class="s">&quot;config&quot;</span><span class="p">,</span>
            <span class="s">&quot;cfm&quot;</span><span class="p">:</span>      <span class="s">&quot;coldfusion&quot;</span><span class="p">,</span>
            <span class="s">&quot;ch&quot;</span><span class="p">:</span>       <span class="s">&quot;chill&quot;</span><span class="p">,</span> <span class="c"># Other extensions, .c186,.c286</span>
            <span class="s">&quot;conf&quot;</span><span class="p">:</span>     <span class="s">&quot;apacheconf&quot;</span><span class="p">,</span>
            <span class="s">&quot;cpp&quot;</span><span class="p">:</span>      <span class="s">&quot;cpp&quot;</span><span class="p">,</span>
            <span class="s">&quot;css&quot;</span><span class="p">:</span>      <span class="s">&quot;css&quot;</span><span class="p">,</span>
            <span class="s">&quot;d&quot;</span><span class="p">:</span>        <span class="s">&quot;d&quot;</span><span class="p">,</span>
            <span class="s">&quot;e&quot;</span><span class="p">:</span>        <span class="s">&quot;eiffel&quot;</span><span class="p">,</span>
            <span class="s">&quot;el&quot;</span><span class="p">:</span>       <span class="s">&quot;elisp&quot;</span><span class="p">,</span>
            <span class="s">&quot;eml&quot;</span><span class="p">:</span>      <span class="s">&quot;mail&quot;</span><span class="p">,</span>
            <span class="s">&quot;erl&quot;</span><span class="p">:</span>      <span class="s">&quot;erlang&quot;</span><span class="p">,</span>
            <span class="s">&quot;f&quot;</span><span class="p">:</span>        <span class="s">&quot;fortran&quot;</span><span class="p">,</span>
            <span class="s">&quot;f90&quot;</span><span class="p">:</span>      <span class="s">&quot;fortran90&quot;</span><span class="p">,</span>
            <span class="s">&quot;factor&quot;</span><span class="p">:</span>   <span class="s">&quot;factor&quot;</span><span class="p">,</span>
            <span class="s">&quot;forth&quot;</span><span class="p">:</span>    <span class="s">&quot;forth&quot;</span><span class="p">,</span>
            <span class="s">&quot;g&quot;</span><span class="p">:</span>        <span class="s">&quot;antlr&quot;</span><span class="p">,</span>
            <span class="s">&quot;groovy&quot;</span><span class="p">:</span>   <span class="s">&quot;groovy&quot;</span><span class="p">,</span>
            <span class="s">&quot;h&quot;</span><span class="p">:</span>        <span class="s">&quot;c&quot;</span><span class="p">,</span> <span class="c"># 2012/05/23.</span>
            <span class="s">&quot;hs&quot;</span><span class="p">:</span>       <span class="s">&quot;haskell&quot;</span><span class="p">,</span>
            <span class="s">&quot;html&quot;</span><span class="p">:</span>     <span class="s">&quot;html&quot;</span><span class="p">,</span>
            <span class="s">&quot;hx&quot;</span><span class="p">:</span>       <span class="s">&quot;haxe&quot;</span><span class="p">,</span>
            <span class="s">&quot;i&quot;</span><span class="p">:</span>        <span class="s">&quot;swig&quot;</span><span class="p">,</span>
            <span class="s">&quot;i4gl&quot;</span><span class="p">:</span>     <span class="s">&quot;i4gl&quot;</span><span class="p">,</span>
            <span class="s">&quot;icn&quot;</span><span class="p">:</span>      <span class="s">&quot;icon&quot;</span><span class="p">,</span>
            <span class="s">&quot;idl&quot;</span><span class="p">:</span>      <span class="s">&quot;idl&quot;</span><span class="p">,</span>
            <span class="s">&quot;inf&quot;</span><span class="p">:</span>      <span class="s">&quot;inform&quot;</span><span class="p">,</span>
            <span class="s">&quot;info&quot;</span><span class="p">:</span>     <span class="s">&quot;texinfo&quot;</span><span class="p">,</span>
            <span class="s">&quot;ini&quot;</span><span class="p">:</span>      <span class="s">&quot;ini&quot;</span><span class="p">,</span>
            <span class="s">&quot;io&quot;</span><span class="p">:</span>       <span class="s">&quot;io&quot;</span><span class="p">,</span>
            <span class="s">&quot;iss&quot;</span><span class="p">:</span>      <span class="s">&quot;inno_setup&quot;</span><span class="p">,</span>
            <span class="s">&quot;java&quot;</span><span class="p">:</span>     <span class="s">&quot;java&quot;</span><span class="p">,</span>
            <span class="s">&quot;jhtml&quot;</span><span class="p">:</span>    <span class="s">&quot;jhtml&quot;</span><span class="p">,</span>
            <span class="s">&quot;jmk&quot;</span><span class="p">:</span>      <span class="s">&quot;jmk&quot;</span><span class="p">,</span>
            <span class="s">&quot;js&quot;</span><span class="p">:</span>       <span class="s">&quot;javascript&quot;</span><span class="p">,</span> <span class="c"># For javascript import test.</span>
            <span class="s">&quot;jsp&quot;</span><span class="p">:</span>      <span class="s">&quot;javaserverpage&quot;</span><span class="p">,</span>
            <span class="c"># &quot;jsp&quot;:      &quot;jsp&quot;,</span>
            <span class="s">&quot;ksh&quot;</span><span class="p">:</span>      <span class="s">&quot;kshell&quot;</span><span class="p">,</span> <span class="c"># Leo 4.5.1.</span>
            <span class="s">&quot;lua&quot;</span><span class="p">:</span>      <span class="s">&quot;lua&quot;</span><span class="p">,</span> <span class="c"># ddm 13/02/06</span>
            <span class="s">&quot;ly&quot;</span><span class="p">:</span>       <span class="s">&quot;lilypond&quot;</span><span class="p">,</span>
            <span class="s">&quot;m&quot;</span><span class="p">:</span>        <span class="s">&quot;matlab&quot;</span><span class="p">,</span> <span class="c"># EKR: 2011/10/21</span>
            <span class="s">&quot;mak&quot;</span><span class="p">:</span>      <span class="s">&quot;makefile&quot;</span><span class="p">,</span>
            <span class="s">&quot;md&quot;</span><span class="p">:</span>       <span class="s">&quot;md&quot;</span><span class="p">,</span> <span class="c"># PeckJ 2013/02/07</span>
            <span class="s">&quot;ml&quot;</span><span class="p">:</span>       <span class="s">&quot;ml&quot;</span><span class="p">,</span>
            <span class="s">&quot;mm&quot;</span><span class="p">:</span>       <span class="s">&quot;objective_c&quot;</span><span class="p">,</span> <span class="c"># Only one extension is valid: .m</span>
            <span class="s">&quot;mod&quot;</span><span class="p">:</span>      <span class="s">&quot;modula3&quot;</span><span class="p">,</span>
            <span class="s">&quot;mpl&quot;</span><span class="p">:</span>      <span class="s">&quot;maple&quot;</span><span class="p">,</span>
            <span class="s">&quot;mqsc&quot;</span><span class="p">:</span>     <span class="s">&quot;mqsc&quot;</span><span class="p">,</span>
            <span class="s">&quot;nqc&quot;</span><span class="p">:</span>      <span class="s">&quot;nqc&quot;</span><span class="p">,</span>
            <span class="s">&quot;nsi&quot;</span><span class="p">:</span>      <span class="s">&quot;nsi&quot;</span><span class="p">,</span> <span class="c"># EKR: 2010/10/27</span>
            <span class="c"># &quot;nsi&quot;:      &quot;nsis2&quot;,</span>
            <span class="s">&quot;nw&quot;</span><span class="p">:</span>       <span class="s">&quot;noweb&quot;</span><span class="p">,</span>
            <span class="s">&quot;occ&quot;</span><span class="p">:</span>      <span class="s">&quot;occam&quot;</span><span class="p">,</span>
            <span class="s">&quot;otl&quot;</span><span class="p">:</span>      <span class="s">&quot;vimoutline&quot;</span><span class="p">,</span> <span class="c">#TL 8/25/08 Vim&#39;s outline plugin</span>
            <span class="s">&quot;p&quot;</span><span class="p">:</span>        <span class="s">&quot;pascal&quot;</span><span class="p">,</span>
            <span class="c"># &quot;p&quot;:      &quot;pop11&quot;, # Conflicts with pascal.</span>
            <span class="s">&quot;php&quot;</span><span class="p">:</span>      <span class="s">&quot;php&quot;</span><span class="p">,</span>
            <span class="s">&quot;pike&quot;</span><span class="p">:</span>     <span class="s">&quot;pike&quot;</span><span class="p">,</span>
            <span class="s">&quot;pl&quot;</span><span class="p">:</span>       <span class="s">&quot;perl&quot;</span><span class="p">,</span>
            <span class="s">&quot;pl1&quot;</span><span class="p">:</span>      <span class="s">&quot;pl1&quot;</span><span class="p">,</span>
            <span class="s">&quot;po&quot;</span><span class="p">:</span>       <span class="s">&quot;gettext&quot;</span><span class="p">,</span>
            <span class="s">&quot;pod&quot;</span><span class="p">:</span>      <span class="s">&quot;perlpod&quot;</span><span class="p">,</span>
            <span class="s">&quot;pov&quot;</span><span class="p">:</span>      <span class="s">&quot;povray&quot;</span><span class="p">,</span>
            <span class="s">&quot;prg&quot;</span><span class="p">:</span>      <span class="s">&quot;foxpro&quot;</span><span class="p">,</span>
            <span class="s">&quot;pro&quot;</span><span class="p">:</span>      <span class="s">&quot;prolog&quot;</span><span class="p">,</span>
            <span class="s">&quot;ps&quot;</span><span class="p">:</span>       <span class="s">&quot;postscript&quot;</span><span class="p">,</span>
            <span class="s">&quot;psp&quot;</span><span class="p">:</span>      <span class="s">&quot;psp&quot;</span><span class="p">,</span>
            <span class="s">&quot;ptl&quot;</span><span class="p">:</span>      <span class="s">&quot;ptl&quot;</span><span class="p">,</span>
            <span class="s">&quot;py&quot;</span><span class="p">:</span>       <span class="s">&quot;python&quot;</span><span class="p">,</span>
            <span class="s">&quot;pyx&quot;</span><span class="p">:</span>      <span class="s">&quot;cython&quot;</span><span class="p">,</span> <span class="c"># Other extensions, .pyd,.pyi</span>
            <span class="c"># &quot;pyx&quot;:    &quot;pyrex&quot;,</span>
            <span class="c"># &quot;r&quot;:      &quot;r&quot;, # modes/r.py does not exist.</span>
            <span class="s">&quot;r&quot;</span><span class="p">:</span>        <span class="s">&quot;rebol&quot;</span><span class="p">,</span> <span class="c"># jason 2003-07-03</span>
            <span class="s">&quot;rb&quot;</span><span class="p">:</span>       <span class="s">&quot;ruby&quot;</span><span class="p">,</span> <span class="c"># thyrsus 2008-11-05</span>
            <span class="s">&quot;rest&quot;</span><span class="p">:</span>     <span class="s">&quot;rst&quot;</span><span class="p">,</span>
            <span class="s">&quot;rex&quot;</span><span class="p">:</span>      <span class="s">&quot;objectrexx&quot;</span><span class="p">,</span>
            <span class="s">&quot;rhtml&quot;</span><span class="p">:</span>    <span class="s">&quot;rhtml&quot;</span><span class="p">,</span>
            <span class="s">&quot;rib&quot;</span><span class="p">:</span>      <span class="s">&quot;rib&quot;</span><span class="p">,</span>
            <span class="s">&quot;sas&quot;</span><span class="p">:</span>      <span class="s">&quot;sas&quot;</span><span class="p">,</span>
            <span class="s">&quot;scala&quot;</span><span class="p">:</span>    <span class="s">&quot;scala&quot;</span><span class="p">,</span>
            <span class="s">&quot;scm&quot;</span><span class="p">:</span>      <span class="s">&quot;scheme&quot;</span><span class="p">,</span>
            <span class="s">&quot;scpt&quot;</span><span class="p">:</span>     <span class="s">&quot;applescript&quot;</span><span class="p">,</span>
            <span class="s">&quot;sgml&quot;</span><span class="p">:</span>     <span class="s">&quot;sgml&quot;</span><span class="p">,</span>
            <span class="s">&quot;sh&quot;</span><span class="p">:</span>       <span class="s">&quot;shell&quot;</span><span class="p">,</span> <span class="c"># DS 4/1/04. modes/shell.py exists.</span>
            <span class="c"># &quot;sh&quot;:     &quot;shellscript&quot;,</span>
            <span class="s">&quot;shtml&quot;</span><span class="p">:</span>    <span class="s">&quot;shtml&quot;</span><span class="p">,</span>
            <span class="s">&quot;sm&quot;</span><span class="p">:</span>       <span class="s">&quot;smalltalk&quot;</span><span class="p">,</span>
            <span class="s">&quot;splus&quot;</span><span class="p">:</span>    <span class="s">&quot;splus&quot;</span><span class="p">,</span>
            <span class="s">&quot;sql&quot;</span><span class="p">:</span>      <span class="s">&quot;plsql&quot;</span><span class="p">,</span> <span class="c"># qt02537 2005-05-27</span>
            <span class="s">&quot;sqr&quot;</span><span class="p">:</span>      <span class="s">&quot;sqr&quot;</span><span class="p">,</span>
            <span class="s">&quot;ss&quot;</span><span class="p">:</span>       <span class="s">&quot;ssharp&quot;</span><span class="p">,</span>
            <span class="s">&quot;ssi&quot;</span><span class="p">:</span>      <span class="s">&quot;shtml&quot;</span><span class="p">,</span>
            <span class="s">&quot;tcl&quot;</span><span class="p">:</span>      <span class="s">&quot;tcl&quot;</span><span class="p">,</span> <span class="c"># modes/tcl.py exists.</span>
            <span class="c"># &quot;tcl&quot;:    &quot;tcltk&quot;,</span>
            <span class="s">&quot;tex&quot;</span><span class="p">:</span>      <span class="s">&quot;latex&quot;</span><span class="p">,</span>
            <span class="c"># &quot;tex&quot;:      &quot;tex&quot;,</span>
            <span class="s">&quot;tpl&quot;</span><span class="p">:</span>      <span class="s">&quot;tpl&quot;</span><span class="p">,</span>
            <span class="s">&quot;ts&quot;</span><span class="p">:</span>       <span class="s">&quot;typescript&quot;</span><span class="p">,</span>
            <span class="s">&quot;txt&quot;</span><span class="p">:</span>      <span class="s">&quot;plain&quot;</span><span class="p">,</span>
            <span class="c"># &quot;txt&quot;:      &quot;text&quot;,</span>
            <span class="c"># &quot;txt&quot;:      &quot;unknown&quot;, # Set when @comment is seen.</span>
            <span class="s">&quot;uc&quot;</span><span class="p">:</span>       <span class="s">&quot;uscript&quot;</span><span class="p">,</span>
            <span class="s">&quot;v&quot;</span><span class="p">:</span>        <span class="s">&quot;verilog&quot;</span><span class="p">,</span>
            <span class="s">&quot;vbs&quot;</span><span class="p">:</span>      <span class="s">&quot;vbscript&quot;</span><span class="p">,</span>
            <span class="s">&quot;vhd&quot;</span><span class="p">:</span>      <span class="s">&quot;vhdl&quot;</span><span class="p">,</span>
            <span class="s">&quot;vhdl&quot;</span><span class="p">:</span>     <span class="s">&quot;vhdl&quot;</span><span class="p">,</span>
            <span class="s">&quot;vim&quot;</span><span class="p">:</span>      <span class="s">&quot;vim&quot;</span><span class="p">,</span>
            <span class="s">&quot;vtl&quot;</span><span class="p">:</span>      <span class="s">&quot;velocity&quot;</span><span class="p">,</span>
            <span class="s">&quot;w&quot;</span><span class="p">:</span>        <span class="s">&quot;cweb&quot;</span><span class="p">,</span>
            <span class="s">&quot;wiki&quot;</span><span class="p">:</span>     <span class="s">&quot;moin&quot;</span><span class="p">,</span>
            <span class="s">&quot;xml&quot;</span><span class="p">:</span>      <span class="s">&quot;xml&quot;</span><span class="p">,</span>
            <span class="s">&quot;xom&quot;</span><span class="p">:</span>      <span class="s">&quot;omnimark&quot;</span><span class="p">,</span>
            <span class="s">&quot;xsl&quot;</span><span class="p">:</span>      <span class="s">&quot;xsl&quot;</span><span class="p">,</span>
            <span class="s">&quot;zpt&quot;</span><span class="p">:</span>      <span class="s">&quot;zpt&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c"># These aren&#39;t real languages, or have no delims...</span>
            <span class="c"># cvs_commit, dsssl, embperl, freemarker, hex, jcl,</span>
            <span class="c"># patch, phpsection, progress, props, pseudoplain,</span>
            <span class="c"># relax_ng_compact, rtf, svn_commit.</span>

        <span class="c"># These have extensions which conflict with other languages.</span>
            <span class="c"># assembly_macro32: .asm or .a</span>
            <span class="c"># assembly_mcs51:   .asm or .a</span>
            <span class="c"># assembly_parrot:  .asm or .a</span>
            <span class="c"># assembly_r2000:   .asm or .a</span>
            <span class="c"># assembly_x86:     .asm or .a</span>
            <span class="c"># squidconf:        .conf</span>
            <span class="c"># rpmspec:          .rpm</span>

        <span class="c"># Extra language extensions, used to associate extensions with mode files.</span>
        <span class="c"># Used by importCommands.languageForExtension.</span>
        <span class="c"># Keys are extensions, values are corresponding mode file (without .py)</span>
        <span class="c"># A value of &#39;none&#39; is a signal to unit tests that no extension file exists.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_extension_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;pod&#39;</span>   <span class="p">:</span> <span class="s">&#39;perl&#39;</span><span class="p">,</span>
            <span class="s">&#39;unknown_language&#39;</span><span class="p">:</span> <span class="s">&#39;none&#39;</span><span class="p">,</span>
            <span class="s">&#39;w&#39;</span>     <span class="p">:</span> <span class="s">&#39;none&#39;</span><span class="p">,</span> <span class="c"># cweb</span>
        <span class="p">}</span>

    <span class="c">#@+node:ekr.20031218072017.2609: *3* app.closeLeoWindow</span></div>
<div class="viewcode-block" id="LeoApp.closeLeoWindow"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LeoApp.closeLeoWindow">[docs]</a>    <span class="k">def</span> <span class="nf">closeLeoWindow</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">frame</span><span class="p">,</span><span class="n">new_c</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Attempt to close a Leo window.</span>

<span class="sd">        Return False if the user veto&#39;s the close.&quot;&quot;&quot;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">c</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">c</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>

        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span> <span class="c"># Commit any open edits.</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">promptingForClose</span><span class="p">:</span>
            <span class="c"># There is already a dialog open asking what to do.</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">recentFilesManager</span><span class="o">.</span><span class="n">writeRecentFilesFile</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="c"># Make sure .leoRecentFiles.txt is written.</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">changed</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">promptingForClose</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">veto</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">promptForSave</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">promptingForClose</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="n">veto</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>

        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">setLog</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span> <span class="c"># no log until we reactive a window.</span>

        <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&quot;close-frame&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
            <span class="c"># This may remove frame from the window list.</span>

        <span class="k">if</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">windowList</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">destroyWindow</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">windowList</span><span class="p">:</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="n">new_c</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">windowList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">c</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">selectLeoWindow</span><span class="p">(</span><span class="n">c2</span><span class="p">)</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">finishQuit</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">True</span> <span class="c"># The window has been closed.</span>
    <span class="c">#@+node:ville.20090602181814.6219: *3* app.commanders</span></div>
<div class="viewcode-block" id="LeoApp.commanders"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LeoApp.commanders">[docs]</a>    <span class="k">def</span> <span class="nf">commanders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return list of currently active controllers &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">c</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">windowList</span><span class="p">]</span>    
    <span class="c">#@+node:ekr.20090717112235.6007: *3* app.computeSignon</span></div>
<div class="viewcode-block" id="LeoApp.computeSignon"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LeoApp.computeSignon">[docs]</a>    <span class="k">def</span> <span class="nf">computeSignon</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">app</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="kn">import</span> <span class="nn">leo.core.leoVersion</span> <span class="kn">as</span> <span class="nn">leoVersion</span>
        <span class="n">build</span><span class="p">,</span><span class="n">date</span>  <span class="o">=</span> <span class="n">leoVersion</span><span class="o">.</span><span class="n">build</span><span class="p">,</span><span class="n">leoVersion</span><span class="o">.</span><span class="n">date</span>
        <span class="n">guiVersion</span>  <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">gui</span> <span class="ow">and</span> <span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">getFullVersion</span><span class="p">()</span> <span class="ow">or</span> <span class="s">&#39;no gui!&#39;</span>
        <span class="n">leoVer</span>      <span class="o">=</span> <span class="n">leoVersion</span><span class="o">.</span><span class="n">version</span>
        <span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span><span class="p">,</span><span class="n">junk</span><span class="p">,</span><span class="n">junk</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span>

        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;win&#39;</span><span class="p">):</span>
            <span class="n">sysVersion</span> <span class="o">=</span> <span class="s">&#39;Windows &#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sys</span><span class="o">.</span><span class="n">getwindowsversion</span><span class="p">()</span>
                <span class="n">sysVersion</span> <span class="o">+=</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">v</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">else</span><span class="p">:</span> <span class="n">sysVersion</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span>

        <span class="n">app</span><span class="o">.</span><span class="n">signon</span> <span class="o">=</span> <span class="s">&#39;Leo </span><span class="si">%s</span><span class="s">, build </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">leoVer</span><span class="p">,</span><span class="n">build</span><span class="p">,</span><span class="n">date</span><span class="p">)</span>
        <span class="n">app</span><span class="o">.</span><span class="n">signon2</span> <span class="o">=</span> <span class="s">&#39;Python </span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">n3</span><span class="p">,</span><span class="n">guiVersion</span><span class="p">,</span><span class="n">sysVersion</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100831090251.5838: *3* app.createXGui</span>
    <span class="c">#@+node:ekr.20100831090251.5840: *4* app.createCursesGui</span></div>
<div class="viewcode-block" id="LeoApp.createCursesGui"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LeoApp.createCursesGui">[docs]</a>    <span class="k">def</span> <span class="nf">createCursesGui</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="n">app</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">app</span><span class="o">.</span><span class="n">pluginsController</span><span class="o">.</span><span class="n">loadOnePlugin</span><span class="p">(</span><span class="s">&#39;leo.plugins.cursesGui&#39;</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20090619065122.8593: *4* app.createDefaultGui</span></div>
<div class="viewcode-block" id="LeoApp.createDefaultGui"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LeoApp.createDefaultGui">[docs]</a>    <span class="k">def</span> <span class="nf">createDefaultGui</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;A convenience routines for plugins to create the default gui class.&quot;&quot;&quot;</span>

        <span class="n">app</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">argName</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">guiArgName</span>

        <span class="c"># This method can be called twice if we had to get .leoID.txt.</span>
        <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="p">:</span> <span class="k">return</span>

        <span class="k">if</span> <span class="n">argName</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;qt&#39;</span><span class="p">,</span><span class="s">&#39;qttabs&#39;</span><span class="p">):</span> <span class="c"># 2011/06/15.</span>
            <span class="n">app</span><span class="o">.</span><span class="n">createQtGui</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">argName</span> <span class="o">==</span> <span class="s">&#39;null&#39;</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">nullGui</span>
        <span class="k">elif</span> <span class="n">argName</span> <span class="o">==</span> <span class="s">&#39;curses&#39;</span><span class="p">:</span>
            <span class="n">app</span><span class="o">.</span><span class="n">createCursesGui</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Leo requires Qt to be installed.&#39;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.1938: *4* app.createNullGuiWithScript</span></div>
<div class="viewcode-block" id="LeoApp.createNullGuiWithScript"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LeoApp.createNullGuiWithScript">[docs]</a>    <span class="k">def</span> <span class="nf">createNullGuiWithScript</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">script</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">app</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">app</span><span class="o">.</span><span class="n">batchMode</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">app</span><span class="o">.</span><span class="n">gui</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">nullGui</span>
        <span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">setScript</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20090202191501.1: *4* app.createQtGui</span></div>
<div class="viewcode-block" id="LeoApp.createQtGui"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LeoApp.createQtGui">[docs]</a>    <span class="k">def</span> <span class="nf">createQtGui</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="c"># Do NOT omit fileName param: it is used in plugin code.</span>

        <span class="sd">&quot;&quot;&quot;A convenience routines for plugins to create the Qt gui class.&quot;&quot;&quot;</span>

        <span class="n">app</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># Take care to try the same imports as in qtGui.py.</span>
            <span class="kn">import</span> <span class="nn">PyQt4.QtCore</span>
            <span class="kn">import</span> <span class="nn">PyQt4.QtGui</span>            
            <span class="kn">import</span> <span class="nn">leo.plugins.qtGui</span> <span class="kn">as</span> <span class="nn">qtGui</span>
            <span class="k">if</span> <span class="mi">0</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">PyQt4</span><span class="p">)</span> <span class="c"># To remove a pyflakes warning.</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">qtGui</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">qtGui</span><span class="p">:</span>
            <span class="n">qtGui</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">gui</span> <span class="ow">and</span> <span class="n">fileName</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;qtGui created in </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">fileName</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20090126063121.3: *4* app.createWxGui</span></div>
<div class="viewcode-block" id="LeoApp.createWxGui"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LeoApp.createWxGui">[docs]</a>    <span class="k">def</span> <span class="nf">createWxGui</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="c"># Do NOT omit fileName param: it is used in plugin code.</span>

        <span class="sd">&quot;&quot;&quot;A convenience routines for plugins to create the wx gui class.&quot;&quot;&quot;</span>

        <span class="n">app</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">app</span><span class="o">.</span><span class="n">pluginsController</span><span class="o">.</span><span class="n">loadOnePlugin</span> <span class="p">(</span><span class="s">&#39;leo.plugins.wxGui&#39;</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fileName</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>

            <span class="k">print</span><span class="p">(</span><span class="s">&#39;wxGui created in </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">fileName</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2612: *3* app.destroyAllOpenWithFiles</span></div>
<div class="viewcode-block" id="LeoApp.destroyAllOpenWithFiles"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LeoApp.destroyAllOpenWithFiles">[docs]</a>    <span class="k">def</span> <span class="nf">destroyAllOpenWithFiles</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Try to remove temp files created with the Open With command.</span>

<span class="sd">        This may fail if the files are still open.</span>

<span class="sd">        Called by g.app.finishQuit&quot;&quot;&quot;</span>

        <span class="c"># We can&#39;t use g.es here because the log stream no longer exists.</span>

        <span class="k">for</span> <span class="n">theDict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">openWithFiles</span><span class="p">[:]:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">destroyOpenWithFileWithDict</span><span class="p">(</span><span class="n">theDict</span><span class="p">)</span>

        <span class="c"># Delete the list so the gc can recycle Leo windows!</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">openWithFiles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c">#@+node:ekr.20031218072017.2613: *3* app.destroyOpenWithFilesForFrame</span></div>
<div class="viewcode-block" id="LeoApp.destroyOpenWithFilesForFrame"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LeoApp.destroyOpenWithFilesForFrame">[docs]</a>    <span class="k">def</span> <span class="nf">destroyOpenWithFilesForFrame</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">frame</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Close all &quot;Open With&quot; files associated with frame</span>

<span class="sd">        Called by app.destroyWindow.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Make a copy of the list: it may change in the loop.</span>
        <span class="n">openWithFiles</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">openWithFiles</span>

        <span class="k">for</span> <span class="n">theDict</span> <span class="ow">in</span> <span class="n">openWithFiles</span><span class="p">[:]:</span> <span class="c"># 6/30/03</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">theDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;c&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span> <span class="o">==</span> <span class="n">frame</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">destroyOpenWithFileWithDict</span><span class="p">(</span><span class="n">theDict</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2614: *3* app.destroyOpenWithFileWithDict</span></div>
<div class="viewcode-block" id="LeoApp.destroyOpenWithFileWithDict"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LeoApp.destroyOpenWithFileWithDict">[docs]</a>    <span class="k">def</span> <span class="nf">destroyOpenWithFileWithDict</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">theDict</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        A helper for app.destroyAllOpenWithFiles and</span>
<span class="sd">        app.destroyOpenWithFilesForFrame.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">theDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;path&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;deleting temp file: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">g</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;can not delete temp file: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>

        <span class="c"># Remove theDict from the list so the gc can recycle the Leo window!</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">openWithFiles</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">theDict</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2615: *3* app.destroyWindow</span></div>
<div class="viewcode-block" id="LeoApp.destroyWindow"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LeoApp.destroyWindow">[docs]</a>    <span class="k">def</span> <span class="nf">destroyWindow</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">frame</span><span class="p">):</span>

        <span class="c"># g.trace(frame in g.app.windowList,frame)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">destroyOpenWithFilesForFrame</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">windowList</span><span class="p">:</span>
            <span class="c"># g.trace(g.app.windowList)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">windowList</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">forgetOpenFile</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">fileName</span><span class="p">())</span>

        <span class="c"># force the window to go away now.</span>
        <span class="c"># Important: this also destroys all the objects of the commander.</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">destroySelf</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.1732: *3* app.finishQuit</span></div>
<div class="viewcode-block" id="LeoApp.finishQuit"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LeoApp.finishQuit">[docs]</a>    <span class="k">def</span> <span class="nf">finishQuit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># forceShutdown may already have fired the &quot;end1&quot; hook.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">killed</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&quot;end1&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">destroyAllOpenWithFiles</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">destroySelf</span><span class="p">()</span>

        <span class="c"># Don&#39;t use g.trace!</span>
        <span class="c"># print(&#39;app.finishQuit: setting g.app.killed&#39;,g.callers())</span>

        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">killed</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="c"># Disable all further hooks and events.</span>
            <span class="c"># Alas, &quot;idle&quot; events can still be called</span>
            <span class="c"># even after the following code.</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">afterHandler</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">afterHandler</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20031218072017.2616: *3* app.forceShutdown</span></div>
<div class="viewcode-block" id="LeoApp.forceShutdown"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LeoApp.forceShutdown">[docs]</a>    <span class="k">def</span> <span class="nf">forceShutdown</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Forces an immediate shutdown of Leo at any time.</span>

<span class="sd">        In particular, may be called from plugins during startup.&quot;&quot;&quot;</span>

        <span class="c"># Wait until everything is quiet before really quitting.</span>
        <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&quot;end1&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># Disable writeWaitingLog</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">killed</span> <span class="o">=</span> <span class="bp">True</span> <span class="c"># Disable all further hooks.</span>

        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">windowList</span><span class="p">[:]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">destroyWindow</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">finishQuit</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.2188: *3* app.newCommander &amp; helper</span></div>
<div class="viewcode-block" id="LeoApp.newCommander"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LeoApp.newCommander">[docs]</a>    <span class="k">def</span> <span class="nf">newCommander</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span><span class="n">relativeFileName</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">gui</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">previousSettings</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Create a commander and its view frame for the Leo main window.&quot;&quot;&quot;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="p">(</span><span class="bp">False</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">trace_startup</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;g.app.newCommander: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">fileName</span><span class="p">))</span>

        <span class="c"># Create the commander and its subcommanders.</span>
        <span class="c"># This takes about 3/4 sec when called by the leoBridge module.</span>
        <span class="kn">import</span> <span class="nn">leo.core.leoCommands</span> <span class="kn">as</span> <span class="nn">leoCommands</span>

        <span class="k">return</span> <span class="n">leoCommands</span><span class="o">.</span><span class="n">Commands</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">relativeFileName</span><span class="p">,</span><span class="n">gui</span><span class="p">,</span><span class="n">previousSettings</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2617: *3* app.onQuit</span></div>
<div class="viewcode-block" id="LeoApp.onQuit"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LeoApp.onQuit">[docs]</a>    <span class="k">def</span> <span class="nf">onQuit</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Exit Leo, prompting to save unsaved outlines first.&#39;&#39;&#39;</span>

        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">quitting</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c"># Don&#39;t use g.trace here.</span>
        <span class="c"># print(&#39;onQuit&#39;,g.app.save_session,g.app.sessionManager)</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">save_session</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">sessionManager</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">sessionManager</span><span class="o">.</span><span class="n">save_snapshot</span><span class="p">()</span>

        <span class="k">while</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">windowList</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">windowList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">closeLeoWindow</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">windowList</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">quitting</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># If we get here the quit has been disabled.</span>
    <span class="c">#@+node:ekr.20120304065838.15588: *3* app.selectLeoWindow</span></div>
<div class="viewcode-block" id="LeoApp.selectLeoWindow"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LeoApp.selectLeoWindow">[docs]</a>    <span class="k">def</span> <span class="nf">selectLeoWindow</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="k">assert</span> <span class="n">c</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>

        <span class="n">frame</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">deiconify</span><span class="p">()</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">lift</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">setLog</span><span class="p">()</span>

        <span class="n">master</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">top</span><span class="p">,</span><span class="s">&#39;leo_master&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">frame</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">leo_master</span>

        <span class="k">if</span> <span class="n">master</span><span class="p">:</span> <span class="c"># 2011/11/21: selecting the new tab ensures focus is set.</span>
            <span class="c"># frame.top.leo_master is a TabbedTopLevel.</span>
            <span class="n">master</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">bodyWantsFocus</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">outerUpdate</span><span class="p">()</span>
    <span class="c">#@+node:ville.20090620122043.6275: *3* app.setGlobalDb</span></div>
<div class="viewcode-block" id="LeoApp.setGlobalDb"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LeoApp.setGlobalDb">[docs]</a>    <span class="k">def</span> <span class="nf">setGlobalDb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create global pickleshare db</span>

<span class="sd">        Usable by::</span>

<span class="sd">            g.app.db[&#39;hello&#39;] = [1,2,5]</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Fixes bug 670108.</span>
        <span class="kn">import</span> <span class="nn">leo.core.leoCache</span> <span class="kn">as</span> <span class="nn">leoCache</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">leoCache</span><span class="o">.</span><span class="n">cacher</span><span class="p">()</span><span class="o">.</span><span class="n">initGlobalDB</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.1978: *3* app.setLeoID</span></div>
<div class="viewcode-block" id="LeoApp.setLeoID"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LeoApp.setLeoID">[docs]</a>    <span class="k">def</span> <span class="nf">setLeoID</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

        <span class="n">tag</span> <span class="o">=</span> <span class="s">&quot;.leoID.txt&quot;</span>
        <span class="n">homeLeoDir</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">homeLeoDir</span>
        <span class="n">globalConfigDir</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">globalConfigDir</span>
        <span class="n">loadDir</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadDir</span>

        <span class="n">verbose</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="c">#@+&lt;&lt; return if we can set leoID from sys.leoID &gt;&gt;</span>
        <span class="c">#@+node:ekr.20031218072017.1979: *4* &lt;&lt; return if we can set leoID from sys.leoID&gt;&gt;</span>
        <span class="c"># This would be set by in Python&#39;s sitecustomize.py file.</span>

        <span class="c"># Use hasattr &amp; getattr to suppress pylint warning.</span>
        <span class="c"># Use a &quot;non-constant&quot; attribute to suppress another warning!</span>

        <span class="n">nonConstantAttr</span> <span class="o">=</span> <span class="s">&quot;leoID&quot;</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span><span class="n">nonConstantAttr</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">leoID</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span><span class="n">nonConstantAttr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">silentMode</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">red</span><span class="p">(</span><span class="s">&quot;leoID=&quot;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">leoID</span><span class="p">,</span><span class="n">spaces</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="c"># Careful: periods in the id field of a gnx will corrupt the .leo file!</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">leoID</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">leoID</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span><span class="s">&#39;-&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">leoID</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c">#@-&lt;&lt; return if we can set leoID from sys.leoID &gt;&gt;</span>
        <span class="c">#@+&lt;&lt; return if we can set leoID from &quot;leoID.txt&quot; &gt;&gt;</span>
        <span class="c">#@+node:ekr.20031218072017.1980: *4* &lt;&lt; return if we can set leoID from &quot;leoID.txt&quot; &gt;&gt;</span>
        <span class="k">for</span> <span class="n">theDir</span> <span class="ow">in</span> <span class="p">(</span><span class="n">homeLeoDir</span><span class="p">,</span><span class="n">globalConfigDir</span><span class="p">,</span><span class="n">loadDir</span><span class="p">):</span>
            <span class="c"># N.B. We would use the _working_ directory if theDir is None!</span>
            <span class="k">if</span> <span class="n">theDir</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_join</span><span class="p">(</span><span class="n">theDir</span><span class="p">,</span><span class="n">tag</span><span class="p">)</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">s</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">leoID</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="c"># Careful: periods in the id field of a gnx</span>
                        <span class="c"># will corrupt the .leo file!</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">leoID</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">leoID</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span><span class="s">&#39;-&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">silentMode</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                            <span class="n">g</span><span class="o">.</span><span class="n">red</span><span class="p">(</span><span class="s">&#39;leoID=&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">leoID</span><span class="p">,</span><span class="s">&#39; (in &#39;</span><span class="p">,</span><span class="n">theDir</span><span class="p">,</span><span class="s">&#39;)&#39;</span><span class="p">,</span><span class="n">spaces</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                        <span class="k">return</span>
                    <span class="k">elif</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">red</span><span class="p">(</span><span class="s">&#39;empty &#39;</span><span class="p">,</span><span class="n">tag</span><span class="p">,</span><span class="s">&#39; (in &#39;</span><span class="p">,</span><span class="n">theDir</span><span class="p">,</span><span class="s">&#39;)&#39;</span><span class="p">,</span><span class="n">spaces</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">leoID</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">leoID</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;unexpected exception in app.setLeoID&#39;</span><span class="p">)</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
        <span class="c">#@-&lt;&lt; return if we can set leoID from &quot;leoID.txt&quot; &gt;&gt;</span>
        <span class="c">#@+&lt;&lt; return if we can set leoID from os.getenv(&#39;USER&#39;) &gt;&gt;</span>
        <span class="c">#@+node:ekr.20060211140947.1: *4* &lt;&lt; return if we can set leoID from os.getenv(&#39;USER&#39;) &gt;&gt;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">theId</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#39;USER&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">theId</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&quot;setting leoID from os.getenv(&#39;USER&#39;):&quot;</span><span class="p">,</span>
                        <span class="nb">repr</span><span class="p">(</span><span class="n">theId</span><span class="p">))</span>
                <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">leoID</span> <span class="o">=</span> <span class="n">theId</span>
                <span class="c"># Careful: periods in the id field of a gnx</span>
                <span class="c"># will corrupt the .leo file!</span>
                <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">leoID</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">leoID</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span><span class="s">&#39;-&#39;</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c">#@-&lt;&lt; return if we can set leoID from os.getenv(&#39;USER&#39;) &gt;&gt;</span>
        <span class="c">#@+&lt;&lt; put up a dialog requiring a valid id &gt;&gt;</span>
        <span class="c">#@+node:ekr.20031218072017.1981: *4* &lt;&lt; put up a dialog requiring a valid id &gt;&gt;</span>
        <span class="c"># 2011/06/13: Don&#39;t put up a splash screen.</span>
        <span class="c"># It would obscure the coming dialog.</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">use_splash_screen</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># New in 4.1: get an id for gnx&#39;s.  Plugins may set g.app.leoID.</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># Create the Qt gui if it exists.</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">createDefaultGui</span><span class="p">(</span><span class="n">fileName</span><span class="o">=</span><span class="s">&#39;g.app.setLeoId&#39;</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="c"># Neither gui could be created: this should never happen.</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Please enter LeoID (e.g. your username, &#39;johndoe&#39;...)&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span> <span class="c"># 2010/02/04.</span>
                <span class="n">leoid</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s">&#39;LeoID: &#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">leoid</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;LeoID: &#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">leoid</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">runAskLeoIDDialog</span><span class="p">()</span>

        <span class="c"># Bug fix: 2/6/05: put result in g.app.leoID.</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">leoID</span> <span class="o">=</span> <span class="n">leoid</span>

        <span class="c"># Careful: periods in the id field of a gnx will corrupt the .leo file!</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">leoID</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">leoID</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span><span class="s">&#39;-&#39;</span><span class="p">)</span>

        <span class="c"># g.trace(g.app.leoID)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&#39;leoID=&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">leoID</span><span class="p">),</span><span class="n">spaces</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="c">#@-&lt;&lt; put up a dialog requiring a valid id &gt;&gt;</span>
        <span class="c">#@+&lt;&lt; attempt to create leoID.txt &gt;&gt;</span>
        <span class="c">#@+node:ekr.20031218072017.1982: *4* &lt;&lt; attempt to create leoID.txt &gt;&gt; (changed)</span>
        <span class="k">for</span> <span class="n">theDir</span> <span class="ow">in</span> <span class="p">(</span><span class="n">homeLeoDir</span><span class="p">,</span><span class="n">globalConfigDir</span><span class="p">,</span><span class="n">loadDir</span><span class="p">):</span>
            <span class="c"># N.B. We would use the _working_ directory if theDir is None!</span>
            <span class="k">if</span> <span class="n">theDir</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_join</span><span class="p">(</span><span class="n">theDir</span><span class="p">,</span><span class="n">tag</span><span class="p">)</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">leoID</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span> <span class="c"># 2010/08/27</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span><span class="n">reportErrors</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">tag</span><span class="p">,</span><span class="s">&#39;created in&#39;</span><span class="p">,</span><span class="n">theDir</span><span class="p">)</span>
                        <span class="k">return</span>
                <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                    <span class="k">pass</span>

                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;can not create&#39;</span><span class="p">,</span><span class="n">tag</span><span class="p">,</span><span class="s">&#39;in&#39;</span><span class="p">,</span><span class="n">theDir</span><span class="p">)</span>
        <span class="c">#@-&lt;&lt; attempt to create leoID.txt &gt;&gt;</span>
    <span class="c">#@+node:ekr.20031218072017.1847: *3* app.setLog, lockLog, unlocklog</span></div>
<div class="viewcode-block" id="LeoApp.setLog"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LeoApp.setLog">[docs]</a>    <span class="k">def</span> <span class="nf">setLog</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">log</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;set the frame to which log messages will go&quot;&quot;&quot;</span>

        <span class="c"># print(&quot;app.setLog:&quot;,log)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">logIsLocked</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span>
</div>
<div class="viewcode-block" id="LeoApp.lockLog"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LeoApp.lockLog">[docs]</a>    <span class="k">def</span> <span class="nf">lockLog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Disable changes to the log&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logIsLocked</span> <span class="o">=</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="LeoApp.unlockLog"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LeoApp.unlockLog">[docs]</a>    <span class="k">def</span> <span class="nf">unlockLog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Enable changes to the log&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logIsLocked</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20031218072017.2619: *3* app.writeWaitingLog</span></div>
<div class="viewcode-block" id="LeoApp.writeWaitingLog"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LeoApp.writeWaitingLog">[docs]</a>    <span class="k">def</span> <span class="nf">writeWaitingLog</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">app</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
            <span class="c"># Do not call g.es, g.es_print, g.pr or g.trace here!</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;** writeWaitingLog&#39;</span><span class="p">,</span><span class="s">&#39;silent&#39;</span><span class="p">,</span><span class="n">app</span><span class="o">.</span><span class="n">silentMode</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">())</span>
            <span class="c"># print(&#39;writeWaitingLog&#39;,g.callers())</span>
            <span class="c"># import sys ; print(&#39;writeWaitingLog: argv&#39;,sys.argv)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
            <span class="n">app</span><span class="o">.</span><span class="n">printWaiting</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">app</span><span class="o">.</span><span class="n">logWaiting</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">setLog</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span> <span class="c"># Prepare to requeue for other commanders.</span>
            <span class="k">return</span>

        <span class="n">table</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">&#39;Leo Log Window&#39;</span><span class="p">,</span><span class="s">&#39;red&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">signon</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
            <span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">signon2</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">table</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>

        <span class="n">c</span><span class="o">.</span><span class="n">setLog</span><span class="p">()</span> <span class="c"># 2010/10/20</span>
        <span class="n">app</span><span class="o">.</span><span class="n">logInited</span> <span class="o">=</span> <span class="bp">True</span> <span class="c"># Prevent recursive call.</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">app</span><span class="o">.</span><span class="n">signon_printed</span><span class="p">:</span>
            <span class="n">app</span><span class="o">.</span><span class="n">signon_printed</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">app</span><span class="o">.</span><span class="n">silentMode</span><span class="p">:</span> <span class="c"># 2011/11/02:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;** isPython3: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">enableDB</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;** caching disabled&#39;</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">signon</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">signon2</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">app</span><span class="o">.</span><span class="n">silentMode</span><span class="p">:</span> <span class="c"># 2011/11/02:</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">printWaiting</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">app</span><span class="o">.</span><span class="n">printWaiting</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">app</span><span class="o">.</span><span class="n">silentMode</span><span class="p">:</span>  <span class="c"># 2011/11/02:</span>
            <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">color</span> <span class="ow">in</span> <span class="n">table</span><span class="p">:</span>
                <span class="n">app</span><span class="o">.</span><span class="n">logWaiting</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,(</span><span class="n">s</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="n">color</span><span class="p">),)</span>
            <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">color</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">logWaiting</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span><span class="n">newline</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="c"># The caller must write the newlines.</span>
        <span class="n">app</span><span class="o">.</span><span class="n">logWaiting</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># Essential when opening multiple files...</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">setLog</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span> 
    <span class="c">#@+node:ekr.20120427064024.10068: *3* app.Detecting already-open files</span>
    <span class="c">#@+node:ekr.20120427064024.10064: *4* app.checkForOpenFile</span></div>
<div class="viewcode-block" id="LeoApp.checkForOpenFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LeoApp.checkForOpenFile">[docs]</a>    <span class="k">def</span> <span class="nf">checkForOpenFile</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>

        <span class="n">d</span><span class="p">,</span><span class="n">tag</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">db</span><span class="p">,</span><span class="s">&#39;open-leo-files&#39;</span>

        <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">batchMode</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">reverting</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">aList</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">runAskYesNoDialog</span><span class="p">(</span><span class="n">c</span><span class="p">,</span>
                    <span class="n">title</span><span class="o">=</span><span class="s">&#39;Open Leo File Again?&#39;</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> is already open.  Open it again?&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fn</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="s">&#39;yes&#39;</span><span class="p">:</span>
                    <span class="n">clear</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">runAskYesNoDialog</span><span class="p">(</span><span class="n">c</span><span class="p">,</span>
                        <span class="n">title</span><span class="o">=</span><span class="s">&#39;Reset open count?&#39;</span><span class="p">,</span>
                        <span class="n">message</span><span class="o">=</span><span class="s">&#39;Reset open count for </span><span class="si">%s</span><span class="s">?&#39;</span> \
                            <span class="s">&quot;</span><span class="se">\n</span><span class="s">Say yes if you know this outline&quot;</span> \
                            <span class="s">&quot;</span><span class="se">\n</span><span class="s">is not really open elsewhere&quot;</span><span class="o">%</span> <span class="p">(</span><span class="n">fn</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">clear</span> <span class="o">==</span> <span class="s">&#39;yes&#39;</span><span class="p">:</span>
                        <span class="n">d</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">fn</span><span class="p">]</span>
                        <span class="c"># IMPORTANT - rest of load process will add another</span>
                        <span class="c"># entry for this Leo instance, don&#39;t do it here</span>
                <span class="k">return</span> <span class="n">result</span> <span class="o">==</span> <span class="s">&#39;yes&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
    <span class="c">#@+node:ekr.20120427064024.10066: *4* app.forgetOpenFile</span></div>
<div class="viewcode-block" id="LeoApp.forgetOpenFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LeoApp.forgetOpenFile">[docs]</a>    <span class="k">def</span> <span class="nf">forgetOpenFile</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">d</span><span class="p">,</span><span class="n">tag</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">db</span><span class="p">,</span><span class="s">&#39;open-leo-files&#39;</span>

        <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">batchMode</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">reverting</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">aList</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
                <span class="n">aList</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;removed: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fn</span><span class="p">),</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>
                    <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">&#39;  </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">z</span><span class="p">))</span>
                <span class="n">d</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">aList</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;did not remove: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fn</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20120427064024.10065: *4* app.rememberOpenFile</span></div>
<div class="viewcode-block" id="LeoApp.rememberOpenFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LeoApp.rememberOpenFile">[docs]</a>    <span class="k">def</span> <span class="nf">rememberOpenFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">d</span><span class="p">,</span><span class="n">tag</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">db</span><span class="p">,</span><span class="s">&#39;open-leo-files&#39;</span>

        <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">batchMode</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">reverting</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">preReadFlag</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">aList</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="c"># It&#39;s proper to add duplicates to this list.</span>
            <span class="n">aList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
                <span class="c"># Trace doesn&#39;t work well while initing.</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;rememberOpenFile:added: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fn</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;  </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">z</span><span class="p">))</span>
            <span class="n">d</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">aList</span>
    <span class="c">#@-others</span>
<span class="c">#@+node:ekr.20120209051836.10242: ** class LoadManager</span></div></div>
<div class="viewcode-block" id="LoadManager"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager">[docs]</a><span class="k">class</span> <span class="nc">LoadManager</span><span class="p">:</span>

    <span class="sd">&#39;&#39;&#39;A class to manage loading .leo files, including configuration files.&#39;&#39;&#39;</span>

    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20120214060149.15851: *3*  LM.ctor</span>
    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="p">(</span><span class="bp">False</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">trace_startup</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;LoadManager.__init__&#39;</span><span class="p">)</span>

        <span class="c"># Global settings &amp; shortcuts dicts.</span>
        <span class="c"># The are the defaults for computing settings and shortcuts for all loaded files.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">globalSettingsDict</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="c"># A g.TypedDict containing the merger of default settings,</span>
            <span class="c"># settings in leoSettings.leo and settings in myLeoSettings.leo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">globalShortcutsDict</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="c"># A g.TypedDictOfLists containg the merger of shortcuts in</span>
            <span class="c"># leoSettings.leo and settings in myLeoSettings.leo.</span>

        <span class="c"># LoadManager ivars corresponding to user options....</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c"># List of files to be loaded.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c"># Dictionary of user options. Keys are option names.</span>

        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># use lm.options.get instead.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">script</span> <span class="o">=</span> <span class="bp">None</span>          <span class="c"># The fileName of a script, or None.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">script_name</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">script_path</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">script_path_w</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">screenshot_fn</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">selectHeadline</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">versionFlag</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">windowFlag</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">windowSize</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># Ivars of *other* classes corresponding to command-line arguments...</span>
            <span class="c"># g.app.batchMode           Set in createNullGuiWithScript</span>
            <span class="c"># g.app.gui = None          The gui class.</span>
            <span class="c"># g.app.guiArgName          The gui name given in --gui option.</span>
            <span class="c"># g.app.qt_use_tabs                </span>
            <span class="c"># g.app.silentMode         </span>
            <span class="c"># g.app.start_fullscreen   </span>
            <span class="c"># g.app.start_maximized    .</span>
            <span class="c"># g.app.start_minimized</span>
            <span class="c"># g.app.useIpython</span>
            <span class="c"># g.app.use_splash_screen</span>
            <span class="c"># g.enableDB                --no-cache</span>
    <span class="c">#@+node:ekr.20120211121736.10812: *3* LM.Directory &amp; file utils</span>
    <span class="c">#@+node:ekr.20120219154958.10481: *4* LM.completeFileName</span>
<div class="viewcode-block" id="LoadManager.completeFileName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.completeFileName">[docs]</a>    <span class="k">def</span> <span class="nf">completeFileName</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="p">):</span>

        <span class="n">fileName</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicode</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
        <span class="n">fileName</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>

        <span class="c"># 2011/10/12: don&#39;t add .leo to *any* file.</span>
        <span class="k">return</span> <span class="n">fileName</span>
    <span class="c">#@+node:ekr.20120209051836.10372: *4* LM.computeLeoSettingsPath</span></div>
<div class="viewcode-block" id="LoadManager.computeLeoSettingsPath"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.computeLeoSettingsPath">[docs]</a>    <span class="k">def</span> <span class="nf">computeLeoSettingsPath</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the full path to leoSettings.leo.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c"># lm = self</span>
        <span class="n">join</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span>
        <span class="n">settings_fn</span> <span class="o">=</span> <span class="s">&#39;leoSettings.leo&#39;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="p">(</span>
            <span class="c"># First, leoSettings.leo in the home directories.</span>
            <span class="n">join</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">homeDir</span><span class="p">,</span>     <span class="n">settings_fn</span><span class="p">),</span>
            <span class="n">join</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">homeLeoDir</span><span class="p">,</span>  <span class="n">settings_fn</span><span class="p">),</span>
            <span class="c"># Last, leoSettings.leo in leo/config directory.</span>
            <span class="n">join</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">globalConfigDir</span><span class="p">,</span> <span class="n">settings_fn</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">table</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;computeLeoSettingsPath&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">path</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">path</span>
    <span class="c">#@+node:ekr.20120209051836.10373: *4* LM.computeMyLeoSettingsPath</span></div>
<div class="viewcode-block" id="LoadManager.computeMyLeoSettingsPath"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.computeMyLeoSettingsPath">[docs]</a>    <span class="k">def</span> <span class="nf">computeMyLeoSettingsPath</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the full path to myLeoSettings.leo.</span>

<span class="sd">        The &quot;footnote&quot;: Get the local directory from lm.files[0]&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">lm</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">join</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span>
        <span class="n">settings_fn</span> <span class="o">=</span> <span class="s">&#39;myLeoSettings.leo&#39;</span>

        <span class="c"># This seems pointless: we need a machine *directory*.</span>
        <span class="c"># For now, however, we&#39;ll keep the existing code as is.</span>
        <span class="n">machine_fn</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">computeMachineName</span><span class="p">()</span> <span class="o">+</span> <span class="n">settings_fn</span>

        <span class="c"># First, compute the directory of the first loaded file.</span>
        <span class="c"># All entries in lm.files are full, absolute paths.</span>
        <span class="n">localDir</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_dirname</span><span class="p">(</span><span class="n">lm</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">lm</span><span class="o">.</span><span class="n">files</span> <span class="k">else</span> <span class="bp">None</span>

        <span class="n">table</span> <span class="o">=</span> <span class="p">(</span>
            <span class="c"># First, myLeoSettings.leo in the local directory</span>
            <span class="n">join</span><span class="p">(</span><span class="n">localDir</span><span class="p">,</span>          <span class="n">settings_fn</span><span class="p">),</span>

            <span class="c"># Next, myLeoSettings.leo in the home directories.</span>
            <span class="n">join</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">homeDir</span><span class="p">,</span>     <span class="n">settings_fn</span><span class="p">),</span>
            <span class="n">join</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">homeLeoDir</span><span class="p">,</span>  <span class="n">settings_fn</span><span class="p">),</span>

            <span class="c"># Next, &lt;machine-name&gt;myLeoSettings.leo in the home directories.</span>
            <span class="n">join</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">homeDir</span><span class="p">,</span>     <span class="n">machine_fn</span><span class="p">),</span>
            <span class="n">join</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">homeLeoDir</span><span class="p">,</span>  <span class="n">machine_fn</span><span class="p">),</span>

            <span class="c"># Last, leoSettings.leo in leo/config directory.</span>
            <span class="n">join</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">globalConfigDir</span><span class="p">,</span> <span class="n">settings_fn</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">table</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;computeMyLeoSettingsPath&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">path</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">return</span> <span class="n">path</span>
    <span class="c">#@+node:ekr.20120209051836.10252: *4* LM.computeStandardDirectories &amp; helpers</span></div>
<div class="viewcode-block" id="LoadManager.computeStandardDirectories"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.computeStandardDirectories">[docs]</a>    <span class="k">def</span> <span class="nf">computeStandardDirectories</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Compute the locations of standard directories and</span>
<span class="sd">        set the corresponding ivars.&#39;&#39;&#39;</span>

        <span class="n">lm</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadDir</span>           <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">computeLoadDir</span><span class="p">()</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">leoDir</span>            <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">computeLeoDir</span><span class="p">()</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">homeDir</span>           <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">computeHomeDir</span><span class="p">()</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">homeLeoDir</span>        <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">computeHomeLeoDir</span><span class="p">()</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">globalConfigDir</span>   <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">computeGlobalConfigDir</span><span class="p">()</span>

        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">extensionsDir</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadDir</span><span class="p">,</span><span class="s">&#39;..&#39;</span><span class="p">,</span><span class="s">&#39;extensions&#39;</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">testDir</span>       <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadDir</span><span class="p">,</span><span class="s">&#39;..&#39;</span><span class="p">,</span><span class="s">&#39;test&#39;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20120209051836.10253: *5* lm.computeGlobalConfigDir</span></div>
<div class="viewcode-block" id="LoadManager.computeGlobalConfigDir"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.computeGlobalConfigDir">[docs]</a>    <span class="k">def</span> <span class="nf">computeGlobalConfigDir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># lm = self</span>

        <span class="c"># To avoid pylint complaints that sys.leo_config_directory does not exist.</span>
        <span class="n">leo_config_dir</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span><span class="s">&#39;leo_config_directory&#39;</span><span class="p">)</span> <span class="ow">and</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span><span class="s">&#39;leo_config_directory&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">leo_config_dir</span><span class="p">:</span>
            <span class="n">theDir</span> <span class="o">=</span> <span class="n">leo_config_dir</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">theDir</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_join</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadDir</span><span class="p">,</span><span class="s">&quot;..&quot;</span><span class="p">,</span><span class="s">&quot;config&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">theDir</span><span class="p">:</span>
            <span class="n">theDir</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize</span><span class="p">(</span><span class="n">theDir</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">theDir</span> <span class="ow">or</span>
            <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">theDir</span><span class="p">)</span> <span class="ow">or</span>
            <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_isdir</span><span class="p">(</span><span class="n">theDir</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">theDir</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">theDir</span>
    <span class="c">#@+node:ekr.20120209051836.10254: *5* lm.computeHomeDir</span></div>
<div class="viewcode-block" id="LoadManager.computeHomeDir"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.computeHomeDir">[docs]</a>    <span class="k">def</span> <span class="nf">computeHomeDir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Returns the user&#39;s home directory.&quot;&quot;&quot;</span>

        <span class="n">home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s">&quot;~&quot;</span><span class="p">)</span>
            <span class="c"># Windows searches the HOME, HOMEPATH and HOMEDRIVE</span>
            <span class="c"># environment vars, then gives up.</span>

        <span class="k">if</span> <span class="n">home</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">home</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">home</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;%&#39;</span> <span class="ow">and</span> <span class="n">home</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;%&#39;</span><span class="p">:</span>
            <span class="c"># Get the indirect reference to the true home.</span>
            <span class="n">home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">home</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">home</span><span class="p">:</span>
            <span class="c"># Important: This returns the _working_ directory if home is None!</span>
            <span class="c"># This was the source of the 4.3 .leoID.txt problems.</span>
            <span class="n">home</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize</span><span class="p">(</span><span class="n">home</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">home</span><span class="p">)</span> <span class="ow">or</span>
                <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_isdir</span><span class="p">(</span><span class="n">home</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">home</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># g.trace(home)</span>
        <span class="k">return</span> <span class="n">home</span>
    <span class="c">#@+node:ekr.20120209051836.10260: *5* lm.computeHomeLeoDir</span></div>
<div class="viewcode-block" id="LoadManager.computeHomeLeoDir"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.computeHomeLeoDir">[docs]</a>    <span class="k">def</span> <span class="nf">computeHomeLeoDir</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># lm = self</span>
        <span class="n">homeLeoDir</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">homeDir</span><span class="p">,</span><span class="s">&#39;.leo&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">homeLeoDir</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">makeAllNonExistentDirectories</span><span class="p">(</span><span class="n">homeLeoDir</span><span class="p">,</span><span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">homeLeoDir</span>
    <span class="c">#@+node:ekr.20120209051836.10255: *5* lm.computeLeoDir</span></div>
<div class="viewcode-block" id="LoadManager.computeLeoDir"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.computeLeoDir">[docs]</a>    <span class="k">def</span> <span class="nf">computeLeoDir</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># lm = self</span>
        <span class="n">loadDir</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadDir</span>
        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_dirname</span><span class="p">(</span><span class="n">loadDir</span><span class="p">)</span>
            <span class="c"># We don&#39;t want the result in sys.path</span>
    <span class="c">#@+node:ekr.20120209051836.10256: *5* lm.computeLoadDir</span></div>
<div class="viewcode-block" id="LoadManager.computeLoadDir"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.computeLoadDir">[docs]</a>    <span class="k">def</span> <span class="nf">computeLoadDir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Returns the directory containing leo.py.&quot;&quot;&quot;</span>

        <span class="kn">import</span> <span class="nn">sys</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c"># Fix a hangnail: on Windows the drive letter returned by</span>
            <span class="c"># __file__ is randomly upper or lower case!</span>
            <span class="c"># The made for an ugly recent files list.</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">__file__</span> <span class="c"># was leo.__file__</span>
            <span class="c"># g.trace(repr(path))</span>
            <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
                <span class="c"># Possible fix for bug 735938:</span>
                <span class="c"># Do the following only if path exists.</span>
                <span class="c">#@+&lt;&lt; resolve symlinks &gt;&gt;</span>
                <span class="c">#@+node:ekr.20120209051836.10257: *6* &lt;&lt; resolve symlinks &gt;&gt;</span>
                <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;pyc&#39;</span><span class="p">):</span>
                    <span class="n">srcfile</span> <span class="o">=</span> <span class="n">path</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">srcfile</span><span class="p">):</span>
                        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">srcfile</span><span class="p">)</span>    
                <span class="c">#@-&lt;&lt; resolve symlinks &gt;&gt;</span>
                <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">==</span><span class="s">&#39;win32&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;:&#39;</span><span class="p">:</span>
                        <span class="c"># Convert the drive name to upper case.</span>
                        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">+</span> <span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>


                <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="n">loadDir</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_dirname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">loadDir</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="n">loadDir</span> <span class="ow">or</span>
                <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">loadDir</span><span class="p">)</span> <span class="ow">or</span>
                <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_isdir</span><span class="p">(</span><span class="n">loadDir</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">loadDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
                <span class="c"># From Marc-Antoine Parent.</span>
                <span class="k">if</span> <span class="n">loadDir</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;Contents/Resources&quot;</span><span class="p">):</span>
                    <span class="n">loadDir</span> <span class="o">+=</span> <span class="s">&quot;/leo/plugins&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;Exception getting load directory&quot;</span><span class="p">)</span>
            <span class="n">loadDir</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize</span><span class="p">(</span><span class="n">loadDir</span><span class="p">)</span>
            <span class="c"># g.trace(loadDir)</span>
            <span class="k">return</span> <span class="n">loadDir</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Exception getting load directory&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
    <span class="c">#@+node:ekr.20120213164030.10697: *5* lm.computeMachineName</span></div>
<div class="viewcode-block" id="LoadManager.computeMachineName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.computeMachineName">[docs]</a>    <span class="k">def</span> <span class="nf">computeMachineName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the name of the current machine, i.e, HOSTNAME.&#39;&#39;&#39;</span>

        <span class="c"># This is prepended to leoSettings.leo or myLeoSettings.leo</span>
        <span class="c"># to give the machine-specific setting name.</span>
        <span class="c"># How can this be worth doing??</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">os</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#39;HOSTNAME&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#39;COMPUTERNAME&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">socket</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

        <span class="c"># g.trace(name)</span>

        <span class="k">return</span> <span class="n">name</span>
    <span class="c">#@+node:ekr.20120211121736.10772: *4* LM.computeWorkbookFileName</span></div>
<div class="viewcode-block" id="LoadManager.computeWorkbookFileName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.computeWorkbookFileName">[docs]</a>    <span class="k">def</span> <span class="nf">computeWorkbookFileName</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># lm = self</span>

        <span class="c"># Get the name of the workbook.</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getString</span><span class="p">(</span><span class="n">setting</span><span class="o">=</span><span class="s">&#39;default_leo_file&#39;</span><span class="p">)</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fn</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">fn</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_isabs</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="c"># Create the file.</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Using default leo file name:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fn</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">fn</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># It&#39;s too risky to open a default file if it is relative.</span>
            <span class="k">return</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20120219154958.10485: *4* LM.reportDirectories</span></div>
<div class="viewcode-block" id="LoadManager.reportDirectories"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.reportDirectories">[docs]</a>    <span class="k">def</span> <span class="nf">reportDirectories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">verbose</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">return</span>

        <span class="k">if</span> <span class="mi">1</span><span class="p">:</span> <span class="c"># old</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">kind</span><span class="p">,</span><span class="n">theDir</span> <span class="ow">in</span> <span class="p">(</span>
                    <span class="p">(</span><span class="s">&quot;load&quot;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadDir</span><span class="p">),</span>
                    <span class="p">(</span><span class="s">&quot;global config&quot;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">globalConfigDir</span><span class="p">),</span>
                    <span class="p">(</span><span class="s">&quot;home&quot;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">homeDir</span><span class="p">),</span>
                <span class="p">):</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> dir:&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kind</span><span class="p">),</span><span class="n">theDir</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">aList</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s">&#39;homeDir&#39;</span><span class="p">,</span><span class="s">&#39;homeLeoDir&#39;</span><span class="p">,</span>
                <span class="s">&#39;leoDir&#39;</span><span class="p">,</span><span class="s">&#39;loadDir&#39;</span><span class="p">,</span>
                <span class="s">&#39;extensionsDir&#39;</span><span class="p">,</span><span class="s">&#39;globalConfigDir&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">ivar</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="p">,</span><span class="n">ivar</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%20s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ivar</span><span class="p">),</span><span class="n">val</span><span class="p">)</span>

    <span class="c">#@+node:ekr.20120215062153.10740: *3* LM.Settings</span>
    <span class="c">#@+node:ekr.20120130101219.10182: *4* lm.computeBindingLetter</span></div>
<div class="viewcode-block" id="LoadManager.computeBindingLetter"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.computeBindingLetter">[docs]</a>    <span class="k">def</span> <span class="nf">computeBindingLetter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">kind</span><span class="p">):</span>

        <span class="c"># lm = self</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kind</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;D&#39;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="s">&#39;M&#39;</span><span class="p">,</span><span class="s">&#39;myLeoSettings.leo&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;leoSettings.leo&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;F&#39;</span><span class="p">,</span><span class="s">&#39;.leo&#39;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">letter</span><span class="p">,</span><span class="n">kind2</span> <span class="ow">in</span> <span class="n">table</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kind</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">kind2</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
                <span class="k">return</span> <span class="n">letter</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;D&#39;</span> <span class="k">if</span> <span class="n">kind</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;mode&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="s">&#39;@&#39;</span>
    <span class="c">#@+node:ekr.20120223062418.10421: *4* lm.computeLocalSettings (where the crash happened)</span></div>
<div class="viewcode-block" id="LoadManager.computeLocalSettings"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.computeLocalSettings">[docs]</a>    <span class="k">def</span> <span class="nf">computeLocalSettings</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">settings_d</span><span class="p">,</span><span class="n">shortcuts_d</span><span class="p">,</span><span class="n">localFlag</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Merge the settings dicts from c&#39;s outline into *new copies of*</span>
<span class="sd">        settings_d and shortcuts_d.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="p">(</span><span class="bp">False</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">trace_startup</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;lm.computeLocalSettings: </span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">c</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">(),</span><span class="n">settings_d</span><span class="p">,</span><span class="n">shortcuts_d</span><span class="p">))</span>

        <span class="n">lm</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">shortcuts_d2</span><span class="p">,</span><span class="n">settings_d2</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">createSettingsDicts</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">localFlag</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">shortcuts_d</span>
        <span class="k">assert</span> <span class="n">settings_d</span>

        <span class="k">if</span> <span class="n">settings_d2</span><span class="p">:</span>
            <span class="n">settings_d</span> <span class="o">=</span> <span class="n">settings_d</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">settings_d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">settings_d2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">shortcuts_d2</span><span class="p">:</span>
            <span class="n">shortcuts_d</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">mergeShortcutsDicts</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">shortcuts_d</span><span class="p">,</span><span class="n">shortcuts_d2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">settings_d</span><span class="p">,</span><span class="n">shortcuts_d</span>
    <span class="c">#@+node:ekr.20121126202114.3: *4* lm.createDefaultSettingsDicts (New)</span></div>
<div class="viewcode-block" id="LoadManager.createDefaultSettingsDicts"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.createDefaultSettingsDicts">[docs]</a>    <span class="k">def</span> <span class="nf">createDefaultSettingsDicts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Create lm.globalSettingsDict &amp; lm.globalShortcutsDict.&#39;&#39;&#39;</span>

        <span class="n">settings_d</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">defaultsDict</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings_d</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">TypedDict</span><span class="p">),</span><span class="n">settings_d</span>
        <span class="n">settings_d</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="s">&#39;lm.globalSettingsDict&#39;</span><span class="p">)</span>

        <span class="n">shortcuts_d</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">TypedDictOfLists</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s">&#39;lm.globalShortcutsDict&#39;</span><span class="p">,</span>
            <span class="n">keyType</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="s">&#39;s&#39;</span><span class="p">),</span> <span class="n">valType</span><span class="o">=</span><span class="n">g</span><span class="o">.</span><span class="n">ShortcutInfo</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">settings_d</span><span class="p">,</span><span class="n">shortcuts_d</span>
    <span class="c">#@+node:ekr.20120214165710.10726: *4* lm.createSettingsDicts</span></div>
<div class="viewcode-block" id="LoadManager.createSettingsDicts"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.createSettingsDicts">[docs]</a>    <span class="k">def</span> <span class="nf">createSettingsDicts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">localFlag</span><span class="p">):</span>

        <span class="kn">import</span> <span class="nn">leo.core.leoConfig</span> <span class="kn">as</span> <span class="nn">leoConfig</span>

        <span class="n">parser</span> <span class="o">=</span> <span class="n">leoConfig</span><span class="o">.</span><span class="n">SettingsTreeParser</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">localFlag</span><span class="p">)</span>
            <span class="c"># returns the *raw* shortcutsDict, not a *merged* shortcuts dict.</span>

        <span class="n">shortcutsDict</span><span class="p">,</span><span class="n">settingsDict</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">traverse</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">shortcutsDict</span><span class="p">,</span><span class="n">settingsDict</span>
    <span class="c">#@+node:ekr.20120223062418.10414: *4* LM.getPreviousSettings</span></div>
<div class="viewcode-block" id="LoadManager.getPreviousSettings"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.getPreviousSettings">[docs]</a>    <span class="k">def</span> <span class="nf">getPreviousSettings</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the settings in effect for fn.  Typically,</span>
<span class="sd">        this involves pre-reading fn.&#39;&#39;&#39;</span>

        <span class="n">lm</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">settingsName</span>  <span class="o">=</span> <span class="s">&#39;settings dict for </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">g</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">shortcutsName</span> <span class="o">=</span> <span class="s">&#39;shortcuts dict for </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">g</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

        <span class="c"># A special case: settings in leoSettings.leo do *not* override</span>
        <span class="c"># the global settings, that is, settings in myLeoSettings.leo.</span>
        <span class="n">isLeoSettings</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s">&#39;leosettings.leo&#39;</span>

        <span class="k">if</span> <span class="n">fn</span> <span class="ow">and</span> <span class="n">lm</span><span class="o">.</span><span class="n">isLeoFile</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">isLeoSettings</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="c"># Open the file usinging a null gui.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">preReadFlag</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">openSettingsFile</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">preReadFlag</span> <span class="o">=</span> <span class="bp">False</span>

            <span class="c"># Merge the settings from c into *copies* of the global dicts.</span>
            <span class="n">d1</span><span class="p">,</span><span class="n">d2</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">computeLocalSettings</span><span class="p">(</span><span class="n">c</span><span class="p">,</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">globalSettingsDict</span><span class="p">,</span><span class="n">lm</span><span class="o">.</span><span class="n">globalShortcutsDict</span><span class="p">,</span><span class="n">localFlag</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                    <span class="c"># d1 and d2 are copies.</span>
            <span class="n">d1</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">settingsName</span><span class="p">)</span>
            <span class="n">d2</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">shortcutsName</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Get the settings from the globals settings dicts.</span>
            <span class="n">d1</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">globalSettingsDict</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">settingsName</span><span class="p">)</span>
            <span class="n">d2</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">globalShortcutsDict</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">shortcutsName</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">PreviousSettings</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span><span class="n">d2</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20120214132927.10723: *4* lm.mergeShortcutsDicts &amp; helpers</span></div>
<div class="viewcode-block" id="LoadManager.mergeShortcutsDicts"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.mergeShortcutsDicts">[docs]</a>    <span class="k">def</span> <span class="nf">mergeShortcutsDicts</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">old_d</span><span class="p">,</span><span class="n">new_d</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Create a new dict by overriding all shortcuts in old_d by shortcuts in new_d.</span>

<span class="sd">        Both old_d and new_d remain unchanged.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">lm</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">old_d</span><span class="p">:</span> <span class="k">return</span> <span class="n">new_d</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">new_d</span><span class="p">:</span> <span class="k">return</span> <span class="n">old_d</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
            <span class="n">new_n</span><span class="p">,</span><span class="n">old_n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">new_d</span><span class="o">.</span><span class="n">keys</span><span class="p">())),</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">old_d</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;new </span><span class="si">%4s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">new_n</span><span class="p">,</span><span class="nb">id</span><span class="p">(</span><span class="n">new_d</span><span class="p">),</span><span class="n">new_d</span><span class="o">.</span><span class="n">name</span><span class="p">()))</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;old </span><span class="si">%4s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">old_n</span><span class="p">,</span><span class="nb">id</span><span class="p">(</span><span class="n">old_d</span><span class="p">),</span><span class="n">old_d</span><span class="o">.</span><span class="n">name</span><span class="p">()))</span>

        <span class="n">inverted_old_d</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">old_d</span><span class="p">)</span>
        <span class="n">inverted_new_d</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">new_d</span><span class="p">)</span>

        <span class="c"># Fix bug 951921: check for duplicate shortcuts only in the new file.</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">checkForDuplicateShortcuts</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">inverted_new_d</span><span class="p">)</span>

        <span class="n">inverted_old_d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">inverted_new_d</span><span class="p">)</span> <span class="c"># Updates inverted_old_d in place.</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">uninvert</span><span class="p">(</span><span class="n">inverted_old_d</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>
    <span class="c">#@+node:ekr.20120311070142.9904: *5* lm.checkForDuplicateShortcuts</span></div>
<div class="viewcode-block" id="LoadManager.checkForDuplicateShortcuts"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.checkForDuplicateShortcuts">[docs]</a>    <span class="k">def</span> <span class="nf">checkForDuplicateShortcuts</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Check for duplicates in an &quot;inverted&quot; dictionary d</span>
<span class="sd">        whose keys are strokes and whose values are lists of ShortcutInfo nodes.</span>

<span class="sd">        Duplicates happen only if panes conflict.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c"># lm = self</span>

        <span class="c"># Fix bug 951921: check for duplicate shortcuts only in the new file.</span>
        <span class="k">for</span> <span class="n">ks</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
            <span class="n">conflict</span><span class="p">,</span><span class="n">panes</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,[</span><span class="s">&#39;all&#39;</span><span class="p">]</span>
            <span class="n">aList</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ks</span><span class="p">)</span>
            <span class="n">aList2</span> <span class="o">=</span> <span class="p">[</span><span class="n">si</span> <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="n">aList</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">si</span><span class="o">.</span><span class="n">pane</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;mode&#39;</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aList</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="n">aList2</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">si</span><span class="o">.</span><span class="n">pane</span> <span class="ow">in</span> <span class="n">panes</span><span class="p">:</span>
                        <span class="n">conflict</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">;</span> <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">panes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">si</span><span class="o">.</span><span class="n">pane</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">conflict</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;conflicting key bindings in </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">()))</span>
                <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="n">aList2</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%6s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">si</span><span class="o">.</span><span class="n">pane</span><span class="p">,</span><span class="n">si</span><span class="o">.</span><span class="n">stroke</span><span class="o">.</span><span class="n">s</span><span class="p">,</span><span class="n">si</span><span class="o">.</span><span class="n">commandName</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20120214132927.10724: *5* lm.invert</span></div>
<div class="viewcode-block" id="LoadManager.invert"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.invert">[docs]</a>    <span class="k">def</span> <span class="nf">invert</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">d</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Invert a shortcut dict whose keys are command names,</span>
<span class="sd">        returning a dict whose keys are strokes.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span> <span class="p">;</span> <span class="n">verbose</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;*&#39;</span><span class="o">*</span><span class="mi">40</span><span class="p">,</span><span class="n">d</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">TypedDictOfLists</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s">&#39;inverted </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">d</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span>
            <span class="n">keyType</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">KeyStroke</span><span class="p">,</span>
            <span class="n">valType</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">ShortcutInfo</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">commandName</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">commandName</span><span class="p">,[]):</span>
                <span class="c"># This assert can fail if there is an exception in the ShortcutInfo ctor.</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">si</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">ShortcutInfo</span><span class="p">),</span><span class="n">si</span>

                <span class="n">stroke</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">stroke</span> <span class="c"># This is canonicalized.</span>
                <span class="n">si</span><span class="o">.</span><span class="n">commandName</span> <span class="o">=</span> <span class="n">commandName</span> <span class="c"># Add info.</span>
                <span class="k">assert</span> <span class="n">stroke</span>
                <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%40s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">commandName</span><span class="p">,</span><span class="n">stroke</span><span class="p">))</span>
                <span class="n">result</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">stroke</span><span class="p">,</span><span class="n">si</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;returns  </span><span class="si">%4s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">())),</span><span class="nb">id</span><span class="p">(</span><span class="n">d</span><span class="p">),</span><span class="n">result</span><span class="o">.</span><span class="n">name</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="c">#@+node:ekr.20120214132927.10725: *5* lm.uninvert</span></div>
<div class="viewcode-block" id="LoadManager.uninvert"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.uninvert">[docs]</a>    <span class="k">def</span> <span class="nf">uninvert</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">d</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Uninvert an inverted shortcut dict whose keys are strokes,</span>
<span class="sd">        returning a dict whose keys are command names.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span> <span class="p">;</span> <span class="n">verbose</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;*&#39;</span><span class="o">*</span><span class="mi">40</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">d</span><span class="o">.</span><span class="n">keyType</span> <span class="o">==</span> <span class="n">g</span><span class="o">.</span><span class="n">KeyStroke</span><span class="p">,</span><span class="n">d</span><span class="o">.</span><span class="n">keyType</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">TypedDictOfLists</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s">&#39;uninverted </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">d</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span>
            <span class="n">keyType</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="s">&#39;commandName&#39;</span><span class="p">),</span>
            <span class="n">valType</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">ShortcutInfo</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">stroke</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">si</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stroke</span><span class="p">,[]):</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">si</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">ShortcutInfo</span><span class="p">),</span><span class="n">si</span>
                <span class="n">commandName</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">commandName</span>
                <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;uninvert </span><span class="si">%20s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">stroke</span><span class="p">,</span><span class="n">commandName</span><span class="p">))</span>
                <span class="k">assert</span> <span class="n">commandName</span>
                <span class="n">result</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">commandName</span><span class="p">,</span><span class="n">si</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;returns </span><span class="si">%4s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">keys</span><span class="p">())),</span><span class="nb">id</span><span class="p">(</span><span class="n">d</span><span class="p">),</span><span class="n">result</span><span class="o">.</span><span class="n">name</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="c">#@+node:ekr.20120222103014.10312: *4* lm.openSettingsFile</span></div>
<div class="viewcode-block" id="LoadManager.openSettingsFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.openSettingsFile">[docs]</a>    <span class="k">def</span> <span class="nf">openSettingsFile</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Open a settings file with a null gui.  Return the commander.</span>

<span class="sd">        The caller must init the c.config object.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="p">(</span><span class="bp">False</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">trace_startup</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;lm.openSettingsFile: g.app.gui: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">g</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">(</span><span class="n">fn</span><span class="p">)))</span>

        <span class="n">lm</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fn</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>

        <span class="n">giveMessage</span> <span class="o">=</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span> <span class="ow">and</span>
            <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">silentMode</span> <span class="ow">and</span>
            <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">batchMode</span><span class="p">)</span>
            <span class="c"># and not g.app.inBridge</span>
        <span class="k">def</span> <span class="nf">message</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="c"># This occurs early in startup, so use the following.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">giveMessage</span><span class="p">:</span> <span class="k">return</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="s">&#39;ascii&#39;</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="n">theFile</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">openLeoOrZipFile</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">theFile</span><span class="p">:</span>
            <span class="n">message</span><span class="p">(</span><span class="s">&#39;reading settings in </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fn</span><span class="p">))</span>

        <span class="c"># Changing g.app.gui here is a major hack.  It is necessary.</span>
        <span class="n">oldGui</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">nullGui</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">newCommander</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">enable</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">lockLog</span><span class="p">()</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fileCommands</span><span class="o">.</span><span class="n">openLeoFile</span><span class="p">(</span><span class="n">theFile</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span>
            <span class="n">readAtFileNodesFlag</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="c"># closes theFile.</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unlockLog</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">openDirectory</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">openDirectory</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_dirname</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span> <span class="o">=</span> <span class="n">oldGui</span>
        <span class="k">return</span> <span class="n">ok</span> <span class="ow">and</span> <span class="n">c</span> <span class="ow">or</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20120213081706.10382: *4* lm.readGlobalSettingsFiles (changed)</span></div>
<div class="viewcode-block" id="LoadManager.readGlobalSettingsFiles"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.readGlobalSettingsFiles">[docs]</a>    <span class="k">def</span> <span class="nf">readGlobalSettingsFiles</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Read leoSettings.leo and myLeoSettings.leo using a null gui.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="p">(</span><span class="bp">False</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">trace_startup</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="s">&#39;lm.readGlobalSettingsFiles&#39;</span>
        <span class="n">lm</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">trace_startup</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&lt;&lt;&lt;&lt;&lt; </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">tag</span><span class="p">)</span>

        <span class="c"># Open the standard settings files with a nullGui.</span>
        <span class="c"># Important: their commanders do not exist outside this method!</span>
        <span class="n">commanders</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">openSettingsFile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">computeLeoSettingsPath</span><span class="p">(),</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">computeMyLeoSettingsPath</span><span class="p">())]</span>

        <span class="n">settings_d</span><span class="p">,</span><span class="n">shortcuts_d</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">createDefaultSettingsDicts</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">commanders</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                <span class="n">settings_d</span><span class="p">,</span><span class="n">shortcuts_d</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">computeLocalSettings</span><span class="p">(</span>
                    <span class="n">c</span><span class="p">,</span><span class="n">settings_d</span><span class="p">,</span><span class="n">shortcuts_d</span><span class="p">,</span><span class="n">localFlag</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="c"># Adjust the name.</span>
        <span class="n">shortcuts_d</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="s">&#39;lm.globalShortcutsDict&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">commanders</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">traceSettingsDict</span><span class="p">(</span><span class="n">settings_d</span><span class="p">,</span><span class="n">verbose</span><span class="p">)</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">traceShortcutsDict</span><span class="p">(</span><span class="n">shortcuts_d</span><span class="p">,</span><span class="n">verbose</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&gt;&gt;&gt;&gt;&gt;</span><span class="si">%s</span><span class="s">...&#39;</span> <span class="o">%</span> <span class="n">tag</span><span class="p">)</span>

        <span class="n">lm</span><span class="o">.</span><span class="n">globalSettingsDict</span> <span class="o">=</span> <span class="n">settings_d</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">globalShortcutsDict</span> <span class="o">=</span> <span class="n">shortcuts_d</span>
    <span class="c">#@+node:ekr.20120214165710.10838: *4* lm.traceSettingsDict</span></div>
<div class="viewcode-block" id="LoadManager.traceSettingsDict"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.traceSettingsDict">[docs]</a>    <span class="k">def</span> <span class="nf">traceSettingsDict</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
                <span class="n">gs</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%35s</span><span class="s"> </span><span class="si">%17s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">(</span><span class="n">gs</span><span class="o">.</span><span class="n">path</span><span class="p">),</span><span class="n">gs</span><span class="o">.</span><span class="n">val</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">d</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20120214165710.10822: *4* lm.traceShortcutsDict</span></div>
<div class="viewcode-block" id="LoadManager.traceShortcutsDict"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.traceShortcutsDict">[docs]</a>    <span class="k">def</span> <span class="nf">traceShortcutsDict</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="c"># print(&#39;%20s %s&#39; % (key,val.dump()))</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%35s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,[</span><span class="n">z</span><span class="o">.</span><span class="n">stroke</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">val</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">d</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20120219154958.10452: *3* LM.load</span></div>
<div class="viewcode-block" id="LoadManager.load"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">pymacs</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">lm</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># Phase 1: before loading plugins.</span>
        <span class="c"># Scan options, set directories and read settings.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lm</span><span class="o">.</span><span class="n">isValidPython</span><span class="p">():</span> <span class="k">return</span>

        <span class="n">lm</span><span class="o">.</span><span class="n">doPrePluginsInit</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">pymacs</span><span class="p">)</span>
            <span class="c"># sets lm.options and lm.files</span>

        <span class="k">if</span> <span class="n">lm</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;version&#39;</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">signon</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c"># Phase 2: load plugins: the gui has already been set.</span>
        <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&quot;start1&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">killed</span><span class="p">:</span> <span class="k">return</span>

        <span class="c"># Phase 3: after loading plugins. Create one or more frames.</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">doPostPluginsInit</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span> <span class="c"># Clears horizontal scrolling in the log pane.</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">runMainLoop</span><span class="p">()</span>
            <span class="c"># For scripts, the gui is a nullGui.</span>
            <span class="c"># and the gui.setScript has already been called.</span>
    <span class="c">#@+node:ekr.20120219154958.10477: *4* LM.doPrePluginsInit &amp; helpers</span></div>
<div class="viewcode-block" id="LoadManager.doPrePluginsInit"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.doPrePluginsInit">[docs]</a>    <span class="k">def</span> <span class="nf">doPrePluginsInit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span><span class="n">pymacs</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; Scan options, set directories and read settings.&#39;&#39;&#39;</span>

        <span class="c"># trace = False</span>
        <span class="n">lm</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">computeStandardDirectories</span><span class="p">()</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">adjustSysPath</span><span class="p">()</span>

        <span class="c"># Scan the options as early as possible.</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">scanOptions</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">pymacs</span><span class="p">)</span>
            <span class="c"># also sets lm.files.</span>

        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;version&#39;</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">computeSignon</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="n">script</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;script&#39;</span><span class="p">)</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="n">script</span> <span class="ow">is</span> <span class="bp">None</span>

        <span class="c"># Init the app.</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">initApp</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">reportDirectories</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span>

        <span class="c"># Read settings *after* setting g.app.config and *before* opening plugins.</span>
        <span class="c"># This means if-gui has effect only in per-file settings.</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">readGlobalSettingsFiles</span><span class="p">()</span>
            <span class="c"># reads only standard settings files, using a null gui.</span>
            <span class="c"># uses lm.files[0] to compute the local directory</span>
            <span class="c"># that might contain myLeoSettings.leo.</span>

        <span class="c"># Read the recent files file.</span>
        <span class="n">localConfigFile</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">lm</span><span class="o">.</span><span class="n">files</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">recentFilesManager</span><span class="o">.</span><span class="n">readRecentFiles</span><span class="p">(</span><span class="n">localConfigFile</span><span class="p">)</span>

        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">setGlobalDb</span><span class="p">()</span>

        <span class="c"># Create the gui after reading options and settings.</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">createGui</span><span class="p">(</span><span class="n">pymacs</span><span class="p">)</span>

        <span class="c"># We can&#39;t print the signon until we know the gui.</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">computeSignon</span><span class="p">()</span> <span class="c"># Set app.signon/signon2 for commanders.</span>
    <span class="c">#@+node:ekr.20120219154958.10478: *5* LM.createGui</span></div>
<div class="viewcode-block" id="LoadManager.createGui"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.createGui">[docs]</a>    <span class="k">def</span> <span class="nf">createGui</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pymacs</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="p">(</span><span class="bp">False</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">trace_startup</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">==================== LM.createGui&#39;</span><span class="p">)</span>

        <span class="n">lm</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">gui_option</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;gui&#39;</span><span class="p">)</span>
        <span class="n">windowFlag</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;windowFlag&#39;</span><span class="p">)</span>
        <span class="n">script</span>     <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;script&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span> <span class="o">==</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">nullGui</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># Enable g.app.createDefaultGui </span>
                <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">createDefaultGui</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># This can happen when launching Leo from IPython.</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;g.app.gui&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">gui_option</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">script</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">windowFlag</span><span class="p">:</span>
                <span class="c"># Always use null gui for scripts.</span>
                <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">createNullGuiWithScript</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">createDefaultGui</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">createSpecialGui</span><span class="p">(</span><span class="n">gui_option</span><span class="p">,</span><span class="n">pymacs</span><span class="p">,</span><span class="n">script</span><span class="p">,</span><span class="n">windowFlag</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20120219154958.10479: *5* LM.createSpecialGui</span></div>
<div class="viewcode-block" id="LoadManager.createSpecialGui"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.createSpecialGui">[docs]</a>    <span class="k">def</span> <span class="nf">createSpecialGui</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">gui</span><span class="p">,</span><span class="n">pymacs</span><span class="p">,</span><span class="n">script</span><span class="p">,</span><span class="n">windowFlag</span><span class="p">):</span>

        <span class="c"># lm = self</span>

        <span class="k">if</span> <span class="n">pymacs</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">createNullGuiWithScript</span><span class="p">(</span><span class="n">script</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">script</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">windowFlag</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">createDefaultGui</span><span class="p">()</span>
                <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">setScript</span><span class="p">(</span><span class="n">script</span><span class="o">=</span><span class="n">script</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">createNullGuiWithScript</span><span class="p">(</span><span class="n">script</span><span class="o">=</span><span class="n">script</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># assert g.app.guiArgName</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">createDefaultGui</span><span class="p">()</span> 
    <span class="c">#@+node:ekr.20120219154958.10480: *5* LM.adjustSysPath</span></div>
<div class="viewcode-block" id="LoadManager.adjustSysPath"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.adjustSysPath">[docs]</a>    <span class="k">def</span> <span class="nf">adjustSysPath</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Adjust sys.path to enable imports as usual with Leo.</span>

<span class="sd">        This method is no longer needed:</span>

<span class="sd">            1. g.importModule will import from the</span>
<span class="sd">               &#39;external&#39; or &#39;extensions&#39; folders as needed</span>
<span class="sd">               without altering sys.path.</span>

<span class="sd">            2.  Plugins now do fully qualified imports.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">pass</span>
    <span class="c">#@+node:ekr.20120219154958.10482: *5* LM.getDefaultFile</span></div>
<div class="viewcode-block" id="LoadManager.getDefaultFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.getDefaultFile">[docs]</a>    <span class="k">def</span> <span class="nf">getDefaultFile</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># Get the name of the workbook.</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getString</span><span class="p">(</span><span class="s">&#39;default_leo_file&#39;</span><span class="p">)</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fn</span><span class="p">:</span> <span class="k">return</span>

        <span class="c"># g.trace(g.os_path_exists(fn),fn)</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">fn</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_isabs</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="c"># Create the file.</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Using default leo file name:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fn</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">fn</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># It&#39;s too risky to open a default file if it is relative.</span>
            <span class="k">return</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20120219154958.10484: *5* LM.initApp</span></div>
<div class="viewcode-block" id="LoadManager.initApp"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.initApp">[docs]</a>    <span class="k">def</span> <span class="nf">initApp</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">verbose</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="p">(</span><span class="bp">False</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">trace_startup</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;LM.initApp&#39;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadManager</span>

        <span class="kn">import</span> <span class="nn">leo.core.leoConfig</span> <span class="kn">as</span> <span class="nn">leoConfig</span>
        <span class="kn">import</span> <span class="nn">leo.core.leoNodes</span> <span class="kn">as</span> <span class="nn">leoNodes</span>
        <span class="kn">import</span> <span class="nn">leo.core.leoPlugins</span> <span class="kn">as</span> <span class="nn">leoPlugins</span>
        <span class="kn">import</span> <span class="nn">leo.core.leoSessions</span> <span class="kn">as</span> <span class="nn">leoSessions</span>

        <span class="c"># Import leoIPython only if requested.  The import is quite slow.</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">useIpython</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">leo.core.leoIPython</span> <span class="kn">as</span> <span class="nn">leoIPython</span>
            <span class="c"># Use the GlobalIPythonManager created during the import process.</span>
            <span class="c"># This ensures that only one copy is ever created.</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">ipm</span> <span class="o">=</span> <span class="n">leoIPython</span><span class="o">.</span><span class="n">g_ipm</span>

        <span class="c"># Make sure we call the new leoPlugins.init top-level function.</span>
        <span class="c"># This prevents a crash when run is called repeatedly from</span>
        <span class="c"># IPython&#39;s lleo extension.</span>
        <span class="n">leoPlugins</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>

        <span class="c"># Force the user to set g.app.leoID.</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">setLeoID</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="c"># Create early classes *after* doing plugins.init()</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">recentFilesManager</span> <span class="o">=</span> <span class="n">RecentFilesManager</span><span class="p">()</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">leoConfig</span><span class="o">.</span><span class="n">GlobalConfigManager</span><span class="p">()</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">nodeIndices</span> <span class="o">=</span> <span class="n">leoNodes</span><span class="o">.</span><span class="n">nodeIndices</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">leoID</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">sessionManager</span> <span class="o">=</span> <span class="n">leoSessions</span><span class="o">.</span><span class="n">SessionManager</span><span class="p">()</span>

        <span class="c"># Complete the plugins class last.</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">pluginsController</span><span class="o">.</span><span class="n">finishCreate</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20120219154958.10486: *5* LM.scanOptions &amp; helper</span></div>
<div class="viewcode-block" id="LoadManager.scanOptions"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.scanOptions">[docs]</a>    <span class="k">def</span> <span class="nf">scanOptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span><span class="n">pymacs</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Handle all options, remove them from sys.argv and set lm.options.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">lm</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># print(&#39;scanOptions&#39;,sys.argv)</span>

        <span class="c"># Note: this automatically implements the --help option.</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">optparse</span><span class="o">.</span><span class="n">OptionParser</span><span class="p">()</span>
        <span class="n">add</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span>

        <span class="n">add</span><span class="p">(</span><span class="s">&#39;--fullscreen&#39;</span><span class="p">,</span>   <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span>
            <span class="n">help</span> <span class="o">=</span> <span class="s">&#39;start fullscreen (Qt only)&#39;</span><span class="p">)</span>
        <span class="n">add</span><span class="p">(</span><span class="s">&#39;--ipython&#39;</span><span class="p">,</span>      <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s">&quot;use_ipython&quot;</span><span class="p">,</span>
            <span class="n">help</span> <span class="o">=</span> <span class="s">&#39;enable ipython support&#39;</span><span class="p">)</span>
        <span class="n">add</span><span class="p">(</span><span class="s">&#39;--gui&#39;</span><span class="p">,</span>
            <span class="n">help</span> <span class="o">=</span> <span class="s">&#39;gui to use (qt/qttabs)&#39;</span><span class="p">)</span>
        <span class="n">add</span><span class="p">(</span><span class="s">&#39;--maximized&#39;</span><span class="p">,</span>    <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span>
            <span class="n">help</span> <span class="o">=</span> <span class="s">&#39;start maximized (Qt only)&#39;</span><span class="p">)</span>
        <span class="n">add</span><span class="p">(</span><span class="s">&#39;--minimized&#39;</span><span class="p">,</span>    <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span>
            <span class="n">help</span> <span class="o">=</span> <span class="s">&#39;start minimized&#39;</span><span class="p">)</span>
        <span class="n">add</span><span class="p">(</span><span class="s">&#39;--no-cache&#39;</span><span class="p">,</span>     <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;no_cache&#39;</span><span class="p">,</span>
            <span class="n">help</span> <span class="o">=</span> <span class="s">&#39;disable reading of cached files&#39;</span><span class="p">)</span>
        <span class="n">add</span><span class="p">(</span><span class="s">&#39;--no-plugins&#39;</span><span class="p">,</span>   <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;no_plugins&#39;</span><span class="p">,</span>
            <span class="n">help</span> <span class="o">=</span> <span class="s">&#39;disable all plugins&#39;</span><span class="p">)</span>
        <span class="n">add</span><span class="p">(</span><span class="s">&#39;--no-splash&#39;</span><span class="p">,</span>    <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;no_splash_screen&#39;</span><span class="p">,</span>
            <span class="n">help</span> <span class="o">=</span> <span class="s">&#39;disable the splash screen&#39;</span><span class="p">)</span>
        <span class="n">add</span><span class="p">(</span><span class="s">&#39;--screen-shot&#39;</span><span class="p">,</span>  <span class="n">dest</span><span class="o">=</span><span class="s">&#39;screenshot_fn&#39;</span><span class="p">,</span>
            <span class="n">help</span> <span class="o">=</span> <span class="s">&#39;take a screen shot and then exit&#39;</span><span class="p">)</span>
        <span class="n">add</span><span class="p">(</span><span class="s">&#39;--script&#39;</span><span class="p">,</span>       <span class="n">dest</span><span class="o">=</span><span class="s">&quot;script&quot;</span><span class="p">,</span>
            <span class="n">help</span> <span class="o">=</span> <span class="s">&#39;execute a script and then exit&#39;</span><span class="p">)</span>
        <span class="n">add</span><span class="p">(</span><span class="s">&#39;--script-window&#39;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s">&quot;script_window&quot;</span><span class="p">,</span>
            <span class="n">help</span> <span class="o">=</span> <span class="s">&#39;open a window for scripts&#39;</span><span class="p">)</span>
        <span class="n">add</span><span class="p">(</span><span class="s">&#39;--select&#39;</span><span class="p">,</span>       <span class="n">dest</span><span class="o">=</span><span class="s">&#39;select&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s">&#39;headline or gnx of node to select&#39;</span><span class="p">)</span>
        <span class="n">add</span><span class="p">(</span><span class="s">&#39;--session-restore&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s">&#39;session_restore&#39;</span><span class="p">,</span>
            <span class="n">help</span> <span class="o">=</span> <span class="s">&#39;restore previously saved session tabs at startup&#39;</span><span class="p">)</span>
        <span class="n">add</span><span class="p">(</span><span class="s">&#39;--session-save&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span><span class="n">dest</span><span class="o">=</span><span class="s">&#39;session_save&#39;</span><span class="p">,</span>
            <span class="n">help</span> <span class="o">=</span> <span class="s">&#39;save session tabs on exit&#39;</span><span class="p">)</span>
        <span class="n">add</span><span class="p">(</span><span class="s">&#39;--silent&#39;</span><span class="p">,</span>       <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;silent&quot;</span><span class="p">,</span>
            <span class="n">help</span> <span class="o">=</span> <span class="s">&#39;disable all log messages&#39;</span><span class="p">)</span>
        <span class="n">add</span><span class="p">(</span><span class="s">&#39;--version&#39;</span><span class="p">,</span>      <span class="n">action</span><span class="o">=</span><span class="s">&quot;store_true&quot;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&quot;version&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s">&#39;print version number and exit&#39;</span><span class="p">)</span>
        <span class="n">add</span><span class="p">(</span><span class="s">&#39;--window-size&#39;</span><span class="p">,</span>  <span class="n">dest</span><span class="o">=</span><span class="s">&#39;window_size&#39;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s">&#39;initial window size in height x width format&#39;</span><span class="p">)</span>

        <span class="c"># Parse the options, and remove them from sys.argv.</span>
        <span class="n">options</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="o">=</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="p">;</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
            <span class="c"># print(&#39;scanOptions:&#39;,sys.argv)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;options&#39;</span><span class="p">,</span><span class="n">options</span><span class="p">)</span>

        <span class="c"># Handle the args...</span>

        <span class="c"># --gui</span>
        <span class="n">gui</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">gui</span>

        <span class="k">if</span> <span class="n">gui</span><span class="p">:</span>
            <span class="n">gui</span> <span class="o">=</span> <span class="n">gui</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">gui</span> <span class="o">==</span> <span class="s">&#39;qttabs&#39;</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">qt_use_tabs</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">gui</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;curses&#39;</span><span class="p">,</span><span class="s">&#39;qt&#39;</span><span class="p">,</span><span class="s">&#39;null&#39;</span><span class="p">):</span>
                <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">qt_use_tabs</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;scanOptions: unknown gui: </span><span class="si">%s</span><span class="s">.  Using qt gui&#39;</span> <span class="o">%</span> <span class="n">gui</span><span class="p">)</span>
                <span class="n">gui</span> <span class="o">=</span> <span class="s">&#39;qt&#39;</span>
                <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">qt_use_tabs</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&#39;darwin&#39;</span><span class="p">:</span>
            <span class="n">gui</span> <span class="o">=</span> <span class="s">&#39;qt&#39;</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">qt_use_tabs</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gui</span> <span class="o">=</span> <span class="s">&#39;qttabs&#39;</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">qt_use_tabs</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">assert</span> <span class="n">gui</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">guiArgName</span> <span class="o">=</span> <span class="n">gui</span>

        <span class="c"># --ipython</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">useIpython</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">use_ipython</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;g.app.useIpython&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">useIpython</span><span class="p">)</span>

        <span class="c"># --fullscreen</span>
        <span class="c"># --minimized</span>
        <span class="c"># --maximized</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">start_fullscreen</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">fullscreen</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">start_maximized</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">maximized</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">start_minimized</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">minimized</span>

        <span class="c"># --no-cache</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">no_cache</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;scanOptions: disabling caching&#39;</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">enableDB</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># --no-plugins</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">no_plugins</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;scanOptions: disabling plugins&#39;</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">enablePlugins</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># --no-splash</span>
        <span class="c"># g.trace(&#39;--no-splash&#39;,options.no_splash_screen)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">use_splash_screen</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">no_splash_screen</span>

        <span class="c"># --screen-shot=fn</span>
        <span class="n">screenshot_fn</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">screenshot_fn</span>
        <span class="k">if</span> <span class="n">screenshot_fn</span><span class="p">:</span>
            <span class="n">screenshot_fn</span> <span class="o">=</span> <span class="n">screenshot_fn</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;scanOptions: screenshot_fn&#39;</span><span class="p">,</span><span class="n">screenshot_fn</span><span class="p">)</span>

        <span class="c"># --script</span>
        <span class="n">script_path</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">script</span>
        <span class="n">script_path_w</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">script_window</span>
        <span class="k">if</span> <span class="n">script_path</span> <span class="ow">and</span> <span class="n">script_path_w</span><span class="p">:</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;--script and script-window are mutually exclusive&quot;</span><span class="p">)</span>

        <span class="n">script_name</span> <span class="o">=</span> <span class="n">script_path</span> <span class="ow">or</span> <span class="n">script_path_w</span>
        <span class="k">if</span> <span class="n">script_name</span><span class="p">:</span>
            <span class="n">script_name</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadDir</span><span class="p">,</span><span class="n">script_name</span><span class="p">)</span>
            <span class="n">script</span><span class="p">,</span><span class="n">e</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">readFileIntoString</span><span class="p">(</span><span class="n">script_name</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;script:&#39;</span><span class="p">)</span>
            <span class="c"># print(&#39;script_name&#39;,repr(script_name))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">script</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="c"># if trace: print(&#39;scanOptions: no script&#39;)</span>

        <span class="c"># --select</span>
        <span class="n">select</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">select</span>
        <span class="k">if</span> <span class="n">select</span><span class="p">:</span>
            <span class="n">select</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;scanOptions: select&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">select</span><span class="p">))</span>

        <span class="c"># --session-restore &amp; --session-save</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">restore_session</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">session_restore</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">save_session</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">session_save</span><span class="p">)</span>

        <span class="c"># --silent</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">silentMode</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">silent</span>
        <span class="c"># print(&#39;scanOptions: silentMode&#39;,g.app.silentMode)</span>

        <span class="c"># --version: print the version and exit.</span>
        <span class="n">versionFlag</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">version</span>


        <span class="c"># --window-size</span>
        <span class="n">windowSize</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">window_size</span>
        <span class="k">if</span> <span class="n">windowSize</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;windowSize&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">windowSize</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">h</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="n">windowSize</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">windowSize</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;bad --window-size:&#39;</span><span class="p">,</span><span class="n">windowSize</span><span class="p">)</span>

        <span class="c"># Compute lm.files</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">computeFilesList</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>

        <span class="c"># Post-process the options.</span>
        <span class="k">if</span> <span class="n">pymacs</span><span class="p">:</span>
            <span class="n">script</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">windowFlag</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># Compute the return values.</span>
        <span class="n">windowFlag</span> <span class="o">=</span> <span class="n">script</span> <span class="ow">and</span> <span class="n">script_path_w</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;gui&#39;</span><span class="p">:</span><span class="n">gui</span><span class="p">,</span>
            <span class="s">&#39;screenshot_fn&#39;</span><span class="p">:</span><span class="n">screenshot_fn</span><span class="p">,</span>
            <span class="s">&#39;script&#39;</span><span class="p">:</span><span class="n">script</span><span class="p">,</span>
            <span class="s">&#39;select&#39;</span><span class="p">:</span><span class="n">select</span><span class="p">,</span>
            <span class="s">&#39;version&#39;</span><span class="p">:</span><span class="n">versionFlag</span><span class="p">,</span>
            <span class="s">&#39;windowFlag&#39;</span><span class="p">:</span><span class="n">windowFlag</span><span class="p">,</span>
            <span class="s">&#39;windowSize&#39;</span><span class="p">:</span><span class="n">windowSize</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">d</span>
    <span class="c">#@+node:ekr.20120219154958.10483: *6* LM.computeFilesList</span></div>
<div class="viewcode-block" id="LoadManager.computeFilesList"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.computeFilesList">[docs]</a>    <span class="k">def</span> <span class="nf">computeFilesList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="p">):</span>

        <span class="n">lm</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">fileName</span><span class="p">:</span>
            <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">arg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">):</span>
                <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">lm</span><span class="o">.</span><span class="n">completeFileName</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
    <span class="c">#@+node:ekr.20120219154958.10487: *4* LM.doPostPluginsInit &amp; helpers</span></div>
<div class="viewcode-block" id="LoadManager.doPostPluginsInit"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.doPostPluginsInit">[docs]</a>    <span class="k">def</span> <span class="nf">doPostPluginsInit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Create a Leo window for each file in the lm.files list.&#39;&#39;&#39;</span>

        <span class="c"># Clear g.app.initing _before_ creating commanders.</span>
        <span class="n">lm</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">initing</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># &quot;idle&quot; hooks may now call g.app.forceShutdown.</span>

        <span class="c"># Create the main frame.  Show it and all queued messages.</span>

        <span class="c"># g.trace(lm.files)</span>
        <span class="k">if</span> <span class="n">lm</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">lm</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">loadLocalFile</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">gui</span><span class="o">=</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="p">,</span><span class="n">old_c</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
                    <span class="c"># Will give a &quot;not found&quot; message.</span>
                <span class="c"># This can fail if the file is open in another instance of Leo.</span>
                <span class="c"># assert c</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">c1</span><span class="p">:</span> <span class="n">c1</span> <span class="o">=</span> <span class="n">c</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">c1</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">restore_session</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">sessionManager</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">aList</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">load_snapshot</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">aList</span><span class="p">:</span>
                    <span class="n">m</span><span class="o">.</span><span class="n">load_session</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span><span class="n">aList</span><span class="p">)</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">c1</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">windowList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">c</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">windowList</span><span class="p">:</span>
            <span class="c"># Create an empty frame.</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">computeWorkbookFileName</span><span class="p">()</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">c1</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">loadLocalFile</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">gui</span><span class="o">=</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="p">,</span><span class="n">old_c</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

        <span class="c"># Put the focus in the first-opened file.</span>
        <span class="n">fileName</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">lm</span><span class="o">.</span><span class="n">files</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">c1</span>

        <span class="c"># For qttabs gui, select the first-loaded tab.</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="p">,</span><span class="s">&#39;frameFactory&#39;</span><span class="p">):</span>
            <span class="n">factory</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">frameFactory</span>
            <span class="k">if</span> <span class="n">factory</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">factory</span><span class="p">,</span><span class="s">&#39;setTabForCommander&#39;</span><span class="p">):</span>
                <span class="n">factory</span><span class="o">.</span><span class="n">setTabForCommander</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="c"># Fix bug 844953: tell Unity which menu to use.</span>
        <span class="n">c</span><span class="o">.</span><span class="n">enableMenuBar</span><span class="p">()</span>

        <span class="c"># Do the final inits.</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">logInited</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">initComplete</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">c</span><span class="o">.</span><span class="n">setLog</span><span class="p">()</span>
        <span class="c"># print(&#39;doPostPluginsInit: ***** set log&#39;)</span>

        <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&quot;start2&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">,</span><span class="n">fileName</span><span class="o">=</span><span class="n">fileName</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">enableIdleTimeHook</span><span class="p">(</span><span class="n">idleTimeDelay</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">initFocusAndDraw</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>

        <span class="n">screenshot_fn</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;screenshot_fn&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">screenshot_fn</span><span class="p">:</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">make_screen_shot</span><span class="p">(</span><span class="n">screenshot_fn</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span> <span class="c"># Force an immediate exit.</span>

        <span class="k">return</span> <span class="bp">True</span>
    <span class="c">#@+node:ekr.20120219154958.10488: *5* LM.initFocusAndDraw</span></div>
<div class="viewcode-block" id="LoadManager.initFocusAndDraw"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.initFocusAndDraw">[docs]</a>    <span class="k">def</span> <span class="nf">initFocusAndDraw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">fileName</span><span class="p">):</span>

        <span class="n">w</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">get_focus</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">fileName</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>

        <span class="c"># Respect c&#39;s focus wishes if posssible.</span>
        <span class="k">if</span> <span class="n">w</span> <span class="o">!=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">bodyCtrl</span> <span class="ow">and</span> <span class="n">w</span> <span class="o">!=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">canvas</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">bodyWantsFocus</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">showStateAndMode</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">outerUpdate</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20120219154958.10489: *5* LM.make_screen_shot</span></div>
<div class="viewcode-block" id="LoadManager.make_screen_shot"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.make_screen_shot">[docs]</a>    <span class="k">def</span> <span class="nf">make_screen_shot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Create a screenshot of the present Leo outline and save it to path.&#39;&#39;&#39;</span>

        <span class="c"># g.trace(&#39;runLeo.py&#39;,fn)</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">guiName</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;qt&#39;</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">loadOnePlugin</span><span class="p">(</span><span class="s">&#39;screenshots&#39;</span><span class="p">)</span>
            <span class="n">m</span><span class="o">.</span><span class="n">make_screen_shot</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20120219154958.10491: *4* LM.isValidPython &amp; emergency (Tk) dialog class</span></div>
<div class="viewcode-block" id="LoadManager.isValidPython"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.isValidPython">[docs]</a>    <span class="k">def</span> <span class="nf">isValidPython</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&#39;cli&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="n">minimum_python_version</span> <span class="o">=</span> <span class="s">&#39;2.6&#39;</span>

        <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">    Leo requires Python </span><span class="si">%s</span><span class="s"> or higher.</span>
<span class="s">    You may download Python from</span>
<span class="s">    http://python.org/download/</span>
<span class="s">    &quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">minimum_python_version</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">version</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)])</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">CheckVersion</span><span class="p">(</span><span class="n">version</span><span class="p">,</span><span class="n">minimum_python_version</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c"># g.app.gui does not exist yet.</span>
                    <span class="kn">import</span> <span class="nn">Tkinter</span> <span class="kn">as</span> <span class="nn">Tk</span>
                    <span class="c">#@+&lt;&lt; define emergency dialog class &gt;&gt;</span>
                    <span class="c">#@+node:ekr.20120219154958.10492: *5* &lt;&lt; define emergency dialog class &gt;&gt;</span>
                    <span class="k">class</span> <span class="nc">emergencyDialog</span><span class="p">:</span>

                        <span class="sd">&quot;&quot;&quot;A class that creates an Tkinter dialog with a single OK button.&quot;&quot;&quot;</span>

                        <span class="c">#@+others</span>
                        <span class="c">#@+node:ekr.20120219154958.10493: *6* __init__ (emergencyDialog)</span>
                        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="n">message</span><span class="p">):</span>

                            <span class="sd">&quot;&quot;&quot;Constructor for the leoTkinterDialog class.&quot;&quot;&quot;</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">answer</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># Value returned from run()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">title</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">=</span><span class="n">message</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">buttonsFrame</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># Frame to hold typical dialog buttons.</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">defaultButtonCommand</span> <span class="o">=</span> <span class="bp">None</span>
                                <span class="c"># Command to call when user closes the window</span>
                                <span class="c"># by clicking the close box.</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># The outermost frame.</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># Created in createTopFrame.</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># The toplevel Tk widget.</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">createTopFrame</span><span class="p">()</span>
                            <span class="n">buttons</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;text&quot;</span><span class="p">:</span><span class="s">&quot;OK&quot;</span><span class="p">,</span><span class="s">&quot;command&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">okButton</span><span class="p">,</span><span class="s">&quot;default&quot;</span><span class="p">:</span><span class="bp">True</span><span class="p">},</span>
                                <span class="c"># Singleton tuple.</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">createButtons</span><span class="p">(</span><span class="n">buttons</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="s">&quot;&lt;Key&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onKey</span><span class="p">)</span>
                        <span class="c">#@+node:ekr.20120219154958.10494: *6* createButtons</span>
                        <span class="k">def</span> <span class="nf">createButtons</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">buttons</span><span class="p">):</span>

                            <span class="sd">&quot;&quot;&quot;Create a row of buttons.</span>

<span class="sd">                            buttons is a list of dictionaries containing</span>
<span class="sd">                            the properties of each button.&quot;&quot;&quot;</span>

                            <span class="k">assert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">buttonsFrame</span> <span class="o">=</span> <span class="n">f</span> <span class="o">=</span> <span class="n">Tk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="p">)</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="s">&quot;top&quot;</span><span class="p">,</span><span class="n">padx</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

                            <span class="c"># Buttons is a list of dictionaries, with an empty dictionary</span>
                            <span class="c"># at the end if there is only one entry.</span>
                            <span class="n">buttonList</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
                                <span class="n">text</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;text&quot;</span><span class="p">,</span><span class="s">&quot;&lt;missing button name&gt;&quot;</span><span class="p">)</span>
                                <span class="n">isDefault</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;default&quot;</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
                                <span class="n">underline</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;underline&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                                <span class="n">command</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;command&quot;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
                                <span class="n">bd</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">isDefault</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

                                <span class="n">b</span> <span class="o">=</span> <span class="n">Tk</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span><span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span><span class="n">bd</span><span class="o">=</span><span class="n">bd</span><span class="p">,</span>
                                    <span class="n">underline</span><span class="o">=</span><span class="n">underline</span><span class="p">,</span><span class="n">command</span><span class="o">=</span><span class="n">command</span><span class="p">)</span>
                                <span class="n">b</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="s">&quot;left&quot;</span><span class="p">,</span><span class="n">padx</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">pady</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
                                <span class="n">buttonList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

                                <span class="k">if</span> <span class="n">isDefault</span> <span class="ow">and</span> <span class="n">command</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">defaultButtonCommand</span> <span class="o">=</span> <span class="n">command</span>

                            <span class="k">return</span> <span class="n">buttonList</span>
                        <span class="c">#@+node:ekr.20120219154958.10495: *6* createTopFrame</span>
                        <span class="k">def</span> <span class="nf">createTopFrame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

                            <span class="sd">&quot;&quot;&quot;Create the Tk.Toplevel widget for a leoTkinterDialog.&quot;&quot;&quot;</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">Tk</span><span class="o">.</span><span class="n">Tk</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">Tk</span><span class="o">.</span><span class="n">Toplevel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">withdraw</span><span class="p">()</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">Tk</span><span class="o">.</span><span class="n">Frame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">side</span><span class="o">=</span><span class="s">&quot;top&quot;</span><span class="p">,</span><span class="n">expand</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">fill</span><span class="o">=</span><span class="s">&quot;both&quot;</span><span class="p">)</span>

                            <span class="n">label</span> <span class="o">=</span> <span class="n">Tk</span><span class="o">.</span><span class="n">Label</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span><span class="n">text</span><span class="o">=</span><span class="n">message</span><span class="p">,</span><span class="n">bg</span><span class="o">=</span><span class="s">&#39;white&#39;</span><span class="p">)</span>
                            <span class="n">label</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">pady</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
                        <span class="c">#@+node:ekr.20120219154958.10496: *6* okButton</span>
                        <span class="k">def</span> <span class="nf">okButton</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

                            <span class="sd">&quot;&quot;&quot;Do default click action in ok button.&quot;&quot;&quot;</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">top</span> <span class="o">=</span> <span class="bp">None</span>

                        <span class="c">#@+node:ekr.20120219154958.10497: *6* onKey</span>
                        <span class="k">def</span> <span class="nf">onKey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>

                            <span class="sd">&quot;&quot;&quot;Handle Key events in askOk dialogs.&quot;&quot;&quot;</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">okButton</span><span class="p">()</span>

                            <span class="k">return</span> <span class="c"># (for Tk) &quot;break&quot;</span>
                        <span class="c">#@+node:ekr.20120219154958.10498: *6* run</span>
                        <span class="k">def</span> <span class="nf">run</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

                            <span class="sd">&quot;&quot;&quot;Run the modal emergency dialog.&quot;&quot;&quot;</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">geometry</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="s">x</span><span class="si">%d%+d%+d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">300</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">50</span><span class="p">))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">lift</span><span class="p">()</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">grab_set</span><span class="p">()</span> <span class="c"># Make the dialog a modal dialog.</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">wait_window</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top</span><span class="p">)</span>
                        <span class="c">#@-others</span>
                    <span class="c">#@-&lt;&lt; define emergency dialog class &gt;&gt;</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="n">emergencyDialog</span><span class="p">(</span>
                        <span class="n">title</span><span class="o">=</span><span class="s">&#39;Python Version Error&#39;</span><span class="p">,</span>
                        <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>
                    <span class="n">d</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">return</span> <span class="n">ok</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;isValidPython: unexpected exception: g.CheckVersion&quot;</span><span class="p">)</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="k">return</span> <span class="mi">0</span>
    <span class="c">#@+node:ekr.20120223062418.10393: *4* LM.loadLocalFile &amp; helper</span></div>
<div class="viewcode-block" id="LoadManager.loadLocalFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.loadLocalFile">[docs]</a>    <span class="k">def</span> <span class="nf">loadLocalFile</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span><span class="n">gui</span><span class="p">,</span><span class="n">old_c</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Completely read a file, creating the corresonding outline.</span>

<span class="sd">        1. If fn is an existing .leo file (possibly zipped), read it twice:</span>
<span class="sd">        the first time with a nullGui to discover settings,</span>
<span class="sd">        the second time with the requested gui to create the outline.</span>

<span class="sd">        2. If fn is an external file:</span>
<span class="sd">        get settings from the leoSettings.leo and myLeoSetting.leo, then</span>
<span class="sd">        create a &quot;wrapper&quot; outline continain an @file node for the external file.</span>

<span class="sd">        3. If fn is empty:</span>
<span class="sd">        get settings from the leoSettings.leo and myLeoSetting.leo or default settings,</span>
<span class="sd">        or open an empty outline.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="p">(</span><span class="bp">False</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">trace_startup</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;lm.loadLocalFile: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fn</span><span class="p">))</span>

        <span class="n">lm</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># Step 0: Return if the file is already open.</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fn</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">findOpenFile</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;Already open: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fn</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">c</span>

        <span class="c"># Step 1: get the previous settings.</span>
        <span class="c"># For .leo files (and zipped .leo files) this pre-reads the file in a null gui.</span>
        <span class="c"># Otherwise, get settings from leoSettings.leo, myLeoSettings.leo, or default settings.</span>
        <span class="n">previousSettings</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">getPreviousSettings</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

        <span class="c"># Step 2: open the outline in the requested gui.</span>
        <span class="c"># For .leo files (and zipped .leo file) this opens the file a second time.</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">openFileByName</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">gui</span><span class="p">,</span><span class="n">old_c</span><span class="p">,</span><span class="n">previousSettings</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c</span>
    <span class="c">#@+node:ekr.20120223062418.10394: *5* LM.openFileByName &amp; helpers</span></div>
<div class="viewcode-block" id="LoadManager.openFileByName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.openFileByName">[docs]</a>    <span class="k">def</span> <span class="nf">openFileByName</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span><span class="n">gui</span><span class="p">,</span><span class="n">old_c</span><span class="p">,</span><span class="n">previousSettings</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Read the local file whose full path is fn using the given gui.</span>
<span class="sd">        fn may be a Leo file (including .leo or zipped file) or an external file.</span>

<span class="sd">        This is not a pre-read: the previousSettings always exist and</span>
<span class="sd">        the commander created here persists until the user closes the outline.</span>

<span class="sd">        Reads the entire outline if fn exists and is a .leo file or zipped file.</span>
<span class="sd">        Creates an empty outline if fn is a non-existent Leo file.</span>
<span class="sd">        Creates an wrapper outline if fn is an external file, existing or not.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="p">(</span><span class="bp">False</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">trace_startup</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;lm.openFileByName: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">(</span><span class="n">fn</span><span class="p">)))</span>   
        <span class="n">lm</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># Disable the log.</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">setLog</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">lockLog</span><span class="p">()</span>

        <span class="c"># Create the a commander for the .leo file.</span>
        <span class="c"># Important.  The settings don&#39;t matter for pre-reads!</span>
        <span class="c"># For second read, the settings for the file are *exactly* previousSettings.</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">newCommander</span><span class="p">(</span><span class="n">fileName</span><span class="o">=</span><span class="n">fn</span><span class="p">,</span><span class="n">gui</span><span class="o">=</span><span class="n">gui</span><span class="p">,</span>
            <span class="n">previousSettings</span><span class="o">=</span><span class="n">previousSettings</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">c</span>

        <span class="c"># Open the file, if possible.</span>
        <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&#39;open0&#39;</span><span class="p">)</span>
        <span class="n">theFile</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">openLeoOrZipFile</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

        <span class="c"># Enable the log.</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unlockLog</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">enable</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

        <span class="c"># Phase 2: Create the outline.</span>
        <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&quot;open1&quot;</span><span class="p">,</span><span class="n">old_c</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">new_c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">fileName</span><span class="o">=</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">theFile</span><span class="p">:</span>
            <span class="n">readAtFileNodesFlag</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">previousSettings</span><span class="p">)</span>
            <span class="c">### The log is not set properly here. ###</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">readOpenedLeoFile</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">gui</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span><span class="n">readAtFileNodesFlag</span><span class="p">,</span><span class="n">theFile</span><span class="p">)</span>
                <span class="c"># Call c.fileCommands.openLeoFile to read the .leo file.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Create a wrapper .leo file if:</span>
            <span class="c"># a) fn is a .leo file that does not exist or</span>
            <span class="c"># b) fn is an external file, existing or not.</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">initWrapperLeoFile</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&quot;open2&quot;</span><span class="p">,</span><span class="n">old_c</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">new_c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">fileName</span><span class="o">=</span><span class="n">fn</span><span class="p">)</span>

        <span class="c"># Phase 3: Complete the initialization.</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">writeWaitingLog</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">setLog</span><span class="p">()</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">createMenu</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">finishOpen</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c</span>
    <span class="c">#@+node:ekr.20120223062418.10405: *6* LM.createMenu</span></div>
<div class="viewcode-block" id="LoadManager.createMenu"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.createMenu">[docs]</a>    <span class="k">def</span> <span class="nf">createMenu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">fn</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="c"># lm = self</span>

        <span class="c"># Create the menu as late as possible so it can use user commands.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&quot;menu1&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">):</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">createMenuBar</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">recentFilesManager</span><span class="o">.</span><span class="n">updateRecentFiles</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&quot;menu2&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&quot;after-create-leo-frame&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&quot;after-create-leo-frame2&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>

            <span class="c"># Fix bug 844953: tell Unity which menu to use.</span>
            <span class="n">c</span><span class="o">.</span><span class="n">enableMenuBar</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20120223062418.10406: *6* LM.findOpenFile</span></div>
<div class="viewcode-block" id="LoadManager.findOpenFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.findOpenFile">[docs]</a>    <span class="k">def</span> <span class="nf">findOpenFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>

        <span class="c"># lm = self</span>

        <span class="k">def</span> <span class="nf">munge</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_normpath</span><span class="p">(</span><span class="n">name</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">windowList</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">c</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_realpath</span><span class="p">(</span><span class="n">munge</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span> <span class="o">==</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_realpath</span><span class="p">(</span><span class="n">munge</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">)):</span>
                <span class="n">frame</span><span class="o">.</span><span class="n">bringToFront</span><span class="p">()</span>
                <span class="n">c</span><span class="o">.</span><span class="n">setLog</span><span class="p">()</span>
                <span class="c"># 2011/11/21: selecting the new tab ensures focus is set.</span>
                <span class="n">master</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">top</span><span class="p">,</span><span class="s">&#39;leo_master&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">frame</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">leo_master</span>
                <span class="k">if</span> <span class="n">master</span><span class="p">:</span> <span class="c"># frame.top.leo_master is a TabbedTopLevel.</span>
                    <span class="n">master</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>
                <span class="n">c</span><span class="o">.</span><span class="n">outerUpdate</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">c</span>

        <span class="k">return</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20120223062418.10407: *6* LM.finishOpen</span></div>
<div class="viewcode-block" id="LoadManager.finishOpen"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.finishOpen">[docs]</a>    <span class="k">def</span> <span class="nf">finishOpen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>

        <span class="c"># lm = self</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">k</span>
        <span class="k">assert</span> <span class="n">k</span>

        <span class="c"># New in Leo 4.6: provide an official way for very late initialization.</span>
        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">initAfterLoad</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">initAfterLoad</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>

        <span class="c"># chapterController.finishCreate must be called after the first real redraw</span>
        <span class="c"># because it requires a valid value for c.rootPosition().</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">chapterController</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">chapterController</span><span class="o">.</span><span class="n">finishCreate</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">k</span><span class="p">:</span> <span class="n">k</span><span class="o">.</span><span class="n">setDefaultInputState</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">initialFocusHelper</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">k</span><span class="p">:</span> <span class="n">k</span><span class="o">.</span><span class="n">showStateAndMode</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">initCompleteHint</span><span class="p">()</span>

    <span class="c">#@+node:ekr.20120223062418.10408: *6* LM.initWrapperLeoFile</span></div>
<div class="viewcode-block" id="LoadManager.initWrapperLeoFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.initWrapperLeoFile">[docs]</a>    <span class="k">def</span> <span class="nf">initWrapperLeoFile</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Create an empty file if the external fn is empty.</span>

<span class="sd">        Otherwise, create an @edit or @file node for the external file.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c"># lm = self</span>

        <span class="c"># Use the config params to set the size and location of the window.</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">setInitialWindowGeometry</span><span class="p">()</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">deiconify</span><span class="p">()</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">lift</span><span class="p">()</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">resizePanesToRatio</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">ratio</span><span class="p">,</span><span class="n">frame</span><span class="o">.</span><span class="n">secondary_ratio</span><span class="p">)</span>
            <span class="c"># Resize the _new_ frame.</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span>
            <span class="c"># Create an empty @edit node unless fn is an .leo file.</span>
            <span class="n">p</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="k">if</span> <span class="n">fn</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.leo&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s">&#39;@edit </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">fn</span>
            <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">c</span><span class="o">.</span><span class="n">looksLikeDerivedFile</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="c"># 2011/10/10: Create an @file node.</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">importCommands</span><span class="o">.</span><span class="n">importDerivedFiles</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">(),</span>
                <span class="n">paths</span><span class="o">=</span><span class="p">[</span><span class="n">fn</span><span class="p">],</span><span class="n">command</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span> <span class="c"># Not undoable.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Create an @edit node.</span>
            <span class="n">s</span><span class="p">,</span><span class="n">e</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">readFileIntoString</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">setHeadString</span><span class="p">(</span><span class="s">&#39;@edit </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">setBodyString</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="c"># chapterController.finishCreate must be called after the first real redraw</span>
        <span class="c"># because it requires a valid value for c.rootPosition().</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getBool</span><span class="p">(</span><span class="s">&#39;use_chapters&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">chapterController</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">chapterController</span><span class="o">.</span><span class="n">finishCreate</span><span class="p">()</span>

        <span class="n">frame</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="c"># Mark the outline clean.</span>
            <span class="c"># This makes it easy to open non-Leo files for quick study.</span>
        <span class="k">return</span> <span class="n">c</span>
    <span class="c">#@+node:ekr.20120223062418.10419: *6* LM.isLeoFile &amp; LM.isZippedFile</span></div>
<div class="viewcode-block" id="LoadManager.isLeoFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.isLeoFile">[docs]</a>    <span class="k">def</span> <span class="nf">isLeoFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">fn</span> <span class="ow">and</span> <span class="p">(</span><span class="n">zipfile</span><span class="o">.</span><span class="n">is_zipfile</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="ow">or</span> <span class="n">fn</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.leo&#39;</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="LoadManager.isZippedFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.isZippedFile">[docs]</a>    <span class="k">def</span> <span class="nf">isZippedFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">fn</span> <span class="ow">and</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">is_zipfile</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20120224161905.10030: *6* LM.openLeoOrZipFile</span></div>
<div class="viewcode-block" id="LoadManager.openLeoOrZipFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.openLeoOrZipFile">[docs]</a>    <span class="k">def</span> <span class="nf">openLeoOrZipFile</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>

        <span class="n">lm</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">zipped</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">isZippedFile</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lm</span><span class="o">.</span><span class="n">isLeoFile</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">zipped</span><span class="p">:</span>
                <span class="n">theFile</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">openZipFile</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">theFile</span> <span class="o">=</span> <span class="n">lm</span><span class="o">.</span><span class="n">openLeoFile</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">theFile</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">return</span> <span class="n">theFile</span>
    <span class="c">#@+node:ekr.20120223062418.10416: *6* LM.openLeoFile</span></div>
<div class="viewcode-block" id="LoadManager.openLeoFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.openLeoFile">[docs]</a>    <span class="k">def</span> <span class="nf">openLeoFile</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>

        <span class="c"># lm = self</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">theFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="s">&#39;rb&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">theFile</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="c"># Do not use string + here: it will fail for non-ascii strings!</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;can not open:&quot;</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20120223062418.10410: *6* LM.openZipFile</span></div>
<div class="viewcode-block" id="LoadManager.openZipFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.openZipFile">[docs]</a>    <span class="k">def</span> <span class="nf">openZipFile</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>

        <span class="c"># lm = self</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">theFile</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">theFile</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>

            <span class="c"># Read the file into an StringIO file.</span>
            <span class="n">aList</span> <span class="o">=</span> <span class="n">theFile</span><span class="o">.</span><span class="n">namelist</span><span class="p">()</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">aList</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">aList</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">aList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">theFile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span> <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">ue</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="c"># Do not use string + here: it will fail for non-ascii strings!</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;can not open:&quot;</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20120223062418.10412: *6* LM.readOpenedLeoFile</span></div>
<div class="viewcode-block" id="LoadManager.readOpenedLeoFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LoadManager.readOpenedLeoFile">[docs]</a>    <span class="k">def</span> <span class="nf">readOpenedLeoFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">gui</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span><span class="n">readAtFileNodesFlag</span><span class="p">,</span><span class="n">theFile</span><span class="p">):</span>

        <span class="c"># New in Leo 4.10: The open1 event does not allow an override of the init logic.</span>
        <span class="k">assert</span> <span class="n">theFile</span>
        <span class="c"># lm = self</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fileCommands</span><span class="o">.</span><span class="n">openLeoFile</span><span class="p">(</span><span class="n">theFile</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span>
            <span class="n">readAtFileNodesFlag</span><span class="o">=</span><span class="n">readAtFileNodesFlag</span><span class="p">)</span>
                <span class="c"># closes file.</span>
        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">openDirectory</span><span class="p">:</span>
                <span class="n">theDir</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">os_path_finalize</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">os_path_dirname</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>
                <span class="n">c</span><span class="o">.</span><span class="n">openDirectory</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">openDirectory</span> <span class="o">=</span> <span class="n">theDir</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">closeLeoWindow</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ok</span>
    <span class="c">#@-others</span>

<span class="c">#@+node:ekr.20120211121736.10831: ** class LogManager</span></div></div>
<div class="viewcode-block" id="LogManager"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LogManager">[docs]</a><span class="k">class</span> <span class="nc">LogManager</span><span class="p">:</span>

    <span class="sd">&#39;&#39;&#39;A class to handle the global log, and especially</span>
<span class="sd">    switching the log from commander to commander.&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="p">(</span><span class="bp">False</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">trace_startup</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;LogManager.__init__&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="bp">None</span>             <span class="c"># The LeoFrame containing the present log.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logInited</span> <span class="o">=</span> <span class="bp">False</span>      <span class="c"># False: all log message go to logWaiting list.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logIsLocked</span> <span class="o">=</span> <span class="bp">False</span>    <span class="c"># True: no changes to log are allowed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logWaiting</span> <span class="o">=</span> <span class="p">[]</span>        <span class="c"># List of messages waiting to go to a log.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">printWaiting</span> <span class="o">=</span> <span class="p">[]</span>      <span class="c"># Queue of messages to be sent to the printer.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signon_printed</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># True: the global signon has been printed.</span>

    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20120211121736.10834: *3* LogM.setLog, lockLog, unlocklog</span>
<div class="viewcode-block" id="LogManager.setLog"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LogManager.setLog">[docs]</a>    <span class="k">def</span> <span class="nf">setLog</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">log</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;set the frame to which log messages will go&quot;&quot;&quot;</span>

        <span class="c"># print(&quot;app.setLog:&quot;,log,g.callers())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">logIsLocked</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span>
</div>
<div class="viewcode-block" id="LogManager.lockLog"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LogManager.lockLog">[docs]</a>    <span class="k">def</span> <span class="nf">lockLog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Disable changes to the log&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logIsLocked</span> <span class="o">=</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="LogManager.unlockLog"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LogManager.unlockLog">[docs]</a>    <span class="k">def</span> <span class="nf">unlockLog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Enable changes to the log&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logIsLocked</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20120211121736.10836: *3* LogM.writeWaitingLog</span></div>
<div class="viewcode-block" id="LogManager.writeWaitingLog"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.LogManager.writeWaitingLog">[docs]</a>    <span class="k">def</span> <span class="nf">writeWaitingLog</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">lm</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
            <span class="c"># Do not call g.es, g.es_print, g.pr or g.trace here!</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;** writeWaitingLog&#39;</span><span class="p">,</span><span class="s">&#39;silent&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">silentMode</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">())</span>
            <span class="c"># print(&#39;writeWaitingLog&#39;,g.callers())</span>
            <span class="c"># import sys ; print(&#39;writeWaitingLog: argv&#39;,sys.argv)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">printWaiting</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">logWaiting</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">setLog</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span> <span class="c"># Prepare to requeue for other commanders.</span>
            <span class="k">return</span>

        <span class="n">table</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">&#39;Leo Log Window&#39;</span><span class="p">,</span><span class="s">&#39;red&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">signon</span><span class="p">,</span><span class="s">&#39;black&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">signon2</span><span class="p">,</span><span class="s">&#39;black&#39;</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="n">table</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>

        <span class="n">c</span><span class="o">.</span><span class="n">setLog</span><span class="p">()</span> <span class="c"># 2010/10/20</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logInited</span> <span class="o">=</span> <span class="bp">True</span> <span class="c"># Prevent recursive call.</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">lm</span><span class="o">.</span><span class="n">signon_printed</span><span class="p">:</span>
            <span class="n">lm</span><span class="o">.</span><span class="n">signon_printed</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">silentMode</span><span class="p">:</span> <span class="c"># 2011/11/02:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;** isPython3: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">enableDB</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;** caching disabled&#39;</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">signon</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">signon2</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">silentMode</span><span class="p">:</span> <span class="c"># 2011/11/02:</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">lm</span><span class="o">.</span><span class="n">printWaiting</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">printWaiting</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">silentMode</span><span class="p">:</span>  <span class="c"># 2011/11/02:</span>
            <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">color</span> <span class="ow">in</span> <span class="n">table</span><span class="p">:</span>
                <span class="n">lm</span><span class="o">.</span><span class="n">logWaiting</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,(</span><span class="n">s</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="n">color</span><span class="p">),)</span>
            <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">color</span> <span class="ow">in</span> <span class="n">lm</span><span class="o">.</span><span class="n">logWaiting</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span><span class="n">newline</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="c"># The caller must write the newlines.</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">logWaiting</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># Essential when opening multiple files...</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">setLog</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span> 
    <span class="c">#@-others</span>
<span class="c">#@+node:ekr.20120223062418.10420: ** class PreviousSettings</span></div></div>
<div class="viewcode-block" id="PreviousSettings"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.PreviousSettings">[docs]</a><span class="k">class</span> <span class="nc">PreviousSettings</span><span class="p">:</span>

    <span class="sd">&#39;&#39;&#39;A class holding the settings and shortcuts dictionaries</span>
<span class="sd">    that are computed in the first pass when loading local</span>
<span class="sd">    files and passed to the second pass.&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">settingsDict</span><span class="p">,</span><span class="n">shortcutsDict</span><span class="p">):</span>

        <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isTypedDict</span><span class="p">(</span><span class="n">settingsDict</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isTypedDictOfLists</span><span class="p">(</span><span class="n">shortcutsDict</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">settingsDict</span> <span class="o">=</span> <span class="n">settingsDict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shortcutsDict</span> <span class="o">=</span> <span class="n">shortcutsDict</span>

    <span class="k">def</span> <span class="nf">__repr__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="s">&#39;&lt;PreviousSettings</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">settingsDict</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">shortcutsDict</span><span class="p">)</span>

    <span class="n">__str__</span> <span class="o">=</span> <span class="n">__repr__</span>
<span class="c">#@+node:ekr.20120225072226.10283: ** class RecentFilesManager</span></div>
<div class="viewcode-block" id="RecentFilesManager"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.RecentFilesManager">[docs]</a><span class="k">class</span> <span class="nc">RecentFilesManager</span><span class="p">:</span>

    <span class="sd">&#39;&#39;&#39;A class to manipulate leoRecentFiles.txt.&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">groupedMenus</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c"># Set in rf.createRecentFilesMenuItems.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recentFiles</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c"># List of g.Bunches describing .leoRecentFiles.txt files.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recentFileMessageWritten</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="c"># To suppress all but the first message.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_recent_files_as_needed</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="c"># Will be set later.</span>

    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20041201080436: *3* rf.appendToRecentFiles</span>
<div class="viewcode-block" id="RecentFilesManager.appendToRecentFiles"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.RecentFilesManager.appendToRecentFiles">[docs]</a>    <span class="k">def</span> <span class="nf">appendToRecentFiles</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">files</span><span class="p">):</span>

        <span class="n">rf</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">theFile</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">theFile</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">munge</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_normpath</span><span class="p">(</span><span class="n">name</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="c"># Remove all variants of name.</span>
            <span class="k">for</span> <span class="n">name2</span> <span class="ow">in</span> <span class="n">rf</span><span class="o">.</span><span class="n">recentFiles</span><span class="p">[:]:</span>
                <span class="k">if</span> <span class="n">munge</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="n">munge</span><span class="p">(</span><span class="n">name2</span><span class="p">):</span>
                    <span class="n">rf</span><span class="o">.</span><span class="n">recentFiles</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">name2</span><span class="p">)</span>

            <span class="n">rf</span><span class="o">.</span><span class="n">recentFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20120225072226.10289: *3* rf.cleanRecentFiles</span></div>
<div class="viewcode-block" id="RecentFilesManager.cleanRecentFiles"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.RecentFilesManager.cleanRecentFiles">[docs]</a>    <span class="k">def</span> <span class="nf">cleanRecentFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Removed items from the recent files list that are no longer valid.&#39;&#39;&#39;</span>

        <span class="n">rf</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">dat</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getData</span><span class="p">(</span><span class="s">&#39;path-demangle&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dat</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;No @data path-demangle setting&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">changes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">replace</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">dat</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;REPLACE: &#39;</span><span class="p">):</span>
                <span class="n">replace</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;WITH:&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">replace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">with_</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">changes</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">replace</span><span class="p">,</span> <span class="n">with_</span><span class="p">))</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> -&gt; </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">changes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">orig</span> <span class="o">=</span> <span class="p">[</span><span class="n">z</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">rf</span><span class="o">.</span><span class="n">recentFiles</span> <span class="k">if</span> <span class="n">z</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)]</span>

        <span class="n">rf</span><span class="o">.</span><span class="n">recentFiles</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">orig</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">for</span> <span class="n">change</span> <span class="ow">in</span> <span class="n">changes</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="o">*</span><span class="n">change</span><span class="p">)</span>
            <span class="n">rf</span><span class="o">.</span><span class="n">updateRecentFiles</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

        <span class="n">rf</span><span class="o">.</span><span class="n">writeRecentFilesFile</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="c"># Force the write message.</span>
    <span class="c">#@+node:ekr.20120225072226.10297: *3* rf.clearRecentFiles</span></div>
<div class="viewcode-block" id="RecentFilesManager.clearRecentFiles"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.RecentFilesManager.clearRecentFiles">[docs]</a>    <span class="k">def</span> <span class="nf">clearRecentFiles</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Clear the recent files list, then add the present file.&quot;&quot;&quot;</span>

        <span class="n">rf</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">u</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">undoer</span> <span class="p">;</span> <span class="n">menu</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">menu</span>

        <span class="n">bunch</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">beforeClearRecentFiles</span><span class="p">()</span>

        <span class="n">recentFilesMenu</span> <span class="o">=</span> <span class="n">menu</span><span class="o">.</span><span class="n">getMenu</span><span class="p">(</span><span class="s">&quot;Recent Files...&quot;</span><span class="p">)</span>
        <span class="n">menu</span><span class="o">.</span><span class="n">deleteRecentFilesMenuItems</span><span class="p">(</span><span class="n">recentFilesMenu</span><span class="p">)</span>

        <span class="n">rf</span><span class="o">.</span><span class="n">recentFiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">fileName</span><span class="p">()]</span>
        <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">windowList</span><span class="p">:</span>
            <span class="n">rf</span><span class="o">.</span><span class="n">createRecentFilesMenuItems</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>

        <span class="n">u</span><span class="o">.</span><span class="n">afterClearRecentFiles</span><span class="p">(</span><span class="n">bunch</span><span class="p">)</span>

        <span class="c"># Write the file immediately.</span>
        <span class="n">rf</span><span class="o">.</span><span class="n">writeRecentFilesFile</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="c"># Force the write message.</span>
    <span class="c">#@+node:ekr.20120225072226.10301: *3* rf.createRecentFilesMenuItems</span></div>
<div class="viewcode-block" id="RecentFilesManager.createRecentFilesMenuItems"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.RecentFilesManager.createRecentFilesMenuItems">[docs]</a>    <span class="k">def</span> <span class="nf">createRecentFilesMenuItems</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>

        <span class="n">rf</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">menu</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">menu</span>

        <span class="n">recentFilesMenu</span> <span class="o">=</span> <span class="n">menu</span><span class="o">.</span><span class="n">getMenu</span><span class="p">(</span><span class="s">&quot;Recent Files...&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">recentFilesMenu</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;Recent Files Menu does not exist&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>
            <span class="k">return</span>

        <span class="c"># Delete all previous entries.</span>
        <span class="n">menu</span><span class="o">.</span><span class="n">deleteRecentFilesMenuItems</span><span class="p">(</span><span class="n">recentFilesMenu</span><span class="p">)</span>

        <span class="c"># Create the permanent (static) menu entries.</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">rf</span><span class="o">.</span><span class="n">getRecentFilesTable</span><span class="p">()</span>
        <span class="n">menu</span><span class="o">.</span><span class="n">createMenuEntries</span><span class="p">(</span><span class="n">recentFilesMenu</span><span class="p">,</span><span class="n">table</span><span class="p">)</span>

        <span class="c"># Create all the other entries (a maximum of 36).</span>
        <span class="n">accel_ch</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="c"># Not a unicode problem.</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">accel_ch</span><span class="p">)</span>

        <span class="c"># see if we&#39;re grouping when files occur in more than one place</span>
        <span class="n">rf_group</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getBool</span><span class="p">(</span><span class="s">&quot;recent_files_group&quot;</span><span class="p">)</span>
        <span class="n">rf_always</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getBool</span><span class="p">(</span><span class="s">&quot;recent_files_group_always&quot;</span><span class="p">)</span>
        <span class="n">groupedEntries</span> <span class="o">=</span> <span class="n">rf_group</span> <span class="ow">or</span> <span class="n">rf_always</span>

        <span class="k">if</span> <span class="n">groupedEntries</span><span class="p">:</span>  <span class="c"># if so, make dict of groups</span>
            <span class="n">dirCount</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">fileName</span> <span class="ow">in</span> <span class="n">rf</span><span class="o">.</span><span class="n">getRecentFiles</span><span class="p">()[:</span><span class="n">n</span><span class="p">]:</span>
                <span class="n">dirName</span><span class="p">,</span> <span class="n">baseName</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_split</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">baseName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dirCount</span><span class="p">:</span>
                    <span class="n">dirCount</span><span class="p">[</span><span class="n">baseName</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;dirs&#39;</span><span class="p">:[],</span> <span class="s">&#39;entry&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>
                <span class="n">dirCount</span><span class="p">[</span><span class="n">baseName</span><span class="p">][</span><span class="s">&#39;dirs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dirName</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">rf</span><span class="o">.</span><span class="n">getRecentFiles</span><span class="p">()[:</span><span class="n">n</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c"># happens with empty list/new file</span>

            <span class="k">def</span> <span class="nf">recentFilesCallback</span> <span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">):</span>
                <span class="n">c</span><span class="o">.</span><span class="n">openRecentFile</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">groupedEntries</span><span class="p">:</span>
                <span class="n">dirName</span><span class="p">,</span> <span class="n">baseName</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_split</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

                <span class="n">entry</span> <span class="o">=</span> <span class="n">dirCount</span><span class="p">[</span><span class="n">baseName</span><span class="p">]</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s">&#39;dirs&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">rf_always</span><span class="p">:</span>  <span class="c"># sub menus</span>
                    <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s">&#39;entry&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">entry</span><span class="p">[</span><span class="s">&#39;entry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">menu</span><span class="o">.</span><span class="n">createNewMenu</span><span class="p">(</span><span class="n">baseName</span><span class="p">,</span> <span class="s">&quot;Recent Files...&quot;</span><span class="p">)</span>
                        <span class="c"># acts as a flag for the need to create the menu</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="n">menu</span><span class="o">.</span><span class="n">getMenu</span><span class="p">(</span><span class="n">baseName</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="n">dirName</span><span class="p">,</span>
                        <span class="n">command</span><span class="o">=</span><span class="n">recentFilesCallback</span><span class="p">,</span> <span class="n">underline</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c"># single occurence, no submenu</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="n">recentFilesMenu</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">baseName</span><span class="p">,</span>
                        <span class="n">command</span><span class="o">=</span><span class="n">recentFilesCallback</span><span class="p">,</span><span class="n">underline</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>  <span class="c"># original behavior</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">accel_ch</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">g</span><span class="o">.</span><span class="n">computeWindowTitle</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
                <span class="n">c</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="n">recentFilesMenu</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                    <span class="n">command</span><span class="o">=</span><span class="n">recentFilesCallback</span><span class="p">,</span><span class="n">underline</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">groupedEntries</span><span class="p">:</span>  <span class="c"># store so we can delete them later</span>
            <span class="n">rf</span><span class="o">.</span><span class="n">groupedMenus</span> <span class="o">=</span> <span class="p">[</span><span class="n">z</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">dirCount</span>
                <span class="k">if</span> <span class="n">dirCount</span><span class="p">[</span><span class="n">z</span><span class="p">][</span><span class="s">&#39;entry&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">]</span>
    <span class="c">#@+node:ekr.20120225072226.10286: *3* rf.getRecentFiles</span></div>
<div class="viewcode-block" id="RecentFilesManager.getRecentFiles"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.RecentFilesManager.getRecentFiles">[docs]</a>    <span class="k">def</span> <span class="nf">getRecentFiles</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">recentFiles</span>
    <span class="c">#@+node:ekr.20120225072226.10304: *3* rf.getRecentFilesTable</span></div>
<div class="viewcode-block" id="RecentFilesManager.getRecentFilesTable"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.RecentFilesManager.getRecentFilesTable">[docs]</a>    <span class="k">def</span> <span class="nf">getRecentFilesTable</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="s">&quot;*clear-recent-files&quot;</span><span class="p">,</span>
            <span class="s">&quot;*clean-recent-files&quot;</span><span class="p">,</span>
            <span class="s">&quot;*sort-recent-files&quot;</span><span class="p">,</span>
            <span class="c"># (&quot;-&quot;,None,None),</span>
        <span class="p">)</span>
    <span class="c">#@+node:ekr.20070224115832: *3* rf.readRecentFiles &amp; helpers</span></div>
<div class="viewcode-block" id="RecentFilesManager.readRecentFiles"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.RecentFilesManager.readRecentFiles">[docs]</a>    <span class="k">def</span> <span class="nf">readRecentFiles</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">localConfigFile</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Read all .leoRecentFiles.txt files.&#39;&#39;&#39;</span>

        <span class="c"># The order of files in this list affects the order of the recent files list.</span>
        <span class="n">rf</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="p">[]</span> 
        <span class="n">localConfigPath</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_dirname</span><span class="p">(</span><span class="n">localConfigFile</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">homeLeoDir</span><span class="p">,</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">globalConfigDir</span><span class="p">,</span>
            <span class="n">localConfigPath</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_realpath</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">path</span> <span class="ow">and</span> <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="n">rf</span><span class="o">.</span><span class="n">readRecentFilesFile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ok</span><span class="p">:</span> <span class="n">seen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">seen</span> <span class="ow">and</span> <span class="n">rf</span><span class="o">.</span><span class="n">write_recent_files_as_needed</span><span class="p">:</span>
            <span class="n">rf</span><span class="o">.</span><span class="n">createRecentFiles</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20061010121944: *4* rf.createRecentFiles</span></div>
<div class="viewcode-block" id="RecentFilesManager.createRecentFiles"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.RecentFilesManager.createRecentFiles">[docs]</a>    <span class="k">def</span> <span class="nf">createRecentFiles</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Trye to reate .leoRecentFiles.txt in</span>
<span class="sd">        - the users home directory first,</span>
<span class="sd">        - Leo&#39;s config directory second.&#39;&#39;&#39;</span>

        <span class="k">for</span> <span class="n">theDir</span> <span class="ow">in</span> <span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">homeLeoDir</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">globalConfigDir</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">theDir</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fn</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_join</span><span class="p">(</span><span class="n">theDir</span><span class="p">,</span><span class="s">&#39;.leoRecentFiles.txt&#39;</span><span class="p">)</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">red</span><span class="p">(</span><span class="s">&#39;created&#39;</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;can not create&#39;</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20050424115658: *4* rf.readRecentFilesFile</span></div>
<div class="viewcode-block" id="RecentFilesManager.readRecentFilesFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.RecentFilesManager.readRecentFilesFile">[docs]</a>    <span class="k">def</span> <span class="nf">readRecentFilesFile</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">path</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">rf</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">fileName</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s">&#39;.leoRecentFiles.txt&#39;</span><span class="p">)</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;can not open&#39;</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>

            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">((</span><span class="s">&#39;reading </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">fileName</span><span class="p">))</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">lines</span> <span class="ow">and</span> <span class="n">rf</span><span class="o">.</span><span class="n">sanitize</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">==</span><span class="s">&#39;readonly&#39;</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">if</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">toUnicode</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">os_path_normpath</span><span class="p">(</span><span class="n">line</span><span class="p">))</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
                <span class="n">rf</span><span class="o">.</span><span class="n">appendToRecentFiles</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ok</span>
    <span class="c">#@+node:ekr.20120225072226.10285: *3* rf.sanitize</span></div>
<div class="viewcode-block" id="RecentFilesManager.sanitize"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.RecentFilesManager.sanitize">[docs]</a>    <span class="k">def</span> <span class="nf">sanitize</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return a sanitized file name.&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">,</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">name</span> <span class="ow">or</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20120215072959.12478: *3* rf.setRecentFiles</span></div>
<div class="viewcode-block" id="RecentFilesManager.setRecentFiles"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.RecentFilesManager.setRecentFiles">[docs]</a>    <span class="k">def</span> <span class="nf">setRecentFiles</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">files</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Update the recent files list.&#39;&#39;&#39;</span>

        <span class="n">rf</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">rf</span><span class="o">.</span><span class="n">appendToRecentFiles</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20120225072226.10293: *3* rf.sortRecentFiles</span></div>
<div class="viewcode-block" id="RecentFilesManager.sortRecentFiles"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.RecentFilesManager.sortRecentFiles">[docs]</a>    <span class="k">def</span> <span class="nf">sortRecentFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Sort the recent files list.&#39;&#39;&#39;</span>

        <span class="n">rf</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">aList</span> <span class="o">=</span> <span class="n">rf</span><span class="o">.</span><span class="n">recentFiles</span>
        <span class="n">aList</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_basename</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> 
        <span class="n">aList</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>

        <span class="n">rf</span><span class="o">.</span><span class="n">recentFiles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
            <span class="n">rf</span><span class="o">.</span><span class="n">updateRecentFiles</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

        <span class="n">rf</span><span class="o">.</span><span class="n">writeRecentFilesFile</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="c"># Force the write message.</span>
    <span class="c">#@+node:ekr.20031218072017.2083: *3* rf.updateRecentFiles</span></div>
<div class="viewcode-block" id="RecentFilesManager.updateRecentFiles"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.RecentFilesManager.updateRecentFiles">[docs]</a>    <span class="k">def</span> <span class="nf">updateRecentFiles</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Create the RecentFiles menu.  May be called with Null fileName.&quot;&quot;&quot;</span>

        <span class="n">rf</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span> <span class="k">return</span>

        <span class="k">def</span> <span class="nf">munge</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize</span><span class="p">(</span><span class="n">name</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">munge2</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadDir</span><span class="p">,</span><span class="n">name</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span><span class="p">)</span>

        <span class="c"># Update the recent files list in all windows.</span>
        <span class="k">if</span> <span class="n">fileName</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">windowList</span><span class="p">:</span>
                <span class="c"># Remove all versions of the file name.</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">rf</span><span class="o">.</span><span class="n">recentFiles</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">munge</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span> <span class="o">==</span> <span class="n">munge</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">or</span>
                        <span class="n">munge2</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span> <span class="o">==</span> <span class="n">munge2</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="p">):</span>
                        <span class="n">rf</span><span class="o">.</span><span class="n">recentFiles</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">rf</span><span class="o">.</span><span class="n">recentFiles</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>
                <span class="c"># Recreate the Recent Files menu.</span>
                <span class="n">rf</span><span class="o">.</span><span class="n">createRecentFilesMenuItems</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">windowList</span><span class="p">:</span>
                <span class="n">rf</span><span class="o">.</span><span class="n">createRecentFilesMenuItems</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050424114937.2: *3* rf.writeRecentFilesFile &amp; helper</span></div>
<div class="viewcode-block" id="RecentFilesManager.writeRecentFilesFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.RecentFilesManager.writeRecentFilesFile">[docs]</a>    <span class="k">def</span> <span class="nf">writeRecentFilesFile</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">force</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Write the appropriate .leoRecentFiles.txt file.</span>

<span class="sd">        Write a message if force is True, or if it hasn&#39;t been written yet.&#39;&#39;&#39;</span>

        <span class="n">tag</span> <span class="o">=</span> <span class="s">&#39;.leoRecentFiles.txt&#39;</span>
        <span class="n">rf</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">localFileName</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fileName</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">localFileName</span><span class="p">:</span>
            <span class="n">localPath</span><span class="p">,</span><span class="n">junk</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_split</span><span class="p">(</span><span class="n">localFileName</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">localPath</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">written</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="p">(</span><span class="n">localPath</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">globalConfigDir</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">homeLeoDir</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
                <span class="n">fileName</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">tag</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fileName</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                    <span class="n">seen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fileName</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                    <span class="n">ok</span> <span class="o">=</span> <span class="n">rf</span><span class="o">.</span><span class="n">writeRecentFilesFileHelper</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">force</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">rf</span><span class="o">.</span><span class="n">recentFileMessageWritten</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;wrote recent file: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">fileName</span><span class="p">)</span>
                            <span class="n">written</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;failed to write recent file: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fileName</span><span class="p">))</span>
                    <span class="c"># Bug fix: Leo 4.4.6: write *all* recent files.</span>

        <span class="k">if</span> <span class="n">written</span><span class="p">:</span>
            <span class="n">rf</span><span class="o">.</span><span class="n">recentFileMessageWritten</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Attempt to create .leoRecentFiles.txt in the user&#39;s home directory.</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">homeLeoDir</span><span class="p">:</span>
                <span class="n">fileName</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">homeLeoDir</span><span class="p">,</span><span class="n">tag</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">fileName</span><span class="p">):</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">red</span><span class="p">(</span><span class="s">&#39;creating: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fileName</span><span class="p">))</span>
                <span class="n">rf</span><span class="o">.</span><span class="n">writeRecentFilesFileHelper</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>


    <span class="c">#@+node:ekr.20050424131051: *4* rf.writeRecentFilesFileHelper</span></div>
<div class="viewcode-block" id="RecentFilesManager.writeRecentFilesFileHelper"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoApp.RecentFilesManager.writeRecentFilesFileHelper">[docs]</a>    <span class="k">def</span> <span class="nf">writeRecentFilesFileHelper</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="p">):</span>

        <span class="c"># g.trace(g.toUnicode(fileName))</span>

        <span class="c"># Don&#39;t update the file if it begins with read-only.</span>
        <span class="n">rf</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">theFile</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">theFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">theFile</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">lines</span> <span class="ow">and</span> <span class="n">rf</span><span class="o">.</span><span class="n">sanitize</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">==</span><span class="s">&#39;readonly&#39;</span><span class="p">:</span>
                <span class="c"># g.trace(&#39;read-only: %s&#39; %fileName)</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="c"># The user may have erased a file.  Not an error.</span>
            <span class="k">if</span> <span class="n">theFile</span><span class="p">:</span> <span class="n">theFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">theFile</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
                <span class="n">theFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">theFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rf</span><span class="o">.</span><span class="n">recentFiles</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rf</span><span class="o">.</span><span class="n">recentFiles</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">reportErrors</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">theFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">1</span><span class="p">:</span> <span class="c"># The user may have erased a file.  Not an error.</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;error writing&#39;</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
                <span class="k">return</span> <span class="bp">False</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;unexpected exception writing&#39;</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span> <span class="k">raise</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">theFile</span><span class="p">:</span>
            <span class="n">theFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="c">#@-others</span>
<span class="c">#@-others</span>
<span class="c">#@-leo</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Leo API 4.11dev documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Ed K. Ream.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
  </body>
</html>