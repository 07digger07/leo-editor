<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>leo.core.leoCache &mdash; Leo API 4.11dev documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '4.11dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Leo API 4.11dev documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Leo API 4.11dev documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for leo.core.leoCache</h1><div class="highlight"><pre>
<span class="c">#@+leo-ver=5-thin</span>
<span class="c">#@+node:ekr.20100208065621.5894: * @file leoCache.py</span>
<span class="sd">&#39;&#39;&#39;A module encapsulating Leo&#39;s file caching&#39;&#39;&#39;</span>

<span class="c">#@+&lt;&lt; imports &gt;&gt;</span>
<span class="c">#@+node:ekr.20100208223942.10436: ** &lt;&lt; imports &gt;&gt; (leoCache)</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">isPython3</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">leo.core.leoGlobals</span> <span class="kn">as</span> <span class="nn">g</span>
<span class="kn">import</span> <span class="nn">leo.core.leoNodes</span> <span class="kn">as</span> <span class="nn">leoNodes</span>

<span class="k">if</span> <span class="n">isPython3</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pickle</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">cPickle</span> <span class="kn">as</span> <span class="nn">pickle</span>

<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">stat</span>
<span class="c"># import time</span>
<span class="kn">import</span> <span class="nn">zlib</span>

<span class="c"># try:</span>
    <span class="c"># import marshal</span>
<span class="c"># except ImportError:</span>
    <span class="c"># marshal = None</span>
<span class="c">#@-&lt;&lt; imports &gt;&gt;</span>

<span class="c"># Abbreviations used throughout.</span>
<span class="n">abspath</span>     <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_abspath</span>
<span class="n">basename</span>    <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_basename</span>
<span class="n">expanduser</span>  <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_expanduser</span>
<span class="n">isdir</span>       <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_isdir</span>
<span class="n">isfile</span>      <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_isfile</span>
<span class="n">join</span>        <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_join</span>
<span class="n">normcase</span>    <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_normcase</span>
<span class="n">split</span>       <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_split</span>

<span class="c">#@+others</span>
<span class="c">#@+node:ekr.20100208062523.5885: ** class cacher</span>
<div class="viewcode-block" id="cacher"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCache.cacher">[docs]</a><span class="k">class</span> <span class="nc">cacher</span><span class="p">:</span>

    <span class="sd">&#39;&#39;&#39;A class that encapsulates all aspects of Leo&#39;s file caching.&#39;&#39;&#39;</span>

    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20100208082353.5919: *3*  Birth (cacher)</span>
    <span class="c">#@+node:ekr.20100208062523.5886: *4*  ctor (cacher)</span>
    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;cacher&#39;</span><span class="p">,</span><span class="s">&#39;c&#39;</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">c</span>

        <span class="c"># set by initFileDB and initGlobalDB...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c"># 2011/07/30</span>
            <span class="c"># When caching is enabled will be a PickleShareDB instance.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dbdirname</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># A string.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inited</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="c">#@+node:ekr.20100208082353.5918: *4* initFileDB</span>
<div class="viewcode-block" id="cacher.initFileDB"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCache.cacher.initFileDB">[docs]</a>    <span class="k">def</span> <span class="nf">initFileDB</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;inited&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">inited</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">fn</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">pth</span><span class="p">,</span> <span class="n">bname</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pth</span> <span class="ow">and</span> <span class="n">bname</span><span class="p">:</span> <span class="c">### and g.enableDB:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="c"># Required for Python 3.x.</span>

            <span class="c"># Important: this creates a top-level directory of the form x_y.</span>
            <span class="c"># x is a short file name, included for convenience.</span>
            <span class="c"># y is a key computed by the *full* path name fn.</span>
            <span class="c"># Thus, there will a separate top-level directory for every path.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dbdirname</span> <span class="o">=</span> <span class="n">dbdirname</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">homeLeoDir</span><span class="p">,</span><span class="s">&#39;db&#39;</span><span class="p">,</span>
                <span class="s">&#39;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bname</span><span class="p">,</span><span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">PickleShareDB</span><span class="p">(</span><span class="n">dbdirname</span><span class="p">)</span>
            <span class="c"># Fixes bug 670108.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inited</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;self.c.db&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100208082353.5920: *4* initGlobalDb</span></div>
<div class="viewcode-block" id="cacher.initGlobalDB"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCache.cacher.initGlobalDB">[docs]</a>    <span class="k">def</span> <span class="nf">initGlobalDB</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

        <span class="c"># New in Leo 4.10.1.</span>
        <span class="c"># We always create the global db, even if caching is disabled.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dbdirname</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">homeLeoDir</span> <span class="o">+</span> <span class="s">&quot;/db/global&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span> <span class="o">=</span> <span class="n">PickleShareDB</span><span class="p">(</span><span class="n">dbdirname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="n">dbdirname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inited</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">return</span> <span class="n">db</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span> <span class="c"># Use a plain dict as a dummy.</span>
    <span class="c">#@+node:ekr.20100210163813.5747: *4* save (cacher)</span></div>
<div class="viewcode-block" id="cacher.save"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCache.cacher.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span><span class="n">changeName</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">changeName</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">inited</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initFileDB</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100209160132.5759: *3* clear/AllCache(s) (cacher)</span></div>
<div class="viewcode-block" id="cacher.clearCache"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCache.cacher.clearCache">[docs]</a>    <span class="k">def</span> <span class="nf">clearCache</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">:</span>
            <span class="c"># 2011/07/30: Be careful about calling db.clear.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">clear</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span> <span class="c"># self.db is a Python dict.</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;unexpected exception&#39;</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="p">{}</span>
</div>
<div class="viewcode-block" id="cacher.clearAllCaches"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCache.cacher.clearAllCaches">[docs]</a>    <span class="k">def</span> <span class="nf">clearAllCaches</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># Clear the cachers *only* for all open windows.</span>
        <span class="c"># This is much safer than tryting to Kill all db&#39;s.</span>
        <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">windows</span><span class="p">():</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">c</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">cacher</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">cacher</span><span class="o">.</span><span class="n">clearCache</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20100208071151.5907: *3* fileKey</span>
    <span class="c"># was atFile._contentHashFile</span>
</div>
<div class="viewcode-block" id="cacher.fileKey"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCache.cacher.fileKey">[docs]</a>    <span class="k">def</span> <span class="nf">fileKey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">content</span><span class="p">,</span><span class="n">requireEncodedString</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Compute the hash of s (usually a headline) and content.</span>
<span class="sd">        s may be unicode, content must be bytes (or plain string in Python 2.x&#39;&#39;&#39;</span>

        <span class="n">m</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isUnicode</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isUnicode</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">requireEncodedString</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">internalError</span><span class="p">(</span><span class="s">&#39;content arg must be str/bytes&#39;</span><span class="p">)</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

        <span class="n">m</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&quot;fcache/&quot;</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20100208082353.5925: *3* Reading</span>
    <span class="c">#@+node:ekr.20100208071151.5910: *4* cacher.createOutlineFromCacheList &amp; helpers</span></div>
<div class="viewcode-block" id="cacher.createOutlineFromCacheList"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCache.cacher.createOutlineFromCacheList">[docs]</a>    <span class="k">def</span> <span class="nf">createOutlineFromCacheList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent_v</span><span class="p">,</span><span class="n">aList</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span><span class="n">top</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; Create outline structure from recursive aList</span>
<span class="sd">        built by makeCacheList.&quot;&quot;&quot;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">internalError</span><span class="p">(</span><span class="s">&#39;no c&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">top</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">cacheListFileName</span> <span class="o">=</span> <span class="n">fileName</span>

        <span class="n">h</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">gnx</span><span class="p">,</span><span class="n">children</span> <span class="o">=</span> <span class="n">aList</span>
        <span class="k">if</span> <span class="n">h</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">parent_v</span>
            <span class="n">v</span><span class="o">.</span><span class="n">_headString</span> <span class="o">=</span> <span class="n">h</span>    
            <span class="n">v</span><span class="o">.</span><span class="n">_bodyString</span> <span class="o">=</span> <span class="n">b</span>

        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
            <span class="n">h</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">gnx</span><span class="p">,</span><span class="n">grandChildren</span> <span class="o">=</span> <span class="n">z</span>
            <span class="n">isClone</span><span class="p">,</span><span class="n">child_v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fastAddLastChild</span><span class="p">(</span><span class="n">parent_v</span><span class="p">,</span><span class="n">gnx</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">isClone</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reportChangedClone</span><span class="p">(</span><span class="n">child_v</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">gnx</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">createOutlineFromCacheList</span><span class="p">(</span>
                    <span class="n">child_v</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span><span class="n">top</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100208071151.5911: *5* casher.fastAddLastChild</span>
    <span class="c"># Similar to createThinChild4</span></div>
<div class="viewcode-block" id="cacher.fastAddLastChild"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCache.cacher.fastAddLastChild">[docs]</a>    <span class="k">def</span> <span class="nf">fastAddLastChild</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent_v</span><span class="p">,</span><span class="n">gnxString</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create new vnode as last child of the receiver.</span>

<span class="sd">        If the gnx exists already, create a clone instead of new vnode.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">nodeIndices</span>
        <span class="n">gnxDict</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fileCommands</span><span class="o">.</span><span class="n">gnxDict</span>
        <span class="k">if</span> <span class="n">gnxString</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">v</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>                 <span class="n">v</span> <span class="o">=</span> <span class="n">gnxDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gnxString</span><span class="p">)</span>
        <span class="n">is_clone</span> <span class="o">=</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
            <span class="s">&#39;clone&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%-5s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">is_clone</span><span class="p">),</span>
            <span class="s">&#39;parent_v&#39;</span><span class="p">,</span><span class="n">parent_v</span><span class="p">,</span><span class="s">&#39;gnx&#39;</span><span class="p">,</span><span class="n">gnxString</span><span class="p">,</span><span class="s">&#39;v&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">is_clone</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">leoNodes</span><span class="o">.</span><span class="n">vnode</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">gnxString</span><span class="p">:</span>
                <span class="n">gnx</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">scanGnx</span><span class="p">(</span><span class="n">gnxString</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">v</span><span class="o">.</span><span class="n">fileIndex</span> <span class="o">=</span> <span class="n">gnx</span>
                <span class="n">gnxDict</span><span class="p">[</span><span class="n">gnxString</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;**** no gnx for&#39;</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
        <span class="n">child_v</span> <span class="o">=</span> <span class="n">v</span>
        <span class="n">child_v</span><span class="o">.</span><span class="n">_linkAsNthChild</span><span class="p">(</span><span class="n">parent_v</span><span class="p">,</span><span class="n">parent_v</span><span class="o">.</span><span class="n">numberOfChildren</span><span class="p">())</span>
        <span class="n">child_v</span><span class="o">.</span><span class="n">setVisited</span><span class="p">()</span> <span class="c"># Supress warning/deletion of unvisited nodes.</span>
        <span class="k">return</span> <span class="n">is_clone</span><span class="p">,</span><span class="n">child_v</span>
    <span class="c">#@+node:ekr.20100705083838.5740: *5* casher.reportChangedClone</span></div>
<div class="viewcode-block" id="cacher.reportChangedClone"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCache.cacher.reportChangedClone">[docs]</a>    <span class="k">def</span> <span class="nf">reportChangedClone</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">child_v</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">gnx</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="n">fileName</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">cacheListFileName</span>
        <span class="n">old</span><span class="p">,</span><span class="n">new</span> <span class="o">=</span> <span class="n">child_v</span><span class="o">.</span><span class="n">b</span><span class="p">,</span><span class="n">b</span>

        <span class="n">same</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">old</span> <span class="o">==</span> <span class="n">new</span> <span class="ow">or</span>
            <span class="n">new</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">old</span> <span class="o">==</span> <span class="n">new</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span>
            <span class="n">old</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">new</span> <span class="o">==</span> <span class="n">old</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c"># if trace and not same:</span>
        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">same</span> <span class="ow">or</span> <span class="n">h</span> <span class="o">==</span> <span class="s">&#39;writeException&#39;</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;same </span><span class="si">%s</span><span class="s"> old </span><span class="si">%s</span><span class="s"> new </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">same</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">old</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">new</span><span class="p">),</span><span class="n">h</span><span class="p">,</span><span class="n">fileName</span><span class="p">))</span>

        <span class="c"># This would make it impossible to clear nodes!</span>
        <span class="c"># if not new: return same</span>

        <span class="k">if</span> <span class="n">same</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">c</span><span class="o">.</span><span class="n">nodeConflictList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">bunch</span><span class="p">(</span>
            <span class="n">tag</span><span class="o">=</span><span class="s">&#39;(cached)&#39;</span><span class="p">,</span>
            <span class="n">fileName</span><span class="o">=</span><span class="n">fileName</span><span class="p">,</span>
            <span class="n">gnx</span><span class="o">=</span><span class="n">gnx</span><span class="p">,</span>
            <span class="n">b_old</span><span class="o">=</span><span class="n">child_v</span><span class="o">.</span><span class="n">b</span><span class="p">,</span>
            <span class="n">h_old</span><span class="o">=</span><span class="n">child_v</span><span class="o">.</span><span class="n">h</span><span class="p">,</span>
            <span class="n">b_new</span><span class="o">=</span><span class="n">b</span><span class="p">,</span>
            <span class="n">h_new</span><span class="o">=</span><span class="n">h</span><span class="p">,</span>
        <span class="p">))</span>

        <span class="c"># Always issue the warning.</span>
        <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;cached read node changed:&quot;</span><span class="p">,</span><span class="n">child_v</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

        <span class="n">child_v</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="n">child_v</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">h</span><span class="p">,</span><span class="n">b</span>
        <span class="n">child_v</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">True</span> <span class="c"># Tell getLeoFile to propegate dirty nodes.</span>
    <span class="c">#@+node:ekr.20100208082353.5923: *4* getCachedGlobalFileRatios</span></div>
<div class="viewcode-block" id="cacher.getCachedGlobalFileRatios"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCache.cacher.getCachedGlobalFileRatios">[docs]</a>    <span class="k">def</span> <span class="nf">getCachedGlobalFileRatios</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">internalError</span><span class="p">(</span><span class="s">&#39;no commander&#39;</span><span class="p">)</span>

        <span class="n">globals_tag</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">,</span><span class="s">&#39;leo3k.globals&#39;</span><span class="p">,</span><span class="s">&#39;leo2k.globals&#39;</span><span class="p">)</span>
        <span class="c"># globals_tag = g.toEncodedString(globals_tag,&#39;ascii&#39;)</span>

        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileKey</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">,</span><span class="n">globals_tag</span><span class="p">)</span>

        <span class="n">ratio</span>  <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;body_outline_ratio_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">),</span><span class="s">&#39;0.5&#39;</span><span class="p">))</span>
        <span class="n">ratio2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;body_secondary_ratio_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">),</span><span class="s">&#39;0.5&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;key&#39;</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%1.2f</span><span class="s"> </span><span class="si">%1.2f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ratio</span><span class="p">,</span><span class="n">ratio2</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">ratio</span><span class="p">,</span><span class="n">ratio2</span>
    <span class="c">#@+node:ekr.20100208082353.5924: *4* getCachedStringPosition</span></div>
<div class="viewcode-block" id="cacher.getCachedStringPosition"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCache.cacher.getCachedStringPosition">[docs]</a>    <span class="k">def</span> <span class="nf">getCachedStringPosition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">internalError</span><span class="p">(</span><span class="s">&#39;no commander&#39;</span><span class="p">)</span>

        <span class="n">globals_tag</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">,</span><span class="s">&#39;leo3k.globals&#39;</span><span class="p">,</span><span class="s">&#39;leo2k.globals&#39;</span><span class="p">)</span>
        <span class="c"># globals_tag = g.toEncodedString(globals_tag,&#39;ascii&#39;)</span>

        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileKey</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">,</span><span class="n">globals_tag</span><span class="p">)</span>
        <span class="n">str_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;current_position_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">str_pos</span><span class="p">,</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">str_pos</span>
    <span class="c">#@+node:ekr.20100208082353.5922: *4* getCachedWindowPositionDict</span></div>
<div class="viewcode-block" id="cacher.getCachedWindowPositionDict"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCache.cacher.getCachedWindowPositionDict">[docs]</a>    <span class="k">def</span> <span class="nf">getCachedWindowPositionDict</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">internalError</span><span class="p">(</span><span class="s">&#39;no commander&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="n">globals_tag</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">,</span><span class="s">&#39;leo3k.globals&#39;</span><span class="p">,</span><span class="s">&#39;leo2k.globals&#39;</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileKey</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">globals_tag</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;window_position_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">top</span><span class="p">,</span><span class="n">left</span><span class="p">,</span><span class="n">height</span><span class="p">,</span><span class="n">width</span> <span class="o">=</span> <span class="n">data</span>
            <span class="n">top</span><span class="p">,</span><span class="n">left</span><span class="p">,</span><span class="n">height</span><span class="p">,</span><span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">top</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">left</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">height</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;top&#39;</span><span class="p">:</span><span class="n">top</span><span class="p">,</span><span class="s">&#39;left&#39;</span><span class="p">:</span><span class="n">left</span><span class="p">,</span><span class="s">&#39;height&#39;</span><span class="p">:</span><span class="n">height</span><span class="p">,</span><span class="s">&#39;width&#39;</span><span class="p">:</span><span class="n">width</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">d</span>
    <span class="c">#@+node:ekr.20100208071151.5905: *4* readFile (cacher)</span></div>
<div class="viewcode-block" id="cacher.readFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCache.cacher.readFile">[docs]</a>    <span class="k">def</span> <span class="nf">readFile</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span><span class="n">root</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">enableDB</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;g.enableDB is False&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="p">,</span><span class="bp">False</span><span class="p">,</span><span class="bp">None</span>
        <span class="n">s</span><span class="p">,</span><span class="n">e</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">readFileIntoString</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">raw</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;empty file contents&#39;</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">s</span><span class="p">,</span><span class="bp">False</span><span class="p">,</span><span class="bp">None</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">isUnicode</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">s</span><span class="p">)):</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%3d</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">line</span><span class="p">)))</span>

        <span class="c"># There will be a bug if s is not already an encoded string.</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileKey</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">requireEncodedString</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;in cache&#39;</span><span class="p">,</span><span class="n">ok</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
            <span class="c"># Delete the previous tree, regardless of the @&lt;file&gt; type.</span>
            <span class="k">while</span> <span class="n">root</span><span class="o">.</span><span class="n">hasChildren</span><span class="p">():</span>
                <span class="n">root</span><span class="o">.</span><span class="n">firstChild</span><span class="p">()</span><span class="o">.</span><span class="n">doDelete</span><span class="p">()</span>
            <span class="c"># Recreate the file from the cache.</span>
            <span class="n">aList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">createOutlineFromCacheList</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="n">aList</span><span class="p">,</span><span class="n">fileName</span><span class="o">=</span><span class="n">fileName</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span><span class="p">,</span><span class="n">ok</span><span class="p">,</span><span class="n">key</span>
    <span class="c">#@+node:ekr.20100208082353.5927: *3* Writing</span>
    <span class="c">#@+node:ekr.20100208071151.5901: *4* makeCacheList</span></div>
<div class="viewcode-block" id="cacher.makeCacheList"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCache.cacher.makeCacheList">[docs]</a>    <span class="k">def</span> <span class="nf">makeCacheList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Create a recursive list describing a tree</span>
<span class="sd">        for use by createOutlineFromCacheList.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c"># This is called after at.copyAllTempBodyStringsToVnodes,</span>
        <span class="c"># so p.b *is* the body text.</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">gnx</span><span class="p">,</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">makeCacheList</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span> <span class="k">for</span> <span class="n">p2</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">children</span><span class="p">()]]</span>
    <span class="c">#@+node:ekr.20100208082353.5929: *4* setCachedGlobalsElement</span></div>
<div class="viewcode-block" id="cacher.setCachedGlobalsElement"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCache.cacher.setCachedGlobalsElement">[docs]</a>    <span class="k">def</span> <span class="nf">setCachedGlobalsElement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">internalError</span><span class="p">(</span><span class="s">&#39;no commander&#39;</span><span class="p">)</span>

        <span class="n">globals_tag</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">,</span><span class="s">&#39;leo3k.globals&#39;</span><span class="p">,</span><span class="s">&#39;leo2k.globals&#39;</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileKey</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">globals_tag</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s">&#39;body_outline_ratio_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">ratio</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s">&#39;body_secondary_ratio_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">secondary_ratio</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;ratios: </span><span class="si">%1.2f</span><span class="s"> </span><span class="si">%1.2f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">ratio</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">secondary_ratio</span><span class="p">))</span>

        <span class="n">width</span><span class="p">,</span><span class="n">height</span><span class="p">,</span><span class="n">left</span><span class="p">,</span><span class="n">top</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">get_window_info</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s">&#39;window_position_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">top</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">left</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">height</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">width</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;top&#39;</span><span class="p">,</span><span class="n">top</span><span class="p">,</span><span class="s">&#39;left&#39;</span><span class="p">,</span><span class="n">left</span><span class="p">,</span><span class="s">&#39;height&#39;</span><span class="p">,</span><span class="n">height</span><span class="p">,</span><span class="s">&#39;width&#39;</span><span class="p">,</span><span class="n">width</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100208082353.5928: *4* setCachedStringPosition</span></div>
<div class="viewcode-block" id="cacher.setCachedStringPosition"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCache.cacher.setCachedStringPosition">[docs]</a>    <span class="k">def</span> <span class="nf">setCachedStringPosition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">str_pos</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">internalError</span><span class="p">(</span><span class="s">&#39;no commander&#39;</span><span class="p">)</span>

        <span class="n">globals_tag</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">,</span><span class="s">&#39;leo3k.globals&#39;</span><span class="p">,</span><span class="s">&#39;leo2k.globals&#39;</span><span class="p">)</span>
        <span class="c"># globals_tag = g.toEncodedString(globals_tag,&#39;ascii&#39;)</span>

        <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileKey</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">,</span><span class="n">globals_tag</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="s">&#39;current_position_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_pos</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">str_pos</span><span class="p">,</span><span class="n">key</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100208071151.5903: *4* writeFile (cacher)</span>
    <span class="c"># Was atFile.writeCachedTree</span>
</div>
<div class="viewcode-block" id="cacher.writeFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCache.cacher.writeFile">[docs]</a>    <span class="k">def</span> <span class="nf">writeFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">fileKey</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

        <span class="c"># Bug fix: 2010/05/26: check g.enableDB before giving internal error.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">enableDB</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;cache disabled&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">fileKey</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
            <span class="n">g</span><span class="o">.</span><span class="n">internalError</span><span class="p">(</span><span class="s">&#39;empty fileKey&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fileKey</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;already cached&#39;</span><span class="p">,</span><span class="n">fileKey</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;caching &#39;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="n">fileKey</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">[</span><span class="n">fileKey</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makeCacheList</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100208065621.5890: *3* test (cacher)</span></div>
<div class="viewcode-block" id="cacher.test"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCache.cacher.test">[docs]</a>    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">guiName</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;nullGui&#39;</span><span class="p">:</span>
            <span class="c"># Null gui&#39;s don&#39;t normally set the g.app.gui.db.</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">setGlobalDb</span><span class="p">()</span> 

        <span class="c"># Fixes bug 670108.</span>
        <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">db</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
            <span class="c"># a PickleShareDB instance.</span>

        <span class="c"># Make sure g.guessExternalEditor works.</span>
        <span class="n">junk</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;LEO_EDITOR&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initFileDB</span><span class="p">(</span><span class="s">&#39;~/testpickleshare&#39;</span><span class="p">)</span>
        <span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span>
        <span class="n">db</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="n">db</span><span class="p">[</span><span class="s">&#39;hello&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">15</span>
        <span class="n">db</span><span class="p">[</span><span class="s">&#39;aku ankka&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">313</span><span class="p">]</span>
        <span class="n">db</span><span class="p">[</span><span class="s">&#39;paths/nest/ok/keyname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,(</span><span class="mi">5</span><span class="p">,</span><span class="mi">46</span><span class="p">)]</span>
        <span class="n">db</span><span class="o">.</span><span class="n">uncache</span><span class="p">()</span> <span class="c"># frees memory, causes re-reads later</span>
        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">db</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="c">#@-others</span>
<span class="c">#@+node:ekr.20100208223942.5967: ** class PickleShareDB</span></div></div>
<span class="n">_sentinel</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>

<div class="viewcode-block" id="PickleShareDB"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCache.PickleShareDB">[docs]</a><span class="k">class</span> <span class="nc">PickleShareDB</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot; The main &#39;connection&#39; object for PickleShare database &quot;&quot;&quot;</span>

    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20100208223942.5968: *3*  Birth &amp; special methods</span>
    <span class="c">#@+node:ekr.20100208223942.5969: *4*  __init__ (PickleShareDb)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">root</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Init the PickleShareDB class.</span>
<span class="sd">        root: The directory that contains the data. Created if it doesn&#39;t exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">abspath</span><span class="p">(</span><span class="n">expanduser</span><span class="p">(</span><span class="n">root</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;PickleShareDB&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c"># Keys are normalized file names.</span>
            <span class="c"># Values are tuples (obj, orig_mod_time)</span>

        <span class="k">def</span> <span class="nf">loadz</span><span class="p">(</span><span class="n">fileobj</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">fileobj</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
                    <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">fileobj</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>
                <span class="k">return</span> <span class="n">val</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>

        <span class="k">def</span> <span class="nf">dumpz</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">fileobj</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">fileobj</span><span class="p">:</span>
                <span class="n">compressed</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                    <span class="n">val</span><span class="p">,</span> <span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">))</span>
                <span class="n">fileobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">compressed</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loader</span> <span class="o">=</span> <span class="n">loadz</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dumper</span> <span class="o">=</span> <span class="n">dumpz</span>
    <span class="c">#@+node:ekr.20100208223942.5970: *4* __contains__</span>
    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;(PickleShareDB)&#39;</span><span class="p">,</span><span class="n">key</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100208223942.5971: *4* __delitem__</span>
    <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; del db[&quot;key&quot;] &quot;&quot;&quot;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

        <span class="n">fn</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="n">key</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;(PickleShareDB)&#39;</span><span class="p">,</span>
            <span class="n">g</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="c"># notfound and permission denied are ok - we</span>
            <span class="c"># lost, the other process wins the conflict</span>
            <span class="k">pass</span>
    <span class="c">#@+node:ekr.20100208223942.5972: *4* __getitem__</span>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; db[&#39;key&#39;] reading &quot;&quot;&quot;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

        <span class="n">fn</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="n">key</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mtime</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">fn</span><span class="p">)[</span><span class="n">stat</span><span class="o">.</span><span class="n">ST_MTIME</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;***OSError&#39;</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span><span class="n">key</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="ow">and</span> <span class="n">mtime</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">fn</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">fn</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;(PickleShareDB: in cache)&#39;</span><span class="p">,</span><span class="n">key</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">obj</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># The cached item has expired, need to read</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_openFile</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="s">&#39;rb&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;***Exception&#39;</span><span class="p">,</span><span class="n">key</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">fn</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">mtime</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;(PickleShareDB: set cache)&#39;</span><span class="p">,</span><span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span>
    <span class="c">#@+node:ekr.20100208223942.5973: *4* __iter__</span>
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;(PickleShareDB)&#39;</span><span class="p">,</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">yield</span> <span class="n">k</span>
    <span class="c">#@+node:ekr.20100208223942.5974: *4* __repr__</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="s">&quot;PickleShareDB(&#39;</span><span class="si">%s</span><span class="s">&#39;)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span>



    <span class="c">#@+node:ekr.20100208223942.5975: *4* __setitem__</span>
    <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; db[&#39;key&#39;] = 5 &quot;&quot;&quot;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="n">key</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;(PickleShareDB)&#39;</span><span class="p">,</span><span class="n">key</span><span class="p">)</span>
        <span class="n">parent</span><span class="p">,</span><span class="n">junk</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">parent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">isdir</span><span class="p">(</span><span class="n">parent</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_makedirs</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dumper</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_openFile</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="s">&#39;wb&#39;</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">mtime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">fn</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="n">mtime</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;***OSError&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span>
    <span class="c">#@+node:ekr.20100208223942.10452: *3* _makedirs</span>
    <span class="k">def</span> <span class="nf">_makedirs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="mi">0</span><span class="n">o777</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">mode</span><span class="p">)</span>

    <span class="c">#@+node:ekr.20100208223942.10458: *3* _openFile</span>
    <span class="k">def</span> <span class="nf">_openFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; Open this file.  Return a file object.</span>

<span class="sd">        Do not print an error message.</span>
<span class="sd">        It is not an error for this to fail. </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20100208223942.10454: *3* _walkfiles &amp; helpers</span>
    <span class="k">def</span> <span class="nf">_walkfiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; D.walkfiles() -&gt; iterator over files in D, recursively.</span>

<span class="sd">        The optional argument, pattern, limits the results to files</span>
<span class="sd">        with names that match the pattern.  For example,</span>
<span class="sd">        mydir.walkfiles(&#39;*.tmp&#39;) yields only files with the .tmp</span>
<span class="sd">        extension.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listdir</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">isfile</span><span class="p">(</span><span class="n">child</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">pattern</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fn_match</span><span class="p">(</span><span class="n">child</span><span class="p">,</span><span class="n">pattern</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">child</span>
            <span class="k">elif</span> <span class="n">isdir</span><span class="p">(</span><span class="n">child</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_walkfiles</span><span class="p">(</span><span class="n">child</span><span class="p">,</span><span class="n">pattern</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">f</span>

    <span class="c">#@+node:ekr.20100208223942.10456: *4* _listdir</span>
    <span class="k">def</span> <span class="nf">_listdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; D.listdir() -&gt; List of items in this directory.</span>

<span class="sd">        Use D.files() or D.dirs() instead if you want a listing</span>
<span class="sd">        of just files or just subdirectories.</span>

<span class="sd">        The elements of the list are path objects.</span>

<span class="sd">        With the optional &#39;pattern&#39; argument, this only lists</span>
<span class="sd">        items whose names match the given pattern.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">names</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pattern</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">child</span><span class="p">)</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span>

    <span class="c">#@+node:ekr.20100208223942.10464: *4* _fn_match</span>
    <span class="k">def</span> <span class="nf">_fn_match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return True if self.name matches the given pattern.</span>

<span class="sd">        pattern - A filename pattern with wildcards, for example &#39;*.py&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">basename</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">pattern</span><span class="p">)</span>

    <span class="c">#@+node:ekr.20100208223942.5978: *3* clear</span>
<div class="viewcode-block" id="PickleShareDB.clear"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCache.PickleShareDB.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="c"># Deletes all files in the fcache subdirectory.</span>
        <span class="c"># It would be more thorough to delete everything</span>
        <span class="c"># below the root directory, but it&#39;s not necessary.</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">red</span><span class="p">(</span><span class="s">&#39;clearing cache at directory...</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__delitem__</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100208223942.5979: *3* get</span></div>
<div class="viewcode-block" id="PickleShareDB.get"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCache.PickleShareDB.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;(PickleShareDB)&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span>
    <span class="c">#@+node:ekr.20100208223942.5980: *3* has_key</span></div>
<div class="viewcode-block" id="PickleShareDB.has_key"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCache.PickleShareDB.has_key">[docs]</a>    <span class="k">def</span> <span class="nf">has_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;(PickleShareDB)&#39;</span><span class="p">,</span><span class="n">key</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="c">#@+node:ekr.20100208223942.5981: *3* items</span></div>
<div class="viewcode-block" id="PickleShareDB.items"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCache.PickleShareDB.items">[docs]</a>    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">z</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
    <span class="c">#@+node:ekr.20100208223942.5982: *3* keys &amp; helpers</span>
    <span class="c"># Called by clear, and during unit testing.</span>
</div>
<div class="viewcode-block" id="PickleShareDB.keys"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCache.PickleShareDB.keys">[docs]</a>    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">globpat</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Return all keys in DB, or all keys matching a glob&quot;&quot;&quot;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

        <span class="k">if</span> <span class="n">globpat</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_walkfiles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">z</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="n">globpat</span><span class="p">))]</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_normalized</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">isfile</span><span class="p">(</span><span class="n">p</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;(PickleShareDB)&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">),</span><span class="n">result</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>
    <span class="c">#@+node:ekr.20100208223942.5976: *4* _normalized</span></div>
    <span class="k">def</span> <span class="nf">_normalized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Make a key suitable for user&#39;s eyes &quot;&quot;&quot;</span>

        <span class="c"># os.path.relpath doesn&#39;t work here.</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relpathto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;/&#39;</span><span class="p">)</span>

    <span class="c">#@+node:ekr.20100208223942.10460: *4* _relpathto</span>
    <span class="c"># Used only by _normalized.</span>

    <span class="k">def</span> <span class="nf">_relpathto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; Return a relative path from self to dst.</span>

<span class="sd">        If there is no relative path from self to dst, for example if</span>
<span class="sd">        they reside on different drives in Windows, then this returns</span>
<span class="sd">        dst.abspath().</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">origin</span> <span class="o">=</span> <span class="n">abspath</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="n">abspath</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>
        <span class="n">orig_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_splitall</span><span class="p">(</span><span class="n">normcase</span><span class="p">(</span><span class="n">origin</span><span class="p">))</span>
        <span class="c"># Don&#39;t normcase dst!  We want to preserve the case.</span>
        <span class="n">dest_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_splitall</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">orig_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">normcase</span><span class="p">(</span><span class="n">dest_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="c"># Can&#39;t get here from there.</span>
            <span class="k">return</span> <span class="n">dst</span>

        <span class="c"># Find the location where the two paths start to differ.</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">start_seg</span><span class="p">,</span> <span class="n">dest_seg</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">orig_list</span><span class="p">,</span> <span class="n">dest_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">start_seg</span> <span class="o">!=</span> <span class="n">normcase</span><span class="p">(</span><span class="n">dest_seg</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c"># Now i is the point where the two paths diverge.</span>
        <span class="c"># Need a certain number of &quot;os.pardir&quot;s to work up</span>
        <span class="c"># from the origin to the point of divergence.</span>
        <span class="n">segments</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">orig_list</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>
        <span class="c"># Need to add the diverging part of dest_list.</span>
        <span class="n">segments</span> <span class="o">+=</span> <span class="n">dest_list</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">segments</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># If they happen to be identical, use os.curdir.</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">curdir</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">segments</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100208223942.10462: *4* _splitall</span>
    <span class="c"># Used by relpathto.</span>

    <span class="k">def</span> <span class="nf">_splitall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a list of the path components in this path.</span>

<span class="sd">        The first item in the list will be a path.  Its value will be</span>
<span class="sd">        either os.curdir, os.pardir, empty, or the root directory of</span>
<span class="sd">        this path (for example, &#39;/&#39; or &#39;C:\\&#39;).  The other items in</span>
<span class="sd">        the list will be strings.</span>

<span class="sd">        path.path.joinpath(*result) will yield the original path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="n">s</span>
        <span class="k">while</span> <span class="n">loc</span> <span class="o">!=</span> <span class="n">os</span><span class="o">.</span><span class="n">curdir</span> <span class="ow">and</span> <span class="n">loc</span> <span class="o">!=</span> <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">:</span>
            <span class="n">prev</span> <span class="o">=</span> <span class="n">loc</span>
            <span class="n">loc</span><span class="p">,</span><span class="n">child</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="n">prev</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">loc</span> <span class="o">==</span> <span class="n">prev</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
        <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span>
        <span class="n">parts</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">parts</span>

    <span class="c">#@+node:ekr.20100208223942.5989: *3* uncache</span>
<div class="viewcode-block" id="PickleShareDB.uncache"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCache.PickleShareDB.uncache">[docs]</a>    <span class="k">def</span> <span class="nf">uncache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">items</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Removes all, or specified items from cache</span>

<span class="sd">        Use this after reading a large amount of large objects</span>
<span class="sd">        to free up memory, when you won&#39;t be needing the objects</span>
<span class="sd">        for a while.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">items</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">it</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>

    <span class="c">#@-others</span>
<span class="c">#@-others</span>
<span class="c">#@-leo</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Leo API 4.11dev documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Ed K. Ream.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
  </body>
</html>