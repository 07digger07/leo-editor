<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>leo.core.leoFileCommands &mdash; Leo API 4.11dev documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '4.11dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Leo API 4.11dev documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Leo API 4.11dev documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for leo.core.leoFileCommands</h1><div class="highlight"><pre>
<span class="c">#@+leo-ver=5-thin</span>
<span class="c">#@+node:ekr.20031218072017.3018: * @file leoFileCommands.py</span>
<span class="c">#@@language python</span>
<span class="c">#@@tabwidth -4</span>
<span class="c">#@@pagewidth 70</span>

<span class="c">#@+&lt;&lt; imports &gt;&gt;</span>
<span class="c">#@+node:ekr.20050405141130: ** &lt;&lt; imports &gt;&gt; (leoFileCommands)</span>
<span class="kn">import</span> <span class="nn">leo.core.leoGlobals</span> <span class="kn">as</span> <span class="nn">g</span>

<span class="c"># if g.app and g.app.use_psyco:</span>
    <span class="c"># # g.pr(&quot;enabled psyco classes&quot;,__file__)</span>
    <span class="c"># try: from psyco.classes import *</span>
    <span class="c"># except ImportError: pass</span>

<span class="kn">import</span> <span class="nn">leo.core.leoNodes</span> <span class="kn">as</span> <span class="nn">leoNodes</span>
<span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">import</span> <span class="nn">difflib</span>

<span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">io</span> <span class="c"># Python 3.x</span>
    <span class="n">StringIO</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span>
    <span class="n">BytesIO</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">cStringIO</span> <span class="c"># Python 2.x</span>
    <span class="n">StringIO</span> <span class="o">=</span> <span class="n">cStringIO</span><span class="o">.</span><span class="n">StringIO</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">zipfile</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c"># IronPython has problems with this.</span>
    <span class="kn">import</span> <span class="nn">xml.sax</span>
    <span class="kn">import</span> <span class="nn">xml.sax.saxutils</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="c"># The following is sometimes used.</span>
<span class="c"># import time</span>
<span class="c">#@-&lt;&lt; imports &gt;&gt;</span>

<span class="c">#@+&lt;&lt; define exception classes &gt;&gt;</span>
<span class="c">#@+node:ekr.20060918164811: ** &lt;&lt; define exception classes &gt;&gt;</span>
<div class="viewcode-block" id="BadLeoFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.BadLeoFile">[docs]</a><span class="k">class</span> <span class="nc">BadLeoFile</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span>
        <span class="ne">Exception</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">message</span><span class="p">)</span> <span class="c"># Init the base class.</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;Bad Leo File:&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span>
</div>
<div class="viewcode-block" id="invalidPaste"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.invalidPaste">[docs]</a><span class="k">class</span> <span class="nc">invalidPaste</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>
<span class="c">#@-&lt;&lt; define exception classes &gt;&gt;</span>
</div>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="s">&#39;cli&#39;</span><span class="p">:</span>
    <span class="c">#@+&lt;&lt; define sax classes &gt;&gt;</span>
    <span class="c">#@+node:ekr.20060919145406: ** &lt;&lt; define sax classes &gt;&gt;</span>
    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20060919110638.19: *3* class saxContentHandler (XMLGenerator)</span>
<div class="viewcode-block" id="saxContentHandler"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.saxContentHandler">[docs]</a>    <span class="k">class</span> <span class="nc">saxContentHandler</span> <span class="p">(</span><span class="n">xml</span><span class="o">.</span><span class="n">sax</span><span class="o">.</span><span class="n">saxutils</span><span class="o">.</span><span class="n">XMLGenerator</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;A sax content handler class that reads Leo files.&#39;&#39;&#39;</span>

        <span class="c">#@+others</span>
        <span class="c">#@+node:ekr.20060919110638.20: *4*  __init__ &amp; helpers</span>
        <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span><span class="n">silent</span><span class="p">,</span><span class="n">inClipboard</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">c</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span> <span class="o">=</span> <span class="n">fileName</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">silent</span> <span class="o">=</span> <span class="n">silent</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inClipboard</span> <span class="o">=</span> <span class="n">inClipboard</span>

            <span class="c"># Init the base class.</span>
            <span class="n">xml</span><span class="o">.</span><span class="n">sax</span><span class="o">.</span><span class="n">saxutils</span><span class="o">.</span><span class="n">XMLGenerator</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

            <span class="c">#@+&lt;&lt; define dispatch dict &gt;&gt;</span>
            <span class="c">#@+node:ekr.20060919110638.21: *5* &lt;&lt; define dispatch dict &gt;&gt;</span>
            <span class="c"># There is no need for an &#39;end&#39; method if all info is carried in attributes.</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dispatchDict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39;change_string&#39;</span><span class="p">:</span>               <span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
                <span class="s">&#39;find_panel_settings&#39;</span><span class="p">:</span>         <span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
                <span class="s">&#39;find_string&#39;</span><span class="p">:</span>                 <span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
                <span class="s">&#39;globals&#39;</span><span class="p">:</span>                     <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">startGlobals</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
                <span class="s">&#39;global_log_window_position&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span> <span class="c"># The position of the log window is no longer used.</span>
                <span class="s">&#39;global_window_position&#39;</span><span class="p">:</span>      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">startWinPos</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
                <span class="s">&#39;leo_file&#39;</span><span class="p">:</span>                    <span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
                <span class="s">&#39;leo_header&#39;</span><span class="p">:</span>                  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">startLeoHeader</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
                <span class="s">&#39;preferences&#39;</span><span class="p">:</span>                 <span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
                <span class="s">&#39;t&#39;</span><span class="p">:</span>                           <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">startTnode</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">endTnode</span><span class="p">),</span>
                <span class="s">&#39;tnodes&#39;</span><span class="p">:</span>                      <span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span>
                <span class="s">&#39;v&#39;</span><span class="p">:</span>                           <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">startVnode</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">endVnode</span><span class="p">),</span>
                <span class="s">&#39;vh&#39;</span><span class="p">:</span>                          <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">startVH</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">endVH</span><span class="p">),</span>
                <span class="s">&#39;vnodes&#39;</span><span class="p">:</span>                      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">startVnodes</span><span class="p">,</span><span class="bp">None</span><span class="p">),</span> <span class="c"># Causes window to appear.</span>
            <span class="p">}</span>
            <span class="c">#@-&lt;&lt; define dispatch dict &gt;&gt;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">printElements</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># &#39;all&#39;, &#39;v&#39;</span>

            <span class="c"># Global attributes of the .leo file...</span>
            <span class="c"># self.body_outline_ratio = &#39;0.5&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">global_window_position</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="s">&#39;utf-8&#39;</span> 

            <span class="c"># Semantics...</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elementStack</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tnxToListDict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="c"># Keys are tnx&#39;s (strings)</span>
                <span class="c"># Values are *lists* of saxNodeClass objects.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodeList</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># List of saxNodeClass objects with the present vnode.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodeStack</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rootNode</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># a sax node.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># True and g.unitTesting</span>
        <span class="c">#@+node:ekr.20060919110638.29: *4*  Do nothing</span>
<div class="viewcode-block" id="saxContentHandler.endElementNS"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.saxContentHandler.endElementNS">[docs]</a>        <span class="k">def</span> <span class="nf">endElementNS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">unused_name</span><span class="p">,</span><span class="n">unused_qname</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">unused_name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="saxContentHandler.endDocument"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.saxContentHandler.endDocument">[docs]</a>        <span class="k">def</span> <span class="nf">endDocument</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">pass</span>
</div>
<div class="viewcode-block" id="saxContentHandler.ignorableWhitespace"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.saxContentHandler.ignorableWhitespace">[docs]</a>        <span class="k">def</span> <span class="nf">ignorableWhitespace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">unused_whitespace</span><span class="p">):</span>
            <span class="k">pass</span>
</div>
<div class="viewcode-block" id="saxContentHandler.skippedEntity"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.saxContentHandler.skippedEntity">[docs]</a>        <span class="k">def</span> <span class="nf">skippedEntity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="saxContentHandler.startElementNS"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.saxContentHandler.startElementNS">[docs]</a>        <span class="k">def</span> <span class="nf">startElementNS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">unused_name</span><span class="p">,</span><span class="n">unused_qname</span><span class="p">,</span><span class="n">unused_attrs</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">unused_name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="saxContentHandler.startDocument"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.saxContentHandler.startDocument">[docs]</a>        <span class="k">def</span> <span class="nf">startDocument</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="c">#@+node:ekr.20060919134313: *4*  Utils</span>
        <span class="c">#@+node:ekr.20060919110638.23: *5* attrsToList</span></div>
<div class="viewcode-block" id="saxContentHandler.attrsToList"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.saxContentHandler.attrsToList">[docs]</a>        <span class="k">def</span> <span class="nf">attrsToList</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">attrs</span><span class="p">):</span>

            <span class="sd">&#39;&#39;&#39;Convert the attributes to a list of g.Bunches.</span>

<span class="sd">            attrs: an Attributes item passed to startElement.&#39;&#39;&#39;</span>

            <span class="k">return</span> <span class="p">[</span>
                <span class="n">g</span><span class="o">.</span><span class="n">Bunch</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span><span class="n">val</span><span class="o">=</span><span class="n">attrs</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">attrs</span><span class="o">.</span><span class="n">getNames</span><span class="p">()]</span>
        <span class="c">#@+node:ekr.20060919110638.26: *5* error</span></div>
<div class="viewcode-block" id="saxContentHandler.error"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.saxContentHandler.error">[docs]</a>        <span class="k">def</span> <span class="nf">error</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>

            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n\n</span><span class="s">XML error: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">message</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c">#@+node:ekr.20060919110638.27: *5* inElement</span></div>
<div class="viewcode-block" id="saxContentHandler.inElement"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.saxContentHandler.inElement">[docs]</a>        <span class="k">def</span> <span class="nf">inElement</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">elementStack</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">elementStack</span>
        <span class="c">#@+node:ekr.20060919110638.28: *5* printStartElement</span></div>
<div class="viewcode-block" id="saxContentHandler.printStartElement"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.saxContentHandler.printStartElement">[docs]</a>        <span class="k">def</span> <span class="nf">printStartElement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">attrs</span><span class="p">):</span>

            <span class="n">indent</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>

            <span class="k">if</span> <span class="n">attrs</span><span class="o">.</span><span class="n">getLength</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">&lt;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">indent</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">attrsToString</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s">&#39; &#39;</span><span class="p">)),</span>
                    <span class="n">newline</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">&lt;</span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">indent</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()),</span>
                    <span class="n">newline</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;v&#39;</span><span class="p">,</span><span class="s">&#39;t&#39;</span><span class="p">,</span><span class="s">&#39;vnodes&#39;</span><span class="p">,</span><span class="s">&#39;tnodes&#39;</span><span class="p">,]:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="c">#@+node:ekr.20060919110638.24: *6* attrsToString</span></div>
<div class="viewcode-block" id="saxContentHandler.attrsToString"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.saxContentHandler.attrsToString">[docs]</a>        <span class="k">def</span> <span class="nf">attrsToString</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">attrs</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">):</span>

            <span class="sd">&#39;&#39;&#39;Convert the attributes to a string.</span>

<span class="sd">            attrs: an Attributes item passed to startElement.</span>

<span class="sd">            sep: the separator charater between attributes.&#39;&#39;&#39;</span>

            <span class="n">result</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s">&#39;</span><span class="si">%s</span><span class="s">=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bunch</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">bunch</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">bunch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrsToList</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
            <span class="p">]</span>

            <span class="k">return</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="c">#@+node:ekr.20060919110638.25: *6* clean</span></div>
<div class="viewcode-block" id="saxContentHandler.clean"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.saxContentHandler.clean">[docs]</a>        <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="s">&quot;ascii&quot;</span><span class="p">)</span>
        <span class="c">#@+node:ekr.20060919110638.30: *4* characters</span></div>
<div class="viewcode-block" id="saxContentHandler.characters"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.saxContentHandler.characters">[docs]</a>        <span class="k">def</span> <span class="nf">characters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">content</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">content</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">):</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;Non-unicode content&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">content</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">content</span><span class="p">)</span> <span class="o">!=</span> <span class="n">types</span><span class="o">.</span><span class="n">UnicodeType</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;Non-unicode content&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>

            <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\r</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span><span class="p">:</span> <span class="k">return</span>

            <span class="n">elementName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elementStack</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">elementStack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s">&#39;&lt;no element name&gt;&#39;</span>

            <span class="c"># if self.trace: g.trace(elementName,content.strip())</span>

            <span class="k">if</span> <span class="n">elementName</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;t&#39;</span><span class="p">,</span><span class="s">&#39;vh&#39;</span><span class="p">):</span>
                <span class="c"># if elementName == &#39;vh&#39;: g.trace(elementName,repr(content))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">content</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;unexpected content:&#39;</span><span class="p">,</span><span class="n">elementName</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>
        <span class="c">#@+node:ekr.20060919110638.31: *4* endElement &amp; helpers</span></div>
<div class="viewcode-block" id="saxContentHandler.endElement"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.saxContentHandler.endElement">[docs]</a>        <span class="k">def</span> <span class="nf">endElement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>

            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">printElements</span> <span class="ow">or</span> <span class="s">&#39;all&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">printElements</span><span class="p">:</span>
                <span class="n">indent</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">level</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
                <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">&lt;/</span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">indent</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>

            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatchDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="mi">1</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;unknown end element&#39;</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">junk</span><span class="p">,</span><span class="n">func</span> <span class="o">=</span> <span class="n">data</span>
                <span class="k">if</span> <span class="n">func</span><span class="p">:</span>
                    <span class="n">func</span><span class="p">()</span>

            <span class="n">name2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">elementStack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">name</span> <span class="o">==</span> <span class="n">name2</span>
            <span class="c"># if self.trace: g.trace(&#39;** pop&#39;,name2)</span>
        <span class="c">#@+node:ekr.20060919110638.32: *5* endTnode</span></div>
<div class="viewcode-block" id="saxContentHandler.endTnode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.saxContentHandler.endTnode">[docs]</a>        <span class="k">def</span> <span class="nf">endTnode</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="k">for</span> <span class="n">sax_node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodeList</span><span class="p">:</span>
                <span class="n">sax_node</span><span class="o">.</span><span class="n">bodyString</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                <span class="c"># if self.trace: g.trace(repr(sax_node))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c">#@+node:ekr.20060919110638.33: *5* endVnode</span></div>
<div class="viewcode-block" id="saxContentHandler.endVnode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.saxContentHandler.endVnode">[docs]</a>        <span class="k">def</span> <span class="nf">endVnode</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodeStack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="c"># if self.trace: g.trace(repr(self.node))</span>
        <span class="c">#@+node:ekr.20060919110638.34: *5* endVH</span></div>
<div class="viewcode-block" id="saxContentHandler.endVH"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.saxContentHandler.endVH">[docs]</a>        <span class="k">def</span> <span class="nf">endVH</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">headString</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                <span class="c"># if self.trace: g.trace(repr(self.node))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c">#@+node:ekr.20060919110638.45: *4* getRootNode</span></div>
<div class="viewcode-block" id="saxContentHandler.getRootNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.saxContentHandler.getRootNode">[docs]</a>        <span class="k">def</span> <span class="nf">getRootNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rootNode</span><span class="o">.</span><span class="n">dump</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rootNode</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                    <span class="n">child</span><span class="o">.</span><span class="n">dump</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rootNode</span>
        <span class="c">#@+node:ekr.20061004054323: *4* processingInstruction (stylesheet)</span></div>
<div class="viewcode-block" id="saxContentHandler.processingInstruction"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.saxContentHandler.processingInstruction">[docs]</a>        <span class="k">def</span> <span class="nf">processingInstruction</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">target</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">target</span> <span class="o">==</span> <span class="s">&#39;xml-stylesheet&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">stylesheet</span> <span class="o">=</span> <span class="n">data</span>
                <span class="k">if</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">silent</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span><span class="n">data</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">target</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
        <span class="c">#@+node:ekr.20060919110638.35: *4* startElement &amp; helpers</span></div>
<div class="viewcode-block" id="saxContentHandler.startElement"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.saxContentHandler.startElement">[docs]</a>        <span class="k">def</span> <span class="nf">startElement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">attrs</span><span class="p">):</span>

            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">printElements</span> <span class="ow">or</span> <span class="s">&#39;all&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">printElements</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">printStartElement</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">attrs</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">elementStack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="c"># if self.trace: g.trace(&#39;**push&#39;,name)</span>

            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatchDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="mi">1</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;unknown start element&#39;</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">func</span><span class="p">,</span><span class="n">junk</span> <span class="o">=</span> <span class="n">data</span>
                <span class="k">if</span> <span class="n">func</span><span class="p">:</span>
                    <span class="n">func</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
        <span class="c">#@+node:ekr.20060919110638.36: *5* getWindowPositionAttributes</span></div>
<div class="viewcode-block" id="saxContentHandler.getWindowPositionAttributes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.saxContentHandler.getWindowPositionAttributes">[docs]</a>        <span class="k">def</span> <span class="nf">getWindowPositionAttributes</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">attrs</span><span class="p">):</span>

            <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>

            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">)</span>

            <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">enableDB</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">cacher</span><span class="o">.</span><span class="n">getCachedWindowPositionDict</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">d</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">fixed</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">fixedWindowPosition</span><span class="p">:</span>
                <span class="n">width</span><span class="p">,</span><span class="n">height</span><span class="p">,</span><span class="n">left</span><span class="p">,</span><span class="n">top</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fixedWindowPosition</span>
                <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;top&#39;</span><span class="p">:</span><span class="n">top</span><span class="p">,</span><span class="s">&#39;left&#39;</span><span class="p">:</span><span class="n">left</span><span class="p">,</span><span class="s">&#39;width&#39;</span><span class="p">:</span><span class="n">width</span><span class="p">,</span><span class="s">&#39;height&#39;</span><span class="p">:</span><span class="n">height</span><span class="p">}</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">d</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">bunch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrsToList</span><span class="p">(</span><span class="n">attrs</span><span class="p">):</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">bunch</span><span class="o">.</span><span class="n">name</span> <span class="p">;</span> <span class="n">val</span> <span class="o">=</span> <span class="n">bunch</span><span class="o">.</span><span class="n">val</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;top&#39;</span><span class="p">,</span><span class="s">&#39;left&#39;</span><span class="p">,</span><span class="s">&#39;width&#39;</span><span class="p">,</span><span class="s">&#39;height&#39;</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">d</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="n">d</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="c"># A reasonable default.</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>

            <span class="c"># if trace: g.trace(d)</span>
            <span class="k">return</span> <span class="n">d</span>
        <span class="c">#@+node:ekr.20060919110638.37: *5* startGlobals (sax read)</span></div>
<div class="viewcode-block" id="saxContentHandler.startGlobals"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.saxContentHandler.startGlobals">[docs]</a>        <span class="k">def</span> <span class="nf">startGlobals</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">attrs</span><span class="p">):</span>

            <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inClipboard</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">ratio</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">secondary_ratio</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span> <span class="c"># Set defaults.</span>

            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">)</span>

            <span class="n">use_db</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">enableDB</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">mFileName</span>
            <span class="k">if</span> <span class="n">use_db</span><span class="p">:</span>
                <span class="n">ratio</span><span class="p">,</span><span class="n">ratio2</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">cacher</span><span class="o">.</span><span class="n">getCachedGlobalFileRatios</span><span class="p">()</span>
                <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">ratio</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">secondary_ratio</span> <span class="o">=</span> <span class="n">ratio</span><span class="p">,</span><span class="n">ratio2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">bunch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrsToList</span><span class="p">(</span><span class="n">attrs</span><span class="p">):</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">bunch</span><span class="o">.</span><span class="n">name</span> <span class="p">;</span> <span class="n">val</span> <span class="o">=</span> <span class="n">bunch</span><span class="o">.</span><span class="n">val</span>
                        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;body_outline_ratio&#39;</span><span class="p">:</span>
                            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">ratio</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="c"># 2010/01/11</span>
                        <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;body_secondary_ratio&#39;</span><span class="p">:</span>
                            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">secondary_ratio</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="c"># 2010/01/11</span>
                    <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;** not cached:&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%1.2f</span><span class="s"> </span><span class="si">%1.2f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">ratio</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">secondary_ratio</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="c">#@+node:ekr.20060919110638.38: *5* startWinPos</span></div>
<div class="viewcode-block" id="saxContentHandler.startWinPos"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.saxContentHandler.startWinPos">[docs]</a>        <span class="k">def</span> <span class="nf">startWinPos</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">attrs</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">global_window_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getWindowPositionAttributes</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
        <span class="c">#@+node:ekr.20060919110638.39: *5* startLeoHeader</span></div>
<div class="viewcode-block" id="saxContentHandler.startLeoHeader"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.saxContentHandler.startLeoHeader">[docs]</a>        <span class="k">def</span> <span class="nf">startLeoHeader</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">unused_attrs</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">tnxToListDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c">#@+node:ekr.20060919110638.40: *5* startVH</span></div>
<div class="viewcode-block" id="saxContentHandler.startVH"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.saxContentHandler.startVH">[docs]</a>        <span class="k">def</span> <span class="nf">startVH</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">unused_attrs</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c">#@+node:ekr.20060919112118: *5* startVnodes</span></div>
<div class="viewcode-block" id="saxContentHandler.startVnodes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.saxContentHandler.startVnodes">[docs]</a>        <span class="k">def</span> <span class="nf">startVnodes</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">unused_attrs</span><span class="p">):</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inClipboard</span><span class="p">:</span>
                <span class="k">return</span> <span class="c"># No need to do anything to the main window.</span>

            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_window_position</span>

            <span class="n">w</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;width&#39;</span><span class="p">,</span><span class="mi">700</span><span class="p">)</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;height&#39;</span><span class="p">,</span><span class="mi">500</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;left&#39;</span><span class="p">,</span><span class="mi">50</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;top&#39;</span><span class="p">,</span><span class="mi">50</span><span class="p">)</span>
            <span class="c"># g.trace(d,w,h,x,y)</span>

            <span class="c"># Redraw the window before writing into it.</span>
            <span class="c"># 2011/06/16: Honor --minimized, --maximized or --fullscreen.</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">start_minimized</span> <span class="ow">and</span>
                <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">start_maximized</span> <span class="ow">and</span>
                <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">start_fullscreen</span>
            <span class="p">):</span>
                <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">setTopGeometry</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
                <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">deiconify</span><span class="p">()</span>
                <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">lift</span><span class="p">()</span>
                <span class="c"># c.frame.update()</span>

            <span class="c"># Causes window to appear.</span>
            <span class="c"># g.trace(&#39;ratio&#39;,c.frame.ratio,c)</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">top</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">resizePanesToRatio</span><span class="p">(</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">ratio</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">secondary_ratio</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">silent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;reading:&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">)</span>
        <span class="c">#@+node:ekr.20060919110638.41: *5* startTnode</span></div>
<div class="viewcode-block" id="saxContentHandler.startTnode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.saxContentHandler.startTnode">[docs]</a>        <span class="k">def</span> <span class="nf">startTnode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">attrs</span><span class="p">):</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">inElement</span><span class="p">(</span><span class="s">&#39;tnodes&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;&lt;t&gt; outside &lt;tnodes&gt;&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">tnodeAttributes</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
        <span class="c">#@+node:ekr.20060919110638.42: *6* tnodeAttributes</span></div>
<div class="viewcode-block" id="saxContentHandler.tnodeAttributes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.saxContentHandler.tnodeAttributes">[docs]</a>        <span class="k">def</span> <span class="nf">tnodeAttributes</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">attrs</span><span class="p">):</span>

            <span class="c"># The vnode must have a tx attribute to associate content</span>
            <span class="c"># with the proper node.</span>

            <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
            <span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodeList</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="c"># Step one: find the tx attribute</span>
            <span class="k">for</span> <span class="n">bunch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrsToList</span><span class="p">(</span><span class="n">attrs</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">bunch</span><span class="o">.</span><span class="n">name</span> <span class="p">;</span> <span class="n">val</span> <span class="o">=</span> <span class="n">bunch</span><span class="o">.</span><span class="n">val</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;tx&#39;</span><span class="p">:</span>
                    <span class="c"># 2010/02/03: This code formerly did something</span>
                    <span class="c"># different when unit testing just to support a unit test.</span>
                    <span class="c"># Hahaha.  The unit test *caused* the bug!</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nodeList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tnxToListDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">val</span><span class="p">,[])</span>
                    <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;tx&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">nodeList</span><span class="p">)</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodeList</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Bad leo file: no node for &lt;t tx=</span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">val</span><span class="p">))</span>
                <span class="k">return</span>

            <span class="c"># Step two: find all the other attributes:</span>
            <span class="k">for</span> <span class="n">bunch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrsToList</span><span class="p">(</span><span class="n">attrs</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">bunch</span><span class="o">.</span><span class="n">name</span> <span class="p">;</span> <span class="n">val</span> <span class="o">=</span> <span class="n">bunch</span><span class="o">.</span><span class="n">val</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s">&#39;tx&#39;</span><span class="p">:</span>
                    <span class="c"># Huge bug fix: 2009/7/1: was node == self.node.</span>
                    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodeList</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">=</span><span class="si">%s</span><span class="s">...&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">val</span><span class="p">[:</span><span class="mi">20</span><span class="p">]))</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">tnodeAttributes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

            <span class="c"># if not self.nodeList:</span>
                <span class="c"># self.error(&#39;Bad leo file: no tx attribute for vnode&#39;)</span>
        <span class="c">#@+node:ekr.20060919110638.43: *5* startVnode</span></div>
<div class="viewcode-block" id="saxContentHandler.startVnode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.saxContentHandler.startVnode">[docs]</a>        <span class="k">def</span> <span class="nf">startVnode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">attrs</span><span class="p">):</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">inElement</span><span class="p">(</span><span class="s">&#39;vnodes&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;&lt;v&gt; outside &lt;vnodes&gt;&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rootNode</span><span class="p">:</span>
                <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rootNode</span> <span class="o">=</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">saxNodeClass</span><span class="p">()</span> <span class="c"># The dummy parent node.</span>
                <span class="n">parent</span><span class="o">.</span><span class="n">headString</span> <span class="o">=</span> <span class="s">&#39;dummyNode&#39;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="n">saxNodeClass</span><span class="p">()</span>

            <span class="n">parent</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vnodeAttributes</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodeStack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">parent</span>
        <span class="c">#@+node:ekr.20060919110638.44: *6* vnodeAttributes</span>
        <span class="c"># The native attributes of &lt;v&gt; elements are a, t, vtag, tnodeList,</span>
        <span class="c"># marks, expanded and descendentTnodeUnknownAttributes.</span>
</div>
<div class="viewcode-block" id="saxContentHandler.vnodeAttributes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.saxContentHandler.vnodeAttributes">[docs]</a>        <span class="k">def</span> <span class="nf">vnodeAttributes</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">attrs</span><span class="p">):</span>

            <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span>

            <span class="k">for</span> <span class="n">bunch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrsToList</span><span class="p">(</span><span class="n">attrs</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">bunch</span><span class="o">.</span><span class="n">name</span> <span class="p">;</span> <span class="n">val</span> <span class="o">=</span> <span class="n">bunch</span><span class="o">.</span><span class="n">val</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;t&#39;</span><span class="p">:</span>
                    <span class="n">aList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tnxToListDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">val</span><span class="p">,[])</span>
                    <span class="n">aList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tnxToListDict</span><span class="p">[</span><span class="n">val</span><span class="p">]</span> <span class="o">=</span> <span class="n">aList</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">tnx</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="c"># nodeIndices.toString returns a string.</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="c">#@-others</span>
    <span class="c">#@+node:ekr.20060919110638.15: *3* class saxNodeClass</span></div></div>
<div class="viewcode-block" id="saxNodeClass"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.saxNodeClass">[docs]</a>    <span class="k">class</span> <span class="nc">saxNodeClass</span><span class="p">:</span>

        <span class="sd">&#39;&#39;&#39;A class representing one &lt;v&gt; element.</span>

<span class="sd">        Use getters to access the attributes, properties and rules of this mode.&#39;&#39;&#39;</span>

        <span class="c">#@+others</span>
        <span class="c">#@+node:ekr.20060919110638.16: *4*  node.__init__</span>
        <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bodyString</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">headString</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tnodeAttributes</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tnodeList</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tnx</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c">#@+node:ekr.20060919110638.17: *4*  node.__str__ &amp; __repr__</span>
        <span class="k">def</span> <span class="nf">__str__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="k">return</span> <span class="s">&#39;&lt;v:</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">headString</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bodyString</span><span class="p">))</span>

        <span class="n">__repr__</span> <span class="o">=</span> <span class="n">__str__</span>
        <span class="c">#@+node:ekr.20060919110638.18: *4* node.dump</span>
<div class="viewcode-block" id="saxNodeClass.dump"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.saxNodeClass.dump">[docs]</a>        <span class="k">def</span> <span class="nf">dump</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">node: </span><span class="si">%s</span><span class="s"> tnx: </span><span class="si">%s</span><span class="s"> len(body): </span><span class="si">%d</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">tnx</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bodyString</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">headString</span><span class="p">))</span>
            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;children:&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">listToString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">))</span>
            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;attrs:&#39;</span><span class="p">,</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="c">#@-others</span>
    <span class="c">#@-others</span>
    <span class="c">#@-&lt;&lt; define sax classes &gt;&gt;</span>
</div></div>
<div class="viewcode-block" id="baseFileCommands"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands">[docs]</a><span class="k">class</span> <span class="nc">baseFileCommands</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A base class for the fileCommands subcommander.&quot;&quot;&quot;</span>
    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20090218115025.4: ** Birth (leoFileCommands)</span>
    <span class="c">#@+node:ekr.20031218072017.3019: *3* leoFileCommands._init_</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>

        <span class="c"># g.trace(&quot;__init__&quot;, &quot;fileCommands.__init__&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nativeTnodeAttributes</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;tx&#39;</span><span class="p">,)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nativeVnodeAttributes</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s">&#39;a&#39;</span><span class="p">,</span>
            <span class="s">&#39;descendentTnodeUnknownAttributes&#39;</span><span class="p">,</span>
            <span class="s">&#39;descendentVnodeUnknownAttributes&#39;</span><span class="p">,</span> <span class="c"># New in Leo 4.5.</span>
            <span class="s">&#39;expanded&#39;</span><span class="p">,</span><span class="s">&#39;marks&#39;</span><span class="p">,</span><span class="s">&#39;t&#39;</span><span class="p">,</span><span class="s">&#39;tnodeList&#39;</span><span class="p">,</span>
            <span class="c"># &#39;vtag&#39;,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">checkOutlineBeforeSave</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getBool</span><span class="p">(</span>
            <span class="s">&#39;check_outline_before_save&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initIvars</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20090218115025.5: *3* fc.initIvars</span>
<div class="viewcode-block" id="baseFileCommands.initIvars"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.initIvars">[docs]</a>    <span class="k">def</span> <span class="nf">initIvars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># General</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mFileName</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fileDate</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leo_file_encoding</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">new_leo_file_encoding</span>

        <span class="c"># The bin param doesn&#39;t exist in Python 2.3;</span>
        <span class="c"># the protocol param doesn&#39;t exist in earlier versions of Python.</span>
        <span class="c"># version = &#39;.&#39;.join([str(sys.version_info[i]) for i in (0,1)])</span>

        <span class="c"># For reading</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checking</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># True: checking only: do *not* alter the outline.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descendentExpandedList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descendentMarksList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forbiddenTnodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descendentTnodeUaDictList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descendentVnodeUaDictList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ratio</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentVnode</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rootVnode</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># For writing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rootPosition</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">openDirectory</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">putCount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c"># self.topVnode = None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toString</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">usingClipboard</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentPosition</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c"># New in 3.12</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">copiedTree</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gnxDict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c"># keys are gnx strings as returned by canonicalTnodeIndex.</span>
            <span class="c"># Values are vnodes.</span>
            <span class="c"># 2011/12/10: This dict is never re-inited.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vnodesDict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c"># keys are gnx strings; values are ignored</span>
    <span class="c">#@+node:ekr.20031218072017.3020: ** Reading</span>
    <span class="c">#@+node:ekr.20060919104836: *3*  Top-level</span>
    <span class="c">#@+node:ekr.20070919133659.1: *4* fc.checkLeoFile</span></div>
<div class="viewcode-block" id="baseFileCommands.checkLeoFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.checkLeoFile">[docs]</a>    <span class="k">def</span> <span class="nf">checkLeoFile</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;The check-leo-file command.&#39;&#39;&#39;</span>

        <span class="n">fc</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="c"># Put the body (minus the @nocolor) into the file buffer.</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span> <span class="p">;</span> <span class="n">tag</span> <span class="o">=</span> <span class="s">&#39;@nocolor</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">tag</span><span class="p">):</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">tag</span><span class="p">):]</span>

        <span class="c"># Do a trial read.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checking</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initReadIvars</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">loading</span> <span class="o">=</span> <span class="bp">True</span> <span class="c"># disable c.changed</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">theFile</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadManager</span><span class="o">.</span><span class="n">openLeoOrZipFile</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">readSaxFile</span><span class="p">(</span>
                    <span class="n">theFile</span><span class="p">,</span><span class="n">fileName</span><span class="o">=</span><span class="s">&#39;check-leo-file&#39;</span><span class="p">,</span>
                    <span class="n">silent</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">inClipboard</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">reassignIndices</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&#39;check-leo-file passed&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">junk</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">junk</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
                <span class="c"># g.es_exception()</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;check-leo-file failed:&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">checking</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">c</span><span class="o">.</span><span class="n">loading</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># reenable c.changed</span>
    <span class="c">#@+node:ekr.20031218072017.1559: *4* fc.getLeoOutlineFromClipboard &amp; helpers</span></div>
<div class="viewcode-block" id="baseFileCommands.getLeoOutlineFromClipboard"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.getLeoOutlineFromClipboard">[docs]</a>    <span class="k">def</span> <span class="nf">getLeoOutlineFromClipboard</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">reassignIndices</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Read a Leo outline from string s in clipboard format.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">current</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span> <span class="p">;</span> <span class="n">check</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">reassignIndices</span>
        <span class="n">checkAfterRead</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getBool</span><span class="p">(</span><span class="s">&#39;check_outline_after_read&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initReadIvars</span><span class="p">()</span> <span class="c"># 2010/02/05</span>

        <span class="c"># Save the hidden root&#39;s children.</span>
        <span class="n">children</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">hiddenRootNode</span><span class="o">.</span><span class="n">children</span>

        <span class="c"># 2011/12/10: never recreate the gnxDict.</span>
            <span class="c"># self.gnxDict = {}</span>

        <span class="c"># 2011/12/12: save and clear gnxDict.</span>
        <span class="c"># This ensures that new indices will be used for all nodes.</span>
        <span class="k">if</span> <span class="n">reassignIndices</span><span class="p">:</span>
            <span class="n">oldGnxDict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gnxDict</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gnxDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Make sure all pasted nodes are entered into the gnxDict.</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">nodeIndices</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">all_unique_nodes</span><span class="p">():</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">fileIndex</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gnxDict</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">usingClipboard</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># This encoding must match the encoding used in putLeoOutline.</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">leo_file_encoding</span><span class="p">,</span><span class="n">reportErrors</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

            <span class="c"># readSaxFile modifies the hidden root.</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readSaxFile</span><span class="p">(</span>
                <span class="n">theFile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">fileName</span><span class="o">=</span><span class="s">&#39;&lt;clipboard&gt;&#39;</span><span class="p">,</span>
                <span class="n">silent</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="c"># don&#39;t tell about stylesheet elements.</span>
                <span class="n">inClipboard</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">reassignIndices</span><span class="o">=</span><span class="n">reassignIndices</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;the clipboard is not valid &quot;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;blue&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">usingClipboard</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># Restore the hidden root&#39;s children</span>
        <span class="n">c</span><span class="o">.</span><span class="n">hiddenRootNode</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="n">children</span>

        <span class="c"># Unlink v from the hidden root.</span>
        <span class="n">v</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">hiddenRootNode</span><span class="p">)</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">leoNodes</span><span class="o">.</span><span class="n">position</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

        <span class="c"># Important: we must not adjust links when linking v</span>
        <span class="c"># into the outline.  The read code has already done that.</span>
        <span class="k">if</span> <span class="n">current</span><span class="o">.</span><span class="n">hasChildren</span><span class="p">()</span> <span class="ow">and</span> <span class="n">current</span><span class="o">.</span><span class="n">isExpanded</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">check</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkPaste</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="n">p</span><span class="o">.</span><span class="n">_linkAsNthChild</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">adjust</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">check</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkPaste</span><span class="p">(</span><span class="n">current</span><span class="o">.</span><span class="n">parent</span><span class="p">(),</span><span class="n">p</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="n">p</span><span class="o">.</span><span class="n">_linkAfter</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="n">adjust</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">reassignIndices</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gnxDict</span> <span class="o">=</span> <span class="n">oldGnxDict</span>
                <span class="c"># 2011/12/12: restore gnxDict.</span>
            <span class="k">for</span> <span class="n">p2</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">self_and_subtree</span><span class="p">():</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">p2</span><span class="o">.</span><span class="n">v</span>
                <span class="n">v</span><span class="o">.</span><span class="n">fileIndex</span> <span class="o">=</span> <span class="n">index</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">nodeIndices</span><span class="o">.</span><span class="n">getNewIndex</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gnxDict</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;**** dumping outline...&#39;</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">dumpOutline</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">checkAfterRead</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&#39;checking outline after paste&#39;</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">checkOutline</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">unittest</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">full</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initReadIvars</span><span class="p">()</span> <span class="c"># 2010/02/05</span>
        <span class="k">return</span> <span class="n">p</span>
</div>
    <span class="n">getLeoOutline</span> <span class="o">=</span> <span class="n">getLeoOutlineFromClipboard</span> <span class="c"># for compatibility</span>
    <span class="c">#@+node:ekr.20080410115129.1: *5* checkPaste</span>
<div class="viewcode-block" id="baseFileCommands.checkPaste"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.checkPaste">[docs]</a>    <span class="k">def</span> <span class="nf">checkPaste</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return True if p may be pasted as a child of parent.&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">parent</span><span class="p">:</span> <span class="k">return</span> <span class="bp">True</span>

        <span class="n">parents</span> <span class="o">=</span> <span class="p">[</span><span class="n">z</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">parent</span><span class="o">.</span><span class="n">self_and_parents</span><span class="p">()]</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">self_and_subtree</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">:</span>
                <span class="c"># g.trace(p.h,id(p.v),id(z.v))</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="o">==</span> <span class="n">z</span><span class="o">.</span><span class="n">v</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;Invalid paste: nodes may not descend from themselves&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">False</span>

        <span class="k">return</span> <span class="bp">True</span>
    <span class="c">#@+node:ekr.20031218072017.1553: *4* fc.getLeoFile &amp; helpers</span>
    <span class="c"># The caller should follow this with a call to c.redraw().</span>
</div>
<div class="viewcode-block" id="baseFileCommands.getLeoFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.getLeoFile">[docs]</a>    <span class="k">def</span> <span class="nf">getLeoFile</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">theFile</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span><span class="n">readAtFileNodesFlag</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">silent</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="c"># g.trace(&#39;*****&#39;,fileName)</span>
        <span class="n">fc</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span> <span class="c"># May be set when reading @file nodes.</span>
        <span class="n">fc</span><span class="o">.</span><span class="n">warnOnReadOnlyFiles</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
        <span class="n">fc</span><span class="o">.</span><span class="n">checking</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">fc</span><span class="o">.</span><span class="n">mFileName</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">mFileName</span>
        <span class="n">fc</span><span class="o">.</span><span class="n">initReadIvars</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">loading</span> <span class="o">=</span> <span class="bp">True</span> <span class="c"># disable c.changed</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">silent</span> <span class="k">else</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">checkForOpenFile</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">getLeoFileHelper</span><span class="p">(</span><span class="n">theFile</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span><span class="n">silent</span><span class="p">)</span>
                    <span class="c"># Read the .leo file and create the outline.</span>

                <span class="c"># Remember the open file.</span>
                <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">rememberOpenFile</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fc</span><span class="o">.</span><span class="n">mFileName</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">mFileName</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="c"># Bug fix. Clear the fileName so forgetOpenFile doesn&#39;t remove it.</span>

            <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                <span class="n">fc</span><span class="o">.</span><span class="n">resolveTnodeLists</span><span class="p">()</span>
                    <span class="c"># Do this before reading external files.</span>
                <span class="n">c</span><span class="o">.</span><span class="n">setFileTimeStamp</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">readAtFileNodesFlag</span><span class="p">:</span>
                    <span class="c"># Redraw before reading the @file nodes so the screen isn&#39;t blank.</span>
                    <span class="c"># This is important for big files like LeoPy.leo.</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>
                    <span class="n">fc</span><span class="o">.</span><span class="n">readExternalFiles</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getBool</span><span class="p">(</span><span class="s">&#39;check_outline_after_read&#39;</span><span class="p">):</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">checkOutline</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">unittest</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">full</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">loading</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># reenable c.changed</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">changed</span><span class="p">:</span>
            <span class="n">fc</span><span class="o">.</span><span class="n">propegateDirtyNodes</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">changed</span><span class="p">)</span> <span class="c"># Refresh the changed marker.</span>
        <span class="n">fc</span><span class="o">.</span><span class="n">initReadIvars</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ok</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">ratio</span>
    <span class="c">#@+node:ekr.20090526081836.5841: *5* fc.getLeoFileHelper</span></div>
<div class="viewcode-block" id="baseFileCommands.getLeoFileHelper"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.getLeoFileHelper">[docs]</a>    <span class="k">def</span> <span class="nf">getLeoFileHelper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">theFile</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span><span class="n">silent</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Read the .leo file and create the outline.&#39;&#39;&#39;</span>

        <span class="n">c</span><span class="p">,</span><span class="n">fc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">,</span><span class="bp">self</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">readSaxFile</span><span class="p">(</span><span class="n">theFile</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span><span class="n">silent</span><span class="p">,</span><span class="n">inClipboard</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">reassignIndices</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">:</span> <span class="c"># v is None for minimal .leo files.</span>
                <span class="n">c</span><span class="o">.</span><span class="n">setRootVnode</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="n">fc</span><span class="o">.</span><span class="n">rootVnode</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">leoNodes</span><span class="o">.</span><span class="n">vnode</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
                <span class="n">v</span><span class="o">.</span><span class="n">setHeadString</span><span class="p">(</span><span class="s">&#39;created root node&#39;</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">leoNodes</span><span class="o">.</span><span class="n">position</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">_linkAsRoot</span><span class="p">(</span><span class="n">oldRoot</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
                <span class="n">fc</span><span class="o">.</span><span class="n">rootVnode</span> <span class="o">=</span> <span class="n">v</span>
                <span class="c"># c.setRootPosition()</span>
                <span class="n">c</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">except</span> <span class="n">BadLeoFile</span><span class="p">:</span>
            <span class="n">junk</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">junk</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
                <span class="n">c</span><span class="o">.</span><span class="n">alert</span><span class="p">(</span><span class="n">fc</span><span class="o">.</span><span class="n">mFileName</span> <span class="o">+</span> <span class="s">&quot; is not a valid Leo file: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">return</span> <span class="n">ok</span>
    <span class="c">#@+node:ekr.20100205060712.8314: *5* fc.handleNodeConflicts &amp; helper</span></div>
<div class="viewcode-block" id="baseFileCommands.handleNodeConflicts"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.handleNodeConflicts">[docs]</a>    <span class="k">def</span> <span class="nf">handleNodeConflicts</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">nodeConflictList</span><span class="p">:</span> <span class="k">return</span>

        <span class="c"># Find the last top-level node.</span>
        <span class="n">sib</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">sib</span><span class="o">.</span><span class="n">hasNext</span><span class="p">():</span>
            <span class="n">sib</span><span class="o">.</span><span class="n">moveToNext</span><span class="p">()</span>

        <span class="c"># Create the &#39;Recovered Nodes&#39; node.</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">sib</span><span class="o">.</span><span class="n">insertAfter</span><span class="p">()</span>
        <span class="n">root</span><span class="o">.</span><span class="n">setHeadString</span><span class="p">(</span><span class="s">&#39;Recovered Nodes&#39;</span><span class="p">)</span>
        <span class="n">root</span><span class="o">.</span><span class="n">expand</span><span class="p">()</span>

        <span class="c"># For each conflict, create one child and two grandchildren.</span>
        <span class="k">for</span> <span class="n">bunch</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">nodeConflictList</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">bunch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;tag&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
            <span class="n">gnx</span> <span class="o">=</span> <span class="n">bunch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;gnx&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
            <span class="n">fn</span>  <span class="o">=</span> <span class="n">bunch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;fileName&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
            <span class="n">b1</span><span class="p">,</span><span class="n">h1</span> <span class="o">=</span> <span class="n">bunch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;b_old&#39;</span><span class="p">),</span><span class="n">bunch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;h_old&#39;</span><span class="p">)</span>
            <span class="n">b2</span><span class="p">,</span><span class="n">h2</span> <span class="o">=</span> <span class="n">bunch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;b_new&#39;</span><span class="p">),</span><span class="n">bunch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;h_new&#39;</span><span class="p">)</span>
            <span class="n">child</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">insertAsLastChild</span><span class="p">()</span>
            <span class="n">h</span> <span class="o">=</span> <span class="s">&#39;Recovered node &quot;</span><span class="si">%s</span><span class="s"> from </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">h1</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>
            <span class="n">child</span><span class="o">.</span><span class="n">setHeadString</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
            <span class="c"># child.setBodyString(&#39;%s %s&#39; % (tag,gnx))</span>
            <span class="n">line1</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="se">\n</span><span class="s">Diff...</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="n">gnx</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">Differ</span><span class="p">()</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">b2</span><span class="p">),</span><span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">b1</span><span class="p">))</span>
            <span class="c"># d = difflib.unified_diff(g.splitLines(b2),g.splitLines(b1))</span>
            <span class="n">diffLines</span> <span class="o">=</span> <span class="p">[</span><span class="n">z</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">d</span><span class="p">]</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line1</span><span class="p">]</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">diffLines</span><span class="p">)</span>
            <span class="c"># There is less need to show trailing newlines because</span>
            <span class="c"># we don&#39;t report changes involving only trailing newlines.</span>
            <span class="n">child</span><span class="o">.</span><span class="n">setBodyString</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span> <span class="c"># .replace(&#39;\n&#39;,&#39;\\n\n&#39;))</span>
            <span class="n">n1</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">insertAsNthChild</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">n2</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">insertAsNthChild</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">n1</span><span class="o">.</span><span class="n">setHeadString</span><span class="p">(</span><span class="s">&#39;old:&#39;</span><span class="o">+</span><span class="n">h1</span><span class="p">)</span>
            <span class="n">n1</span><span class="o">.</span><span class="n">setBodyString</span><span class="p">(</span><span class="n">b1</span><span class="p">)</span>
            <span class="n">n2</span><span class="o">.</span><span class="n">setHeadString</span><span class="p">(</span><span class="s">&#39;new:&#39;</span><span class="o">+</span><span class="n">h2</span><span class="p">)</span>
            <span class="n">n2</span><span class="o">.</span><span class="n">setBodyString</span><span class="p">(</span><span class="n">b2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">root</span>
    <span class="c">#@+node:ekr.20100701112151.5959: *6* getDiff</span></div>
<div class="viewcode-block" id="baseFileCommands.getDiff"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.getDiff">[docs]</a>    <span class="k">def</span> <span class="nf">getDiff</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">):</span>

        <span class="c"># pylint: disable=E1120</span>
        <span class="c"># E1120:getDiff: No value passed for parameter &#39;b&#39; in function call</span>

        <span class="n">lines1</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">s1</span><span class="p">)</span>
        <span class="n">lines2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span>
        <span class="n">diffLines</span> <span class="o">=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">Differ</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">lines1</span><span class="p">,</span><span class="n">lines2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">diffLines</span>
    <span class="c">#@+node:ekr.20100124110832.6212: *5* fc.propegateDirtyNodes</span></div>
<div class="viewcode-block" id="baseFileCommands.propegateDirtyNodes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.propegateDirtyNodes">[docs]</a>    <span class="k">def</span> <span class="nf">propegateDirtyNodes</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">fc</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">c</span>

        <span class="n">aList</span> <span class="o">=</span> <span class="p">[</span><span class="n">z</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">all_positions</span><span class="p">()</span> <span class="k">if</span> <span class="n">z</span><span class="o">.</span><span class="n">isDirty</span><span class="p">()]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">setAllAncestorAtFileNodesDirty</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20120212220616.10537: *5* fc.readExternalFiles</span></div>
<div class="viewcode-block" id="baseFileCommands.readExternalFiles"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.readExternalFiles">[docs]</a>    <span class="k">def</span> <span class="nf">readExternalFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="p">):</span>

        <span class="n">c</span><span class="p">,</span><span class="n">fc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">,</span><span class="bp">self</span>

        <span class="n">c</span><span class="o">.</span><span class="n">atFileCommands</span><span class="o">.</span><span class="n">readAll</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">rootVnode</span><span class="p">(),</span><span class="n">partialFlag</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">recoveryNode</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">handleNodeConflicts</span><span class="p">()</span>

        <span class="c"># Do this after reading external files.</span>
        <span class="c"># The descendent nodes won&#39;t exist unless we have read the @thin nodes!</span>
        <span class="n">fc</span><span class="o">.</span><span class="n">restoreDescendentAttributes</span><span class="p">()</span>

        <span class="n">fc</span><span class="o">.</span><span class="n">setPositionsFromVnodes</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">selectVnode</span><span class="p">(</span><span class="n">recoveryNode</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">)</span> <span class="c"># load body pane</span>
    <span class="c">#@+node:ekr.20031218072017.1554: *5* fc.warnOnReadOnlyFiles</span></div>
<div class="viewcode-block" id="baseFileCommands.warnOnReadOnlyFiles"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.warnOnReadOnlyFiles">[docs]</a>    <span class="k">def</span> <span class="nf">warnOnReadOnlyFiles</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="p">):</span>

        <span class="c"># os.access may not exist on all platforms.</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">except</span> <span class="ne">UnicodeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;read only:&quot;</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.3029: *4* fc.readAtFileNodes</span></div>
<div class="viewcode-block" id="baseFileCommands.readAtFileNodes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.readAtFileNodes">[docs]</a>    <span class="k">def</span> <span class="nf">readAtFileNodes</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">atFileCommands</span><span class="o">.</span><span class="n">readAll</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">partialFlag</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>

        <span class="c"># Force an update of the body pane.</span>
        <span class="n">c</span><span class="o">.</span><span class="n">setBodyString</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">onBodyChanged</span><span class="p">(</span><span class="n">undoType</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2297: *4* fc.openLeoFile</span></div>
<div class="viewcode-block" id="baseFileCommands.openLeoFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.openLeoFile">[docs]</a>    <span class="k">def</span> <span class="nf">openLeoFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">theFile</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span><span class="n">readAtFileNodesFlag</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">silent</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span>

        <span class="c"># Set c.openDirectory</span>
        <span class="n">theDir</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_dirname</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">theDir</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">openDirectory</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">openDirectory</span> <span class="o">=</span> <span class="n">theDir</span>

        <span class="n">ok</span><span class="p">,</span> <span class="n">ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getLeoFile</span><span class="p">(</span>
            <span class="n">theFile</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span>
            <span class="n">readAtFileNodesFlag</span><span class="o">=</span><span class="n">readAtFileNodesFlag</span><span class="p">,</span>
            <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">resizePanesToRatio</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span><span class="n">frame</span><span class="o">.</span><span class="n">secondary_ratio</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ok</span>
    <span class="c">#@+node:ekr.20031218072017.3030: *4* readOutlineOnly</span></div>
<div class="viewcode-block" id="baseFileCommands.readOutlineOnly"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.readOutlineOnly">[docs]</a>    <span class="k">def</span> <span class="nf">readOutlineOnly</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">theFile</span><span class="p">,</span><span class="n">fileName</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>

        <span class="c">#@+&lt;&lt; Set the default directory &gt;&gt;</span>
        <span class="c">#@+node:ekr.20071211134300: *5* &lt;&lt; Set the default directory &gt;&gt;</span>
        <span class="c">#@+at</span>
        <span class="c"># The most natural default directory is the directory containing the .leo file</span>
        <span class="c"># that we are about to open. If the user has specified the &quot;Default Directory&quot;</span>
        <span class="c"># preference that will over-ride what we are about to set.</span>
        <span class="c">#@@c</span>

        <span class="n">theDir</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_dirname</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">theDir</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">openDirectory</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">openDirectory</span> <span class="o">=</span> <span class="n">theDir</span>
        <span class="c">#@-&lt;&lt; Set the default directory &gt;&gt;</span>
        <span class="n">ok</span><span class="p">,</span> <span class="n">ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getLeoFile</span><span class="p">(</span><span class="n">theFile</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span><span class="n">readAtFileNodesFlag</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>

        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">deiconify</span><span class="p">()</span>
        <span class="n">junk</span><span class="p">,</span><span class="n">junk</span><span class="p">,</span><span class="n">secondary_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">initialRatios</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">resizePanesToRatio</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span><span class="n">secondary_ratio</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ok</span>
    <span class="c">#@+node:ekr.20060919133249: *3* Common</span>
    <span class="c"># Methods common to both the sax and non-sax code.</span>
    <span class="c">#@+node:ekr.20031218072017.2004: *4* fc.canonicalTnodeIndex</span></div>
<div class="viewcode-block" id="baseFileCommands.canonicalTnodeIndex"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.canonicalTnodeIndex">[docs]</a>    <span class="k">def</span> <span class="nf">canonicalTnodeIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">index</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Convert Tnnn to nnn, leaving gnx&#39;s unchanged.&quot;&quot;&quot;</span>

        <span class="c"># index might be Tnnn, nnn, or gnx.</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;Can not happen: index is None&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="n">junk</span><span class="p">,</span><span class="n">theTime</span><span class="p">,</span><span class="n">junk</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">nodeIndices</span><span class="o">.</span><span class="n">scanGnx</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">theTime</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> <span class="c"># A pre-4.1 file index.</span>
            <span class="k">if</span> <span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;T&quot;</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="k">return</span> <span class="n">index</span>
    <span class="c">#@+node:ekr.20040701065235.1: *4* fc.getDescendentAttributes</span></div>
<div class="viewcode-block" id="baseFileCommands.getDescendentAttributes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.getDescendentAttributes">[docs]</a>    <span class="k">def</span> <span class="nf">getDescendentAttributes</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">tag</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;s is a list of gnx&#39;s, separated by commas from a &lt;v&gt; or &lt;t&gt; element.</span>
<span class="sd">        Parses s into a list.</span>

<span class="sd">        This is used to record marked and expanded nodes.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">gnxs</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">gnx</span> <span class="k">for</span> <span class="n">gnx</span> <span class="ow">in</span> <span class="n">gnxs</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gnx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="c"># g.trace(tag,result)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="c">#@+node:EKR.20040627114602: *4* fc.getDescendentUnknownAttributes</span>
    <span class="c"># Pre Leo 4.5 Only @thin vnodes had the descendentTnodeUnknownAttributes field.</span>
    <span class="c"># New in Leo 4.5: @thin &amp; @shadow vnodes have descendentVnodeUnknownAttributes field.</span>
</div>
<div class="viewcode-block" id="baseFileCommands.getDescendentUnknownAttributes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.getDescendentUnknownAttributes">[docs]</a>    <span class="k">def</span> <span class="nf">getDescendentUnknownAttributes</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Unhexlify and unpickle t/v.descendentUnknownAttribute field.&#39;&#39;&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c"># Changed in version 3.2: Accept only bytestring or bytearray objects as input.</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="c"># 2011/02/22</span>
            <span class="nb">bin</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="c"># Throws a TypeError if val is not a hex string.</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">bin</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">val</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;Can not unpickle&#39;</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">),</span><span class="n">v</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="n">s</span><span class="p">[:</span><span class="mi">40</span><span class="p">])</span>
            <span class="k">return</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20060919142200.1: *4* fc.initReadIvars</span></div>
<div class="viewcode-block" id="baseFileCommands.initReadIvars"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.initReadIvars">[docs]</a>    <span class="k">def</span> <span class="nf">initReadIvars</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">descendentTnodeUaDictList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descendentVnodeUaDictList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descendentExpandedList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descendentMarksList</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c"># 2011/12/10: never re-init this dict.</span>
            <span class="c"># self.gnxDict = {}</span>
            <span class="c"># g.trace(&#39;*** clearing gnxDict&#39;,g.callers())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">nodeConflictList</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># 2010/01/05</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">nodeConflictFileName</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># 2010/01/05</span>
    <span class="c">#@+node:EKR.20040627120120: *4* fc.restoreDescendentAttributes</span></div>
<div class="viewcode-block" id="baseFileCommands.restoreDescendentAttributes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.restoreDescendentAttributes">[docs]</a>    <span class="k">def</span> <span class="nf">restoreDescendentAttributes</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>

        <span class="k">for</span> <span class="n">resultDict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">descendentTnodeUaDictList</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;t.dict&#39;</span><span class="p">,</span><span class="n">resultDict</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">gnx</span> <span class="ow">in</span> <span class="n">resultDict</span><span class="p">:</span>
                <span class="n">tref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canonicalTnodeIndex</span><span class="p">(</span><span class="n">gnx</span><span class="p">)</span>
                <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gnxDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tref</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
                    <span class="n">v</span><span class="o">.</span><span class="n">unknownAttributes</span> <span class="o">=</span> <span class="n">resultDict</span><span class="p">[</span><span class="n">gnx</span><span class="p">]</span>
                    <span class="n">v</span><span class="o">.</span><span class="n">_p_changed</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s">&#39;restoreDescendantAttributes: &#39;</span>
                        <span class="s">&#39;can not find vnode (duA): gnx = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gnx</span><span class="p">))</span>

        <span class="c"># New in Leo 4.5: keys are archivedPositions, values are attributes.</span>
        <span class="k">for</span> <span class="n">root_v</span><span class="p">,</span><span class="n">resultDict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">descendentVnodeUaDictList</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;v.dict&#39;</span><span class="p">,</span><span class="n">resultDict</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">resultDict</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolveArchivedPosition</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">root_v</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
                    <span class="n">v</span><span class="o">.</span><span class="n">unknownAttributes</span> <span class="o">=</span> <span class="n">resultDict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="n">v</span><span class="o">.</span><span class="n">_p_changed</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s">&#39;restoreDescendantAttributes: &#39;</span>
                        <span class="s">&#39;can not find vnode (duA): archivedPosition: </span><span class="si">%s</span><span class="s">, root_v: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">key</span><span class="p">,</span><span class="n">root_v</span><span class="p">))</span>

        <span class="n">marks</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">;</span> <span class="n">expanded</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">gnx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">descendentExpandedList</span><span class="p">:</span>
            <span class="n">tref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canonicalTnodeIndex</span><span class="p">(</span><span class="n">gnx</span><span class="p">)</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gnxDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gnx</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
                <span class="n">expanded</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">=</span><span class="n">v</span>
                <span class="c"># if trace: g.trace(&#39;expanded&#39;,v)</span>
            <span class="k">elif</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s">&#39;restoreDescendantAttributes: &#39;</span>
                    <span class="s">&#39;can not find vnode (expanded): gnx = </span><span class="si">%s</span><span class="s">, tref: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gnx</span><span class="p">,</span><span class="n">tref</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">gnx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">descendentMarksList</span><span class="p">:</span>
            <span class="n">tref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canonicalTnodeIndex</span><span class="p">(</span><span class="n">gnx</span><span class="p">)</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gnxDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gnx</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">:</span> <span class="n">marks</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">=</span><span class="n">v</span>
            <span class="k">elif</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s">&#39;restoreDescendantAttributes: &#39;</span>
                    <span class="s">&#39;can not find vnode (marks): gnx = </span><span class="si">%s</span><span class="s"> tref: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gnx</span><span class="p">,</span><span class="n">tref</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">marks</span> <span class="ow">or</span> <span class="n">expanded</span><span class="p">:</span>
            <span class="c"># g.trace(&#39;marks&#39;,len(marks),&#39;expanded&#39;,len(expanded))</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">all_unique_positions</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">marks</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">):</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">initMarkedBit</span><span class="p">()</span>
                        <span class="c"># This was the problem: was p.setMark.</span>
                        <span class="c"># There was a big performance bug in the mark hook in the Node Navigator plugin.</span>
                <span class="k">if</span> <span class="n">expanded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">):</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">expand</span><span class="p">()</span>
                    <span class="c"># if trace: g.trace(&#39;expand&#39;,p.h)</span>
    <span class="c">#@+node:ekr.20060919104530: *3* Sax (reading)</span>
    <span class="c">#@+node:ekr.20090525144314.6526: *4* cleanSaxInputString</span></div>
<div class="viewcode-block" id="baseFileCommands.cleanSaxInputString"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.cleanSaxInputString">[docs]</a>    <span class="k">def</span> <span class="nf">cleanSaxInputString</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Clean control characters from s.</span>
<span class="sd">        s may be a bytes or a (unicode) string.&#39;&#39;&#39;</span>

        <span class="c"># Note: form-feed (&#39;\f&#39;) is 12 decimal.</span>
        <span class="n">badchars</span> <span class="o">=</span> <span class="p">[</span><span class="nb">chr</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">32</span><span class="p">)]</span>
        <span class="n">badchars</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">badchars</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\r</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">badchars</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

        <span class="n">flatten</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">badchars</span><span class="p">)</span>
        <span class="n">pad</span> <span class="o">=</span> <span class="s">&#39; &#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">flatten</span><span class="p">)</span>

        <span class="c"># pylint: disable=E1101</span>
        <span class="c"># E1101:cleanSaxInputString: Class &#39;str&#39; has no &#39;maketrans&#39; member</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
            <span class="n">flatten</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">flatten</span><span class="p">,</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="n">pad</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">pad</span><span class="p">,</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="n">transtable</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">maketrans</span><span class="p">(</span><span class="n">flatten</span><span class="p">,</span><span class="n">pad</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">transtable</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">maketrans</span><span class="p">(</span><span class="n">flatten</span><span class="p">,</span><span class="n">pad</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">transtable</span><span class="p">)</span>

    <span class="c"># for i in range(32): print i,repr(chr(i))</span>
    <span class="c">#@+node:ekr.20060919110638.5: *4* fc.createSaxChildren &amp; helpers</span></div>
<div class="viewcode-block" id="baseFileCommands.createSaxChildren"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.createSaxChildren">[docs]</a>    <span class="k">def</span> <span class="nf">createSaxChildren</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sax_node</span><span class="p">,</span> <span class="n">parent_v</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span> <span class="c"># and c.shortFileName().find(&#39;small&#39;) &gt; -1</span>
        <span class="n">children</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sax_child</span> <span class="ow">in</span> <span class="n">sax_node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="n">tnx</span> <span class="o">=</span> <span class="n">sax_child</span><span class="o">.</span><span class="n">tnx</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gnxDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tnx</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">:</span> <span class="c"># A clone.</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;**clone&#39;</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
                <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createSaxVnode</span><span class="p">(</span><span class="n">sax_child</span><span class="p">,</span><span class="n">parent_v</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>   
            <span class="k">else</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createSaxVnode</span><span class="p">(</span><span class="n">sax_child</span><span class="p">,</span><span class="n">parent_v</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">createSaxChildren</span><span class="p">(</span><span class="n">sax_child</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
            <span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">parent_v</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="n">children</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
            <span class="n">child</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parent_v</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
                <span class="s">&#39;*** added parent&#39;</span><span class="p">,</span><span class="n">parent_v</span><span class="p">,</span><span class="s">&#39;to&#39;</span><span class="p">,</span><span class="n">child</span><span class="p">,</span>
                <span class="s">&#39;len(child.parents)&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">parents</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">children</span>
    <span class="c">#@+node:ekr.20060919110638.7: *5* fc.createSaxVnode &amp; helpers</span></div>
<div class="viewcode-block" id="baseFileCommands.createSaxVnode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.createSaxVnode">[docs]</a>    <span class="k">def</span> <span class="nf">createSaxVnode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sax_node</span><span class="p">,</span><span class="n">parent_v</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;test&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">sax_node</span><span class="o">.</span><span class="n">headString</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">sax_node</span><span class="o">.</span><span class="n">bodyString</span>

        <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
            <span class="c"># The body of the later node overrides the earlier.</span>
            <span class="c"># Don&#39;t set t.h: h is always empty.</span>
            <span class="c"># This may be an internal error.</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">b</span> <span class="o">==</span> <span class="n">b</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
                    <span class="s">&#39;***no update</span><span class="se">\n</span><span class="s">old: </span><span class="si">%s</span><span class="se">\n</span><span class="s">new: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">b</span><span class="p">,</span><span class="n">b</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
                    <span class="s">&#39;***update</span><span class="se">\n</span><span class="s">old: </span><span class="si">%s</span><span class="se">\n</span><span class="s">new: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">b</span><span class="p">,</span><span class="n">b</span><span class="p">))</span>
                <span class="n">v</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">b</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">leoNodes</span><span class="o">.</span><span class="n">vnode</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
            <span class="n">v</span><span class="o">.</span><span class="n">setBodyString</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
            <span class="n">v</span><span class="o">.</span><span class="n">setHeadString</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">sax_node</span><span class="o">.</span><span class="n">tnx</span><span class="p">:</span>
                <span class="n">v</span><span class="o">.</span><span class="n">fileIndex</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">nodeIndices</span><span class="o">.</span><span class="n">scanGnx</span><span class="p">(</span><span class="n">sax_node</span><span class="o">.</span><span class="n">tnx</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canonicalTnodeIndex</span><span class="p">(</span><span class="n">sax_node</span><span class="o">.</span><span class="n">tnx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gnxDict</span> <span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
            <span class="s">&#39;tnx&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%-22s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="p">),</span><span class="s">&#39;v&#39;</span><span class="p">,</span><span class="nb">id</span><span class="p">(</span><span class="n">v</span><span class="p">),</span>
            <span class="s">&#39;len(body)&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%-4d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)),</span><span class="n">h</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">handleVnodeSaxAttributes</span><span class="p">(</span><span class="n">sax_node</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handleTnodeSaxAttributes</span><span class="p">(</span><span class="n">sax_node</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">v</span>
    <span class="c">#@+node:ekr.20060919110638.8: *6* handleTnodeSaxAttributes</span></div>
<div class="viewcode-block" id="baseFileCommands.handleTnodeSaxAttributes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.handleTnodeSaxAttributes">[docs]</a>    <span class="k">def</span> <span class="nf">handleTnodeSaxAttributes</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sax_node</span><span class="p">,</span><span class="n">v</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">sax_node</span><span class="o">.</span><span class="n">tnodeAttributes</span>
        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">d</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">sax_node</span><span class="p">,</span><span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

        <span class="n">aDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicode</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">))</span> <span class="c"># 2011/02/22</span>
            <span class="n">val2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSaxUa</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>
            <span class="c"># g.trace(key,val,val2)</span>
            <span class="n">aDict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val2</span>

        <span class="k">if</span> <span class="n">aDict</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;uA&#39;</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="nb">list</span><span class="p">(</span><span class="n">aDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="n">v</span><span class="o">.</span><span class="n">unknownAttributes</span> <span class="o">=</span> <span class="n">aDict</span>
    <span class="c">#@+node:ekr.20061004053644: *6* handleVnodeSaxAttributes</span>
    <span class="c"># The native attributes of &lt;v&gt; elements are a, t, vtag, tnodeList,</span>
    <span class="c"># marks, expanded, and descendentTnodeUnknownAttributes.</span>
    <span class="c"># New in Leo 4.5: added descendentVnodeUnknownAttributes to native attributes.</span>
</div>
<div class="viewcode-block" id="baseFileCommands.handleVnodeSaxAttributes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.handleVnodeSaxAttributes">[docs]</a>    <span class="k">def</span> <span class="nf">handleVnodeSaxAttributes</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sax_node</span><span class="p">,</span><span class="n">v</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">sax_node</span><span class="o">.</span><span class="n">attributes</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="s">&#39;E&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;expand&#39;</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
            <span class="c"># g.trace(&#39;%s a=%s %s&#39; % (id(sax_node),s,v.headString()))</span>
            <span class="c"># &#39;C&#39; (clone) and &#39;D&#39; bits are not used.</span>
            <span class="k">if</span> <span class="s">&#39;M&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">setMarked</span><span class="p">()</span>
            <span class="k">if</span> <span class="s">&#39;E&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">expand</span><span class="p">()</span>
            <span class="k">if</span> <span class="s">&#39;O&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">setOrphan</span><span class="p">()</span>
            <span class="c"># if &#39;T&#39; in s: self.topVnode = v</span>
            <span class="k">if</span> <span class="s">&#39;V&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
                <span class="c"># g.red(&#39;handleVnodeSaxAttributes: setting currentVnode&#39;,v)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">currentVnode</span> <span class="o">=</span> <span class="n">v</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;tnodeList&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">tnodeList</span> <span class="o">=</span> <span class="n">s</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tnodeList</span><span class="p">:</span>
            <span class="c"># This tnodeList will be resolved later.</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;found tnodeList&#39;</span><span class="p">,</span><span class="n">v</span><span class="o">.</span><span class="n">headString</span><span class="p">(),</span><span class="n">tnodeList</span><span class="p">)</span>
            <span class="n">v</span><span class="o">.</span><span class="n">tempTnodeList</span> <span class="o">=</span> <span class="n">tnodeList</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;descendentTnodeUnknownAttributes&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">:</span> 
            <span class="n">aDict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDescendentUnknownAttributes</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">aDict</span><span class="p">:</span>
                <span class="c"># g.trace(&#39;descendentTnodeUaDictList&#39;,aDict)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">descendentTnodeUaDictList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aDict</span><span class="p">)</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;descendentVnodeUnknownAttributes&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">:</span> 
            <span class="n">aDict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDescendentUnknownAttributes</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">aDict</span><span class="p">:</span>
                <span class="c"># g.trace(&#39;descendentVnodeUaDictList&#39;,aDict)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">descendentVnodeUaDictList</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">v</span><span class="p">,</span><span class="n">aDict</span><span class="p">),)</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;expanded&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">aList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDescendentAttributes</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">tag</span><span class="o">=</span><span class="s">&quot;expanded&quot;</span><span class="p">)</span>
            <span class="c"># g.trace(&#39;expanded list&#39;,len(aList))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">descendentExpandedList</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">aList</span><span class="p">)</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;marks&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">aList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDescendentAttributes</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">tag</span><span class="o">=</span><span class="s">&quot;marks&quot;</span><span class="p">)</span>
            <span class="c"># g.trace(&#39;marks list&#39;,len(aList))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">descendentMarksList</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">aList</span><span class="p">)</span>

        <span class="n">aDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nativeVnodeAttributes</span><span class="p">:</span>
                <span class="c"># This is not a bug.</span>
                <span class="k">if</span> <span class="bp">False</span> <span class="ow">and</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
                    <span class="s">&#39;****ignoring***&#39;</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">val2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getSaxUa</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>
                <span class="n">aDict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val2</span>
                <span class="c"># g.trace(key,val,val2)</span>
        <span class="k">if</span> <span class="n">aDict</span><span class="p">:</span>
            <span class="c"># if trace: g.trace(&#39;uA&#39;,v,aDict)</span>
            <span class="n">v</span><span class="o">.</span><span class="n">unknownAttributes</span> <span class="o">=</span> <span class="n">aDict</span>
    <span class="c">#@+node:ekr.20060919110638.2: *4* dumpSaxTree</span></div>
<div class="viewcode-block" id="baseFileCommands.dumpSaxTree"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.dumpSaxTree">[docs]</a>    <span class="k">def</span> <span class="nf">dumpSaxTree</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">root</span><span class="p">,</span><span class="n">dummy</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">root</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;dumpSaxTree: empty tree&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dummy</span><span class="p">:</span>
            <span class="n">root</span><span class="o">.</span><span class="n">dump</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumpSaxTree</span><span class="p">(</span><span class="n">child</span><span class="p">,</span><span class="n">dummy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20061003093021: *4* getSaxUa</span></div>
<div class="viewcode-block" id="baseFileCommands.getSaxUa"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.getSaxUa">[docs]</a>    <span class="k">def</span> <span class="nf">getSaxUa</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">attr</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span> <span class="c"># Kind is for unit testing.</span>

        <span class="sd">&quot;&quot;&quot;Parse an unknown attribute in a &lt;v&gt; or &lt;t&gt; element.</span>
<span class="sd">        The unknown tag has been pickled and hexlify&#39;d.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c"># val = str(val)</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="c"># 2011/02/22.</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;unexpected exception converting hexlified string to string&#39;</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="c"># New in 4.3: leave string attributes starting with &#39;str_&#39; alone.</span>
        <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;str_&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">val</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;&#39;</span><span class="p">):</span>
                <span class="c"># 2011/05/26.</span>
                <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicode</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

        <span class="c"># New in 4.3: convert attributes starting with &#39;b64_&#39; using the base64 conversion.</span>
        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># Not ready yet.</span>
            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;b64_&#39;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span> <span class="k">pass</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span> <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">binString</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">unhexlify</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="c"># Throws a TypeError if val is not a hex string.</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c"># Python 2.x throws TypeError</span>
            <span class="c"># Python 3.x throws binascii.Error</span>
            <span class="c"># Assume that Leo 4.1 wrote the attribute.</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;raw&#39;</span><span class="p">,</span><span class="s">&#39;unit test failed: kind=&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">kind</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;can not unhexlify </span><span class="si">%s</span><span class="s">=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span><span class="n">val</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">val</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># No change needed to support protocols.</span>
            <span class="n">val2</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">binString</span><span class="p">)</span>
            <span class="c"># g.trace(&#39;v.3 val:&#39;,val2)</span>
            <span class="k">return</span> <span class="n">val2</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">UnpicklingError</span><span class="p">,</span><span class="ne">ImportError</span><span class="p">,</span><span class="ne">AttributeError</span><span class="p">,</span><span class="ne">ValueError</span><span class="p">,</span><span class="ne">TypeError</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;can not unpickle </span><span class="si">%s</span><span class="s">=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attr</span><span class="p">,</span><span class="n">val</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">val</span>
    <span class="c">#@+node:ekr.20060919110638.14: *4* parse_leo_file</span></div>
<div class="viewcode-block" id="baseFileCommands.parse_leo_file"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.parse_leo_file">[docs]</a>    <span class="k">def</span> <span class="nf">parse_leo_file</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">theFile</span><span class="p">,</span><span class="n">inputFileName</span><span class="p">,</span><span class="n">silent</span><span class="p">,</span><span class="n">inClipboard</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">theFile</span><span class="p">:</span>
                    <span class="c"># Use the open binary file, opened by the caller.</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">theFile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="c"># type(s) is bytes.</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleanSaxInputString</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="n">theFile</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleanSaxInputString</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="n">theFile</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">theFile</span><span class="p">:</span> <span class="n">s</span> <span class="o">=</span> <span class="n">theFile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleanSaxInputString</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="n">theFile</span> <span class="o">=</span> <span class="n">cStringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">sax</span><span class="o">.</span><span class="n">make_parser</span><span class="p">()</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">setFeature</span><span class="p">(</span><span class="n">xml</span><span class="o">.</span><span class="n">sax</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">feature_external_ges</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="c"># Include external general entities, esp. xml-stylesheet lines.</span>
            <span class="k">if</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># Expat does not read external features.</span>
                <span class="n">parser</span><span class="o">.</span><span class="n">setFeature</span><span class="p">(</span><span class="n">xml</span><span class="o">.</span><span class="n">sax</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">feature_external_pes</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                    <span class="c"># Include all external parameter entities</span>
                    <span class="c"># Hopefully the parser can figure out the encoding from the &lt;?xml&gt; element.</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="n">saxContentHandler</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">inputFileName</span><span class="p">,</span><span class="n">silent</span><span class="p">,</span><span class="n">inClipboard</span><span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">setContentHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">theFile</span><span class="p">)</span> <span class="c"># expat does not support parseString</span>
            <span class="c"># g.trace(&#39;parsing done&#39;)</span>
            <span class="n">sax_node</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">getRootNode</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;error parsing&#39;</span><span class="p">,</span><span class="n">inputFileName</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
            <span class="n">sax_node</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">return</span> <span class="n">sax_node</span>
    <span class="c">#@+node:ekr.20060919110638.3: *4* readSaxFile</span></div>
<div class="viewcode-block" id="baseFileCommands.readSaxFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.readSaxFile">[docs]</a>    <span class="k">def</span> <span class="nf">readSaxFile</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">theFile</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span><span class="n">silent</span><span class="p">,</span><span class="n">inClipboard</span><span class="p">,</span><span class="n">reassignIndices</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">dump</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">fc</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">c</span>

        <span class="c"># Pass one: create the intermediate nodes.</span>
        <span class="n">saxRoot</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">parse_leo_file</span><span class="p">(</span><span class="n">theFile</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span>
            <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">,</span><span class="n">inClipboard</span><span class="o">=</span><span class="n">inClipboard</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dump</span><span class="p">:</span> <span class="n">fc</span><span class="o">.</span><span class="n">dumpSaxTree</span><span class="p">(</span><span class="n">saxRoot</span><span class="p">,</span><span class="n">dummy</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c"># Pass two: create the tree of vnodes from the intermediate nodes.</span>
        <span class="k">if</span> <span class="n">saxRoot</span><span class="p">:</span>
            <span class="n">parent_v</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">hiddenRootNode</span>
            <span class="n">children</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">createSaxChildren</span><span class="p">(</span><span class="n">saxRoot</span><span class="p">,</span><span class="n">parent_v</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">c</span><span class="o">.</span><span class="n">hiddenRootNode</span><span class="o">.</span><span class="n">children</span> <span class="o">==</span> <span class="n">children</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">children</span> <span class="ow">and</span> <span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">None</span>
            <span class="k">return</span> <span class="n">v</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20060919110638.11: *4* resolveTnodeLists</span></div>
<div class="viewcode-block" id="baseFileCommands.resolveTnodeLists"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.resolveTnodeLists">[docs]</a>    <span class="k">def</span> <span class="nf">resolveTnodeLists</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">all_unique_positions</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;tempTnodeList&#39;</span><span class="p">):</span>
                <span class="c"># g.trace(p.v.headString())</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">tnx</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">tempTnodeList</span><span class="p">:</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canonicalTnodeIndex</span><span class="p">(</span><span class="n">tnx</span><span class="p">)</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gnxDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">tnx</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;*** No vnode for </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">tnx</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">tnodeList</span> <span class="o">=</span> <span class="n">result</span>
                    <span class="c"># g.trace(&#39;*** tnodeList for&#39;,p.h,result)</span>
                <span class="nb">delattr</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;tempTnodeList&#39;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20080805132422.3: *4* resolveArchivedPosition</span></div>
<div class="viewcode-block" id="baseFileCommands.resolveArchivedPosition"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.resolveArchivedPosition">[docs]</a>    <span class="k">def</span> <span class="nf">resolveArchivedPosition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">archivedPosition</span><span class="p">,</span><span class="n">root_v</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return a vnode corresponding to the archived position relative to root node root_v.&#39;&#39;&#39;</span>

        <span class="k">def</span> <span class="nf">oops</span> <span class="p">(</span><span class="n">message</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;bad archived position: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">message</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">aList</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">archivedPosition</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)]</span>
            <span class="n">aList</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">oops</span><span class="p">(</span><span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">archivedPosition</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">aList</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">oops</span><span class="p">(</span><span class="s">&#39;empty&#39;</span><span class="p">)</span>

        <span class="n">last_v</span> <span class="o">=</span> <span class="n">root_v</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">aList</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">oops</span><span class="p">(</span><span class="s">&#39;root index=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">n</span> <span class="p">)</span>

        <span class="k">while</span> <span class="n">aList</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">aList</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">children</span> <span class="o">=</span> <span class="n">last_v</span><span class="o">.</span><span class="n">children</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">children</span><span class="p">):</span>
                <span class="n">last_v</span> <span class="o">=</span> <span class="n">children</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">oops</span><span class="p">(</span><span class="s">&#39;bad index=&quot;</span><span class="si">%s</span><span class="s">&quot;, len(children)=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">children</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">last_v</span>
    <span class="c">#@+node:ekr.20060919110638.13: *4* setPositionsFromVnodes &amp; helper (sax read)</span></div>
<div class="viewcode-block" id="baseFileCommands.setPositionsFromVnodes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.setPositionsFromVnodes">[docs]</a>    <span class="k">def</span> <span class="nf">setPositionsFromVnodes</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span>
        <span class="n">current</span><span class="p">,</span><span class="n">str_pos</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span><span class="bp">None</span>

        <span class="n">use_db</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">enableDB</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">mFileName</span>
        <span class="k">if</span> <span class="n">use_db</span><span class="p">:</span>
            <span class="n">str_pos</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">cacher</span><span class="o">.</span><span class="n">getCachedStringPosition</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">str_pos</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;unknownAttributes&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">unknownAttributes</span>
            <span class="k">if</span> <span class="n">d</span><span class="p">:</span> <span class="n">str_pos</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;str_leo_pos&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;from p.v.u&#39;</span><span class="p">,</span><span class="n">str_pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">str_pos</span><span class="p">:</span>
            <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">archivedPositionToPosition</span><span class="p">(</span><span class="n">str_pos</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">setCurrentPosition</span><span class="p">(</span><span class="n">current</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">())</span>
    <span class="c">#@+node:ekr.20061006104837.1: *5* archivedPositionToPosition</span></div>
<div class="viewcode-block" id="baseFileCommands.archivedPositionToPosition"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.archivedPositionToPosition">[docs]</a>    <span class="k">def</span> <span class="nf">archivedPositionToPosition</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicode</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="c"># 2011/02/25</span>
        <span class="n">aList</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">aList</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c"># g.trace(&#39;oops: bad archived position. not an int:&#39;,aList,c)</span>
            <span class="n">aList</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">aList</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span> <span class="p">;</span> <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">level</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">aList</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">aList</span><span class="p">[</span><span class="n">level</span><span class="p">]</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">hasNext</span><span class="p">():</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">moveToNext</span><span class="p">()</span>
                    <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># g.trace(&#39;oops: bad archived position. no sibling:&#39;,aList,p.h,c)</span>
                    <span class="k">return</span> <span class="bp">None</span>
            <span class="n">level</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">level</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">aList</span><span class="p">):</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToFirstChild</span><span class="p">()</span>
                <span class="c"># g.trace(&#39;level&#39;,level,&#39;index&#39;,aList[level],p.h)</span>
        <span class="k">return</span> <span class="n">p</span>
    <span class="c">#@+node:ekr.20031218072017.3032: ** Writing</span>
    <span class="c">#@+node:ekr.20070413045221.2: *3*  Top-level  (leoFileCommands)</span>
    <span class="c">#@+node:ekr.20031218072017.1720: *4* save (fileCommands)</span></div>
<div class="viewcode-block" id="baseFileCommands.save"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span><span class="n">silent</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">v</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">currentVnode</span><span class="p">()</span>

        <span class="c"># New in 4.2.  Return ok flag so shutdown logic knows if all went well.</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&quot;save1&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">v</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span><span class="n">fileName</span><span class="o">=</span><span class="n">fileName</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ok</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span> <span class="c"># Set the current headline text.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setDefaultDirectoryForNewFiles</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">cacher</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">changeName</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">checkFileTimeStamp</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_Leo_file</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span> <span class="c"># outlineOnlyFlag</span>
            <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">putSavedMessage</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
                <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span> <span class="c"># Clears all dirty bits.</span>
                <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">save_clears_undo_buffer</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;clearing undo&quot;</span><span class="p">)</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">undoer</span><span class="o">.</span><span class="n">clearUndoState</span><span class="p">()</span>

            <span class="n">c</span><span class="o">.</span><span class="n">redraw_after_icons_changed</span><span class="p">()</span>

        <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&quot;save2&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">v</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span><span class="n">fileName</span><span class="o">=</span><span class="n">fileName</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ok</span>
    <span class="c">#@+node:ekr.20031218072017.3043: *4* saveAs (leoFileCommands)</span></div>
<div class="viewcode-block" id="baseFileCommands.saveAs"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.saveAs">[docs]</a>    <span class="k">def</span> <span class="nf">saveAs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">v</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">currentVnode</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&quot;save1&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">v</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span><span class="n">fileName</span><span class="o">=</span><span class="n">fileName</span><span class="p">):</span>
            <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span> <span class="c"># Set the current headline text.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setDefaultDirectoryForNewFiles</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">cacher</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">changeName</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="c"># Disable path-changed messages in writeAllHelper.</span>
            <span class="n">c</span><span class="o">.</span><span class="n">ignoreChangedPaths</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_Leo_file</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">outlineOnlyFlag</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span> <span class="c"># Clears all dirty bits.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">putSavedMessage</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">ignoreChangedPaths</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="n">c</span><span class="o">.</span><span class="n">redraw_after_icons_changed</span><span class="p">()</span>

        <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&quot;save2&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">v</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span><span class="n">fileName</span><span class="o">=</span><span class="n">fileName</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.3044: *4* saveTo (leoFileCommands)</span></div>
<div class="viewcode-block" id="baseFileCommands.saveTo"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.saveTo">[docs]</a>    <span class="k">def</span> <span class="nf">saveTo</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">v</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">currentVnode</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&quot;save1&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">v</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span><span class="n">fileName</span><span class="o">=</span><span class="n">fileName</span><span class="p">):</span>
            <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span><span class="c"># Set the current headline text.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setDefaultDirectoryForNewFiles</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">cacher</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">changeName</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="c"># Disable path-changed messages in writeAllHelper.</span>
            <span class="n">c</span><span class="o">.</span><span class="n">ignoreChangedPaths</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_Leo_file</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">outlineOnlyFlag</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">ignoreChangedPaths</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">putSavedMessage</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>

            <span class="n">c</span><span class="o">.</span><span class="n">redraw_after_icons_changed</span><span class="p">()</span>

        <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&quot;save2&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">v</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span><span class="n">fileName</span><span class="o">=</span><span class="n">fileName</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20070413061552: *4* putSavedMessage</span></div>
<div class="viewcode-block" id="baseFileCommands.putSavedMessage"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.putSavedMessage">[docs]</a>    <span class="k">def</span> <span class="nf">putSavedMessage</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>

        <span class="n">zipMark</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">isZipped</span><span class="p">,</span><span class="s">&#39;[zipped] &#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>

        <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;saved:&quot;</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%s%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">zipMark</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">(</span><span class="n">fileName</span><span class="p">)))</span>
    <span class="c">#@+node:ekr.20050404190914.2: *3* deleteFileWithMessage (leoFileCommands)</span></div>
<div class="viewcode-block" id="baseFileCommands.deleteFileWithMessage"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.deleteFileWithMessage">[docs]</a>    <span class="k">def</span> <span class="nf">deleteFileWithMessage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span><span class="n">unused_kind</span><span class="p">):</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;read only&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;exception deleting backup file:&quot;</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">(</span><span class="n">full</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20031218072017.1470: *3* put (leoFileCommands)</span></div>
<div class="viewcode-block" id="baseFileCommands.put"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.put">[docs]</a>    <span class="k">def</span> <span class="nf">put</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Put string s to self.outputFile. All output eventually comes here.&#39;&#39;&#39;</span>

        <span class="c"># Improved code: self.outputFile (a cStringIO object) always exists.</span>
        <span class="c"># g.trace(g.callers(1),repr(s))</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">putCount</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">leo_file_encoding</span><span class="p">,</span><span class="n">reportErrors</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="baseFileCommands.put_dquote"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.put_dquote">[docs]</a>    <span class="k">def</span> <span class="nf">put_dquote</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="baseFileCommands.put_dquoted_bool"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.put_dquoted_bool">[docs]</a>    <span class="k">def</span> <span class="nf">put_dquoted_bool</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">b</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39;&quot;1&quot;&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39;&quot;0&quot;&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="baseFileCommands.put_flag"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.put_flag">[docs]</a>    <span class="k">def</span> <span class="nf">put_flag</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">a</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)</span> <span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39;=&quot;1&quot;&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="baseFileCommands.put_in_dquotes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.put_in_dquotes">[docs]</a>    <span class="k">def</span> <span class="nf">put_in_dquotes</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">a</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">a</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="c"># will always be True if we use backquotes.</span>
        <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39;0&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="baseFileCommands.put_nl"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.put_nl">[docs]</a>    <span class="k">def</span> <span class="nf">put_nl</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="baseFileCommands.put_tab"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.put_tab">[docs]</a>    <span class="k">def</span> <span class="nf">put_tab</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="baseFileCommands.put_tabs"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.put_tabs">[docs]</a>    <span class="k">def</span> <span class="nf">put_tabs</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
        <span class="k">while</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="c">#@+node:ekr.20031218072017.1971: *3* putClipboardHeader</span></div>
<div class="viewcode-block" id="baseFileCommands.putClipboardHeader"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.putClipboardHeader">[docs]</a>    <span class="k">def</span> <span class="nf">putClipboardHeader</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># Put the minimum header for sax.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39;&lt;leo_header file_format=&quot;2&quot;/&gt;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20040324080819.1: *3* putLeoFile &amp; helpers</span></div>
<div class="viewcode-block" id="baseFileCommands.putLeoFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.putLeoFile">[docs]</a>    <span class="k">def</span> <span class="nf">putLeoFile</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">updateFixedStatus</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">putProlog</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">putHeader</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">putGlobals</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">putPrefs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">putFindSettings</span><span class="p">()</span>
        <span class="c">#start = g.getTime()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">putVnodes</span><span class="p">()</span>
        <span class="c">#start = g.printDiffTime(&quot;vnodes &quot;,start)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">putTnodes</span><span class="p">()</span>
        <span class="c">#start = g.printDiffTime(&quot;tnodes &quot;,start)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">putPostlog</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.3035: *4* putFindSettings</span></div>
<div class="viewcode-block" id="baseFileCommands.putFindSettings"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.putFindSettings">[docs]</a>    <span class="k">def</span> <span class="nf">putFindSettings</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># New in 4.3:  These settings never get written to the .leo file.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;&lt;find_panel_settings/&gt;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put_nl</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.3037: *4* putGlobals</span>
    <span class="c"># Changed for Leo 4.0.</span>
</div>
<div class="viewcode-block" id="baseFileCommands.putGlobals"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.putGlobals">[docs]</a>    <span class="k">def</span> <span class="nf">putGlobals</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>

        <span class="n">use_db</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">enableDB</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">mFileName</span>
        <span class="k">if</span> <span class="n">use_db</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">cacher</span><span class="o">.</span><span class="n">setCachedGlobalsElement</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">)</span>

        <span class="c"># Always put positions, to trigger sax methods.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;&lt;globals&quot;</span><span class="p">)</span>
        <span class="c">#@+&lt;&lt; put the body/outline ratios &gt;&gt;</span>
        <span class="c">#@+node:ekr.20031218072017.3038: *5* &lt;&lt; put the body/outline ratios &gt;&gt;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot; body_outline_ratio=&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put_in_dquotes</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">fixed</span> <span class="ow">or</span> <span class="n">use_db</span><span class="p">,</span><span class="s">&quot;0.5&quot;</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%1.2f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">ratio</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot; body_secondary_ratio=&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put_in_dquotes</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">fixed</span> <span class="ow">or</span> <span class="n">use_db</span><span class="p">,</span><span class="s">&quot;0.5&quot;</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%1.2f</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">secondary_ratio</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;fixed or use_db&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">fixed</span> <span class="ow">or</span> <span class="n">use_db</span><span class="p">,</span>
            <span class="s">&#39;</span><span class="si">%1.2f</span><span class="s"> </span><span class="si">%1.2f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">ratio</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">secondary_ratio</span><span class="p">))</span>
        <span class="c">#@-&lt;&lt; put the body/outline ratios &gt;&gt;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;&gt;&quot;</span><span class="p">)</span> <span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">put_nl</span><span class="p">()</span>
        <span class="c">#@+&lt;&lt; put the position of this frame &gt;&gt;</span>
        <span class="c">#@+node:ekr.20031218072017.3039: *5* &lt;&lt; put the position of this frame &gt;&gt;</span>
        <span class="c"># New in Leo 4.5: support fixed .leo files.</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">fixed</span> <span class="ow">or</span> <span class="n">use_db</span><span class="p">:</span>
            <span class="n">width</span><span class="p">,</span><span class="n">height</span><span class="p">,</span><span class="n">left</span><span class="p">,</span><span class="n">top</span> <span class="o">=</span> <span class="mi">700</span><span class="p">,</span><span class="mi">500</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">50</span>
                <span class="c"># Put fixed, immutable, reasonable defaults.</span>
                <span class="c"># Leo 4.5 and later will ignore these when reading.</span>
                <span class="c"># These should be reasonable defaults so that the</span>
                <span class="c"># file will be opened properly by older versions</span>
                <span class="c"># of Leo that do not support fixed .leo files.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">width</span><span class="p">,</span><span class="n">height</span><span class="p">,</span><span class="n">left</span><span class="p">,</span><span class="n">top</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">get_window_info</span><span class="p">()</span>

        <span class="c"># g.trace(width,height,left,top)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">put_tab</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;&lt;global_window_position&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot; top=&quot;</span><span class="p">)</span> <span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">put_in_dquotes</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">top</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot; left=&quot;</span><span class="p">)</span> <span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">put_in_dquotes</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">left</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot; height=&quot;</span><span class="p">)</span> <span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">put_in_dquotes</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">height</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot; width=&quot;</span><span class="p">)</span> <span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">put_in_dquotes</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">width</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;/&gt;&quot;</span><span class="p">)</span> <span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">put_nl</span><span class="p">()</span>
        <span class="c">#@-&lt;&lt; put the position of this frame &gt;&gt;</span>
        <span class="c">#@+&lt;&lt; put the position of the log window &gt;&gt;</span>
        <span class="c">#@+node:ekr.20031218072017.3040: *5* &lt;&lt; put the position of the log window &gt;&gt;</span>
        <span class="n">top</span> <span class="o">=</span> <span class="n">left</span> <span class="o">=</span> <span class="n">height</span> <span class="o">=</span> <span class="n">width</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># no longer used</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">put_tab</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;&lt;global_log_window_position&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot; top=&quot;</span><span class="p">)</span> <span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">put_in_dquotes</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">top</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot; left=&quot;</span><span class="p">)</span> <span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">put_in_dquotes</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">left</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot; height=&quot;</span><span class="p">)</span> <span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">put_in_dquotes</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">height</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot; width=&quot;</span><span class="p">)</span> <span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">put_in_dquotes</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">width</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;/&gt;&quot;</span><span class="p">)</span> <span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">put_nl</span><span class="p">()</span>
        <span class="c">#@-&lt;&lt; put the position of the log window &gt;&gt;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;&lt;/globals&gt;&quot;</span><span class="p">)</span> <span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">put_nl</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.3041: *4* putHeader</span></div>
<div class="viewcode-block" id="baseFileCommands.putHeader"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.putHeader">[docs]</a>    <span class="k">def</span> <span class="nf">putHeader</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">tnodes</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">clone_windows</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># Always zero in Leo2.</span>

        <span class="k">if</span> <span class="mi">1</span><span class="p">:</span> <span class="c"># For compatibility with versions before Leo 4.5.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;&lt;leo_header&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot; file_format=&quot;</span><span class="p">)</span> <span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">put_in_dquotes</span><span class="p">(</span><span class="s">&quot;2&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot; tnodes=&quot;</span><span class="p">)</span> <span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">put_in_dquotes</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tnodes</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot; max_tnode_index=&quot;</span><span class="p">)</span> <span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">put_in_dquotes</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot; clone_windows=&quot;</span><span class="p">)</span> <span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">put_in_dquotes</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">clone_windows</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;/&gt;&quot;</span><span class="p">)</span> <span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">put_nl</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39;&lt;leo_header file_format=&quot;2&quot;/&gt;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.3042: *4* putPostlog</span></div>
<div class="viewcode-block" id="baseFileCommands.putPostlog"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.putPostlog">[docs]</a>    <span class="k">def</span> <span class="nf">putPostlog</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;&lt;/leo_file&gt;&quot;</span><span class="p">)</span> <span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">put_nl</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.2066: *4* putPrefs</span></div>
<div class="viewcode-block" id="baseFileCommands.putPrefs"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.putPrefs">[docs]</a>    <span class="k">def</span> <span class="nf">putPrefs</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># New in 4.3:  These settings never get written to the .leo file.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;&lt;preferences/&gt;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put_nl</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.1246: *4* putProlog</span></div>
<div class="viewcode-block" id="baseFileCommands.putProlog"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.putProlog">[docs]</a>    <span class="k">def</span> <span class="nf">putProlog</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">putXMLLine</span><span class="p">()</span>

        <span class="c"># Put &quot;created by Leo&quot; line.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39;&lt;!-- Created by Leo (http://webpages.charter.net/edreamleo/front.html) --&gt;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put_nl</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stylesheet</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">stylesheet</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">putStyleSheetLine</span><span class="p">()</span>

        <span class="c"># Put the &lt;leo_file&gt; element.</span>
        <span class="c"># New in Leo 4.9: this element contains a namespace.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39;&lt;leo_file xmlns:leo=&quot;http://www.leo-editor.org/2011/leo&quot; &gt;&#39;</span><span class="p">)</span>
        <span class="c"># self.put(&quot;&lt;leo_file&gt;&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put_nl</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.1248: *4* putStyleSheetLine</span></div>
<div class="viewcode-block" id="baseFileCommands.putStyleSheetLine"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.putStyleSheetLine">[docs]</a>    <span class="k">def</span> <span class="nf">putStyleSheetLine</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>

        <span class="c"># The stylesheet in the .leo file takes precedence over the default stylesheet.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;&lt;?xml-stylesheet &quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">stylesheet</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">stylesheet</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;?&gt;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put_nl</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.1577: *4* putTnode</span></div>
<div class="viewcode-block" id="baseFileCommands.putTnode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.putTnode">[docs]</a>    <span class="k">def</span> <span class="nf">putTnode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">v</span><span class="p">):</span>

        <span class="c"># Call put just once.</span>
        <span class="n">gnx</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">nodeIndices</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">fileIndex</span><span class="p">)</span>
        <span class="n">ua</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;unknownAttributes&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">putUnknownAttributes</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">b</span>
        <span class="k">if</span> <span class="n">b</span><span class="p">:</span>
            <span class="n">body</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">sax</span><span class="o">.</span><span class="n">saxutils</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">body</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39;&lt;t tx=&quot;</span><span class="si">%s</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">&gt;</span><span class="si">%s</span><span class="s">&lt;/t&gt;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gnx</span><span class="p">,</span><span class="n">ua</span><span class="p">,</span><span class="n">body</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20031218072017.1575: *4* putTnodes</span></div>
<div class="viewcode-block" id="baseFileCommands.putTnodes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.putTnodes">[docs]</a>    <span class="k">def</span> <span class="nf">putTnodes</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Puts all tnodes as required for copy or save commands&quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;&lt;tnodes&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="c">#@+&lt;&lt; write only those tnodes that were referenced &gt;&gt;</span>
        <span class="c">#@+node:ekr.20031218072017.1576: *5* &lt;&lt; write only those tnodes that were referenced &gt;&gt;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">usingClipboard</span><span class="p">:</span> <span class="c"># write the current tree.</span>
            <span class="n">theIter</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">self_and_subtree</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># write everything</span>
            <span class="n">theIter</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">all_unique_positions</span><span class="p">()</span>

        <span class="c"># Populate tnodes</span>
        <span class="n">tnodes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">theIter</span><span class="p">:</span>
            <span class="c"># Make *sure* the file index has the proper form.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">theId</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">fileIndex</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">theId</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">fileIndex</span><span class="p">,</span><span class="s">&#39;&#39;</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">BadLeoFile</span><span class="p">(</span><span class="s">&#39;bad p.v.fileIndex: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">fileIndex</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">u</span><span class="p">(</span><span class="s">&#39;0&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">theId</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">n</span>
            <span class="n">tnodes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span>

        <span class="c"># Put all tnodes in index order.</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tnodes</span><span class="p">):</span>
            <span class="c"># g.trace(index)</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">tnodes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
                <span class="c"># Write only those tnodes whose vnodes were written.</span>
                <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">isWriteBit</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">putTnode</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;can not happen: no vnode for&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
                <span class="c"># This prevents the file from being written.</span>
                <span class="k">raise</span> <span class="n">BadLeoFile</span><span class="p">(</span><span class="s">&#39;no vnode for </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
        <span class="c">#@-&lt;&lt; write only those tnodes that were referenced &gt;&gt;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;&lt;/tnodes&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.1863: *4* putVnode</span></div>
<div class="viewcode-block" id="baseFileCommands.putVnode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.putVnode">[docs]</a>    <span class="k">def</span> <span class="nf">putVnode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">isIgnore</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Write a &lt;v&gt; element corresponding to a vnode.&quot;&quot;&quot;</span>

        <span class="n">fc</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">fc</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span>
        <span class="n">isAuto</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtAutoNode</span><span class="p">()</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">atAutoNodeName</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">isEdit</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtEditNode</span><span class="p">()</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">atEditNodeName</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">hasChildren</span><span class="p">()</span>
            <span class="c"># 2010/09/02: @edit nodes must not have children.</span>
            <span class="c"># If they do, the entire tree is written to the outline.</span>
        <span class="n">isFile</span>   <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtFileNode</span><span class="p">()</span>
        <span class="n">isShadow</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtShadowFileNode</span><span class="p">()</span>
        <span class="n">isThin</span>   <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtThinFileNode</span><span class="p">()</span>
        <span class="n">isOrphan</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">isOrphan</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isIgnore</span><span class="p">:</span> <span class="n">isIgnore</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtIgnoreNode</span><span class="p">()</span>

        <span class="c"># 2010/10/22: force writes of orphan @edit, @auto and @shadow trees.</span>
        <span class="k">if</span>   <span class="n">isIgnore</span><span class="p">:</span> <span class="n">forceWrite</span> <span class="o">=</span> <span class="bp">True</span>      <span class="c"># Always write full @ignore trees.</span>
        <span class="k">elif</span> <span class="n">isAuto</span><span class="p">:</span>   <span class="n">forceWrite</span> <span class="o">=</span> <span class="n">isOrphan</span>  <span class="c"># Force write of orphan @auto trees.</span>
        <span class="k">elif</span> <span class="n">isEdit</span><span class="p">:</span>   <span class="n">forceWrite</span> <span class="o">=</span> <span class="n">isOrphan</span>  <span class="c"># Force write of orphan @edit trees.</span>
        <span class="k">elif</span> <span class="n">isFile</span><span class="p">:</span>   <span class="n">forceWrite</span> <span class="o">=</span> <span class="n">isOrphan</span>  <span class="c"># Force write of orphan @file trees.</span>
        <span class="k">elif</span> <span class="n">isShadow</span><span class="p">:</span> <span class="n">forceWrite</span> <span class="o">=</span> <span class="n">isOrphan</span>  <span class="c"># Force write of @shadow trees.</span>
        <span class="k">elif</span> <span class="n">isThin</span><span class="p">:</span>   <span class="n">forceWrite</span> <span class="o">=</span> <span class="n">isOrphan</span>  <span class="c"># Force write of  orphan @thin trees.</span>
        <span class="k">else</span><span class="p">:</span>          <span class="n">forceWrite</span> <span class="o">=</span> <span class="bp">True</span>      <span class="c"># Write all other @&lt;file&gt; trees.</span>

        <span class="c"># if p.h.startswith(&#39;@file&#39;): g.trace(&#39;isOrphan&#39;,isOrphan,&#39;forceWrite&#39;,forceWrite,p.h)</span>

        <span class="c">#@+&lt;&lt; Set gnx = vnode index &gt;&gt;</span>
        <span class="c">#@+node:ekr.20031218072017.1864: *5* &lt;&lt; Set gnx = vnode index &gt;&gt;</span>
        <span class="n">gnx</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">nodeIndices</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">fileIndex</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">forceWrite</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">usingClipboard</span><span class="p">:</span>
            <span class="n">v</span><span class="o">.</span><span class="n">setWriteBit</span><span class="p">()</span> <span class="c"># 4.2: Indicate we wrote the body text.</span>
        <span class="c">#@-&lt;&lt; Set gnx = vnode index &gt;&gt;</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c">#@+&lt;&lt; Append attribute bits to attrs &gt;&gt;</span>
        <span class="c">#@+node:ekr.20031218072017.1865: *5* &lt;&lt; Append attribute bits to attrs &gt;&gt;</span>
        <span class="c"># These string catenations are benign because they rarely happen.</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="c"># New in Leo 4.5: support fixed .leo files.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">fixed</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">isExpanded</span><span class="p">()</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">hasChildren</span><span class="p">()</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">putBitsFlag</span><span class="p">:</span>
                <span class="n">attr</span> <span class="o">+=</span> <span class="s">&quot;E&quot;</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">isMarked</span><span class="p">():</span>   <span class="n">attr</span> <span class="o">+=</span> <span class="s">&quot;M&quot;</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">isOrphan</span><span class="p">():</span>   <span class="n">attr</span> <span class="o">+=</span> <span class="s">&quot;O&quot;</span>
            <span class="k">if</span> <span class="n">attr</span><span class="p">:</span>
                <span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39; a=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>

        <span class="c"># Put the archived *current* position in the *root* positions &lt;v&gt; element.</span>
        <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">:</span>
            <span class="n">aList</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentPosition</span><span class="o">.</span><span class="n">archivedPosition</span><span class="p">()]</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">u</span>
            <span class="n">str_pos</span> <span class="o">=</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">aList</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;str_leo_pos&#39;</span><span class="p">):</span>
                <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;str_leo_pos&#39;</span><span class="p">]</span>
            <span class="c"># Don&#39;t write the current position if we can cache it. </span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">enableDB</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">cacher</span><span class="o">.</span><span class="n">setCachedStringPosition</span><span class="p">(</span><span class="n">str_pos</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">c</span><span class="o">.</span><span class="n">fixed</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="s">&#39;str_leo_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">str_pos</span>
            <span class="n">v</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">d</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s">&quot;unknownAttributes&quot;</span><span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">unknownAttributes</span>
            <span class="k">if</span> <span class="n">d</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">fixed</span> <span class="ow">and</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;str_leo_pos&#39;</span><span class="p">):</span>
                <span class="c"># g.trace(&quot;clearing str_leo_pos&quot;,v)</span>
                <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;str_leo_pos&#39;</span><span class="p">]</span>
                <span class="n">v</span><span class="o">.</span><span class="n">unknownAttributes</span> <span class="o">=</span> <span class="n">d</span>
        <span class="c">#@-&lt;&lt; Append attribute bits to attrs &gt;&gt;</span>
        <span class="c">#@+&lt;&lt; Append unKnownAttributes to attrs &gt;&gt;</span>
        <span class="c">#@+node:ekr.20040324082713: *5* &lt;&lt; Append unKnownAttributes to attrs&gt;&gt;</span>
        <span class="c"># v.unknownAttributes are now put in &lt;t&gt; elements.</span>

        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">hasChildren</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">forceWrite</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">usingClipboard</span><span class="p">:</span>
            <span class="c"># We put the entire tree when using the clipboard, so no need for this.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">isAuto</span><span class="p">:</span> <span class="c"># Bug fix: 2008/8/7.</span>
                <span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">putDescendentVnodeUas</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="c"># New in Leo 4.5.</span>
                <span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">putDescendentAttributes</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
        <span class="c">#@-&lt;&lt; Append unKnownAttributes to attrs &gt;&gt;</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
        <span class="n">v_head</span> <span class="o">=</span> <span class="s">&#39;&lt;v t=&quot;</span><span class="si">%s</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gnx</span><span class="p">,</span><span class="n">attrs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gnx</span> <span class="ow">in</span> <span class="n">fc</span><span class="o">.</span><span class="n">vnodesDict</span><span class="p">:</span>
            <span class="n">fc</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">v_head</span><span class="o">+</span><span class="s">&#39;&lt;/v&gt;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fc</span><span class="o">.</span><span class="n">vnodesDict</span><span class="p">[</span><span class="n">gnx</span><span class="p">]</span><span class="o">=</span><span class="bp">True</span>
            <span class="n">v_head</span> <span class="o">+=</span> <span class="s">&#39;&lt;vh&gt;</span><span class="si">%s</span><span class="s">&lt;/vh&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">xml</span><span class="o">.</span><span class="n">sax</span><span class="o">.</span><span class="n">saxutils</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">headString</span><span class="p">()</span><span class="ow">or</span><span class="s">&#39;&#39;</span><span class="p">))</span>
            <span class="c"># The string catentation is faster than repeated calls to fc.put.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">usingClipboard</span><span class="p">:</span>
                <span class="c">#@+&lt;&lt; issue informational messages &gt;&gt;</span>
                <span class="c">#@+node:ekr.20040702085529: *5* &lt;&lt; issue informational messages &gt;&gt; (changed)</span>
                <span class="k">if</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># It&#39;s strange to clear the orphan bit.</span>
                    <span class="k">if</span> <span class="n">isOrphan</span> <span class="ow">and</span> <span class="p">(</span><span class="n">isFile</span> <span class="ow">or</span> <span class="n">isThin</span><span class="p">):</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;writing erroneous:&quot;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
                        <span class="n">p</span><span class="o">.</span><span class="n">clearOrphan</span><span class="p">()</span>
                <span class="c">#@-&lt;&lt; issue informational messages &gt;&gt;</span>
            <span class="c"># New in 4.2: don&#39;t write child nodes of @file-thin trees (except when writing to clipboard)</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">hasChildren</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="n">forceWrite</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">usingClipboard</span><span class="p">):</span>
                <span class="n">fc</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">v_head</span><span class="p">)</span>
                <span class="c"># This optimization eliminates all &quot;recursive&quot; copies.</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToFirstChild</span><span class="p">()</span>
                <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">fc</span><span class="o">.</span><span class="n">putVnode</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">isIgnore</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">hasNext</span><span class="p">():</span> <span class="n">p</span><span class="o">.</span><span class="n">moveToNext</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>           <span class="k">break</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToParent</span><span class="p">()</span> <span class="c"># Restore p in the caller.</span>
                <span class="n">fc</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39;&lt;/v&gt;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fc</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">&lt;/v&gt;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">v_head</span><span class="p">)</span> <span class="c"># Call put only once.</span>
    <span class="c">#@+node:ekr.20031218072017.1579: *4* putVnodes</span></div>
<div class="viewcode-block" id="baseFileCommands.putVnodes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.putVnodes">[docs]</a>    <span class="k">def</span> <span class="nf">putVnodes</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Puts all &lt;v&gt; elements in the order in which they appear in the outline.&quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="n">c</span><span class="o">.</span><span class="n">clearAllVisited</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;&lt;vnodes&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="c"># Make only one copy for all calls.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentPosition</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">rootPosition</span>    <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span>
        <span class="c"># self.topPosition     = c.topPosition()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vnodesDict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">usingClipboard</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">putVnode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">currentPosition</span><span class="p">)</span> <span class="c"># Write only current tree.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span><span class="o">.</span><span class="n">self_and_siblings</span><span class="p">():</span>
                <span class="c"># New in Leo 4.4.2 b2 An optimization:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">putVnode</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">isIgnore</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">isAtIgnoreNode</span><span class="p">())</span> <span class="c"># Write the next top-level node.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&quot;&lt;/vnodes&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.1247: *4* putXMLLine</span></div>
<div class="viewcode-block" id="baseFileCommands.putXMLLine"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.putXMLLine">[docs]</a>    <span class="k">def</span> <span class="nf">putXMLLine</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Put the **properly encoded** &lt;?xml&gt; element.&#39;&#39;&#39;</span>

        <span class="c"># Use self.leo_file_encoding encoding.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">prolog_prefix_string</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">leo_file_encoding</span><span class="p">,</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">prolog_postfix_string</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20031218072017.1573: *3* putLeoOutline (to clipboard)</span></div>
<div class="viewcode-block" id="baseFileCommands.putLeoOutline"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.putLeoOutline">[docs]</a>    <span class="k">def</span> <span class="nf">putLeoOutline</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return a string, *not unicode*, encoded with self.leo_file_encoding,</span>
<span class="sd">        suitable for pasting to the clipboard.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">fileLikeObject</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">usingClipboard</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">putProlog</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">putClipboardHeader</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">putVnodes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">putTnodes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">putPostlog</span><span class="p">()</span>

        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">usingClipboard</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">s</span>
    <span class="c">#@+node:ekr.20060919064401: *3* putToOPML</span>
    <span class="c"># All elements and attributes prefixed by &#39;:&#39; are leo-specific.</span>
    <span class="c"># All other elements and attributes are specified by the OPML 1 spec.</span>
</div>
<div class="viewcode-block" id="baseFileCommands.putToOPML"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.putToOPML">[docs]</a>    <span class="k">def</span> <span class="nf">putToOPML</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Should be overridden by the opml plugin.&#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20031218072017.3046: *3* write_Leo_file &amp; helpers</span></div>
<div class="viewcode-block" id="baseFileCommands.write_Leo_file"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.write_Leo_file">[docs]</a>    <span class="k">def</span> <span class="nf">write_Leo_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span><span class="n">outlineOnlyFlag</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">toOPML</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkOutlineBeforeSave</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkOutline</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">outlineOnlyFlag</span> <span class="ow">or</span> <span class="n">toOPML</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">recentFilesManager</span><span class="o">.</span><span class="n">writeRecentFilesFile</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeAllAtFileNodesHelper</span><span class="p">()</span> <span class="c"># Ignore any errors.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isReadOnly</span><span class="p">(</span><span class="n">fileName</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">putCount</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">toString</span> <span class="o">=</span> <span class="n">toString</span>
            <span class="k">if</span> <span class="n">toString</span><span class="p">:</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">writeToStringHelper</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">writeToFileHelper</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">toOPML</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">toString</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">ok</span>
</div>
    <span class="n">write_LEO_file</span> <span class="o">=</span> <span class="n">write_Leo_file</span> <span class="c"># For compatibility with old plugins.</span>
    <span class="c">#@+node:ekr.20100119145629.6109: *4* checkOutline</span>
<div class="viewcode-block" id="baseFileCommands.checkOutline"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.checkOutline">[docs]</a>    <span class="k">def</span> <span class="nf">checkOutline</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>

        <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&#39;@bool check_outline_before_save = True&#39;</span><span class="p">)</span>

        <span class="n">errors</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">checkOutline</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">unittest</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">full</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">errors</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;outline not written&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ok</span>
    <span class="c">#@+node:ekr.20040324080359.1: *4* isReadOnly</span></div>
<div class="viewcode-block" id="baseFileCommands.isReadOnly"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.isReadOnly">[docs]</a>    <span class="k">def</span> <span class="nf">isReadOnly</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="p">):</span>

        <span class="c"># self.read_only is not valid for Save As and Save To commands.</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">fileName</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="p">):</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;can not write: read only:&quot;</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">True</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span> <span class="c"># os.access() may not exist on all platforms.</span>

        <span class="k">return</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20100119145629.6114: *4* writeAllAtFileNodesHelper</span></div>
<div class="viewcode-block" id="baseFileCommands.writeAllAtFileNodesHelper"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.writeAllAtFileNodesHelper">[docs]</a>    <span class="k">def</span> <span class="nf">writeAllAtFileNodesHelper</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Write all @&lt;file&gt; nodes and set orphan bits.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c"># 2010/01/19: Do *not* signal failure here.</span>
            <span class="c"># This allows Leo to quit properly.</span>
            <span class="n">c</span><span class="o">.</span><span class="n">atFileCommands</span><span class="o">.</span><span class="n">writeAll</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_error</span><span class="p">(</span><span class="s">&quot;exception writing external files&quot;</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20100119145629.6111: *4* writeToFileHelper &amp; helpers</span></div>
<div class="viewcode-block" id="baseFileCommands.writeToFileHelper"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.writeToFileHelper">[docs]</a>    <span class="k">def</span> <span class="nf">writeToFileHelper</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span><span class="n">toOPML</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">toZip</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">isZipped</span>
        <span class="n">ok</span><span class="p">,</span><span class="n">backupName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createBackupFile</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>
        <span class="n">fileName</span><span class="p">,</span><span class="n">theActualFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createActualFile</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">toOPML</span><span class="p">,</span><span class="n">toZip</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">theActualFile</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mFileName</span> <span class="o">=</span> <span class="n">fileName</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span> <span class="c"># Always write to a string.</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">toOPML</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">putToOPML</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">putLeoFile</span><span class="p">()</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">write_Leo_file_string</span> <span class="o">=</span> <span class="n">s</span> <span class="c"># 2010/01/19: always set this.</span>
            <span class="k">if</span> <span class="n">toZip</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeZipFile</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">leo_file_encoding</span><span class="p">,</span><span class="s">&#39;replace&#39;</span><span class="p">)</span>
                <span class="n">theActualFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="n">theActualFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">c</span><span class="o">.</span><span class="n">setFileTimeStamp</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
                <span class="c"># raise AttributeError # To test handleWriteLeoFileException.</span>
                <span class="c"># Delete backup file.</span>
                <span class="k">if</span> <span class="n">backupName</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">backupName</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">deleteFileWithMessage</span><span class="p">(</span><span class="n">backupName</span><span class="p">,</span><span class="s">&#39;backup&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handleWriteLeoFileException</span><span class="p">(</span>
                <span class="n">fileName</span><span class="p">,</span><span class="n">backupName</span><span class="p">,</span><span class="n">theActualFile</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20100119145629.6106: *5* createActualFile</span></div>
<div class="viewcode-block" id="baseFileCommands.createActualFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.createActualFile">[docs]</a>    <span class="k">def</span> <span class="nf">createActualFile</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span><span class="n">toOPML</span><span class="p">,</span><span class="n">toZip</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">toOPML</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mFileName</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;opml&#39;</span><span class="p">):</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mFileName</span> <span class="o">+</span> <span class="s">&#39;.opml&#39;</span>
        <span class="k">if</span> <span class="n">toZip</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">toString</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">theActualFile</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c"># 2010/01/21: always write in binary mode.</span>
                <span class="n">theActualFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="s">&#39;wb&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;can not open </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">fileName</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
                <span class="n">theActualFile</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">return</span> <span class="n">fileName</span><span class="p">,</span><span class="n">theActualFile</span>
    <span class="c">#@+node:ekr.20031218072017.3047: *5* createBackupFile</span></div>
<div class="viewcode-block" id="baseFileCommands.createBackupFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.createBackupFile">[docs]</a>    <span class="k">def</span> <span class="nf">createBackupFile</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Create a closed backup file and copy the file to it,</span>
<span class="sd">            but only if the original file exists.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">fileName</span><span class="p">):</span>
            <span class="n">fd</span><span class="p">,</span><span class="n">backupName</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="c"># rb is essential.</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;exception creating backup file&#39;</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
                <span class="n">ok</span><span class="p">,</span><span class="n">backupName</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span><span class="bp">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_only</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;read only&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ok</span><span class="p">,</span><span class="n">backupName</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span><span class="bp">None</span>
        <span class="k">return</span> <span class="n">ok</span><span class="p">,</span><span class="n">backupName</span>
    <span class="c">#@+node:ekr.20100119145629.6108: *5* handleWriteLeoFileException</span></div>
<div class="viewcode-block" id="baseFileCommands.handleWriteLeoFileException"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.handleWriteLeoFileException">[docs]</a>    <span class="k">def</span> <span class="nf">handleWriteLeoFileException</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span><span class="n">backupName</span><span class="p">,</span><span class="n">theActualFile</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>

        <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;exception writing:&quot;</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">(</span><span class="n">full</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">theActualFile</span><span class="p">:</span>
            <span class="n">theActualFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c"># Delete fileName.</span>
        <span class="k">if</span> <span class="n">fileName</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">fileName</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deleteFileWithMessage</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>

        <span class="c"># Rename backupName to fileName.</span>
        <span class="k">if</span> <span class="n">backupName</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">backupName</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;restoring&quot;</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span><span class="s">&quot;from&quot;</span><span class="p">,</span><span class="n">backupName</span><span class="p">)</span>

            <span class="c"># No need to create directories when restoring.</span>
            <span class="n">g</span><span class="o">.</span><span class="n">utils_rename</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">backupName</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;backup file does not exist!&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">backupName</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20100119145629.6110: *4* writeToStringHelper</span></div>
<div class="viewcode-block" id="baseFileCommands.writeToStringHelper"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.writeToStringHelper">[docs]</a>    <span class="k">def</span> <span class="nf">writeToStringHelper</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="p">):</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mFileName</span> <span class="o">=</span> <span class="n">fileName</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">putLeoFile</span><span class="p">()</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">write_Leo_file_string</span> <span class="o">=</span> <span class="n">s</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;exception writing:&quot;</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">(</span><span class="n">full</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">write_Leo_file_string</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20070412095520: *4* writeZipFile</span></div>
<div class="viewcode-block" id="baseFileCommands.writeZipFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.writeZipFile">[docs]</a>    <span class="k">def</span> <span class="nf">writeZipFile</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="c"># The name of the file in the archive.</span>
        <span class="n">contentsName</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span>
            <span class="n">g</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mFileName</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">leo_file_encoding</span><span class="p">,</span><span class="n">reportErrors</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c"># The name of the archive itself.</span>
        <span class="n">fileName</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mFileName</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">leo_file_encoding</span><span class="p">,</span><span class="n">reportErrors</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c"># Write the archive.</span>
        <span class="n">theFile</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">,</span><span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span><span class="p">)</span>
        <span class="n">theFile</span><span class="o">.</span><span class="n">writestr</span><span class="p">(</span><span class="n">contentsName</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
        <span class="n">theFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.2012: *3* writeAtFileNodes (fileCommands)</span></div>
<div class="viewcode-block" id="baseFileCommands.writeAtFileNodes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.writeAtFileNodes">[docs]</a>    <span class="k">def</span> <span class="nf">writeAtFileNodes</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Write all @file nodes in the selected outline.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>

        <span class="n">c</span><span class="o">.</span><span class="n">init_error_dialogs</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">atFileCommands</span><span class="o">.</span><span class="n">writeAll</span><span class="p">(</span><span class="n">writeAtFileNodesFlag</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">raise_error_dialogs</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;write&#39;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20080801071227.5: *3* writeAtShadowNodes (fileCommands)</span></div>
<div class="viewcode-block" id="baseFileCommands.writeAtShadowNodes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.writeAtShadowNodes">[docs]</a>    <span class="k">def</span> <span class="nf">writeAtShadowNodes</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Write all @file nodes in the selected outline.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>

        <span class="n">c</span><span class="o">.</span><span class="n">init_error_dialogs</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">atFileCommands</span><span class="o">.</span><span class="n">writeAll</span><span class="p">(</span><span class="n">writeAtFileNodesFlag</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">raise_error_dialogs</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;write&#39;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.1666: *3* writeDirtyAtFileNodes (fileCommands)</span></div>
<div class="viewcode-block" id="baseFileCommands.writeDirtyAtFileNodes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.writeDirtyAtFileNodes">[docs]</a>    <span class="k">def</span> <span class="nf">writeDirtyAtFileNodes</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Write all changed @file Nodes.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>

        <span class="n">c</span><span class="o">.</span><span class="n">init_error_dialogs</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">atFileCommands</span><span class="o">.</span><span class="n">writeAll</span><span class="p">(</span><span class="n">writeDirtyAtFileNodesFlag</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">raise_error_dialogs</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;write&#39;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20080801071227.6: *3* writeDirtyAtShadowNodes (fileCommands)</span></div>
<div class="viewcode-block" id="baseFileCommands.writeDirtyAtShadowNodes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.writeDirtyAtShadowNodes">[docs]</a>    <span class="k">def</span> <span class="nf">writeDirtyAtShadowNodes</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Write all changed @shadow Nodes.&#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">atFileCommands</span><span class="o">.</span><span class="n">writeDirtyAtShadowNodes</span><span class="p">()</span>

    <span class="c">#@+node:ekr.20031218072017.2013: *3* writeMissingAtFileNodes</span></div>
<div class="viewcode-block" id="baseFileCommands.writeMissingAtFileNodes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.writeMissingAtFileNodes">[docs]</a>    <span class="k">def</span> <span class="nf">writeMissingAtFileNodes</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Write all missing @file nodes.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">atFileCommands</span><span class="o">.</span><span class="n">writeMissing</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.3050: *3* writeOutlineOnly</span></div>
<div class="viewcode-block" id="baseFileCommands.writeOutlineOnly"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.writeOutlineOnly">[docs]</a>    <span class="k">def</span> <span class="nf">writeOutlineOnly</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Write the entire outline without writing any derived files.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_Leo_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mFileName</span><span class="p">,</span><span class="n">outlineOnlyFlag</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&#39;done&#39;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20080805114146.2: ** Utils</span>
    <span class="c">#@+node:ekr.20031218072017.1570: *3* fc.assignFileIndices &amp; compactFileIndices</span></div>
<div class="viewcode-block" id="baseFileCommands.assignFileIndices"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.assignFileIndices">[docs]</a>    <span class="k">def</span> <span class="nf">assignFileIndices</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Assign a file index to all tnodes&quot;&quot;&quot;</span>

        <span class="k">pass</span> <span class="c"># No longer needed: we assign indices as needed.</span>

    <span class="c"># Indices are now immutable, so there is no longer any difference between these two routines.</span></div>
    <span class="n">compactFileIndices</span> <span class="o">=</span> <span class="n">assignFileIndices</span>
    <span class="c">#@+node:ekr.20080805085257.1: *3* fc.createUaList</span>
<div class="viewcode-block" id="baseFileCommands.createUaList"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.createUaList">[docs]</a>    <span class="k">def</span> <span class="nf">createUaList</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aList</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Given aList of pairs (p,torv), return a list of pairs (torv,d)</span>
<span class="sd">        where d contains all picklable items of torv.unknownAttributes.&#39;&#39;&#39;</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">torv</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">torv</span><span class="o">.</span><span class="n">unknownAttributes</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">({}):</span>
                <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;ignoring non-dictionary uA for&quot;</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># Create a new dict containing only entries that can be pickled.</span>
                <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">torv</span><span class="o">.</span><span class="n">unknownAttributes</span><span class="p">)</span> <span class="c"># Copy the dict.</span>

                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                    <span class="c"># Just see if val can be pickled.  Suppress any error.</span>
                    <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickle</span><span class="p">(</span><span class="n">torv</span><span class="o">=</span><span class="n">torv</span><span class="p">,</span><span class="n">val</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">),</span><span class="n">tag</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;ignoring bad unknownAttributes key&quot;</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="s">&quot;in&quot;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">d</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">torv</span><span class="p">,</span><span class="n">d</span><span class="p">),)</span>

        <span class="k">return</span> <span class="n">result</span>
    <span class="c">#@+node:ekr.20080805085257.2: *3* fc.pickle</span></div>
<div class="viewcode-block" id="baseFileCommands.pickle"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.pickle">[docs]</a>    <span class="k">def</span> <span class="nf">pickle</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">torv</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">tag</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Pickle val and return the hexlified result.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="n">protocol</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">s2</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">hexlify</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">s3</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">ue</span><span class="p">(</span><span class="n">s2</span><span class="p">,</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span>
                <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">),</span><span class="n">val</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">),</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span>
                <span class="nb">type</span><span class="p">(</span><span class="n">s2</span><span class="p">),</span><span class="n">s2</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="n">s3</span><span class="p">),</span><span class="n">s3</span><span class="p">)</span>
            <span class="n">field</span> <span class="o">=</span> <span class="s">&#39; </span><span class="si">%s</span><span class="s">=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="n">s3</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">field</span>

        <span class="k">except</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tag</span><span class="p">:</span> <span class="c"># The caller will print the error if tag is None.</span>
                <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;ignoring non-pickleable value&quot;</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="s">&quot;in&quot;</span><span class="p">,</span><span class="n">torv</span><span class="p">)</span>
            <span class="k">return</span> <span class="s">&#39;&#39;</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;fc.pickle: unexpected exception in&quot;</span><span class="p">,</span><span class="n">torv</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
            <span class="k">return</span> <span class="s">&#39;&#39;</span>
    <span class="c">#@+node:ekr.20040701065235.2: *3* fc.putDescendentAttributes</span></div>
<div class="viewcode-block" id="baseFileCommands.putDescendentAttributes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.putDescendentAttributes">[docs]</a>    <span class="k">def</span> <span class="nf">putDescendentAttributes</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="n">nodeIndices</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">nodeIndices</span>

        <span class="c"># Create lists of all tnodes whose vnodes are marked or expanded.</span>
        <span class="n">marks</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">;</span> <span class="n">expanded</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">subtree</span><span class="p">():</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isMarked</span><span class="p">()</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">marks</span><span class="p">:</span>
                <span class="n">marks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">hasChildren</span><span class="p">()</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">isExpanded</span><span class="p">()</span> <span class="ow">and</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">expanded</span><span class="p">:</span>
                <span class="n">expanded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">theList</span><span class="p">,</span><span class="n">tag</span> <span class="ow">in</span> <span class="p">((</span><span class="n">marks</span><span class="p">,</span><span class="s">&quot;marks&quot;</span><span class="p">),(</span><span class="n">expanded</span><span class="p">,</span><span class="s">&quot;expanded&quot;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">theList</span><span class="p">:</span>
                <span class="n">sList</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">theList</span><span class="p">:</span>
                    <span class="n">sList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">,&quot;</span> <span class="o">%</span> <span class="n">nodeIndices</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">fileIndex</span><span class="p">))</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sList</span><span class="p">)</span>
                <span class="c"># g.trace(tag,[str(p.h) for p in theList])</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="si">%s</span><span class="s">=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="n">s</span><span class="p">))</span>

        <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20080805071954.2: *3* fc.putDescendentVnodeUas</span></div>
<div class="viewcode-block" id="baseFileCommands.putDescendentVnodeUas"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.putDescendentVnodeUas">[docs]</a>    <span class="k">def</span> <span class="nf">putDescendentVnodeUas</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the a uA field for descendent vnode attributes,</span>
<span class="sd">        suitable for reconstituting uA&#39;s for anonymous vnodes.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

        <span class="c"># Create aList of tuples (p,v) having a valid unknownAttributes dict.</span>
        <span class="c"># Create dictionary: keys are vnodes, values are corresonding archived positions.</span>
        <span class="n">pDict</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">;</span> <span class="n">aList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p2</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">self_and_subtree</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="s">&quot;unknownAttributes&quot;</span><span class="p">):</span>
                <span class="n">aList</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">p2</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span><span class="n">p2</span><span class="o">.</span><span class="n">v</span><span class="p">),)</span>
                <span class="n">pDict</span><span class="p">[</span><span class="n">p2</span><span class="o">.</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">p2</span><span class="o">.</span><span class="n">archivedPosition</span><span class="p">(</span><span class="n">root_p</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>

        <span class="c"># Create aList of pairs (v,d) where d contains only pickleable entries.</span>
        <span class="k">if</span> <span class="n">aList</span><span class="p">:</span> <span class="n">aList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createUaList</span><span class="p">(</span><span class="n">aList</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">aList</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#39;&#39;</span>

        <span class="c"># Create d, an enclosing dict to hold all the inner dicts.</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">v</span><span class="p">,</span><span class="n">d2</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
            <span class="n">aList2</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">pDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span>
            <span class="c"># g.trace(aList2)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">aList2</span><span class="p">)</span>
            <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="n">d2</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">dictToString</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>

        <span class="c"># Pickle and hexlify d</span>
        <span class="k">return</span> <span class="n">d</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickle</span><span class="p">(</span>
            <span class="n">torv</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="n">val</span><span class="o">=</span><span class="n">d</span><span class="p">,</span><span class="n">tag</span><span class="o">=</span><span class="s">&#39;descendentVnodeUnknownAttributes&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
    <span class="c">#@+node:ekr.20050418161620.2: *3* fc.putUaHelper</span></div>
<div class="viewcode-block" id="baseFileCommands.putUaHelper"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.putUaHelper">[docs]</a>    <span class="k">def</span> <span class="nf">putUaHelper</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">torv</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">val</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Put attribute whose name is key and value is val to the output stream.&#39;&#39;&#39;</span>

        <span class="c"># g.trace(key,repr(val),g.callers())</span>

        <span class="c"># New in 4.3: leave string attributes starting with &#39;str_&#39; alone.</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;str_&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">):</span>
                <span class="n">attr</span> <span class="o">=</span> <span class="s">&#39; </span><span class="si">%s</span><span class="s">=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">xml</span><span class="o">.</span><span class="n">sax</span><span class="o">.</span><span class="n">saxutils</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">attr</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;ignoring non-string attribute&quot;</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="s">&quot;in&quot;</span><span class="p">,</span><span class="n">torv</span><span class="p">)</span>
                <span class="k">return</span> <span class="s">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pickle</span><span class="p">(</span><span class="n">torv</span><span class="o">=</span><span class="n">torv</span><span class="p">,</span><span class="n">val</span><span class="o">=</span><span class="n">val</span><span class="p">,</span><span class="n">tag</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
    <span class="c">#@+node:EKR.20040526202501: *3* fc.putUnknownAttributes</span></div>
<div class="viewcode-block" id="baseFileCommands.putUnknownAttributes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.putUnknownAttributes">[docs]</a>    <span class="k">def</span> <span class="nf">putUnknownAttributes</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">torv</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Put pickleable values for all keys in torv.unknownAttributes dictionary.&quot;&quot;&quot;</span>

        <span class="n">attrDict</span> <span class="o">=</span> <span class="n">torv</span><span class="o">.</span><span class="n">unknownAttributes</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">attrDict</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">({}):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;ignoring non-dictionary unknownAttributes for&quot;</span><span class="p">,</span><span class="n">torv</span><span class="p">)</span>
            <span class="k">return</span> <span class="s">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">putUaHelper</span><span class="p">(</span><span class="n">torv</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">attrDict</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
            <span class="c"># g.trace(torv,attrDict)</span>
            <span class="k">return</span> <span class="n">val</span>
    <span class="c">#@+node:ekr.20031218072017.3045: *3* fc.setDefaultDirectoryForNewFiles</span></div>
<div class="viewcode-block" id="baseFileCommands.setDefaultDirectoryForNewFiles"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.setDefaultDirectoryForNewFiles">[docs]</a>    <span class="k">def</span> <span class="nf">setDefaultDirectoryForNewFiles</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Set c.openDirectory for new files for the benefit of leoAtFile.scanAllDirectives.&quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">openDirectory</span><span class="p">:</span>
            <span class="n">theDir</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_dirname</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">theDir</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_isabs</span><span class="p">(</span><span class="n">theDir</span><span class="p">)</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">theDir</span><span class="p">):</span>
                <span class="n">c</span><span class="o">.</span><span class="n">openDirectory</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">openDirectory</span> <span class="o">=</span> <span class="n">theDir</span>
    <span class="c">#@+node:ekr.20080412172151.2: *3* fc.updateFixedStatus</span></div>
<div class="viewcode-block" id="baseFileCommands.updateFixedStatus"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.baseFileCommands.updateFixedStatus">[docs]</a>    <span class="k">def</span> <span class="nf">updateFixedStatus</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">findSettingsPosition</span><span class="p">(</span><span class="s">&#39;@bool fixedWindow&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">leo.core.leoConfig</span> <span class="kn">as</span> <span class="nn">leoConfig</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">leoConfig</span><span class="o">.</span><span class="n">SettingsTreeParser</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">kind</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">val</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parseHeadline</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">and</span> <span class="n">val</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;true&#39;</span><span class="p">,</span><span class="s">&#39;1&#39;</span><span class="p">):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">c</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="n">val</span>

        <span class="c"># g.trace(&#39;c.fixed&#39;,c.fixed)</span>
    <span class="c">#@-others</span>
</div></div>
<div class="viewcode-block" id="fileCommands"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoFileCommands.fileCommands">[docs]</a><span class="k">class</span> <span class="nc">fileCommands</span> <span class="p">(</span><span class="n">baseFileCommands</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A class creating the fileCommands subcommander.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
<span class="c">#@-leo</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Leo API 4.11dev documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Ed K. Ream.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
  </body>
</html>