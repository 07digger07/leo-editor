<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>leo.core.leoCommands &mdash; Leo API 4.11dev documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '4.11dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Leo API 4.11dev documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Leo API 4.11dev documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for leo.core.leoCommands</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="c">#@+leo-ver=5-thin</span>
<span class="c">#@+node:ekr.20031218072017.2810: * @file leoCommands.py</span>
<span class="c">#@@first</span>
    <span class="c"># Needed because of unicode characters in tests.</span>

<span class="c">#@@language python</span>
<span class="c">#@@tabwidth -4</span>
<span class="c">#@@pagewidth 70</span>

<span class="c">#@+&lt;&lt; imports &gt;&gt;</span>
<span class="c">#@+node:ekr.20040712045933: ** &lt;&lt; imports &gt;&gt; (leoCommands)</span>
<span class="kn">import</span> <span class="nn">leo.core.leoGlobals</span> <span class="kn">as</span> <span class="nn">g</span>

<span class="c"># if g.app and g.app.use_psyco:</span>
    <span class="c"># # g.pr(&quot;enabled psyco classes&quot;,__file__)</span>
    <span class="c"># try: from psyco.classes import *</span>
    <span class="c"># except ImportError: pass</span>

<span class="c"># The leoCommands ctor now does these imports.</span>
<span class="c"># This breaks circular dependencies.</span>

    <span class="c"># import leo.core.leoAtFile as leoAtFile</span>
    <span class="c"># import leo.core.leoCache as leoCache</span>
    <span class="c"># import leo.core.leoChapters as leoChapters</span>
    <span class="c"># import leo.core.leoEditCommands as leoEditCommands</span>
    <span class="c"># import leo.core.leoKeys as leoKeys</span>
    <span class="c"># import leo.core.leoFileCommands as leoFileCommands</span>
    <span class="c"># import leo.core.leoImport as leoImport</span>
    <span class="c"># import leo.core.leoRst as leoRst</span>
    <span class="c"># import leo.core.leoShadow as leoShadow</span>
    <span class="c"># import leo.core.leoTangle as leoTangle</span>
    <span class="c"># import leo.core.leoTest as leoTest</span>
    <span class="c"># import leo.core.leoUndo as leoUndo</span>

<span class="kn">import</span> <span class="nn">leo.core.leoNodes</span> <span class="kn">as</span> <span class="nn">leoNodes</span>

<span class="c"># import leo.external.pickleshare as pickleshare</span>

<span class="c"># import hashlib</span>
<span class="kn">import</span> <span class="nn">imp</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">keyword</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">tokenize</span> <span class="c"># for Check Python command</span>
<span class="c"># import unittest</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">tabnanny</span> <span class="c"># for Check Python command # Does not exist in jython</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">tabnanny</span> <span class="o">=</span> <span class="bp">None</span>

<span class="c"># The following import _is_ used.</span>
<span class="kn">import</span> <span class="nn">token</span>    <span class="c"># for Check Python command</span>
<span class="c">#@-&lt;&lt; imports &gt;&gt;</span>

<span class="c">#@+others</span>
<span class="c">#@+node:ekr.20041118104831: ** class commands</span>
<div class="viewcode-block" id="Commands"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands">[docs]</a><span class="k">class</span> <span class="nc">Commands</span> <span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A class that implements most of Leo&#39;s commands.&quot;&quot;&quot;</span>
    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20031218072017.2811: *3*  c.Birth &amp; death</span>
    <span class="c">#@+node:ekr.20031218072017.2812: *4* c.__init__ &amp; helpers</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span><span class="n">relativeFileName</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">gui</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">previousSettings</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="p">(</span><span class="bp">False</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">trace_startup</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="s">&#39;Commands.__init__ </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">(</span><span class="n">fileName</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">trace_startup</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">()))</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">trace_startup</span><span class="p">:</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>

        <span class="c"># Official ivars.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_currentPosition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nullPosition</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_topPosition</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nullPosition</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gui</span> <span class="o">=</span> <span class="n">gui</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ipythonController</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="c"># Set only by the ipython plugin.</span>

        <span class="c"># The order of these calls does not matter.</span>
        <span class="n">c</span><span class="o">.</span><span class="n">initCommandIvars</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">initDebugIvars</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">initDocumentIvars</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">initEventIvars</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">initFileIvars</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">relativeFileName</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">initOptionsIvars</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">initObjectIvars</span><span class="p">()</span>

        <span class="c"># Init the settings *before* initing the objects.</span>
        <span class="kn">import</span> <span class="nn">leo.core.leoConfig</span> <span class="kn">as</span> <span class="nn">leoConfig</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">leoConfig</span><span class="o">.</span><span class="n">LocalConfigManager</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">previousSettings</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">setIvarsFromSettings</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="c"># Initialize all subsidiary objects, including subcommanders.</span>
        <span class="n">c</span><span class="o">.</span><span class="n">initObjects</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gui</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span>
        <span class="k">assert</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">c</span>

        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">trace_startup</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">printDiffTime</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">: after controllers created&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">),</span><span class="n">t1</span><span class="p">)</span>

        <span class="c"># Complete the init!</span>
        <span class="n">c</span><span class="o">.</span><span class="n">finishCreate</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">trace_startup</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">printDiffTime</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">: after c.finishCreate&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">),</span><span class="n">t1</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20120217070122.10475: *5* c.computeWindowTitle</span>
<div class="viewcode-block" id="Commands.computeWindowTitle"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.computeWindowTitle">[docs]</a>    <span class="k">def</span> <span class="nf">computeWindowTitle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Set the window title and fileName.&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">fileName</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">computeWindowTitle</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;untitled&quot;</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">numberOfUntitledWindows</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">computeWindowTitle</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">numberOfUntitledWindows</span> <span class="o">=</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span>

        <span class="k">return</span> <span class="n">title</span>
    <span class="c">#@+node:ekr.20120217070122.10473: *5* c.initCommandIvars</span></div>
<div class="viewcode-block" id="Commands.initCommandIvars"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.initCommandIvars">[docs]</a>    <span class="k">def</span> <span class="nf">initCommandIvars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Init ivars used while executing a command.&#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">commandsDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disableCommandsMessage</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="c"># The presence of this message disables all commands.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hookFunction</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="c">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignoreChangedPaths</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="c"># True: disable path changed message in at.WriteAllHelper.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inCommand</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="c"># Interlocks to prevent premature closing of a window.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isZipped</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="c"># Set by g.openWithFileName.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outlineToNowebDefaultFileName</span> <span class="o">=</span> <span class="s">&quot;noweb.nw&quot;</span>
            <span class="c"># For Outline To Noweb dialog.</span>

        <span class="c"># For tangle/untangle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tangle_errors</span> <span class="o">=</span> <span class="mi">0</span>


        <span class="c"># Default Tangle options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_header_flag</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_doc_flag</span> <span class="o">=</span> <span class="bp">False</span>


        <span class="c"># For hoist/dehoist commands.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hoistStack</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c"># Stack of nodes to be root of drawn tree.</span>
            <span class="c"># Affects drawing routines and find commands.</span>

        <span class="c"># For outline navigation.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">navPrefix</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">u</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span> <span class="c"># Must always be a string.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">navTime</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20120217070122.10466: *5* c.initDebugIvars</span></div>
<div class="viewcode-block" id="Commands.initDebugIvars"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.initDebugIvars">[docs]</a>    <span class="k">def</span> <span class="nf">initDebugIvars</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">command_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scanAtPathDirectivesCount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trace_focus_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c">#@+node:ekr.20120217070122.10471: *5* c.initDocumentIvars</span></div>
<div class="viewcode-block" id="Commands.initDocumentIvars"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.initDocumentIvars">[docs]</a>    <span class="k">def</span> <span class="nf">initDocumentIvars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Init per-document ivars.&#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">expansionLevel</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c"># The expansion level of this outline.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expansionNode</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="c"># The last node we expanded or contracted.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeConflictList</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c"># List of nodes with conflicting read-time data.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeConflictFileName</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="c"># The fileName for c.nodeConflictList.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeStampDict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c">#@+node:ekr.20120217070122.10467: *5* c.initEventIvars</span></div>
<div class="viewcode-block" id="Commands.initEventIvars"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.initEventIvars">[docs]</a>    <span class="k">def</span> <span class="nf">initEventIvars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">configInited</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doubleClickFlag</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exists</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="c"># Indicate that this class exists and has not been destroyed.</span>
            <span class="c"># Do this early in the startup process so we can call hooks.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hasFocusWidget</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idle_callback</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="c"># For c.idle_focus_helper.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_qt_dialog</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="c"># True: in a qt dialog.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loading</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="c"># True: we are loading a file: disables c.setChanged()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">promptingForClose</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="c"># True: lock out additional closing dialogs.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suppressHeadChanged</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="c"># True: prevent setting c.changed when switching chapters.</span>

        <span class="c"># Flags for c.outerUpdate...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requestBringToFront</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># A commander, or None.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requestCloseWindow</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requestedFocusWidget</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requestRedrawFlag</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requestedIconify</span> <span class="o">=</span> <span class="s">&#39;&#39;</span> <span class="c"># &#39;iconify&#39;,&#39;deiconify&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requestRecolorFlag</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20120217070122.10472: *5* c.initFileIvars</span></div>
<div class="viewcode-block" id="Commands.initFileIvars"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.initFileIvars">[docs]</a>    <span class="k">def</span> <span class="nf">initFileIvars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span><span class="n">relativeFileName</span><span class="p">):</span>

        <span class="c"># if not fileName: fileName = &#39;&#39;</span>
        <span class="c"># if not relativeFileName: relativeFileName = &#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="c"># True: the ouline has changed since the last save.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignored_at_file_nodes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c"># List of nodes for error dialog.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_error_nodes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mFileName</span> <span class="o">=</span> <span class="n">fileName</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
            <span class="c"># Do _not_ use os_path_norm: it converts an empty path to &#39;.&#39; (!!)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mRelativeFileName</span> <span class="o">=</span> <span class="n">relativeFileName</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
            <span class="c">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">openDirectory</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20120217070122.10469: *5* c.initOptionsIvars</span></div>
<div class="viewcode-block" id="Commands.initOptionsIvars"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.initOptionsIvars">[docs]</a>    <span class="k">def</span> <span class="nf">initOptionsIvars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># print(&#39;c.initOptionsIvars&#39;)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixedWindowPosition</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">focus_border_color</span> <span class="o">=</span> <span class="s">&#39;white&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">focus_border_width</span> <span class="o">=</span> <span class="mi">1</span> <span class="c"># pixels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outlineHasInitialFocus</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">page_width</span> <span class="o">=</span> <span class="mi">132</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparse_find</span> <span class="o">=</span> <span class="bp">True</span>     
        <span class="bp">self</span><span class="o">.</span><span class="n">sparse_move</span> <span class="o">=</span> <span class="bp">True</span>    
        <span class="bp">self</span><span class="o">.</span><span class="n">sparse_spell</span> <span class="o">=</span> <span class="bp">True</span>   
        <span class="bp">self</span><span class="o">.</span><span class="n">stayInTreeAfterSelect</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tab_width</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tangle_batch_flag</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_language</span> <span class="o">=</span> <span class="s">&quot;python&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">untangle_batch_flag</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_body_focus_border</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_focus_border</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20120217070122.10468: *5* c.initObjectIvars</span></div>
<div class="viewcode-block" id="Commands.initObjectIvars"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.initObjectIvars">[docs]</a>    <span class="k">def</span> <span class="nf">initObjectIvars</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># These ivars are set later by leoEditCommands.createEditCommanders</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abbrevCommands</span>  <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bufferCommands</span>  <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">editCommands</span>    <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># May be set to a PickleShare instance later.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chapterCommands</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">controlCommands</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debugCommands</span>   <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">editFileCommands</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">helpCommands</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyHandler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyHandlerCommands</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">killBufferCommands</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leoCommands</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">macroCommands</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">miniBufferWidget</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queryReplaceCommands</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rectangleCommands</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerCommands</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">searchCommands</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spellCommands</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leoTestManager</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20120217070122.10470: *5* c.initObjects</span></div>
<div class="viewcode-block" id="Commands.initObjects"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.initObjects">[docs]</a>    <span class="k">def</span> <span class="nf">initObjects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">gui</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="p">(</span><span class="bp">False</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">trace_startup</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;g.initObjects </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">c</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">(),</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hiddenRootNode</span> <span class="o">=</span> <span class="n">leoNodes</span><span class="o">.</span><span class="n">vnode</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hiddenRootNode</span><span class="o">.</span><span class="n">setHeadString</span><span class="p">(</span><span class="s">&#39;&lt;hidden root vnode&gt;&#39;</span><span class="p">)</span>

        <span class="c"># Create the gui frame.</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">computeWindowTitle</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">initing</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&quot;before-create-leo-frame&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span> <span class="o">=</span> <span class="n">gui</span><span class="o">.</span><span class="n">createLeoFrame</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">title</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">c</span> <span class="o">==</span> <span class="n">c</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nodeHistory</span> <span class="o">=</span> <span class="n">nodeHistory</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initConfigSettings</span><span class="p">()</span>

        <span class="n">c</span><span class="o">.</span><span class="n">setWindowPosition</span><span class="p">()</span> <span class="c"># Do this after initing settings.</span>

        <span class="c"># Break circular import dependencies by importing here.</span>
        <span class="c"># These imports take almost 3/4 sec in the leoBridge.</span>
        <span class="kn">import</span> <span class="nn">leo.core.leoAtFile</span> <span class="kn">as</span> <span class="nn">leoAtFile</span>
        <span class="kn">import</span> <span class="nn">leo.core.leoCache</span> <span class="kn">as</span> <span class="nn">leoCache</span>
        <span class="kn">import</span> <span class="nn">leo.core.leoChapters</span> <span class="kn">as</span> <span class="nn">leoChapters</span>
        <span class="kn">import</span> <span class="nn">leo.core.leoEditCommands</span> <span class="kn">as</span> <span class="nn">leoEditCommands</span>
        <span class="kn">import</span> <span class="nn">leo.core.leoKeys</span> <span class="kn">as</span> <span class="nn">leoKeys</span>
        <span class="kn">import</span> <span class="nn">leo.core.leoFileCommands</span> <span class="kn">as</span> <span class="nn">leoFileCommands</span>
        <span class="kn">import</span> <span class="nn">leo.core.leoImport</span> <span class="kn">as</span> <span class="nn">leoImport</span>
        <span class="kn">import</span> <span class="nn">leo.core.leoRst</span> <span class="kn">as</span> <span class="nn">leoRst</span>
        <span class="kn">import</span> <span class="nn">leo.core.leoShadow</span> <span class="kn">as</span> <span class="nn">leoShadow</span>
        <span class="kn">import</span> <span class="nn">leo.core.leoTangle</span> <span class="kn">as</span> <span class="nn">leoTangle</span>
        <span class="kn">import</span> <span class="nn">leo.core.leoTest</span> <span class="kn">as</span> <span class="nn">leoTest</span>
        <span class="kn">import</span> <span class="nn">leo.core.leoUndo</span> <span class="kn">as</span> <span class="nn">leoUndo</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">keyHandler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">leoKeys</span><span class="o">.</span><span class="n">keyHandlerClass</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chapterController</span>  <span class="o">=</span> <span class="n">leoChapters</span><span class="o">.</span><span class="n">chapterController</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shadowController</span>   <span class="o">=</span> <span class="n">leoShadow</span><span class="o">.</span><span class="n">shadowController</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fileCommands</span>       <span class="o">=</span> <span class="n">leoFileCommands</span><span class="o">.</span><span class="n">fileCommands</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atFileCommands</span>     <span class="o">=</span> <span class="n">leoAtFile</span><span class="o">.</span><span class="n">atFile</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">importCommands</span>     <span class="o">=</span> <span class="n">leoImport</span><span class="o">.</span><span class="n">leoImportCommands</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rstCommands</span>        <span class="o">=</span> <span class="n">leoRst</span><span class="o">.</span><span class="n">rstCommands</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tangleCommands</span>     <span class="o">=</span> <span class="n">leoTangle</span><span class="o">.</span><span class="n">tangleCommands</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">testManager</span>        <span class="o">=</span> <span class="n">leoTest</span><span class="o">.</span><span class="n">TestManager</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">editCommandsManager</span> <span class="o">=</span> <span class="n">leoEditCommands</span><span class="o">.</span><span class="n">EditCommandsManager</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">editCommandsManager</span><span class="o">.</span><span class="n">createEditCommanders</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cacher</span> <span class="o">=</span> <span class="n">leoCache</span><span class="o">.</span><span class="n">cacher</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cacher</span><span class="o">.</span><span class="n">initFileDB</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mFileName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">undoer</span> <span class="o">=</span> <span class="n">leoUndo</span><span class="o">.</span><span class="n">undoer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">leo.plugins.free_layout</span> <span class="kn">as</span> <span class="nn">free_layout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">free_layout</span> <span class="o">=</span> <span class="n">free_layout</span><span class="o">.</span><span class="n">FreeLayoutController</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2814: *4* c.__repr__ &amp; __str__</span></div>
    <span class="k">def</span> <span class="nf">__repr__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="s">&quot;Commander </span><span class="si">%d</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mFileName</span><span class="p">))</span>

    <span class="n">__str__</span> <span class="o">=</span> <span class="n">__repr__</span>
    <span class="c">#@+node:ekr.20050920093543: *4* c.finishCreate &amp; helper</span>
<div class="viewcode-block" id="Commands.finishCreate"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.finishCreate">[docs]</a>    <span class="k">def</span> <span class="nf">finishCreate</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Finish creating the commander and all sub-objects.</span>

<span class="sd">        This is the last step in the startup process.&#39;&#39;&#39;</span>

        <span class="c"># trace = (False or g.trace_startup) and not g.unitTesting</span>
        <span class="c"># if trace: print(&#39;c.finishCreate&#39;)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">k</span>
        <span class="c"># p = c.p</span>
        <span class="k">assert</span> <span class="n">c</span><span class="o">.</span><span class="n">gui</span>
        <span class="k">assert</span> <span class="n">k</span>

        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">finishCreate</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">miniBufferWidget</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">miniBufferWidget</span>
            <span class="c"># Will be None for nullGui.</span>

        <span class="c"># This costs little.</span>
        <span class="n">c</span><span class="o">.</span><span class="n">commandsDict</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">editCommandsManager</span><span class="o">.</span><span class="n">finishCreateEditCommanders</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rstCommands</span><span class="o">.</span><span class="n">finishCreate</span><span class="p">()</span>

        <span class="c"># copy global commands to this controller    </span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">global_commands_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">k</span><span class="o">.</span><span class="n">registerCommand</span><span class="p">(</span><span class="n">name</span><span class="p">,</span>
                <span class="n">shortcut</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">func</span><span class="o">=</span><span class="n">f</span><span class="p">,</span><span class="n">pane</span><span class="o">=</span><span class="s">&#39;all&#39;</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>        

        <span class="n">k</span><span class="o">.</span><span class="n">finishCreate</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">isNullGui</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">registerHandler</span><span class="p">(</span><span class="s">&#39;idle&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">idle_focus_helper</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">finishCreate</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">finishCreate</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">undoer</span><span class="o">.</span><span class="n">clearUndoState</span><span class="p">()</span>
            <span class="c"># Menus must exist at this point.</span>

        <span class="c"># Do not call chapterController.finishCreate here:</span>
        <span class="c"># It must be called after the first real redraw.</span>
        <span class="n">c</span><span class="o">.</span><span class="n">bodyWantsFocus</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20051007143620: *5* printCommandsDict</span></div>
<div class="viewcode-block" id="Commands.printCommandsDict"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.printCommandsDict">[docs]</a>    <span class="k">def</span> <span class="nf">printCommandsDict</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Commands...&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">commandsDict</span><span class="p">):</span>
            <span class="n">command</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">commandsDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%30s</span><span class="s"> = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">key</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">command</span><span class="p">,</span><span class="n">command</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span><span class="s">&#39;&lt;None&gt;&#39;</span><span class="p">)))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20041130173135: *4* c.hash</span>
    <span class="c"># This is a bad idea.</span></div>
<div class="viewcode-block" id="Commands.hash"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.hash">[docs]</a>    <span class="k">def</span> <span class="nf">hash</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">os_path_finalize</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
    <span class="c">#@+node:ekr.20110509064011.14563: *4* c.idle_focus_helper</span></div>
    <span class="n">idle_focus_count</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="Commands.idle_focus_helper"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.idle_focus_helper">[docs]</a>    <span class="k">def</span> <span class="nf">idle_focus_helper</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tag</span><span class="p">,</span><span class="n">keys</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;An idle-tme handler that ensures that focus is *somewhere*.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># False: only print surprises.</span>
        <span class="n">active</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># True: actually change the focus.</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">assert</span> <span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;idle&#39;</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span> <span class="ow">or</span> <span class="n">keys</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;c&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">c</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">idle_focus_count</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">in_qt_dialog</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;in_qt_dialog&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">idle_callback</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;calling c.idle_callback&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">idle_callback</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">idle_callback</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">idle_callback</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">return</span>

        <span class="n">w</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">get_focus</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">w</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idle_focus_count</span><span class="p">,</span><span class="n">w</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">active</span><span class="p">:</span> <span class="c"># Set by gui.onActivate/onDeactivate.</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> no focus -&gt; body&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idle_focus_count</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">active</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">bodyWantsFocusNow</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20081005065934.1: *4* c.initAfterLoad</span></div>
<div class="viewcode-block" id="Commands.initAfterLoad"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.initAfterLoad">[docs]</a>    <span class="k">def</span> <span class="nf">initAfterLoad</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Provide an offical hook for late inits of the commander.&#39;&#39;&#39;</span>

        <span class="k">pass</span>
    <span class="c">#@+node:ekr.20090213065933.6: *4* c.initConfigSettings</span></div>
<div class="viewcode-block" id="Commands.initConfigSettings"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.initConfigSettings">[docs]</a>    <span class="k">def</span> <span class="nf">initConfigSettings</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Init all cached commander config settings.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="p">(</span><span class="bp">False</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">trace_startup</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;c.initConfigSettings: c.configInited: </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">c</span><span class="o">.</span><span class="n">configInited</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">()))</span>

        <span class="n">getBool</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getBool</span>
        <span class="n">getColor</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getColor</span>
        <span class="n">getData</span>  <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getData</span>
        <span class="n">getInt</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getInt</span>

        <span class="n">c</span><span class="o">.</span><span class="n">autoindent_in_nocolor</span>     <span class="o">=</span> <span class="n">getBool</span><span class="p">(</span><span class="s">&#39;autoindent_in_nocolor_mode&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">collapse_nodes_after_move</span> <span class="o">=</span> <span class="n">getBool</span><span class="p">(</span><span class="s">&#39;collapse_nodes_after_move&#39;</span><span class="p">)</span>
            <span class="c"># Patch by nh2: 0004-Add-bool-collapse_nodes_after_move-option.patch</span>
        <span class="n">c</span><span class="o">.</span><span class="n">collapse_on_lt_arrow</span>      <span class="o">=</span> <span class="n">getBool</span><span class="p">(</span><span class="s">&#39;collapse_on_lt_arrow&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="c"># 2011/11/09: An excellent, subliminal, improvement.</span>
        <span class="n">c</span><span class="o">.</span><span class="n">contractVisitedNodes</span>      <span class="o">=</span> <span class="n">getBool</span><span class="p">(</span><span class="s">&#39;contractVisitedNodes&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">fixed</span>                     <span class="o">=</span> <span class="n">getBool</span><span class="p">(</span><span class="s">&#39;fixedWindow&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">fixedWindowPosition</span>       <span class="o">=</span> <span class="n">getData</span><span class="p">(</span><span class="s">&#39;fixedWindowPosition&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">focus_border_color</span>        <span class="o">=</span> <span class="n">getColor</span><span class="p">(</span><span class="s">&#39;focus_border_color&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;red&#39;</span>
        <span class="n">c</span><span class="o">.</span><span class="n">focus_border_command_state_color</span> <span class="o">=</span> <span class="n">getColor</span><span class="p">(</span>
            <span class="s">&#39;focus_border_command_state_color&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;blue&#39;</span>
        <span class="n">c</span><span class="o">.</span><span class="n">focus_border_overwrite_state_color</span> <span class="o">=</span> <span class="n">getColor</span><span class="p">(</span>
            <span class="s">&#39;focus_border_overwrite_state_color&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;green&#39;</span>
        <span class="n">c</span><span class="o">.</span><span class="n">focus_border_width</span>        <span class="o">=</span> <span class="n">getInt</span><span class="p">(</span><span class="s">&#39;focus_border_width&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">1</span> <span class="c"># pixels</span>
        <span class="n">c</span><span class="o">.</span><span class="n">outlineHasInitialFocus</span>    <span class="o">=</span> <span class="n">getBool</span><span class="p">(</span><span class="s">&#39;outline_pane_has_initial_focus&#39;</span><span class="p">)</span>
        <span class="c"># c.showMinibuffer            = getBool(&#39;useMinibuffer&#39;)</span>
            <span class="c"># This option is a bad idea.</span>
        <span class="n">c</span><span class="o">.</span><span class="n">page_width</span>                <span class="o">=</span> <span class="n">getInt</span><span class="p">(</span><span class="s">&#39;page_width&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">132</span>
            <span class="c"># 2012/02/27: this appears to be a fix of an *ancient* bug.</span>
        <span class="n">c</span><span class="o">.</span><span class="n">putBitsFlag</span>               <span class="o">=</span> <span class="n">getBool</span><span class="p">(</span><span class="s">&#39;put_expansion_bits_in_leo_files&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">sparse_move</span>               <span class="o">=</span> <span class="n">getBool</span><span class="p">(</span><span class="s">&#39;sparse_move_outline_left&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">sparse_find</span>               <span class="o">=</span> <span class="n">getBool</span><span class="p">(</span><span class="s">&#39;collapse_nodes_during_finds&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">sparce_spell</span>              <span class="o">=</span> <span class="n">getBool</span><span class="p">(</span><span class="s">&#39;collapse_nodes_while_spelling&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">stayInTreeAfterSelect</span>     <span class="o">=</span> <span class="n">getBool</span><span class="p">(</span><span class="s">&#39;stayInTreeAfterSelect&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">stayInTreeAfterEdit</span>       <span class="o">=</span> <span class="n">getBool</span><span class="p">(</span><span class="s">&#39;stayInTreeAfterEditHeadline&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">smart_tab</span>                 <span class="o">=</span> <span class="n">getBool</span><span class="p">(</span><span class="s">&#39;smart_tab&#39;</span><span class="p">)</span>
            <span class="c"># Note: there is also a smart_auto_indent setting.</span>
        <span class="n">c</span><span class="o">.</span><span class="n">tab_width</span>                 <span class="o">=</span> <span class="n">getInt</span><span class="p">(</span><span class="s">&#39;tab_width&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="o">-</span><span class="mi">4</span>
        <span class="n">c</span><span class="o">.</span><span class="n">use_body_focus_border</span>     <span class="o">=</span> <span class="n">getBool</span><span class="p">(</span><span class="s">&#39;use_body_focus_border&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">use_focus_border</span>          <span class="o">=</span> <span class="n">getBool</span><span class="p">(</span><span class="s">&#39;use_focus_border&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">write_script_file</span>         <span class="o">=</span> <span class="n">getBool</span><span class="p">(</span><span class="s">&#39;write_script_file&#39;</span><span class="p">)</span>

        <span class="c"># g.trace(&#39;smart %s, tab_width %s&#39; % (c.smart_tab, c.tab_width))</span>
        <span class="c"># g.trace(c.sparse_move)</span>
    <span class="c">#@+node:ekr.20090213065933.7: *4* c.setWindowPosition</span></div>
<div class="viewcode-block" id="Commands.setWindowPosition"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.setWindowPosition">[docs]</a>    <span class="k">def</span> <span class="nf">setWindowPosition</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># g.trace(c.fixed,c.fixedWindowPosition)</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">fixedWindowPosition</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">w</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixedWindowPosition</span>
                <span class="n">c</span><span class="o">.</span><span class="n">fixedWindowPosition</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">w</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">h</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;bad @data fixedWindowPosition&#39;</span><span class="p">,</span>
                    <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fixedWindowPosition</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">windowPosition</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span><span class="mi">700</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">50</span> <span class="c"># width,height,left,top.</span>
    <span class="c">#@+node:ekr.20031218072017.2817: *3*  c.doCommand</span></div>
    <span class="n">command_count</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="Commands.doCommand"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.doCommand">[docs]</a>    <span class="k">def</span> <span class="nf">doCommand</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">command</span><span class="p">,</span><span class="n">label</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Execute the given command, invoking hooks and catching exceptions.</span>

<span class="sd">        The code assumes that the &quot;command1&quot; hook has completely handled the command if</span>
<span class="sd">        g.doHook(&quot;command1&quot;) returns False.</span>
<span class="sd">        This provides a simple mechanism for overriding commands.&quot;&quot;&quot;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="n">commandName</span> <span class="o">=</span> <span class="n">command</span> <span class="ow">and</span> <span class="n">command</span><span class="o">.</span><span class="n">__name__</span>
        <span class="n">c</span><span class="o">.</span><span class="n">setLog</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">command_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getBool</span><span class="p">(</span><span class="s">&#39;trace_doCommand&#39;</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">commandName</span><span class="p">)</span>

        <span class="c"># The presence of this message disables all commands.</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">disableCommandsMessage</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">disableCommandsMessage</span><span class="p">)</span>
            <span class="k">return</span> <span class="c"># (for Tk) &#39;break&#39; # Inhibit all other handlers.</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">exists</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">inCommand</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
            <span class="c"># g.trace(&#39;inCommand&#39;,c)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">commandInterruptFlag</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;ignoring command: already executing a command.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="c"># (for Tk) &#39;break&#39;</span>

        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">commandInterruptFlag</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">label</span> <span class="ow">and</span> <span class="n">event</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="c"># Do this only for legacy commands.</span>
            <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="s">&quot;cantredo&quot;</span><span class="p">:</span> <span class="n">label</span> <span class="o">=</span> <span class="s">&quot;redo&quot;</span>
            <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="s">&quot;cantundo&quot;</span><span class="p">:</span> <span class="n">label</span> <span class="o">=</span> <span class="s">&quot;undo&quot;</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">commandName</span> <span class="o">=</span> <span class="n">label</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&quot;command1&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">p</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">inCommand</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;start&#39;</span><span class="p">,</span><span class="n">command</span><span class="p">)</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">command</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;end&#39;</span><span class="p">,</span><span class="n">command</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span> <span class="c"># Be careful: the command could destroy c.</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">inCommand</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">funcReturn</span> <span class="o">=</span> <span class="n">val</span>
                <span class="c"># else: g.pr(&#39;c no longer exists&#39;,c)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">inCommand</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&quot;exception executing command&quot;</span><span class="p">)</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">c</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">requestCloseWindow</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;closing window after command&#39;</span><span class="p">)</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">requestCloseWindow</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">closeLeoWindow</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;calling outerUpdate&#39;</span><span class="p">)</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">outerUpdate</span><span class="p">()</span>

        <span class="c"># Be careful: the command could destroy c.</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
            <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&quot;command2&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">p</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

        <span class="k">return</span> <span class="c"># (for Tk) &quot;break&quot; # Inhibit all other handlers.</span>
    <span class="c">#@+node:ekr.20080514131122.20: *4* c.outerUpdate</span></div>
<div class="viewcode-block" id="Commands.outerUpdate"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.outerUpdate">[docs]</a>    <span class="k">def</span> <span class="nf">outerUpdate</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">;</span> <span class="n">traceFocus</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">aList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">exists</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">k</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c"># Suppress any requested redraw until we have iconified or diconified.</span>
        <span class="n">redrawFlag</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">requestRedrawFlag</span>
        <span class="n">c</span><span class="o">.</span><span class="n">requestRedrawFlag</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="p">(</span><span class="n">verbose</span> <span class="ow">or</span> <span class="n">aList</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;**start&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">()</span> <span class="ow">or</span> <span class="s">&#39;&lt;unnamed&gt;&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">requestBringToFront</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span><span class="s">&#39;bringToFront&#39;</span><span class="p">):</span>
                <span class="c">### c.frame.bringToFront()</span>
                <span class="n">c</span><span class="o">.</span><span class="n">requestBringToFront</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">bringToFront</span><span class="p">()</span>
                    <span class="c"># c.requestBringToFront is a commander.</span>
            <span class="n">c</span><span class="o">.</span><span class="n">requestBringToFront</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># The iconify requests are made only by c.bringToFront.</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">requestedIconify</span> <span class="o">==</span> <span class="s">&#39;iconify&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">aList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;iconify&#39;</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">iconify</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">requestedIconify</span> <span class="o">==</span> <span class="s">&#39;deiconify&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">aList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;deiconify&#39;</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">deiconify</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">redrawFlag</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;****&#39;</span><span class="p">,</span><span class="s">&#39;tree.drag_p&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">drag_p</span><span class="p">)</span>
            <span class="c"># A hack: force the redraw, even if we are dragging.</span>
            <span class="n">aList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;*** redraw&#39;</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">redraw_now</span><span class="p">(</span><span class="n">forceDraw</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">requestRecolorFlag</span><span class="p">:</span>
            <span class="n">aList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">recolor&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">incrementalRecolorFlag</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;full &#39;</span><span class="p">)))</span>
            <span class="c"># This should be the only call to c.recolor_now.</span>
            <span class="n">c</span><span class="o">.</span><span class="n">recolor_now</span><span class="p">(</span><span class="n">incremental</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">incrementalRecolorFlag</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">requestedFocusWidget</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">requestedFocusWidget</span>
            <span class="k">if</span> <span class="n">traceFocus</span><span class="p">:</span> <span class="n">aList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;focus: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">widget_name</span><span class="p">(</span><span class="n">w</span><span class="p">)))</span>
            <span class="n">c</span><span class="o">.</span><span class="n">set_focus</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># We must not set the focus to the body pane here!</span>
            <span class="c"># That would make nested calls to c.outerUpdate significant.</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="p">(</span><span class="n">verbose</span> <span class="ow">or</span> <span class="n">aList</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;** end&#39;</span><span class="p">,</span><span class="n">aList</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">incrementalRecolorFlag</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">c</span><span class="o">.</span><span class="n">requestRecolorFlag</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">c</span><span class="o">.</span><span class="n">requestRedrawFlag</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">c</span><span class="o">.</span><span class="n">requestedFocusWidget</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">c</span><span class="o">.</span><span class="n">requestedIconify</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">mods</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">childrenModifiedSet</span>
        <span class="k">if</span> <span class="n">mods</span><span class="p">:</span>
            <span class="c">#print(mods)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&quot;childrenModified&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">mods</span><span class="p">)</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">mods</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">contentModifiedSet</span>
        <span class="k">if</span> <span class="n">mods</span><span class="p">:</span>
            <span class="c">#print(mods)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&quot;contentModified&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">mods</span><span class="p">)</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="c"># g.trace(&#39;after&#39;)</span>
    <span class="c">#@+node:ekr.20110510052422.14618: *3* c.alert</span></div>
<div class="viewcode-block" id="Commands.alert"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.alert">[docs]</a>    <span class="k">def</span> <span class="nf">alert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">message</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># The unit tests just tests the args.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">alert</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">message</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20110605040658.17005: *3* c.check_event</span></div>
<div class="viewcode-block" id="Commands.check_event"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.check_event">[docs]</a>    <span class="k">def</span> <span class="nf">check_event</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

        <span class="n">c</span><span class="p">,</span><span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span>

        <span class="kn">import</span> <span class="nn">leo.core.leoGui</span> <span class="kn">as</span> <span class="nn">leoGui</span>

        <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="n">message</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">val</span><span class="p">,</span><span class="n">message</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">val</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;check_event&#39;</span><span class="p">,</span><span class="n">message</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">isLeoKeyEvent</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="n">leoGui</span><span class="o">.</span><span class="n">leoKeyEvent</span><span class="p">)</span>
        <span class="n">stroke</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">stroke</span>
        <span class="n">got</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">char</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;plain: </span><span class="si">%s</span><span class="s">, stroke: </span><span class="si">%s</span><span class="s">, char: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">k</span><span class="o">.</span><span class="n">isPlainKey</span><span class="p">(</span><span class="n">stroke</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">stroke</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">char</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
            <span class="n">expected</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">stroke2char</span><span class="p">(</span><span class="n">stroke</span><span class="p">)</span>
                <span class="c"># Be strict for unit testing.</span>
        <span class="k">elif</span> <span class="n">stroke</span> <span class="ow">and</span> <span class="p">(</span><span class="n">stroke</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;Alt+&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">stroke</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;Ctrl+&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">expected</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">char</span>
                <span class="c"># Alas, Alt and Ctrl bindings must *retain* the char field,</span>
                <span class="c"># so there is no way to know what char field to expect.</span>
        <span class="k">elif</span> <span class="n">trace</span> <span class="ow">or</span> <span class="n">k</span><span class="o">.</span><span class="n">isPlainKey</span><span class="p">(</span><span class="n">stroke</span><span class="p">):</span>
            <span class="n">expected</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">stroke2char</span><span class="p">(</span><span class="n">stroke</span><span class="p">)</span>
                <span class="c"># Perform the full test.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expected</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">char</span>
                <span class="c"># disable the test.</span>
                <span class="c"># We will use the (weird) key value for, say, Ctrl-s,</span>
                <span class="c"># if there is no binding for Ctrl-s.</span>

        <span class="n">test</span><span class="p">(</span><span class="n">isLeoKeyEvent</span><span class="p">,</span><span class="s">&#39;not leo event: </span><span class="si">%s</span><span class="s">, callers: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">repr</span><span class="p">(</span><span class="n">event</span><span class="p">),</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">()))</span>

        <span class="n">test</span><span class="p">(</span><span class="n">expected</span> <span class="o">==</span> <span class="n">got</span><span class="p">,</span><span class="s">&#39;stroke: </span><span class="si">%s</span><span class="s">, expected char: </span><span class="si">%s</span><span class="s">, got: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">stroke</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">expected</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">got</span><span class="p">)))</span>
    <span class="c">#@+node:ekr.20120306130648.9849: *3* c.enableMenuBar</span></div>
<div class="viewcode-block" id="Commands.enableMenuBar"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.enableMenuBar">[docs]</a>    <span class="k">def</span> <span class="nf">enableMenuBar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;A failed attempt to work around Ubuntu Unity memory bugs.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># g.trace(c.frame.title,g.callers())</span>

        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">isNull</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">windowList</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">frame</span> <span class="o">!=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="p">:</span>
                    <span class="n">frame</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">menuBar</span><span class="o">.</span><span class="n">setDisabled</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">menuBar</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20080901124540.1: *3* c.Directive scanning</span>
    <span class="c"># These are all new in Leo 4.5.1.</span>
    <span class="c">#@+node:ekr.20080827175609.39: *4* c.scanAllDirectives</span></div>
<div class="viewcode-block" id="Commands.scanAllDirectives"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.scanAllDirectives">[docs]</a>    <span class="k">def</span> <span class="nf">scanAllDirectives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">scanToCursor</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Scan p and ancestors for directives.</span>

<span class="sd">        Returns a dict containing the results, including defaults.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="c"># Set defaults</span>
        <span class="n">language</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">target_language</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">target_language</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">lang_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;language&#39;</span><span class="p">:</span><span class="n">language</span><span class="p">,</span>
            <span class="s">&#39;delims&#39;</span><span class="p">:</span><span class="n">g</span><span class="o">.</span><span class="n">set_delims_from_language</span><span class="p">(</span><span class="n">language</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">wrap</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getBool</span><span class="p">(</span><span class="s">&quot;body_pane_wraps&quot;</span><span class="p">)</span>

        <span class="n">table</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="s">&#39;encoding&#39;</span><span class="p">,</span>    <span class="bp">None</span><span class="p">,</span>           <span class="n">g</span><span class="o">.</span><span class="n">scanAtEncodingDirectives</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;lang-dict&#39;</span><span class="p">,</span>   <span class="n">lang_dict</span><span class="p">,</span>      <span class="n">g</span><span class="o">.</span><span class="n">scanAtCommentAndAtLanguageDirectives</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;lineending&#39;</span><span class="p">,</span>  <span class="bp">None</span><span class="p">,</span>           <span class="n">g</span><span class="o">.</span><span class="n">scanAtLineendingDirectives</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;pagewidth&#39;</span><span class="p">,</span>   <span class="n">c</span><span class="o">.</span><span class="n">page_width</span><span class="p">,</span>   <span class="n">g</span><span class="o">.</span><span class="n">scanAtPagewidthDirectives</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;path&#39;</span><span class="p">,</span>        <span class="bp">None</span><span class="p">,</span>           <span class="n">c</span><span class="o">.</span><span class="n">scanAtPathDirectives</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;tabwidth&#39;</span><span class="p">,</span>    <span class="n">c</span><span class="o">.</span><span class="n">tab_width</span><span class="p">,</span>    <span class="n">g</span><span class="o">.</span><span class="n">scanAtTabwidthDirectives</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;wrap&#39;</span><span class="p">,</span>        <span class="n">wrap</span><span class="p">,</span>           <span class="n">g</span><span class="o">.</span><span class="n">scanAtWrapDirectives</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c"># Set d by scanning all directives.</span>
        <span class="n">aList</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_directives_dict_list</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">scanToCursor</span><span class="o">=</span><span class="n">scanToCursor</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">default</span><span class="p">,</span><span class="n">func</span> <span class="ow">in</span> <span class="n">table</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">aList</span><span class="p">)</span>
            <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">val</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span><span class="n">default</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>

        <span class="c"># Post process: do *not* set commander ivars.</span>
        <span class="n">lang_dict</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;lang-dict&#39;</span><span class="p">)</span>

        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&quot;delims&quot;</span>        <span class="p">:</span> <span class="n">lang_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;delims&#39;</span><span class="p">),</span>
            <span class="s">&quot;encoding&quot;</span>      <span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;encoding&#39;</span><span class="p">),</span>
            <span class="s">&quot;language&quot;</span>      <span class="p">:</span> <span class="n">lang_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;language&#39;</span><span class="p">),</span>
            <span class="s">&quot;lineending&quot;</span>    <span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;lineending&#39;</span><span class="p">),</span>
            <span class="s">&quot;pagewidth&quot;</span>     <span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;pagewidth&#39;</span><span class="p">),</span>
            <span class="s">&quot;path&quot;</span>          <span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;path&#39;</span><span class="p">),</span> <span class="c"># Redundant: or g.getBaseDirectory(c),</span>
            <span class="s">&quot;tabwidth&quot;</span>      <span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;tabwidth&#39;</span><span class="p">),</span>
            <span class="s">&quot;pluginsList&quot;</span>   <span class="p">:</span> <span class="p">[],</span> <span class="c"># No longer used.</span>
            <span class="s">&quot;wrap&quot;</span>          <span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;wrap&#39;</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">lang_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;language&#39;</span><span class="p">),</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>

        <span class="c"># g.trace(d.get(&#39;tabwidth&#39;))</span>

        <span class="k">return</span> <span class="n">d</span>
    <span class="c">#@+node:ekr.20080828103146.15: *4* c.scanAtPathDirectives</span></div>
<div class="viewcode-block" id="Commands.scanAtPathDirectives"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.scanAtPathDirectives">[docs]</a>    <span class="k">def</span> <span class="nf">scanAtPathDirectives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aList</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Scan aList for @path directives.</span>
<span class="sd">        Return a reasonable default if no @path directive is found.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">c</span><span class="o">.</span><span class="n">scanAtPathDirectivesCount</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c"># An important statistic.</span>
        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;**entry&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

        <span class="c"># Step 1: Compute the starting path.</span>
        <span class="c"># The correct fallback directory is the absolute path to the base.</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">openDirectory</span><span class="p">:</span>  <span class="c"># Bug fix: 2008/9/18</span>
            <span class="n">base</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">openDirectory</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">relative_path_base_directory</span>
            <span class="k">if</span> <span class="n">base</span> <span class="ow">and</span> <span class="n">base</span> <span class="o">==</span> <span class="s">&quot;!&quot;</span><span class="p">:</span>    <span class="n">base</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadDir</span>
            <span class="k">elif</span> <span class="n">base</span> <span class="ow">and</span> <span class="n">base</span> <span class="o">==</span> <span class="s">&quot;.&quot;</span><span class="p">:</span>  <span class="n">base</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">openDirectory</span>

        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;base   &#39;</span><span class="p">,</span><span class="n">base</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;loadDir&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadDir</span><span class="p">)</span>

        <span class="n">absbase</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadDir</span><span class="p">,</span><span class="n">base</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;absbase&#39;</span><span class="p">,</span><span class="n">absbase</span><span class="p">)</span>

        <span class="c"># Step 2: look for @path directives.</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
            <span class="c"># Look for @path directives.</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;path&#39;</span><span class="p">)</span>
            <span class="n">warning</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;@path_in_body&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">path</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;**** d&#39;</span><span class="p">,</span><span class="n">d</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;**** @path path&#39;</span><span class="p">,</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span> <span class="c"># retain empty paths for warnings.</span>
                <span class="c"># Convert &quot;path&quot; or &lt;path&gt; to path.</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">stripPathCruft</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">path</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">warning</span><span class="p">:</span>
                    <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="c"># We will silently ignore empty @path directives.</span>

        <span class="c"># Add absbase and reverse the list.</span>
        <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">absbase</span><span class="p">)</span>
        <span class="n">paths</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>

        <span class="c"># Step 3: Compute the full, effective, absolute path.</span>
        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">printList</span><span class="p">(</span><span class="n">paths</span><span class="p">,</span><span class="n">tag</span><span class="o">=</span><span class="s">&#39;c.scanAtPathDirectives: raw paths&#39;</span><span class="p">)</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="o">*</span><span class="n">paths</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;joined path:&#39;</span><span class="p">,</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;returns&#39;</span><span class="p">,</span><span class="n">path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">path</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">getBaseDirectory</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="c"># 2010/10/22: A useful default.</span>
    <span class="c">#@+node:ekr.20080828103146.12: *4* c.scanAtRootDirectives</span>
    <span class="c"># Called only by scanColorDirectives.</span>
</div>
<div class="viewcode-block" id="Commands.scanAtRootDirectives"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.scanAtRootDirectives">[docs]</a>    <span class="k">def</span> <span class="nf">scanAtRootDirectives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aList</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Scan aList for @root-code and @root-doc directives.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># To keep pylint happy.</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="s">&#39;at_root_bodies_start_in_doc_mode&#39;</span>
        <span class="n">start_in_doc</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="n">tag</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="p">,</span><span class="n">tag</span><span class="p">)</span>

        <span class="c"># New in Leo 4.6: dashes are valid in directive names.</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;root-code&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&#39;code&#39;</span>
            <span class="k">elif</span> <span class="s">&#39;root-doc&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&#39;doc&#39;</span>
            <span class="k">elif</span> <span class="s">&#39;root&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">start_in_doc</span><span class="p">,</span><span class="s">&#39;doc&#39;</span><span class="p">,</span><span class="s">&#39;code&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20080922124033.5: *4* c.os_path_finalize and c.os_path_finalize_join</span></div>
<div class="viewcode-block" id="Commands.os_path_finalize"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.os_path_finalize">[docs]</a>    <span class="k">def</span> <span class="nf">os_path_finalize</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">path</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">keys</span><span class="p">[</span><span class="s">&#39;c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>

        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Commands.os_path_finalize_join"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.os_path_finalize_join">[docs]</a>    <span class="k">def</span> <span class="nf">os_path_finalize_join</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">keys</span><span class="p">[</span><span class="s">&#39;c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>

        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20081006100835.1: *4* c.getNodePath &amp; c.getNodeFileName</span>
    <span class="c"># Not used in Leo&#39;s core.</span>
    <span class="c"># Used by the UNl plugin.  Does not need to create a path.</span></div>
<div class="viewcode-block" id="Commands.getNodePath"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.getNodePath">[docs]</a>    <span class="k">def</span> <span class="nf">getNodePath</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the path in effect at node p.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">aList</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_directives_dict_list</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">scanAtPathDirectives</span><span class="p">(</span><span class="n">aList</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">path</span>

    <span class="c"># Not used in Leo&#39;s core.</span></div>
<div class="viewcode-block" id="Commands.getNodeFileName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.getNodeFileName">[docs]</a>    <span class="k">def</span> <span class="nf">getNodeFileName</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the full file name at node p,</span>
<span class="sd">        including effects of all @path directives.</span>

<span class="sd">        Return None if p is no kind of @file node.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">scanAllAtPathDirectives</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">self_and_parents</span><span class="p">():</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">anyAtFileNodeName</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">name</span><span class="p">:</span> <span class="k">break</span>

        <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">name</span>
    <span class="c">#@+node:ekr.20091211111443.6265: *3* c.doBatchOperations &amp; helpers</span></div>
<div class="viewcode-block" id="Commands.doBatchOperations"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.doBatchOperations">[docs]</a>    <span class="k">def</span> <span class="nf">doBatchOperations</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aList</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c"># Validate aList and create the parents dict</span>
        <span class="k">if</span> <span class="n">aList</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">aList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ok</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkBatchOperationsList</span><span class="p">(</span><span class="n">aList</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;do-batch-operations: invalid list argument&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">aList2</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">,[])</span>
            <span class="k">if</span> <span class="n">aList2</span><span class="p">:</span>
                <span class="n">aList</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">op</span> <span class="ow">in</span> <span class="n">aList2</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s">&#39;insert&#39;</span><span class="p">:</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;insert:&#39;</span><span class="p">,</span><span class="n">v</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;delete:&#39;</span><span class="p">,</span><span class="n">v</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20091211111443.6266: *4* checkBatchOperationsList</span></div>
<div class="viewcode-block" id="Commands.checkBatchOperationsList"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.checkBatchOperationsList">[docs]</a>    <span class="k">def</span> <span class="nf">checkBatchOperationsList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aList</span><span class="p">):</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">;</span> <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">op</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">z</span>
                <span class="n">ok</span><span class="o">=</span> <span class="p">(</span><span class="n">op</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;insert&#39;</span><span class="p">,</span><span class="s">&#39;delete&#39;</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">leoNodes</span><span class="o">.</span><span class="n">position</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="nb">type</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="mi">9</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                    <span class="n">aList2</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">,[])</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">n</span><span class="p">,</span><span class="n">op</span>
                    <span class="n">aList2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">aList2</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span> <span class="k">break</span>
        <span class="k">return</span> <span class="n">ok</span><span class="p">,</span><span class="n">d</span>
    <span class="c">#@+node:ekr.20051106040126: *3* c.executeMinibufferCommand</span></div>
<div class="viewcode-block" id="Commands.executeMinibufferCommand"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.executeMinibufferCommand">[docs]</a>    <span class="k">def</span> <span class="nf">executeMinibufferCommand</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">commandName</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">k</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">k</span>

        <span class="n">func</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">commandsDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">commandName</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">func</span><span class="p">:</span>
            <span class="n">event</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">create_key_event</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
            <span class="n">k</span><span class="o">.</span><span class="n">masterCommand</span><span class="p">(</span><span class="n">commandName</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">,</span><span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">k</span><span class="o">.</span><span class="n">funcReturn</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;no such command: </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">commandName</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">()))</span>
            <span class="k">return</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20091002083910.6106: *3* c.find...</span>
    <span class="c">#@+&lt;&lt; poslist doc &gt;&gt;</span>
    <span class="c">#@+node:bob.20101215134608.5898: *4* &lt;&lt; poslist doc &gt;&gt;</span>
    <span class="c">#@@nocolor-node</span>
    <span class="c">#@+at </span>
    <span class="c"># List of positions </span>
    <span class="c"># </span>
    <span class="c"># Functions find_h() and find_b() both return an instance of poslist.</span>
    <span class="c"># </span>
    <span class="c"># Methods filter_h() and filter_b() refine a poslist.</span>
    <span class="c"># </span>
    <span class="c"># Method children() generates a new poslist by descending one level from</span>
    <span class="c"># all the nodes in a poslist.</span>
    <span class="c"># </span>
    <span class="c"># A chain of poslist method calls must begin with find_h() or find_b().</span>
    <span class="c"># The rest of the chain can be any combination of filter_h(),</span>
    <span class="c"># filter_b(), and children(). For example:</span>
    <span class="c"># </span>
    <span class="c">#     pl = c.find_h(&#39;@file.*py&#39;).children().filter_h(&#39;class.*&#39;).filter_b(&#39;import (.*)&#39;)</span>
    <span class="c"># </span>
    <span class="c"># For each position, pos, in the poslist returned, find_h() and</span>
    <span class="c"># filter_h() set attribute pos.mo to the match object (see Python</span>
    <span class="c"># Regular Expression documentation) for the pattern match.</span>
    <span class="c"># </span>
    <span class="c"># Caution: The pattern given to find_h() or filter_h() must match zero</span>
    <span class="c"># or more characters at the beginning of the headline.</span>
    <span class="c"># </span>
    <span class="c"># For each position, pos, the postlist returned, find_b() and filter_b()</span>
    <span class="c"># set attribute pos.matchiter to an iterator that will return a match</span>
    <span class="c"># object for each of the non-overlapping matches of the pattern in the</span>
    <span class="c"># body of the node.</span>
    <span class="c">#@-&lt;&lt; poslist doc &gt;&gt;</span>
    <span class="c">#@+node:ville.20090311190405.70: *4* c.find_h</span></div>
<div class="viewcode-block" id="Commands.find_h"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.find_h">[docs]</a>    <span class="k">def</span> <span class="nf">find_h</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regex</span><span class="p">,</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return list (a poslist) of all nodes where zero or more characters at</span>
<span class="sd">        the beginning of the headline match regex</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">leoNodes</span><span class="o">.</span><span class="n">poslist</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">all_positions</span><span class="p">():</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">pc</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">pc</span><span class="o">.</span><span class="n">mo</span> <span class="o">=</span> <span class="n">m</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="c">#@+node:ville.20090311200059.1: *4* c.find_b</span></div>
<div class="viewcode-block" id="Commands.find_b"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.find_b">[docs]</a>    <span class="k">def</span> <span class="nf">find_b</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regex</span><span class="p">,</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return list (a poslist) of all nodes whose body matches regex</span>
<span class="sd">        one or more times.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">leoNodes</span><span class="o">.</span><span class="n">poslist</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">all_positions</span><span class="p">():</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
            <span class="n">t1</span><span class="p">,</span><span class="n">t2</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">tee</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
                    <span class="n">t1</span><span class="o">.</span><span class="n">__next__</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">t1</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">pc</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">pc</span><span class="o">.</span><span class="n">matchiter</span> <span class="o">=</span> <span class="n">t2</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pc</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>
    <span class="c">#@+node:ekr.20091001141621.6061: *3* c.generators</span>
    <span class="c">#@+node:ekr.20091001141621.6043: *4* c.all_nodes &amp; all_unique_nodes</span></div>
<div class="viewcode-block" id="Commands.all_nodes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.all_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">all_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">all_positions</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span>
        <span class="k">raise</span> <span class="ne">StopIteration</span>
</div>
<div class="viewcode-block" id="Commands.all_unique_nodes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.all_unique_nodes">[docs]</a>    <span class="k">def</span> <span class="nf">all_unique_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">all_unique_positions</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span>
        <span class="k">raise</span> <span class="ne">StopIteration</span>

    <span class="c"># Compatibility with old code.</span></div>
    <span class="n">all_tnodes_iter</span> <span class="o">=</span> <span class="n">all_nodes</span>
    <span class="n">all_vnodes_iter</span> <span class="o">=</span> <span class="n">all_nodes</span>
    <span class="n">all_unique_tnodes_iter</span> <span class="o">=</span> <span class="n">all_unique_nodes</span>
    <span class="n">all_unique_vnodes_iter</span> <span class="o">=</span> <span class="n">all_unique_nodes</span>
    <span class="c">#@+node:ekr.20091001141621.6062: *4* c.all_unique_positions</span>
<div class="viewcode-block" id="Commands.all_unique_positions"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.all_unique_positions">[docs]</a>    <span class="k">def</span> <span class="nf">all_unique_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span> <span class="c"># Make one copy.</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">p</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">p</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">StopIteration</span>

    <span class="c"># Compatibility with old code.</span></div>
    <span class="n">all_positions_with_unique_tnodes_iter</span> <span class="o">=</span> <span class="n">all_unique_positions</span>
    <span class="n">all_positions_with_unique_vnodes_iter</span> <span class="o">=</span> <span class="n">all_unique_positions</span>
    <span class="c">#@+node:ekr.20091001141621.6044: *4* c.all_positions</span>
<div class="viewcode-block" id="Commands.all_positions"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.all_positions">[docs]</a>    <span class="k">def</span> <span class="nf">all_positions</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span> <span class="c"># Make one copy.</span>
        <span class="k">while</span> <span class="n">p</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">p</span>
            <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">StopIteration</span>

    <span class="c"># Compatibility with old code.</span></div>
    <span class="n">all_positions_iter</span> <span class="o">=</span> <span class="n">all_positions</span>
    <span class="n">allNodes_iter</span> <span class="o">=</span> <span class="n">all_positions</span>
    <span class="c">#@+node:ekr.20090130135126.1: *3* c.Properties</span>
    <span class="k">def</span> <span class="nf">__get_p</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">currentPosition</span><span class="p">()</span>

    <span class="n">p</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span>
        <span class="n">__get_p</span><span class="p">,</span> <span class="c"># No setter.</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="s">&quot;commander current position property&quot;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20110530082209.18250: *3* c.putApropos</span>
<div class="viewcode-block" id="Commands.putApropos"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.putApropos">[docs]</a>    <span class="k">def</span> <span class="nf">putApropos</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">adjustTripleString</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(),</span><span class="n">c</span><span class="o">.</span><span class="n">tab_width</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;&lt;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;&lt;&lt;&#39;</span><span class="p">):</span>
            <span class="k">pass</span> <span class="c"># how to do selective replace??</span>

        <span class="n">pc</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">pluginsController</span>
        <span class="n">vr</span> <span class="o">=</span> <span class="n">pc</span><span class="o">.</span><span class="n">loadOnePlugin</span><span class="p">(</span><span class="s">&#39;viewrendered.py&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">vr</span> <span class="c"># For unit testing.</span>
        <span class="k">if</span> <span class="n">vr</span><span class="p">:</span>
            <span class="n">kw</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39;c&#39;</span><span class="p">:</span><span class="n">c</span><span class="p">,</span>
                <span class="s">&#39;flags&#39;</span><span class="p">:</span><span class="s">&#39;rst&#39;</span><span class="p">,</span>
                <span class="s">&#39;label&#39;</span><span class="p">:</span><span class="s">&#39;&#39;</span><span class="p">,</span>
                <span class="s">&#39;msg&#39;</span><span class="p">:</span><span class="n">s</span><span class="p">,</span>
                <span class="s">&#39;name&#39;</span><span class="p">:</span><span class="s">&#39;Apropos&#39;</span><span class="p">,</span>
                <span class="s">&#39;short_title&#39;</span><span class="p">:</span><span class="s">&#39;&#39;</span><span class="p">,</span>
                <span class="s">&#39;title&#39;</span><span class="p">:</span><span class="s">&#39;&#39;</span><span class="p">}</span>
            <span class="n">vr</span><span class="o">.</span><span class="n">show_scrolled_message</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s">&#39;Apropos&#39;</span><span class="p">,</span><span class="n">kw</span><span class="o">=</span><span class="n">kw</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">bodyWantsFocus</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                <span class="n">vr</span><span class="o">.</span><span class="n">close_rendering_pane</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;c&#39;</span><span class="p">:</span><span class="n">c</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="c">#@+node:bobjack.20080509080123.2: *3* c.universalCallback</span></div>
<div class="viewcode-block" id="Commands.universalCallback"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.universalCallback">[docs]</a>    <span class="k">def</span> <span class="nf">universalCallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Create a universal command callback.</span>

<span class="sd">        Create and return a callback that wraps a function with an rClick</span>
<span class="sd">        signature in a callback which adapts standard minibufer command</span>
<span class="sd">        callbacks to a compatible format.</span>

<span class="sd">        This also serves to allow rClick callback functions to handle</span>
<span class="sd">        minibuffer commands from sources other than rClick menus so allowing</span>
<span class="sd">        a single function to handle calls from all sources.</span>

<span class="sd">        A function wrapped in this wrapper can handle rclick generator</span>
<span class="sd">        and invocation commands and commands typed in the minibuffer.</span>

<span class="sd">        It will also be able to handle commands from the minibuffer even</span>
<span class="sd">        if rclick is not installed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">minibufferCallback</span><span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="n">function</span><span class="o">=</span><span class="n">function</span><span class="p">):</span>

            <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

            <span class="c"># Avoid a pylint complaint.</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s">&#39;theContextMenuController&#39;</span><span class="p">):</span>
                <span class="n">cm</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s">&#39;theContextMenuController&#39;</span><span class="p">)</span>
                <span class="n">keywords</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">mb_keywords</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cm</span> <span class="o">=</span> <span class="n">keywords</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">keywords</span><span class="p">:</span>
                <span class="c"># If rClick is not loaded or no keywords dict was provided</span>
                <span class="c">#  then the command must have been issued in a minibuffer</span>
                <span class="c">#  context.</span>
                <span class="n">keywords</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;c&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span> <span class="s">&#39;rc_phase&#39;</span><span class="p">:</span> <span class="s">&#39;minibuffer&#39;</span><span class="p">}</span>

            <span class="n">keywords</span><span class="p">[</span><span class="s">&#39;mb_event&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span>     

            <span class="n">retval</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">function</span><span class="p">,</span><span class="n">keywords</span><span class="p">)</span>
                <span class="n">retval</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">keywords</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cm</span><span class="p">:</span>
                    <span class="c"># Even if there is an error:</span>
                    <span class="c">#   clear mb_keywords prior to next command and</span>
                    <span class="c">#   ensure mb_retval from last command is wiped</span>
                    <span class="n">cm</span><span class="o">.</span><span class="n">mb_keywords</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="n">cm</span><span class="o">.</span><span class="n">mb_retval</span> <span class="o">=</span> <span class="n">retval</span>

        <span class="n">minibufferCallback</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">function</span><span class="o">.</span><span class="n">__doc__</span>
        <span class="k">return</span> <span class="n">minibufferCallback</span>

    <span class="c">#fix bobjacks spelling error</span></div>
    <span class="n">universallCallback</span> <span class="o">=</span> <span class="n">universalCallback</span>
    <span class="c">#@+node:ekr.20031218072017.2818: *3* Command handlers...</span>
    <span class="c">#@+node:ekr.20031218072017.2819: *4* File Menu</span>
    <span class="c">#@+node:ekr.20031218072017.2820: *5* top level (file menu)</span>
    <span class="c">#@+node:ekr.20031218072017.2833: *6* c.close</span>
<div class="viewcode-block" id="Commands.close"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">new_c</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Close the Leo window, prompting to save it if it has been changed.&#39;&#39;&#39;</span>

        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">closeLeoWindow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span><span class="n">new_c</span><span class="o">=</span><span class="n">new_c</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20110530124245.18245: *6* c.importAnyFile &amp; helper</span></div>
<div class="viewcode-block" id="Commands.importAnyFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.importAnyFile">[docs]</a>    <span class="k">def</span> <span class="nf">importAnyFile</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Import one or more files.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">ic</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">importCommands</span>

        <span class="n">types</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">&quot;All files&quot;</span><span class="p">,</span><span class="s">&quot;*&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;C/C++ files&quot;</span><span class="p">,</span><span class="s">&quot;*.c&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;C/C++ files&quot;</span><span class="p">,</span><span class="s">&quot;*.cpp&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;C/C++ files&quot;</span><span class="p">,</span><span class="s">&quot;*.h&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;C/C++ files&quot;</span><span class="p">,</span><span class="s">&quot;*.hpp&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;Java files&quot;</span><span class="p">,</span><span class="s">&quot;*.java&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;Lua files&quot;</span><span class="p">,</span> <span class="s">&quot;*.lua&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;Pascal files&quot;</span><span class="p">,</span><span class="s">&quot;*.pas&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;Python files&quot;</span><span class="p">,</span><span class="s">&quot;*.py&quot;</span><span class="p">)</span> <span class="p">]</span>

        <span class="n">names</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">runOpenFileDialog</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s">&quot;Import File&quot;</span><span class="p">,</span>
            <span class="n">filetypes</span><span class="o">=</span><span class="n">types</span><span class="p">,</span>
            <span class="n">defaultextension</span><span class="o">=</span><span class="s">&quot;.py&quot;</span><span class="p">,</span>
            <span class="n">multiple</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">bringToFront</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                <span class="c"># a kludge for unit testing.</span>
                <span class="n">c</span><span class="o">.</span><span class="n">init_error_dialogs</span><span class="p">()</span>
                <span class="n">c</span><span class="o">.</span><span class="n">raise_error_dialogs</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;read&#39;</span><span class="p">)</span>
            <span class="k">return</span>



        <span class="c"># New in Leo 4.9: choose the type of import based on the extension.</span>

        <span class="n">c</span><span class="o">.</span><span class="n">init_error_dialogs</span><span class="p">()</span>

        <span class="n">derived</span> <span class="o">=</span> <span class="p">[</span><span class="n">z</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">names</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">looksLikeDerivedFile</span><span class="p">(</span><span class="n">z</span><span class="p">)]</span>
        <span class="n">others</span> <span class="o">=</span> <span class="p">[</span> <span class="n">z</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">names</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">derived</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">derived</span><span class="p">:</span>
            <span class="n">ic</span><span class="o">.</span><span class="n">importDerivedFiles</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">,</span><span class="n">paths</span><span class="o">=</span><span class="n">derived</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">others</span><span class="p">:</span>
            <span class="n">junk</span><span class="p">,</span><span class="n">ext</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_splitext</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ext</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">):</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">ext</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

            <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;cw&#39;</span><span class="p">,</span><span class="s">&#39;cweb&#39;</span><span class="p">):</span>
                <span class="n">ic</span><span class="o">.</span><span class="n">importWebCommand</span><span class="p">([</span><span class="n">fn</span><span class="p">],</span><span class="s">&quot;cweb&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;nw&#39;</span><span class="p">,</span><span class="s">&#39;noweb&#39;</span><span class="p">):</span>
                <span class="n">ic</span><span class="o">.</span><span class="n">importWebCommand</span><span class="p">([</span><span class="n">fn</span><span class="p">],</span><span class="s">&quot;noweb&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s">&#39;txt&#39;</span><span class="p">:</span>
                <span class="n">ic</span><span class="o">.</span><span class="n">importFlattenedOutline</span><span class="p">([</span><span class="n">fn</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ic</span><span class="o">.</span><span class="n">importFilesCommand</span><span class="p">([</span><span class="n">fn</span><span class="p">],</span><span class="s">&quot;@file&quot;</span><span class="p">)</span>

            <span class="c"># No longer supported.</span>
            <span class="c"># c.importCommands.importFilesCommand (names,&quot;@root&quot;)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">raise_error_dialogs</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;read&#39;</span><span class="p">)</span>

    <span class="c"># Compatibility</span></div>
    <span class="n">importAtFile</span> <span class="o">=</span> <span class="n">importAnyFile</span>
    <span class="n">importAtRoot</span> <span class="o">=</span> <span class="n">importAnyFile</span>
    <span class="n">importCWEBFiles</span> <span class="o">=</span> <span class="n">importAnyFile</span>
    <span class="n">importDerivedFile</span> <span class="o">=</span> <span class="n">importAnyFile</span>
    <span class="n">importFlattenedOutline</span> <span class="o">=</span> <span class="n">importAnyFile</span>
    <span class="n">importNowebFiles</span> <span class="o">=</span> <span class="n">importAnyFile</span>
    <span class="c">#@+node:ekr.20110530124245.18248: *7* c.looksLikeDerivedFile</span>
<div class="viewcode-block" id="Commands.looksLikeDerivedFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.looksLikeDerivedFile">[docs]</a>    <span class="k">def</span> <span class="nf">looksLikeDerivedFile</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return True if fn names a file that looks like an</span>
<span class="sd">        external file written by Leo.&#39;&#39;&#39;</span>

        <span class="c"># c = self    </span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;@+leo-ver=&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">return</span> <span class="n">val</span>
    <span class="c">#@+node:ekr.20031218072017.1623: *6* c.new</span></div>
<div class="viewcode-block" id="Commands.new"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.new">[docs]</a>    <span class="k">def</span> <span class="nf">new</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">gui</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Create a new Leo window.&#39;&#39;&#39;</span>

        <span class="n">lm</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadManager</span>

        <span class="c"># Clean out the update queue so it won&#39;t interfere with the new window.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outerUpdate</span><span class="p">()</span>

        <span class="c"># Send all log messages to the new frame.</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">setLog</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">lockLog</span><span class="p">()</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">newCommander</span><span class="p">(</span><span class="n">fileName</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">gui</span><span class="o">=</span><span class="n">gui</span><span class="p">)</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unlockLog</span><span class="p">()</span>

        <span class="n">frame</span><span class="o">.</span><span class="n">setInitialWindowGeometry</span><span class="p">()</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">deiconify</span><span class="p">()</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">lift</span><span class="p">()</span>
        <span class="n">frame</span><span class="o">.</span><span class="n">resizePanesToRatio</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">ratio</span><span class="p">,</span><span class="n">frame</span><span class="o">.</span><span class="n">secondary_ratio</span><span class="p">)</span>
            <span class="c"># Resize the _new_ frame.</span>
        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">createFirstTreeNode</span><span class="p">()</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">createMenu</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">lm</span><span class="o">.</span><span class="n">finishOpen</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">writeWaitingLog</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&quot;new&quot;</span><span class="p">,</span><span class="n">old_c</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">new_c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">setLog</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">c</span> <span class="c"># For unit tests and scripts.</span>
    <span class="c">#@+node:ekr.20031218072017.2821: *6* c.open &amp; helper</span></div>
<div class="viewcode-block" id="Commands.open"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.open">[docs]</a>    <span class="k">def</span> <span class="nf">open</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Open a Leo window containing the contents of a .leo file.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="c">#@+&lt;&lt; Set closeFlag if the only open window is empty &gt;&gt;</span>
        <span class="c">#@+node:ekr.20031218072017.2822: *7* &lt;&lt; Set closeFlag if the only open window is empty &gt;&gt;</span>
        <span class="c">#@+at</span>
        <span class="c"># If this is the only open window was opened when the app started, and</span>
        <span class="c"># the window has never been written to or saved, then we will</span>
        <span class="c"># automatically close that window if this open command completes</span>
        <span class="c"># successfully.</span>
        <span class="c">#@@c</span>

        <span class="n">closeFlag</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">startupWindow</span> <span class="ow">and</span> <span class="c"># The window was open on startup</span>
            <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">changed</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">saved</span> <span class="ow">and</span> <span class="c"># The window has never been changed</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">numberOfUntitledWindows</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="c"># Only one untitled window has ever been opened</span>
        <span class="c">#@-&lt;&lt; Set closeFlag if the only open window is empty &gt;&gt;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="p">[</span>
            <span class="c"># 2010/10/09: Fix an interface blunder. Show all files by default.</span>
            <span class="p">(</span><span class="s">&quot;All files&quot;</span><span class="p">,</span><span class="s">&quot;*&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;Leo files&quot;</span><span class="p">,</span><span class="s">&quot;*.leo&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;Python files&quot;</span><span class="p">,</span><span class="s">&quot;*.py&quot;</span><span class="p">),]</span>

        <span class="n">fileName</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">givenArgs</span><span class="p">)</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">runOpenFileDialog</span><span class="p">(</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s">&quot;Open&quot;</span><span class="p">,</span><span class="n">filetypes</span> <span class="o">=</span> <span class="n">table</span><span class="p">,</span><span class="n">defaultextension</span> <span class="o">=</span> <span class="s">&quot;.leo&quot;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">bringToFront</span><span class="p">()</span>

        <span class="n">c</span><span class="o">.</span><span class="n">init_error_dialogs</span><span class="p">()</span>

        <span class="n">ok</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">fileName</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fileName</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.leo&#39;</span><span class="p">):</span>
                <span class="n">c2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">openWithFileName</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">old_c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">c2</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">setGlobalOpenDir</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">c2</span> <span class="ow">and</span> <span class="n">closeFlag</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">destroyWindow</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">c</span><span class="o">.</span><span class="n">looksLikeDerivedFile</span><span class="p">(</span><span class="n">fileName</span><span class="p">):</span>
                <span class="c"># 2011/10/09: A smart open makes Leo lighter:</span>
                <span class="c"># Create an @file node for files containing Leo sentinels.</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">importCommands</span><span class="o">.</span><span class="n">importDerivedFiles</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">,</span>
                    <span class="n">paths</span><span class="o">=</span><span class="p">[</span><span class="n">fileName</span><span class="p">],</span><span class="n">command</span><span class="o">=</span><span class="s">&#39;Open&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># otherwise, create an @edit node.</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">createNodeFromExternalFile</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">raise_error_dialogs</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;write&#39;</span><span class="p">)</span>

        <span class="c"># openWithFileName sets focus if ok.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">initialFocusHelper</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20090212054250.9: *7* c.createNodeFromExternalFile</span></div>
<div class="viewcode-block" id="Commands.createNodeFromExternalFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.createNodeFromExternalFile">[docs]</a>    <span class="k">def</span> <span class="nf">createNodeFromExternalFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Read the file into a node.</span>
<span class="sd">        Return None, indicating that c.open should set focus.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">s</span><span class="p">,</span><span class="n">e</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">readFileIntoString</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">head</span><span class="p">,</span><span class="n">ext</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_splitext</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ext</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">):</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">ext</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">language</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">extension_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">language</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s">&#39;@color</span><span class="se">\n</span><span class="s">@language </span><span class="si">%s</span><span class="se">\n\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">language</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="s">&#39;@killcolor</span><span class="se">\n\n</span><span class="s">&#39;</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">insertHeadline</span><span class="p">(</span><span class="n">op_name</span><span class="o">=</span><span class="s">&#39;Open File&#39;</span><span class="p">,</span> <span class="n">as_child</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">p2</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="s">&#39;@edit </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">fn</span> <span class="c"># g.shortFileName(fn)</span>
        <span class="n">p2</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">s</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">bodyCtrl</span>
        <span class="k">if</span> <span class="n">w</span><span class="p">:</span> <span class="n">w</span><span class="o">.</span><span class="n">setInsertPoint</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">recolor</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.2823: *6* c.openWith and helpers</span></div>
<div class="viewcode-block" id="Commands.openWith"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.openWith">[docs]</a>    <span class="k">def</span> <span class="nf">openWith</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">d</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;This routine handles the items in the Open With... menu.</span>

<span class="sd">        The &quot;d&quot; arg is a Python dictionary whose keys and values</span>
<span class="sd">        are set from the body text of @openwith nodes.</span>

<span class="sd">        d.get(&#39;ext&#39;):   The temp file&#39;s extension.</span>
<span class="sd">        d.get(&#39;kind&#39;):  The method used to open the file.</span>
<span class="sd">        One of: (&#39;os.startfile&#39;,&#39;exec&#39;,&#39;os.spawnl&#39;:&#39;os.spawnv&#39;.&#39;subprocess.Popen&#39;)</span>
<span class="sd">        d.get(&#39;args&#39;):  A list of arguments specified by the arg tag.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ext&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&#39;openwith1&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="n">d</span><span class="o">=</span><span class="n">d</span><span class="p">):</span>
                <span class="n">ext</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">getOpenWithExt</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">ext</span><span class="p">)</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">openWithHelper</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">ext</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fn</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">enableIdleTimeHook</span><span class="p">(</span><span class="n">idleTimeDelay</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">openTempFileInExternalEditor</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&#39;openwith2&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="n">d</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;unexpected exception in c.openWith&#39;</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.2824: *7* c.getOpenWithExt</span></div>
<div class="viewcode-block" id="Commands.getOpenWithExt"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.getOpenWithExt">[docs]</a>    <span class="k">def</span> <span class="nf">getOpenWithExt</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">ext</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">ext</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;&#39;&quot;</span><span class="p">,</span><span class="s">&#39;&quot;&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">ext</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">ch</span><span class="p">):</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">ext</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ext</span><span class="p">:</span>
            <span class="c"># if node is part of @&lt;file&gt; tree, get ext from file name</span>
            <span class="k">for</span> <span class="n">p2</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">self_and_parents</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">p2</span><span class="o">.</span><span class="n">isAnyAtFileNode</span><span class="p">():</span>
                    <span class="n">fn</span> <span class="o">=</span> <span class="n">p2</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">ext</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_splitext</span><span class="p">(</span><span class="n">fn</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;found node:&#39;</span><span class="p">,</span><span class="n">ext</span><span class="p">,</span><span class="n">p2</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
                    <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ext</span><span class="p">:</span>
            <span class="n">theDict</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">scanAllDirectives</span><span class="p">()</span>
            <span class="n">language</span> <span class="o">=</span> <span class="n">theDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;language&#39;</span><span class="p">)</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">language_extension_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">language</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;found directive&#39;</span><span class="p">,</span><span class="n">language</span><span class="p">,</span><span class="n">ext</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ext</span><span class="p">:</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="s">&#39;.txt&#39;</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;use default (.txt)&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ext</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;.&#39;</span><span class="p">:</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span><span class="o">+</span><span class="n">ext</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ext</span>
    <span class="c">#@+node:ekr.20031218072017.2829: *7* c.openTempFileInExternalEditor</span></div>
<div class="viewcode-block" id="Commands.openTempFileInExternalEditor"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.openTempFileInExternalEditor">[docs]</a>    <span class="k">def</span> <span class="nf">openTempFileInExternalEditor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span><span class="n">testing</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Open the closed mkstemp file fn in an external editor.</span>
<span class="sd">        The arg and openType args come from the data arg to c.openWith.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">True</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">testing</span> <span class="o">=</span> <span class="n">testing</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

        <span class="k">def</span> <span class="nf">join</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
            <span class="k">print</span><span class="p">()</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%15s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)))</span>

        <span class="n">arg_tuple</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;args&#39;</span><span class="p">,[])</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arg_tuple</span><span class="p">)</span>
        <span class="n">openType</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;kind&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">=</span> <span class="s">&#39;&lt;no command&gt;&#39;</span>
            <span class="k">if</span> <span class="n">openType</span> <span class="o">==</span> <span class="s">&#39;os.startfile&#39;</span><span class="p">:</span>
                <span class="n">command</span> <span class="o">=</span> <span class="s">&#39;os.startfile(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">join</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">testing</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">startfile</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="n">fn</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">openType</span> <span class="o">==</span> <span class="s">&#39;exec&#39;</span><span class="p">:</span>
                <span class="n">command</span> <span class="o">=</span> <span class="s">&#39;exec(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">join</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">testing</span><span class="p">:</span> <span class="k">exec</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="n">fn</span><span class="p">),{},{})</span>
            <span class="k">elif</span> <span class="n">openType</span> <span class="o">==</span> <span class="s">&#39;os.spawnl&#39;</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_basename</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                <span class="n">command</span> <span class="o">=</span> <span class="s">&#39;os.spawnl(</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">testing</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">spawnl</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">P_NOWAIT</span><span class="p">,</span><span class="n">arg</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">openType</span> <span class="o">==</span> <span class="s">&#39;os.spawnv&#39;</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">arg_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> 
                <span class="n">vtuple</span> <span class="o">=</span> <span class="n">arg_tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">vtuple</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                    <span class="c"># add the name of the program as the first argument.</span>
                    <span class="c"># Change suggested by Jim Sizelove.</span>
                <span class="n">vtuple</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
                <span class="n">command</span> <span class="o">=</span> <span class="s">&#39;os.spawnv(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">vtuple</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">testing</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">spawnv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">P_NOWAIT</span><span class="p">,</span><span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">vtuple</span><span class="p">)</span> <span class="c">#???</span>
            <span class="k">elif</span> <span class="n">openType</span> <span class="o">==</span> <span class="s">&#39;subprocess.Popen&#39;</span><span class="p">:</span>
                <span class="n">use_shell</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">c_arg</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
                <span class="n">command</span> <span class="o">=</span> <span class="s">&#39;subprocess.Popen(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">c_arg</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">testing</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">c_arg</span><span class="p">,</span><span class="n">shell</span><span class="o">=</span><span class="n">use_shell</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;c_arg&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">c_arg</span><span class="p">))</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">isCallable</span><span class="p">(</span><span class="n">openType</span><span class="p">):</span>
                <span class="c"># Invoke openWith like this:</span>
                <span class="c"># c.openWith(data=[f,None,None])</span>
                <span class="c"># f will be called with one arg, the filename</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">openType</span><span class="p">,</span><span class="n">fn</span><span class="p">))</span>
                <span class="n">command</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">openType</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">testing</span><span class="p">:</span> <span class="n">openType</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">command</span><span class="o">=</span><span class="s">&#39;bad command:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">openType</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">testing</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">command</span> <span class="c"># for unit testing.</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;exception executing open-with command:&#39;</span><span class="p">,</span><span class="n">command</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
            <span class="k">return</span> <span class="s">&#39;oops: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">command</span>
    <span class="c">#@+node:ekr.20031218072017.2832: *7* c.openWithTempFilePath (may be over-ridden)</span></div>
<div class="viewcode-block" id="Commands.openWithTempFilePath"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.openWithTempFilePath">[docs]</a>    <span class="k">def</span> <span class="nf">openWithTempFilePath</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">ext</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the path to the temp file corresponding to p and ext.</span>

<span class="sd">        This is overridden in mod_tempfname plugin</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">fn</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">_LeoTemp_</span><span class="si">%s%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">g</span><span class="o">.</span><span class="n">sanitize_filename</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">)),</span><span class="n">ext</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span> <span class="c"># 2010/02/07</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicode</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">td</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">())</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_join</span><span class="p">(</span><span class="n">td</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">path</span>
    <span class="c">#@+node:ekr.20100203050306.5797: *7* c.openWithHelper</span></div>
<div class="viewcode-block" id="Commands.openWithHelper"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.openWithHelper">[docs]</a>    <span class="k">def</span> <span class="nf">openWithHelper</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">ext</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;create or reopen a temp file for p,</span>
<span class="sd">        testing for conflicting changes.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># May be over-ridden by mod_tempfname plugin.</span>
        <span class="n">searchPath</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">openWithTempFilePath</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">ext</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">searchPath</span><span class="p">:</span>
            <span class="c"># Check the mod_tempfname plugin.</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;c.openWithTempFilePath failed&#39;</span><span class="p">)</span>

        <span class="c"># Set d and path if a temp file already refers to p.v</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">searchPath</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">openWithFiles</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="o">==</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;v&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">searchPath</span> <span class="o">==</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;path&#39;</span><span class="p">):</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">searchPath</span> <span class="p">;</span> <span class="k">break</span>

        <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;path&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">searchPath</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">createOrRecreateTempFileAsNeeded</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">ext</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">createOpenWithTempFile</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">ext</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fn</span> <span class="c"># fn may be None.</span>
    <span class="c">#@+node:ekr.20031218072017.2827: *8* c.createOrRecreateTempFileAsNeeded</span></div>
    <span class="n">conflict_message</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">    Conflicting changes in outline and temp file.</span>
<span class="s">    Do you want to use the data in the outline?</span>
<span class="s">    Yes: use the data in the outline.</span>
<span class="s">    No: use the data in the temp file.</span>
<span class="s">    Cancel or Escape or Return: do nothing.</span>
<span class="s">    &#39;&#39;&#39;</span>

<div class="viewcode-block" id="Commands.createOrRecreateTempFileAsNeeded"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.createOrRecreateTempFileAsNeeded">[docs]</a>    <span class="k">def</span> <span class="nf">createOrRecreateTempFileAsNeeded</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">ext</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;test for changes in both p and the temp file:</span>

<span class="sd">        - If only p&#39;s body text has changed, we recreate the temp file.</span>
<span class="sd">        - If only the temp file has changed, do nothing here.</span>
<span class="sd">        - If both have changed we must prompt the user to see which code to use.</span>

<span class="sd">        Return the file name.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">fn</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;path&#39;</span><span class="p">)</span>
        <span class="c"># Get the old &amp; new body text and modification times.</span>
        <span class="n">encoding</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;encoding&#39;</span><span class="p">)</span>
        <span class="n">old_body</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;body&#39;</span><span class="p">)</span>
        <span class="n">new_body</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="p">,</span><span class="n">encoding</span><span class="p">,</span><span class="n">reportErrors</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">old_time</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;time&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_time</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_getmtime</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">new_time</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">body_changed</span> <span class="o">=</span> <span class="n">old_body</span> <span class="o">!=</span> <span class="n">new_body</span>
        <span class="n">time_changed</span> <span class="o">=</span> <span class="n">old_time</span> <span class="o">!=</span> <span class="n">new_time</span>

        <span class="k">if</span> <span class="n">body_changed</span> <span class="ow">and</span> <span class="n">time_changed</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Conflict in temp file for&#39;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">runAskYesNoCancelDialog</span><span class="p">(</span><span class="n">c</span><span class="p">,</span>
                <span class="s">&#39;Conflict!&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">conflict_message</span><span class="p">,</span>
                <span class="n">yesMessage</span> <span class="o">=</span> <span class="s">&#39;Outline&#39;</span><span class="p">,</span>
                <span class="n">noMessage</span> <span class="o">=</span> <span class="s">&#39;File&#39;</span><span class="p">,</span>
                <span class="n">defaultButton</span> <span class="o">=</span> <span class="s">&#39;Cancel&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">result</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;cancel&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="n">rewrite</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;yes&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rewrite</span> <span class="o">=</span> <span class="n">body_changed</span>

        <span class="k">if</span> <span class="n">rewrite</span><span class="p">:</span>
            <span class="c"># May be overridden by the mod_tempfname plugin.</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">createOpenWithTempFile</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">ext</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&#39;reopening:&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">fn</span>
    <span class="c">#@+node:ekr.20100203050306.5937: *8* c.createOpenWithTempFile</span></div>
<div class="viewcode-block" id="Commands.createOpenWithTempFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.createOpenWithTempFile">[docs]</a>    <span class="k">def</span> <span class="nf">createOpenWithTempFile</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">ext</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># May be over-ridden by mod_tempfname plugin.</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">openWithTempFilePath</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">ext</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">red</span><span class="p">(</span><span class="s">&#39;recreating:  &#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&#39;creating:  &#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="c"># Convert s to whatever encoding is in effect.</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">scanAllDirectives</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">encoding</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;encoding&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">encoding</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">encoding</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">default_derived_file_encoding</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span> <span class="c"># 2010/02/09</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="p">,</span><span class="n">encoding</span><span class="p">,</span><span class="n">reportErrors</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> 
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">t1</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_getmtime</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">t1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;time: &#39;</span><span class="p">,</span><span class="n">t1</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">t1</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="c"># Remove previous entry from app.openWithFiles if it exists.</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">openWithFiles</span><span class="p">[:]:</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="o">==</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;v&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;removing&#39;</span><span class="p">,</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;path&#39;</span><span class="p">))</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">openWithFiles</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

            <span class="n">d</span> <span class="o">=</span> <span class="p">{</span>
                <span class="c"># Used by app.destroyOpenWithFilesForFrame.</span>
                <span class="s">&#39;c&#39;</span><span class="p">:</span><span class="n">c</span><span class="p">,</span>
                <span class="c"># Used here and by app.destroyOpenWithFileWithDict.</span>
                <span class="s">&#39;path&#39;</span><span class="p">:</span><span class="n">fn</span><span class="p">,</span>
                <span class="c"># Used by c.testForConflicts.</span>
                <span class="s">&#39;body&#39;</span><span class="p">:</span><span class="n">s</span><span class="p">,</span>
                <span class="s">&#39;encoding&#39;</span><span class="p">:</span><span class="n">encoding</span><span class="p">,</span>
                <span class="s">&#39;time&#39;</span><span class="p">:</span><span class="n">t1</span><span class="p">,</span>
                <span class="c"># Used by the open_with plugin.</span>
                <span class="s">&#39;p&#39;</span><span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                <span class="c"># Used by c.openWithHelper, and below.</span>
                <span class="s">&#39;v&#39;</span><span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">openWithFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">fn</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;exception creating temp file&#39;</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20031218072017.2834: *6* c.save</span></div>
<div class="viewcode-block" id="Commands.save"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Save a Leo outline to a file.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="c"># Do this now: w may go away.</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">get_focus</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">inBody</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">widget_name</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;body&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inBody</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">saveCursorAndScroll</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTestDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;init_error_dialogs&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># A kludge for unit testing:</span>
            <span class="c"># indicated that c.init_error_dialogs and c.raise_error_dialogs</span>
            <span class="c"># will be called below, *without* actually saving the .leo file.</span>
            <span class="n">c</span><span class="o">.</span><span class="n">init_error_dialogs</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">raise_error_dialogs</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;write&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">disableSave</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;save commands disabled&quot;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;purple&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">c</span><span class="o">.</span><span class="n">init_error_dialogs</span><span class="p">()</span>

        <span class="c"># Make sure we never pass None to the ctor.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
            <span class="n">c</span><span class="o">.</span><span class="n">mFileName</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">:</span>
            <span class="c"># Calls c.setChanged(False) if no error.</span>
            <span class="n">c</span><span class="o">.</span><span class="n">fileCommands</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">root</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">root</span><span class="o">.</span><span class="n">next</span><span class="p">()</span> <span class="ow">and</span> <span class="n">root</span><span class="o">.</span><span class="n">isAtEditNode</span><span class="p">():</span>
                <span class="c"># There is only a single @edit node in the outline.</span>
                <span class="c"># A hack to allow &quot;quick edit&quot; of non-Leo files.</span>
                <span class="c"># See https://bugs.launchpad.net/leo-editor/+bug/381527</span>
                <span class="n">fileName</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="c"># Write the @edit node if needed.</span>
                <span class="k">if</span> <span class="n">root</span><span class="o">.</span><span class="n">isDirty</span><span class="p">():</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">atFileCommands</span><span class="o">.</span><span class="n">writeOneAtEditNode</span><span class="p">(</span><span class="n">root</span><span class="p">,</span>
                        <span class="n">toString</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fileName</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">givenArgs</span><span class="p">)</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">runSaveFileDialog</span><span class="p">(</span>
                    <span class="n">initialfile</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">,</span>
                    <span class="n">title</span><span class="o">=</span><span class="s">&quot;Save&quot;</span><span class="p">,</span>
                    <span class="n">filetypes</span><span class="o">=</span><span class="p">[(</span><span class="s">&quot;Leo files&quot;</span><span class="p">,</span> <span class="s">&quot;*.leo&quot;</span><span class="p">)],</span>
                    <span class="n">defaultextension</span><span class="o">=</span><span class="s">&quot;.leo&quot;</span><span class="p">)</span>

            <span class="n">c</span><span class="o">.</span><span class="n">bringToFront</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">fileName</span><span class="p">:</span>
                <span class="c"># Don&#39;t change mFileName until the dialog has suceeded.</span>
                <span class="n">c</span><span class="o">.</span><span class="n">mFileName</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">ensure_extension</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="s">&quot;.leo&quot;</span><span class="p">)</span>
                <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">mFileName</span>
                <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">computeWindowTitle</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">))</span>
                <span class="n">c</span><span class="o">.</span><span class="n">openDirectory</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">openDirectory</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_dirname</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">)</span>
                    <span class="c"># Bug fix in 4.4b2.</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">qt_use_tabs</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span><span class="s">&#39;top&#39;</span><span class="p">):</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">leo_master</span><span class="o">.</span><span class="n">setTabName</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">)</span>
                <span class="n">c</span><span class="o">.</span><span class="n">fileCommands</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">recentFilesManager</span><span class="o">.</span><span class="n">updateRecentFiles</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">)</span>

        <span class="c"># Done in fileCommands.save.</span>
        <span class="c"># c.redraw_after_icons_changed()</span>

        <span class="n">c</span><span class="o">.</span><span class="n">raise_error_dialogs</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;write&#39;</span><span class="p">)</span>

        <span class="c"># *Safely* restore focus, without using the old w directly.</span>
        <span class="k">if</span> <span class="n">inBody</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">bodyWantsFocus</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">restoreCursorAndScroll</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">treeWantsFocus</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20110228162720.13980: *6* c.saveAll</span></div>
<div class="viewcode-block" id="Commands.saveAll"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.saveAll">[docs]</a>    <span class="k">def</span> <span class="nf">saveAll</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Save all open tabs windows/tabs.&#39;&#39;&#39;</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">windowList</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">c</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">isChanged</span><span class="p">():</span>
                <span class="n">c</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="c"># Restore the present tab.</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">dw</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">top</span> <span class="c"># A DynamicWindow</span>
        <span class="n">dw</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2835: *6* c.saveAs</span></div>
<div class="viewcode-block" id="Commands.saveAs"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.saveAs">[docs]</a>    <span class="k">def</span> <span class="nf">saveAs</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Save a Leo outline to a file with a new filename.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="c"># Do this now: w may go away.</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">get_focus</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">inBody</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">widget_name</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;body&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inBody</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">saveCursorAndScroll</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">disableSave</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;save commands disabled&quot;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;purple&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">c</span><span class="o">.</span><span class="n">init_error_dialogs</span><span class="p">()</span>

        <span class="c"># Make sure we never pass None to the ctor.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

        <span class="n">fileName</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">givenArgs</span><span class="p">)</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">runSaveFileDialog</span><span class="p">(</span>
            <span class="n">initialfile</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s">&quot;Save As&quot;</span><span class="p">,</span>
            <span class="n">filetypes</span><span class="o">=</span><span class="p">[(</span><span class="s">&quot;Leo files&quot;</span><span class="p">,</span> <span class="s">&quot;*.leo&quot;</span><span class="p">)],</span>
            <span class="n">defaultextension</span><span class="o">=</span><span class="s">&quot;.leo&quot;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">bringToFront</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">fileName</span><span class="p">:</span>
            <span class="c"># Fix bug 998090: save file as doesn&#39;t remove entry from open file list.</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">forgetOpenFile</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">)</span>
            <span class="c"># Don&#39;t change mFileName until the dialog has suceeded.</span>
            <span class="n">c</span><span class="o">.</span><span class="n">mFileName</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">ensure_extension</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="s">&quot;.leo&quot;</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">mFileName</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">computeWindowTitle</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">))</span>
            <span class="n">c</span><span class="o">.</span><span class="n">openDirectory</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">openDirectory</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_dirname</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">)</span>
                <span class="c"># Bug fix in 4.4b2.</span>
            <span class="c"># Calls c.setChanged(False) if no error.</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">qt_use_tabs</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span><span class="s">&#39;top&#39;</span><span class="p">):</span>
                <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">leo_master</span><span class="o">.</span><span class="n">setTabName</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">fileCommands</span><span class="o">.</span><span class="n">saveAs</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">recentFilesManager</span><span class="o">.</span><span class="n">updateRecentFiles</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">)</span>

        <span class="c"># Done in fileCommands.saveAs.</span>
        <span class="c"># c.redraw_after_icons_changed()</span>

        <span class="n">c</span><span class="o">.</span><span class="n">raise_error_dialogs</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;write&#39;</span><span class="p">)</span>

        <span class="c"># *Safely* restore focus, without using the old w directly.</span>
        <span class="k">if</span> <span class="n">inBody</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">bodyWantsFocus</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">restoreCursorAndScroll</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">treeWantsFocus</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.2836: *6* c.saveTo</span></div>
<div class="viewcode-block" id="Commands.saveTo"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.saveTo">[docs]</a>    <span class="k">def</span> <span class="nf">saveTo</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Save a Leo outline to a file, leaving the file associated with the Leo outline unchanged.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="c"># Do this now: w may go away.</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">get_focus</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">inBody</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">widget_name</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;body&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inBody</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">saveCursorAndScroll</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">disableSave</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;save commands disabled&quot;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;purple&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">c</span><span class="o">.</span><span class="n">init_error_dialogs</span><span class="p">()</span>

        <span class="c"># Make sure we never pass None to the ctor.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

        <span class="c"># set local fileName, _not_ c.mFileName</span>
        <span class="n">fileName</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">givenArgs</span><span class="p">)</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">runSaveFileDialog</span><span class="p">(</span>
            <span class="n">initialfile</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s">&quot;Save To&quot;</span><span class="p">,</span>
            <span class="n">filetypes</span><span class="o">=</span><span class="p">[(</span><span class="s">&quot;Leo files&quot;</span><span class="p">,</span> <span class="s">&quot;*.leo&quot;</span><span class="p">)],</span>
            <span class="n">defaultextension</span><span class="o">=</span><span class="s">&quot;.leo&quot;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">bringToFront</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">fileName</span><span class="p">:</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">ensure_extension</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="s">&quot;.leo&quot;</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">fileCommands</span><span class="o">.</span><span class="n">saveTo</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">recentFilesManager</span><span class="o">.</span><span class="n">updateRecentFiles</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>

        <span class="c"># Does not change icons status.</span>
        <span class="c"># c.redraw_after_icons_changed()</span>

        <span class="n">c</span><span class="o">.</span><span class="n">raise_error_dialogs</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;write&#39;</span><span class="p">)</span>

        <span class="c"># *Safely* restore focus, without using the old w directly.</span>
        <span class="k">if</span> <span class="n">inBody</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">bodyWantsFocus</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">restoreCursorAndScroll</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">treeWantsFocus</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.2837: *6* c.revert</span></div>
<div class="viewcode-block" id="Commands.revert"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.revert">[docs]</a>    <span class="k">def</span> <span class="nf">revert</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Revert the contents of a Leo outline to last saved contents.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># Make sure the user wants to Revert.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">reply</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">runAskYesNoDialog</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&quot;Revert&quot;</span><span class="p">,</span>
            <span class="s">&quot;Revert to previous version of &quot;</span> <span class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">mFileName</span> <span class="o">+</span> <span class="s">&quot;?&quot;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">bringToFront</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">reply</span><span class="o">==</span><span class="s">&quot;no&quot;</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c"># Rename this frame so the open logic won&#39;t think it is open.</span>
        <span class="n">fileName</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">mFileName</span> <span class="p">;</span> <span class="n">c</span><span class="o">.</span><span class="n">mFileName</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

        <span class="c"># Create a new frame before deleting this frame.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">reverting</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">openWithFileName</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">old_c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">reverting</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">c2</span><span class="p">:</span>
            <span class="n">c2</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">deiconify</span><span class="p">()</span>
            <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&quot;close-frame&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">destroyWindow</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">mFileName</span> <span class="o">=</span> <span class="n">fileName</span>
    <span class="c">#@+node:ekr.20070413045221: *6* c.saveAsUnzipped &amp; saveAsZipped</span></div>
<div class="viewcode-block" id="Commands.saveAsUnzipped"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.saveAsUnzipped">[docs]</a>    <span class="k">def</span> <span class="nf">saveAsUnzipped</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Save a Leo outline to a file with a new filename,</span>
<span class="sd">        ensuring that the file is not compressed.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saveAsZippedHelper</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Commands.saveAsZipped"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.saveAsZipped">[docs]</a>    <span class="k">def</span> <span class="nf">saveAsZipped</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Save a Leo outline to a file with a new filename,</span>
<span class="sd">        ensuring that the file is compressed.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saveAsZippedHelper</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Commands.saveAsZippedHelper"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.saveAsZippedHelper">[docs]</a>    <span class="k">def</span> <span class="nf">saveAsZippedHelper</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">isZipped</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">oldZipped</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">isZipped</span>
        <span class="n">c</span><span class="o">.</span><span class="n">isZipped</span> <span class="o">=</span> <span class="n">isZipped</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">saveAs</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">isZipped</span> <span class="o">=</span> <span class="n">oldZipped</span>
    <span class="c">#@+node:ekr.20031218072017.2079: *5* Recent Files submenu &amp; allies</span>
    <span class="c">#@+node:ekr.20031218072017.2080: *6* c.clearRecentFiles</span></div>
<div class="viewcode-block" id="Commands.clearRecentFiles"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.clearRecentFiles">[docs]</a>    <span class="k">def</span> <span class="nf">clearRecentFiles</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Clear the recent files list, then add the present file.&quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">recentFilesManager</span><span class="o">.</span><span class="n">clearRecentFiles</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2081: *6* c.openRecentFile</span></div>
<div class="viewcode-block" id="Commands.openRecentFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.openRecentFile">[docs]</a>    <span class="k">def</span> <span class="nf">openRecentFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># Automatically close the previous window if...</span>
        <span class="n">closeFlag</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">startupWindow</span> <span class="ow">and</span>
                <span class="c"># The window was open on startup</span>
            <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">changed</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">saved</span> <span class="ow">and</span>
                <span class="c"># The window has never been changed</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">numberOfUntitledWindows</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                <span class="c"># Only one untitled window has ever been opened.</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&quot;recentfiles1&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">,</span><span class="n">fileName</span><span class="o">=</span><span class="n">fn</span><span class="p">,</span><span class="n">closeFlag</span><span class="o">=</span><span class="n">closeFlag</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="n">c2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">openWithFileName</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">old_c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">closeFlag</span> <span class="ow">and</span> <span class="n">c2</span> <span class="ow">and</span> <span class="n">c2</span> <span class="o">!=</span> <span class="n">c</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">destroyWindow</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="p">)</span>
            <span class="n">c2</span><span class="o">.</span><span class="n">setLog</span><span class="p">()</span>
            <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&quot;recentfiles2&quot;</span><span class="p">,</span>
                <span class="n">c</span><span class="o">=</span><span class="n">c2</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">c2</span><span class="o">.</span><span class="n">p</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">c2</span><span class="o">.</span><span class="n">p</span><span class="p">,</span><span class="n">fileName</span><span class="o">=</span><span class="n">fn</span><span class="p">,</span><span class="n">closeFlag</span><span class="o">=</span><span class="n">closeFlag</span><span class="p">)</span>
    <span class="c">#@+node:tbrown.20080509212202.6: *6* c.cleanRecentFiles</span></div>
<div class="viewcode-block" id="Commands.cleanRecentFiles"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.cleanRecentFiles">[docs]</a>    <span class="k">def</span> <span class="nf">cleanRecentFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Remove items from the recent files list that are no longer valid.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">recentFilesManager</span><span class="o">.</span><span class="n">cleanRecentFiles</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="c">#@+node:tbrown.20080509212202.8: *6* c.sortRecentFiles</span></div>
<div class="viewcode-block" id="Commands.sortRecentFiles"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.sortRecentFiles">[docs]</a>    <span class="k">def</span> <span class="nf">sortRecentFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Sort the recent files list.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">recentFilesManager</span><span class="o">.</span><span class="n">sortRecentFiles</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2838: *5* c.Read/Write submenu</span>
    <span class="c">#@+node:ekr.20070806105721.1: *6* c.readAtAutoNodes</span></div>
<div class="viewcode-block" id="Commands.readAtAutoNodes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.readAtAutoNodes">[docs]</a>    <span class="k">def</span> <span class="nf">readAtAutoNodes</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Read all @auto nodes in the presently selected outline.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">u</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">undoer</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">init_error_dialogs</span><span class="p">()</span>
        <span class="n">undoData</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">beforeChangeTree</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">importCommands</span><span class="o">.</span><span class="n">readAtAutoNodes</span><span class="p">()</span>
        <span class="n">u</span><span class="o">.</span><span class="n">afterChangeTree</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s">&#39;Read @auto Nodes&#39;</span><span class="p">,</span><span class="n">undoData</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">raise_error_dialogs</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;read&#39;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.1839: *6* c.readAtFileNodes</span></div>
<div class="viewcode-block" id="Commands.readAtFileNodes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.readAtFileNodes">[docs]</a>    <span class="k">def</span> <span class="nf">readAtFileNodes</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Read all @file nodes in the presently selected outline.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">u</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">undoer</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span>
        <span class="c"># c.init_error_dialogs() # Done in at.readAll.</span>
        <span class="n">undoData</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">beforeChangeTree</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">fileCommands</span><span class="o">.</span><span class="n">readAtFileNodes</span><span class="p">()</span>
        <span class="n">u</span><span class="o">.</span><span class="n">afterChangeTree</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s">&#39;Read @file Nodes&#39;</span><span class="p">,</span><span class="n">undoData</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>
        <span class="c"># c.raise_error_dialogs(kind=&#39;read&#39;) # Done in at.readAll.</span>
    <span class="c">#@+node:ekr.20080801071227.4: *6* c.readAtShadowNodes</span></div>
<div class="viewcode-block" id="Commands.readAtShadowNodes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.readAtShadowNodes">[docs]</a>    <span class="k">def</span> <span class="nf">readAtShadowNodes</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Read all @shadow nodes in the presently selected outline.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">u</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">undoer</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">init_error_dialogs</span><span class="p">()</span>
        <span class="n">undoData</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">beforeChangeTree</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">atFileCommands</span><span class="o">.</span><span class="n">readAtShadowNodes</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">u</span><span class="o">.</span><span class="n">afterChangeTree</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s">&#39;Read @shadow Nodes&#39;</span><span class="p">,</span><span class="n">undoData</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">raise_error_dialogs</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;read&#39;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20070915134101: *6* c.readFileIntoNode</span></div>
<div class="viewcode-block" id="Commands.readFileIntoNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.readFileIntoNode">[docs]</a>    <span class="k">def</span> <span class="nf">readFileIntoNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Read a file into a single node.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">undoType</span> <span class="o">=</span> <span class="s">&#39;Read File Into Node&#39;</span>
        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span>

        <span class="n">filetypes</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&quot;All files&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">),(</span><span class="s">&quot;Python files&quot;</span><span class="p">,</span><span class="s">&quot;*.py&quot;</span><span class="p">),(</span><span class="s">&quot;Leo files&quot;</span><span class="p">,</span> <span class="s">&quot;*.leo&quot;</span><span class="p">),]</span>
        <span class="n">fileName</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">runOpenFileDialog</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s">&quot;Read File Into Node&quot;</span><span class="p">,</span><span class="n">filetypes</span><span class="o">=</span><span class="n">filetypes</span><span class="p">,</span><span class="n">defaultextension</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fileName</span><span class="p">:</span><span class="k">return</span>
        <span class="n">s</span><span class="p">,</span><span class="n">e</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">readFileIntoString</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">g</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;@nocolor</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">s</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">bodyCtrl</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">insertHeadline</span><span class="p">(</span><span class="n">op_name</span><span class="o">=</span><span class="n">undoType</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">setHeadString</span><span class="p">(</span><span class="s">&#39;@read-file-into-node &#39;</span> <span class="o">+</span> <span class="n">fileName</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">setBodyString</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">w</span><span class="o">.</span><span class="n">setAllText</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2839: *6* c.readOutlineOnly</span></div>
<div class="viewcode-block" id="Commands.readOutlineOnly"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.readOutlineOnly">[docs]</a>    <span class="k">def</span> <span class="nf">readOutlineOnly</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Open a Leo outline from a .leo file, but do not read any derived files.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span>

        <span class="n">fileName</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">runOpenFileDialog</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s">&quot;Read Outline Only&quot;</span><span class="p">,</span>
            <span class="n">filetypes</span><span class="o">=</span><span class="p">[(</span><span class="s">&quot;Leo files&quot;</span><span class="p">,</span> <span class="s">&quot;*.leo&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s">&quot;All files&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">)],</span>
            <span class="n">defaultextension</span><span class="o">=</span><span class="s">&quot;.leo&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">fileName</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">theFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">newCommander</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">deiconify</span><span class="p">()</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">lift</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">fileCommands</span><span class="o">.</span><span class="n">readOutlineOnly</span><span class="p">(</span><span class="n">theFile</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span> <span class="c"># closes file.</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;can not open:&quot;</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20070915142635: *6* c.writeFileFromNode</span></div>
<div class="viewcode-block" id="Commands.writeFileFromNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.writeFileFromNode">[docs]</a>    <span class="k">def</span> <span class="nf">writeFileFromNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;If node starts with @read-file-into-node, use the full path name in the headline.</span>
<span class="sd">        Otherwise, prompt for a file name.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span>

        <span class="n">h</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="s">&#39;@read-file-into-node&#39;</span>

        <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">tag</span><span class="p">):</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">tag</span><span class="p">):]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">fileName</span><span class="p">:</span>
            <span class="n">filetypes</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&quot;All files&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">),(</span><span class="s">&quot;Python files&quot;</span><span class="p">,</span><span class="s">&quot;*.py&quot;</span><span class="p">),(</span><span class="s">&quot;Leo files&quot;</span><span class="p">,</span> <span class="s">&quot;*.leo&quot;</span><span class="p">),]</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">runSaveFileDialog</span><span class="p">(</span>
                <span class="n">initialfile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="s">&#39;Write File From Node&#39;</span><span class="p">,</span>
                <span class="n">filetypes</span><span class="o">=</span><span class="n">filetypes</span><span class="p">,</span>
                <span class="n">defaultextension</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fileName</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">theFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="n">theFile</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="n">theFile</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@nocolor</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">):</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s">&#39;@nocolor</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">):]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span> <span class="c"># 2010/08/27</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">reportErrors</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">theFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="n">theFile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&#39;wrote:&#39;</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>
                <span class="n">theFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;can not write </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2841: *5* Tangle submenu</span>
    <span class="c">#@+node:ekr.20031218072017.2842: *6* tangleAll</span></div>
<div class="viewcode-block" id="Commands.tangleAll"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.tangleAll">[docs]</a>    <span class="k">def</span> <span class="nf">tangleAll</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Tangle all @root nodes in the entire outline.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">c</span><span class="o">.</span><span class="n">tangleCommands</span><span class="o">.</span><span class="n">tangleAll</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.2843: *6* tangleMarked</span></div>
<div class="viewcode-block" id="Commands.tangleMarked"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.tangleMarked">[docs]</a>    <span class="k">def</span> <span class="nf">tangleMarked</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Tangle all marked @root nodes in the entire outline.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">c</span><span class="o">.</span><span class="n">tangleCommands</span><span class="o">.</span><span class="n">tangleMarked</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.2844: *6* tangle</span></div>
<div class="viewcode-block" id="Commands.tangle"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.tangle">[docs]</a>    <span class="k">def</span> <span class="nf">tangle</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Tangle all @root nodes in the selected outline.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">c</span><span class="o">.</span><span class="n">tangleCommands</span><span class="o">.</span><span class="n">tangle</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.2845: *5* Untangle submenu</span>
    <span class="c">#@+node:ekr.20031218072017.2846: *6* untangleAll</span></div>
<div class="viewcode-block" id="Commands.untangleAll"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.untangleAll">[docs]</a>    <span class="k">def</span> <span class="nf">untangleAll</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Untangle all @root nodes in the entire outline.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">c</span><span class="o">.</span><span class="n">tangleCommands</span><span class="o">.</span><span class="n">untangleAll</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">undoer</span><span class="o">.</span><span class="n">clearUndoState</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.2847: *6* untangleMarked</span></div>
<div class="viewcode-block" id="Commands.untangleMarked"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.untangleMarked">[docs]</a>    <span class="k">def</span> <span class="nf">untangleMarked</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Untangle all marked @root nodes in the entire outline.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">c</span><span class="o">.</span><span class="n">tangleCommands</span><span class="o">.</span><span class="n">untangleMarked</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">undoer</span><span class="o">.</span><span class="n">clearUndoState</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.2848: *6* untangle</span></div>
<div class="viewcode-block" id="Commands.untangle"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.untangle">[docs]</a>    <span class="k">def</span> <span class="nf">untangle</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Untangle all @root nodes in the selected outline.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">c</span><span class="o">.</span><span class="n">tangleCommands</span><span class="o">.</span><span class="n">untangle</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">undoer</span><span class="o">.</span><span class="n">clearUndoState</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.2849: *5* Export submenu</span>
    <span class="c">#@+node:ekr.20031218072017.2850: *6* c.exportHeadlines</span></div>
<div class="viewcode-block" id="Commands.exportHeadlines"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.exportHeadlines">[docs]</a>    <span class="k">def</span> <span class="nf">exportHeadlines</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Export all headlines to an external file.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">filetypes</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&quot;Text files&quot;</span><span class="p">,</span> <span class="s">&quot;*.txt&quot;</span><span class="p">),(</span><span class="s">&quot;All files&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">)]</span>

        <span class="n">fileName</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">runSaveFileDialog</span><span class="p">(</span>
            <span class="n">initialfile</span><span class="o">=</span><span class="s">&quot;headlines.txt&quot;</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s">&quot;Export Headlines&quot;</span><span class="p">,</span>
            <span class="n">filetypes</span><span class="o">=</span><span class="n">filetypes</span><span class="p">,</span>
            <span class="n">defaultextension</span><span class="o">=</span><span class="s">&quot;.txt&quot;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">bringToFront</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">fileName</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">setGlobalOpenDir</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">importCommands</span><span class="o">.</span><span class="n">exportHeadlines</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2851: *6* c.flattenOutline</span></div>
<div class="viewcode-block" id="Commands.flattenOutline"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.flattenOutline">[docs]</a>    <span class="k">def</span> <span class="nf">flattenOutline</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Export the selected outline to an external file.</span>
<span class="sd">        The outline is represented in MORE format.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">filetypes</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&quot;Text files&quot;</span><span class="p">,</span> <span class="s">&quot;*.txt&quot;</span><span class="p">),(</span><span class="s">&quot;All files&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">)]</span>

        <span class="n">fileName</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">runSaveFileDialog</span><span class="p">(</span>
            <span class="n">initialfile</span><span class="o">=</span><span class="s">&quot;flat.txt&quot;</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s">&quot;Flatten Selected Outline&quot;</span><span class="p">,</span>
            <span class="n">filetypes</span><span class="o">=</span><span class="n">filetypes</span><span class="p">,</span>
            <span class="n">defaultextension</span><span class="o">=</span><span class="s">&quot;.txt&quot;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">bringToFront</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">fileName</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">setGlobalOpenDir</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">importCommands</span><span class="o">.</span><span class="n">flattenOutline</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2857: *6* c.outlineToCWEB</span></div>
<div class="viewcode-block" id="Commands.outlineToCWEB"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.outlineToCWEB">[docs]</a>    <span class="k">def</span> <span class="nf">outlineToCWEB</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Export the selected outline to an external file.</span>
<span class="sd">        The outline is represented in CWEB format.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">filetypes</span><span class="o">=</span><span class="p">[</span>
            <span class="p">(</span><span class="s">&quot;CWEB files&quot;</span><span class="p">,</span> <span class="s">&quot;*.w&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;Text files&quot;</span><span class="p">,</span> <span class="s">&quot;*.txt&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;All files&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">)]</span>

        <span class="n">fileName</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">runSaveFileDialog</span><span class="p">(</span>
            <span class="n">initialfile</span><span class="o">=</span><span class="s">&quot;cweb.w&quot;</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s">&quot;Outline To CWEB&quot;</span><span class="p">,</span>
            <span class="n">filetypes</span><span class="o">=</span><span class="n">filetypes</span><span class="p">,</span>
            <span class="n">defaultextension</span><span class="o">=</span><span class="s">&quot;.w&quot;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">bringToFront</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">fileName</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">setGlobalOpenDir</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">importCommands</span><span class="o">.</span><span class="n">outlineToWeb</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="s">&quot;cweb&quot;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2858: *6* c.outlineToNoweb</span></div>
<div class="viewcode-block" id="Commands.outlineToNoweb"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.outlineToNoweb">[docs]</a>    <span class="k">def</span> <span class="nf">outlineToNoweb</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Export the selected outline to an external file.</span>
<span class="sd">        The outline is represented in noweb format.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">filetypes</span><span class="o">=</span><span class="p">[</span>
            <span class="p">(</span><span class="s">&quot;Noweb files&quot;</span><span class="p">,</span> <span class="s">&quot;*.nw&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;Text files&quot;</span><span class="p">,</span> <span class="s">&quot;*.txt&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;All files&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">)]</span>

        <span class="n">fileName</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">runSaveFileDialog</span><span class="p">(</span>
            <span class="n">initialfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outlineToNowebDefaultFileName</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s">&quot;Outline To Noweb&quot;</span><span class="p">,</span>
            <span class="n">filetypes</span><span class="o">=</span><span class="n">filetypes</span><span class="p">,</span>
            <span class="n">defaultextension</span><span class="o">=</span><span class="s">&quot;.nw&quot;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">bringToFront</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">fileName</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">setGlobalOpenDir</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">importCommands</span><span class="o">.</span><span class="n">outlineToWeb</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="s">&quot;noweb&quot;</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">outlineToNowebDefaultFileName</span> <span class="o">=</span> <span class="n">fileName</span>
    <span class="c">#@+node:ekr.20031218072017.2859: *6* c.removeSentinels</span></div>
<div class="viewcode-block" id="Commands.removeSentinels"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.removeSentinels">[docs]</a>    <span class="k">def</span> <span class="nf">removeSentinels</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Import one or more files, removing any sentinels.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">types</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">&quot;All files&quot;</span><span class="p">,</span><span class="s">&quot;*&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;C/C++ files&quot;</span><span class="p">,</span><span class="s">&quot;*.c&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;C/C++ files&quot;</span><span class="p">,</span><span class="s">&quot;*.cpp&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;C/C++ files&quot;</span><span class="p">,</span><span class="s">&quot;*.h&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;C/C++ files&quot;</span><span class="p">,</span><span class="s">&quot;*.hpp&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;Java files&quot;</span><span class="p">,</span><span class="s">&quot;*.java&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;Lua files&quot;</span><span class="p">,</span> <span class="s">&quot;*.lua&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;Pascal files&quot;</span><span class="p">,</span><span class="s">&quot;*.pas&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;Python files&quot;</span><span class="p">,</span><span class="s">&quot;*.py&quot;</span><span class="p">)</span> <span class="p">]</span>

        <span class="n">names</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">runOpenFileDialog</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s">&quot;Remove Sentinels&quot;</span><span class="p">,</span>
            <span class="n">filetypes</span><span class="o">=</span><span class="n">types</span><span class="p">,</span>
            <span class="n">defaultextension</span><span class="o">=</span><span class="s">&quot;.py&quot;</span><span class="p">,</span>
            <span class="n">multiple</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">bringToFront</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">c</span><span class="o">.</span><span class="n">importCommands</span><span class="o">.</span><span class="n">removeSentinelsCommand</span> <span class="p">(</span><span class="n">names</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2860: *6* weave</span></div>
<div class="viewcode-block" id="Commands.weave"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.weave">[docs]</a>    <span class="k">def</span> <span class="nf">weave</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Simulate a literate-programming weave operation by writing the outline to a text file.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">filetypes</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&quot;Text files&quot;</span><span class="p">,</span> <span class="s">&quot;*.txt&quot;</span><span class="p">),(</span><span class="s">&quot;All files&quot;</span><span class="p">,</span> <span class="s">&quot;*&quot;</span><span class="p">)]</span>

        <span class="n">fileName</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">runSaveFileDialog</span><span class="p">(</span>
            <span class="n">initialfile</span><span class="o">=</span><span class="s">&quot;weave.txt&quot;</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s">&quot;Weave&quot;</span><span class="p">,</span>
            <span class="n">filetypes</span><span class="o">=</span><span class="n">filetypes</span><span class="p">,</span>
            <span class="n">defaultextension</span><span class="o">=</span><span class="s">&quot;.txt&quot;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">bringToFront</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">fileName</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">setGlobalOpenDir</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">importCommands</span><span class="o">.</span><span class="n">weave</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2861: *4* Edit Menu...</span>
    <span class="c">#@+node:ekr.20031218072017.2862: *5* Edit top level</span>
    <span class="c">#@+node:ekr.20031218072017.2090: *6* c.colorPanel</span></div>
<div class="viewcode-block" id="Commands.colorPanel"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.colorPanel">[docs]</a>    <span class="k">def</span> <span class="nf">colorPanel</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Open the color dialog.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">frame</span><span class="o">.</span><span class="n">colorPanel</span><span class="p">:</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">colorPanel</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">createColorPanel</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="n">frame</span><span class="o">.</span><span class="n">colorPanel</span><span class="o">.</span><span class="n">bringToFront</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.2140: *6* c.executeScript &amp; helpers</span></div>
<div class="viewcode-block" id="Commands.executeScript"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.executeScript">[docs]</a>    <span class="k">def</span> <span class="nf">executeScript</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">script</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">useSelectedText</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">define_g</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">define_name</span><span class="o">=</span><span class="s">&#39;__main__&#39;</span><span class="p">,</span><span class="n">silent</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">namespace</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">raiseFlag</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;This executes body text as a Python script.</span>

<span class="sd">        We execute the selected text, or the entire body text if no text is selected.&quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">script1</span> <span class="o">=</span> <span class="n">script</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">script</span><span class="p">:</span>
            <span class="n">script</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">getScript</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">,</span><span class="n">useSelectedText</span><span class="o">=</span><span class="n">useSelectedText</span><span class="p">)</span>

        <span class="n">script_p</span> <span class="o">=</span> <span class="n">p</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span> <span class="c"># Only for error reporting below.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">redirectScriptOutput</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">oldLog</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">log</span> <span class="c"># 2011/01/19</span>
            <span class="n">log</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">log</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span>
            <span class="k">if</span> <span class="n">script</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">openDirectory</span><span class="p">)</span>
                <span class="n">script</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="c"># Make sure we end the script properly.</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c"># We *always* execute the script with p = c.p.</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">executeScriptHelper</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="n">define_g</span><span class="p">,</span><span class="n">define_name</span><span class="p">,</span><span class="n">namespace</span><span class="p">,</span><span class="n">script</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">raiseFlag</span><span class="p">:</span>
                        <span class="k">raise</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">handleScriptException</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">script_p</span><span class="p">,</span><span class="n">script</span><span class="p">,</span><span class="n">script1</span><span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tabName</span> <span class="o">=</span> <span class="n">log</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">log</span><span class="p">,</span><span class="s">&#39;tabName&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">log</span><span class="o">.</span><span class="n">tabName</span> <span class="ow">or</span> <span class="s">&#39;Log&#39;</span>
                <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;no script selected&quot;</span><span class="p">,</span><span class="n">tabName</span><span class="o">=</span><span class="n">tabName</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">oldLog</span> <span class="c"># 2011/01/19</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unredirectScriptOutput</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20120923063251.10651: *7* c.executeScriptHelper</span></div>
<div class="viewcode-block" id="Commands.executeScriptHelper"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.executeScriptHelper">[docs]</a>    <span class="k">def</span> <span class="nf">executeScriptHelper</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">args</span><span class="p">,</span><span class="n">define_g</span><span class="p">,</span><span class="n">define_name</span><span class="p">,</span><span class="n">namespace</span><span class="p">,</span><span class="n">script</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c"># *Always* use c.p and pass c.p to script.</span>
        <span class="n">c</span><span class="o">.</span><span class="n">setCurrentDirectoryFromContext</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">define_g</span><span class="p">,{</span><span class="s">&#39;c&#39;</span><span class="p">:</span><span class="n">c</span><span class="p">,</span><span class="s">&#39;g&#39;</span><span class="p">:</span><span class="n">g</span><span class="p">,</span><span class="s">&#39;p&#39;</span><span class="p">:</span><span class="n">p</span><span class="p">},{})</span>
        <span class="k">if</span> <span class="n">define_name</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;__name__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">define_name</span>
        <span class="n">d</span><span class="p">[</span><span class="s">&#39;script_args&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">args</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">namespace</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">namespace</span><span class="p">)</span>

        <span class="c"># A kludge: reset c.inCommand here to handle the case where we *never* return.</span>
        <span class="c"># (This can happen when there are multiple event loops.)</span>
        <span class="c"># This does not prevent zombie windows if the script puts up a dialog...</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">inCommand</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">g</span><span class="o">.</span><span class="n">inScript</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">inScript</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="c"># g.inScript is a synonym for g.app.inScript.</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">write_script_file</span><span class="p">:</span>
                <span class="n">scriptFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">writeScriptFile</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
                    <span class="k">exec</span><span class="p">(</span><span class="nb">compile</span><span class="p">(</span><span class="n">script</span><span class="p">,</span><span class="n">scriptFile</span><span class="p">,</span><span class="s">&#39;exec&#39;</span><span class="p">),</span><span class="n">d</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">execfile</span><span class="p">(</span><span class="n">scriptFile</span><span class="p">,</span><span class="n">d</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">exec</span><span class="p">(</span><span class="n">script</span><span class="p">,</span><span class="n">d</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">inScript</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">inScript</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20031218072017.2143: *7* c.redirectScriptOutput</span></div>
<div class="viewcode-block" id="Commands.redirectScriptOutput"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.redirectScriptOutput">[docs]</a>    <span class="k">def</span> <span class="nf">redirectScriptOutput</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># g.trace(&#39;original&#39;)</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">redirect_execute_script_output_to_log_pane</span><span class="p">:</span>

            <span class="n">g</span><span class="o">.</span><span class="n">redirectStdout</span><span class="p">()</span> <span class="c"># Redirect stdout</span>
            <span class="n">g</span><span class="o">.</span><span class="n">redirectStderr</span><span class="p">()</span> <span class="c"># Redirect stderr</span>
    <span class="c">#@+node:ekr.20110522121957.18230: *7* c.setCurrentDirectoryFromContext</span></div>
<div class="viewcode-block" id="Commands.setCurrentDirectoryFromContext"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.setCurrentDirectoryFromContext">[docs]</a>    <span class="k">def</span> <span class="nf">setCurrentDirectoryFromContext</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">aList</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_directives_dict_list</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">scanAtPathDirectives</span><span class="p">(</span><span class="n">aList</span><span class="p">)</span>

        <span class="n">curDir</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>

        <span class="c"># g.trace(p.h,&#39;\npath  &#39;,path,&#39;\ncurDir&#39;,curDir)</span>

        <span class="k">if</span> <span class="n">path</span> <span class="ow">and</span> <span class="n">path</span> <span class="o">!=</span> <span class="n">curDir</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;calling os.chdir(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
    <span class="c">#@+node:EKR.20040627100424: *7* c.unredirectScriptOutput</span></div>
<div class="viewcode-block" id="Commands.unredirectScriptOutput"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.unredirectScriptOutput">[docs]</a>    <span class="k">def</span> <span class="nf">unredirectScriptOutput</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># g.trace(&#39;original&#39;)</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">exists</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">redirect_execute_script_output_to_log_pane</span><span class="p">:</span>

            <span class="n">g</span><span class="o">.</span><span class="n">restoreStderr</span><span class="p">()</span>
            <span class="n">g</span><span class="o">.</span><span class="n">restoreStdout</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.2088: *6* c.fontPanel</span></div>
<div class="viewcode-block" id="Commands.fontPanel"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.fontPanel">[docs]</a>    <span class="k">def</span> <span class="nf">fontPanel</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Open the font dialog.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">frame</span><span class="o">.</span><span class="n">fontPanel</span><span class="p">:</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">fontPanel</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">createFontPanel</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="n">frame</span><span class="o">.</span><span class="n">fontPanel</span><span class="o">.</span><span class="n">bringToFront</span><span class="p">()</span>
    <span class="c">#@+node:EKR.20040612232221: *6* c.goToScriptLineNumber</span>
    <span class="c"># Called from g.handleScriptException.</span>
</div>
<div class="viewcode-block" id="Commands.goToScriptLineNumber"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.goToScriptLineNumber">[docs]</a>    <span class="k">def</span> <span class="nf">goToScriptLineNumber</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">script</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Go to line n of a script.&quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">scriptData</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;p&#39;</span><span class="p">:</span><span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span><span class="s">&#39;lines&#39;</span><span class="p">:</span><span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">script</span><span class="p">)}</span>
        <span class="n">c</span><span class="o">.</span><span class="n">goToLineNumber</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">go</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span><span class="n">scriptData</span><span class="o">=</span><span class="n">scriptData</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2086: *6* c.preferences</span></div>
<div class="viewcode-block" id="Commands.preferences"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.preferences">[docs]</a>    <span class="k">def</span> <span class="nf">preferences</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Handle the preferences command.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">c</span><span class="o">.</span><span class="n">openLeoSettings</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.2883: *6* c.show/hide/toggleInvisibles</span></div>
<div class="viewcode-block" id="Commands.hideInvisibles"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.hideInvisibles">[docs]</a>    <span class="k">def</span> <span class="nf">hideInvisibles</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Hide invisible (whitespace) characters.&#39;&#39;&#39;</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span><span class="o">.</span><span class="n">showInvisiblesHelper</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Commands.showInvisibles"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.showInvisibles">[docs]</a>    <span class="k">def</span> <span class="nf">showInvisibles</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Show invisible (whitespace) characters.&#39;&#39;&#39;</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span><span class="o">.</span><span class="n">showInvisiblesHelper</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Commands.toggleShowInvisibles"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.toggleShowInvisibles">[docs]</a>    <span class="k">def</span> <span class="nf">toggleShowInvisibles</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Toggle showing of invisible (whitespace) characters.&#39;&#39;&#39;</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">colorizer</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">getColorizer</span><span class="p">()</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">colorizer</span><span class="o">.</span><span class="n">showInvisibles</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">showInvisiblesHelper</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Commands.showInvisiblesHelper"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.showInvisiblesHelper">[docs]</a>    <span class="k">def</span> <span class="nf">showInvisiblesHelper</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">val</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="n">colorizer</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">getColorizer</span><span class="p">()</span>
        <span class="n">colorizer</span><span class="o">.</span><span class="n">showInvisibles</span> <span class="o">=</span> <span class="n">val</span>

         <span class="c"># It is much easier to change the menu name here than in the menu updater.</span>
        <span class="n">menu</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">getMenu</span><span class="p">(</span><span class="s">&quot;Edit&quot;</span><span class="p">)</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">getMenuLabel</span><span class="p">(</span><span class="n">menu</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="s">&#39;Hide Invisibles&#39;</span><span class="p">,</span><span class="s">&#39;Show Invisibles&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">val</span><span class="p">:</span> <span class="n">frame</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">setMenuLabel</span><span class="p">(</span><span class="n">menu</span><span class="p">,</span><span class="s">&quot;Show Invisibles&quot;</span><span class="p">,</span><span class="s">&quot;Hide Invisibles&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>   <span class="n">frame</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">setMenuLabel</span><span class="p">(</span><span class="n">menu</span><span class="p">,</span><span class="s">&quot;Hide Invisibles&quot;</span><span class="p">,</span><span class="s">&quot;Show Invisibles&quot;</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">recolor</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20070115135502: *6* c.writeScriptFile</span></div>
<div class="viewcode-block" id="Commands.writeScriptFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.writeScriptFile">[docs]</a>    <span class="k">def</span> <span class="nf">writeScriptFile</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">script</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="c"># Get the path to the file.</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getString</span><span class="p">(</span><span class="s">&#39;script_file_path&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">isAbsPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">driveSpec</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitdrive</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
            <span class="c"># xxx bad idea, loadDir is often read only!</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadDir</span>
            <span class="k">if</span> <span class="n">isAbsPath</span><span class="p">:</span>
                <span class="c"># make the first element absolute</span>
                <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">driveSpec</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">allParts</span> <span class="o">=</span> <span class="p">[</span><span class="n">path</span><span class="p">]</span> <span class="o">+</span> <span class="n">parts</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="o">*</span><span class="n">allParts</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span>
                <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">homeLeoDir</span><span class="p">,</span><span class="s">&#39;scriptFile.py&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>                

        <span class="c"># Write the file.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
                <span class="c"># Use the default encoding.</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">script</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span> <span class="c"># 2010/08/27</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">reportErrors</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;Failed to write script to </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
            <span class="c"># g.es(&quot;Check your configuration of script_file_path, currently %s&quot; %</span>
                <span class="c"># c.config.getString(&#39;script_file_path&#39;))</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">return</span> <span class="n">path</span>
    <span class="c">#@+node:ekr.20100216141722.5620: *6* class goToLineNumber and helpers (commands)</span></div>
<div class="viewcode-block" id="Commands.goToLineNumber"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.goToLineNumber">[docs]</a>    <span class="k">class</span> <span class="nc">goToLineNumber</span><span class="p">:</span>

        <span class="sd">&#39;&#39;&#39;A class implementing goto-global-line.&#39;&#39;&#39;</span>

        <span class="c">#@+others</span>
        <span class="c">#@+node:ekr.20100216141722.5621: *7*  __init__ (gotoLineNumber)</span>
        <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>

            <span class="c"># g.trace(&#39;(c.gotoLineNumber)&#39;)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">c</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isAtAuto</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c">#@+node:ekr.20100216141722.5622: *7* go</span>
<div class="viewcode-block" id="Commands.goToLineNumber.go"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.goToLineNumber.go">[docs]</a>        <span class="k">def</span> <span class="nf">go</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">scriptData</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

            <span class="sd">&#39;&#39;&#39;Place the cursor on the n&#39;th line of a derived file or script.</span>
<span class="sd">            When present scriptData is a dict with &#39;root&#39; and &#39;lines&#39; keys.&#39;&#39;&#39;</span>

            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span>

            <span class="k">if</span> <span class="n">scriptData</span><span class="p">:</span>
                <span class="n">fileName</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_script</span><span class="p">(</span><span class="n">scriptData</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
                <span class="n">fileName</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_file</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">isAtAuto</span> <span class="o">=</span> <span class="n">root</span> <span class="ow">and</span> <span class="n">root</span><span class="o">.</span><span class="n">isAtAutoNode</span><span class="p">()</span>
            <span class="n">isRaw</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">root</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="n">root</span><span class="o">.</span><span class="n">isAtEditNode</span><span class="p">()</span> <span class="ow">or</span> <span class="n">root</span><span class="o">.</span><span class="n">isAtAsisFileNode</span><span class="p">()</span> <span class="ow">or</span>
                <span class="n">root</span><span class="o">.</span><span class="n">isAtAutoNode</span><span class="p">()</span> <span class="ow">or</span> <span class="n">root</span><span class="o">.</span><span class="n">isAtNoSentFileNode</span><span class="p">())</span>
            <span class="n">ignoreSentinels</span> <span class="o">=</span> <span class="n">root</span> <span class="ow">and</span> <span class="n">root</span><span class="o">.</span><span class="n">isAtNoSentFileNode</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">root</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">scriptData</span><span class="p">:</span>  <span class="n">root</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>           <span class="n">root</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

            <span class="k">if</span> <span class="n">isRaw</span><span class="p">:</span>
                <span class="n">p</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">found</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">countLines</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
                <span class="n">n2</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c"># Convert to one-based.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vnodeName</span><span class="p">,</span><span class="n">gnx</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">delim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findVnode</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">ignoreSentinels</span><span class="p">)</span>
                <span class="n">p</span><span class="p">,</span><span class="n">found</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findGnx</span><span class="p">(</span><span class="n">delim</span><span class="p">,</span><span class="n">root</span><span class="p">,</span><span class="n">gnx</span><span class="p">,</span><span class="n">vnodeName</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">showResults</span><span class="p">(</span><span class="n">found</span><span class="p">,</span><span class="n">p</span> <span class="ow">or</span> <span class="n">root</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">lines</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">found</span>
        <span class="c">#@+node:ekr.20100216141722.5623: *7* countLines &amp; helpers</span></div>
<div class="viewcode-block" id="Commands.goToLineNumber.countLines"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.goToLineNumber.countLines">[docs]</a>        <span class="k">def</span> <span class="nf">countLines</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">root</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>

            <span class="sd">&#39;&#39;&#39;Scan through root&#39;s outline, looking for line n (one based).</span>
<span class="sd">            Return (p,i,found)</span>
<span class="sd">            p is the found node.</span>
<span class="sd">            i is the offset of the line within the node.</span>
<span class="sd">            found is True if the line was found.&#39;&#39;&#39;</span>

            <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
            <span class="c"># c = self.c</span>

            <span class="c"># Start the recursion.</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="c"># Convert to zero based internally.</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> (zero-based) </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;*&#39;</span> <span class="o">*</span> <span class="mi">20</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">root</span><span class="o">.</span><span class="n">h</span><span class="p">))</span>
            <span class="n">p</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">junk</span><span class="p">,</span><span class="n">found</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">countLinesHelper</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">trace</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">p</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">found</span> <span class="c"># The index is zero-based.</span>
        <span class="c">#@+node:ekr.20100216141722.5624: *8* countLinesHelper</span></div>
<div class="viewcode-block" id="Commands.goToLineNumber.countLinesHelper"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.goToLineNumber.countLinesHelper">[docs]</a>        <span class="k">def</span> <span class="nf">countLinesHelper</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">trace</span><span class="p">):</span>

            <span class="sd">&#39;&#39;&#39;Scan p&#39;s body text, looking for line n (zero-based).</span>
<span class="sd">            ao is the index of the line containing @others or None.</span>

<span class="sd">            Return (p,i,n,effective_lines,found)</span>
<span class="sd">            found: True if the line was found.</span>
<span class="sd">            if found::</span>

<span class="sd">                p:              The found node.</span>
<span class="sd">                i:              The offset of the line within the node.</span>
<span class="sd">                effective_lines:-1 (not used)</span>

<span class="sd">            if not found::</span>

<span class="sd">                p:              The original node.</span>
<span class="sd">                i:              -1 (not used)</span>
<span class="sd">                effective_lines:The number of lines in this node and all descendant nodes.</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
            <span class="c"># c = self.c</span>
            <span class="n">ao</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c"># The index of the line being scanning in this node.</span>
            <span class="n">effective_lines</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c"># The number of &quot;counted&quot; lines including the present line i.</span>
            <span class="c"># Invariant 1: n never changes in this method(!)</span>
            <span class="c"># Invariant 2: n is alway the target line.</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                <span class="n">progress</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;i </span><span class="si">%3s</span><span class="s"> effective </span><span class="si">%3s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">i</span><span class="p">,</span><span class="n">effective_lines</span><span class="p">,</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()))</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@others&#39;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">ao</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">hasChildren</span><span class="p">():</span>
                            <span class="n">ao</span> <span class="o">=</span> <span class="n">i</span>
                            <span class="c"># Count lines in inner nodes.</span>
                            <span class="c"># Pass n-effective_lines as the targe line number.</span>
                            <span class="n">new_n</span> <span class="o">=</span> <span class="n">n</span><span class="o">-</span><span class="n">effective_lines</span>
                            <span class="n">p2</span><span class="p">,</span><span class="n">i2</span><span class="p">,</span><span class="n">effective_lines2</span><span class="p">,</span><span class="n">found</span> <span class="o">=</span> \
                                <span class="bp">self</span><span class="o">.</span><span class="n">countLinesInChildren</span><span class="p">(</span><span class="n">new_n</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">trace</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
                                <span class="k">return</span> <span class="n">p2</span><span class="p">,</span><span class="n">i2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="bp">True</span> <span class="c"># effective_lines doesn&#39;t matter.</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c"># Assert that the line has not been found.</span>
                                <span class="k">if</span> <span class="n">effective_lines2</span> <span class="o">&gt;</span> <span class="n">new_n</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
                                        <span class="s">&#39;***oops! effective_lines2: </span><span class="si">%s</span><span class="s">, new_n: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">effective_lines2</span><span class="p">,</span><span class="n">new_n</span><span class="p">))</span>
                                    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span> <span class="k">assert</span> <span class="bp">False</span>
                                <span class="n">effective_lines</span> <span class="o">+=</span> <span class="n">effective_lines2</span>
                                <span class="c"># Do *not* change i: it will be bumped below.</span>
                                <span class="c"># Invariant: n never changes!</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">pass</span> <span class="c"># silently ignore erroneous @others.</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">pass</span> <span class="c"># A regular directive: don&#39;t change n or i here.</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># Bug fix 2011/01/21: use effective_lines, not i, in this comparison.</span>
                    <span class="c"># The line is now known to be effective.</span>
                    <span class="k">if</span> <span class="n">effective_lines</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;Found! n: </span><span class="si">%s</span><span class="s"> i: </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                        <span class="k">return</span> <span class="n">p</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="bp">True</span> <span class="c"># effective_lines doesn&#39;t matter.</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">effective_lines</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c"># This is the one and only place we update i in this loop.</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">assert</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">progress</span>

            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;Not found. n: </span><span class="si">%s</span><span class="s"> effective_lines: </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">n</span><span class="p">,</span><span class="n">effective_lines</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">p</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">effective_lines</span><span class="p">,</span><span class="bp">False</span> <span class="c"># i doesn&#39;t matter.</span>
        <span class="c">#@+node:ekr.20100216141722.5625: *8* countLinesInChildren</span></div>
<div class="viewcode-block" id="Commands.goToLineNumber.countLinesInChildren"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.goToLineNumber.countLinesInChildren">[docs]</a>        <span class="k">def</span> <span class="nf">countLinesInChildren</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">trace</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
            <span class="n">effective_lines</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span><span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;child </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">child</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
                <span class="c"># Recursively scan the children.</span>
                <span class="c"># Pass n-effective_lines as the targe line number for each child.</span>
                <span class="n">new_n</span> <span class="o">=</span> <span class="n">n</span><span class="o">-</span><span class="n">effective_lines</span>
                <span class="n">p2</span><span class="p">,</span><span class="n">i2</span><span class="p">,</span><span class="n">effective_lines2</span><span class="p">,</span><span class="n">found</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">countLinesHelper</span><span class="p">(</span><span class="n">child</span><span class="p">,</span><span class="n">new_n</span><span class="p">,</span><span class="n">trace</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;Found! i2: </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i2</span><span class="p">,</span><span class="n">child</span><span class="o">.</span><span class="n">h</span><span class="p">))</span>
                    <span class="k">return</span> <span class="n">p2</span><span class="p">,</span><span class="n">i2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="bp">True</span> <span class="c"># effective_lines doesn&#39;t matter.</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># Assert that the line has not been found.</span>
                    <span class="k">if</span> <span class="n">effective_lines2</span> <span class="o">&gt;</span> <span class="n">new_n</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
                            <span class="s">&#39;*** oops! effective_lines2: </span><span class="si">%s</span><span class="s">, new_n: </span><span class="si">%s</span><span class="s"> n: </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">effective_lines2</span><span class="p">,</span><span class="n">new_n</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span> <span class="k">assert</span> <span class="bp">False</span>
                    <span class="c"># i2 is not used</span>
                    <span class="n">effective_lines</span> <span class="o">+=</span> <span class="n">effective_lines2</span>

            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;Not found. effective_lines: </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">effective_lines</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">p</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">effective_lines</span><span class="p">,</span><span class="bp">False</span> <span class="c"># i does not matter.</span>
        <span class="c">#@+node:ekr.20100216141722.5626: *7* findGnx</span></div>
<div class="viewcode-block" id="Commands.goToLineNumber.findGnx"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.goToLineNumber.findGnx">[docs]</a>        <span class="k">def</span> <span class="nf">findGnx</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">delim</span><span class="p">,</span><span class="n">root</span><span class="p">,</span><span class="n">gnx</span><span class="p">,</span><span class="n">vnodeName</span><span class="p">):</span>

            <span class="sd">&#39;&#39;&#39;Scan root&#39;s tree for a node with the given gnx and vnodeName.</span>

<span class="sd">            return (p,found)&#39;&#39;&#39;</span>

            <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

            <span class="k">if</span> <span class="n">delim</span> <span class="ow">and</span> <span class="n">gnx</span><span class="p">:</span>
                <span class="n">gnx</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">nodeIndices</span><span class="o">.</span><span class="n">scanGnx</span><span class="p">(</span><span class="n">gnx</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">self_and_subtree</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">matchHeadline</span><span class="p">(</span><span class="n">vnodeName</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">fileIndex</span> <span class="o">==</span> <span class="n">gnx</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span><span class="bp">True</span>

                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;not found! </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gnx</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">vnodeName</span><span class="p">)))</span>
                <span class="k">return</span> <span class="bp">None</span><span class="p">,</span><span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">root</span><span class="p">,</span><span class="bp">False</span>
        <span class="c">#@+node:ekr.20100216141722.5627: *7* findRoot</span></div>
<div class="viewcode-block" id="Commands.goToLineNumber.findRoot"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.goToLineNumber.findRoot">[docs]</a>        <span class="k">def</span> <span class="nf">findRoot</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

            <span class="sd">&#39;&#39;&#39;Find the closest ancestor @&lt;file&gt; node, except @all nodes.</span>

<span class="sd">            return root, fileName.&#39;&#39;&#39;</span>

            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c"># First look for ancestor @file node.</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">self_and_parents</span><span class="p">():</span>
                <span class="n">fileName</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtAllNode</span><span class="p">()</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">anyAtFileNodeName</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">fileName</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span><span class="n">fileName</span>

            <span class="c"># Search the entire tree for joined nodes.</span>
            <span class="c"># Bug fix: Leo 4.5.1: *must* search *all* positions.</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">all_positions</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="o">==</span> <span class="n">p1</span><span class="o">.</span><span class="n">v</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">p1</span><span class="p">:</span>
                    <span class="c"># Found a joined position.</span>
                    <span class="k">for</span> <span class="n">p2</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">self_and_parents</span><span class="p">():</span>
                        <span class="n">fileName</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">p2</span><span class="o">.</span><span class="n">isAtAllNode</span><span class="p">()</span> <span class="ow">and</span> <span class="n">p2</span><span class="o">.</span><span class="n">anyAtFileNodeName</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">fileName</span><span class="p">:</span>
                            <span class="k">return</span> <span class="n">p2</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span><span class="n">fileName</span>

            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span><span class="bp">None</span>
        <span class="c">#@+node:ekr.20100216141722.5628: *7* findVnode &amp; helpers</span></div>
<div class="viewcode-block" id="Commands.goToLineNumber.findVnode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.goToLineNumber.findVnode">[docs]</a>        <span class="k">def</span> <span class="nf">findVnode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">root</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">ignoreSentinels</span><span class="p">):</span>

            <span class="sd">&#39;&#39;&#39;Search the lines of a derived file containing sentinels for a vnode.</span>
<span class="sd">            return (vnodeName,gnx,offset,delim):</span>

<span class="sd">            vnodeName:  the name found in the previous @+body sentinel.</span>
<span class="sd">            gnx:        the gnx of the found node.</span>
<span class="sd">            offset:     the offset within the node of the desired line.</span>
<span class="sd">            delim:      the comment delim from the @+leo sentinel.</span>
<span class="sd">            &#39;&#39;&#39;</span>

            <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
            <span class="c"># c = self.c</span>
            <span class="c"># g.trace(&#39;lines...\n&#39;,g.listToString(lines))</span>
            <span class="n">gnx</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">delim</span><span class="p">,</span><span class="n">readVersion5</span><span class="p">,</span><span class="n">thinFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setDelimFromLines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">delim</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;no sentinels in:&#39;</span><span class="p">,</span><span class="n">root</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span>

            <span class="n">nodeLine</span><span class="p">,</span><span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findNodeSentinel</span><span class="p">(</span><span class="n">delim</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nodeLine</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                    <span class="c"># The line precedes the first @+node sentinel</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;no @+node!!&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">root</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="n">gnx</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">delim</span>

            <span class="n">s</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">nodeLine</span><span class="p">]</span>
            <span class="n">gnx</span><span class="p">,</span><span class="n">vnodeName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNodeLineInfo</span><span class="p">(</span><span class="n">readVersion5</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">thinFile</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">delim</span> <span class="ow">and</span> <span class="n">vnodeName</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;offset: </span><span class="si">%s</span><span class="s">, vnodeName: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">offset</span><span class="p">,</span><span class="n">vnodeName</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">vnodeName</span><span class="p">,</span><span class="n">gnx</span><span class="p">,</span><span class="n">offset</span><span class="p">,</span><span class="n">delim</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;bad @+node sentinel&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span>
        <span class="c">#@+node:ekr.20100216141722.5629: *8* findNodeSentinel &amp; helper</span></div>
<div class="viewcode-block" id="Commands.goToLineNumber.findNodeSentinel"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.goToLineNumber.findNodeSentinel">[docs]</a>        <span class="k">def</span> <span class="nf">findNodeSentinel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">delim</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>

            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Scan backwards from the line n, looking for an @-body line. When found,</span>
<span class="sd">            get the vnode&#39;s name from that line and set p to the indicated vnode. This</span>
<span class="sd">            will fail if vnode names have been changed, and that can&#39;t be helped.</span>

<span class="sd">            We compute the offset of the requested line **within the found node**.</span>
<span class="sd">            &#39;&#39;&#39;</span>

            <span class="c"># c = self.c</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># This is essentially the Tk line number.</span>
            <span class="n">nodeSentinelLine</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span> <span class="c"># Start with the requested line.</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">line</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nodeSentinelLine</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">progress</span> <span class="o">=</span> <span class="n">line</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">line</span><span class="p">]</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">delim</span><span class="p">):</span>
                    <span class="n">line</span><span class="p">,</span><span class="n">nodeSentinelLine</span><span class="p">,</span><span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handleDelim</span><span class="p">(</span>
                        <span class="n">delim</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">line</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">offset</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">assert</span> <span class="n">nodeSentinelLine</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">line</span> <span class="o">&lt;</span> <span class="n">progress</span>
            <span class="k">return</span> <span class="n">nodeSentinelLine</span><span class="p">,</span><span class="n">offset</span>
        <span class="c">#@+node:ekr.20100216141722.5630: *9* handleDelim</span></div>
<div class="viewcode-block" id="Commands.goToLineNumber.handleDelim"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.goToLineNumber.handleDelim">[docs]</a>        <span class="k">def</span> <span class="nf">handleDelim</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">delim</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">line</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">offset</span><span class="p">):</span>

            <span class="sd">&#39;&#39;&#39;Handle the delim while scanning backward.&#39;&#39;&#39;</span>

            <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
            <span class="c"># c = self.c</span>
            <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;line&quot;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">),</span><span class="s">&quot;is a sentinel line&quot;</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">delim</span><span class="p">)</span>
            <span class="n">nodeSentinelLine</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

            <span class="c"># This code works for both old and new sentinels.</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;-node&quot;</span><span class="p">):</span>
                <span class="c"># The end of a nested section.</span>
                <span class="n">old_line</span> <span class="o">=</span> <span class="n">line</span>
                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skipToMatchingNodeSentinel</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="n">line</span><span class="p">,</span><span class="n">delim</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">line</span> <span class="o">&lt;</span> <span class="n">old_line</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;found&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">line</span><span class="p">]))</span>
                <span class="n">nodeSentinelLine</span> <span class="o">=</span> <span class="n">line</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="n">n</span><span class="o">-</span><span class="n">line</span>
            <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;+node&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;found&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">line</span><span class="p">]))</span>
                <span class="n">nodeSentinelLine</span> <span class="o">=</span> <span class="n">line</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="n">n</span><span class="o">-</span><span class="n">line</span>
            <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;&lt;&lt;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;@first&quot;</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="n">nodeSentinelLine</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">return</span> <span class="n">line</span><span class="p">,</span><span class="n">nodeSentinelLine</span><span class="p">,</span><span class="n">offset</span>
        <span class="c">#@+node:ekr.20100216141722.5631: *8* getNodeLineInfo &amp; helper</span></div>
<div class="viewcode-block" id="Commands.goToLineNumber.getNodeLineInfo"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.goToLineNumber.getNodeLineInfo">[docs]</a>        <span class="k">def</span> <span class="nf">getNodeLineInfo</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">readVersion5</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">thinFile</span><span class="p">):</span>

            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">gnx</span> <span class="o">=</span> <span class="bp">None</span> <span class="p">;</span> <span class="n">vnodeName</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="k">if</span> <span class="n">thinFile</span><span class="p">:</span>
                <span class="c"># gnx is lies between the first and second &#39;:&#39;:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>   <span class="n">gnx</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>       <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="c"># Force an error.</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="c"># Force an error.</span>

            <span class="c"># old sentinels: vnode name is everything following the first or second&#39;:&#39;</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">vnodeName</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">readVersion5</span><span class="p">:</span> <span class="c"># new sentinels: remove level stars.</span>
                    <span class="n">vnodeName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">removeLevelStars</span><span class="p">(</span><span class="n">vnodeName</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vnodeName</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;bad @+node sentinel&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">gnx</span><span class="p">,</span><span class="n">vnodeName</span>
        <span class="c">#@+node:ekr.20100728074713.5843: *9* removeLevelStars</span></div>
<div class="viewcode-block" id="Commands.goToLineNumber.removeLevelStars"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.goToLineNumber.removeLevelStars">[docs]</a>        <span class="k">def</span> <span class="nf">removeLevelStars</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

            <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

            <span class="c"># Remove leading stars.</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;*&#39;</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c"># Remove optional level number.</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c"># Remove trailing stars.</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;*&#39;</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c"># Remove one blank.</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39; &#39;</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">return</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>
        <span class="c">#@+node:ekr.20100216141722.5632: *8* setDelimFromLines</span></div>
<div class="viewcode-block" id="Commands.goToLineNumber.setDelimFromLines"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.goToLineNumber.setDelimFromLines">[docs]</a>        <span class="k">def</span> <span class="nf">setDelimFromLines</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lines</span><span class="p">):</span>

            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">at</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">atFileCommands</span>

            <span class="c"># Find the @+leo line.</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> 
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="ow">and</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;@+leo&quot;</span><span class="p">)</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">leoLine</span> <span class="o">=</span> <span class="n">i</span> <span class="c"># Index of the line containing the leo sentinel</span>

            <span class="c"># Set delim and thinFile from the @+leo line.</span>
            <span class="n">delim</span><span class="p">,</span><span class="n">thinFile</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span><span class="bp">False</span>

            <span class="k">if</span> <span class="n">leoLine</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">leoLine</span><span class="p">]</span>
                <span class="n">valid</span><span class="p">,</span><span class="n">newDerivedFile</span><span class="p">,</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">,</span><span class="n">thinFile</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">parseLeoSentinel</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="n">readVersion5</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">readVersion5</span>

                <span class="c"># New in Leo 4.5.1: only support 4.x files.</span>
                <span class="k">if</span> <span class="n">valid</span> <span class="ow">and</span> <span class="n">newDerivedFile</span><span class="p">:</span>
                    <span class="n">delim</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="s">&#39;@&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">readVersion5</span> <span class="o">=</span> <span class="bp">False</span>

            <span class="k">return</span> <span class="n">delim</span><span class="p">,</span><span class="n">readVersion5</span><span class="p">,</span><span class="n">thinFile</span>
        <span class="c">#@+node:ekr.20100216141722.5633: *8* skipToMatchingNodeSentinel (no longer used)</span></div>
<div class="viewcode-block" id="Commands.goToLineNumber.skipToMatchingNodeSentinel"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.goToLineNumber.skipToMatchingNodeSentinel">[docs]</a>        <span class="k">def</span> <span class="nf">skipToMatchingNodeSentinel</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">delim</span><span class="p">):</span>

            <span class="n">s</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">delim</span><span class="p">))</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">delim</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;+node&quot;</span><span class="p">):</span>
                <span class="n">start</span><span class="o">=</span><span class="s">&quot;+node&quot;</span> <span class="p">;</span> <span class="n">end</span><span class="o">=</span><span class="s">&quot;-node&quot;</span> <span class="p">;</span> <span class="n">delta</span><span class="o">=</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;-node&quot;</span><span class="p">))</span>
                <span class="n">start</span><span class="o">=</span><span class="s">&quot;-node&quot;</span> <span class="p">;</span> <span class="n">end</span><span class="o">=</span><span class="s">&quot;+node&quot;</span> <span class="p">;</span> <span class="n">delta</span><span class="o">=-</span><span class="mi">1</span>
            <span class="c"># Scan to matching @+-node delim.</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="n">delta</span> <span class="p">;</span> <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">delim</span><span class="p">):</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">delim</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">start</span><span class="p">):</span>
                        <span class="n">level</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">end</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span> <span class="n">level</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="n">n</span> <span class="o">+=</span> <span class="n">delta</span>

            <span class="c"># g.trace(n)</span>
            <span class="k">return</span> <span class="n">n</span>
        <span class="c">#@+node:ekr.20100216141722.5634: *7* getFileLines (leoEditCommands)</span></div>
<div class="viewcode-block" id="Commands.goToLineNumber.getFileLines"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.goToLineNumber.getFileLines">[docs]</a>        <span class="k">def</span> <span class="nf">getFileLines</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">root</span><span class="p">,</span><span class="n">fileName</span><span class="p">):</span>

            <span class="sd">&#39;&#39;&#39;Read the file into lines.&#39;&#39;&#39;</span>

            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
            <span class="n">isAtEdit</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">isAtEditNode</span><span class="p">()</span>
            <span class="n">isAtNoSent</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">isAtNoSentFileNode</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">isAtNoSent</span> <span class="ow">or</span> <span class="n">isAtEdit</span><span class="p">:</span>
                <span class="c"># Write a virtual file containing sentinels.</span>
                <span class="n">at</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">atFileCommands</span>
                <span class="n">kind</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">isAtNoSent</span><span class="p">,</span><span class="s">&#39;@nosent&#39;</span><span class="p">,</span><span class="s">&#39;@edit&#39;</span><span class="p">)</span>
                <span class="n">at</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span><span class="n">nosentinels</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">stringOutput</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># Calculate the full path.</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">scanAllAtPathDirectives</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">root</span><span class="p">)</span>
                <span class="c"># g.trace(&#39;path&#39;,path,&#39;fileName&#39;,fileName)</span>
                <span class="n">fileName</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>
                <span class="n">lines</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">openFile</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">lines</span>
        <span class="c">#@+node:ekr.20100216141722.5635: *7* openFile (gotoLineNumber)</span></div>
<div class="viewcode-block" id="Commands.goToLineNumber.openFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.goToLineNumber.openFile">[docs]</a>        <span class="k">def</span> <span class="nf">openFile</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Open a file and check if a shadow file exists.</span>
<span class="sd">            Construct a line mapping. This ivar is empty if no shadow file exists.</span>
<span class="sd">            Otherwise it contains a mapping, shadow file number -&gt; real file number.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">shadowController</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">shadow_filename</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shadowPathName</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">shadow_filename</span><span class="p">):</span>
                    <span class="n">fn</span> <span class="o">=</span> <span class="n">shadow_filename</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">shadow_filename</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">line_mapping</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">push_filter_mapping</span><span class="p">(</span>
                        <span class="n">lines</span><span class="p">,</span>
                        <span class="n">x</span><span class="o">.</span><span class="n">markerFromFileLines</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="n">shadow_filename</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># Just open the original file.  This is not an error!</span>
                    <span class="n">fn</span> <span class="o">=</span> <span class="n">filename</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">line_mapping</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c"># Make sure failures to open a file generate clear messages.</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;can not open&#39;</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
                <span class="c"># g.es_exception()</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">return</span> <span class="n">lines</span>
        <span class="c">#@+node:ekr.20100216141722.5636: *7* setup_file</span></div>
<div class="viewcode-block" id="Commands.goToLineNumber.setup_file"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.goToLineNumber.setup_file">[docs]</a>        <span class="k">def</span> <span class="nf">setup_file</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

            <span class="sd">&#39;&#39;&#39;Return (lines,n) where:</span>

<span class="sd">            lines are the lines to be scanned.</span>
<span class="sd">            n is the effective line number (munged for @shadow nodes).</span>
<span class="sd">            &#39;&#39;&#39;</span>

            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">shadowController</span>

            <span class="n">root</span><span class="p">,</span><span class="n">fileName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findRoot</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">root</span> <span class="ow">and</span> <span class="n">fileName</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">shadowController</span><span class="o">.</span><span class="n">line_mapping</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># Set by open.</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getFileLines</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>
                    <span class="c"># This will set x.line_mapping for @shadow files.</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">line_mapping</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">n</span><span class="p">:</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">line_mapping</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;no ancestor @&lt;file node&gt;: using script line numbers&quot;</span><span class="p">)</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">getScript</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">useSelectedText</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">fileName</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">root</span>
        <span class="c">#@+node:ekr.20100216141722.5637: *7* setup_script</span></div>
<div class="viewcode-block" id="Commands.goToLineNumber.setup_script"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.goToLineNumber.setup_script">[docs]</a>        <span class="k">def</span> <span class="nf">setup_script</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">scriptData</span><span class="p">):</span>

            <span class="c"># c = self.c</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">scriptData</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;p&#39;</span><span class="p">)</span>
            <span class="n">root</span><span class="p">,</span><span class="n">fileName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findRoot</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">scriptData</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;lines&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">fileName</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">root</span>
        <span class="c">#@+node:ekr.20100216141722.5638: *7* showResults</span></div>
<div class="viewcode-block" id="Commands.goToLineNumber.showResults"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.goToLineNumber.showResults">[docs]</a>        <span class="k">def</span> <span class="nf">showResults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">found</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">lines</span><span class="p">):</span>

            <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">w</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">bodyCtrl</span>

            <span class="c"># Select p and make it visible.</span>
            <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

            <span class="c"># Put the cursor on line n2 of the body text.</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getAllText</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
                <span class="n">ins</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">convertRowColToPythonIndex</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">n2</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;only&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span><span class="s">&#39;lines&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
                <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">getLine</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">ins</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;found: </span><span class="si">%5s</span><span class="s"> </span><span class="si">%2s</span><span class="s"> </span><span class="si">%2s</span><span class="s"> </span><span class="si">%15s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">found</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">])))</span>  

            <span class="n">w</span><span class="o">.</span><span class="n">setInsertPoint</span><span class="p">(</span><span class="n">ins</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">bodyWantsFocus</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">seeInsertPoint</span><span class="p">()</span>
        <span class="c">#@-others</span>
    <span class="c">#@+node:ekr.20031218072017.2884: *5* Edit Body submenu</span>
    <span class="c">#@+node:ekr.20031218072017.1827: *6* c.findMatchingBracket, helper and test</span></div></div>
<div class="viewcode-block" id="Commands.findMatchingBracket"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.findMatchingBracket">[docs]</a>    <span class="k">def</span> <span class="nf">findMatchingBracket</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Select the text between matching brackets.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">w</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">bodyCtrl</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">batchMode</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">notValidInBatchMode</span><span class="p">(</span><span class="s">&quot;Match Brackets&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">brackets</span> <span class="o">=</span> <span class="s">&quot;()[]{}&lt;&gt;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getAllText</span><span class="p">()</span>
        <span class="n">ins</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getInsertPoint</span><span class="p">()</span>
        <span class="n">ch1</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">ins</span><span class="o">-</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="n">ins</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
        <span class="n">ch2</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">ins</span>   <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="n">ins</span><span class="p">]</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
        <span class="c"># g.trace(repr(ch1),repr(ch2),ins)</span>

        <span class="c"># Prefer to match the character to the left of the cursor.</span>
        <span class="k">if</span> <span class="n">ch1</span> <span class="ow">and</span> <span class="n">ch1</span> <span class="ow">in</span> <span class="n">brackets</span><span class="p">:</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="n">ch1</span> <span class="p">;</span> <span class="n">index</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ins</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ch2</span> <span class="ow">and</span> <span class="n">ch2</span> <span class="ow">in</span> <span class="n">brackets</span><span class="p">:</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="n">ch2</span> <span class="p">;</span> <span class="n">index</span> <span class="o">=</span> <span class="n">ins</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">index2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findMatchingBracketHelper</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">ch</span><span class="p">,</span><span class="n">index</span><span class="p">)</span>
        <span class="c"># g.trace(&#39;index,index2&#39;,index,index2)</span>
        <span class="k">if</span> <span class="n">index2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">index2</span> <span class="o">&lt;</span> <span class="n">index</span><span class="p">:</span>
                <span class="n">w</span><span class="o">.</span><span class="n">setSelectionRange</span><span class="p">(</span><span class="n">index2</span><span class="p">,</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">insert</span><span class="o">=</span><span class="n">index2</span><span class="p">)</span> <span class="c"># was insert=index2+1</span>
                <span class="c"># g.trace(&#39;case 1&#39;,s[index2:index+1])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">w</span><span class="o">.</span><span class="n">setSelectionRange</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">index2</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">insert</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span><span class="n">index2</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                <span class="c"># g.trace(&#39;case2&#39;,s[index:index2+1])</span>
            <span class="n">w</span><span class="o">.</span><span class="n">see</span><span class="p">(</span><span class="n">index2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;unmatched&quot;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">ch</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20061113221414: *7* findMatchingBracketHelper</span>
    <span class="c"># To do: replace comments with blanks before scanning.</span>
    <span class="c"># Test  unmatched())</span></div>
<div class="viewcode-block" id="Commands.findMatchingBracketHelper"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.findMatchingBracketHelper">[docs]</a>    <span class="k">def</span> <span class="nf">findMatchingBracketHelper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">ch</span><span class="p">,</span><span class="n">index</span><span class="p">):</span>

        <span class="c"># c = self</span>
        <span class="n">open_brackets</span>  <span class="o">=</span> <span class="s">&quot;([{&lt;&quot;</span> <span class="p">;</span> <span class="n">close_brackets</span> <span class="o">=</span> <span class="s">&quot;)]}&gt;&quot;</span>
        <span class="n">brackets</span> <span class="o">=</span> <span class="n">open_brackets</span> <span class="o">+</span> <span class="n">close_brackets</span>
        <span class="n">matching_brackets</span> <span class="o">=</span> <span class="n">close_brackets</span> <span class="o">+</span> <span class="n">open_brackets</span>
        <span class="n">forward</span> <span class="o">=</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">open_brackets</span>
        <span class="c"># Find the character matching the initial bracket.</span>
        <span class="c"># g.trace(&#39;index&#39;,index,&#39;ch&#39;,repr(ch),&#39;brackets&#39;,brackets)</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">brackets</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="n">brackets</span><span class="p">[</span><span class="n">n</span><span class="p">]:</span>
                <span class="n">match_ch</span> <span class="o">=</span> <span class="n">matching_brackets</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="c"># g.trace(&#39;index&#39;,index,&#39;ch&#39;,repr(ch),&#39;match_ch&#39;,repr(match_ch))</span>
        <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">forward</span> <span class="ow">and</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="c"># g.trace(&quot;not found&quot;)</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="n">ch2</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
            <span class="c"># g.trace(&#39;forward&#39;,forward,&#39;ch2&#39;,repr(ch2),&#39;index&#39;,index)</span>
            <span class="k">if</span> <span class="n">ch2</span> <span class="o">==</span> <span class="n">ch</span><span class="p">:</span>
                <span class="n">level</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">ch2</span> <span class="o">==</span> <span class="n">match_ch</span><span class="p">:</span>
                <span class="n">level</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">level</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">index</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">forward</span> <span class="ow">and</span> <span class="n">index</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c"># g.trace(&quot;not found&quot;)</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">forward</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span> <span class="c"># unreachable: keeps pychecker happy.</span>
    <span class="c"># Test  (</span>
    <span class="c"># ([(x){y}]))</span>
    <span class="c"># Test  ((x)(unmatched</span>
    <span class="c">#@+node:ekr.20031218072017.1704: *6* convertAllBlanks</span></div>
<div class="viewcode-block" id="Commands.convertAllBlanks"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.convertAllBlanks">[docs]</a>    <span class="k">def</span> <span class="nf">convertAllBlanks</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Convert all blanks to tabs in the selected outline.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">u</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">undoer</span> <span class="p">;</span> <span class="n">undoType</span> <span class="o">=</span> <span class="s">&#39;Convert All Blanks&#39;</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">batchMode</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">notValidInBatchMode</span><span class="p">(</span><span class="n">undoType</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">d</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">scanAllDirectives</span><span class="p">()</span>
        <span class="n">tabWidth</span>  <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;tabwidth&quot;</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">u</span><span class="o">.</span><span class="n">beforeChangeGroup</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="n">undoType</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">current</span><span class="o">.</span><span class="n">self_and_subtree</span><span class="p">():</span>
            <span class="c"># g.trace(p.h,tabWidth)</span>
            <span class="n">innerUndoData</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">beforeChangeNodeContents</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="n">current</span><span class="p">:</span>
                <span class="n">changed</span><span class="p">,</span><span class="n">dirtyVnodeList2</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">convertBlanks</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">changed</span><span class="p">:</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">dirtyVnodeList</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">dirtyVnodeList2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span> <span class="p">;</span> <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">b</span>
                <span class="c"># assert(g.isUnicode(text))</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                    <span class="n">i</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_leading_ws_with_indent</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">tabWidth</span><span class="p">)</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">computeLeadingWhitespace</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="nb">abs</span><span class="p">(</span><span class="n">tabWidth</span><span class="p">))</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span> <span class="c"># use positive width.</span>
                    <span class="k">if</span> <span class="n">s</span> <span class="o">!=</span> <span class="n">line</span><span class="p">:</span> <span class="n">changed</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">changed</span><span class="p">:</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">dirtyVnodeList2</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span>
                    <span class="n">dirtyVnodeList</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">dirtyVnodeList2</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">setBodyString</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                    <span class="n">u</span><span class="o">.</span><span class="n">afterChangeNodeContents</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">undoType</span><span class="p">,</span><span class="n">innerUndoData</span><span class="p">)</span>
        <span class="n">u</span><span class="o">.</span><span class="n">afterChangeGroup</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="n">undoType</span><span class="p">,</span><span class="n">dirtyVnodeList</span><span class="o">=</span><span class="n">dirtyVnodeList</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;blanks converted to tabs in&quot;</span><span class="p">,</span><span class="n">count</span><span class="p">,</span><span class="s">&quot;nodes&quot;</span><span class="p">)</span>
                <span class="c"># Must come before c.redraw().</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">redraw_after_icons_changed</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.1705: *6* convertAllTabs</span></div>
<div class="viewcode-block" id="Commands.convertAllTabs"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.convertAllTabs">[docs]</a>    <span class="k">def</span> <span class="nf">convertAllTabs</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Convert all tabs to blanks in the selected outline.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">u</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">undoer</span> <span class="p">;</span> <span class="n">undoType</span> <span class="o">=</span> <span class="s">&#39;Convert All Tabs&#39;</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">batchMode</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">notValidInBatchMode</span><span class="p">(</span><span class="n">undoType</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">theDict</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">scanAllDirectives</span><span class="p">()</span>
        <span class="n">tabWidth</span>  <span class="o">=</span> <span class="n">theDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;tabwidth&quot;</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">u</span><span class="o">.</span><span class="n">beforeChangeGroup</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="n">undoType</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">current</span><span class="o">.</span><span class="n">self_and_subtree</span><span class="p">():</span>
            <span class="n">undoData</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">beforeChangeNodeContents</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="n">current</span><span class="p">:</span>
                <span class="n">changed</span><span class="p">,</span><span class="n">dirtyVnodeList2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convertTabs</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">changed</span><span class="p">:</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">dirtyVnodeList</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">dirtyVnodeList2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">;</span> <span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">b</span>
                <span class="c"># assert(g.isUnicode(text))</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                    <span class="n">i</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_leading_ws_with_indent</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">tabWidth</span><span class="p">)</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">computeLeadingWhitespace</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">tabWidth</span><span class="p">))</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span> <span class="c"># use negative width.</span>
                    <span class="k">if</span> <span class="n">s</span> <span class="o">!=</span> <span class="n">line</span><span class="p">:</span> <span class="n">changed</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">changed</span><span class="p">:</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">dirtyVnodeList2</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span>
                    <span class="n">dirtyVnodeList</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">dirtyVnodeList2</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">setBodyString</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                    <span class="n">u</span><span class="o">.</span><span class="n">afterChangeNodeContents</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">undoType</span><span class="p">,</span><span class="n">undoData</span><span class="p">)</span>
        <span class="n">u</span><span class="o">.</span><span class="n">afterChangeGroup</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="n">undoType</span><span class="p">,</span><span class="n">dirtyVnodeList</span><span class="o">=</span><span class="n">dirtyVnodeList</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;tabs converted to blanks in&quot;</span><span class="p">,</span><span class="n">count</span><span class="p">,</span><span class="s">&quot;nodes&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">redraw_after_icons_changed</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.1821: *6* convertBlanks</span></div>
<div class="viewcode-block" id="Commands.convertBlanks"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.convertBlanks">[docs]</a>    <span class="k">def</span> <span class="nf">convertBlanks</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Convert all blanks to tabs in the selected node.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span> <span class="p">;</span> <span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">head</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span><span class="n">tail</span><span class="p">,</span><span class="n">oldSel</span><span class="p">,</span><span class="n">oldYview</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">getBodyLines</span><span class="p">(</span><span class="n">expandSelection</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c"># Use the relative @tabwidth, not the global one.</span>
        <span class="n">theDict</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">scanAllDirectives</span><span class="p">()</span>
        <span class="n">tabWidth</span>  <span class="o">=</span> <span class="n">theDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;tabwidth&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tabWidth</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">optimizeLeadingWhitespace</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="nb">abs</span><span class="p">(</span><span class="n">tabWidth</span><span class="p">))</span> <span class="c"># Use positive width.</span>
                <span class="k">if</span> <span class="n">s</span> <span class="o">!=</span> <span class="n">line</span><span class="p">:</span> <span class="n">changed</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">changed</span><span class="p">:</span>
                <span class="n">undoType</span> <span class="o">=</span> <span class="s">&#39;Convert Blanks&#39;</span>
                <span class="n">result</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="n">oldSel</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">updateBodyPane</span><span class="p">(</span><span class="n">head</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">tail</span><span class="p">,</span><span class="n">undoType</span><span class="p">,</span><span class="n">oldSel</span><span class="p">,</span><span class="n">oldYview</span><span class="p">)</span> <span class="c"># Handles undo</span>

        <span class="k">return</span> <span class="n">changed</span><span class="p">,</span><span class="n">dirtyVnodeList</span>
    <span class="c">#@+node:ekr.20031218072017.1822: *6* convertTabs</span></div>
<div class="viewcode-block" id="Commands.convertTabs"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.convertTabs">[docs]</a>    <span class="k">def</span> <span class="nf">convertTabs</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Convert all tabs to blanks in the selected node.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span> <span class="p">;</span> <span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">head</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span><span class="n">tail</span><span class="p">,</span><span class="n">oldSel</span><span class="p">,</span><span class="n">oldYview</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBodyLines</span><span class="p">(</span><span class="n">expandSelection</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c"># Use the relative @tabwidth, not the global one.</span>
        <span class="n">theDict</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">scanAllDirectives</span><span class="p">()</span>
        <span class="n">tabWidth</span>  <span class="o">=</span> <span class="n">theDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;tabwidth&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tabWidth</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">i</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_leading_ws_with_indent</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">tabWidth</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">computeLeadingWhitespace</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">tabWidth</span><span class="p">))</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span> <span class="c"># use negative width.</span>
                <span class="k">if</span> <span class="n">s</span> <span class="o">!=</span> <span class="n">line</span><span class="p">:</span> <span class="n">changed</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">changed</span><span class="p">:</span>
                <span class="n">undoType</span> <span class="o">=</span> <span class="s">&#39;Convert Tabs&#39;</span>
                <span class="n">result</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="n">oldSel</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">updateBodyPane</span><span class="p">(</span><span class="n">head</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">tail</span><span class="p">,</span><span class="n">undoType</span><span class="p">,</span><span class="n">oldSel</span><span class="p">,</span><span class="n">oldYview</span><span class="p">)</span> <span class="c"># Handles undo</span>

        <span class="k">return</span> <span class="n">changed</span><span class="p">,</span><span class="n">dirtyVnodeList</span>
    <span class="c">#@+node:ekr.20031218072017.1823: *6* createLastChildNode</span></div>
<div class="viewcode-block" id="Commands.createLastChildNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.createLastChildNode">[docs]</a>    <span class="k">def</span> <span class="nf">createLastChildNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent</span><span class="p">,</span><span class="n">headline</span><span class="p">,</span><span class="n">body</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;A helper function for the three extract commands.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">body</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">body</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">body</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">body</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">insertAsLastChild</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">initHeadString</span><span class="p">(</span><span class="n">headline</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">setBodyString</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">validateOutline</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">p</span>
    <span class="c">#@+node:ekr.20031218072017.1824: *6* dedentBody</span></div>
<div class="viewcode-block" id="Commands.dedentBody"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.dedentBody">[docs]</a>    <span class="k">def</span> <span class="nf">dedentBody</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Remove one tab&#39;s worth of indentation from all presently selected lines.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">current</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span> <span class="p">;</span> <span class="n">undoType</span><span class="o">=</span><span class="s">&#39;Unindent&#39;</span>

        <span class="n">d</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">scanAllDirectives</span><span class="p">(</span><span class="n">current</span><span class="p">)</span> <span class="c"># Support @tab_width directive properly.</span>
        <span class="n">tab_width</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;tabwidth&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">tab_width</span><span class="p">)</span>
        <span class="n">head</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span><span class="n">tail</span><span class="p">,</span><span class="n">oldSel</span><span class="p">,</span><span class="n">oldYview</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBodyLines</span><span class="p">()</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">;</span> <span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_leading_ws_with_indent</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">tab_width</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">computeLeadingWhitespace</span><span class="p">(</span><span class="n">width</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">tab_width</span><span class="p">),</span><span class="n">tab_width</span><span class="p">)</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>
            <span class="k">if</span> <span class="n">s</span> <span class="o">!=</span> <span class="n">line</span><span class="p">:</span> <span class="n">changed</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">changed</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">updateBodyPane</span><span class="p">(</span><span class="n">head</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">tail</span><span class="p">,</span><span class="n">undoType</span><span class="p">,</span><span class="n">oldSel</span><span class="p">,</span><span class="n">oldYview</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20110530124245.18238: *6* c.extract...</span>
    <span class="c">#@+node:ekr.20110530124245.18239: *7* extract &amp; helpers</span></div>
<div class="viewcode-block" id="Commands.extract"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.extract">[docs]</a>    <span class="k">def</span> <span class="nf">extract</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Create child node from the selected body text.</span>

<span class="sd">        1. If the selection starts with a section reference, the section name become</span>
<span class="sd">           the child&#39;s headline. All following lines become the child&#39;s body text.</span>
<span class="sd">           The section reference line remains in the original body text.</span>

<span class="sd">        2. If the selection looks like a Python class or definition line, the</span>
<span class="sd">           class/function/method name becmes child&#39;s headline and all selected lines</span>
<span class="sd">           become the child&#39;s body text.</span>

<span class="sd">        3. Otherwise, the first line becomes the child&#39;s headline, and all selected</span>
<span class="sd">           lines become the child&#39;s body text.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">c</span><span class="p">,</span><span class="n">current</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">undoType</span> <span class="o">=</span> <span class="bp">self</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">undoer</span><span class="p">,</span><span class="s">&#39;Extract&#39;</span>
        <span class="n">head</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span><span class="n">tail</span><span class="p">,</span><span class="n">oldSel</span><span class="p">,</span><span class="n">oldYview</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBodyLines</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">:</span> <span class="k">return</span> <span class="c"># Nothing selected.</span>

        <span class="c"># Remove leading whitespace.</span>
        <span class="n">junk</span><span class="p">,</span> <span class="n">ws</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_leading_ws_with_indent</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">tab_width</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">removeLeadingWhitespace</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">ws</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">tab_width</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>

        <span class="n">h</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">ref_h</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">extractRef</span><span class="p">(</span><span class="n">h</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">def_h</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">extractDef</span><span class="p">(</span><span class="n">h</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ref_h</span><span class="p">:</span>
            <span class="c"># h,b,middle = ref_h,lines[1:],lines[0]</span>
            <span class="c"># 2012/02/27: Change suggested by vitalije (vitalijem@gmail.com)</span>
            <span class="n">h</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">middle</span> <span class="o">=</span> <span class="n">ref_h</span><span class="p">,</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="s">&#39; &#39;</span><span class="o">*</span><span class="n">ws</span> <span class="o">+</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">def_h</span><span class="p">:</span>
            <span class="n">h</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">middle</span> <span class="o">=</span> <span class="n">def_h</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span><span class="s">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">h</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">middle</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span><span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="s">&#39;&#39;</span>

        <span class="n">u</span><span class="o">.</span><span class="n">beforeChangeGroup</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="n">undoType</span><span class="p">)</span>

        <span class="n">undoData</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">beforeInsertNode</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">createLastChildNode</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
        <span class="n">u</span><span class="o">.</span><span class="n">afterInsertNode</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">undoType</span><span class="p">,</span><span class="n">undoData</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">updateBodyPane</span><span class="p">(</span><span class="n">head</span><span class="p">,</span><span class="n">middle</span><span class="p">,</span><span class="n">tail</span><span class="p">,</span>
            <span class="n">undoType</span><span class="o">=</span><span class="n">undoType</span><span class="p">,</span><span class="n">oldSel</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">oldYview</span><span class="o">=</span><span class="n">oldYview</span><span class="p">)</span>

        <span class="n">u</span><span class="o">.</span><span class="n">afterChangeGroup</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="n">undoType</span><span class="o">=</span><span class="n">undoType</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span><span class="o">.</span><span class="n">expand</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">parent</span><span class="p">())</span> <span class="c"># A bit more convenient than p.</span>
        <span class="n">c</span><span class="o">.</span><span class="n">bodyWantsFocus</span><span class="p">()</span>

    <span class="c"># Compatibility</span></div>
    <span class="n">extractSection</span> <span class="o">=</span> <span class="n">extract</span>
    <span class="n">extractPythonMethod</span> <span class="o">=</span> <span class="n">extract</span>
    <span class="c">#@+node:ekr.20110530124245.18241: *8* extractDef</span>
<div class="viewcode-block" id="Commands.extractDef"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.extractDef">[docs]</a>    <span class="k">def</span> <span class="nf">extractDef</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the defined function/method name if</span>
<span class="sd">        s looks like Python def or class line.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;def&#39;</span><span class="p">,</span><span class="s">&#39;class&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">tag</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">tag</span><span class="p">))</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_id</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">chars</span><span class="o">=</span><span class="s">&#39;_&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;class&#39;</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">name</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">k</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="s">&#39;(&#39;</span><span class="p">):</span>
                            <span class="k">return</span> <span class="n">name</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span>
    <span class="c">#@+node:ekr.20110530124245.18242: *8* extractRef</span></div>
<div class="viewcode-block" id="Commands.extractRef"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.extractRef">[docs]</a>    <span class="k">def</span> <span class="nf">extractRef</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return s if it starts with a section name.&#39;&#39;&#39;</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;&lt;&lt;&#39;</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;&gt;&gt;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">j</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;@&lt;&#39;</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;@&gt;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">j</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span>

        <span class="k">return</span> <span class="s">&#39;&#39;</span>
    <span class="c">#@+node:ekr.20031218072017.1710: *7* extractSectionNames</span></div>
<div class="viewcode-block" id="Commands.extractSectionNames"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.extractSectionNames">[docs]</a>    <span class="k">def</span> <span class="nf">extractSectionNames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Create child nodes for every section reference in the selected text.</span>
<span class="sd">        The headline of each new child node is the section reference.</span>
<span class="sd">        The body of each child node is empty.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">u</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">undoer</span> <span class="p">;</span> <span class="n">undoType</span> <span class="o">=</span> <span class="s">&#39;Extract Section Names&#39;</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span> <span class="p">;</span> <span class="n">current</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="n">head</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span><span class="n">tail</span><span class="p">,</span><span class="n">oldSel</span><span class="p">,</span><span class="n">oldYview</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBodyLines</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;No lines selected&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">u</span><span class="o">.</span><span class="n">beforeChangeGroup</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="n">undoType</span><span class="p">)</span>
        <span class="n">found</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">findSectionName</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
                <span class="n">undoData</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">beforeInsertNode</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createLastChildNode</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
                <span class="n">u</span><span class="o">.</span><span class="n">afterInsertNode</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">undoType</span><span class="p">,</span><span class="n">undoData</span><span class="p">)</span>
                <span class="n">found</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">c</span><span class="o">.</span><span class="n">validateOutline</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
            <span class="n">u</span><span class="o">.</span><span class="n">afterChangeGroup</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="n">undoType</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;selected text should contain section names&quot;</span><span class="p">)</span>

        <span class="c"># Restore the selection.</span>
        <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">oldSel</span>
        <span class="n">body</span><span class="o">.</span><span class="n">setSelectionRange</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
        <span class="n">body</span><span class="o">.</span><span class="n">setFocus</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.1711: *8* findSectionName</span></div>
<div class="viewcode-block" id="Commands.findSectionName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.findSectionName">[docs]</a>    <span class="k">def</span> <span class="nf">findSectionName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="n">head1</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;&lt;&lt;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">head1</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">head2</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;&gt;&gt;&quot;</span><span class="p">,</span><span class="n">head1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">head1</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;@&lt;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">head1</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">head2</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;@&gt;&quot;</span><span class="p">,</span><span class="n">head1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">head1</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">head2</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">head1</span> <span class="o">&gt;</span> <span class="n">head2</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">head1</span><span class="p">:</span><span class="n">head2</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">name</span>
    <span class="c">#@+node:ekr.20031218072017.1829: *6* c.getBodyLines</span></div>
<div class="viewcode-block" id="Commands.getBodyLines"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.getBodyLines">[docs]</a>    <span class="k">def</span> <span class="nf">getBodyLines</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">expandSelection</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Return head,lines,tail where:</span>

<span class="sd">        before is string containg all the lines before the selected text</span>
<span class="sd">        (or the text before the insert point if no selection)</span>
<span class="sd">        lines is a list of lines containing the selected text (or the line containing the insert point if no selection)</span>
<span class="sd">        after is a string all lines after the selected text</span>
<span class="sd">        (or the text after the insert point if no selection)&quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">body</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span> <span class="p">;</span> <span class="n">w</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">bodyCtrl</span>
        <span class="n">oldVview</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">getYScrollPosition</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">expandSelection</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getAllText</span><span class="p">()</span>
            <span class="n">head</span> <span class="o">=</span> <span class="n">tail</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="n">oldSel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="c"># Retain the newlines of each line.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Note: lines is the entire line containing the insert point if no selection.</span>
            <span class="n">head</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">tail</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">getSelectionLines</span><span class="p">()</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="c"># Retain the newlines of each line.</span>

            <span class="c"># Expand the selection.</span>
            <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">head</span><span class="p">)</span>
            <span class="n">j</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">head</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">oldSel</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span>

        <span class="k">return</span> <span class="n">head</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span><span class="n">tail</span><span class="p">,</span><span class="n">oldSel</span><span class="p">,</span><span class="n">oldVview</span> <span class="c"># string,list,string,tuple.</span>
    <span class="c">#@+node:ekr.20031218072017.1830: *6* indentBody (indent-region)</span></div>
<div class="viewcode-block" id="Commands.indentBody"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.indentBody">[docs]</a>    <span class="k">def</span> <span class="nf">indentBody</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;The indent-region command indents each line of the selected body text,</span>
<span class="sd">        or each line of a node if there is no selected text. The @tabwidth directive</span>
<span class="sd">        in effect determines amount of indentation. (not yet) A numeric argument</span>
<span class="sd">        specifies the column to indent to.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">current</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span> <span class="p">;</span> <span class="n">undoType</span><span class="o">=</span><span class="s">&#39;Indent Region&#39;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">scanAllDirectives</span><span class="p">(</span><span class="n">current</span><span class="p">)</span> <span class="c"># Support @tab_width directive properly.</span>
        <span class="n">tab_width</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;tabwidth&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">tab_width</span><span class="p">)</span>
        <span class="n">head</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span><span class="n">tail</span><span class="p">,</span><span class="n">oldSel</span><span class="p">,</span><span class="n">oldYview</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBodyLines</span><span class="p">()</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">;</span> <span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_leading_ws_with_indent</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">tab_width</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">computeLeadingWhitespace</span><span class="p">(</span><span class="n">width</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">tab_width</span><span class="p">),</span><span class="n">tab_width</span><span class="p">)</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>
            <span class="k">if</span> <span class="n">s</span> <span class="o">!=</span> <span class="n">line</span><span class="p">:</span> <span class="n">changed</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">changed</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">updateBodyPane</span><span class="p">(</span><span class="n">head</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">tail</span><span class="p">,</span><span class="n">undoType</span><span class="p">,</span><span class="n">oldSel</span><span class="p">,</span><span class="n">oldYview</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050312114529: *6* c.insert/removeComments</span>
    <span class="c">#@+node:ekr.20050312114529.1: *7* addComments</span></div>
<div class="viewcode-block" id="Commands.addComments"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.addComments">[docs]</a>    <span class="k">def</span> <span class="nf">addComments</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="c">#@+&lt;&lt; addComments docstring &gt;&gt;</span>
        <span class="c">#@+node:ekr.20111115111842.9789: *8* &lt;&lt; addComments docstring &gt;&gt;</span>
        <span class="c">#@@pagewidth 50</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Converts all selected lines to comment lines using</span>
<span class="sd">        the comment delimiters given by the applicable @language directive.</span>

<span class="sd">        Inserts single-line comments if possible; inserts</span>
<span class="sd">        block comments for languages like html that lack</span>
<span class="sd">        single-line comments.</span>

<span class="sd">        @bool indent_added_comments</span>

<span class="sd">        If True (the default), inserts opening comment</span>
<span class="sd">        delimiters just before the first non-whitespace</span>
<span class="sd">        character of each line. Otherwise, inserts opening</span>
<span class="sd">        comment delimiters at the start of each line.</span>

<span class="sd">        *See also*: delete-comments.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c">#@-&lt;&lt; addComments docstring &gt;&gt;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">scanAllDirectives</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">scanToCursor</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">d1</span><span class="p">,</span><span class="n">d2</span><span class="p">,</span><span class="n">d3</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;delims&#39;</span><span class="p">)</span> <span class="c"># d1 is the line delim.</span>
        <span class="n">head</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span><span class="n">tail</span><span class="p">,</span><span class="n">oldSel</span><span class="p">,</span><span class="n">oldYview</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBodyLines</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;no text selected&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">d2</span> <span class="o">=</span> <span class="n">d2</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span> <span class="p">;</span> <span class="n">d3</span> <span class="o">=</span> <span class="n">d3</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">d1</span><span class="p">:</span> <span class="n">openDelim</span><span class="p">,</span><span class="n">closeDelim</span> <span class="o">=</span> <span class="n">d1</span><span class="o">+</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>  <span class="n">openDelim</span><span class="p">,</span><span class="n">closeDelim</span> <span class="o">=</span> <span class="n">d2</span><span class="o">+</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39; &#39;</span><span class="o">+</span><span class="n">d3</span>

        <span class="c"># Comment out non-blank lines.</span>
        <span class="n">indent</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getBool</span><span class="p">(</span><span class="s">&#39;indent_added_comments&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">indent</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">openDelim</span><span class="o">+</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">+</span><span class="n">closeDelim</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">openDelim</span><span class="o">+</span><span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">+</span><span class="n">closeDelim</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">updateBodyPane</span><span class="p">(</span><span class="n">head</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">tail</span><span class="p">,</span><span class="n">undoType</span><span class="o">=</span><span class="s">&#39;Add Comments&#39;</span><span class="p">,</span><span class="n">oldSel</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">oldYview</span><span class="o">=</span><span class="n">oldYview</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050312114529.2: *7* deleteComments</span></div>
<div class="viewcode-block" id="Commands.deleteComments"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.deleteComments">[docs]</a>    <span class="k">def</span> <span class="nf">deleteComments</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="c">#@+&lt;&lt; deleteComments docstring &gt;&gt;</span>
        <span class="c">#@+node:ekr.20111115111842.9790: *8* &lt;&lt; deleteComments docstring &gt;&gt;</span>
        <span class="c">#@@pagewidth 50</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Removes one level of comment delimiters from all</span>
<span class="sd">        selected lines.  The applicable @language directive</span>
<span class="sd">        determines the comment delimiters to be removed.</span>

<span class="sd">        Removes single-line comments if possible; removes</span>
<span class="sd">        block comments for languages like html that lack</span>
<span class="sd">        single-line comments.</span>

<span class="sd">        *See also*: add-comments.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c">#@-&lt;&lt; deleteComments docstring &gt;&gt;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">scanAllDirectives</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">scanToCursor</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c"># d1 is the line delim.</span>
        <span class="n">d1</span><span class="p">,</span><span class="n">d2</span><span class="p">,</span><span class="n">d3</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;delims&#39;</span><span class="p">)</span>

        <span class="n">head</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span><span class="n">tail</span><span class="p">,</span><span class="n">oldSel</span><span class="p">,</span><span class="n">oldYview</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBodyLines</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;no text selected&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">d1</span><span class="p">:</span>
            <span class="c"># Remove the single-line comment delim in front of each line</span>
            <span class="n">d1b</span> <span class="o">=</span> <span class="n">d1</span> <span class="o">+</span> <span class="s">&#39; &#39;</span>
            <span class="n">n1</span><span class="p">,</span><span class="n">n1b</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">d1</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">d1b</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">d1b</span><span class="p">):</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">n1b</span><span class="p">:])</span>
                <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">d1</span><span class="p">):</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">n1</span><span class="p">:])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Remove the block comment delimiters from each line.</span>
            <span class="n">n2</span><span class="p">,</span><span class="n">n3</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">d2</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">d3</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">d3</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="n">n2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">d2</span><span class="p">)</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">first</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">n2</span>
                    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">first</span><span class="p">,</span><span class="s">&#39; &#39;</span><span class="p">):</span> <span class="n">first</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">last</span> <span class="o">=</span> <span class="n">j</span>
                    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">last</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39; &#39;</span><span class="p">):</span> <span class="n">last</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">first</span><span class="p">:</span><span class="n">last</span><span class="p">]</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="n">n3</span><span class="p">:])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">updateBodyPane</span><span class="p">(</span><span class="n">head</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">tail</span><span class="p">,</span><span class="n">undoType</span><span class="o">=</span><span class="s">&#39;Delete Comments&#39;</span><span class="p">,</span><span class="n">oldSel</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">oldYview</span><span class="o">=</span><span class="n">oldYview</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.1831: *6* insertBodyTime, helpers and tests</span></div>
<div class="viewcode-block" id="Commands.insertBodyTime"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.insertBodyTime">[docs]</a>    <span class="k">def</span> <span class="nf">insertBodyTime</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Insert a time/date stamp at the cursor.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">undoType</span> <span class="o">=</span> <span class="s">&#39;Insert Body Time&#39;</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">bodyCtrl</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">batchMode</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">notValidInBatchMode</span><span class="p">(</span><span class="n">undoType</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">oldSel</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">getSelectionRange</span><span class="p">()</span>
        <span class="n">w</span><span class="o">.</span><span class="n">deleteTextSelection</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTime</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getInsertPoint</span><span class="p">()</span>
        <span class="n">w</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">onBodyChanged</span><span class="p">(</span><span class="n">undoType</span><span class="p">,</span><span class="n">oldSel</span><span class="o">=</span><span class="n">oldSel</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.1832: *7* getTime</span></div>
<div class="viewcode-block" id="Commands.getTime"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.getTime">[docs]</a>    <span class="k">def</span> <span class="nf">getTime</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">body</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">default_format</span> <span class="o">=</span>  <span class="s">&quot;%m/</span><span class="si">%d</span><span class="s">/%Y %H:%M:%S&quot;</span> <span class="c"># E.g., 1/30/2003 8:31:55</span>

        <span class="c"># Try to get the format string from leoConfig.txt.</span>
        <span class="k">if</span> <span class="n">body</span><span class="p">:</span>
            <span class="n">format</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getString</span><span class="p">(</span><span class="s">&quot;body_time_format_string&quot;</span><span class="p">)</span>
            <span class="n">gmt</span>    <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getBool</span><span class="p">(</span><span class="s">&quot;body_gmt_time&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">format</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getString</span><span class="p">(</span><span class="s">&quot;headline_time_format_string&quot;</span><span class="p">)</span>
            <span class="n">gmt</span>    <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getBool</span><span class="p">(</span><span class="s">&quot;headline_gmt_time&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">format</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">format</span> <span class="o">=</span> <span class="n">default_format</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c"># import time</span>
            <span class="k">if</span> <span class="n">gmt</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">format</span><span class="p">,</span><span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">format</span><span class="p">,</span><span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">())</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">NameError</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;time.strftime not available on this platform&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s">&quot;&quot;</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span> <span class="c"># Probably a bad format string in leoSettings.leo.</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">default_format</span><span class="p">,</span><span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">s</span>
    <span class="c">#@+node:ekr.20101118113953.5839: *6* c.reformatParagraph &amp; helpers</span></div>
<div class="viewcode-block" id="Commands.reformatParagraph"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.reformatParagraph">[docs]</a>    <span class="k">def</span> <span class="nf">reformatParagraph</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">undoType</span><span class="o">=</span><span class="s">&#39;Reformat Paragraph&#39;</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Reformat a text paragraph</span>

<span class="sd">        Wraps the concatenated text to present page width setting. Leading tabs are</span>
<span class="sd">        sized to present tab width setting. First and second line of original text is</span>
<span class="sd">        used to determine leading whitespace in reformatted text. Hanging indentation</span>
<span class="sd">        is honored.</span>

<span class="sd">        Paragraph is bound by start of body, end of body and blank lines. Paragraph is</span>
<span class="sd">        selected by position of current insertion cursor.</span>

<span class="sd">    &quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">body</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span> <span class="p">;</span> <span class="n">w</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">bodyCtrl</span>

        <span class="c"># g.trace(c.page_width)</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">batchMode</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">notValidInBatchMode</span><span class="p">(</span><span class="s">&quot;xxx&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">body</span><span class="o">.</span><span class="n">hasSelection</span><span class="p">():</span>
            <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getSelectionRange</span><span class="p">()</span>
            <span class="n">w</span><span class="o">.</span><span class="n">setInsertPoint</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="n">oldSel</span><span class="p">,</span><span class="n">oldYview</span><span class="p">,</span><span class="n">original</span><span class="p">,</span><span class="n">pageWidth</span><span class="p">,</span><span class="n">tabWidth</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rp_get_args</span><span class="p">()</span>
        <span class="n">head</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span><span class="n">tail</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">findBoundParagraph</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">indents</span><span class="p">,</span><span class="n">leading_ws</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rp_get_leading_ws</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="n">tabWidth</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rp_wrap_all_lines</span><span class="p">(</span><span class="n">indents</span><span class="p">,</span><span class="n">leading_ws</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span><span class="n">pageWidth</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">rp_reformat</span><span class="p">(</span><span class="n">head</span><span class="p">,</span><span class="n">oldSel</span><span class="p">,</span><span class="n">oldYview</span><span class="p">,</span><span class="n">original</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">tail</span><span class="p">,</span><span class="n">undoType</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.1825: *7* c.findBoundParagraph</span></div>
<div class="viewcode-block" id="Commands.findBoundParagraph"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.findBoundParagraph">[docs]</a>    <span class="k">def</span> <span class="nf">findBoundParagraph</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">head</span><span class="p">,</span><span class="n">ins</span><span class="p">,</span><span class="n">tail</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">getInsertLines</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ins</span> <span class="ow">or</span> <span class="n">ins</span><span class="o">.</span><span class="n">isspace</span><span class="p">()</span> <span class="ow">or</span> <span class="n">ins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;@&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span>

        <span class="n">head_lines</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">head</span><span class="p">)</span>
        <span class="n">tail_lines</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">tail</span><span class="p">)</span>

        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c">#@+&lt;&lt; trace head_lines, ins, tail_lines &gt;&gt;</span>
            <span class="c">#@+node:ekr.20031218072017.1826: *8* &lt;&lt; trace head_lines, ins, tail_lines &gt;&gt;</span>
            <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">head_lines&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">head_lines</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">ins&quot;</span><span class="p">,</span> <span class="n">ins</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">tail_lines&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">tail_lines</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&quot;head_lines: &quot;</span><span class="p">,</span><span class="n">head_lines</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&quot;ins: &quot;</span><span class="p">,</span><span class="n">ins</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&quot;tail_lines: &quot;</span><span class="p">,</span><span class="n">tail_lines</span><span class="p">)</span>
            <span class="c">#@-&lt;&lt; trace head_lines, ins, tail_lines &gt;&gt;</span>

        <span class="c"># Scan backwards.</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">head_lines</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">head_lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">isspace</span><span class="p">()</span> <span class="ow">or</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;@&#39;</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span> <span class="p">;</span> <span class="k">break</span>

        <span class="n">pre_para_lines</span> <span class="o">=</span> <span class="n">head_lines</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
        <span class="n">para_head_lines</span> <span class="o">=</span> <span class="n">head_lines</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>

        <span class="c"># Scan forwards.</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">tail_lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">isspace</span><span class="p">()</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">para_tail_lines</span> <span class="o">=</span> <span class="n">tail_lines</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
        <span class="n">post_para_lines</span> <span class="o">=</span> <span class="n">tail_lines</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>

        <span class="n">head</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">joinLines</span><span class="p">(</span><span class="n">pre_para_lines</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">para_head_lines</span> 
        <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">ins</span><span class="p">])</span>
        <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">para_tail_lines</span><span class="p">)</span>
        <span class="n">tail</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">joinLines</span><span class="p">(</span><span class="n">post_para_lines</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">head</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">tail</span> <span class="c"># string, list, string</span>
    <span class="c">#@+node:ekr.20101118113953.5840: *7* rp_get_args</span></div>
<div class="viewcode-block" id="Commands.rp_get_args"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.rp_get_args">[docs]</a>    <span class="k">def</span> <span class="nf">rp_get_args</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Compute and return oldSel,oldYview,original,pageWidth,tabWidth.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">body</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span> <span class="p">;</span>  <span class="n">w</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">bodyCtrl</span>

        <span class="n">d</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">scanAllDirectives</span><span class="p">()</span>

        <span class="c"># g.trace(c.editCommands.fillColumn)</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">editCommands</span><span class="o">.</span><span class="n">fillColumn</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pageWidth</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">editCommands</span><span class="o">.</span><span class="n">fillColumn</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pageWidth</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;pagewidth&quot;</span><span class="p">)</span>

        <span class="n">tabWidth</span>  <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;tabwidth&quot;</span><span class="p">)</span>
        <span class="n">original</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getAllText</span><span class="p">()</span>
        <span class="n">oldSel</span> <span class="o">=</span>  <span class="n">w</span><span class="o">.</span><span class="n">getSelectionRange</span><span class="p">()</span>
        <span class="n">oldYview</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">getYScrollPosition</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">oldSel</span><span class="p">,</span><span class="n">oldYview</span><span class="p">,</span><span class="n">original</span><span class="p">,</span><span class="n">pageWidth</span><span class="p">,</span><span class="n">tabWidth</span>
    <span class="c">#@+node:ekr.20101118113953.5841: *7* rp_get_leading_ws</span></div>
<div class="viewcode-block" id="Commands.rp_get_leading_ws"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.rp_get_leading_ws">[docs]</a>    <span class="k">def</span> <span class="nf">rp_get_leading_ws</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span><span class="n">tabWidth</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Compute and return indents and leading_ws.&#39;&#39;&#39;</span>

        <span class="c"># c = self</span>
        <span class="n">indents</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">leading_ws</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                <span class="c"># Use the original, non-optimized leading whitespace.</span>
                <span class="n">leading_ws</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ws</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_leading_ws</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">indents</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">computeWidth</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span><span class="n">tabWidth</span><span class="p">)</span>

        <span class="n">indents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">indents</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">leading_ws</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">leading_ws</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">indents</span><span class="p">,</span><span class="n">leading_ws</span>
    <span class="c">#@+node:ekr.20101118113953.5842: *7* rp_reformat</span></div>
<div class="viewcode-block" id="Commands.rp_reformat"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.rp_reformat">[docs]</a>    <span class="k">def</span> <span class="nf">rp_reformat</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">head</span><span class="p">,</span><span class="n">oldSel</span><span class="p">,</span><span class="n">oldYview</span><span class="p">,</span><span class="n">original</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">tail</span><span class="p">,</span><span class="n">undoType</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Reformat the body and update the selection.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">body</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span> <span class="p">;</span> <span class="n">w</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">bodyCtrl</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getAllText</span><span class="p">()</span>

        <span class="c"># This destroys recoloring.</span>
        <span class="n">junk</span><span class="p">,</span> <span class="n">ins</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">setSelectionAreas</span><span class="p">(</span><span class="n">head</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">tail</span><span class="p">)</span>

        <span class="n">changed</span> <span class="o">=</span> <span class="n">original</span> <span class="o">!=</span> <span class="n">head</span> <span class="o">+</span> <span class="n">result</span> <span class="o">+</span> <span class="n">tail</span>
        <span class="k">if</span> <span class="n">changed</span><span class="p">:</span>
            <span class="c"># 2010/11/16: stay in the paragraph.</span>
            <span class="n">body</span><span class="o">.</span><span class="n">onBodyChanged</span><span class="p">(</span><span class="n">undoType</span><span class="p">,</span><span class="n">oldSel</span><span class="o">=</span><span class="n">oldSel</span><span class="p">,</span><span class="n">oldYview</span><span class="o">=</span><span class="n">oldYview</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Advance to the next paragraph.</span>
            <span class="n">ins</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c"># Move past the selection.</span>
            <span class="k">while</span> <span class="n">ins</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">getLine</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">ins</span><span class="p">)</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>
                <span class="c"># 2010/11/16: it&#39;s annoying, imo, to treat @ lines differently.</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
                    <span class="n">ins</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ins</span> <span class="o">=</span> <span class="n">i</span> <span class="p">;</span> <span class="k">break</span>

            <span class="c"># setSelectionAreas has destroyed the coloring.</span>
            <span class="n">c</span><span class="o">.</span><span class="n">recolor</span><span class="p">()</span>

        <span class="n">w</span><span class="o">.</span><span class="n">setSelectionRange</span><span class="p">(</span><span class="n">ins</span><span class="p">,</span><span class="n">ins</span><span class="p">,</span><span class="n">insert</span><span class="o">=</span><span class="n">ins</span><span class="p">)</span>

        <span class="c"># 2011/10/26: Calling see does more harm than good.</span>
            <span class="c"># w.see(ins)</span>
    <span class="c">#@+node:ekr.20101118113953.5843: *7* rp_wrap_all_lines</span></div>
<div class="viewcode-block" id="Commands.rp_wrap_all_lines"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.rp_wrap_all_lines">[docs]</a>    <span class="k">def</span> <span class="nf">rp_wrap_all_lines</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">indents</span><span class="p">,</span><span class="n">leading_ws</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span><span class="n">pageWidth</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;compute the result of wrapping all lines.&#39;&#39;&#39;</span>

        <span class="n">trailingNL</span> <span class="o">=</span> <span class="n">lines</span> <span class="ow">and</span> <span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">),</span><span class="n">z</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>

        <span class="c"># Wrap the lines, decreasing the page width by indent.</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">wrap_lines</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span>
            <span class="n">pageWidth</span><span class="o">-</span><span class="n">indents</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">pageWidth</span><span class="o">-</span><span class="n">indents</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c"># prefix with the leading whitespace, if any</span>
        <span class="n">paddedResult</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">paddedResult</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">leading_ws</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">paddedResult</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">leading_ws</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">line</span><span class="p">)</span>

        <span class="c"># Convert the result to a string.</span>
        <span class="n">result</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">paddedResult</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trailingNL</span><span class="p">:</span> <span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>

        <span class="k">return</span> <span class="n">result</span>
    <span class="c">#@+node:ekr.20031218072017.1838: *6* updateBodyPane (handles changeNodeContents)</span></div>
<div class="viewcode-block" id="Commands.updateBodyPane"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.updateBodyPane">[docs]</a>    <span class="k">def</span> <span class="nf">updateBodyPane</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">head</span><span class="p">,</span><span class="n">middle</span><span class="p">,</span><span class="n">tail</span><span class="p">,</span><span class="n">undoType</span><span class="p">,</span><span class="n">oldSel</span><span class="p">,</span><span class="n">oldYview</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">body</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="c"># Update the text and notify the event handler.</span>
        <span class="n">body</span><span class="o">.</span><span class="n">setSelectionAreas</span><span class="p">(</span><span class="n">head</span><span class="p">,</span><span class="n">middle</span><span class="p">,</span><span class="n">tail</span><span class="p">)</span>

        <span class="c"># Expand the selection.</span>
        <span class="n">head</span> <span class="o">=</span> <span class="n">head</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
        <span class="n">middle</span> <span class="o">=</span> <span class="n">middle</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
        <span class="n">tail</span> <span class="o">=</span> <span class="n">tail</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">head</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">head</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">middle</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">newSel</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span>
        <span class="n">body</span><span class="o">.</span><span class="n">setSelectionRange</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>

        <span class="c"># This handles the undo.</span>
        <span class="n">body</span><span class="o">.</span><span class="n">onBodyChanged</span><span class="p">(</span><span class="n">undoType</span><span class="p">,</span><span class="n">oldSel</span><span class="o">=</span><span class="n">oldSel</span> <span class="ow">or</span> <span class="n">newSel</span><span class="p">,</span><span class="n">oldYview</span><span class="o">=</span><span class="n">oldYview</span><span class="p">)</span>

        <span class="c"># Update the changed mark and icon.</span>
        <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isDirty</span><span class="p">():</span>
            <span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span>

        <span class="n">c</span><span class="o">.</span><span class="n">redraw_after_icons_changed</span><span class="p">()</span>

        <span class="c"># Scroll as necessary.</span>
        <span class="k">if</span> <span class="n">oldYview</span><span class="p">:</span>
            <span class="n">body</span><span class="o">.</span><span class="n">setYScrollPosition</span><span class="p">(</span><span class="n">oldYview</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">body</span><span class="o">.</span><span class="n">seeInsertPoint</span><span class="p">()</span>

        <span class="n">body</span><span class="o">.</span><span class="n">setFocus</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">recolor</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">dirtyVnodeList</span>
    <span class="c">#@+node:ekr.20031218072017.2885: *5* Edit Headline submenu</span>
    <span class="c">#@+node:ekr.20031218072017.2886: *6* c.editHeadline</span></div>
<div class="viewcode-block" id="Commands.editHeadline"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.editHeadline">[docs]</a>    <span class="k">def</span> <span class="nf">editHeadline</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Begin editing the headline of the selected node.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">k</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">k</span> <span class="p">;</span> <span class="n">tree</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">tree</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">batchMode</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">notValidInBatchMode</span><span class="p">(</span><span class="s">&quot;Edit Headline&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">e</span><span class="p">,</span><span class="n">wrapper</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">editLabel</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">k</span><span class="p">:</span>
            <span class="c"># k.setDefaultInputState()</span>
            <span class="n">k</span><span class="o">.</span><span class="n">setEditingState</span><span class="p">()</span>
            <span class="n">k</span><span class="o">.</span><span class="n">showStateAndMode</span><span class="p">(</span><span class="n">w</span><span class="o">=</span><span class="n">wrapper</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2290: *6* toggleAngleBrackets</span></div>
<div class="viewcode-block" id="Commands.toggleAngleBrackets"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.toggleAngleBrackets">[docs]</a>    <span class="k">def</span> <span class="nf">toggleAngleBrackets</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Add or remove double angle brackets from the headline of the selected node.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">batchMode</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">notValidInBatchMode</span><span class="p">(</span><span class="s">&quot;Toggle Angle Brackets&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;&lt;&lt;&quot;</span>
            <span class="ow">or</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="s">&quot;&gt;&gt;&quot;</span><span class="p">):</span> <span class="c"># Must be on separate line.</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;&lt;&lt;&quot;</span><span class="p">:</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span> <span class="o">==</span> <span class="s">&quot;&gt;&gt;&quot;</span><span class="p">:</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">angleBrackets</span><span class="p">(</span><span class="s">&#39; &#39;</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span> <span class="s">&#39; &#39;</span><span class="p">)</span>

        <span class="n">p</span><span class="o">.</span><span class="n">setHeadString</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">redrawAndEdit</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">selectAll</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2887: *5* Find submenu (frame methods)</span>
    <span class="c">#@+node:ekr.20051013084200: *6* dismissFindPanel</span></div>
<div class="viewcode-block" id="Commands.dismissFindPanel"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.dismissFindPanel">[docs]</a>    <span class="k">def</span> <span class="nf">dismissFindPanel</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">findPanel</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">findPanel</span><span class="o">.</span><span class="n">dismiss</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.2888: *6* showFindPanel</span></div>
<div class="viewcode-block" id="Commands.showFindPanel"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.showFindPanel">[docs]</a>    <span class="k">def</span> <span class="nf">showFindPanel</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Open Leo&#39;s legacy Find dialog.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">findPanel</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">findPanel</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">createFindPanel</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">findPanel</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">findPanel</span><span class="o">.</span><span class="n">bringToFront</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;the&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">guiName</span><span class="p">(),</span>
                <span class="s">&#39;gui does not support a stand-alone find dialog&#39;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2889: *6* findNext</span></div>
<div class="viewcode-block" id="Commands.findNext"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.findNext">[docs]</a>    <span class="k">def</span> <span class="nf">findNext</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">findPanel</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">findPanel</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">createFindPanel</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">findPanel</span><span class="o">.</span><span class="n">findNextCommand</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2890: *6* findPrevious</span></div>
<div class="viewcode-block" id="Commands.findPrevious"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.findPrevious">[docs]</a>    <span class="k">def</span> <span class="nf">findPrevious</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">findPanel</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">findPanel</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">createFindPanel</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">findPanel</span><span class="o">.</span><span class="n">findPreviousCommand</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2891: *6* replace</span></div>
<div class="viewcode-block" id="Commands.replace"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">findPanel</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">findPanel</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">createFindPanel</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">findPanel</span><span class="o">.</span><span class="n">changeCommand</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2892: *6* replaceThenFind</span></div>
<div class="viewcode-block" id="Commands.replaceThenFind"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.replaceThenFind">[docs]</a>    <span class="k">def</span> <span class="nf">replaceThenFind</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">findPanel</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">findPanel</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">createFindPanel</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">findPanel</span><span class="o">.</span><span class="n">changeThenFindCommand</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20051013083241: *6* replaceAll</span></div>
<div class="viewcode-block" id="Commands.replaceAll"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.replaceAll">[docs]</a>    <span class="k">def</span> <span class="nf">replaceAll</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">findPanel</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">findPanel</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">createFindPanel</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">findPanel</span><span class="o">.</span><span class="n">changeAllCommand</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2893: *5* notValidInBatchMode</span></div>
<div class="viewcode-block" id="Commands.notValidInBatchMode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.notValidInBatchMode">[docs]</a>    <span class="k">def</span> <span class="nf">notValidInBatchMode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commandName</span><span class="p">):</span>

        <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;the&#39;</span><span class="p">,</span><span class="n">commandName</span><span class="p">,</span><span class="s">&quot;command is not valid in batch mode&quot;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2894: *4* Outline menu...</span>
    <span class="c">#@+node:ekr.20031218072017.2895: *5*  Top Level... (Commands)</span>
    <span class="c">#@+node:ekr.20031218072017.1548: *6* c.Cut &amp; Paste Outlines</span>
    <span class="c">#@+node:ekr.20031218072017.1549: *7* c.cutOutline</span></div>
<div class="viewcode-block" id="Commands.cutOutline"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.cutOutline">[docs]</a>    <span class="k">def</span> <span class="nf">cutOutline</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Delete the selected outline and send it to the clipboard.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">canDeleteHeadline</span><span class="p">():</span>
            <span class="n">c</span><span class="o">.</span><span class="n">copyOutline</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">deleteOutline</span><span class="p">(</span><span class="s">&quot;Cut Node&quot;</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">recolor</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.1550: *7* c.copyOutline</span></div>
<div class="viewcode-block" id="Commands.copyOutline"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.copyOutline">[docs]</a>    <span class="k">def</span> <span class="nf">copyOutline</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Copy the selected outline to the clipboard.&#39;&#39;&#39;</span>

        <span class="c"># Copying an outline has no undo consequences.</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fileCommands</span><span class="o">.</span><span class="n">putLeoOutline</span><span class="p">()</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">replaceClipboardWith</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.1551: *7* c.pasteOutline</span>
    <span class="c"># To cut and paste between apps, just copy into an empty body first, then copy to Leo&#39;s clipboard.</span>
</div>
<div class="viewcode-block" id="Commands.pasteOutline"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.pasteOutline">[docs]</a>    <span class="k">def</span> <span class="nf">pasteOutline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">reassignIndices</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Paste an outline into the present outline from the clipboard.</span>
<span class="sd">        Nodes do *not* retain their original identify.&#39;&#39;&#39;</span>

        <span class="c"># trace = False and not g.unitTesting</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">getTextFromClipboard</span><span class="p">()</span>
        <span class="n">pasteAsClone</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">reassignIndices</span>
        <span class="n">undoType</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">reassignIndices</span><span class="p">,</span><span class="s">&#39;Paste Node&#39;</span><span class="p">,</span><span class="s">&#39;Paste As Clone&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">canPasteOutline</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">return</span> <span class="c"># This should never happen.</span>

        <span class="n">isLeo</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">prolog_prefix_string</span><span class="p">)</span>

        <span class="n">vnodeInfoDict</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">computeVnodeInfoDict</span><span class="p">()</span> <span class="k">if</span> <span class="n">pasteAsClone</span> <span class="k">else</span> <span class="p">{}</span>

        <span class="c"># create a *position* to be pasted.</span>
        <span class="k">if</span> <span class="n">isLeo</span><span class="p">:</span>
            <span class="n">pasted</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fileCommands</span><span class="o">.</span><span class="n">getLeoOutlineFromClipboard</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">reassignIndices</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pasted</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">importCommands</span><span class="o">.</span><span class="n">convertMoreStringToOutlineAfter</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">pasted</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">pasteAsClone</span><span class="p">:</span>
            <span class="n">copiedBunchList</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">computeCopiedBunchList</span><span class="p">(</span><span class="n">pasted</span><span class="p">,</span><span class="n">vnodeInfoDict</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">copiedBunchList</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">undoData</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">undoer</span><span class="o">.</span><span class="n">beforeInsertNode</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">,</span>
            <span class="n">pasteAsClone</span><span class="o">=</span><span class="n">pasteAsClone</span><span class="p">,</span><span class="n">copiedBunchList</span><span class="o">=</span><span class="n">copiedBunchList</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">validateOutline</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">pasted</span><span class="p">)</span>
        <span class="n">pasted</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

        <span class="c"># paste as first child if back is expanded.</span>
        <span class="n">back</span> <span class="o">=</span> <span class="n">pasted</span><span class="o">.</span><span class="n">back</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">back</span> <span class="ow">and</span> <span class="n">back</span><span class="o">.</span><span class="n">hasChildren</span><span class="p">()</span> <span class="ow">and</span> <span class="n">back</span><span class="o">.</span><span class="n">isExpanded</span><span class="p">():</span>
            <span class="c"># 2011/06/21: fixed hanger: test back.hasChildren().</span>
            <span class="n">pasted</span><span class="o">.</span><span class="n">moveToNthChildOf</span><span class="p">(</span><span class="n">back</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pasteAsClone</span><span class="p">:</span>
            <span class="c"># Set dirty bits for ancestors of *all* pasted nodes.</span>
            <span class="c"># Note: the setDescendentsDirty flag does not do what we want.</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pasted</span><span class="o">.</span><span class="n">self_and_subtree</span><span class="p">():</span>
                <span class="n">p</span><span class="o">.</span><span class="n">setAllAncestorAtFileNodesDirty</span><span class="p">(</span>
                    <span class="n">setDescendentsDirty</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">undoer</span><span class="o">.</span><span class="n">afterInsertNode</span><span class="p">(</span><span class="n">pasted</span><span class="p">,</span><span class="n">undoType</span><span class="p">,</span><span class="n">undoData</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">(</span><span class="n">pasted</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">recolor</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">pasted</span> <span class="c"># For unit testing.</span>
    <span class="c">#@+node:ekr.20050418084539: *8* c.computeVnodeInfoDict</span>
    <span class="c">#@+at</span>
    <span class="c"># </span>
    <span class="c"># We don&#39;t know yet which nodes will be affected by the paste, so we remember</span>
    <span class="c"># everything. This is expensive, but foolproof.</span>
    <span class="c"># </span>
    <span class="c"># The alternative is to try to remember the &#39;before&#39; values of nodes in the</span>
    <span class="c"># fileCommands read logic. Several experiments failed, and the code is very ugly.</span>
    <span class="c"># In short, it seems wise to do things the foolproof way.</span>
    <span class="c"># </span>
    <span class="c">#@@c</span>
</div>
<div class="viewcode-block" id="Commands.computeVnodeInfoDict"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.computeVnodeInfoDict">[docs]</a>    <span class="k">def</span> <span class="nf">computeVnodeInfoDict</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span><span class="p">,</span><span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="p">,{}</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">all_unique_nodes</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">Bunch</span><span class="p">(</span><span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span><span class="n">head</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="n">body</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">d</span>
    <span class="c">#@+node:ekr.20050418084539.2: *8* c.computeCopiedBunchList</span></div>
<div class="viewcode-block" id="Commands.computeCopiedBunchList"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.computeCopiedBunchList">[docs]</a>    <span class="k">def</span> <span class="nf">computeCopiedBunchList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pasted</span><span class="p">,</span><span class="n">vnodeInfoDict</span><span class="p">):</span>

        <span class="c"># Create a dict containing only copied vnodes.</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pasted</span><span class="o">.</span><span class="n">self_and_subtree</span><span class="p">():</span>
            <span class="n">d</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span>

        <span class="c"># g.trace(sorted(list(d.keys())))</span>

        <span class="n">aList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vnodeInfoDict</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                <span class="n">bunch</span> <span class="o">=</span> <span class="n">vnodeInfoDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="n">aList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bunch</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">aList</span>
    <span class="c">#@+node:EKR.20040610130943: *7* pasteOutlineRetainingClones</span></div>
<div class="viewcode-block" id="Commands.pasteOutlineRetainingClones"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.pasteOutlineRetainingClones">[docs]</a>    <span class="k">def</span> <span class="nf">pasteOutlineRetainingClones</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Paste an outline into the present outline from the clipboard.</span>
<span class="sd">        Nodes *retain* their original identify.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">pasteOutline</span><span class="p">(</span><span class="n">reassignIndices</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2028: *6* c.hoist/dehoist/clearAllHoists</span>
    <span class="c">#@+node:ekr.20120308061112.9865: *7* c.deHoist</span></div>
<div class="viewcode-block" id="Commands.dehoist"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.dehoist">[docs]</a>    <span class="k">def</span> <span class="nf">dehoist</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Undo a previous hoist of an outline.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="k">if</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">canDehoist</span><span class="p">():</span>
            <span class="n">bunch</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">hoistStack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">bunch</span><span class="o">.</span><span class="n">expanded</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">expand</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>              <span class="n">p</span><span class="o">.</span><span class="n">contract</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>

            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">clearStatusLine</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">hoistStack</span><span class="p">:</span>
                <span class="n">bunch</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">hoistStack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">putStatusLine</span><span class="p">(</span><span class="s">&quot;Hoist: &quot;</span> <span class="o">+</span> <span class="n">bunch</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">putStatusLine</span><span class="p">(</span><span class="s">&quot;No hoist&quot;</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">undoer</span><span class="o">.</span><span class="n">afterDehoist</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s">&#39;DeHoist&#39;</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&#39;hoist-changed&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>

    <span class="c">#@+node:ekr.20120308061112.9866: *7* c.clearAllHoists</span></div>
<div class="viewcode-block" id="Commands.clearAllHoists"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.clearAllHoists">[docs]</a>    <span class="k">def</span> <span class="nf">clearAllHoists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Undo a previous hoist of an outline.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">c</span><span class="o">.</span><span class="n">hoistStack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">putStatusLine</span><span class="p">(</span><span class="s">&quot;Hoists cleared&quot;</span><span class="p">)</span>

        <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&#39;hoist-changed&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20120308061112.9867: *7* c.hoist</span></div>
<div class="viewcode-block" id="Commands.hoist"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.hoist">[docs]</a>    <span class="k">def</span> <span class="nf">hoist</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Make only the selected outline visible.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="k">if</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">canHoist</span><span class="p">():</span>
            <span class="c"># Remember the expansion state.</span>
            <span class="n">bunch</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">Bunch</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span><span class="n">expanded</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">isExpanded</span><span class="p">())</span>
            <span class="n">c</span><span class="o">.</span><span class="n">hoistStack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bunch</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">expand</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">clearStatusLine</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">putStatusLine</span><span class="p">(</span><span class="s">&quot;Hoist: &quot;</span> <span class="o">+</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">undoer</span><span class="o">.</span><span class="n">afterHoist</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s">&#39;Hoist&#39;</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&#39;hoist-changed&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.1759: *6* Insert, Delete &amp; Clone (Commands)</span>
    <span class="c">#@+node:ekr.20031218072017.1760: *7* c.checkMoveWithParentWithWarning &amp; c.checkDrag</span>
    <span class="c">#@+node:ekr.20070910105044: *8* c.checkMoveWithParentWithWarning</span></div>
<div class="viewcode-block" id="Commands.checkMoveWithParentWithWarning"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.checkMoveWithParentWithWarning">[docs]</a>    <span class="k">def</span> <span class="nf">checkMoveWithParentWithWarning</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">root</span><span class="p">,</span><span class="n">parent</span><span class="p">,</span><span class="n">warningFlag</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Return False if root or any of root&#39;s descedents is a clone of</span>
<span class="sd">        parent or any of parents ancestors.&quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;Illegal move or drag: no clone may contain a clone of itself&quot;</span>

        <span class="c"># g.trace(&quot;root&quot;,root,&quot;parent&quot;,parent)</span>
        <span class="n">clonedVnodes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ancestor</span> <span class="ow">in</span> <span class="n">parent</span><span class="o">.</span><span class="n">self_and_parents</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">ancestor</span><span class="o">.</span><span class="n">isCloned</span><span class="p">():</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">ancestor</span><span class="o">.</span><span class="n">v</span>
                <span class="n">clonedVnodes</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">clonedVnodes</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">self_and_subtree</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isCloned</span><span class="p">()</span> <span class="ow">and</span> <span class="n">clonedVnodes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTestDict</span><span class="p">[</span><span class="s">&#39;checkMoveWithParentWithWarning&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">True</span>
                <span class="k">elif</span> <span class="n">warningFlag</span><span class="p">:</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">alert</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="c">#@+node:ekr.20070910105044.1: *8* c.checkDrag</span></div>
<div class="viewcode-block" id="Commands.checkDrag"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.checkDrag">[docs]</a>    <span class="k">def</span> <span class="nf">checkDrag</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">root</span><span class="p">,</span><span class="n">target</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Return False if target is any descendant of root.&quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s">&quot;Can not drag a node into its descendant tree.&quot;</span>

        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">subtree</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">z</span> <span class="o">==</span> <span class="n">target</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTestDict</span><span class="p">[</span><span class="s">&#39;checkMoveWithParentWithWarning&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">alert</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="c">#@+node:ekr.20031218072017.1193: *7* c.deleteOutline</span></div>
<div class="viewcode-block" id="Commands.deleteOutline"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.deleteOutline">[docs]</a>    <span class="k">def</span> <span class="nf">deleteOutline</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">op_name</span><span class="o">=</span><span class="s">&quot;Delete Node&quot;</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Deletes the selected outline.&quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">chapterController</span> <span class="p">;</span> <span class="n">u</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">undoer</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span> <span class="c"># Make sure we capture the headline for Undo.</span>

        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">hasVisBack</span><span class="p">(</span><span class="n">c</span><span class="p">):</span> <span class="n">newNode</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">visBack</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">newNode</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">next</span><span class="p">()</span> <span class="c"># _not_ p.visNext(): we are at the top level.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">newNode</span><span class="p">:</span> <span class="k">return</span>

        <span class="k">if</span> <span class="n">cc</span><span class="p">:</span> <span class="c"># Special cases for @chapter and @chapters nodes.</span>
            <span class="n">chapter</span> <span class="o">=</span> <span class="s">&#39;@chapter &#39;</span> <span class="p">;</span> <span class="n">chapters</span> <span class="o">=</span> <span class="s">&#39;@chapters &#39;</span> 
            <span class="n">h</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span>
            <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">chapters</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">hasChildren</span><span class="p">():</span>
                    <span class="k">return</span> <span class="n">cc</span><span class="o">.</span><span class="n">note</span><span class="p">(</span><span class="s">&#39;Can not delete @chapters node with children.&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">h</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">chapter</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">chapter</span><span class="p">):]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
                    <span class="c"># Bug fix: 2009/3/23: Make sure the chapter exists!</span>
                    <span class="c"># This might be an @chapter node outside of @chapters tree.</span>
                    <span class="n">theChapter</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">chaptersDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">theChapter</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">cc</span><span class="o">.</span><span class="n">removeChapterByName</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="n">undoData</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">beforeDeleteNode</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">setAllAncestorAtFileNodesDirty</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">doDelete</span><span class="p">(</span><span class="n">newNode</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">u</span><span class="o">.</span><span class="n">afterDeleteNode</span><span class="p">(</span><span class="n">newNode</span><span class="p">,</span><span class="n">op_name</span><span class="p">,</span><span class="n">undoData</span><span class="p">,</span><span class="n">dirtyVnodeList</span><span class="o">=</span><span class="n">dirtyVnodeList</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">(</span><span class="n">newNode</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">validateOutline</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.1761: *7* c.insertHeadline</span></div>
<div class="viewcode-block" id="Commands.insertHeadline"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.insertHeadline">[docs]</a>    <span class="k">def</span> <span class="nf">insertHeadline</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">op_name</span><span class="o">=</span><span class="s">&quot;Insert Node&quot;</span><span class="p">,</span><span class="n">as_child</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Insert a node after the presently selected node.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">u</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">undoer</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">current</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span>

        <span class="n">undoData</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">undoer</span><span class="o">.</span><span class="n">beforeInsertNode</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
        <span class="c"># Make sure the new node is visible when hoisting.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">as_child</span> <span class="ow">or</span>
            <span class="p">(</span><span class="n">current</span><span class="o">.</span><span class="n">hasChildren</span><span class="p">()</span> <span class="ow">and</span> <span class="n">current</span><span class="o">.</span><span class="n">isExpanded</span><span class="p">())</span> <span class="ow">or</span>
            <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">hoistStack</span> <span class="ow">and</span> <span class="n">current</span> <span class="o">==</span> <span class="n">c</span><span class="o">.</span><span class="n">hoistStack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getBool</span><span class="p">(</span><span class="s">&#39;insert_new_nodes_at_end&#39;</span><span class="p">):</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">insertAsLastChild</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">insertAsNthChild</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">insertAfter</span><span class="p">()</span>
        <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&#39;create-node&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">setDirty</span><span class="p">(</span><span class="n">setDescendentsDirty</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">setAllAncestorAtFileNodesDirty</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">u</span><span class="o">.</span><span class="n">afterInsertNode</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">op_name</span><span class="p">,</span><span class="n">undoData</span><span class="p">,</span><span class="n">dirtyVnodeList</span><span class="o">=</span><span class="n">dirtyVnodeList</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">redrawAndEdit</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">selectAll</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">p</span>
    <span class="c">#@+node:ekr.20071005173203.1: *7* c.insertChild</span></div>
<div class="viewcode-block" id="Commands.insertChild"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.insertChild">[docs]</a>    <span class="k">def</span> <span class="nf">insertChild</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Insert a node after the presently selected node.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">insertHeadline</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">,</span><span class="n">op_name</span><span class="o">=</span><span class="s">&#39;Insert Child&#39;</span><span class="p">,</span><span class="n">as_child</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.1762: *7* c.clone</span></div>
<div class="viewcode-block" id="Commands.clone"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.clone">[docs]</a>    <span class="k">def</span> <span class="nf">clone</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Create a clone of the selected outline.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">u</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">undoer</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">undoData</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">undoer</span><span class="o">.</span><span class="n">beforeCloneNode</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span> <span class="c"># Capture any changes to the headline.</span>
        <span class="n">clone</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="n">clone</span><span class="o">.</span><span class="n">setAllAncestorAtFileNodesDirty</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">validateOutline</span><span class="p">():</span>
            <span class="n">u</span><span class="o">.</span><span class="n">afterCloneNode</span><span class="p">(</span><span class="n">clone</span><span class="p">,</span><span class="s">&#39;Clone Node&#39;</span><span class="p">,</span><span class="n">undoData</span><span class="p">,</span><span class="n">dirtyVnodeList</span><span class="o">=</span><span class="n">dirtyVnodeList</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">(</span><span class="n">clone</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">clone</span> <span class="c"># For mod_labels and chapters plugins.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clone</span><span class="o">.</span><span class="n">doDelete</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">setCurrentPosition</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20031218072017.1765: *7* c.validateOutline</span>
    <span class="c"># Makes sure all nodes are valid.</span>
</div>
<div class="viewcode-block" id="Commands.validateOutline"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.validateOutline">[docs]</a>    <span class="k">def</span> <span class="nf">validateOutline</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="n">root</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">nullPosition</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">root</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">root</span><span class="o">.</span><span class="n">validateOutlineWithParent</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
    <span class="c">#@+node:ekr.20080425060424.1: *6* Sort...</span>
    <span class="c">#@+node:ekr.20080503055349.1: *7* c.setPositionAfterSort</span></div>
<div class="viewcode-block" id="Commands.setPositionAfterSort"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.setPositionAfterSort">[docs]</a>    <span class="k">def</span> <span class="nf">setPositionAfterSort</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sortChildren</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="n">p_v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>
        <span class="n">parent_v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">_parentVnode</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">sortChildren</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">parent</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parent</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">firstChild</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">leoNodes</span><span class="o">.</span><span class="n">position</span><span class="p">(</span><span class="n">parent_v</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">while</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="o">!=</span> <span class="n">p_v</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToNext</span><span class="p">()</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="ow">or</span> <span class="n">parent</span>

        <span class="k">return</span> <span class="n">p</span>
    <span class="c">#@+node:ekr.20050415134809: *7* c.sortChildren</span>
    <span class="c"># New in Leo 4.7 final: this method no longer supports</span>
    <span class="c"># the &#39;cmp&#39; keyword arg.</span>
</div>
<div class="viewcode-block" id="Commands.sortChildren"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.sortChildren">[docs]</a>    <span class="k">def</span> <span class="nf">sortChildren</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">key</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Sort the children of a node.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="k">if</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">hasChildren</span><span class="p">():</span>
            <span class="n">c</span><span class="o">.</span><span class="n">sortSiblings</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">firstChild</span><span class="p">(),</span><span class="n">sortChildren</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050415134809.1: *7* c.sortSiblings</span>
    <span class="c"># New in Leo 4.7 final: this method no longer supports</span>
    <span class="c"># the &#39;cmp&#39; keyword arg.</span>
</div>
<div class="viewcode-block" id="Commands.sortSiblings"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.sortSiblings">[docs]</a>    <span class="k">def</span> <span class="nf">sortSiblings</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sortChildren</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                      <span class="n">reverse</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Sort the siblings of a node.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">u</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">undoer</span>
        <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span>

        <span class="n">undoType</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">sortChildren</span><span class="p">,</span><span class="s">&#39;Sort Children&#39;</span><span class="p">,</span><span class="s">&#39;Sort Siblings&#39;</span><span class="p">)</span>
        <span class="n">parent_v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">_parentVnode</span><span class="p">()</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>
        <span class="n">oldChildren</span> <span class="o">=</span> <span class="n">parent_v</span><span class="o">.</span><span class="n">children</span><span class="p">[:]</span>
        <span class="n">newChildren</span> <span class="o">=</span> <span class="n">parent_v</span><span class="o">.</span><span class="n">children</span><span class="p">[:]</span>

        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">lowerKey</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">lowerKey</span>

        <span class="n">newChildren</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">oldChildren</span> <span class="o">==</span> <span class="n">newChildren</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c"># 2010/01/20. Fix bug 510148.</span>
        <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

        <span class="c"># g.trace(g.listToString(newChildren))</span>

        <span class="n">bunch</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">beforeSort</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">undoType</span><span class="p">,</span><span class="n">oldChildren</span><span class="p">,</span><span class="n">newChildren</span><span class="p">,</span><span class="n">sortChildren</span><span class="p">)</span>
        <span class="n">parent_v</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="n">newChildren</span>
        <span class="k">if</span> <span class="n">parent</span><span class="p">:</span>
            <span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">setAllAncestorAtFileNodesDirty</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">u</span><span class="o">.</span><span class="n">afterSort</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">bunch</span><span class="p">,</span><span class="n">dirtyVnodeList</span><span class="p">)</span>

        <span class="c"># Sorting destroys position p, and possibly the root position.</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">setPositionAfterSort</span><span class="p">(</span><span class="n">sortChildren</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20040711135959.2: *5* Check Outline submenu...</span>
    <span class="c">#@+node:ekr.20031218072017.2072: *6* c.checkOutline</span></div>
<div class="viewcode-block" id="Commands.checkOutline"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.checkOutline">[docs]</a>    <span class="k">def</span> <span class="nf">checkOutline</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">unittest</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">full</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">root</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Report any possible clone errors in the outline.</span>

<span class="sd">        Remove any tnodeLists.&quot;&quot;&quot;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span> <span class="n">errors</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">full</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">unittest</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&quot;all tests enabled: this may take awhile&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">root</span><span class="p">:</span> <span class="nb">iter</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">self_and_subtree</span>
        <span class="k">else</span><span class="p">:</span>    <span class="nb">iter</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">all_positions</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c">#@+&lt;&lt; remove tnodeList &gt;&gt;</span>
                <span class="c">#@+node:ekr.20040313150633: *7* &lt;&lt; remove tnodeList &gt;&gt;</span>
                <span class="c"># Empty tnodeLists are not errors.</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span>

                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s">&quot;tnodeList&quot;</span><span class="p">):</span> <span class="c"># and len(v.tnodeList) &gt; 0 and not v.isAnyAtFileNode():</span>
                    <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;deleting tnodeList for &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="nb">delattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s">&quot;tnodeList&quot;</span><span class="p">)</span>
                    <span class="n">v</span><span class="o">.</span><span class="n">_p_changed</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="c">#@-&lt;&lt; remove tnodeList &gt;&gt;</span>
                <span class="k">if</span> <span class="n">full</span><span class="p">:</span> <span class="c"># Unit tests usually set this false.</span>
                    <span class="c">#@+&lt;&lt; do full tests &gt;&gt;</span>
                    <span class="c">#@+node:ekr.20040323155951: *7* &lt;&lt; do full tests &gt;&gt;</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">unittest</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">count</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;.&#39;</span><span class="p">,</span><span class="n">newline</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">count</span> <span class="o">%</span> <span class="mi">8000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">g</span><span class="o">.</span><span class="n">enl</span><span class="p">()</span>

                    <span class="c">#@+others</span>
                    <span class="c">#@+node:ekr.20040314035615: *8* assert consistency of threadNext &amp; threadBack links</span>
                    <span class="n">threadBack</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">threadBack</span><span class="p">()</span>
                    <span class="n">threadNext</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">threadNext</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">threadBack</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="n">p</span> <span class="o">==</span> <span class="n">threadBack</span><span class="o">.</span><span class="n">threadNext</span><span class="p">(),</span> <span class="s">&quot;p!=p.threadBack().threadNext()&quot;</span>

                    <span class="k">if</span> <span class="n">threadNext</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="n">p</span> <span class="o">==</span> <span class="n">threadNext</span><span class="o">.</span><span class="n">threadBack</span><span class="p">(),</span> <span class="s">&quot;p!=p.threadNext().threadBack()&quot;</span>
                    <span class="c">#@+node:ekr.20040314035615.1: *8* assert consistency of next and back links</span>
                    <span class="n">back</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">back</span><span class="p">()</span>
                    <span class="nb">next</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">back</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="n">p</span> <span class="o">==</span> <span class="n">back</span><span class="o">.</span><span class="n">next</span><span class="p">(),</span> <span class="s">&#39;p!=p.back().next(),  back: </span><span class="si">%s</span><span class="se">\n</span><span class="s">back.next: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">back</span><span class="p">,</span><span class="n">back</span><span class="o">.</span><span class="n">next</span><span class="p">())</span>

                    <span class="k">if</span> <span class="nb">next</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="n">p</span> <span class="o">==</span> <span class="nb">next</span><span class="o">.</span><span class="n">back</span><span class="p">(),</span> <span class="s">&#39;p!=p.next().back, next: </span><span class="si">%s</span><span class="se">\n</span><span class="s">next.back: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="nb">next</span><span class="p">,</span><span class="nb">next</span><span class="o">.</span><span class="n">back</span><span class="p">())</span>
                    <span class="c">#@+node:ekr.20040314035615.2: *8* assert consistency of parent and child links</span>
                    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">hasParent</span><span class="p">():</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">childIndex</span><span class="p">()</span>
                        <span class="k">assert</span> <span class="n">p</span> <span class="o">==</span> <span class="n">p</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span><span class="o">.</span><span class="n">moveToNthChild</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="s">&quot;p!=parent.moveToNthChild&quot;</span>

                    <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
                        <span class="k">assert</span> <span class="n">p</span> <span class="o">==</span> <span class="n">child</span><span class="o">.</span><span class="n">parent</span><span class="p">(),</span> <span class="s">&quot;p!=child.parent&quot;</span>

                    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">hasNext</span><span class="p">():</span>
                        <span class="k">assert</span> <span class="n">p</span><span class="o">.</span><span class="n">next</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span> <span class="o">==</span> <span class="n">p</span><span class="o">.</span><span class="n">parent</span><span class="p">(),</span> <span class="s">&quot;next.parent!=parent&quot;</span>

                    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">hasBack</span><span class="p">():</span>
                        <span class="k">assert</span> <span class="n">p</span><span class="o">.</span><span class="n">back</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span> <span class="o">==</span> <span class="n">p</span><span class="o">.</span><span class="n">parent</span><span class="p">(),</span> <span class="s">&quot;back.parent!=parent&quot;</span>
                    <span class="c">#@+node:ekr.20080426051658.1: *8* assert consistency of parent and children arrays</span>
                    <span class="c">#@+at</span>
                    <span class="c"># Every nodes gets visited, so we only check consistency</span>
                    <span class="c"># between p and its parent, not between p and its children.</span>
                    <span class="c"># </span>
                    <span class="c"># In other words, this is a strong test.</span>
                    <span class="c">#@@c</span>

                    <span class="n">parent_v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">_parentVnode</span><span class="p">()</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">childIndex</span><span class="p">()</span>

                    <span class="k">assert</span> <span class="n">parent_v</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;fail 1&#39;</span>
                    <span class="c">#@-others</span>
                    <span class="c">#@-&lt;&lt; do full tests &gt;&gt;</span>
            <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
                <span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c">#@+&lt;&lt; give test failed message &gt;&gt;</span>
                <span class="c">#@+node:ekr.20040314044652: *7* &lt;&lt; give test failed message &gt;&gt;</span>
                <span class="n">junk</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">junk</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>

                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;test failed at position </span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">p</span><span class="p">),</span><span class="n">value</span><span class="p">))</span>
                <span class="c">#@-&lt;&lt; give test failed message &gt;&gt;</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="k">return</span> <span class="n">errors</span> 
        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">unittest</span><span class="p">:</span>
            <span class="c">#@+&lt;&lt; print summary message &gt;&gt;</span>
            <span class="c">#@+node:ekr.20040314043900: *7* &lt;&lt;print summary message &gt;&gt;</span>
            <span class="k">if</span> <span class="n">full</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">enl</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">errors</span> <span class="ow">or</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="c"># color = g.choose(errors,&#39;red&#39;,&#39;blue&#39;)</span>
                <span class="c"># g.es_print(&#39;&#39;,count,&#39;nodes checked&#39;,errors,&#39;errors&#39;,color=color)</span>
                <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">count</span><span class="p">,</span><span class="s">&#39;nodes checked&#39;</span><span class="p">,</span><span class="n">errors</span><span class="p">,</span><span class="s">&#39;errors&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">count</span><span class="p">,</span><span class="s">&#39;nodes checked&#39;</span><span class="p">,</span><span class="n">errors</span><span class="p">,</span><span class="s">&#39;errors&#39;</span><span class="p">)</span>

            <span class="c">#@-&lt;&lt; print summary message &gt;&gt;</span>
        <span class="k">return</span> <span class="n">errors</span>
    <span class="c">#@+node:ekr.20040723094220: *6* Check Outline commands &amp; allies</span>
    <span class="c"># This code is no longer used by any Leo command,</span>
    <span class="c"># but it will be retained for use of scripts.</span>
    <span class="c">#@+node:ekr.20040723094220.1: *7* c.checkAllPythonCode</span></div>
<div class="viewcode-block" id="Commands.checkAllPythonCode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.checkAllPythonCode">[docs]</a>    <span class="k">def</span> <span class="nf">checkAllPythonCode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">unittest</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">ignoreAtIgnore</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Check all nodes in the selected tree for syntax and tab errors.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">result</span> <span class="o">=</span> <span class="s">&quot;ok&quot;</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">all_unique_positions</span><span class="p">():</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">unittest</span><span class="p">:</span>
                <span class="c">#@+&lt;&lt; print dots &gt;&gt;</span>
                <span class="c">#@+node:ekr.20040723094220.2: *8* &lt;&lt; print dots &gt;&gt;</span>
                <span class="k">if</span> <span class="n">count</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;.&#39;</span><span class="p">,</span><span class="n">newline</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">count</span> <span class="o">%</span> <span class="mi">2000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">enl</span><span class="p">()</span>
                <span class="c">#@-&lt;&lt; print dots &gt;&gt;</span>

            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">scanForAtLanguage</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;python&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">scanForAtSettings</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="ow">not</span> <span class="n">ignoreAtIgnore</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">scanForAtIgnore</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">c</span><span class="o">.</span><span class="n">checkPythonNode</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">unittest</span><span class="p">)</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">SyntaxError</span><span class="p">,</span><span class="n">tokenize</span><span class="o">.</span><span class="n">TokenError</span><span class="p">,</span><span class="n">tabnanny</span><span class="o">.</span><span class="n">NannyNag</span><span class="p">):</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="s">&quot;error&quot;</span> <span class="c"># Continue to check.</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">return</span> <span class="s">&quot;surprise&quot;</span> <span class="c"># abort</span>
                    <span class="k">if</span> <span class="n">unittest</span> <span class="ow">and</span> <span class="n">result</span> <span class="o">!=</span> <span class="s">&quot;ok&quot;</span><span class="p">:</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;Syntax error in </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">p</span><span class="o">.</span><span class="n">cleanHeadString</span><span class="p">())</span>
                        <span class="k">return</span> <span class="n">result</span> <span class="c"># End the unit test: it has failed.</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">unittest</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&quot;check complete&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>
    <span class="c">#@+node:ekr.20040723094220.3: *7* c.checkPythonCode</span></div>
<div class="viewcode-block" id="Commands.checkPythonCode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.checkPythonCode">[docs]</a>    <span class="k">def</span> <span class="nf">checkPythonCode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">unittest</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">ignoreAtIgnore</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">suppressErrors</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">checkOnSave</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Check the selected tree for syntax and tab errors.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">result</span> <span class="o">=</span> <span class="s">&quot;ok&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">unittest</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;checking Python code   &quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">self_and_subtree</span><span class="p">():</span>

            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">unittest</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">checkOnSave</span><span class="p">:</span>
                <span class="c">#@+&lt;&lt; print dots &gt;&gt;</span>
                <span class="c">#@+node:ekr.20040723094220.4: *8* &lt;&lt; print dots &gt;&gt;</span>
                <span class="k">if</span> <span class="n">count</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;.&#39;</span><span class="p">,</span><span class="n">newline</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">count</span> <span class="o">%</span> <span class="mi">2000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">enl</span><span class="p">()</span>
                <span class="c">#@-&lt;&lt; print dots &gt;&gt;</span>

            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">scanForAtLanguage</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;python&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ignoreAtIgnore</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">scanForAtIgnore</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">c</span><span class="o">.</span><span class="n">checkPythonNode</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">unittest</span><span class="p">,</span><span class="n">suppressErrors</span><span class="p">)</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">SyntaxError</span><span class="p">,</span><span class="n">tokenize</span><span class="o">.</span><span class="n">TokenError</span><span class="p">,</span><span class="n">tabnanny</span><span class="o">.</span><span class="n">NannyNag</span><span class="p">):</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="s">&quot;error&quot;</span> <span class="c"># Continue to check.</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">return</span> <span class="s">&quot;surprise&quot;</span> <span class="c"># abort</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">unittest</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&quot;check complete&quot;</span><span class="p">)</span>

        <span class="c"># We _can_ return a result for unit tests because we aren&#39;t using doCommand.</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="c">#@+node:ekr.20040723094220.5: *7* c.checkPythonNode</span></div>
<div class="viewcode-block" id="Commands.checkPythonNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.checkPythonNode">[docs]</a>    <span class="k">def</span> <span class="nf">checkPythonNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">unittest</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">suppressErrors</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">h</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span>

        <span class="c"># Call getScript to ignore directives and section references.</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">getScript</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">body</span><span class="p">:</span> <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="s">&#39;&lt;node: </span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
                <span class="n">body</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
            <span class="nb">compile</span><span class="p">(</span><span class="n">body</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span><span class="s">&#39;exec&#39;</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">tabNannyNode</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">body</span><span class="p">,</span><span class="n">unittest</span><span class="p">,</span><span class="n">suppressErrors</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">SyntaxError</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">suppressErrors</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Syntax error in: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">h</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">(</span><span class="n">full</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;black&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">unittest</span><span class="p">:</span> <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;unexpected exception&#39;</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">unittest</span><span class="p">:</span> <span class="k">raise</span>

    <span class="c">#@+node:ekr.20040723094220.6: *7* c.tabNannyNode</span>
    <span class="c"># This code is based on tabnanny.check.</span>
</div>
<div class="viewcode-block" id="Commands.tabNannyNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.tabNannyNode">[docs]</a>    <span class="k">def</span> <span class="nf">tabNannyNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">headline</span><span class="p">,</span><span class="n">body</span><span class="p">,</span><span class="n">unittest</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">suppressErrors</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Check indentation using tabnanny.&quot;&quot;&quot;</span>

        <span class="c"># c = self</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">readline</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">readLinesClass</span><span class="p">(</span><span class="n">body</span><span class="p">)</span><span class="o">.</span><span class="n">next</span>
            <span class="n">tabnanny</span><span class="o">.</span><span class="n">process_tokens</span><span class="p">(</span><span class="n">tokenize</span><span class="o">.</span><span class="n">generate_tokens</span><span class="p">(</span><span class="n">readline</span><span class="p">))</span>

        <span class="k">except</span> <span class="ne">IndentationError</span><span class="p">:</span>
            <span class="n">junk</span><span class="p">,</span><span class="n">msg</span><span class="p">,</span><span class="n">junk</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">suppressErrors</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;IndentationError in&quot;</span><span class="p">,</span><span class="n">headline</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">unittest</span><span class="p">:</span> <span class="k">raise</span>

        <span class="k">except</span> <span class="n">tokenize</span><span class="o">.</span><span class="n">TokenError</span><span class="p">:</span>
            <span class="n">junk</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">junk</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">suppressErrors</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;TokenError in&quot;</span><span class="p">,</span><span class="n">headline</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">unittest</span><span class="p">:</span> <span class="k">raise</span>

        <span class="k">except</span> <span class="n">tabnanny</span><span class="o">.</span><span class="n">NannyNag</span><span class="p">:</span>
            <span class="n">junk</span><span class="p">,</span> <span class="n">nag</span><span class="p">,</span> <span class="n">junk</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">suppressErrors</span><span class="p">:</span>
                <span class="n">badline</span> <span class="o">=</span> <span class="n">nag</span><span class="o">.</span><span class="n">get_lineno</span><span class="p">()</span>
                <span class="n">line</span>    <span class="o">=</span> <span class="n">nag</span><span class="o">.</span><span class="n">get_line</span><span class="p">()</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">nag</span><span class="o">.</span><span class="n">get_msg</span><span class="p">()</span>
                <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;indentation error in&quot;</span><span class="p">,</span><span class="n">headline</span><span class="p">,</span><span class="s">&quot;line&quot;</span><span class="p">,</span><span class="n">badline</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="n">line2</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="p">))[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;offending line:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">line2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">unittest</span><span class="p">:</span> <span class="k">raise</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&quot;unexpected exception&quot;</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">unittest</span><span class="p">:</span> <span class="k">raise</span>
    <span class="c">#@+node:ekr.20040412060927: *6* c.dumpOutline</span></div>
<div class="viewcode-block" id="Commands.dumpOutline"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.dumpOutline">[docs]</a>    <span class="k">def</span> <span class="nf">dumpOutline</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; Dump all nodes in the outline.&quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">print</span> <span class="p">;</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="o">*</span><span class="mi">40</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">hiddenRootNode</span>
        <span class="n">v</span><span class="o">.</span><span class="n">dump</span><span class="p">()</span>
        <span class="n">seen</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">all_positions</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="n">seen</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">dump</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20040711135959.1: *6* Pretty Print commands</span>
    <span class="c">#@+node:ekr.20110917174948.6903: *7* class CPrettyPrinter</span></div>
<div class="viewcode-block" id="Commands.CPrettyPrinter"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.CPrettyPrinter">[docs]</a>    <span class="k">class</span> <span class="nc">CPrettyPrinter</span><span class="p">:</span>

        <span class="c">#@+others</span>
        <span class="c">#@+node:ekr.20110917174948.6904: *8* __init__ (CPrettyPrinter)</span>
        <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">c</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># Set in indent.</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">brackets</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c"># The brackets indentation level.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parens</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c"># The parenthesis nesting level.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c"># The list of tokens that form the final result.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tab_width</span> <span class="o">=</span> <span class="mi">4</span>
                <span class="c"># The number of spaces in each unit of leading indentation.</span>

            <span class="c"># No longer used.</span>

            <span class="c"># self.ignored_brackets = 0</span>
                <span class="c"># # The number of &#39;}&#39; to ignore before reducing self.brackets.</span>
            <span class="c"># self.ignore_ws = False</span>
                <span class="c"># # True: ignore the next whitespace token if any.</span>
        <span class="c">#@+node:ekr.20110917174948.6911: *8* indent &amp; helpers</span>
<div class="viewcode-block" id="Commands.CPrettyPrinter.indent"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.CPrettyPrinter.indent">[docs]</a>        <span class="k">def</span> <span class="nf">indent</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">toList</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">giveWarnings</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

            <span class="c"># c = self.c</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="p">:</span> <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="n">aList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
            <span class="k">assert</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">aList</span><span class="p">)</span> <span class="o">==</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span>

            <span class="n">aList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_statement_braces</span><span class="p">(</span><span class="n">aList</span><span class="p">,</span><span class="n">giveWarnings</span><span class="o">=</span><span class="n">giveWarnings</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">bracketLevel</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parens</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
                <span class="c"># g.trace(repr(s))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">put_token</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

            <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">toList</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
        <span class="c">#@+node:ekr.20110918225821.6815: *9* add_statement_braces</span></div>
<div class="viewcode-block" id="Commands.CPrettyPrinter.add_statement_braces"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.CPrettyPrinter.add_statement_braces">[docs]</a>        <span class="k">def</span> <span class="nf">add_statement_braces</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">giveWarnings</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span>

            <span class="k">def</span> <span class="nf">oops</span><span class="p">(</span><span class="n">message</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">):</span>
                <span class="c"># This can be called from c-to-python, in which case warnings should be suppressed.</span>
                <span class="k">if</span> <span class="n">giveWarnings</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;** changed &#39;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> after</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">message</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]))))</span>

            <span class="n">i</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">),[]</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
                <span class="n">token_</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="c"># token is a module.</span>
                <span class="n">progress</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">if</span> <span class="n">token_</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;if&#39;</span><span class="p">,</span><span class="s">&#39;for&#39;</span><span class="p">,</span><span class="s">&#39;while&#39;</span><span class="p">,):</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_ws_and_comments</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="s">&#39;(&#39;</span><span class="p">):</span>
                        <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_parens</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="s">&#39;)&#39;</span><span class="p">):</span>
                            <span class="n">old_j</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span>
                            <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_ws_and_comments</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="s">&#39;;&#39;</span><span class="p">):</span>
                                <span class="c"># Example: while (*++prefix);</span>
                                <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">])</span>
                            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="s">&#39;{&#39;</span><span class="p">):</span>
                                <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">oops</span><span class="p">(</span><span class="s">&quot;insert &#39;{&#39;&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
                                <span class="c"># Back up, and don&#39;t go past a newline or comment.</span>
                                <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">old_j</span><span class="p">)</span>
                                <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">])</span>
                                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span>
                                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;{&#39;</span><span class="p">)</span>
                                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                                <span class="n">i</span> <span class="o">=</span> <span class="n">j</span>
                                <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_statement</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                                <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">])</span>
                                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;}&#39;</span><span class="p">)</span>
                                <span class="n">oops</span><span class="p">(</span><span class="s">&quot;insert &#39;}&#39;&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">oops</span><span class="p">(</span><span class="s">&quot;missing &#39;)&#39;&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
                            <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">oops</span><span class="p">(</span><span class="s">&quot;missing &#39;(&#39;&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">])</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">j</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token_</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">assert</span> <span class="n">progress</span> <span class="o">&lt;</span> <span class="n">i</span>

            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="c">#@+node:ekr.20110919184022.6903: *10* skip_ws</span></div>
<div class="viewcode-block" id="Commands.CPrettyPrinter.skip_ws"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.CPrettyPrinter.skip_ws">[docs]</a>        <span class="k">def</span> <span class="nf">skip_ws</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="n">token_</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="c"># token is a module.</span>
                <span class="k">if</span> <span class="n">token_</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">token_</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">):</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="k">return</span> <span class="n">i</span>
        <span class="c">#@+node:ekr.20110918225821.6820: *10* skip_ws_and_comments</span></div>
<div class="viewcode-block" id="Commands.CPrettyPrinter.skip_ws_and_comments"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.CPrettyPrinter.skip_ws_and_comments">[docs]</a>        <span class="k">def</span> <span class="nf">skip_ws_and_comments</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="n">token_</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="c"># token is a module.</span>
                <span class="k">if</span> <span class="n">token_</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">token_</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;//&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">token_</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;/*&#39;</span><span class="p">):</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="k">return</span> <span class="n">i</span>
        <span class="c">#@+node:ekr.20110918225821.6817: *10* skip_parens</span></div>
<div class="viewcode-block" id="Commands.CPrettyPrinter.skip_parens"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.CPrettyPrinter.skip_parens">[docs]</a>        <span class="k">def</span> <span class="nf">skip_parens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

            <span class="sd">&#39;&#39;&#39;Skips from the opening ( to the matching ).</span>

<span class="sd">            If no matching is found i is set to len(s)&#39;&#39;&#39;</span>

            <span class="k">assert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;(&#39;</span><span class="p">))</span>

            <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="n">ch</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;(&#39;</span><span class="p">:</span>
                    <span class="n">level</span> <span class="o">+=</span> <span class="mi">1</span> <span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;)&#39;</span><span class="p">:</span>
                    <span class="n">level</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">level</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>  <span class="k">return</span> <span class="n">i</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">i</span>
        <span class="c">#@+node:ekr.20110918225821.6818: *10* skip_statement</span></div>
<div class="viewcode-block" id="Commands.CPrettyPrinter.skip_statement"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.CPrettyPrinter.skip_statement">[docs]</a>        <span class="k">def</span> <span class="nf">skip_statement</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

            <span class="sd">&#39;&#39;&#39;Skip to the next &#39;;&#39; or &#39;}&#39; token.&#39;&#39;&#39;</span>

            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="s">&#39;;}&#39;</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">i</span>
        <span class="c">#@+node:ekr.20110917204542.6967: *9* put_token &amp; helpers</span></div>
<div class="viewcode-block" id="Commands.CPrettyPrinter.put_token"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.CPrettyPrinter.put_token">[docs]</a>        <span class="k">def</span> <span class="nf">put_token</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

            <span class="sd">&#39;&#39;&#39;Append token s to self.result as is,</span>
<span class="sd">            *except* for adjusting leading whitespace and comments.</span>

<span class="sd">            &#39;{&#39; tokens bump self.brackets or self.ignored_brackets.</span>
<span class="sd">            self.brackets determines leading whitespace.</span>
<span class="sd">            &#39;&#39;&#39;</span>

            <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="s">&#39;{&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">brackets</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">s</span> <span class="o">==</span> <span class="s">&#39;}&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">brackets</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">remove_indent</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">s</span> <span class="o">==</span> <span class="s">&#39;(&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parens</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">s</span> <span class="o">==</span> <span class="s">&#39;)&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parens</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parens</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39; &#39;</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">brackets</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tab_width</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> <span class="k">pass</span> <span class="c"># Use the existing indentation.</span>
            <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parens</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">):</span>
                    <span class="c"># Kill the whitespace.</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                <span class="k">else</span><span class="p">:</span> <span class="k">pass</span> <span class="c"># Keep the whitespace.</span>
            <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;/*&#39;</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reformat_block_comment</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span> <span class="c"># put s as it is.</span>

            <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="c">#@+at</span>
        <span class="c">#     # It doesn&#39;t hurt to increase indentation after *all* &#39;{&#39;.</span>
        <span class="c">#     if s == &#39;{&#39;:</span>
        <span class="c">#         # Increase brackets unless &#39;=&#39; precedes it.</span>
        <span class="c">#         if self.prev_token(&#39;=&#39;):</span>
        <span class="c">#             self.ignored_brackets += 1</span>
        <span class="c">#         else:</span>
        <span class="c">#             self.brackets += 1</span>
        <span class="c">#     elif s == &#39;}&#39;:</span>
        <span class="c">#         if self.ignored_brackets:</span>
        <span class="c">#             self.ignored_brackets -= 1</span>
        <span class="c">#         else:</span>
        <span class="c">#             self.brackets -= 1</span>
        <span class="c">#             self.remove_indent()</span>
        <span class="c">#@+node:ekr.20110917204542.6968: *10* prev_token</span></div>
<div class="viewcode-block" id="Commands.CPrettyPrinter.prev_token"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.CPrettyPrinter.prev_token">[docs]</a>        <span class="k">def</span> <span class="nf">prev_token</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

            <span class="sd">&#39;&#39;&#39;Return the previous token, ignoring whitespace and comments.&#39;&#39;&#39;</span>

            <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">s2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="n">s2</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">True</span>
                <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">isspace</span><span class="p">()</span> <span class="ow">or</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;//&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span> <span class="p">(</span><span class="s">&#39;/*&#39;</span><span class="p">):</span>
                    <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">False</span>
        <span class="c">#@+node:ekr.20110918184425.6916: *10* reformat_block_comment</span></div>
<div class="viewcode-block" id="Commands.CPrettyPrinter.reformat_block_comment"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.CPrettyPrinter.reformat_block_comment">[docs]</a>        <span class="k">def</span> <span class="nf">reformat_block_comment</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

            <span class="k">return</span> <span class="n">s</span>
        <span class="c">#@+node:ekr.20110917204542.6969: *10* remove_indent</span></div>
<div class="viewcode-block" id="Commands.CPrettyPrinter.remove_indent"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.CPrettyPrinter.remove_indent">[docs]</a>        <span class="k">def</span> <span class="nf">remove_indent</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="sd">&#39;&#39;&#39;Remove one tab-width of blanks from the previous token.&#39;&#39;&#39;</span>

            <span class="n">w</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tab_width</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39; &#39;</span> <span class="o">*</span> <span class="n">w</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">):</span>
                        <span class="n">s2</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">+</span><span class="n">s2</span><span class="p">[:</span><span class="o">-</span><span class="n">w</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="n">w</span><span class="p">])</span>
        <span class="c">#@+node:ekr.20110918225821.6819: *8* match</span></div>
<div class="viewcode-block" id="Commands.CPrettyPrinter.match"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.CPrettyPrinter.match">[docs]</a>        <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">pat</span><span class="p">):</span>

            <span class="k">return</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">pat</span>
        <span class="c">#@+node:ekr.20110917174948.6930: *8* tokenize &amp; helper</span></div>
<div class="viewcode-block" id="Commands.CPrettyPrinter.tokenize"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.CPrettyPrinter.tokenize">[docs]</a>        <span class="k">def</span> <span class="nf">tokenize</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

            <span class="sd">&#39;&#39;&#39;Tokenize comments, strings, identifiers, whitespace and operators.&#39;&#39;&#39;</span>

            <span class="n">i</span><span class="p">,</span><span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,[]</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="c"># Loop invariant: at end: j &gt; i and s[i:j] is the new token.</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">ch</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">ch</span> <span class="ow">in</span> <span class="s">&#39;@</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">:</span> <span class="c"># Make *sure* these are separate tokens.</span>
                    <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;#&#39;</span><span class="p">:</span> <span class="c"># Preprocessor directive.</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_to_end_of_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">ch</span> <span class="ow">in</span> <span class="s">&#39; </span><span class="se">\t</span><span class="s">&#39;</span><span class="p">:</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">ch</span><span class="o">.</span><span class="n">isalpha</span><span class="p">()</span> <span class="ow">or</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;_&#39;</span><span class="p">:</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_c_id</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;//&#39;</span><span class="p">):</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;/*&#39;</span><span class="p">):</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_block_comment</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">ch</span> <span class="ow">in</span> <span class="s">&quot;&#39;</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">:</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_string</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">assert</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="n">i</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]))</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="c"># Advance.</span>

            <span class="k">return</span> <span class="n">result</span>

        <span class="c">#@+at The following could be added to the &#39;else&#39; clause::</span>
        <span class="c">#     # Accumulate everything else.</span>
        <span class="c">#     while (</span>
        <span class="c">#         j &lt; n and</span>
        <span class="c">#         not s[j].isspace() and</span>
        <span class="c">#         not s[j].isalpha() and</span>
        <span class="c">#         not s[j] in &#39;&quot;\&#39;_@&#39; and</span>
        <span class="c">#             # start of strings, identifiers, and single-character tokens.</span>
        <span class="c">#         not g.match(s,j,&#39;//&#39;) and</span>
        <span class="c">#         not g.match(s,j,&#39;/*&#39;) and</span>
        <span class="c">#         not g.match(s,j,&#39;--&gt;&#39;)</span>
        <span class="c">#     ):</span>
        <span class="c">#         j += 1</span>
        <span class="c">#@+node:ekr.20110917193725.6974: *9* skip_block_comment</span></div>
<div class="viewcode-block" id="Commands.CPrettyPrinter.skip_block_comment"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.CPrettyPrinter.skip_block_comment">[docs]</a>        <span class="k">def</span> <span class="nf">skip_block_comment</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

            <span class="k">assert</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;/*&quot;</span><span class="p">))</span>

            <span class="n">j</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;*/&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="c">#@-others</span>
    <span class="c">#@+node:ekr.20040711135244.5: *7* class PythonPrettyPrinter</span></div></div>
<div class="viewcode-block" id="Commands.PythonPrettyPrinter"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.PythonPrettyPrinter">[docs]</a>    <span class="k">class</span> <span class="nc">PythonPrettyPrinter</span><span class="p">:</span>

        <span class="c">#@+others</span>
        <span class="c">#@+node:ekr.20040711135244.6: *8* __init__ (PythonPrettyPrinter)</span>
        <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">array</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c"># List of strings comprising the line being accumulated.</span>
                <span class="c"># Important: this list never crosses a line.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bracketLevel</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">c</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dumping</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">erow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ecol</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># The ending row/col of the token.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lastName</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># The name of the previous token type.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">line</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># Same as self.srow</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lineParenLevel</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># List of lines.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parenLevel</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prevName</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># The string containing the line.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">squareBracketLevel</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">srow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scol</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># The starting row/col of the token.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startline</span> <span class="o">=</span> <span class="bp">True</span> <span class="c"># True: the token starts a line.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tracing</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="c">#@+&lt;&lt; define dispatch dict &gt;&gt;</span>
            <span class="c">#@+node:ekr.20041021100850: *9* &lt;&lt; define dispatch dict &gt;&gt;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dispatchDict</span> <span class="o">=</span> <span class="p">{</span>

                <span class="s">&quot;comment&quot;</span><span class="p">:</span>    <span class="bp">self</span><span class="o">.</span><span class="n">doMultiLine</span><span class="p">,</span>
                <span class="s">&quot;dedent&quot;</span><span class="p">:</span>     <span class="bp">self</span><span class="o">.</span><span class="n">doDedent</span><span class="p">,</span>
                <span class="s">&quot;endmarker&quot;</span><span class="p">:</span>  <span class="bp">self</span><span class="o">.</span><span class="n">doEndMarker</span><span class="p">,</span>
                <span class="s">&quot;errortoken&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">doErrorToken</span><span class="p">,</span>
                <span class="s">&quot;indent&quot;</span><span class="p">:</span>     <span class="bp">self</span><span class="o">.</span><span class="n">doIndent</span><span class="p">,</span>
                <span class="s">&quot;name&quot;</span><span class="p">:</span>       <span class="bp">self</span><span class="o">.</span><span class="n">doName</span><span class="p">,</span>
                <span class="s">&quot;newline&quot;</span><span class="p">:</span>    <span class="bp">self</span><span class="o">.</span><span class="n">doNewline</span><span class="p">,</span>
                <span class="s">&quot;nl&quot;</span> <span class="p">:</span>        <span class="bp">self</span><span class="o">.</span><span class="n">doNewline</span><span class="p">,</span>
                <span class="s">&quot;number&quot;</span><span class="p">:</span>     <span class="bp">self</span><span class="o">.</span><span class="n">doNumber</span><span class="p">,</span>
                <span class="s">&quot;op&quot;</span><span class="p">:</span>         <span class="bp">self</span><span class="o">.</span><span class="n">doOp</span><span class="p">,</span>
                <span class="s">&quot;string&quot;</span><span class="p">:</span>     <span class="bp">self</span><span class="o">.</span><span class="n">doMultiLine</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="c">#@-&lt;&lt; define dispatch dict &gt;&gt;</span>
        <span class="c">#@+node:ekr.20040713093048: *8* clear</span>
<div class="viewcode-block" id="Commands.PythonPrettyPrinter.clear"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.PythonPrettyPrinter.clear">[docs]</a>        <span class="k">def</span> <span class="nf">clear</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c">#@+node:ekr.20040713064323: *8* dumpLines</span></div>
<div class="viewcode-block" id="Commands.PythonPrettyPrinter.dumpLines"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.PythonPrettyPrinter.dumpLines">[docs]</a>        <span class="k">def</span> <span class="nf">dumpLines</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">lines</span><span class="p">):</span>

            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;-&#39;</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">cleanHeadString</span><span class="p">())</span>

            <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                    <span class="n">line2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="n">reportErrors</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="n">line2</span><span class="p">,</span><span class="n">newline</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="c"># Don&#39;t add a trailing newline!)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)):</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="n">reportErrors</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%3d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="c">#@+node:ekr.20040711135244.7: *8* dumpToken</span></div>
<div class="viewcode-block" id="Commands.PythonPrettyPrinter.dumpToken"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.PythonPrettyPrinter.dumpToken">[docs]</a>        <span class="k">def</span> <span class="nf">dumpToken</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">token5tuple</span><span class="p">):</span>

            <span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">t3</span><span class="p">,</span><span class="n">t4</span><span class="p">,</span><span class="n">t5</span> <span class="o">=</span> <span class="n">token5tuple</span>
            <span class="n">srow</span><span class="p">,</span><span class="n">scol</span> <span class="o">=</span> <span class="n">t3</span> <span class="p">;</span> <span class="n">erow</span><span class="p">,</span><span class="n">ecol</span> <span class="o">=</span> <span class="n">t4</span>
            <span class="n">line</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">t5</span><span class="p">)</span> <span class="c"># can fail</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">tok_name</span><span class="p">[</span><span class="n">t1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span> <span class="c"># can fail</span>

            <span class="n">startLine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line</span> <span class="o">!=</span> <span class="n">srow</span>
            <span class="k">if</span> <span class="n">startLine</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;----- line&quot;</span><span class="p">,</span><span class="n">srow</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">line</span> <span class="o">=</span> <span class="n">srow</span>

            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%10s</span><span class="s"> (</span><span class="si">%2d</span><span class="s">,</span><span class="si">%2d</span><span class="s">) </span><span class="si">%-8s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">scol</span><span class="p">,</span><span class="n">ecol</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
        <span class="c">#@+node:ekr.20040713091855: *8* endUndo</span></div>
<div class="viewcode-block" id="Commands.PythonPrettyPrinter.endUndo"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.PythonPrettyPrinter.endUndo">[docs]</a>        <span class="k">def</span> <span class="nf">endUndo</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">u</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">undoer</span> <span class="p">;</span> <span class="n">undoType</span> <span class="o">=</span> <span class="s">&#39;Pretty Print&#39;</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">:</span>
                <span class="c"># Tag the end of the command.</span>
                <span class="n">u</span><span class="o">.</span><span class="n">afterChangeGroup</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="n">undoType</span><span class="p">,</span><span class="n">dirtyVnodeList</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dirtyVnodeList</span><span class="p">)</span>
        <span class="c">#@+node:ekr.20040711135244.8: *8* get</span></div>
<div class="viewcode-block" id="Commands.PythonPrettyPrinter.get"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.PythonPrettyPrinter.get">[docs]</a>        <span class="k">def</span> <span class="nf">get</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastName</span> <span class="o">!=</span> <span class="s">&#39;newline&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">:</span>
                <span class="c"># Strip the trailing whitespace from the last line.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span>
        <span class="c">#@+node:ekr.20040711135244.4: *8* prettyPrintNode</span></div>
<div class="viewcode-block" id="Commands.PythonPrettyPrinter.prettyPrintNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.PythonPrettyPrinter.prettyPrintNode">[docs]</a>        <span class="k">def</span> <span class="nf">prettyPrintNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">dump</span><span class="p">):</span>

            <span class="c"># c = self.c</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span> <span class="k">return</span>

            <span class="n">readlines</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">readLinesClass</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">next</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">token5tuple</span> <span class="ow">in</span> <span class="n">tokenize</span><span class="o">.</span><span class="n">generate_tokens</span><span class="p">(</span><span class="n">readlines</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">putToken</span><span class="p">(</span><span class="n">token5tuple</span><span class="p">)</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

            <span class="k">except</span> <span class="n">tokenize</span><span class="o">.</span><span class="n">TokenError</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;error pretty-printing&quot;</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="s">&quot;not changed.&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="n">dump</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dumpLines</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">lines</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">replaceBody</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">lines</span><span class="p">)</span>
        <span class="c">#@+node:ekr.20040711135244.9: *8* put</span></div>
<div class="viewcode-block" id="Commands.PythonPrettyPrinter.put"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.PythonPrettyPrinter.put">[docs]</a>        <span class="k">def</span> <span class="nf">put</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">strip</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

            <span class="sd">&quot;&quot;&quot;Put s to self.array, and strip trailing whitespace if strip is True.&quot;&quot;&quot;</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span> <span class="ow">and</span> <span class="n">strip</span><span class="p">:</span>
                <span class="n">prev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">prev</span><span class="o">.</span><span class="n">rstrip</span><span class="p">():</span>
                        <span class="c"># Stripping trailing whitespace doesn&#39;t strip leading whitespace.</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">prev</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># The previous entry isn&#39;t leading whitespace, so we can strip whitespace.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">prev</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="c">#@+node:ekr.20041021104237: *8* putArray</span></div>
<div class="viewcode-block" id="Commands.PythonPrettyPrinter.putArray"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.PythonPrettyPrinter.putArray">[docs]</a>        <span class="k">def</span> <span class="nf">putArray</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="sd">&quot;&quot;&quot;Add the next text by joining all the strings is self.array&quot;&quot;&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">array</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lineParenLevel</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c">#@+node:ekr.20040711135244.10: *8* putNormalToken &amp; allies</span></div>
<div class="viewcode-block" id="Commands.PythonPrettyPrinter.putNormalToken"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.PythonPrettyPrinter.putNormalToken">[docs]</a>        <span class="k">def</span> <span class="nf">putNormalToken</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">token5tuple</span><span class="p">):</span>

            <span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">t3</span><span class="p">,</span><span class="n">t4</span><span class="p">,</span><span class="n">t5</span> <span class="o">=</span> <span class="n">token5tuple</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">tok_name</span><span class="p">[</span><span class="n">t1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="c"># The token type</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">t2</span>  <span class="c"># the token string</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">srow</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">scol</span> <span class="o">=</span> <span class="n">t3</span> <span class="c"># row &amp; col where the token begins in the source.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">erow</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ecol</span> <span class="o">=</span> <span class="n">t4</span> <span class="c"># row &amp; col where the token ends in the source.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">t5</span> <span class="c"># The line containing the token.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startLine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">srow</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">srow</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">startLine</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">doStartLine</span><span class="p">()</span>

            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatchDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">oops</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span>
            <span class="n">f</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lastName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="c">#@+node:ekr.20041021102938: *9* doEndMarker</span></div>
<div class="viewcode-block" id="Commands.PythonPrettyPrinter.doEndMarker"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.PythonPrettyPrinter.doEndMarker">[docs]</a>        <span class="k">def</span> <span class="nf">doEndMarker</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">putArray</span><span class="p">()</span>
        <span class="c">#@+node:ekr.20041021102340.1: *9* doErrorToken</span></div>
<div class="viewcode-block" id="Commands.PythonPrettyPrinter.doErrorToken"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.PythonPrettyPrinter.doErrorToken">[docs]</a>        <span class="k">def</span> <span class="nf">doErrorToken</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>

            <span class="c"># This code is executed for versions of Python earlier than 2.4</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">==</span> <span class="s">&#39;@&#39;</span><span class="p">:</span>
                <span class="c"># Preserve whitespace after @.</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">scol</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">ws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scol</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">ws</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span>
        <span class="c">#@+node:ekr.20041021102340.2: *9* doIndent &amp; doDedent</span></div>
<div class="viewcode-block" id="Commands.PythonPrettyPrinter.doDedent"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.PythonPrettyPrinter.doDedent">[docs]</a>        <span class="k">def</span> <span class="nf">doDedent</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="k">pass</span>
</div>
<div class="viewcode-block" id="Commands.PythonPrettyPrinter.doIndent"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.PythonPrettyPrinter.doIndent">[docs]</a>        <span class="k">def</span> <span class="nf">doIndent</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>
        <span class="c">#@+node:ekr.20041021102340: *9* doMultiLine (strings, etc).</span></div>
<div class="viewcode-block" id="Commands.PythonPrettyPrinter.doMultiLine"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.PythonPrettyPrinter.doMultiLine">[docs]</a>        <span class="k">def</span> <span class="nf">doMultiLine</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="c"># Ensure a blank before comments not preceded entirely by whitespace.</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
                <span class="n">prev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">prev</span> <span class="ow">and</span> <span class="n">prev</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39; &#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span> 

            <span class="c"># These may span lines, so duplicate the end-of-line logic.</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">putArray</span><span class="p">()</span>

            <span class="c"># Add a blank after the string if there is something in the last line.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span>

            <span class="c"># Suppress start-of-line logic.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">erow</span>
        <span class="c">#@+node:ekr.20041021101911.5: *9* doName</span></div>
<div class="viewcode-block" id="Commands.PythonPrettyPrinter.doName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.PythonPrettyPrinter.doName">[docs]</a>        <span class="k">def</span> <span class="nf">doName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="c"># Ensure whitespace or start-of-line precedes the name.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
                <span class="n">last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">ch</span> <span class="o">=</span> <span class="n">last</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">outer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parenLevel</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">squareBracketLevel</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="n">chars</span> <span class="o">=</span> <span class="s">&#39;@ </span><span class="se">\t</span><span class="s">{([.&#39;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">outer</span><span class="p">:</span> <span class="n">chars</span> <span class="o">+=</span> <span class="s">&#39;,=&lt;&gt;*-+&amp;|/&#39;</span>
                <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">chars</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> &quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prevName</span> <span class="o">==</span> <span class="s">&quot;def&quot;</span><span class="p">:</span> <span class="c"># A personal idiosyncracy.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span> <span class="c"># Retain the blank before &#39;(&#39;.</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">prevName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">val</span>
        <span class="c">#@+node:ekr.20041021101911.3: *9* doNewline</span></div>
<div class="viewcode-block" id="Commands.PythonPrettyPrinter.doNewline"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.PythonPrettyPrinter.doNewline">[docs]</a>        <span class="k">def</span> <span class="nf">doNewline</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="c"># Remove trailing whitespace.</span>
            <span class="c"># This never removes trailing whitespace from multi-line tokens.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">putArray</span><span class="p">()</span>
        <span class="c">#@+node:ekr.20041021101911.6: *9* doNumber</span></div>
<div class="viewcode-block" id="Commands.PythonPrettyPrinter.doNumber"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.PythonPrettyPrinter.doNumber">[docs]</a>        <span class="k">def</span> <span class="nf">doNumber</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>
        <span class="c">#@+node:ekr.20040711135244.11: *9* doOp</span></div>
<div class="viewcode-block" id="Commands.PythonPrettyPrinter.doOp"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.PythonPrettyPrinter.doOp">[docs]</a>        <span class="k">def</span> <span class="nf">doOp</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">val</span>
            <span class="n">outer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineParenLevel</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parenLevel</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">squareBracketLevel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="c"># New in Python 2.4: &#39;@&#39; is an operator, not an error token.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">==</span> <span class="s">&#39;@&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>
                <span class="c"># Preserve whitespace after @.</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">scol</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">ws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scol</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">ws</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">val</span> <span class="o">==</span> <span class="s">&#39;(&#39;</span><span class="p">:</span>
                <span class="c"># Nothing added; strip leading blank before function calls but not before Python keywords.</span>
                <span class="n">strip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastName</span><span class="o">==</span><span class="s">&#39;name&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">keyword</span><span class="o">.</span><span class="n">iskeyword</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prevName</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39;(&#39;</span><span class="p">,</span><span class="n">strip</span><span class="o">=</span><span class="n">strip</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parenLevel</span> <span class="o">+=</span> <span class="mi">1</span> <span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineParenLevel</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">,</span><span class="s">&#39;==&#39;</span><span class="p">,</span><span class="s">&#39;+=&#39;</span><span class="p">,</span><span class="s">&#39;-=&#39;</span><span class="p">,</span><span class="s">&#39;!=&#39;</span><span class="p">,</span><span class="s">&#39;&lt;=&#39;</span><span class="p">,</span><span class="s">&#39;&gt;=&#39;</span><span class="p">,</span><span class="s">&#39;&lt;&#39;</span><span class="p">,</span><span class="s">&#39;&gt;&#39;</span><span class="p">,</span><span class="s">&#39;&lt;&gt;&#39;</span><span class="p">,</span><span class="s">&#39;*&#39;</span><span class="p">,</span><span class="s">&#39;**&#39;</span><span class="p">,</span><span class="s">&#39;+&#39;</span><span class="p">,</span><span class="s">&#39;&amp;&#39;</span><span class="p">,</span><span class="s">&#39;|&#39;</span><span class="p">,</span><span class="s">&#39;/&#39;</span><span class="p">,</span><span class="s">&#39;//&#39;</span><span class="p">):</span>
                <span class="c"># Add leading and trailing blank in outer mode.</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">outer</span><span class="p">,</span><span class="s">&#39; </span><span class="si">%s</span><span class="s"> &#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">s</span> <span class="o">%</span> <span class="n">val</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;^&#39;</span><span class="p">,</span><span class="s">&#39;~&#39;</span><span class="p">,</span><span class="s">&#39;{&#39;</span><span class="p">,</span><span class="s">&#39;[&#39;</span><span class="p">):</span>
                <span class="c"># Add leading blank in outer mode.</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">outer</span><span class="p">,</span><span class="s">&#39; </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">s</span> <span class="o">%</span> <span class="n">val</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="s">&#39;[&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">squareBracketLevel</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span><span class="s">&#39;:&#39;</span><span class="p">,</span><span class="s">&#39;}&#39;</span><span class="p">,</span><span class="s">&#39;]&#39;</span><span class="p">,</span><span class="s">&#39;)&#39;</span><span class="p">):</span>
                <span class="c"># Add trailing blank in outer mode.</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">outer</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> &#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">s</span> <span class="o">%</span> <span class="n">val</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="s">&#39;]&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">squareBracketLevel</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="s">&#39;)&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">parenLevel</span> <span class="o">-=</span> <span class="mi">1</span> <span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineParenLevel</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="c"># ----- no difference between outer and inner modes ---</span>
            <span class="k">elif</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">,</span><span class="s">&#39;%&#39;</span><span class="p">):</span>
                <span class="c"># Add leading and trailing blank.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39; </span><span class="si">%s</span><span class="s"> &#39;</span> <span class="o">%</span> <span class="n">val</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">val</span> <span class="o">==</span> <span class="s">&#39;&gt;&gt;&#39;</span><span class="p">:</span>
                <span class="c"># Add leading blank.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39; </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">val</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">val</span> <span class="o">==</span> <span class="s">&#39;&lt;&lt;&#39;</span><span class="p">:</span>
                <span class="c"># Add trailing blank.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> &#39;</span> <span class="o">%</span> <span class="n">val</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">):</span>
                <span class="c"># Could be binary or unary.  Or could be a hyphen in a section name.</span>
                <span class="c"># Add preceding blank only for non-id&#39;s.</span>
                <span class="k">if</span> <span class="n">outer</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
                        <span class="n">prev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">prev</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">isWordChar</span><span class="p">(</span><span class="n">prev</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s">&#39; </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">val</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="c"># Try to leave whitespace unchanged.</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="c">#@+node:ekr.20041021112219: *9* doStartLine</span></div>
<div class="viewcode-block" id="Commands.PythonPrettyPrinter.doStartLine"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.PythonPrettyPrinter.doStartLine">[docs]</a>        <span class="k">def</span> <span class="nf">doStartLine</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="n">before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">scol</span><span class="p">]</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">before</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ws</span><span class="p">)</span>
        <span class="c">#@+node:ekr.20041021101911.1: *9* oops</span></div>
<div class="viewcode-block" id="Commands.PythonPrettyPrinter.oops"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.PythonPrettyPrinter.oops">[docs]</a>        <span class="k">def</span> <span class="nf">oops</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;unknown PrettyPrinting code: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="c">#@+node:ekr.20041021101911.2: *9* trace (PrettyPrint)</span></div>
<div class="viewcode-block" id="Commands.PythonPrettyPrinter.trace"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.PythonPrettyPrinter.trace">[docs]</a>        <span class="k">def</span> <span class="nf">trace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracing</span><span class="p">:</span>

                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%10s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="nb">repr</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val</span><span class="p">))</span>
                <span class="p">))</span>
        <span class="c">#@+node:ekr.20040711135244.12: *8* putToken</span></div>
<div class="viewcode-block" id="Commands.PythonPrettyPrinter.putToken"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.PythonPrettyPrinter.putToken">[docs]</a>        <span class="k">def</span> <span class="nf">putToken</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">token5tuple</span><span class="p">):</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dumping</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dumpToken</span><span class="p">(</span><span class="n">token5tuple</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">putNormalToken</span><span class="p">(</span><span class="n">token5tuple</span><span class="p">)</span>
        <span class="c">#@+node:ekr.20040713070356: *8* replaceBody</span></div>
<div class="viewcode-block" id="Commands.PythonPrettyPrinter.replaceBody"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.PythonPrettyPrinter.replaceBody">[docs]</a>        <span class="k">def</span> <span class="nf">replaceBody</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">lines</span><span class="p">):</span>

            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">u</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">undoer</span> <span class="p">;</span> <span class="n">undoType</span> <span class="o">=</span> <span class="s">&#39;Pretty Print&#39;</span>
            <span class="c"># sel = c.frame.body.getInsertPoint()</span>
            <span class="n">oldBody</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span>
            <span class="n">body</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">oldBody</span> <span class="o">!=</span> <span class="n">body</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">:</span>
                    <span class="c"># Start the group.</span>
                    <span class="n">u</span><span class="o">.</span><span class="n">beforeChangeGroup</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">undoType</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">undoData</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">beforeChangeNodeContents</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="n">c</span><span class="o">.</span><span class="n">setBodyString</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">body</span><span class="p">)</span>
                <span class="n">dirtyVnodeList2</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dirtyVnodeList</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">dirtyVnodeList2</span><span class="p">)</span>
                <span class="n">u</span><span class="o">.</span><span class="n">afterChangeNodeContents</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">undoType</span><span class="p">,</span><span class="n">undoData</span><span class="p">,</span><span class="n">dirtyVnodeList</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dirtyVnodeList</span><span class="p">)</span>
        <span class="c">#@-others</span>
    <span class="c">#@+node:ekr.20040712053025: *7* prettyPrintAllPythonCode</span></div></div>
<div class="viewcode-block" id="Commands.prettyPrintAllPythonCode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.prettyPrintAllPythonCode">[docs]</a>    <span class="k">def</span> <span class="nf">prettyPrintAllPythonCode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">dump</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Reformat all Python code in the outline to make it look more beautiful.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">pp</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">PythonPrettyPrinter</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">all_unique_positions</span><span class="p">():</span>

            <span class="c"># Unlike c.scanAllDirectives, scanForAtLanguage ignores @comment.</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">scanForAtLanguage</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;python&quot;</span><span class="p">:</span>
                <span class="n">pp</span><span class="o">.</span><span class="n">prettyPrintNode</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">dump</span><span class="o">=</span><span class="n">dump</span><span class="p">)</span>

        <span class="n">pp</span><span class="o">.</span><span class="n">endUndo</span><span class="p">()</span>

    <span class="c"># For unit test of inverse commands dict.</span></div>
<div class="viewcode-block" id="Commands.beautifyAllPythonCode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.beautifyAllPythonCode">[docs]</a>    <span class="k">def</span> <span class="nf">beautifyAllPythonCode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">dump</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Reformat all Python code in the outline.&#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prettyPrintAllPythonCode</span> <span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="n">dump</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20110917174948.6877: *7* beautifyCCode</span></div>
<div class="viewcode-block" id="Commands.beautifyCCode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.beautifyCCode">[docs]</a>    <span class="k">def</span> <span class="nf">beautifyCCode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Reformat all C code in the selected tree.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">CPrettyPrinter</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">undoer</span> <span class="p">;</span> <span class="n">undoType</span> <span class="o">=</span> <span class="s">&#39;beautify-c&#39;</span>

        <span class="n">u</span><span class="o">.</span><span class="n">beforeChangeGroup</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">,</span><span class="n">undoType</span><span class="p">)</span>
        <span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">self_and_subtree</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">scanForAtLanguage</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;c&quot;</span><span class="p">:</span>
                <span class="n">bunch</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">beforeChangeNodeContents</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">indent</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span> <span class="o">!=</span> <span class="n">s</span><span class="p">:</span>
                    <span class="c"># g.es(&#39;changed: %s&#39; % (p.h))</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">s</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span>
                    <span class="n">dirtyVnodeList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
                    <span class="n">u</span><span class="o">.</span><span class="n">afterChangeNodeContents</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">undoType</span><span class="p">,</span><span class="n">bunch</span><span class="p">)</span>
                    <span class="n">changed</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="n">changed</span><span class="p">:</span>
            <span class="n">u</span><span class="o">.</span><span class="n">afterChangeGroup</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">,</span><span class="n">undoType</span><span class="p">,</span>
                <span class="n">reportFlag</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">dirtyVnodeList</span><span class="o">=</span><span class="n">dirtyVnodeList</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">bodyWantsFocus</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20040712053025.1: *7* prettyPrintPythonCode</span></div>
<div class="viewcode-block" id="Commands.prettyPrintPythonCode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.prettyPrintPythonCode">[docs]</a>    <span class="k">def</span> <span class="nf">prettyPrintPythonCode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">dump</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Reformat all Python code in the selected tree.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">p</span><span class="p">:</span> <span class="n">root</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">root</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="n">pp</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">PythonPrettyPrinter</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">self_and_subtree</span><span class="p">():</span>

            <span class="c"># Unlike c.scanAllDirectives, scanForAtLanguage ignores @comment.</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">scanForAtLanguage</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;python&quot;</span><span class="p">:</span>

                <span class="n">pp</span><span class="o">.</span><span class="n">prettyPrintNode</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">dump</span><span class="o">=</span><span class="n">dump</span><span class="p">)</span>

        <span class="n">pp</span><span class="o">.</span><span class="n">endUndo</span><span class="p">()</span>

    <span class="c"># For unit test of inverse commands dict.</span></div>
<div class="viewcode-block" id="Commands.beautifyPythonCode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.beautifyPythonCode">[docs]</a>    <span class="k">def</span> <span class="nf">beautifyPythonCode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">dump</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Beautify all Python code in the selected tree.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prettyPrintPythonCode</span> <span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="n">dump</span><span class="p">)</span>

    <span class="c">#@+node:ekr.20050729211526: *7* prettyPrintPythonNode</span></div>
<div class="viewcode-block" id="Commands.prettyPrintPythonNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.prettyPrintPythonNode">[docs]</a>    <span class="k">def</span> <span class="nf">prettyPrintPythonNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">dump</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="n">pp</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">PythonPrettyPrinter</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="c"># Unlike c.scanAllDirectives, scanForAtLanguage ignores @comment.</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">scanForAtLanguage</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;python&quot;</span><span class="p">:</span>
            <span class="n">pp</span><span class="o">.</span><span class="n">prettyPrintNode</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">dump</span><span class="o">=</span><span class="n">dump</span><span class="p">)</span>

        <span class="n">pp</span><span class="o">.</span><span class="n">endUndo</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20071001075704: *7* prettyPrintPythonTree</span></div>
<div class="viewcode-block" id="Commands.prettyPrintPythonTree"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.prettyPrintPythonTree">[docs]</a>    <span class="k">def</span> <span class="nf">prettyPrintPythonTree</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">dump</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Beautify all Python code in the selected outline.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span> <span class="p">;</span> <span class="n">pp</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">PythonPrettyPrinter</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">self_and_subtree</span><span class="p">():</span>

            <span class="c"># Unlike c.scanAllDirectives, scanForAtLanguage ignores @comment.</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">scanForAtLanguage</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;python&quot;</span><span class="p">:</span>

                <span class="n">pp</span><span class="o">.</span><span class="n">prettyPrintNode</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">dump</span><span class="o">=</span><span class="n">dump</span><span class="p">)</span>

        <span class="n">pp</span><span class="o">.</span><span class="n">endUndo</span><span class="p">()</span>

    <span class="c"># For unit test of inverse commands dict.</span></div>
<div class="viewcode-block" id="Commands.beautifyPythonTree"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.beautifyPythonTree">[docs]</a>    <span class="k">def</span> <span class="nf">beautifyPythonTree</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">dump</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Beautify all Python code in the selected outline.&#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prettyPrintPythonTree</span> <span class="p">(</span><span class="n">event</span><span class="p">,</span><span class="n">dump</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2898: *5* Expand &amp; Contract...</span>
    <span class="c">#@+node:ekr.20031218072017.2899: *6* Commands (outline menu)</span>
    <span class="c">#@+node:ekr.20031218072017.2900: *7* contractAllHeadlines</span></div>
<div class="viewcode-block" id="Commands.contractAllHeadlines"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.contractAllHeadlines">[docs]</a>    <span class="k">def</span> <span class="nf">contractAllHeadlines</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Contract all nodes in the outline.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">all_unique_positions</span><span class="p">():</span>
            <span class="n">p</span><span class="o">.</span><span class="n">contract</span><span class="p">()</span>
        <span class="c"># Select the topmost ancestor of the presently selected node.</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="k">while</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">hasParent</span><span class="p">():</span>
            <span class="n">p</span><span class="o">.</span><span class="n">moveToParent</span><span class="p">()</span>

        <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">setFocus</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">expansionLevel</span> <span class="o">=</span> <span class="mi">1</span> <span class="c"># Reset expansion level.</span>
    <span class="c">#@+node:ekr.20080819075811.3: *7* contractAllOtherNodes &amp; helper</span></div>
<div class="viewcode-block" id="Commands.contractAllOtherNodes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.contractAllOtherNodes">[docs]</a>    <span class="k">def</span> <span class="nf">contractAllOtherNodes</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Contract all nodes except those needed to make the</span>
<span class="sd">        presently selected node visible.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">leaveOpen</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span><span class="o">.</span><span class="n">self_and_siblings</span><span class="p">():</span>
            <span class="n">c</span><span class="o">.</span><span class="n">contractIfNotCurrent</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">leaveOpen</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>

    <span class="c">#@+node:ekr.20080819075811.7: *8* contractIfNotCurrent</span></div>
<div class="viewcode-block" id="Commands.contractIfNotCurrent"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.contractIfNotCurrent">[docs]</a>    <span class="k">def</span> <span class="nf">contractIfNotCurrent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">leaveOpen</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="n">leaveOpen</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">isAncestorOf</span><span class="p">(</span><span class="n">leaveOpen</span><span class="p">):</span>
            <span class="n">p</span><span class="o">.</span><span class="n">contract</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">child</span> <span class="o">!=</span> <span class="n">leaveOpen</span> <span class="ow">and</span> <span class="n">child</span><span class="o">.</span><span class="n">isAncestorOf</span><span class="p">(</span><span class="n">leaveOpen</span><span class="p">):</span>
                <span class="n">c</span><span class="o">.</span><span class="n">contractIfNotCurrent</span><span class="p">(</span><span class="n">child</span><span class="p">,</span><span class="n">leaveOpen</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">p2</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">self_and_subtree</span><span class="p">():</span>
                    <span class="n">p2</span><span class="o">.</span><span class="n">contract</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.2901: *7* contractNode</span></div>
<div class="viewcode-block" id="Commands.contractNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.contractNode">[docs]</a>    <span class="k">def</span> <span class="nf">contractNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Contract the presently selected node.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="n">p</span><span class="o">.</span><span class="n">contract</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isCloned</span><span class="p">():</span>
            <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span> <span class="c"># A full redraw is necessary to handle clones.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">redraw_after_contract</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span><span class="n">setFocus</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20040930064232: *7* contractNodeOrGoToParent</span></div>
<div class="viewcode-block" id="Commands.contractNodeOrGoToParent"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.contractNodeOrGoToParent">[docs]</a>    <span class="k">def</span> <span class="nf">contractNodeOrGoToParent</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Simulate the left Arrow Key in folder of Windows Explorer.&quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="n">parent</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>
        <span class="n">redraw</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">hasChildren</span><span class="p">()</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">isExpanded</span><span class="p">():</span>
            <span class="n">c</span><span class="o">.</span><span class="n">contractNode</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">parent</span> <span class="ow">and</span> <span class="n">parent</span><span class="o">.</span><span class="n">isVisible</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
            <span class="c"># New in Leo 4.9.1: contract all children first.</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">collapse_on_lt_arrow</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">parent</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">isExpanded</span><span class="p">():</span>
                        <span class="n">child</span><span class="o">.</span><span class="n">contract</span><span class="p">()</span>
                        <span class="n">redraw</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">c</span><span class="o">.</span><span class="n">goToParent</span><span class="p">()</span>

        <span class="c"># This is a bit off-putting.</span>
        <span class="c"># elif not parent and not c.hoistStack:</span>
            <span class="c"># p = c.rootPosition()</span>
            <span class="c"># while p:</span>
                <span class="c"># if p.isExpanded():</span>
                    <span class="c"># p.contract()</span>
                    <span class="c"># redraw = True</span>
                <span class="c"># p.moveToNext()</span>

        <span class="k">if</span> <span class="n">redraw</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.2902: *7* contractParent</span></div>
<div class="viewcode-block" id="Commands.contractParent"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.contractParent">[docs]</a>    <span class="k">def</span> <span class="nf">contractParent</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Contract the parent of the presently selected node.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="n">parent</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">parent</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">parent</span><span class="o">.</span><span class="n">contract</span><span class="p">()</span>

        <span class="n">c</span><span class="o">.</span><span class="n">redraw_after_contract</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">parent</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2903: *7* expandAllHeadlines</span></div>
<div class="viewcode-block" id="Commands.expandAllHeadlines"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.expandAllHeadlines">[docs]</a>    <span class="k">def</span> <span class="nf">expandAllHeadlines</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Expand all headlines.</span>
<span class="sd">        Warning: this can take a long time for large outlines.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">p</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">expandSubtree</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">moveToNext</span><span class="p">()</span>

        <span class="n">c</span><span class="o">.</span><span class="n">redraw_after_expand</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">(),</span><span class="n">setFocus</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">expansionLevel</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># Reset expansion level.</span>
    <span class="c">#@+node:ekr.20031218072017.2904: *7* expandAllSubheads</span></div>
<div class="viewcode-block" id="Commands.expandAllSubheads"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.expandAllSubheads">[docs]</a>    <span class="k">def</span> <span class="nf">expandAllSubheads</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Expand all children of the presently selected node.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">child</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">firstChild</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">expandSubtree</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">child</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">expandSubtree</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
            <span class="n">child</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>

        <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">setFocus</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2905: *7* expandLevel1..9</span></div>
<div class="viewcode-block" id="Commands.expandLevel1"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.expandLevel1">[docs]</a>    <span class="k">def</span> <span class="nf">expandLevel1</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Expand the outline to level 1&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expandToLevel</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Commands.expandLevel2"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.expandLevel2">[docs]</a>    <span class="k">def</span> <span class="nf">expandLevel2</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Expand the outline to level 2&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expandToLevel</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Commands.expandLevel3"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.expandLevel3">[docs]</a>    <span class="k">def</span> <span class="nf">expandLevel3</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Expand the outline to level 3&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expandToLevel</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Commands.expandLevel4"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.expandLevel4">[docs]</a>    <span class="k">def</span> <span class="nf">expandLevel4</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Expand the outline to level 4&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expandToLevel</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Commands.expandLevel5"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.expandLevel5">[docs]</a>    <span class="k">def</span> <span class="nf">expandLevel5</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Expand the outline to level 5&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expandToLevel</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Commands.expandLevel6"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.expandLevel6">[docs]</a>    <span class="k">def</span> <span class="nf">expandLevel6</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Expand the outline to level 6&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expandToLevel</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Commands.expandLevel7"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.expandLevel7">[docs]</a>    <span class="k">def</span> <span class="nf">expandLevel7</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Expand the outline to level 7&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expandToLevel</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Commands.expandLevel8"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.expandLevel8">[docs]</a>    <span class="k">def</span> <span class="nf">expandLevel8</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Expand the outline to level 8&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expandToLevel</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Commands.expandLevel9"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.expandLevel9">[docs]</a>    <span class="k">def</span> <span class="nf">expandLevel9</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Expand the outline to level 9&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expandToLevel</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2906: *7* expandNextLevel</span></div>
<div class="viewcode-block" id="Commands.expandNextLevel"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.expandNextLevel">[docs]</a>    <span class="k">def</span> <span class="nf">expandNextLevel</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Increase the expansion level of the outline and</span>
<span class="sd">        Expand all nodes at that level or lower.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">v</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">currentVnode</span><span class="p">()</span>

        <span class="c"># Expansion levels are now local to a particular tree.</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">expansionNode</span> <span class="o">!=</span> <span class="n">v</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">expansionLevel</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">c</span><span class="o">.</span><span class="n">expansionNode</span> <span class="o">=</span> <span class="n">v</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">expandToLevel</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">expansionLevel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2907: *7* expandNode</span></div>
<div class="viewcode-block" id="Commands.expandNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.expandNode">[docs]</a>    <span class="k">def</span> <span class="nf">expandNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Expand the presently selected node.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="n">p</span><span class="o">.</span><span class="n">expand</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isCloned</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;***redraw&#39;</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span> <span class="c"># Bug fix: 2009/10/03.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">redraw_after_expand</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">setFocus</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c">#@+node:ekr.20040930064232.1: *7* expandNodeAnd/OrGoToFirstChild</span></div>
<div class="viewcode-block" id="Commands.expandNodeAndGoToFirstChild"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.expandNodeAndGoToFirstChild">[docs]</a>    <span class="k">def</span> <span class="nf">expandNodeAndGoToFirstChild</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;If a node has children, expand it if needed and go to the first child.&quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">hasChildren</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isExpanded</span><span class="p">():</span>
                <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">firstChild</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">expandNode</span><span class="p">()</span>
                <span class="c"># Fix bug 930726</span>
                <span class="c"># expandNodeAndGoToFirstChild only expands or only goes to first child .</span>
                <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">firstChild</span><span class="p">())</span>

        <span class="n">c</span><span class="o">.</span><span class="n">treeFocusHelper</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Commands.expandNodeOrGoToFirstChild"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.expandNodeOrGoToFirstChild">[docs]</a>    <span class="k">def</span> <span class="nf">expandNodeOrGoToFirstChild</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Simulate the Right Arrow Key in folder of Windows Explorer.&quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">hasChildren</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">isExpanded</span><span class="p">():</span>
                <span class="n">c</span><span class="o">.</span><span class="n">expandNode</span><span class="p">()</span> <span class="c"># Calls redraw_after_expand.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">redraw_after_expand</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">firstChild</span><span class="p">(),</span><span class="n">setFocus</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20060928062431: *7* expandOnlyAncestorsOfNode</span></div>
<div class="viewcode-block" id="Commands.expandOnlyAncestorsOfNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.expandOnlyAncestorsOfNode">[docs]</a>    <span class="k">def</span> <span class="nf">expandOnlyAncestorsOfNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Contract all nodes in the outline.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">level</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">all_unique_positions</span><span class="p">():</span>
            <span class="n">p</span><span class="o">.</span><span class="n">contract</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">parents</span><span class="p">():</span>
            <span class="n">p</span><span class="o">.</span><span class="n">expand</span><span class="p">()</span>
            <span class="n">level</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">(</span><span class="n">setFocus</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">expansionLevel</span> <span class="o">=</span> <span class="n">level</span> <span class="c"># Reset expansion level.</span>
    <span class="c">#@+node:ekr.20031218072017.2908: *7* expandPrevLevel</span></div>
<div class="viewcode-block" id="Commands.expandPrevLevel"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.expandPrevLevel">[docs]</a>    <span class="k">def</span> <span class="nf">expandPrevLevel</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Decrease the expansion level of the outline and</span>
<span class="sd">        Expand all nodes at that level or lower.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">v</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">currentVnode</span><span class="p">()</span>

        <span class="c"># Expansion levels are now local to a particular tree.</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">expansionNode</span> <span class="o">!=</span> <span class="n">v</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">expansionLevel</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">c</span><span class="o">.</span><span class="n">expansionNode</span> <span class="o">=</span> <span class="n">v</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">expandToLevel</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">expansionLevel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20031218072017.2909: *6* Utilities</span>
    <span class="c">#@+node:ekr.20031218072017.2910: *7* contractSubtree</span></div>
<div class="viewcode-block" id="Commands.contractSubtree"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.contractSubtree">[docs]</a>    <span class="k">def</span> <span class="nf">contractSubtree</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">subtree</span><span class="p">():</span>
            <span class="n">p</span><span class="o">.</span><span class="n">contract</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.2911: *7* expandSubtree</span></div>
<div class="viewcode-block" id="Commands.expandSubtree"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.expandSubtree">[docs]</a>    <span class="k">def</span> <span class="nf">expandSubtree</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">v</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">lastNode</span><span class="p">()</span>

        <span class="k">while</span> <span class="n">v</span> <span class="ow">and</span> <span class="n">v</span> <span class="o">!=</span> <span class="n">last</span><span class="p">:</span>
            <span class="n">v</span><span class="o">.</span><span class="n">expand</span><span class="p">()</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">threadNext</span><span class="p">()</span>

        <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.2912: *7* expandToLevel (rewritten in 4.4)</span></div>
<div class="viewcode-block" id="Commands.expandToLevel"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.expandToLevel">[docs]</a>    <span class="k">def</span> <span class="nf">expandToLevel</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">level</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">level</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">current</span><span class="o">.</span><span class="n">self_and_subtree</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">level</span><span class="p">()</span> <span class="o">-</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">level</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">expand</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">contract</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">expansionLevel</span> <span class="o">=</span> <span class="n">level</span>
        <span class="n">c</span><span class="o">.</span><span class="n">expansionNode</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.2922: *5* Mark...</span>
    <span class="c">#@+node:ekr.20090905110447.6098: *6* c.cloneMarked</span></div>
<div class="viewcode-block" id="Commands.cloneMarked"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.cloneMarked">[docs]</a>    <span class="k">def</span> <span class="nf">cloneMarked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Clone all marked nodes as children of a new node.&quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">u</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">undoer</span> <span class="p">;</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c"># Create a new node to hold clones.</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">p1</span><span class="o">.</span><span class="n">insertAfter</span><span class="p">()</span>
        <span class="n">parent</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="s">&#39;Clones of marked nodes&#39;</span>

        <span class="n">moved</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">p</span> <span class="o">=</span> <span class="p">[],</span><span class="mi">0</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">p</span><span class="p">:</span>
            <span class="c"># Careful: don&#39;t clone already-cloned nodes.</span>
            <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="n">parent</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">isMarked</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="ow">in</span> <span class="n">moved</span><span class="p">:</span>
                <span class="n">moved</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
                <span class="c"># Moving the clone leaves position p unchanged.</span>
                <span class="n">p</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">moveToLastChildOf</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span>
                <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">parent</span><span class="o">.</span><span class="n">expand</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
            <span class="n">u</span><span class="o">.</span><span class="n">afterCloneMarkedNodes</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parent</span><span class="o">.</span><span class="n">doDelete</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&#39;cloned </span><span class="si">%s</span><span class="s"> nodes&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">))</span>
        <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>    
    <span class="c">#@+node:ekr.20111005081134.15540: *6* c.deleteMarked</span></div>
<div class="viewcode-block" id="Commands.deleteMarked"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.deleteMarked">[docs]</a>    <span class="k">def</span> <span class="nf">deleteMarked</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Delete all marked nodes.&quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">u</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">undoer</span> <span class="p">;</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">undo_data</span><span class="p">,</span><span class="n">p</span> <span class="o">=</span> <span class="p">[],</span><span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">p</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isMarked</span><span class="p">():</span>
                <span class="n">undo_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
                <span class="nb">next</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">positionAfterDeletedTree</span><span class="p">()</span>
                <span class="n">p</span><span class="o">.</span><span class="n">doDelete</span><span class="p">()</span>
                <span class="n">p</span> <span class="o">=</span> <span class="nb">next</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">undo_data</span><span class="p">:</span>
            <span class="n">u</span><span class="o">.</span><span class="n">afterDeleteMarkedNodes</span><span class="p">(</span><span class="n">undo_data</span><span class="p">,</span><span class="n">p1</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&#39;deleted </span><span class="si">%s</span><span class="s"> nodes&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">undo_data</span><span class="p">)))</span>
            <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

        <span class="c"># Don&#39;t even *think* about restoring the old position.</span>
        <span class="n">c</span><span class="o">.</span><span class="n">contractAllHeadlines</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">())</span>
        <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>    
    <span class="c">#@+node:ekr.20111005081134.15539: *6* c.moveMarked &amp; helper</span></div>
<div class="viewcode-block" id="Commands.moveMarked"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.moveMarked">[docs]</a>    <span class="k">def</span> <span class="nf">moveMarked</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Move all marked nodes as children of parent position.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">u</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">undoer</span> <span class="p">;</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c"># Check for marks.</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">all_unique_nodes</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">isMarked</span><span class="p">():</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;no marked nodes&#39;</span><span class="p">)</span>

        <span class="c"># Create a new root node to hold the moved nodes.</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">createMoveMarkedNode</span><span class="p">()</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">parent</span><span class="o">.</span><span class="n">isMarked</span><span class="p">()</span>

        <span class="n">undo_data</span><span class="p">,</span><span class="n">p</span> <span class="o">=</span> <span class="p">[],</span><span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">p</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">parent</span> <span class="o">==</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span>
            <span class="c"># Careful: don&#39;t move already-moved nodes.</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isMarked</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">parent</span><span class="o">.</span><span class="n">isAncestorOf</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                <span class="n">undo_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
                <span class="nb">next</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">positionAfterDeletedTree</span><span class="p">()</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToLastChildOf</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
                <span class="n">p</span> <span class="o">=</span> <span class="nb">next</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">undo_data</span><span class="p">:</span>
            <span class="n">u</span><span class="o">.</span><span class="n">afterMoveMarkedNodes</span><span class="p">(</span><span class="n">undo_data</span><span class="p">,</span><span class="n">p1</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&#39;moved </span><span class="si">%s</span><span class="s"> nodes&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">undo_data</span><span class="p">)))</span>
            <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

        <span class="c"># Don&#39;t even *think* about restoring the old position.</span>
        <span class="n">c</span><span class="o">.</span><span class="n">contractAllHeadlines</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>    
    <span class="c">#@+node:ekr.20111005081134.15543: *7* createMoveMarkedNode</span></div>
<div class="viewcode-block" id="Commands.createMoveMarkedNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.createMoveMarkedNode">[docs]</a>    <span class="k">def</span> <span class="nf">createMoveMarkedNode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">oldRoot</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">oldRoot</span><span class="o">.</span><span class="n">insertAfter</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">moveToRoot</span><span class="p">(</span><span class="n">oldRoot</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">setHeadString</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s">&#39;Moved marked nodes&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">p</span>
    <span class="c">#@+node:ekr.20031218072017.2923: *6* markChangedHeadlines</span></div>
<div class="viewcode-block" id="Commands.markChangedHeadlines"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.markChangedHeadlines">[docs]</a>    <span class="k">def</span> <span class="nf">markChangedHeadlines</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Mark all nodes that have been changed.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">u</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">undoer</span> <span class="p">;</span> <span class="n">undoType</span> <span class="o">=</span> <span class="s">&#39;Mark Changed&#39;</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span>
        <span class="n">u</span><span class="o">.</span><span class="n">beforeChangeGroup</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="n">undoType</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">all_unique_positions</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isDirty</span><span class="p">()</span><span class="ow">and</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">isMarked</span><span class="p">():</span>
                <span class="n">bunch</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">beforeMark</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">undoType</span><span class="p">)</span>
                <span class="n">c</span><span class="o">.</span><span class="n">setMarked</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">u</span><span class="o">.</span><span class="n">afterMark</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">undoType</span><span class="p">,</span><span class="n">bunch</span><span class="p">)</span>
        <span class="n">u</span><span class="o">.</span><span class="n">afterChangeGroup</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="n">undoType</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&#39;done&#39;</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">redraw_after_icons_changed</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.2924: *6* markChangedRoots</span></div>
<div class="viewcode-block" id="Commands.markChangedRoots"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.markChangedRoots">[docs]</a>    <span class="k">def</span> <span class="nf">markChangedRoots</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Mark all changed @root nodes.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">u</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">undoer</span> <span class="p">;</span> <span class="n">undoType</span> <span class="o">=</span> <span class="s">&#39;Mark Changed&#39;</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span>
        <span class="n">u</span><span class="o">.</span><span class="n">beforeChangeGroup</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="n">undoType</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">all_unique_positions</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isDirty</span><span class="p">()</span><span class="ow">and</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">isMarked</span><span class="p">():</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span>
                <span class="n">flag</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">is_special</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;@root&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                    <span class="n">bunch</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">beforeMark</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">undoType</span><span class="p">)</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">setMarked</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                    <span class="n">u</span><span class="o">.</span><span class="n">afterMark</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">undoType</span><span class="p">,</span><span class="n">bunch</span><span class="p">)</span>
        <span class="n">u</span><span class="o">.</span><span class="n">afterChangeGroup</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="n">undoType</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&#39;done&#39;</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">redraw_after_icons_changed</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.2925: *6* markAllAtFileNodesDirty</span></div>
<div class="viewcode-block" id="Commands.markAllAtFileNodesDirty"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.markAllAtFileNodesDirty">[docs]</a>    <span class="k">def</span> <span class="nf">markAllAtFileNodesDirty</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Mark all @file nodes as changed.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span>

        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">p</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtFileNode</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">isDirty</span><span class="p">():</span>
                <span class="n">p</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span>
                <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>

        <span class="n">c</span><span class="o">.</span><span class="n">redraw_after_icons_changed</span><span class="p">()</span>

    <span class="c">#@+node:ekr.20031218072017.2926: *6* markAtFileNodesDirty</span></div>
<div class="viewcode-block" id="Commands.markAtFileNodesDirty"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.markAtFileNodesDirty">[docs]</a>    <span class="k">def</span> <span class="nf">markAtFileNodesDirty</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Mark all @file nodes in the selected tree as changed.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span>
        <span class="n">after</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">nodeAfterTree</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">after</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtFileNode</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">isDirty</span><span class="p">():</span>
                <span class="n">p</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span>
                <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>

        <span class="n">c</span><span class="o">.</span><span class="n">redraw_after_icons_changed</span><span class="p">()</span>

    <span class="c">#@+node:ekr.20031218072017.2928: *6* markHeadline</span></div>
<div class="viewcode-block" id="Commands.markHeadline"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.markHeadline">[docs]</a>    <span class="k">def</span> <span class="nf">markHeadline</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Toggle the mark of the selected node.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">u</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">undoer</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span>
        <span class="n">undoType</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">isMarked</span><span class="p">(),</span><span class="s">&#39;Unmark&#39;</span><span class="p">,</span><span class="s">&#39;Mark&#39;</span><span class="p">)</span>
        <span class="n">bunch</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">beforeMark</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">undoType</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isMarked</span><span class="p">():</span>
            <span class="n">c</span><span class="o">.</span><span class="n">clearMarked</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">setMarked</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">u</span><span class="o">.</span><span class="n">afterMark</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">undoType</span><span class="p">,</span><span class="n">bunch</span><span class="p">,</span><span class="n">dirtyVnodeList</span><span class="o">=</span><span class="n">dirtyVnodeList</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">redraw_after_icons_changed</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.2929: *6* markSubheads</span></div>
<div class="viewcode-block" id="Commands.markSubheads"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.markSubheads">[docs]</a>    <span class="k">def</span> <span class="nf">markSubheads</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Mark all children of the selected node as changed.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">u</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">undoer</span> <span class="p">;</span> <span class="n">undoType</span> <span class="o">=</span> <span class="s">&#39;Mark Subheads&#39;</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">current</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span>
        <span class="n">u</span><span class="o">.</span><span class="n">beforeChangeGroup</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="n">undoType</span><span class="p">)</span>
        <span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">current</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">isMarked</span><span class="p">():</span>
                <span class="n">bunch</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">beforeMark</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">undoType</span><span class="p">)</span>
                <span class="n">c</span><span class="o">.</span><span class="n">setMarked</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="n">dirtyVnodeList2</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span>
                <span class="n">dirtyVnodeList</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">dirtyVnodeList2</span><span class="p">)</span>
                <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">u</span><span class="o">.</span><span class="n">afterMark</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">undoType</span><span class="p">,</span><span class="n">bunch</span><span class="p">)</span>
        <span class="n">u</span><span class="o">.</span><span class="n">afterChangeGroup</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="n">undoType</span><span class="p">,</span><span class="n">dirtyVnodeList</span><span class="o">=</span><span class="n">dirtyVnodeList</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">redraw_after_icons_changed</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.2930: *6* unmarkAll</span></div>
<div class="viewcode-block" id="Commands.unmarkAll"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.unmarkAll">[docs]</a>    <span class="k">def</span> <span class="nf">unmarkAll</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Unmark all nodes in the entire outline.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">u</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">undoer</span> <span class="p">;</span> <span class="n">undoType</span> <span class="o">=</span> <span class="s">&#39;Unmark All&#39;</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">current</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span>
        <span class="n">u</span><span class="o">.</span><span class="n">beforeChangeGroup</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="n">undoType</span><span class="p">)</span>
        <span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">all_unique_positions</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isMarked</span><span class="p">():</span>
                <span class="n">bunch</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">beforeMark</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">undoType</span><span class="p">)</span>
                <span class="c"># c.clearMarked(p) # Very slow: calls a hook.</span>
                <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">clearMarked</span><span class="p">()</span>
                <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span>
                <span class="n">u</span><span class="o">.</span><span class="n">afterMark</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">undoType</span><span class="p">,</span><span class="n">bunch</span><span class="p">)</span>
                <span class="n">changed</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">all_unique_positions</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">isDirty</span><span class="p">()]</span>
        <span class="k">if</span> <span class="n">changed</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&quot;clear-all-marks&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">u</span><span class="o">.</span><span class="n">afterChangeGroup</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="n">undoType</span><span class="p">,</span><span class="n">dirtyVnodeList</span><span class="o">=</span><span class="n">dirtyVnodeList</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">redraw_after_icons_changed</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.1766: *5* Move... (Commands)</span>
    <span class="c">#@+node:ekr.20070420092425: *6* cantMoveMessage</span></div>
<div class="viewcode-block" id="Commands.cantMoveMessage"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.cantMoveMessage">[docs]</a>    <span class="k">def</span> <span class="nf">cantMoveMessage</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">h</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span><span class="o">.</span><span class="n">h</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@chapter&#39;</span><span class="p">),</span><span class="s">&#39;chapter&#39;</span><span class="p">,</span><span class="s">&#39;hoist&#39;</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;can&#39;t move node out of&quot;</span><span class="p">,</span><span class="n">kind</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.1767: *6* demote</span></div>
<div class="viewcode-block" id="Commands.demote"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.demote">[docs]</a>    <span class="k">def</span> <span class="nf">demote</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Make all following siblings children of the selected node.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">u</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">undoer</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">hasNext</span><span class="p">():</span>
            <span class="n">c</span><span class="o">.</span><span class="n">treeFocusHelper</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="c"># Make sure all the moves will be valid.</span>
        <span class="nb">next</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="k">while</span> <span class="nb">next</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">checkMoveWithParentWithWarning</span><span class="p">(</span><span class="nb">next</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="bp">True</span><span class="p">):</span>
                <span class="n">c</span><span class="o">.</span><span class="n">treeFocusHelper</span><span class="p">()</span>
                <span class="k">return</span>
            <span class="nb">next</span><span class="o">.</span><span class="n">moveToNext</span><span class="p">()</span>

        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span>
        <span class="n">parent_v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">_parentVnode</span><span class="p">()</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">childIndex</span><span class="p">()</span>
        <span class="n">followingSibs</span> <span class="o">=</span> <span class="n">parent_v</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
        <span class="c"># g.trace(&#39;sibs2\n&#39;,g.listToString(followingSibs2))</span>

        <span class="c"># Remove the moved nodes from the parent&#39;s children.</span>
        <span class="n">parent_v</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="n">parent_v</span><span class="o">.</span><span class="n">children</span><span class="p">[:</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="c"># Add the moved nodes to p&#39;s children</span>
        <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">followingSibs</span><span class="p">)</span>
        <span class="c"># Adjust the parent links in the moved nodes.</span>
        <span class="c"># There is no need to adjust descendant links.</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">followingSibs</span><span class="p">:</span>
            <span class="n">child</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">parent_v</span><span class="p">)</span>
            <span class="n">child</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>

        <span class="n">p</span><span class="o">.</span><span class="n">expand</span><span class="p">()</span>
        <span class="c"># Even if p is an @ignore node there is no need to mark the demoted children dirty.</span>
        <span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">setAllAncestorAtFileNodesDirty</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">u</span><span class="o">.</span><span class="n">afterDemote</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">followingSibs</span><span class="p">,</span><span class="n">dirtyVnodeList</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">setFocus</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">updateSyntaxColorer</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="c"># Moving can change syntax coloring.</span>
    <span class="c">#@+node:ekr.20031218072017.1768: *6* moveOutlineDown</span>
    <span class="c">#@+at</span>
    <span class="c"># Moving down is more tricky than moving up; we can&#39;t move p to be a child of</span>
    <span class="c"># itself. An important optimization: we don&#39;t have to call</span>
    <span class="c"># checkMoveWithParentWithWarning() if the parent of the moved node remains the</span>
    <span class="c"># same.</span>
    <span class="c">#@@c</span>
</div>
<div class="viewcode-block" id="Commands.moveOutlineDown"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.moveOutlineDown">[docs]</a>    <span class="k">def</span> <span class="nf">moveOutlineDown</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Move the selected node down.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">u</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">undoer</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span> <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">canMoveOutlineDown</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">hoistStack</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cantMoveMessage</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">treeFocusHelper</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="n">inAtIgnoreRange</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">inAtIgnoreRange</span><span class="p">()</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>
        <span class="nb">next</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">visNext</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="k">while</span> <span class="nb">next</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">isAncestorOf</span><span class="p">(</span><span class="nb">next</span><span class="p">):</span>
            <span class="nb">next</span> <span class="o">=</span> <span class="nb">next</span><span class="o">.</span><span class="n">visNext</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">next</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">hoistStack</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cantMoveMessage</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">treeFocusHelper</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span>
        <span class="n">undoData</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">beforeMoveNode</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="c">#@+&lt;&lt; Move p down &amp; set moved if successful &gt;&gt;</span>
        <span class="c">#@+node:ekr.20031218072017.1769: *7* &lt;&lt; Move p down &amp; set moved if successful &gt;&gt;</span>
        <span class="k">if</span> <span class="nb">next</span><span class="o">.</span><span class="n">hasChildren</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">next</span><span class="o">.</span><span class="n">isExpanded</span><span class="p">():</span>
            <span class="c"># Attempt to move p to the first child of next.</span>
            <span class="n">moved</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">checkMoveWithParentWithWarning</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="nb">next</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">moved</span><span class="p">:</span>
                <span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">setAllAncestorAtFileNodesDirty</span><span class="p">()</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToNthChildOf</span><span class="p">(</span><span class="nb">next</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Attempt to move p after next.</span>
            <span class="n">moved</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">checkMoveWithParentWithWarning</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="nb">next</span><span class="o">.</span><span class="n">parent</span><span class="p">(),</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">moved</span><span class="p">:</span>
                <span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">setAllAncestorAtFileNodesDirty</span><span class="p">()</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveAfter</span><span class="p">(</span><span class="nb">next</span><span class="p">)</span>

        <span class="c"># Patch by nh2: 0004-Add-bool-collapse_nodes_after_move-option.patch</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">collapse_nodes_after_move</span> <span class="ow">and</span> <span class="n">moved</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">sparse_move</span> <span class="ow">and</span> <span class="n">parent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">parent</span><span class="o">.</span><span class="n">isAncestorOf</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="c"># New in Leo 4.4.2: contract the old parent if it is no longer the parent of p.</span>
            <span class="n">parent</span><span class="o">.</span><span class="n">contract</span><span class="p">()</span>
        <span class="c">#@-&lt;&lt; Move p down &amp; set moved if successful &gt;&gt;</span>
        <span class="k">if</span> <span class="n">moved</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">inAtIgnoreRange</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">inAtIgnoreRange</span><span class="p">():</span>
                <span class="c"># The moved nodes have just become newly unignored.</span>
                <span class="n">p</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span> <span class="c"># Mark descendent @thin nodes dirty.</span>
            <span class="k">else</span><span class="p">:</span> <span class="c"># No need to mark descendents dirty.</span>
                <span class="n">dirtyVnodeList2</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">setAllAncestorAtFileNodesDirty</span><span class="p">()</span>
                <span class="n">dirtyVnodeList</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">dirtyVnodeList2</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">u</span><span class="o">.</span><span class="n">afterMoveNode</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s">&#39;Move Down&#39;</span><span class="p">,</span><span class="n">undoData</span><span class="p">,</span><span class="n">dirtyVnodeList</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">setFocus</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">updateSyntaxColorer</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="c"># Moving can change syntax coloring.</span>
    <span class="c">#@+node:ekr.20031218072017.1770: *6* moveOutlineLeft</span></div>
<div class="viewcode-block" id="Commands.moveOutlineLeft"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.moveOutlineLeft">[docs]</a>    <span class="k">def</span> <span class="nf">moveOutlineLeft</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Move the selected node left if possible.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">u</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">undoer</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">canMoveOutlineLeft</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">hoistStack</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cantMoveMessage</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">treeFocusHelper</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">hasParent</span><span class="p">():</span>
            <span class="n">c</span><span class="o">.</span><span class="n">treeFocusHelper</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="n">inAtIgnoreRange</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">inAtIgnoreRange</span><span class="p">()</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span>
        <span class="n">undoData</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">beforeMoveNode</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">setAllAncestorAtFileNodesDirty</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">moveAfter</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inAtIgnoreRange</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">inAtIgnoreRange</span><span class="p">():</span>
            <span class="c"># The moved nodes have just become newly unignored.</span>
            <span class="n">p</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span> <span class="c"># Mark descendent @thin nodes dirty.</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># No need to mark descendents dirty.</span>
            <span class="n">dirtyVnodeList2</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">setAllAncestorAtFileNodesDirty</span><span class="p">()</span>
            <span class="n">dirtyVnodeList</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">dirtyVnodeList2</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">u</span><span class="o">.</span><span class="n">afterMoveNode</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s">&#39;Move Left&#39;</span><span class="p">,</span><span class="n">undoData</span><span class="p">,</span><span class="n">dirtyVnodeList</span><span class="p">)</span>

        <span class="c"># Patch by nh2: 0004-Add-bool-collapse_nodes_after_move-option.patch</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">collapse_nodes_after_move</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">sparse_move</span><span class="p">:</span> <span class="c"># New in Leo 4.4.2</span>
            <span class="n">parent</span><span class="o">.</span><span class="n">contract</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">redraw_now</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">setFocus</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">recolor_now</span><span class="p">()</span> <span class="c"># Moving can change syntax coloring.</span>
    <span class="c">#@+node:ekr.20031218072017.1771: *6* moveOutlineRight</span></div>
<div class="viewcode-block" id="Commands.moveOutlineRight"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.moveOutlineRight">[docs]</a>    <span class="k">def</span> <span class="nf">moveOutlineRight</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Move the selected node right if possible.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">u</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">undoer</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">canMoveOutlineRight</span><span class="p">():</span> <span class="c"># 11/4/03: Support for hoist.</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">hoistStack</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cantMoveMessage</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">treeFocusHelper</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="n">back</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">back</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">back</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">treeFocusHelper</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">checkMoveWithParentWithWarning</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">back</span><span class="p">,</span><span class="bp">True</span><span class="p">):</span>
            <span class="n">c</span><span class="o">.</span><span class="n">treeFocusHelper</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span>
        <span class="n">undoData</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">beforeMoveNode</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">setAllAncestorAtFileNodesDirty</span><span class="p">()</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">back</span><span class="o">.</span><span class="n">numberOfChildren</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">moveToNthChildOf</span><span class="p">(</span><span class="n">back</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="c"># Moving an outline right can never bring it outside the range of @ignore.</span>
        <span class="n">dirtyVnodeList2</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">setAllAncestorAtFileNodesDirty</span><span class="p">()</span>
        <span class="n">dirtyVnodeList</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">dirtyVnodeList2</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">u</span><span class="o">.</span><span class="n">afterMoveNode</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s">&#39;Move Right&#39;</span><span class="p">,</span><span class="n">undoData</span><span class="p">,</span><span class="n">dirtyVnodeList</span><span class="p">)</span>
        <span class="c"># g.trace(p)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">redraw_now</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">setFocus</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">recolor_now</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.1772: *6* moveOutlineUp</span></div>
<div class="viewcode-block" id="Commands.moveOutlineUp"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.moveOutlineUp">[docs]</a>    <span class="k">def</span> <span class="nf">moveOutlineUp</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Move the selected node up if possible.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">u</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">undoer</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">canMoveOutlineUp</span><span class="p">():</span> <span class="c"># Support for hoist.</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">hoistStack</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cantMoveMessage</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">treeFocusHelper</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="n">back</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">visBack</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">back</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;no visBack&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">inAtIgnoreRange</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">inAtIgnoreRange</span><span class="p">()</span>
        <span class="n">back2</span> <span class="o">=</span> <span class="n">back</span><span class="o">.</span><span class="n">visBack</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span>
        <span class="n">undoData</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">beforeMoveNode</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">setAllAncestorAtFileNodesDirty</span><span class="p">()</span>
        <span class="n">moved</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c">#@+&lt;&lt; Move p up &gt;&gt;</span>
        <span class="c">#@+node:ekr.20031218072017.1773: *7* &lt;&lt; Move p up &gt;&gt;</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&quot;visBack&quot;</span><span class="p">,</span><span class="n">back</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&quot;visBack2&quot;</span><span class="p">,</span><span class="n">back2</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&quot;back2.hasChildren&quot;</span><span class="p">,</span><span class="n">back2</span> <span class="ow">and</span> <span class="n">back2</span><span class="o">.</span><span class="n">hasChildren</span><span class="p">())</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&quot;back2.isExpanded&quot;</span><span class="p">,</span><span class="n">back2</span> <span class="ow">and</span> <span class="n">back2</span><span class="o">.</span><span class="n">isExpanded</span><span class="p">())</span>

        <span class="n">parent</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">back2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">hoistStack</span><span class="p">:</span> <span class="c"># hoist or chapter.</span>
                <span class="n">limit</span><span class="p">,</span><span class="n">limitIsVisible</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">visLimit</span><span class="p">()</span>
                <span class="k">assert</span> <span class="n">limit</span>
                <span class="k">if</span> <span class="n">limitIsVisible</span><span class="p">:</span>
                    <span class="c"># canMoveOutlineUp should have caught this.</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;can not happen. In hoist&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># g.trace(&#39;chapter first child&#39;)</span>
                    <span class="n">moved</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">moveToFirstChildOf</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># p will be the new root node</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToRoot</span><span class="p">(</span><span class="n">oldRoot</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">())</span>
                <span class="n">moved</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">elif</span> <span class="n">back2</span><span class="o">.</span><span class="n">hasChildren</span><span class="p">()</span> <span class="ow">and</span> <span class="n">back2</span><span class="o">.</span><span class="n">isExpanded</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">checkMoveWithParentWithWarning</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">back2</span><span class="p">,</span><span class="bp">True</span><span class="p">):</span>
                <span class="n">moved</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToNthChildOf</span><span class="p">(</span><span class="n">back2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">checkMoveWithParentWithWarning</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">back2</span><span class="o">.</span><span class="n">parent</span><span class="p">(),</span><span class="bp">True</span><span class="p">):</span>
                <span class="n">moved</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveAfter</span><span class="p">(</span><span class="n">back2</span><span class="p">)</span>

        <span class="c"># Patch by nh2: 0004-Add-bool-collapse_nodes_after_move-option.patch</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">collapse_nodes_after_move</span> <span class="ow">and</span> <span class="n">moved</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">sparse_move</span> <span class="ow">and</span> <span class="n">parent</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">parent</span><span class="o">.</span><span class="n">isAncestorOf</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="c"># New in Leo 4.4.2: contract the old parent if it is no longer the parent of p.</span>
            <span class="n">parent</span><span class="o">.</span><span class="n">contract</span><span class="p">()</span>
        <span class="c">#@-&lt;&lt; Move p up &gt;&gt;</span>
        <span class="k">if</span> <span class="n">moved</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">inAtIgnoreRange</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">inAtIgnoreRange</span><span class="p">():</span>
                <span class="c"># The moved nodes have just become newly unignored.</span>
                <span class="n">dirtyVnodeList2</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span> <span class="c"># Mark descendent @thin nodes dirty.</span>
            <span class="k">else</span><span class="p">:</span> <span class="c"># No need to mark descendents dirty.</span>
                <span class="n">dirtyVnodeList2</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">setAllAncestorAtFileNodesDirty</span><span class="p">()</span>
            <span class="n">dirtyVnodeList</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">dirtyVnodeList2</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">u</span><span class="o">.</span><span class="n">afterMoveNode</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s">&#39;Move Right&#39;</span><span class="p">,</span><span class="n">undoData</span><span class="p">,</span><span class="n">dirtyVnodeList</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">setFocus</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">updateSyntaxColorer</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="c"># Moving can change syntax coloring.</span>
    <span class="c">#@+node:ekr.20031218072017.1774: *6* c.promote</span></div>
<div class="viewcode-block" id="Commands.promote"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.promote">[docs]</a>    <span class="k">def</span> <span class="nf">promote</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Make all children of the selected nodes siblings of the selected node.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">u</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">undoer</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">hasChildren</span><span class="p">():</span>
            <span class="n">c</span><span class="o">.</span><span class="n">treeFocusHelper</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="n">isAtIgnoreNode</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtIgnoreNode</span><span class="p">()</span>
        <span class="n">inAtIgnoreRange</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">inAtIgnoreRange</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span>
        <span class="n">parent_v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">_parentVnode</span><span class="p">()</span>
        <span class="n">children</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">children</span>
        <span class="c"># Add the children to parent_v&#39;s children.</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">childIndex</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">parent_v</span><span class="o">.</span><span class="n">children</span><span class="p">[:]</span>
        <span class="n">parent_v</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="n">z</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
        <span class="n">parent_v</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">children</span><span class="p">)</span>
        <span class="n">parent_v</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">n</span><span class="p">:])</span>
        <span class="c"># Remove v&#39;s children.</span>
        <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># Adjust the parent links in the moved children.</span>
        <span class="c"># There is no need to adjust descendant links.</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
            <span class="n">child</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
            <span class="n">child</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parent_v</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">inAtIgnoreRange</span> <span class="ow">and</span> <span class="n">isAtIgnoreNode</span><span class="p">:</span>
            <span class="c"># The promoted nodes have just become newly unignored.</span>
            <span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span> <span class="c"># Mark descendent @thin nodes dirty.</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># No need to mark descendents dirty.</span>
            <span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">setAllAncestorAtFileNodesDirty</span><span class="p">()</span>
        <span class="n">u</span><span class="o">.</span><span class="n">afterPromote</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">children</span><span class="p">,</span><span class="n">dirtyVnodeList</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">setFocus</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">updateSyntaxColorer</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="c"># Moving can change syntax coloring.</span>
    <span class="c">#@+node:ekr.20071213185710: *6* c.toggleSparseMove</span></div>
<div class="viewcode-block" id="Commands.toggleSparseMove"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.toggleSparseMove">[docs]</a>    <span class="k">def</span> <span class="nf">toggleSparseMove</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Toggle whether moves collapse the outline.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">c</span><span class="o">.</span><span class="n">sparse_move</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">sparse_move</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&#39;sparse-move: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">c</span><span class="o">.</span><span class="n">sparse_move</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2913: *5* Goto (Commands)</span>
    <span class="c">#@+node:ekr.20031218072017.1628: *6* goNextVisitedNode</span></div>
<div class="viewcode-block" id="Commands.goNextVisitedNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.goNextVisitedNode">[docs]</a>    <span class="k">def</span> <span class="nf">goNextVisitedNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Select the next visited node.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">nodeHistory</span><span class="o">.</span><span class="n">goNext</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">p</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">nodeHistory</span><span class="o">.</span><span class="n">skipBeadUpdate</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">nodeHistory</span><span class="o">.</span><span class="n">skipBeadUpdate</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">c</span><span class="o">.</span><span class="n">redraw_after_select</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="c">#@+node:ekr.20031218072017.1627: *6* goPrevVisitedNode</span></div>
<div class="viewcode-block" id="Commands.goPrevVisitedNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.goPrevVisitedNode">[docs]</a>    <span class="k">def</span> <span class="nf">goPrevVisitedNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Select the previously visited node.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">nodeHistory</span><span class="o">.</span><span class="n">goPrev</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">p</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">nodeHistory</span><span class="o">.</span><span class="n">skipBeadUpdate</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>            
                <span class="n">c</span><span class="o">.</span><span class="n">nodeHistory</span><span class="o">.</span><span class="n">skipBeadUpdate</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">c</span><span class="o">.</span><span class="n">redraw_after_select</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2914: *6* goToFirstNode</span></div>
<div class="viewcode-block" id="Commands.goToFirstNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.goToFirstNode">[docs]</a>    <span class="k">def</span> <span class="nf">goToFirstNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Select the first node of the entire outline.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">expandOnlyAncestorsOfNode</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">treeSelectHelper</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="c">#@+node:ekr.20051012092453: *6* goToFirstSibling</span></div>
<div class="viewcode-block" id="Commands.goToFirstSibling"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.goToFirstSibling">[docs]</a>    <span class="k">def</span> <span class="nf">goToFirstSibling</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Select the first sibling of the selected node.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">hasBack</span><span class="p">():</span>
            <span class="k">while</span> <span class="n">p</span><span class="o">.</span><span class="n">hasBack</span><span class="p">():</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToBack</span><span class="p">()</span>

        <span class="n">c</span><span class="o">.</span><span class="n">treeSelectHelper</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20070615070925: *6* goToFirstVisibleNode</span></div>
<div class="viewcode-block" id="Commands.goToFirstVisibleNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.goToFirstVisibleNode">[docs]</a>    <span class="k">def</span> <span class="nf">goToFirstVisibleNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Select the first visible node of the selected chapter or hoist.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">firstVisible</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">expandOnlyAncestorsOfNode</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">redraw_after_select</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">treeSelectHelper</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2915: *6* goToLastNode</span></div>
<div class="viewcode-block" id="Commands.goToLastNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.goToLastNode">[docs]</a>    <span class="k">def</span> <span class="nf">goToLastNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Select the last node in the entire tree.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span>

        <span class="k">while</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">hasThreadNext</span><span class="p">():</span>
            <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>

        <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">treeSelectHelper</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">expandOnlyAncestorsOfNode</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20051012092847.1: *6* goToLastSibling</span></div>
<div class="viewcode-block" id="Commands.goToLastSibling"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.goToLastSibling">[docs]</a>    <span class="k">def</span> <span class="nf">goToLastSibling</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Select the last sibling of the selected node.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">hasNext</span><span class="p">():</span>
            <span class="k">while</span> <span class="n">p</span><span class="o">.</span><span class="n">hasNext</span><span class="p">():</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToNext</span><span class="p">()</span>

        <span class="n">c</span><span class="o">.</span><span class="n">treeSelectHelper</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050711153537: *6* c.goToLastVisibleNode</span></div>
<div class="viewcode-block" id="Commands.goToLastVisibleNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.goToLastVisibleNode">[docs]</a>    <span class="k">def</span> <span class="nf">goToLastVisibleNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Select the last visible node of selected chapter or hoist.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">lastVisible</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">expandOnlyAncestorsOfNode</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">redraw_after_select</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">treeSelectHelper</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2916: *6* goToNextClone</span></div>
<div class="viewcode-block" id="Commands.goToNextClone"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.goToNextClone">[docs]</a>    <span class="k">def</span> <span class="nf">goToNextClone</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Select the next node that is a clone of the selected node.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">chapterController</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">isCloned</span><span class="p">():</span>
            <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;not a clone:&#39;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span>
        <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>
        <span class="n">wrapped</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c"># g.trace(p.v,p.h)</span>
            <span class="k">if</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="o">==</span> <span class="n">v</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">p</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">wrapped</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wrapped</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">p</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cc</span><span class="p">:</span>
                <span class="n">cc</span><span class="o">.</span><span class="n">selectChapterByName</span><span class="p">(</span><span class="s">&#39;main&#39;</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">redraw_after_select</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&#39;done&#39;</span><span class="p">)</span>

        <span class="c"># if cc:</span>
            <span class="c"># name = cc.findChapterNameForPosition(p)</span>
            <span class="c"># cc.selectChapterByName(name)</span>
    <span class="c">#@+node:ekr.20071213123942: *6* findNextClone</span></div>
<div class="viewcode-block" id="Commands.findNextClone"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.findNextClone">[docs]</a>    <span class="k">def</span> <span class="nf">findNextClone</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Select the next cloned node.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span> <span class="p">;</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">chapterController</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span> <span class="k">return</span>

        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isCloned</span><span class="p">():</span>
            <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>

        <span class="n">flag</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">while</span> <span class="n">p</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isCloned</span><span class="p">():</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">;</span> <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cc</span><span class="p">:</span>
                <span class="c"># name = cc.findChapterNameForPosition(p)</span>
                <span class="n">cc</span><span class="o">.</span><span class="n">selectChapterByName</span><span class="p">(</span><span class="s">&#39;main&#39;</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">redraw_after_select</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&#39;no more clones&#39;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2917: *6* goToNextDirtyHeadline</span></div>
<div class="viewcode-block" id="Commands.goToNextDirtyHeadline"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.goToNextDirtyHeadline">[docs]</a>    <span class="k">def</span> <span class="nf">goToNextDirtyHeadline</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Select the node that is marked as changed.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>
        <span class="n">wrapped</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">isDirty</span><span class="p">():</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">p</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">wrapped</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wrapped</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&#39;done&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">treeSelectHelper</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="c"># Sets focus.</span>
    <span class="c">#@+node:ekr.20031218072017.2918: *6* goToNextMarkedHeadline</span></div>
<div class="viewcode-block" id="Commands.goToNextMarkedHeadline"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.goToNextMarkedHeadline">[docs]</a>    <span class="k">def</span> <span class="nf">goToNextMarkedHeadline</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Select the next marked node.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>
        <span class="n">wrapped</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">isMarked</span><span class="p">():</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">p</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">wrapped</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wrapped</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&#39;done&#39;</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">treeSelectHelper</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="c"># Sets focus.</span>
    <span class="c">#@+node:ekr.20031218072017.2919: *6* goToNextSibling</span></div>
<div class="viewcode-block" id="Commands.goToNextSibling"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.goToNextSibling">[docs]</a>    <span class="k">def</span> <span class="nf">goToNextSibling</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Select the next sibling of the selected node.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="n">c</span><span class="o">.</span><span class="n">treeSelectHelper</span><span class="p">(</span><span class="n">p</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">next</span><span class="p">())</span>
    <span class="c">#@+node:ekr.20031218072017.2920: *6* goToParent</span></div>
<div class="viewcode-block" id="Commands.goToParent"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.goToParent">[docs]</a>    <span class="k">def</span> <span class="nf">goToParent</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Select the parent of the selected node.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="c"># g.trace(p.parent())</span>

        <span class="n">c</span><span class="o">.</span><span class="n">treeSelectHelper</span><span class="p">(</span><span class="n">p</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">parent</span><span class="p">())</span>
    <span class="c">#@+node:ekr.20031218072017.2921: *6* goToPrevSibling</span></div>
<div class="viewcode-block" id="Commands.goToPrevSibling"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.goToPrevSibling">[docs]</a>    <span class="k">def</span> <span class="nf">goToPrevSibling</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Select the previous sibling of the selected node.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="n">c</span><span class="o">.</span><span class="n">treeSelectHelper</span><span class="p">(</span><span class="n">p</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">back</span><span class="p">())</span>
    <span class="c">#@+node:ekr.20031218072017.2993: *6* selectThreadBack</span></div>
<div class="viewcode-block" id="Commands.selectThreadBack"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.selectThreadBack">[docs]</a>    <span class="k">def</span> <span class="nf">selectThreadBack</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Select the node preceding the selected node in outline order.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadBack</span><span class="p">()</span>

        <span class="n">c</span><span class="o">.</span><span class="n">treeSelectHelper</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2994: *6* selectThreadNext</span></div>
<div class="viewcode-block" id="Commands.selectThreadNext"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.selectThreadNext">[docs]</a>    <span class="k">def</span> <span class="nf">selectThreadNext</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Select the node following the selected node in outline order.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>

        <span class="n">c</span><span class="o">.</span><span class="n">treeSelectHelper</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2995: *6* selectVisBack</span>
    <span class="c"># This has an up arrow for a control key.</span>
</div>
<div class="viewcode-block" id="Commands.selectVisBack"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.selectVisBack">[docs]</a>    <span class="k">def</span> <span class="nf">selectVisBack</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Select the visible node preceding the presently selected node.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">canSelectVisBack</span><span class="p">():</span>
            <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span> <span class="c"># 2011/05/28: A special case.</span>
            <span class="k">return</span>

        <span class="n">p</span><span class="o">.</span><span class="n">moveToVisBack</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="c"># g.trace(p.h)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">treeSelectHelper</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2996: *6* selectVisNext</span></div>
<div class="viewcode-block" id="Commands.selectVisNext"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.selectVisNext">[docs]</a>    <span class="k">def</span> <span class="nf">selectVisNext</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Select the visible node following the presently selected node.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">canSelectVisNext</span><span class="p">():</span>
            <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span> <span class="c"># 2011/05/28: A special case.</span>
            <span class="k">return</span>

        <span class="n">p</span><span class="o">.</span><span class="n">moveToVisNext</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">treeSelectHelper</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20070417112650: *6* utils</span>
    <span class="c">#@+node:ekr.20070226121510: *7*  c.xFocusHelper</span></div>
<div class="viewcode-block" id="Commands.treeEditFocusHelper"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.treeEditFocusHelper">[docs]</a>    <span class="k">def</span> <span class="nf">treeEditFocusHelper</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">stayInTreeAfterEdit</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">treeWantsFocus</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">bodyWantsFocus</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Commands.treeFocusHelper"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.treeFocusHelper">[docs]</a>    <span class="k">def</span> <span class="nf">treeFocusHelper</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">stayInTreeAfterSelect</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">treeWantsFocus</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">bodyWantsFocus</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Commands.initialFocusHelper"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.initialFocusHelper">[docs]</a>    <span class="k">def</span> <span class="nf">initialFocusHelper</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">outlineHasInitialFocus</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">treeWantsFocus</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">bodyWantsFocus</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20070226113916: *7*  c.treeSelectHelper</span></div>
<div class="viewcode-block" id="Commands.treeSelectHelper"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.treeSelectHelper">[docs]</a>    <span class="k">def</span> <span class="nf">treeSelectHelper</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="k">if</span> <span class="n">p</span><span class="p">:</span>
            <span class="c"># Do not call expandAllAncestors here.</span>
            <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">redraw_after_select</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">treeFocusHelper</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.2931: *4* Window Menu</span>
    <span class="c">#@+node:ekr.20031218072017.2092: *5* openCompareWindow</span></div>
<div class="viewcode-block" id="Commands.openCompareWindow"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.openCompareWindow">[docs]</a>    <span class="k">def</span> <span class="nf">openCompareWindow</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Open a dialog for comparing files and directories.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">frame</span><span class="o">.</span><span class="n">comparePanel</span><span class="p">:</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">comparePanel</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">createComparePanel</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">comparePanel</span><span class="p">:</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">comparePanel</span><span class="o">.</span><span class="n">bringToFront</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;the&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">guiName</span><span class="p">(),</span>
                <span class="s">&#39;gui does not support the compare window&#39;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2932: *5* openPythonWindow</span></div>
<div class="viewcode-block" id="Commands.openPythonWindow"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.openPythonWindow">[docs]</a>    <span class="k">def</span> <span class="nf">openPythonWindow</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Open Python&#39;s Idle debugger in a separate process.&#39;&#39;&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">idlelib_path</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">find_module</span><span class="p">(</span><span class="s">&#39;idlelib&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;idlelib not found: can not open a Python window.&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">idle</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_join</span><span class="p">(</span><span class="n">idlelib_path</span><span class="p">,</span><span class="s">&#39;idle.py&#39;</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="n">idle</span> <span class="p">]</span>

        <span class="k">if</span> <span class="mi">1</span><span class="p">:</span> <span class="c"># Use present environment.</span>
            <span class="n">os</span><span class="o">.</span><span class="n">spawnv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">P_NOWAIT</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># Use a pristine environment.</span>
            <span class="n">os</span><span class="o">.</span><span class="n">spawnve</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">P_NOWAIT</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2938: *4* Help Menu</span>
    <span class="c">#@+node:ekr.20031218072017.2939: *5* about (version number &amp; date)</span></div>
<div class="viewcode-block" id="Commands.about"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.about">[docs]</a>    <span class="k">def</span> <span class="nf">about</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Bring up an About Leo Dialog.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># Don&#39;t use triple-quoted strings or continued strings here.</span>
        <span class="c"># Doing so would add unwanted leading tabs.</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">signon</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n\n</span><span class="s">&#39;</span>
        <span class="n">theCopyright</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s">&quot;Copyright 1999-2012 by Edward K. Ream</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span>
            <span class="s">&quot;All Rights Reserved</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span>
            <span class="s">&quot;Leo is distributed under the MIT License&quot;</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s">&quot;http://webpages.charter.net/edreamleo/front.html&quot;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="s">&quot;edreamleo@gmail.com&quot;</span>

        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">runAboutLeoDialog</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">version</span><span class="p">,</span><span class="n">theCopyright</span><span class="p">,</span><span class="n">url</span><span class="p">,</span><span class="n">email</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2943: *5* openLeoSettings and openMyLeoSettings</span></div>
<div class="viewcode-block" id="Commands.openLeoSettings"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.openLeoSettings">[docs]</a>    <span class="k">def</span> <span class="nf">openLeoSettings</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Open leoSettings.leo in a new Leo window.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">openSettingsHelper</span><span class="p">(</span><span class="s">&#39;leoSettings.leo&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Commands.openMyLeoSettings"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.openMyLeoSettings">[docs]</a>    <span class="k">def</span> <span class="nf">openMyLeoSettings</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Open myLeoSettings.leo in a new Leo window.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">openSettingsHelper</span><span class="p">(</span><span class="s">&#39;myLeoSettings.leo&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Commands.openSettingsHelper"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.openSettingsHelper">[docs]</a>    <span class="k">def</span> <span class="nf">openSettingsHelper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">homeLeoDir</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">homeLeoDir</span>
        <span class="n">loadDir</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadDir</span>
        <span class="n">configDir</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">globalConfigDir</span>

        <span class="c"># Look in configDir first.</span>
        <span class="n">fileName</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_join</span><span class="p">(</span><span class="n">configDir</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">openWithFileName</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">old_c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c2</span><span class="p">:</span> <span class="k">return</span>

        <span class="c"># Look in homeLeoDir second.</span>
        <span class="k">if</span> <span class="n">configDir</span> <span class="o">==</span> <span class="n">loadDir</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="s">&quot;not found in&quot;</span><span class="p">,</span><span class="n">configDir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_join</span><span class="p">(</span><span class="n">homeLeoDir</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                <span class="n">c2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">openWithFileName</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">old_c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">c2</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="s">&quot;not found in&quot;</span><span class="p">,</span><span class="n">configDir</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">or&quot;</span><span class="p">,</span><span class="n">homeLeoDir</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20061018094539: *5* openLeoScripts</span></div>
<div class="viewcode-block" id="Commands.openLeoScripts"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.openLeoScripts">[docs]</a>    <span class="k">def</span> <span class="nf">openLeoScripts</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Open scripts.leo.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">fileName</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_join</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadDir</span><span class="p">,</span><span class="s">&#39;..&#39;</span><span class="p">,</span><span class="s">&#39;scripts&#39;</span><span class="p">,</span><span class="s">&#39;scripts.leo&#39;</span><span class="p">)</span>

        <span class="c"># Bug fix: 2012/04/09: only call g.openWithFileName if the file exists.</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">fileName</span><span class="p">):</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">openWithFileName</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">old_c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c2</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;not found:&#39;</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2940: *5* leoDocumentation</span></div>
<div class="viewcode-block" id="Commands.leoDocumentation"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.leoDocumentation">[docs]</a>    <span class="k">def</span> <span class="nf">leoDocumentation</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Open LeoDocs.leo in a new Leo window.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;LeoDocs.leo&quot;</span>

        <span class="n">fileName</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_join</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadDir</span><span class="p">,</span><span class="s">&quot;..&quot;</span><span class="p">,</span><span class="s">&quot;doc&quot;</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
        <span class="c"># Bug fix: 2012/04/09: only call g.openWithFileName if the file exists.</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">fileName</span><span class="p">):</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">openWithFileName</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">old_c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c2</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;not found:&quot;</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2941: *5* leoHome</span></div>
<div class="viewcode-block" id="Commands.leoHome"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.leoHome">[docs]</a>    <span class="k">def</span> <span class="nf">leoHome</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Open Leo&#39;s Home page in a web browser.&#39;&#39;&#39;</span>

        <span class="kn">import</span> <span class="nn">webbrowser</span>

        <span class="n">url</span> <span class="o">=</span> <span class="s">&quot;http://webpages.charter.net/edreamleo/front.html&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">webbrowser</span><span class="o">.</span><span class="n">open_new</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;not found:&quot;</span><span class="p">,</span><span class="n">url</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050130152008: *5* openLeoPlugins</span></div>
<div class="viewcode-block" id="Commands.openLeoPlugins"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.openLeoPlugins">[docs]</a>    <span class="k">def</span> <span class="nf">openLeoPlugins</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Open leoPlugins.leo in a new Leo window.&#39;&#39;&#39;</span>

        <span class="n">names</span> <span class="o">=</span>  <span class="p">(</span><span class="s">&#39;leoPlugins.leo&#39;</span><span class="p">,</span><span class="s">&#39;leoPluginsRef.leo&#39;</span><span class="p">)</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;leoPlugins.leo&quot;</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_join</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadDir</span><span class="p">,</span><span class="s">&quot;..&quot;</span><span class="p">,</span><span class="s">&quot;plugins&quot;</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
            <span class="c"># Bug fix: 2012/04/09: only call g.openWithFileName if the file exists.</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">fileName</span><span class="p">):</span>
                <span class="n">c2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">openWithFileName</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">old_c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">c2</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;not found:&#39;</span><span class="p">,</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">names</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20090628075121.5994: *5* leoQuickStart</span></div>
<div class="viewcode-block" id="Commands.leoQuickStart"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.leoQuickStart">[docs]</a>    <span class="k">def</span> <span class="nf">leoQuickStart</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Open quickstart.leo in a new Leo window.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;quickstart.leo&quot;</span>

        <span class="n">fileName</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_join</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadDir</span><span class="p">,</span><span class="s">&quot;..&quot;</span><span class="p">,</span><span class="s">&quot;doc&quot;</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
        <span class="c"># Bug fix: 2012/04/09: only call g.openWithFileName if the file exists.</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">fileName</span><span class="p">):</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">openWithFileName</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">old_c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c2</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;not found:&quot;</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2942: *5* leoTutorial (version number)</span></div>
<div class="viewcode-block" id="Commands.leoTutorial"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.leoTutorial">[docs]</a>    <span class="k">def</span> <span class="nf">leoTutorial</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Open Leo&#39;s online tutorial in a web browser.&#39;&#39;&#39;</span>

        <span class="kn">import</span> <span class="nn">webbrowser</span>

        <span class="k">if</span> <span class="mi">1</span><span class="p">:</span> <span class="c"># new url</span>
            <span class="n">url</span> <span class="o">=</span> <span class="s">&quot;http://www.3dtree.com/ev/e/sbooks/leo/sbframetoc_ie.htm&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="s">&quot;http://www.evisa.com/e/sbooks/leo/sbframetoc_ie.htm&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">webbrowser</span><span class="o">.</span><span class="n">open_new</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;not found:&quot;</span><span class="p">,</span><span class="n">url</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20060613082924: *5* leoUsersGuide</span></div>
<div class="viewcode-block" id="Commands.leoUsersGuide"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.leoUsersGuide">[docs]</a>    <span class="k">def</span> <span class="nf">leoUsersGuide</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Open Leo&#39;s users guide in a web browser.&#39;&#39;&#39;</span>

        <span class="n">url</span> <span class="o">=</span> <span class="s">&#39;http://webpages.charter.net/edreamleo/leo_toc.html&#39;</span>
        <span class="n">g</span><span class="o">.</span><span class="n">handleUrl</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20110402084740.14490: *4* Icon bar</span></div>
<div class="viewcode-block" id="Commands.goToNextHistory"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.goToNextHistory">[docs]</a>    <span class="k">def</span> <span class="nf">goToNextHistory</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Go to the next node in the history list.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">nodeHistory</span><span class="o">.</span><span class="n">goNext</span><span class="p">()</span>
            <span class="c"># Returns None if the position does not exist.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">c</span><span class="o">.</span><span class="n">nodeHistory</span><span class="o">.</span><span class="n">skipBeadUpdate</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">nodeHistory</span><span class="o">.</span><span class="n">skipBeadUpdate</span> <span class="o">=</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="Commands.goToPrevHistory"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.goToPrevHistory">[docs]</a>    <span class="k">def</span> <span class="nf">goToPrevHistory</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Go to the previous node in the history list.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">nodeHistory</span><span class="o">.</span><span class="n">goPrev</span><span class="p">()</span>
            <span class="c"># Returns None if the position does not exist.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">c</span><span class="o">.</span><span class="n">nodeHistory</span><span class="o">.</span><span class="n">skipBeadUpdate</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">nodeHistory</span><span class="o">.</span><span class="n">skipBeadUpdate</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20031218072017.2945: *3* Dragging (commands)</span>
    <span class="c">#@+node:ekr.20031218072017.2353: *4* c.dragAfter</span></div>
<div class="viewcode-block" id="Commands.dragAfter"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.dragAfter">[docs]</a>    <span class="k">def</span> <span class="nf">dragAfter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">after</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">undoer</span> <span class="p">;</span> <span class="n">undoType</span> <span class="o">=</span> <span class="s">&#39;Drag&#39;</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="n">inAtIgnoreRange</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">inAtIgnoreRange</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">checkDrag</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">after</span><span class="p">):</span> <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">checkMoveWithParentWithWarning</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">after</span><span class="o">.</span><span class="n">parent</span><span class="p">(),</span><span class="bp">True</span><span class="p">):</span> <span class="k">return</span>

        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span>
        <span class="n">undoData</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">beforeMoveNode</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
        <span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">setAllAncestorAtFileNodesDirty</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">moveAfter</span><span class="p">(</span><span class="n">after</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inAtIgnoreRange</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">inAtIgnoreRange</span><span class="p">():</span>
            <span class="c"># The moved nodes have just become newly unignored.</span>
            <span class="n">dirtyVnodeList2</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span> <span class="c"># Mark descendent @thin nodes dirty.</span>
            <span class="n">dirtyVnodeList</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">dirtyVnodeList2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># No need to mark descendents dirty.</span>
            <span class="n">dirtyVnodeList2</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">setAllAncestorAtFileNodesDirty</span><span class="p">()</span>
            <span class="n">dirtyVnodeList</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">dirtyVnodeList2</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">u</span><span class="o">.</span><span class="n">afterMoveNode</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">undoType</span><span class="p">,</span><span class="n">undoData</span><span class="p">,</span><span class="n">dirtyVnodeList</span><span class="o">=</span><span class="n">dirtyVnodeList</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">updateSyntaxColorer</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="c"># Dragging can change syntax coloring.</span>
    <span class="c">#@+node:ekr.20031218072017.2947: *4* c.dragToNthChildOf</span></div>
<div class="viewcode-block" id="Commands.dragToNthChildOf"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.dragToNthChildOf">[docs]</a>    <span class="k">def</span> <span class="nf">dragToNthChildOf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">parent</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">u</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">undoer</span> <span class="p">;</span> <span class="n">undoType</span> <span class="o">=</span> <span class="s">&#39;Drag&#39;</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="n">inAtIgnoreRange</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">inAtIgnoreRange</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">checkDrag</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">parent</span><span class="p">):</span> <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">checkMoveWithParentWithWarning</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">parent</span><span class="p">,</span><span class="bp">True</span><span class="p">):</span> <span class="k">return</span>

        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span>
        <span class="n">undoData</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">beforeMoveNode</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
        <span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">setAllAncestorAtFileNodesDirty</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">moveToNthChildOf</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inAtIgnoreRange</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">inAtIgnoreRange</span><span class="p">():</span>
            <span class="c"># The moved nodes have just become newly unignored.</span>
            <span class="n">dirtyVnodeList2</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span> <span class="c"># Mark descendent @thin nodes dirty.</span>
            <span class="n">dirtyVnodeList</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">dirtyVnodeList2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># No need to mark descendents dirty.</span>
            <span class="n">dirtyVnodeList2</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">setAllAncestorAtFileNodesDirty</span><span class="p">()</span>
            <span class="n">dirtyVnodeList</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">dirtyVnodeList2</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">u</span><span class="o">.</span><span class="n">afterMoveNode</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">undoType</span><span class="p">,</span><span class="n">undoData</span><span class="p">,</span><span class="n">dirtyVnodeList</span><span class="o">=</span><span class="n">dirtyVnodeList</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">updateSyntaxColorer</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="c"># Dragging can change syntax coloring.</span>
    <span class="c">#@+node:ekr.20031218072017.2946: *4* c.dragCloneToNthChildOf</span></div>
<div class="viewcode-block" id="Commands.dragCloneToNthChildOf"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.dragCloneToNthChildOf">[docs]</a>    <span class="k">def</span> <span class="nf">dragCloneToNthChildOf</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">parent</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">u</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">undoer</span> <span class="p">;</span> <span class="n">undoType</span> <span class="o">=</span> <span class="s">&#39;Clone Drag&#39;</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="n">inAtIgnoreRange</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">inAtIgnoreRange</span><span class="p">()</span>

        <span class="c"># g.trace(&quot;p,parent,n:&quot;,p.h,parent.h,n)</span>
        <span class="n">clone</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="c"># Creates clone &amp; dependents, does not set undo.</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">checkDrag</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">parent</span><span class="p">)</span> <span class="ow">or</span>
            <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">checkMoveWithParentWithWarning</span><span class="p">(</span><span class="n">clone</span><span class="p">,</span><span class="n">parent</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">clone</span><span class="o">.</span><span class="n">doDelete</span><span class="p">(</span><span class="n">newNode</span><span class="o">=</span><span class="n">p</span><span class="p">)</span> <span class="c"># Destroys clone and makes p the current node.</span>
            <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="c"># Also sets root position.</span>
            <span class="k">return</span>
        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span>
        <span class="n">undoData</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">beforeInsertNode</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
        <span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="n">clone</span><span class="o">.</span><span class="n">setAllAncestorAtFileNodesDirty</span><span class="p">()</span>
        <span class="n">clone</span><span class="o">.</span><span class="n">moveToNthChildOf</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inAtIgnoreRange</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">inAtIgnoreRange</span><span class="p">():</span>
            <span class="c"># The moved nodes have just become newly unignored.</span>
            <span class="n">dirtyVnodeList2</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span> <span class="c"># Mark descendent @thin nodes dirty.</span>
            <span class="n">dirtyVnodeList</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">dirtyVnodeList2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># No need to mark descendents dirty.</span>
            <span class="n">dirtyVnodeList2</span> <span class="o">=</span>  <span class="n">p</span><span class="o">.</span><span class="n">setAllAncestorAtFileNodesDirty</span><span class="p">()</span>
            <span class="n">dirtyVnodeList</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">dirtyVnodeList2</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">u</span><span class="o">.</span><span class="n">afterInsertNode</span><span class="p">(</span><span class="n">clone</span><span class="p">,</span><span class="n">undoType</span><span class="p">,</span><span class="n">undoData</span><span class="p">,</span><span class="n">dirtyVnodeList</span><span class="o">=</span><span class="n">dirtyVnodeList</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">(</span><span class="n">clone</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">updateSyntaxColorer</span><span class="p">(</span><span class="n">clone</span><span class="p">)</span> <span class="c"># Dragging can change syntax coloring.</span>
    <span class="c">#@+node:ekr.20031218072017.2948: *4* c.dragCloneAfter</span></div>
<div class="viewcode-block" id="Commands.dragCloneAfter"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.dragCloneAfter">[docs]</a>    <span class="k">def</span> <span class="nf">dragCloneAfter</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">after</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">u</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">undoer</span> <span class="p">;</span> <span class="n">undoType</span> <span class="o">=</span> <span class="s">&#39;Clone Drag&#39;</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="n">clone</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span> <span class="c"># Creates clone.  Does not set undo.</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">checkDrag</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">after</span><span class="p">)</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">checkMoveWithParentWithWarning</span><span class="p">(</span><span class="n">clone</span><span class="p">,</span><span class="n">after</span><span class="o">.</span><span class="n">parent</span><span class="p">(),</span><span class="bp">True</span><span class="p">):</span>
            <span class="n">inAtIgnoreRange</span> <span class="o">=</span> <span class="n">clone</span><span class="o">.</span><span class="n">inAtIgnoreRange</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span>
            <span class="n">undoData</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">beforeInsertNode</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
            <span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="n">clone</span><span class="o">.</span><span class="n">setAllAncestorAtFileNodesDirty</span><span class="p">()</span>
            <span class="n">clone</span><span class="o">.</span><span class="n">moveAfter</span><span class="p">(</span><span class="n">after</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inAtIgnoreRange</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">clone</span><span class="o">.</span><span class="n">inAtIgnoreRange</span><span class="p">():</span>
                <span class="c"># The moved node have just become newly unignored.</span>
                <span class="n">dirtyVnodeList2</span> <span class="o">=</span> <span class="n">clone</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span> <span class="c"># Mark descendent @thin nodes dirty.</span>
                <span class="n">dirtyVnodeList</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">dirtyVnodeList2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="c"># No need to mark descendents dirty.</span>
                <span class="n">dirtyVnodeList2</span> <span class="o">=</span> <span class="n">clone</span><span class="o">.</span><span class="n">setAllAncestorAtFileNodesDirty</span><span class="p">()</span>
                <span class="n">dirtyVnodeList</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">dirtyVnodeList2</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">u</span><span class="o">.</span><span class="n">afterInsertNode</span><span class="p">(</span><span class="n">clone</span><span class="p">,</span><span class="n">undoType</span><span class="p">,</span><span class="n">undoData</span><span class="p">,</span><span class="n">dirtyVnodeList</span><span class="o">=</span><span class="n">dirtyVnodeList</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">clone</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># g.trace(&quot;invalid clone drag&quot;)</span>
            <span class="n">clone</span><span class="o">.</span><span class="n">doDelete</span><span class="p">(</span><span class="n">newNode</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">updateSyntaxColorer</span><span class="p">(</span><span class="n">clone</span><span class="p">)</span> <span class="c"># Dragging can change syntax coloring.</span>
    <span class="c">#@+node:ekr.20031218072017.2949: *3* Drawing Utilities (commands)</span>
    <span class="c">#@+node:ekr.20080610085158.2: *4* c.add_command</span></div>
<div class="viewcode-block" id="Commands.add_command"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.add_command">[docs]</a>    <span class="k">def</span> <span class="nf">add_command</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">menu</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">command</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;command&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">command</span><span class="p">:</span>

            <span class="c"># Command is always either:</span>
            <span class="c"># one of two callbacks defined in createMenuEntries or</span>
            <span class="c"># recentFilesCallback, defined in createRecentFilesMenuItems.</span>

            <span class="k">def</span> <span class="nf">add_commandCallback</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">command</span><span class="o">=</span><span class="n">command</span><span class="p">):</span>
                <span class="c"># g.trace(command)</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">command</span><span class="p">()</span>
                <span class="c"># Careful: func may destroy c.</span>
                <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">outerUpdate</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">val</span>

            <span class="n">keys</span> <span class="p">[</span><span class="s">&#39;command&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">add_commandCallback</span>

            <span class="n">menu</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="o">**</span><span class="n">keys</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;can not happen: no &quot;command&quot; arg&#39;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20080514131122.7: *4* c.begin/endUpdate</span>
</div>
<div class="viewcode-block" id="Commands.beginUpdate"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.beginUpdate">[docs]</a>    <span class="k">def</span> <span class="nf">beginUpdate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Deprecated: does nothing.&#39;&#39;&#39;</span>

        <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;***** c.beginUpdate is deprecated&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span> <span class="k">assert</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Commands.endUpdate"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.endUpdate">[docs]</a>    <span class="k">def</span> <span class="nf">endUpdate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">flag</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Request a redraw of the screen if flag is True.&#39;&#39;&#39;</span>

        <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;***** c.endUpdate is deprecated&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span> <span class="k">assert</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">requestRedrawFlag</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="c"># g.trace(&#39;flag is True&#39;,c.shortFileName(),g.callers())</span>
</div>
    <span class="n">BeginUpdate</span> <span class="o">=</span> <span class="n">beginUpdate</span> <span class="c"># Compatibility with old scripts</span>
    <span class="n">EndUpdate</span> <span class="o">=</span> <span class="n">endUpdate</span> <span class="c"># Compatibility with old scripts</span>
    <span class="c">#@+node:ekr.20080514131122.8: *4* c.bringToFront</span>
<div class="viewcode-block" id="Commands.bringToFront"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.bringToFront">[docs]</a>    <span class="k">def</span> <span class="nf">bringToFront</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c2</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">set_focus</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="n">c2</span> <span class="ow">or</span> <span class="n">c</span>
        <span class="n">c</span><span class="o">.</span><span class="n">requestBringToFront</span> <span class="o">=</span> <span class="n">c2</span>
        <span class="n">c</span><span class="o">.</span><span class="n">requestedIconify</span> <span class="o">=</span> <span class="s">&#39;deiconify&#39;</span>
        <span class="n">c</span><span class="o">.</span><span class="n">requestedFocusWidget</span> <span class="o">=</span> <span class="n">c2</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">bodyCtrl</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">ensure_commander_visible</span><span class="p">(</span><span class="n">c2</span><span class="p">)</span>
</div>
    <span class="n">BringToFront</span> <span class="o">=</span> <span class="n">bringToFront</span> <span class="c"># Compatibility with old scripts</span>
    <span class="c">#@+node:ekr.20040803072955.143: *4* c.expandAllAncestors</span>
<div class="viewcode-block" id="Commands.expandAllAncestors"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.expandAllAncestors">[docs]</a>    <span class="k">def</span> <span class="nf">expandAllAncestors</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Expand all ancestors without redrawing.</span>

<span class="sd">        Return a flag telling whether a redraw is needed.&#39;&#39;&#39;</span>

        <span class="c"># c = self</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">redraw_flag</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">parents</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">isExpanded</span><span class="p">():</span>
                <span class="n">p</span><span class="o">.</span><span class="n">expand</span><span class="p">()</span>
                <span class="n">redraw_flag</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">redraw_flag</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">p</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">),</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">redraw_flag</span>
    <span class="c">#@+node:ekr.20080514131122.9: *4* c.get/request/set_focus</span></div>
<div class="viewcode-block" id="Commands.get_focus"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.get_focus">[docs]</a>    <span class="k">def</span> <span class="nf">get_focus</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">get_focus</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Commands.get_requested_focus"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.get_requested_focus">[docs]</a>    <span class="k">def</span> <span class="nf">get_requested_focus</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">requestedFocusWidget</span>
</div>
<div class="viewcode-block" id="Commands.request_focus"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.request_focus">[docs]</a>    <span class="k">def</span> <span class="nf">request_focus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">w</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">widget_name</span><span class="p">(</span><span class="n">w</span><span class="p">),</span><span class="n">w</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">w</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">requestedFocusWidget</span> <span class="o">=</span> <span class="n">w</span>
</div>
<div class="viewcode-block" id="Commands.set_focus"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.set_focus">[docs]</a>    <span class="k">def</span> <span class="nf">set_focus</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">force</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">w</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;c.set_focus:&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">widget_name</span><span class="p">(</span><span class="n">w</span><span class="p">),</span><span class="n">w</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>
                <span class="c"># w,c.shortFileName())</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">set_focus</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">w</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;c.set_focus: no w&#39;</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">requestedFocusWidget</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20080514131122.10: *4* c.invalidateFocus</span></div>
<div class="viewcode-block" id="Commands.invalidateFocus"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.invalidateFocus">[docs]</a>    <span class="k">def</span> <span class="nf">invalidateFocus</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Indicate that the focus is in an invalid location, or is unknown.&#39;&#39;&#39;</span>

        <span class="c"># c = self</span>
        <span class="c"># c.requestedFocusWidget = None</span>
        <span class="k">pass</span>
    <span class="c">#@+node:ekr.20080514131122.12: *4* c.recolor &amp; requestRecolor</span></div>
<div class="viewcode-block" id="Commands.requestRecolor"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.requestRecolor">[docs]</a>    <span class="k">def</span> <span class="nf">requestRecolor</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="c"># g.trace(g.callers(4))</span>
        <span class="n">c</span><span class="o">.</span><span class="n">requestRecolorFlag</span> <span class="o">=</span> <span class="bp">True</span>
</div>
    <span class="n">recolor</span> <span class="o">=</span> <span class="n">requestRecolor</span>
    <span class="c">#@+node:ekr.20080514131122.14: *4* c.redrawing...</span>
    <span class="c">#@+node:ekr.20090110073010.1: *5* c.redraw</span>
<div class="viewcode-block" id="Commands.redraw"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.redraw">[docs]</a>    <span class="k">def</span> <span class="nf">redraw</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">setFocus</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Redraw the screen immediately.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span>

        <span class="n">c</span><span class="o">.</span><span class="n">expandAllAncestors</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="c"># 2012/03/10: tree.redraw will change the position if p is a hoisted @chapter node.</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">redraw</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="c"># Be careful.  nullTree.redraw return None.</span>
        <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">p2</span> <span class="ow">or</span> <span class="n">p</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;setFocus&#39;</span><span class="p">,</span><span class="n">setFocus</span><span class="p">,</span><span class="n">p2</span> <span class="ow">or</span> <span class="n">p</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">setFocus</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">treeFocusHelper</span><span class="p">()</span>

    <span class="c"># Compatibility with old scripts</span></div>
    <span class="n">force_redraw</span> <span class="o">=</span> <span class="n">redraw</span>
    <span class="n">redraw_now</span> <span class="o">=</span> <span class="n">redraw</span>
    <span class="c">#@+node:ekr.20090110131802.2: *5* c.redraw_after_contract</span>
<div class="viewcode-block" id="Commands.redraw_after_contract"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.redraw_after_contract">[docs]</a>    <span class="k">def</span> <span class="nf">redraw_after_contract</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">setFocus</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">p</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">setCurrentPosition</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">currentPosition</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isCloned</span><span class="p">():</span>
            <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span><span class="n">setFocus</span><span class="o">=</span><span class="n">setFocus</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">redraw_after_contract</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">setFocus</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">treeFocusHelper</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20090112065525.1: *5* c.redraw_after_expand</span></div>
<div class="viewcode-block" id="Commands.redraw_after_expand"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.redraw_after_expand">[docs]</a>    <span class="k">def</span> <span class="nf">redraw_after_expand</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">setFocus</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">p</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">setCurrentPosition</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">currentPosition</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isCloned</span><span class="p">():</span>
            <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span><span class="n">setFocus</span><span class="o">=</span><span class="n">setFocus</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">redraw_after_expand</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">setFocus</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">treeFocusHelper</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20090110073010.2: *5* c.redraw_after_head_changed</span></div>
<div class="viewcode-block" id="Commands.redraw_after_head_changed"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.redraw_after_head_changed">[docs]</a>    <span class="k">def</span> <span class="nf">redraw_after_head_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Redraw the screen (if needed) when editing ends.</span>
<span class="sd">        This may be a do-nothing for some gui&#39;s.&#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">redraw_after_head_changed</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20090110073010.3: *5* c.redraw_afer_icons_changed</span></div>
<div class="viewcode-block" id="Commands.redraw_after_icons_changed"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.redraw_after_icons_changed">[docs]</a>    <span class="k">def</span> <span class="nf">redraw_after_icons_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Update the icon for the presently selected node,</span>
<span class="sd">        or all icons if the &#39;all&#39; flag is true.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">redraw_after_icons_changed</span><span class="p">()</span>

        <span class="c"># c.treeFocusHelper()</span>
    <span class="c">#@+node:ekr.20090110073010.4: *5* c.redraw_after_select</span></div>
<div class="viewcode-block" id="Commands.redraw_after_select"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.redraw_after_select">[docs]</a>    <span class="k">def</span> <span class="nf">redraw_after_select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Redraw the screen after node p has been selected.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;(Commands)&#39;</span><span class="p">,</span><span class="n">p</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span> <span class="ow">or</span> <span class="s">&#39;&lt;No p&gt;&#39;</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">flag</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">expandAllAncestors</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">redraw_after_select</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20080514131122.13: *4* c.recolor_now</span></div>
<div class="viewcode-block" id="Commands.recolor_now"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.recolor_now">[docs]</a>    <span class="k">def</span> <span class="nf">recolor_now</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">incremental</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">interruptable</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="c"># g.trace(&#39;incremental&#39;,incremental,p and p.h,g.callers())</span>

        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">colorizer</span><span class="o">.</span><span class="n">colorize</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>
            <span class="n">incremental</span><span class="o">=</span><span class="n">incremental</span><span class="p">,</span><span class="n">interruptable</span><span class="o">=</span><span class="n">interruptable</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20080514131122.16: *4* c.traceFocus</span></div>
<div class="viewcode-block" id="Commands.traceFocus"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.traceFocus">[docs]</a>    <span class="k">def</span> <span class="nf">traceFocus</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">w</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="bp">False</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getBool</span><span class="p">(</span><span class="s">&#39;trace_focus&#39;</span><span class="p">)):</span>
            <span class="c">### import pdb ; pdb.set_trace() # Drop into pdb.</span>
            <span class="n">c</span><span class="o">.</span><span class="n">trace_focus_count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%4d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">trace_focus_count</span><span class="p">),</span><span class="n">c</span><span class="o">.</span><span class="n">widget_name</span><span class="p">(</span><span class="n">w</span><span class="p">),</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20080514131122.17: *4* c.widget_name</span></div>
<div class="viewcode-block" id="Commands.widget_name"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.widget_name">[docs]</a>    <span class="k">def</span> <span class="nf">widget_name</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">widget</span><span class="p">):</span>

        <span class="c"># c = self</span>
        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">widget_name</span><span class="p">(</span><span class="n">widget</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
    <span class="c">#@+node:ekr.20080514131122.18: *4* c.xWantsFocus</span>
</div>
<div class="viewcode-block" id="Commands.bodyWantsFocus"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.bodyWantsFocus">[docs]</a>    <span class="k">def</span> <span class="nf">bodyWantsFocus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">body</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span>
        <span class="n">c</span><span class="o">.</span><span class="n">request_focus</span><span class="p">(</span><span class="n">body</span> <span class="ow">and</span> <span class="n">body</span><span class="o">.</span><span class="n">bodyCtrl</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Commands.logWantsFocus"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.logWantsFocus">[docs]</a>    <span class="k">def</span> <span class="nf">logWantsFocus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">log</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">log</span>
        <span class="n">c</span><span class="o">.</span><span class="n">request_focus</span><span class="p">(</span><span class="n">log</span> <span class="ow">and</span> <span class="n">log</span><span class="o">.</span><span class="n">logCtrl</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Commands.minibufferWantsFocus"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.minibufferWantsFocus">[docs]</a>    <span class="k">def</span> <span class="nf">minibufferWantsFocus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">c</span><span class="o">.</span><span class="n">request_focus</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">miniBufferWidget</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Commands.treeWantsFocus"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.treeWantsFocus">[docs]</a>    <span class="k">def</span> <span class="nf">treeWantsFocus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">tree</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">tree</span>
        <span class="n">c</span><span class="o">.</span><span class="n">request_focus</span><span class="p">(</span><span class="n">tree</span> <span class="ow">and</span> <span class="n">tree</span><span class="o">.</span><span class="n">canvas</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Commands.widgetWantsFocus"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.widgetWantsFocus">[docs]</a>    <span class="k">def</span> <span class="nf">widgetWantsFocus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">w</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span><span class="o">.</span><span class="n">request_focus</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20080514131122.19: *4* c.xWantsFocusNow</span>
    <span class="c"># widgetWantsFocusNow does an automatic update.</span></div>
<div class="viewcode-block" id="Commands.widgetWantsFocusNow"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.widgetWantsFocusNow">[docs]</a>    <span class="k">def</span> <span class="nf">widgetWantsFocusNow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">w</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">c</span><span class="o">.</span><span class="n">request_focus</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">outerUpdate</span><span class="p">()</span>

    <span class="c"># New in 4.9: all FocusNow methods now *do* call c.outerUpdate().</span></div>
<div class="viewcode-block" id="Commands.bodyWantsFocusNow"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.bodyWantsFocusNow">[docs]</a>    <span class="k">def</span> <span class="nf">bodyWantsFocusNow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">body</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span>
        <span class="n">c</span><span class="o">.</span><span class="n">widgetWantsFocusNow</span><span class="p">(</span><span class="n">body</span> <span class="ow">and</span> <span class="n">body</span><span class="o">.</span><span class="n">bodyCtrl</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Commands.logWantsFocusNow"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.logWantsFocusNow">[docs]</a>    <span class="k">def</span> <span class="nf">logWantsFocusNow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">log</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">log</span>
        <span class="n">c</span><span class="o">.</span><span class="n">widgetWantsFocusNow</span><span class="p">(</span><span class="n">log</span> <span class="ow">and</span> <span class="n">log</span><span class="o">.</span><span class="n">logCtrl</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Commands.treeWantsFocusNow"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.treeWantsFocusNow">[docs]</a>    <span class="k">def</span> <span class="nf">treeWantsFocusNow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">tree</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">tree</span>
        <span class="n">c</span><span class="o">.</span><span class="n">widgetWantsFocusNow</span><span class="p">(</span><span class="n">tree</span> <span class="ow">and</span> <span class="n">tree</span><span class="o">.</span><span class="n">canvas</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2955: *3* Enabling Menu Items</span>
    <span class="c">#@+node:ekr.20040323172420: *4* Slow routines: no longer used</span>
    <span class="c">#@+node:ekr.20031218072017.2966: *5* canGoToNextDirtyHeadline (slow)</span></div>
<div class="viewcode-block" id="Commands.canGoToNextDirtyHeadline"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.canGoToNextDirtyHeadline">[docs]</a>    <span class="k">def</span> <span class="nf">canGoToNextDirtyHeadline</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">current</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">all_unique_positions</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">current</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">isDirty</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20031218072017.2967: *5* canGoToNextMarkedHeadline (slow)</span></div>
<div class="viewcode-block" id="Commands.canGoToNextMarkedHeadline"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.canGoToNextMarkedHeadline">[docs]</a>    <span class="k">def</span> <span class="nf">canGoToNextMarkedHeadline</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">current</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">all_unique_positions</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">current</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">isMarked</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20031218072017.2968: *5* canMarkChangedHeadline (slow)</span></div>
<div class="viewcode-block" id="Commands.canMarkChangedHeadlines"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.canMarkChangedHeadlines">[docs]</a>    <span class="k">def</span> <span class="nf">canMarkChangedHeadlines</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">all_unique_positions</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isDirty</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20031218072017.2969: *5* canMarkChangedRoots (slow)</span></div>
<div class="viewcode-block" id="Commands.canMarkChangedRoots"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.canMarkChangedRoots">[docs]</a>    <span class="k">def</span> <span class="nf">canMarkChangedRoots</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">all_unique_positions</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isDirty</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">isAnyAtFileNode</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20040131170659: *4* canClone (new for hoist)</span></div>
<div class="viewcode-block" id="Commands.canClone"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.canClone">[docs]</a>    <span class="k">def</span> <span class="nf">canClone</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">hoistStack</span><span class="p">:</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
            <span class="n">bunch</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">hoistStack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">current</span> <span class="o">!=</span> <span class="n">bunch</span><span class="o">.</span><span class="n">p</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
    <span class="c">#@+node:ekr.20031218072017.2956: *4* canContractAllHeadlines</span></div>
<div class="viewcode-block" id="Commands.canContractAllHeadlines"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.canContractAllHeadlines">[docs]</a>    <span class="k">def</span> <span class="nf">canContractAllHeadlines</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">all_unique_positions</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isExpanded</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20031218072017.2957: *4* canContractAllSubheads</span></div>
<div class="viewcode-block" id="Commands.canContractAllSubheads"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.canContractAllSubheads">[docs]</a>    <span class="k">def</span> <span class="nf">canContractAllSubheads</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">current</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">current</span><span class="o">.</span><span class="n">subtree</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">current</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">isExpanded</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20031218072017.2958: *4* canContractParent</span></div>
<div class="viewcode-block" id="Commands.canContractParent"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.canContractParent">[docs]</a>    <span class="k">def</span> <span class="nf">canContractParent</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.2959: *4* canContractSubheads</span></div>
<div class="viewcode-block" id="Commands.canContractSubheads"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.canContractSubheads">[docs]</a>    <span class="k">def</span> <span class="nf">canContractSubheads</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">current</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">current</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">isExpanded</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20031218072017.2960: *4* canCutOutline &amp; canDeleteHeadline</span></div>
<div class="viewcode-block" id="Commands.canDeleteHeadline"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.canDeleteHeadline">[docs]</a>    <span class="k">def</span> <span class="nf">canDeleteHeadline</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">hoistStack</span><span class="p">:</span>
            <span class="n">bunch</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">hoistStack</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="n">bunch</span><span class="o">.</span><span class="n">p</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>

        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">hasParent</span><span class="p">()</span> <span class="ow">or</span> <span class="n">p</span><span class="o">.</span><span class="n">hasThreadBack</span><span class="p">()</span> <span class="ow">or</span> <span class="n">p</span><span class="o">.</span><span class="n">hasNext</span><span class="p">()</span>
</div>
    <span class="n">canCutOutline</span> <span class="o">=</span> <span class="n">canDeleteHeadline</span>
    <span class="c">#@+node:ekr.20031218072017.2961: *4* canDemote</span>
<div class="viewcode-block" id="Commands.canDemote"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.canDemote">[docs]</a>    <span class="k">def</span> <span class="nf">canDemote</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">hasNext</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.2962: *4* canExpandAllHeadlines</span></div>
<div class="viewcode-block" id="Commands.canExpandAllHeadlines"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.canExpandAllHeadlines">[docs]</a>    <span class="k">def</span> <span class="nf">canExpandAllHeadlines</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">all_unique_positions</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">isExpanded</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20031218072017.2963: *4* canExpandAllSubheads</span></div>
<div class="viewcode-block" id="Commands.canExpandAllSubheads"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.canExpandAllSubheads">[docs]</a>    <span class="k">def</span> <span class="nf">canExpandAllSubheads</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">subtree</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">isExpanded</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20031218072017.2964: *4* canExpandSubheads</span></div>
<div class="viewcode-block" id="Commands.canExpandSubheads"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.canExpandSubheads">[docs]</a>    <span class="k">def</span> <span class="nf">canExpandSubheads</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">current</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">current</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">current</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">isExpanded</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20031218072017.2287: *4* canExtract, canExtractSection &amp; canExtractSectionNames</span></div>
<div class="viewcode-block" id="Commands.canExtract"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.canExtract">[docs]</a>    <span class="k">def</span> <span class="nf">canExtract</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">body</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span>
        <span class="k">return</span> <span class="n">body</span> <span class="ow">and</span> <span class="n">body</span><span class="o">.</span><span class="n">hasSelection</span><span class="p">()</span>
</div>
    <span class="n">canExtractSectionNames</span> <span class="o">=</span> <span class="n">canExtract</span>

<div class="viewcode-block" id="Commands.canExtractSection"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.canExtractSection">[docs]</a>    <span class="k">def</span> <span class="nf">canExtractSection</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">body</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">body</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">getSelectedText</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>

        <span class="n">line</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">i1</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;&lt;&lt;&quot;</span><span class="p">)</span>
        <span class="n">j1</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;&gt;&gt;&quot;</span><span class="p">)</span>
        <span class="n">i2</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;@&lt;&quot;</span><span class="p">)</span>
        <span class="n">j2</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;@&gt;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">i1</span> <span class="o">&lt;</span> <span class="n">j1</span> <span class="ow">or</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">i2</span> <span class="o">&lt;</span> <span class="n">j2</span>
    <span class="c">#@+node:ekr.20031218072017.2965: *4* canFindMatchingBracket</span></div>
<div class="viewcode-block" id="Commands.canFindMatchingBracket"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.canFindMatchingBracket">[docs]</a>    <span class="k">def</span> <span class="nf">canFindMatchingBracket</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">brackets</span> <span class="o">=</span> <span class="s">&quot;()[]{}&quot;</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">getAllText</span><span class="p">()</span>
        <span class="n">ins</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">getInsertPoint</span><span class="p">()</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">ins</span>   <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="n">ins</span><span class="p">]</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">ins</span><span class="o">-</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="n">ins</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>

        <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">c1</span> <span class="ow">and</span> <span class="n">c1</span> <span class="ow">in</span> <span class="n">brackets</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">c2</span> <span class="ow">and</span> <span class="n">c2</span> <span class="ow">in</span> <span class="n">brackets</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20040303165342: *4* canHoist &amp; canDehoist</span></div>
<div class="viewcode-block" id="Commands.canDehoist"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.canDehoist">[docs]</a>    <span class="k">def</span> <span class="nf">canDehoist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">hoistLevel</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span>
</div>
<div class="viewcode-block" id="Commands.canHoist"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.canHoist">[docs]</a>    <span class="k">def</span> <span class="nf">canHoist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># N.B.  This is called at idle time, so minimizing positions is crucial!</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">hoistStack</span><span class="p">:</span>
            <span class="n">bunch</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">hoistStack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">bunch</span><span class="o">.</span><span class="n">p</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">isCurrentPosition</span><span class="p">(</span><span class="n">bunch</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">c</span><span class="o">.</span><span class="n">currentPositionIsRootPosition</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">currentPositionHasNext</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
    <span class="c">#@+node:ekr.20070608165544: *4* hoistLevel</span></div>
<div class="viewcode-block" id="Commands.hoistLevel"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.hoistLevel">[docs]</a>    <span class="k">def</span> <span class="nf">hoistLevel</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">cc</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">chapterController</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">hoistStack</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">cc</span> <span class="ow">and</span> <span class="n">cc</span><span class="o">.</span><span class="n">inChapter</span><span class="p">():</span>
            <span class="n">n</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">n</span>
    <span class="c">#@+node:ekr.20031218072017.2970: *4* canMoveOutlineDown</span></div>
<div class="viewcode-block" id="Commands.canMoveOutlineDown"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.canMoveOutlineDown">[docs]</a>    <span class="k">def</span> <span class="nf">canMoveOutlineDown</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">current</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="k">return</span> <span class="n">current</span> <span class="ow">and</span> <span class="n">current</span><span class="o">.</span><span class="n">visNext</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2971: *4* canMoveOutlineLeft</span></div>
<div class="viewcode-block" id="Commands.canMoveOutlineLeft"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.canMoveOutlineLeft">[docs]</a>    <span class="k">def</span> <span class="nf">canMoveOutlineLeft</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">hoistStack</span><span class="p">:</span>
            <span class="n">bunch</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">hoistStack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">hasParent</span><span class="p">():</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToParent</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">bunch</span><span class="o">.</span><span class="n">p</span> <span class="ow">and</span> <span class="n">bunch</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">isAncestorOf</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">hasParent</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.2972: *4* canMoveOutlineRight</span></div>
<div class="viewcode-block" id="Commands.canMoveOutlineRight"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.canMoveOutlineRight">[docs]</a>    <span class="k">def</span> <span class="nf">canMoveOutlineRight</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">hoistStack</span><span class="p">:</span>
            <span class="n">bunch</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">hoistStack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">hasBack</span><span class="p">()</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">bunch</span><span class="o">.</span><span class="n">p</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">hasBack</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.2973: *4* canMoveOutlineUp</span></div>
<div class="viewcode-block" id="Commands.canMoveOutlineUp"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.canMoveOutlineUp">[docs]</a>    <span class="k">def</span> <span class="nf">canMoveOutlineUp</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">current</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="n">visBack</span> <span class="o">=</span> <span class="n">current</span> <span class="ow">and</span> <span class="n">current</span><span class="o">.</span><span class="n">visBack</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">visBack</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="n">visBack</span><span class="o">.</span><span class="n">visBack</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">c</span><span class="o">.</span><span class="n">hoistStack</span><span class="p">:</span>
            <span class="n">limit</span><span class="p">,</span><span class="n">limitIsVisible</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">visLimit</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">limitIsVisible</span><span class="p">:</span> <span class="c"># A hoist</span>
                <span class="k">return</span> <span class="n">current</span> <span class="o">!=</span> <span class="n">limit</span>
            <span class="k">else</span><span class="p">:</span> <span class="c"># A chapter.</span>
                <span class="k">return</span> <span class="n">current</span> <span class="o">!=</span> <span class="n">limit</span><span class="o">.</span><span class="n">firstChild</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">current</span> <span class="o">!=</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.2974: *4* canPasteOutline</span></div>
<div class="viewcode-block" id="Commands.canPasteOutline"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.canPasteOutline">[docs]</a>    <span class="k">def</span> <span class="nf">canPasteOutline</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">getTextFromClipboard</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">prolog_prefix_string</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;matches xml prolog&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">importCommands</span><span class="o">.</span><span class="n">stringIsValidMoreFile</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;More file?&#39;</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">val</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;no clipboard text&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20031218072017.2975: *4* canPromote</span></div>
<div class="viewcode-block" id="Commands.canPromote"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.canPromote">[docs]</a>    <span class="k">def</span> <span class="nf">canPromote</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">v</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">currentVnode</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">v</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">hasChildren</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.2977: *4* canSelect....</span></div>
<div class="viewcode-block" id="Commands.canSelectThreadBack"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.canSelectThreadBack">[docs]</a>    <span class="k">def</span> <span class="nf">canSelectThreadBack</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">hasThreadBack</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Commands.canSelectThreadNext"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.canSelectThreadNext">[docs]</a>    <span class="k">def</span> <span class="nf">canSelectThreadNext</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">hasThreadNext</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Commands.canSelectVisBack"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.canSelectVisBack">[docs]</a>    <span class="k">def</span> <span class="nf">canSelectVisBack</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">visBack</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Commands.canSelectVisNext"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.canSelectVisNext">[docs]</a>    <span class="k">def</span> <span class="nf">canSelectVisNext</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">visNext</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2978: *4* canShiftBodyLeft/Right</span></div>
<div class="viewcode-block" id="Commands.canShiftBodyLeft"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.canShiftBodyLeft">[docs]</a>    <span class="k">def</span> <span class="nf">canShiftBodyLeft</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">body</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span>
        <span class="k">return</span> <span class="n">body</span> <span class="ow">and</span> <span class="n">body</span><span class="o">.</span><span class="n">getAllText</span><span class="p">()</span>
</div>
    <span class="n">canShiftBodyRight</span> <span class="o">=</span> <span class="n">canShiftBodyLeft</span>
    <span class="c">#@+node:ekr.20031218072017.2979: *4* canSortChildren, canSortSiblings</span>
<div class="viewcode-block" id="Commands.canSortChildren"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.canSortChildren">[docs]</a>    <span class="k">def</span> <span class="nf">canSortChildren</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="k">return</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">hasChildren</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Commands.canSortSiblings"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.canSortSiblings">[docs]</a>    <span class="k">def</span> <span class="nf">canSortSiblings</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="k">return</span> <span class="n">p</span> <span class="ow">and</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">hasNext</span><span class="p">()</span> <span class="ow">or</span> <span class="n">p</span><span class="o">.</span><span class="n">hasBack</span><span class="p">())</span>
    <span class="c">#@+node:ekr.20031218072017.2980: *4* canUndo &amp; canRedo</span></div>
<div class="viewcode-block" id="Commands.canUndo"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.canUndo">[docs]</a>    <span class="k">def</span> <span class="nf">canUndo</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">undoer</span><span class="o">.</span><span class="n">canUndo</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Commands.canRedo"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.canRedo">[docs]</a>    <span class="k">def</span> <span class="nf">canRedo</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">undoer</span><span class="o">.</span><span class="n">canRedo</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.2981: *4* canUnmarkAll</span></div>
<div class="viewcode-block" id="Commands.canUnmarkAll"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.canUnmarkAll">[docs]</a>    <span class="k">def</span> <span class="nf">canUnmarkAll</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">all_unique_positions</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isMarked</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20111217154130.10286: *3* Error dialogs (commands)</span>
    <span class="c">#@+node:ekr.20111217154130.10284: *4* c.init_error_dialogs</span></div>
<div class="viewcode-block" id="Commands.init_error_dialogs"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.init_error_dialogs">[docs]</a>    <span class="k">def</span> <span class="nf">init_error_dialogs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">c</span><span class="o">.</span><span class="n">import_error_nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">c</span><span class="o">.</span><span class="n">ignored_at_file_nodes</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTestDict</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="s">&#39;init_error_dialogs&#39;</span>
            <span class="n">d</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20111217154130.10285: *4* c.raise_error_dialogs</span></div>
<div class="viewcode-block" id="Commands.raise_error_dialogs"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.raise_error_dialogs">[docs]</a>    <span class="k">def</span> <span class="nf">raise_error_dialogs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;read&#39;</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTestDict</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="s">&#39;raise_error_dialogs&#39;</span>
            <span class="n">d</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="c"># This trace catches all too-many-calls failures.</span>
            <span class="c"># g.trace(g.callers())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># 2011/12/17: Issue one or two dialogs.</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">import_error_nodes</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">ignored_at_file_nodes</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">dismiss_splash_screen</span><span class="p">()</span>
                <span class="c"># g.trace(g.callers())</span>

            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">import_error_nodes</span><span class="p">:</span>
                <span class="n">files</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">import_error_nodes</span><span class="p">))</span>
                <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">runAskOkDialog</span><span class="p">(</span><span class="n">c</span><span class="p">,</span>
                    <span class="n">title</span><span class="o">=</span><span class="s">&#39;Import errors&#39;</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="s">&#39;The following were not imported properly.  @ignore was inserted:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">files</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">ignored_at_file_nodes</span><span class="p">:</span>
                <span class="n">files</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">ignored_at_file_nodes</span><span class="p">))</span>
                <span class="n">kind</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">kind</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;read&#39;</span><span class="p">),</span><span class="s">&#39;read&#39;</span><span class="p">,</span><span class="s">&#39;written&#39;</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">runAskOkDialog</span><span class="p">(</span><span class="n">c</span><span class="p">,</span>
                    <span class="n">title</span><span class="o">=</span><span class="s">&#39;Not read&#39;</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="s">&#39;The following were not </span><span class="si">%s</span><span class="s"> because they contain @ignore:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kind</span><span class="p">,</span><span class="n">files</span><span class="p">))</span>

        <span class="n">c</span><span class="o">.</span><span class="n">init_error_dialogs</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.2982: *3* Getters &amp; Setters</span>
    <span class="c">#@+node:ekr.20060906211747: *4* Getters</span>
    <span class="c">#@+node:ekr.20040803140033: *5* c.currentPosition (changed)</span></div>
<div class="viewcode-block" id="Commands.currentPosition"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.currentPosition">[docs]</a>    <span class="k">def</span> <span class="nf">currentPosition</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Return the presently selected position.&quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&#39;_currentPosition&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&#39;_currentPosition&#39;</span><span class="p">):</span>
            <span class="c"># New in Leo 4.4.2: *always* return a copy.</span>
            <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">_currentPosition</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">nullPosition</span><span class="p">()</span>

    <span class="c"># For compatibiility with old scripts.</span></div>
    <span class="n">currentVnode</span> <span class="o">=</span> <span class="n">currentPosition</span>
    <span class="c">#@+node:ekr.20040306220230.1: *5* c.edit_widget</span>
<div class="viewcode-block" id="Commands.edit_widget"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.edit_widget">[docs]</a>    <span class="k">def</span> <span class="nf">edit_widget</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">return</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">edit_widget</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2986: *5* c.fileName &amp; relativeFileName &amp; shortFileName</span>
    <span class="c"># Compatibility with scripts</span>
</div>
<div class="viewcode-block" id="Commands.fileName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.fileName">[docs]</a>    <span class="k">def</span> <span class="nf">fileName</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mFileName</span>
</div>
<div class="viewcode-block" id="Commands.relativeFileName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.relativeFileName">[docs]</a>    <span class="k">def</span> <span class="nf">relativeFileName</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mRelativeFileName</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">mFileName</span>
</div>
<div class="viewcode-block" id="Commands.shortFileName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.shortFileName">[docs]</a>    <span class="k">def</span> <span class="nf">shortFileName</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mFileName</span><span class="p">)</span>
</div>
    <span class="n">shortFilename</span> <span class="o">=</span> <span class="n">shortFileName</span>
    <span class="c">#@+node:ekr.20070615070925.1: *5* c.firstVisible</span>
<div class="viewcode-block" id="Commands.firstVisible"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.firstVisible">[docs]</a>    <span class="k">def</span> <span class="nf">firstVisible</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Move to the first visible node of the present chapter or hoist.&quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">back</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">visBack</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">back</span> <span class="ow">and</span> <span class="n">back</span><span class="o">.</span><span class="n">isVisible</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">back</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">break</span>
        <span class="k">return</span> <span class="n">p</span>
    <span class="c">#@+node:ekr.20040803112200: *5* c.is...Position</span>
    <span class="c">#@+node:ekr.20040803155551: *6* c.currentPositionIsRootPosition</span></div>
<div class="viewcode-block" id="Commands.currentPositionIsRootPosition"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.currentPositionIsRootPosition">[docs]</a>    <span class="k">def</span> <span class="nf">currentPositionIsRootPosition</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Return True if the current position is the root position.</span>

<span class="sd">        This method is called during idle time, so not generating positions</span>
<span class="sd">        here fixes a major leak.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">root</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">_currentPosition</span> <span class="ow">and</span> <span class="n">root</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">_currentPosition</span> <span class="o">==</span> <span class="n">root</span>

        <span class="c"># return (</span>
            <span class="c"># c._currentPosition and c._rootPosition and</span>
            <span class="c"># c._currentPosition == c._rootPosition)</span>
    <span class="c">#@+node:ekr.20040803160656: *6* c.currentPositionHasNext</span></div>
<div class="viewcode-block" id="Commands.currentPositionHasNext"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.currentPositionHasNext">[docs]</a>    <span class="k">def</span> <span class="nf">currentPositionHasNext</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Return True if the current position is the root position.</span>

<span class="sd">        This method is called during idle time, so not generating positions</span>
<span class="sd">        here fixes a major leak.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">current</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">_currentPosition</span> 

        <span class="k">return</span> <span class="n">current</span> <span class="ow">and</span> <span class="n">current</span><span class="o">.</span><span class="n">hasNext</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20040803112450: *6* c.isCurrentPosition</span></div>
<div class="viewcode-block" id="Commands.isCurrentPosition"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.isCurrentPosition">[docs]</a>    <span class="k">def</span> <span class="nf">isCurrentPosition</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">_currentPosition</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">p</span> <span class="o">==</span> <span class="n">c</span><span class="o">.</span><span class="n">_currentPosition</span>
    <span class="c">#@+node:ekr.20040803112450.1: *6* c.isRootPosition</span></div>
<div class="viewcode-block" id="Commands.isRootPosition"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.isRootPosition">[docs]</a>    <span class="k">def</span> <span class="nf">isRootPosition</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">root</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">==</span> <span class="n">root</span> <span class="c"># 2011/03/03</span>

        <span class="c"># if p is None or c._rootPosition is None:</span>
            <span class="c"># return False</span>
        <span class="c"># else:</span>
            <span class="c"># return p == c._rootPosition</span>
    <span class="c">#@+node:ekr.20031218072017.2987: *5* c.isChanged</span></div>
<div class="viewcode-block" id="Commands.isChanged"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.isChanged">[docs]</a>    <span class="k">def</span> <span class="nf">isChanged</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">changed</span>
    <span class="c">#@+node:ekr.20031218072017.4146: *5* c.lastVisible</span></div>
<div class="viewcode-block" id="Commands.lastVisible"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.lastVisible">[docs]</a>    <span class="k">def</span> <span class="nf">lastVisible</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Move to the last visible node of the present chapter or hoist.&quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">next</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">visNext</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="c"># g.trace(&#39;next&#39;,next)</span>
            <span class="k">if</span> <span class="nb">next</span> <span class="ow">and</span> <span class="nb">next</span><span class="o">.</span><span class="n">isVisible</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
                <span class="n">p</span> <span class="o">=</span> <span class="nb">next</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">break</span>
        <span class="k">return</span> <span class="n">p</span>
    <span class="c">#@+node:ekr.20040311094927: *5* c.nullPosition</span></div>
<div class="viewcode-block" id="Commands.nullPosition"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.nullPosition">[docs]</a>    <span class="k">def</span> <span class="nf">nullPosition</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># c = self</span>
        <span class="k">return</span> <span class="n">leoNodes</span><span class="o">.</span><span class="n">position</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20040307104131.3: *5* c.positionExists</span></div>
<div class="viewcode-block" id="Commands.positionExists"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.positionExists">[docs]</a>    <span class="k">def</span> <span class="nf">positionExists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">root</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Return True if a position exists in c&#39;s tree&quot;&quot;&quot;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">children</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">tag</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">children</span><span class="p">):</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;bad i: </span><span class="si">%s</span><span class="s">, children: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">i</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">children</span><span class="p">)))</span> <span class="c"># ,g.callers(12))</span>
                <span class="k">elif</span> <span class="n">children</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">v</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;v mismatch: children[i]: </span><span class="si">%s</span><span class="s">, v: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">children</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">and</span> <span class="n">children</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="n">v</span><span class="o">.</span><span class="n">h</span><span class="p">))</span> <span class="c"># ,g.callers(12))</span>

        <span class="c"># This code must be fast.</span>
        <span class="n">root1</span> <span class="o">=</span> <span class="n">root</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">root</span><span class="p">:</span>
            <span class="n">root</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span>

        <span class="k">while</span> <span class="n">p</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="n">root</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">hasParent</span><span class="p">():</span>
                <span class="n">old_v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">_childIndex</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToParent</span><span class="p">()</span>
                <span class="n">children</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">children</span>
                <span class="c"># Major bug fix: 2009/1/2 and 2009/1/5</span>
                <span class="n">report</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">children</span><span class="p">,</span><span class="n">old_v</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">children</span><span class="p">)</span> <span class="ow">or</span> <span class="n">children</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">old_v</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">False</span>
            <span class="k">elif</span> <span class="n">root1</span><span class="p">:</span>
                <span class="c"># Major bug fix: 2012/03/08: Do *not* expand the search!</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># A top-level position, check from hidden root vnode.</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">_childIndex</span>
                <span class="n">children</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">hiddenRootNode</span><span class="o">.</span><span class="n">children</span>
                <span class="n">report</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">children</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">children</span><span class="p">)</span> <span class="ow">and</span> <span class="n">children</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;no v found&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20040803140033.2: *5* c.rootPosition</span></div>
    <span class="n">_rootCount</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="Commands.rootPosition"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.rootPosition">[docs]</a>    <span class="k">def</span> <span class="nf">rootPosition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Return the root position.</span>

<span class="sd">        Root position is the first position in the document. Other</span>
<span class="sd">        top level positions are siblings of this node.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># g.trace(self._rootCount) ; self._rootCount += 1</span>

        <span class="c"># 2011/02/25: Compute the position directly.</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">hiddenRootNode</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">hiddenRootNode</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">leoNodes</span><span class="o">.</span><span class="n">position</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">childIndex</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">stack</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">nullPosition</span><span class="p">()</span>

    <span class="c"># For compatibiility with old scripts.</span></div>
    <span class="n">rootVnode</span> <span class="o">=</span> <span class="n">rootPosition</span>
    <span class="n">findRootPosition</span> <span class="o">=</span> <span class="n">rootPosition</span>
    <span class="c">#@+node:ekr.20070609122713: *5* c.visLimit</span>
<div class="viewcode-block" id="Commands.visLimit"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.visLimit">[docs]</a>    <span class="k">def</span> <span class="nf">visLimit</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the topmost visible node.</span>
<span class="sd">        This is affected by chapters and hoists.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">chapterController</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">hoistStack</span><span class="p">:</span>
            <span class="n">bunch</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">hoistStack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">bunch</span><span class="o">.</span><span class="n">p</span>
            <span class="n">limitIsVisible</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">cc</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@chapter&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">p</span><span class="p">,</span><span class="n">limitIsVisible</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span><span class="bp">None</span>
    <span class="c">#@+node:ekr.20090107113956.1: *5* c.vnode2position</span></div>
<div class="viewcode-block" id="Commands.vnode2position"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.vnode2position">[docs]</a>    <span class="k">def</span> <span class="nf">vnode2position</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">v</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Given a vnode v, construct a valid position p such that p.v = v.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">context</span> <span class="c"># v&#39;s commander.</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">context</span><span class="p">)</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">v</span><span class="o">.</span><span class="n">parents</span><span class="p">:</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">parent</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,(</span><span class="n">v</span><span class="p">,</span><span class="n">n</span><span class="p">),)</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">parent</span>

        <span class="c"># v.parents includes the hidden root node.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">stack</span><span class="p">:</span>
            <span class="c"># a vnode not in the tree</span>
            <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">nullPosition</span><span class="p">()</span>
        <span class="n">v</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">leoNodes</span><span class="o">.</span><span class="n">position</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">stack</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">p</span>

    <span class="c">#@+node:tbrown.20091206142842.10296: *5* c.vnode2allPositions</span></div>
<div class="viewcode-block" id="Commands.vnode2allPositions"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.vnode2allPositions">[docs]</a>    <span class="k">def</span> <span class="nf">vnode2allPositions</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">v</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Given a vnode v, find all valid positions p such that p.v = v.</span>

<span class="sd">        Not really all, just all for each of v&#39;s distinct immediate parents.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">context</span> <span class="c"># v&#39;s commander.</span>
        <span class="k">assert</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="n">context</span><span class="p">)</span>
        <span class="n">positions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">immediate</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">parents</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">immediate</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">immediate</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">stack</span> <span class="o">=</span> <span class="p">[(</span><span class="n">v</span><span class="p">,</span><span class="n">n</span><span class="p">)]</span>
            <span class="k">while</span> <span class="n">immediate</span><span class="o">.</span><span class="n">parents</span><span class="p">:</span>
                <span class="n">parent</span> <span class="o">=</span> <span class="n">immediate</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">immediate</span> <span class="ow">in</span> <span class="n">parent</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">immediate</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,(</span><span class="n">immediate</span><span class="p">,</span><span class="n">n</span><span class="p">),)</span>
                <span class="n">immediate</span> <span class="o">=</span> <span class="n">parent</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">v</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">leoNodes</span><span class="o">.</span><span class="n">position</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">stack</span><span class="p">)</span>
                <span class="n">positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">positions</span>
    <span class="c">#@+node:ekr.20060906211747.1: *4* Setters</span>
    <span class="c">#@+node:ekr.20040315032503: *5* c.appendStringToBody</span></div>
<div class="viewcode-block" id="Commands.appendStringToBody"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.appendStringToBody">[docs]</a>    <span class="k">def</span> <span class="nf">appendStringToBody</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">body</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">isUnicode</span><span class="p">(</span><span class="n">body</span><span class="p">))</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicode</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">setBodyString</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">body</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2984: *5* c.clearAllMarked</span></div>
<div class="viewcode-block" id="Commands.clearAllMarked"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.clearAllMarked">[docs]</a>    <span class="k">def</span> <span class="nf">clearAllMarked</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">all_unique_positions</span><span class="p">():</span>
            <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">clearMarked</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.2985: *5* c.clearAllVisited</span></div>
<div class="viewcode-block" id="Commands.clearAllVisited"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.clearAllVisited">[docs]</a>    <span class="k">def</span> <span class="nf">clearAllVisited</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">all_unique_positions</span><span class="p">():</span>
            <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">clearVisited</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">clearWriteBit</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20060906211138: *5* c.clearMarked</span></div>
<div class="viewcode-block" id="Commands.clearMarked"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.clearMarked">[docs]</a>    <span class="k">def</span> <span class="nf">clearMarked</span>  <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">clearMarked</span><span class="p">()</span>
        <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&quot;clear-mark&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20040305223522: *5* c.setBodyString</span></div>
<div class="viewcode-block" id="Commands.setBodyString"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.setBodyString">[docs]</a>    <span class="k">def</span> <span class="nf">setBodyString</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">v</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicode</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="c"># 1/22/05: Major change: the previous test was: &#39;if p == current:&#39;</span>
        <span class="c"># This worked because commands work on the presently selected node.</span>
        <span class="c"># But setRecentFiles may change a _clone_ of the selected node!</span>
        <span class="k">if</span> <span class="n">current</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">==</span><span class="n">current</span><span class="o">.</span><span class="n">v</span><span class="p">:</span>
            <span class="c"># Revert to previous code, but force an empty selection.</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">setSelectionAreas</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">bodyCtrl</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getInsertPoint</span><span class="p">()</span>
            <span class="n">w</span><span class="o">.</span><span class="n">setSelectionRange</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="c"># This code destoys all tags, so we must recolor.</span>
            <span class="n">c</span><span class="o">.</span><span class="n">recolor</span><span class="p">()</span>

        <span class="c"># Keep the body text in the vnode up-to-date.</span>
        <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">b</span> <span class="o">!=</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">v</span><span class="o">.</span><span class="n">setBodyString</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">v</span><span class="o">.</span><span class="n">setSelection</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">isChanged</span><span class="p">():</span>
                <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">redraw_after_icons_changed</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.2989: *5* c.setChanged</span></div>
<div class="viewcode-block" id="Commands.setChanged"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.setChanged">[docs]</a>    <span class="k">def</span> <span class="nf">setChanged</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">changedFlag</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">c</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="n">changedFlag</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">loading</span><span class="p">:</span> <span class="k">return</span> <span class="c"># don&#39;t update while loading.</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">changedFlag</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>

        <span class="c"># Clear all dirty bits _before_ setting the caption.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">changedFlag</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">all_unique_nodes</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">isDirty</span><span class="p">():</span>
                    <span class="n">v</span><span class="o">.</span><span class="n">clearDirty</span><span class="p">()</span>

        <span class="c"># Do nothing for null frames.</span>
        <span class="k">assert</span> <span class="n">c</span><span class="o">.</span><span class="n">gui</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">guiName</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;nullGui&#39;</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">top</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">leo_master</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">leo_master</span><span class="p">)</span>

        <span class="n">master</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">top</span><span class="p">,</span><span class="s">&#39;leo_master&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">leo_master</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">master</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">master</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">changedFlag</span><span class="p">)</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">getTitle</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">changedFlag</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">s</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;*&#39;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="s">&quot;* &quot;</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;* &quot;</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">setTitle</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
    <span class="c">#@+node:ekr.20040803140033.1: *5* c.setCurrentPosition</span></div>
    <span class="n">_currentCount</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="Commands.setCurrentPosition"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.setCurrentPosition">[docs]</a>    <span class="k">def</span> <span class="nf">setCurrentPosition</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Set the presently selected position. For internal use only.</span>

<span class="sd">        Client code should use c.selectPosition instead.&quot;&quot;&quot;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">_currentCount</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">_currentCount</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">p</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">positionExists</span><span class="p">(</span><span class="n">p</span><span class="p">):</span> <span class="c"># 2011/02/25:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">_currentPosition</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">trace</span><span class="p">(</span><span class="s">&#39;Invalid position: </span><span class="si">%s</span><span class="s">, root: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">p</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">),</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">_currentPosition</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">_currentPosition</span><span class="o">.</span><span class="n">h</span><span class="p">)),</span>
                <span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>

            <span class="c"># Don&#39;t kill unit tests for this kind of problem.</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">p</span><span class="p">:</span>
            <span class="c"># Important: p.equal requires c._currentPosition to be non-None.</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">_currentPosition</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">==</span> <span class="n">c</span><span class="o">.</span><span class="n">_currentPosition</span><span class="p">:</span>
                <span class="k">pass</span> <span class="c"># We have already made a copy.</span>
            <span class="k">else</span><span class="p">:</span> <span class="c"># Must make a copy _now_</span>
                <span class="n">c</span><span class="o">.</span><span class="n">_currentPosition</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">_currentPosition</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c"># For compatibiility with old scripts.</span></div>
    <span class="n">setCurrentVnode</span> <span class="o">=</span> <span class="n">setCurrentPosition</span>
    <span class="c">#@+node:ekr.20040305223225: *5* c.setHeadString</span>
<div class="viewcode-block" id="Commands.setHeadString"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.setHeadString">[docs]</a>    <span class="k">def</span> <span class="nf">setHeadString</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Set the p&#39;s headline and the corresponding tree widget to s.</span>

<span class="sd">        This is used in by unit tests to restore the outline.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">p</span><span class="o">.</span><span class="n">initHeadString</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span>

        <span class="c"># Change the actual tree widget so</span>
        <span class="c"># A later call to c.endEditing or c.redraw will use s.</span>
        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">setHeadline</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20060109164136: *5* c.setLog</span></div>
<div class="viewcode-block" id="Commands.setLog"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.setLog">[docs]</a>    <span class="k">def</span> <span class="nf">setLog</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c"># c.frame or c.frame.log may not exist.</span>
                <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">setLog</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>
    <span class="c">#@+node:ekr.20060906211138.1: *5* c.setMarked</span></div>
<div class="viewcode-block" id="Commands.setMarked"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.setMarked">[docs]</a>    <span class="k">def</span> <span class="nf">setMarked</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">setMarked</span><span class="p">()</span>
        <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&quot;set-mark&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20040803140033.3: *5* c.setRootPosition (A do-nothing)</span></div>
<div class="viewcode-block" id="Commands.setRootPosition"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.setRootPosition">[docs]</a>    <span class="k">def</span> <span class="nf">setRootPosition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">unused_p</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Set c._rootPosition.&quot;&quot;&quot;</span>

        <span class="c"># 2011/03/03: No longer used.</span>
    <span class="c">#@+node:ekr.20060906131836: *5* c.setRootVnode (A do-nothing)</span></div>
<div class="viewcode-block" id="Commands.setRootVnode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.setRootVnode">[docs]</a>    <span class="k">def</span> <span class="nf">setRootVnode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>

        <span class="k">pass</span>

        <span class="c"># c = self</span>

        <span class="c"># # 2011/02/25: c.setRootPosition needs no arguments.</span>
        <span class="c"># c.setRootPosition()</span>
    <span class="c">#@+node:ekr.20040311173238: *5* c.topPosition &amp; c.setTopPosition</span></div>
<div class="viewcode-block" id="Commands.topPosition"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.topPosition">[docs]</a>    <span class="k">def</span> <span class="nf">topPosition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Return the root position.&quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">_topPosition</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">_topPosition</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">nullPosition</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Commands.setTopPosition"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.setTopPosition">[docs]</a>    <span class="k">def</span> <span class="nf">setTopPosition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Set the root positioin.&quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">p</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">_topPosition</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">_topPosition</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">nullPosition</span><span class="p">()</span>

    <span class="c"># Define these for compatibiility with old scripts.</span></div>
    <span class="n">topVnode</span> <span class="o">=</span> <span class="n">topPosition</span>
    <span class="n">setTopVnode</span> <span class="o">=</span> <span class="n">setTopPosition</span>
    <span class="c">#@+node:ekr.20031218072017.3404: *5* c.trimTrailingLines</span>
<div class="viewcode-block" id="Commands.trimTrailingLines"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.trimTrailingLines">[docs]</a>    <span class="k">def</span> <span class="nf">trimTrailingLines</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Trims trailing blank lines from a node.</span>

<span class="sd">        It is surprising difficult to do this during Untangle.&quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">;</span> <span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                <span class="k">del</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span> <span class="p">;</span> <span class="n">changed</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">break</span>
        <span class="k">if</span> <span class="n">changed</span><span class="p">:</span>
            <span class="n">body</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">body</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="c"># Add back one last newline.</span>
            <span class="c"># g.trace(body)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">setBodyString</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">body</span><span class="p">)</span>
            <span class="c"># Don&#39;t set the dirty bit: it would just be annoying.</span>
    <span class="c">#@+node:ekr.20031218072017.2990: *3* Selecting &amp; Updating (commands)</span>
    <span class="c">#@+node:ekr.20031218072017.2991: *4* c.redrawAndEdit</span>
    <span class="c"># Sets the focus to p and edits p.</span>
</div>
<div class="viewcode-block" id="Commands.redrawAndEdit"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.redrawAndEdit">[docs]</a>    <span class="k">def</span> <span class="nf">redrawAndEdit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">selectAll</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">selection</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">keepMinibuffer</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Redraw the screen and start editing the headline at position p.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">k</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">k</span>

        <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">p</span><span class="p">:</span>
            <span class="c"># This should request focus.</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">editLabel</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">selectAll</span><span class="o">=</span><span class="n">selectAll</span><span class="p">,</span><span class="n">selection</span><span class="o">=</span><span class="n">selection</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">k</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">keepMinibuffer</span><span class="p">:</span>
                <span class="c"># Setting the input state has no effect on focus.</span>
                <span class="k">if</span> <span class="n">selectAll</span><span class="p">:</span>
                    <span class="n">k</span><span class="o">.</span><span class="n">setInputState</span><span class="p">(</span><span class="s">&#39;insert&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">k</span><span class="o">.</span><span class="n">setDefaultInputState</span><span class="p">()</span>

                <span class="c"># This *does* affect focus.</span>
                <span class="n">k</span><span class="o">.</span><span class="n">showStateAndMode</span><span class="p">()</span>

        <span class="c"># Update the focus immediately.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">keepMinibuffer</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">outerUpdate</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.2992: *4* c.endEditing (calls tree.endEditLabel)</span>
    <span class="c"># Ends the editing in the outline.</span>
</div>
<div class="viewcode-block" id="Commands.endEditing"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.endEditing">[docs]</a>    <span class="k">def</span> <span class="nf">endEditing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        
        <span class="k">if</span> <span class="n">p</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;(c)&#39;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">endEditLabel</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">setSelectedLabelState</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="c"># The following code would be wrong; c.endEditing is a utility method.</span>
        <span class="c"># k = c.k</span>
        <span class="c"># if k:</span>
            <span class="c"># k.setDefaultInputState()</span>
            <span class="c"># # Recolor the *body* text, **not** the headline.</span>
            <span class="c"># k.showStateAndMode(w=c.frame.body.bodyCtrl)</span>
    <span class="c">#@+node:ekr.20031218072017.2997: *4* c.selectPosition</span></div>
<div class="viewcode-block" id="Commands.selectPosition"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.selectPosition">[docs]</a>    <span class="k">def</span> <span class="nf">selectPosition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">enableRedrawFlag</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Select a new position.&quot;&quot;&quot;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">chapterController</span>

        <span class="k">if</span> <span class="n">cc</span><span class="p">:</span>
            <span class="n">cc</span><span class="o">.</span><span class="n">selectChapterForPosition</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="c"># Important: selectChapterForPosition calls c.redraw</span>
                <span class="c"># if the chapter changes.</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">p</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

        <span class="c"># 2012/03/08: De-hoist as necessary to make p visible.</span>
        <span class="n">redraw_flag</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">hoistStack</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">c</span><span class="o">.</span><span class="n">hoistStack</span><span class="p">:</span>
                <span class="n">bunch</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">hoistStack</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">hoistStack</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">positionExists</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">bunch</span><span class="o">.</span><span class="n">p</span><span class="p">):</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">bunch</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">hoistStack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="n">redraw_flag</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;unhoist&#39;</span><span class="p">,</span><span class="n">bunch</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">positionExists</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;** does not exist: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">))</span>

        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="c"># New in Leo 4.4.2.</span>
        <span class="n">c</span><span class="o">.</span><span class="n">setCurrentPosition</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="c"># Do *not* test whether the position exists!</span>
            <span class="c"># We may be in the midst of an undo.</span>

        <span class="k">if</span> <span class="n">redraw_flag</span> <span class="ow">and</span> <span class="n">enableRedrawFlag</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>
</div>
    <span class="n">selectVnode</span> <span class="o">=</span> <span class="n">selectPosition</span>
    <span class="c">#@+node:ekr.20060923202156: *4* c.onCanvasKey</span>
<div class="viewcode-block" id="Commands.onCanvasKey"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.onCanvasKey">[docs]</a>    <span class="k">def</span> <span class="nf">onCanvasKey</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Navigate to the next headline starting with ch = event.char.</span>
<span class="sd">        If ch is uppercase, search all headlines; otherwise search only visible headlines.</span>
<span class="sd">        This is modelled on Windows explorer.&#39;&#39;&#39;</span>

        <span class="c"># g.trace(event and event.char)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">event</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">event</span><span class="o">.</span><span class="n">char</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">event</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">isalnum</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="n">c</span>  <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span> <span class="p">;</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">invisible</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getBool</span><span class="p">(</span><span class="s">&#39;invisible_outline_navigation&#39;</span><span class="p">)</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="n">event</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">char</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
        <span class="n">allFlag</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">isupper</span><span class="p">()</span> <span class="ow">and</span> <span class="n">invisible</span> <span class="c"># all is a global (!?)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">invisible</span><span class="p">:</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">found</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">extend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">navQuickKey</span><span class="p">()</span>
        <span class="n">attempts</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">extend</span><span class="p">,(</span><span class="bp">True</span><span class="p">,</span><span class="bp">False</span><span class="p">),(</span><span class="bp">False</span><span class="p">,))</span>
        <span class="k">for</span> <span class="n">extend2</span> <span class="ow">in</span> <span class="n">attempts</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">allFlag</span><span class="p">:</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">moveToVisNext</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="n">p1</span><span class="p">:</span> <span class="c"># Never try to match the same position.</span>
                    <span class="c"># g.trace(&#39;failed&#39;,extend2)</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="bp">False</span> <span class="p">;</span> <span class="k">break</span>
                <span class="n">newPrefix</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">navHelper</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">ch</span><span class="p">,</span><span class="n">extend2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">newPrefix</span><span class="p">:</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">;</span> <span class="k">break</span>
            <span class="k">if</span> <span class="n">found</span><span class="p">:</span> <span class="k">break</span>
        <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">redraw_after_select</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">navTime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">navPrefix</span> <span class="o">=</span> <span class="n">newPrefix</span>
            <span class="c"># g.trace(&#39;extend&#39;,extend,&#39;extend2&#39;,extend2,&#39;navPrefix&#39;,c.navPrefix,&#39;p&#39;,p.h)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">navTime</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">c</span><span class="o">.</span><span class="n">navPrefix</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">c</span><span class="o">.</span><span class="n">treeWantsFocus</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20061002095711.1: *5* c.navQuickKey</span></div>
<div class="viewcode-block" id="Commands.navQuickKey"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.navQuickKey">[docs]</a>    <span class="k">def</span> <span class="nf">navQuickKey</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;return true if there are two quick outline navigation keys</span>
<span class="sd">        in quick succession.</span>

<span class="sd">        Returns False if @float outline_nav_extend_delay setting is 0.0 or unspecified.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">deltaTime</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getFloat</span><span class="p">(</span><span class="s">&#39;outline_nav_extend_delay&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">deltaTime</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="mf">0.0</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nearTime</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">navTime</span> <span class="ow">and</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span> <span class="o">-</span> <span class="n">c</span><span class="o">.</span><span class="n">navTime</span> <span class="o">&lt;</span> <span class="n">deltaTime</span>
            <span class="k">return</span> <span class="n">nearTime</span>
    <span class="c">#@+node:ekr.20061002095711: *5* c.navHelper</span></div>
<div class="viewcode-block" id="Commands.navHelper"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.navHelper">[docs]</a>    <span class="k">def</span> <span class="nf">navHelper</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">ch</span><span class="p">,</span><span class="n">extend</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">h</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">extend</span><span class="p">:</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">navPrefix</span> <span class="o">+</span> <span class="n">ch</span>
            <span class="k">return</span> <span class="n">h</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="ow">and</span> <span class="n">prefix</span>

        <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">ch</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">ch</span>

        <span class="c"># New feature: search for first non-blank character after @x for common x.</span>
        <span class="k">if</span> <span class="n">ch</span> <span class="o">!=</span> <span class="s">&#39;@&#39;</span> <span class="ow">and</span> <span class="n">h</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;button&#39;</span><span class="p">,</span><span class="s">&#39;command&#39;</span><span class="p">,</span><span class="s">&#39;file&#39;</span><span class="p">,</span><span class="s">&#39;thin&#39;</span><span class="p">,</span><span class="s">&#39;asis&#39;</span><span class="p">,</span><span class="s">&#39;nosent&#39;</span><span class="p">,):</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="s">&#39;@&#39;</span><span class="o">+</span><span class="n">s</span>
                <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="o">+</span><span class="n">s</span><span class="p">):</span>
                    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
                        <span class="n">ch2</span> <span class="o">=</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="ow">and</span> <span class="n">h</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
                        <span class="k">if</span> <span class="n">ch2</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
                            <span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">ch2</span>
                        <span class="k">else</span><span class="p">:</span> <span class="k">break</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="ow">and</span> <span class="n">h</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">ch</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
                        <span class="k">return</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">ch</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span>
    <span class="c">#@+node:ville.20090525205736.12325: *4* c.getSelectedPositions</span></div>
<div class="viewcode-block" id="Commands.getSelectedPositions"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.getSelectedPositions">[docs]</a>    <span class="k">def</span> <span class="nf">getSelectedPositions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get list (poslist) of currently selected positions</span>

<span class="sd">        So far only makes sense on qt gui (which supports multiselection)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">getSelectedPositions</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20031218072017.2999: *3* Syntax coloring interface</span>
    <span class="c">#@+at These routines provide a convenient interface to the syntax colorer.</span>
    <span class="c">#@+node:ekr.20031218072017.3000: *4* updateSyntaxColorer</span></div>
<div class="viewcode-block" id="Commands.updateSyntaxColorer"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.updateSyntaxColorer">[docs]</a>    <span class="k">def</span> <span class="nf">updateSyntaxColorer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">v</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">updateSyntaxColorer</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20090103070824.12: *3* Time stamps</span>
    <span class="c">#@+node:ekr.20090103070824.11: *4* c.checkFileTimeStamp</span></div>
<div class="viewcode-block" id="Commands.checkFileTimeStamp"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.checkFileTimeStamp">[docs]</a>    <span class="k">def</span> <span class="nf">checkFileTimeStamp</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return True if the file given by fn has not been changed</span>
<span class="sd">        since Leo read it or if the user agrees to overwrite it.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># Don&#39;t assume the file still exists.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;file no longer exists&#39;</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="n">timeStamp</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">timeStampDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">timeStamp</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;no time stamp&#39;</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="n">timeStamp2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">timeStamp</span> <span class="o">==</span> <span class="n">timeStamp2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;time stamps match&#39;</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span><span class="n">timeStamp</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;mismatch&#39;</span><span class="p">,</span><span class="n">timeStamp</span><span class="p">,</span><span class="n">timeStamp2</span><span class="p">)</span>

        <span class="n">message</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">fn</span><span class="p">,</span>
            <span class="n">g</span><span class="o">.</span><span class="n">tr</span><span class="p">(</span><span class="s">&#39;has been modified outside of Leo.&#39;</span><span class="p">),</span>
            <span class="n">g</span><span class="o">.</span><span class="n">tr</span><span class="p">(</span><span class="s">&#39;Overwrite this file?&#39;</span><span class="p">))</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">runAskYesNoCancelDialog</span><span class="p">(</span><span class="n">c</span><span class="p">,</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s">&#39;Overwrite modified file?&#39;</span><span class="p">,</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ok</span> <span class="o">==</span> <span class="s">&#39;yes&#39;</span>
    <span class="c">#@+node:ekr.20090103070824.9: *4* c.setFileTimeStamp</span></div>
<div class="viewcode-block" id="Commands.setFileTimeStamp"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.Commands.setFileTimeStamp">[docs]</a>    <span class="k">def</span> <span class="nf">setFileTimeStamp</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">timeStamp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">timeStampDict</span><span class="p">[</span><span class="n">fn</span><span class="p">]</span> <span class="o">=</span> <span class="n">timeStamp</span>

        <span class="c"># g.trace(&#39;%20s&#39; % (timeStamp),fn)</span>

    <span class="c">#@-others</span>
<span class="c">#@+node:ekr.20070615131604: ** class nodeHistory</span></div></div>
<div class="viewcode-block" id="nodeHistory"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.nodeHistory">[docs]</a><span class="k">class</span> <span class="nc">nodeHistory</span><span class="p">:</span>

    <span class="sd">&#39;&#39;&#39;A class encapsulating knowledge of visited nodes.&#39;&#39;&#39;</span>

    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20070615131604.1: *3*  ctor (nodeHistory)</span>
    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beadList</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c"># list of (position,chapter) tuples for</span>
            <span class="c"># nav_buttons and nodenavigator plugins.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beadPointer</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skipBeadUpdate</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20070615131604.3: *3* canGoToNext/Prev</span>
<div class="viewcode-block" id="nodeHistory.canGoToNextVisited"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.nodeHistory.canGoToNextVisited">[docs]</a>    <span class="k">def</span> <span class="nf">canGoToNextVisited</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">beadPointer</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beadList</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">beadPointer</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beadList</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">beadPointer</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beadList</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="nodeHistory.canGoToPrevVisited"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.nodeHistory.canGoToPrevVisited">[docs]</a>    <span class="k">def</span> <span class="nf">canGoToPrevVisited</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beadPointer</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">beadPointer</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beadList</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">beadPointer</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="c">#@+node:ekr.20070615132939: *3* clear</span></div>
<div class="viewcode-block" id="nodeHistory.clear"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.nodeHistory.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">beadList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beadPointer</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="c">#@+node:ekr.20070615134813: *3* goNext/Prev</span></div>
<div class="viewcode-block" id="nodeHistory.goNext"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.nodeHistory.goNext">[docs]</a>    <span class="k">def</span> <span class="nf">goNext</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the next visited node, or None.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="p">(</span><span class="bp">False</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">beadPointer</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beadList</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">beadPointer</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">p</span><span class="p">,</span><span class="n">chapter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beadList</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">beadPointer</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">positionExists</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">p</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;does not exist&#39;</span><span class="p">,</span><span class="n">p</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">selectChapter</span><span class="p">(</span><span class="n">chapter</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">p</span>
</div>
<div class="viewcode-block" id="nodeHistory.goPrev"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.nodeHistory.goPrev">[docs]</a>    <span class="k">def</span> <span class="nf">goPrev</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the previous visited node, or None.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="p">(</span><span class="bp">False</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">beadPointer</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">beadPointer</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">p</span><span class="p">,</span><span class="n">chapter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beadList</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">beadPointer</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">positionExists</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">p</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;does not exist&#39;</span><span class="p">,</span><span class="n">p</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">selectChapter</span><span class="p">(</span><span class="n">chapter</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">p</span>
    <span class="c">#@+node:ekr.20070615132939.1: *3* remove</span></div>
<div class="viewcode-block" id="nodeHistory.remove"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.nodeHistory.remove">[docs]</a>    <span class="k">def</span> <span class="nf">remove</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Remove an item from the nav_buttons list.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beadPointer</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">beadList</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">beadPointer</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">beadList</span> <span class="o">=</span> <span class="p">[</span><span class="n">z</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beadList</span>
                            <span class="k">if</span> <span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">positionExists</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">beadPointer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beadList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">beadPointer</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">beadPointer</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;bead list&#39;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">([</span><span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">h</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beadList</span><span class="p">])</span>
    <span class="c">#@+node:ekr.20070615140032: *3* selectChapter</span></div>
<div class="viewcode-block" id="nodeHistory.selectChapter"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.nodeHistory.selectChapter">[docs]</a>    <span class="k">def</span> <span class="nf">selectChapter</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">chapter</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">chapterController</span>

        <span class="k">if</span> <span class="n">cc</span> <span class="ow">and</span> <span class="n">chapter</span> <span class="ow">and</span> <span class="n">chapter</span> <span class="o">!=</span> <span class="n">cc</span><span class="o">.</span><span class="n">getSelectedChapter</span><span class="p">():</span>
            <span class="n">cc</span><span class="o">.</span><span class="n">selectChapterByName</span><span class="p">(</span><span class="n">chapter</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="c">#@+node:ville.20090724234020.14676: *3* update (leoCommands)</span></div>
<div class="viewcode-block" id="nodeHistory.update"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.nodeHistory.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="p">(</span><span class="bp">False</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skipBeadUpdate</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">beadList</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">beadList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">p</span><span class="p">:</span>
            <span class="c"># do not re-append the same node</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">p</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

        <span class="n">cc</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">chapterController</span>
        <span class="n">theChapter</span> <span class="o">=</span> <span class="n">cc</span> <span class="ow">and</span> <span class="n">cc</span><span class="o">.</span><span class="n">getSelectedChapter</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">theChapter</span><span class="p">)</span>

        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># This makes no sense.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">beadPointer</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beadList</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c"># if we came to new node, truncate bead list</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">beadList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beadList</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">beadPointer</span><span class="p">]</span>
                <span class="k">if</span> <span class="bp">True</span> <span class="ow">or</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;truncating&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">beadList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beadPointer</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">beadList</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>    
            <span class="c"># g.trace(&#39;bead list&#39;,p.h)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">([</span><span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">h</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beadList</span><span class="p">])</span>
    <span class="c">#@+node:ekr.20070615140655: *3* visitedPositions</span></div>
<div class="viewcode-block" id="nodeHistory.visitedPositions"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoCommands.nodeHistory.visitedPositions">[docs]</a>    <span class="k">def</span> <span class="nf">visitedPositions</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">chapter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">beadList</span><span class="p">]</span>
    <span class="c">#@-others</span>
<span class="c">#@-others</span>
<span class="c">#@-leo</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Leo API 4.11dev documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Ed K. Ream.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
  </body>
</html>