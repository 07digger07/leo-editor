<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>leo.core.leoPlugins &mdash; Leo API 4.11dev documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '4.11dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Leo API 4.11dev documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Leo API 4.11dev documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for leo.core.leoPlugins</h1><div class="highlight"><pre>
<span class="c">#@+leo-ver=5-thin</span>
<span class="c">#@+node:ekr.20031218072017.3439: * @file leoPlugins.py</span>
<span class="sd">&#39;&#39;&#39;define the LeoPluginsController class.&#39;&#39;&#39;</span>

<span class="c">#@@language python</span>
<span class="c">#@@tabwidth -4</span>
<span class="c">#@@pagewidth 70</span>

<span class="kn">import</span> <span class="nn">leo.core.leoGlobals</span> <span class="kn">as</span> <span class="nn">g</span>
<span class="c"># import bisect</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="c">#@+others</span>
<span class="c">#@+node:ekr.20100908125007.6041: ** Top-level functions</span>
<div class="viewcode-block" id="init"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoPlugins.init">[docs]</a><span class="k">def</span> <span class="nf">init</span><span class="p">():</span>

    <span class="sd">&#39;&#39;&#39;Init g.app.pluginsController.&#39;&#39;&#39;</span>

    <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">pluginsController</span> <span class="o">=</span> <span class="n">LeoPluginsController</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="registerHandler"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoPlugins.registerHandler">[docs]</a><span class="k">def</span> <span class="nf">registerHandler</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;A wrapper so plugins can still call leoPlugins.registerHandler.&#39;&#39;&#39;</span>

    <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">pluginsController</span><span class="o">.</span><span class="n">registerHandler</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
<span class="c">#@+node:ville.20090222141717.2: ** TryNext (exception)</span></div>
<div class="viewcode-block" id="TryNext"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoPlugins.TryNext">[docs]</a><span class="k">class</span> <span class="nc">TryNext</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Try next hook exception.</span>

<span class="sd">    Raise this in your hook function to indicate that the next hook handler</span>
<span class="sd">    should be used to handle the operation.  If you pass arguments to the</span>
<span class="sd">    constructor those arguments will be used by the next hook instead of the</span>
<span class="sd">    original ones.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
<span class="c">#@+node:ekr.20100908125007.6033: ** class CommandChainDispatcher</span></div>
<div class="viewcode-block" id="CommandChainDispatcher"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoPlugins.CommandChainDispatcher">[docs]</a><span class="k">class</span> <span class="nc">CommandChainDispatcher</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Dispatch calls to a chain of commands until some func can handle it</span>

<span class="sd">    Usage: instantiate, execute &quot;add&quot; to add commands (with optional</span>
<span class="sd">    priority), execute normally via f() calling mechanism.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">commands</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">commands</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chain</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chain</span> <span class="o">=</span> <span class="n">commands</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Command chain is called just like normal func. </span>

<span class="sd">        This will call all funcs in chain with the same args as were given to this</span>
<span class="sd">        function, and return the result of first func that didn&#39;t raise</span>
<span class="sd">        TryNext &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">prio</span><span class="p">,</span><span class="n">cmd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">:</span>
            <span class="c">#print &quot;prio&quot;,prio,&quot;cmd&quot;,cmd #dbg</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">ret</span>
            <span class="k">except</span> <span class="n">TryNext</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">args</span> <span class="ow">or</span> <span class="n">exc</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
                    <span class="n">args</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">args</span>
                    <span class="n">kw</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">kwargs</span>

        <span class="c"># if no function will accept it, raise TryNext up to the caller</span>
        <span class="k">raise</span> <span class="n">TryNext</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">)</span>

<div class="viewcode-block" id="CommandChainDispatcher.add"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoPlugins.CommandChainDispatcher.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add a func to the cmd chain with given priority &quot;&quot;&quot;</span>
        <span class="c"># Fails in Python 3: func is not orderable.</span>
        <span class="c"># bisect.insort(self.chain,(priority,func))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">priority</span><span class="p">,</span><span class="n">func</span><span class="p">),)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">z</span><span class="p">:</span><span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</div>
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return all objects in chain.</span>

<span class="sd">        Handy if the objects are not callable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="p">)</span>
<span class="c">#@+node:ekr.20100908125007.6009: ** class baseLeoPlugin</span></div>
<div class="viewcode-block" id="baseLeoPlugin"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoPlugins.baseLeoPlugin">[docs]</a><span class="k">class</span> <span class="nc">baseLeoPlugin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c">#@+&lt;&lt;docstring&gt;&gt;</span>
    <span class="c">#@+node:ekr.20100908125007.6010: *3* &lt;&lt;docstring&gt;&gt;</span>
    <span class="sd">&quot;&quot;&quot;A Convenience class to simplify plugin authoring</span>

<span class="sd">    .. contents::</span>

<span class="sd">    Usage</span>
<span class="sd">    =====</span>


<span class="sd">    Initialization</span>
<span class="sd">    --------------</span>

<span class="sd">    - import the base class::</span>

<span class="sd">        from leoPlugins import leo.core.leoBasePlugin as leoBasePlugin</span>

<span class="sd">    - create a class which inherits from leoBasePlugin::</span>

<span class="sd">        class myPlugin(leoBasePlugin):</span>

<span class="sd">    - in the __init__ method of the class, call the parent constructor::</span>

<span class="sd">        def __init__(self, tag, keywords):</span>
<span class="sd">            leoBasePlugin.__init__(self, tag, keywords)</span>

<span class="sd">    - put the actual plugin code into a method; for this example, the work</span>
<span class="sd">      is done by myPlugin.handler()</span>

<span class="sd">    - put the class in a file which lives in the &lt;LeoDir&gt;/plugins directory</span>
<span class="sd">        for this example it is named myPlugin.py</span>

<span class="sd">    - add code to register the plugin::</span>

<span class="sd">        leoPlugins.registerHandler(&quot;after-create-leo-frame&quot;, Hello)</span>

<span class="sd">    Configuration</span>
<span class="sd">    -------------</span>

<span class="sd">    baseLeoPlugins has 3 *methods* for setting commands</span>

<span class="sd">    - setCommand::</span>

<span class="sd">            def setCommand(self, commandName, handler, </span>
<span class="sd">                    shortcut = None, pane = &#39;all&#39;, verbose = True):</span>

<span class="sd">    - setMenuItem::</span>

<span class="sd">            def setMenuItem(self, menu, commandName = None, handler = None):</span>

<span class="sd">    - setButton::</span>

<span class="sd">            def setButton(self, buttonText = None, commandName = None, color = None):</span>

<span class="sd">    *variables*</span>

<span class="sd">    :commandName:  the string typed into minibuffer to execute the ``handler``</span>

<span class="sd">    :handler:  the method in the class which actually does the work</span>

<span class="sd">    :shortcut:  the key combination to activate the command</span>

<span class="sd">    :menu:  a string designating on of the menus (&#39;File&#39;, Edit&#39;, &#39;Outline&#39;, ...)</span>

<span class="sd">    :buttonText:  the text to put on the button if one is being created.</span>

<span class="sd">    Example</span>
<span class="sd">    =======</span>

<span class="sd">    Contents of file ``&lt;LeoDir&gt;/plugins/hello.py``::</span>

<span class="sd">        class Hello(baseLeoPlugin):</span>
<span class="sd">            def __init__(self, tag, keywords):</span>

<span class="sd">                # call parent __init__</span>
<span class="sd">                baseLeoPlugin.__init__(self, tag, keywords)</span>

<span class="sd">                # if the plugin object defines only one command, </span>
<span class="sd">                # just give it a name. You can then create a button and menu entry</span>
<span class="sd">                self.setCommand(&#39;Hello&#39;, self.hello)</span>
<span class="sd">                self.setButton()</span>
<span class="sd">                self.setMenuItem(&#39;Cmds&#39;)</span>

<span class="sd">                # create a command with a shortcut</span>
<span class="sd">                self.setCommand(&#39;Hola&#39;, self.hola, &#39;Alt-Ctrl-H&#39;)</span>

<span class="sd">                # create a button using different text than commandName</span>
<span class="sd">                self.setButton(&#39;Hello in Spanish&#39;)</span>

<span class="sd">                # create a menu item with default text</span>
<span class="sd">                self.setMenuItem(&#39;Cmds&#39;)</span>

<span class="sd">                # define a command using setMenuItem </span>
<span class="sd">                self.setMenuItem(&#39;Cmds&#39;, &#39;Ciao baby&#39;, self.ciao)</span>

<span class="sd">            def hello(self, event):</span>
<span class="sd">                g.pr(&quot;hello from node %s&quot; % self.c.p.h)</span>

<span class="sd">            def hola(self, event):</span>
<span class="sd">                g.pr(&quot;hola from node %s&quot; % self.c.p.h)</span>

<span class="sd">            def ciao(self, event):</span>
<span class="sd">                g.pr(&quot;ciao baby (%s)&quot; % self.c.p.h)</span>


<span class="sd">        leoPlugins.registerHandler(&quot;after-create-leo-frame&quot;, Hello)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#@-&lt;&lt;docstring&gt;&gt;</span>
    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20100908125007.6012: *3* __init__ (baseLeoPlugin)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">keywords</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Set self.c to be the ``commander`` of the active node</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">keywords</span><span class="p">[</span><span class="s">&#39;c&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commandNames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c">#@+node:ekr.20100908125007.6013: *3* setCommand</span>
<div class="viewcode-block" id="baseLeoPlugin.setCommand"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoPlugins.baseLeoPlugin.setCommand">[docs]</a>    <span class="k">def</span> <span class="nf">setCommand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commandName</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> 
                    <span class="n">shortcut</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">pane</span> <span class="o">=</span> <span class="s">&#39;all&#39;</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Associate a command name with handler code, </span>
<span class="sd">        optionally defining a keystroke shortcut</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">commandNames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">commandName</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">commandName</span> <span class="o">=</span> <span class="n">commandName</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shortcut</span> <span class="o">=</span> <span class="n">shortcut</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">handler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">registerCommand</span> <span class="p">(</span><span class="n">commandName</span><span class="p">,</span> <span class="n">shortcut</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> 
                                <span class="n">pane</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100908125007.6014: *3* setMenuItem</span></div>
<div class="viewcode-block" id="baseLeoPlugin.setMenuItem"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoPlugins.baseLeoPlugin.setMenuItem">[docs]</a>    <span class="k">def</span> <span class="nf">setMenuItem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">menu</span><span class="p">,</span> <span class="n">commandName</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">handler</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Create a menu item in &#39;menu&#39; using text &#39;commandName&#39; calling handler &#39;handler&#39;</span>
<span class="sd">        if commandName and handler are none, use the most recently defined values</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># setMenuItem can create a command, or use a previously defined one.</span>
        <span class="k">if</span> <span class="n">commandName</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">commandName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commandName</span>
        <span class="c"># make sure commandName is in the list of commandNames                        </span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">commandName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">commandNames</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">commandNames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">commandName</span><span class="p">)</span> 

        <span class="k">if</span> <span class="n">handler</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handler</span>

        <span class="n">table</span> <span class="o">=</span> <span class="p">((</span><span class="n">commandName</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">handler</span><span class="p">),)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">createMenuItemsFromTable</span><span class="p">(</span><span class="n">menu</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100908125007.6015: *3* setButton</span></div>
<div class="viewcode-block" id="baseLeoPlugin.setButton"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoPlugins.baseLeoPlugin.setButton">[docs]</a>    <span class="k">def</span> <span class="nf">setButton</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">buttonText</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">commandName</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Associate an existing command with a &#39;button&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">buttonText</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">buttonText</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commandName</span>

        <span class="k">if</span> <span class="n">commandName</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">commandName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commandName</span>       
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">commandName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">commandNames</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s">&quot;setButton error, </span><span class="si">%s</span><span class="s"> is not a commandName&quot;</span> <span class="o">%</span> <span class="n">commandName</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="s">&#39;grey&#39;</span>
        <span class="n">script</span> <span class="o">=</span> <span class="s">&quot;c.k.simulateCommand(&#39;</span><span class="si">%s</span><span class="s">&#39;)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">commandName</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">makeScriptButton</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">script</span><span class="o">=</span><span class="n">script</span><span class="p">,</span> 
            <span class="n">buttonText</span> <span class="o">=</span> <span class="n">buttonText</span><span class="p">,</span> <span class="n">bg</span> <span class="o">=</span> <span class="n">color</span><span class="p">)</span>
    <span class="c">#@-others</span>
<span class="c">#@+node:ekr.20100908125007.6007: ** class LeoPluginsController</span></div></div>
<div class="viewcode-block" id="LeoPluginsController"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoPlugins.LeoPluginsController">[docs]</a><span class="k">class</span> <span class="nc">LeoPluginsController</span><span class="p">:</span>

    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20100909065501.5954: *3* Birth</span>
    <span class="c">#@+node:ekr.20100908125007.6034: *4* pc.ctor</span>
    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># g.trace(&#39;LeoPluginsController&#39;,g.callers())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadedModulesFilesDict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c"># Keys are regularized module names, values are the names of .leo files</span>
            <span class="c"># containing @enabled-plugins nodes that caused the plugin to be loaded</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadedModules</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c"># Keys are regularized module names, values are modules.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadingModuleNameStack</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c"># The stack of module names.</span>
            <span class="c"># The top is the module being loaded.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">signonModule</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># A hack for plugin_signon.</span>

        <span class="c"># Settings.  Set these here in case finishCreate is never called.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warn_on_failure</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">assert</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">act_on_node</span> <span class="o">=</span> <span class="n">CommandChainDispatcher</span><span class="p">()</span>
        <span class="n">g</span><span class="o">.</span><span class="n">visit_tree_item</span> <span class="o">=</span> <span class="n">CommandChainDispatcher</span><span class="p">()</span>
        <span class="n">g</span><span class="o">.</span><span class="n">tree_popup_handlers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c">#@+node:ekr.20100909065501.5974: *4* pc.finishCreate</span>
<div class="viewcode-block" id="LeoPluginsController.finishCreate"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoPlugins.LeoPluginsController.finishCreate">[docs]</a>    <span class="k">def</span> <span class="nf">finishCreate</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Set configuration settings for LeoPluginsController.</span>

<span class="sd">        Nothing bad will happen if this is never called.&#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">warn_on_failure</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getBool</span><span class="p">(</span>
            <span class="n">setting</span><span class="o">=</span><span class="s">&#39;warn_when_plugins_fail_to_load&#39;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100909065501.5952: *3* Event handlers</span>
    <span class="c">#@+node:ekr.20100908125007.6016: *4* callTagHandler</span></div>
<div class="viewcode-block" id="LeoPluginsController.callTagHandler"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoPlugins.LeoPluginsController.callTagHandler">[docs]</a>    <span class="k">def</span> <span class="nf">callTagHandler</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">bunch</span><span class="p">,</span><span class="n">tag</span><span class="p">,</span><span class="n">keywords</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">traceIdle</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="n">handler</span> <span class="o">=</span> <span class="n">bunch</span><span class="o">.</span><span class="n">fn</span> <span class="p">;</span> <span class="n">moduleName</span> <span class="o">=</span> <span class="n">bunch</span><span class="o">.</span><span class="n">moduleName</span>

        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="p">(</span><span class="n">traceIdle</span> <span class="ow">or</span> <span class="n">tag</span> <span class="o">!=</span> <span class="s">&#39;idle&#39;</span><span class="p">):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">keywords</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;c&#39;</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">moduleName</span> <span class="p">;</span> <span class="n">tag2</span> <span class="o">=</span> <span class="s">&#39;leo.plugins.&#39;</span>
            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">tag2</span><span class="p">):</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">tag2</span><span class="p">):]</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;c: </span><span class="si">%s</span><span class="s"> </span><span class="si">%23s</span><span class="s"> : </span><span class="si">%s</span><span class="s"> . </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">c</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">()</span> <span class="ow">or</span> <span class="s">&#39;&lt;no c&gt;&#39;</span><span class="p">,</span>
                <span class="n">tag</span><span class="p">,</span><span class="n">handler</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span><span class="n">name</span><span class="p">))</span>

        <span class="c"># Make sure the new commander exists.</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;c&#39;</span><span class="p">,</span><span class="s">&#39;new_c&#39;</span><span class="p">):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">keywords</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                <span class="c"># Make sure c exists and has a frame.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">exists</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&#39;frame&#39;</span><span class="p">):</span>
                    <span class="c"># g.pr(&#39;skipping tag %s: c does not exist or does not have a frame.&#39; % tag)</span>
                    <span class="k">return</span> <span class="bp">None</span>

        <span class="c"># Calls to registerHandler from inside the handler belong to moduleName.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadingModuleNameStack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">moduleName</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">handler</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="n">keywords</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;hook failed: </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">moduleName</span><span class="p">))</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadingModuleNameStack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="c">#@+node:ekr.20100908125007.6017: *4* doHandlersForTag</span></div>
<div class="viewcode-block" id="LeoPluginsController.doHandlersForTag"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoPlugins.LeoPluginsController.doHandlersForTag">[docs]</a>    <span class="k">def</span> <span class="nf">doHandlersForTag</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tag</span><span class="p">,</span><span class="n">keywords</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Execute all handlers for a given tag, in alphabetical order.</span>

<span class="sd">        All exceptions are caught by the caller, doHook.&quot;&quot;&quot;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">traceIdle</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">killed</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="p">(</span><span class="n">traceIdle</span> <span class="ow">or</span> <span class="n">tag</span> <span class="o">!=</span> <span class="s">&#39;idle&#39;</span><span class="p">):</span>
            <span class="n">event_p</span> <span class="o">=</span> <span class="n">keywords</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;new_p&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">keywords</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;p&#39;</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="n">event_p</span><span class="o">.</span><span class="n">h</span> <span class="k">if</span> <span class="n">event_p</span> <span class="k">else</span> <span class="s">&#39;&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
            <span class="n">bunches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
            <span class="c"># Execute hooks in some random order.</span>
            <span class="c"># Return if one of them returns a non-None result.</span>
            <span class="k">for</span> <span class="n">bunch</span> <span class="ow">in</span> <span class="n">bunches</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">callTagHandler</span><span class="p">(</span><span class="n">bunch</span><span class="p">,</span><span class="n">tag</span><span class="p">,</span><span class="n">keywords</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">val</span>

        <span class="k">if</span> <span class="s">&#39;all&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
            <span class="n">bunches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;all&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">bunch</span> <span class="ow">in</span> <span class="n">bunches</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">callTagHandler</span><span class="p">(</span><span class="n">bunch</span><span class="p">,</span><span class="n">tag</span><span class="p">,</span><span class="n">keywords</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20100908125007.6018: *4* doPlugins</span>
    <span class="c"># This is the default g.app.hookFunction.</span>
</div>
<div class="viewcode-block" id="LeoPluginsController.doPlugins"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoPlugins.LeoPluginsController.doPlugins">[docs]</a>    <span class="k">def</span> <span class="nf">doPlugins</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tag</span><span class="p">,</span><span class="n">keywords</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">killed</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c"># g.trace(tag,g.callers())</span>

        <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;start1&#39;</span><span class="p">,</span><span class="s">&#39;open0&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loadHandlers</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="n">keywords</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">doHandlersForTag</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="n">keywords</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100909065501.5950: *3* Information</span>
    <span class="c">#@+node:ekr.20100908125007.6019: *4* getHandlersForTag</span></div>
<div class="viewcode-block" id="LeoPluginsController.getHandlersForTag"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoPlugins.LeoPluginsController.getHandlersForTag">[docs]</a>    <span class="k">def</span> <span class="nf">getHandlersForTag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tags</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">type</span><span class="p">((),),</span><span class="nb">type</span><span class="p">([])):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                <span class="n">aList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getHandlersForOneTag</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span> 
                <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">aList</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">getHandlersForOneTag</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="LeoPluginsController.getHandlersForOneTag"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoPlugins.LeoPluginsController.getHandlersForOneTag">[docs]</a>    <span class="k">def</span> <span class="nf">getHandlersForOneTag</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tag</span><span class="p">):</span>

        <span class="n">aList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">,[])</span>
        <span class="k">return</span> <span class="n">aList</span>
    <span class="c">#@+node:ekr.20100910075900.10204: *4* getLoadedPlugins</span></div>
<div class="viewcode-block" id="LeoPluginsController.getLoadedPlugins"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoPlugins.LeoPluginsController.getLoadedPlugins">[docs]</a>    <span class="k">def</span> <span class="nf">getLoadedPlugins</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loadedModules</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="c">#@+node:ekr.20100908125007.6020: *4* getPluginModule</span></div>
<div class="viewcode-block" id="LeoPluginsController.getPluginModule"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoPlugins.LeoPluginsController.getPluginModule">[docs]</a>    <span class="k">def</span> <span class="nf">getPluginModule</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">moduleName</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadedModules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">moduleName</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100908125007.6021: *4* isLoaded</span></div>
<div class="viewcode-block" id="LeoPluginsController.isLoaded"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoPlugins.LeoPluginsController.isLoaded">[docs]</a>    <span class="k">def</span> <span class="nf">isLoaded</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">regularizeName</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadedModules</span>
    <span class="c">#@+node:ekr.20100908125007.6025: *4* printHandlers</span></div>
<div class="viewcode-block" id="LeoPluginsController.printHandlers"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoPlugins.LeoPluginsController.printHandlers">[docs]</a>    <span class="k">def</span> <span class="nf">printHandlers</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">moduleName</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Print the handlers for each plugin.&#39;&#39;&#39;</span>

        <span class="n">tabName</span> <span class="o">=</span> <span class="s">&#39;Plugins&#39;</span>
        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">selectTab</span><span class="p">(</span><span class="n">tabName</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">moduleName</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;handlers for </span><span class="si">%s</span><span class="s">...</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">moduleName</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;all plugin handlers...</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="n">s</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="n">tabName</span><span class="o">=</span><span class="n">tabName</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">modules</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
            <span class="n">bunches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">bunch</span> <span class="ow">in</span> <span class="n">bunches</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">bunch</span><span class="o">.</span><span class="n">moduleName</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="n">modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,[])</span>
                <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
                <span class="n">modules</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">tags</span>

        <span class="n">n</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">modules</span><span class="p">):</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="n">modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">moduleName</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">tag</span><span class="p">))</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tag</span><span class="p">,</span><span class="n">key</span><span class="p">),)</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;</span><span class="si">%*s</span><span class="s"> </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="o">-</span><span class="n">n</span><span class="p">,</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">)</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span><span class="n">tabName</span><span class="o">=</span><span class="n">tabName</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100908125007.6026: *4* printPlugins</span></div>
<div class="viewcode-block" id="LeoPluginsController.printPlugins"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoPlugins.LeoPluginsController.printPlugins">[docs]</a>    <span class="k">def</span> <span class="nf">printPlugins</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Print all enabled plugins.&#39;&#39;&#39;</span>

        <span class="n">tabName</span> <span class="o">=</span> <span class="s">&#39;Plugins&#39;</span>
        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">selectTab</span><span class="p">(</span><span class="n">tabName</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;enabled plugins...</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loadedModules</span><span class="p">):</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span><span class="n">tabName</span><span class="o">=</span><span class="n">tabName</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100908125007.6027: *4* printPluginsInfo</span></div>
<div class="viewcode-block" id="LeoPluginsController.printPluginsInfo"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoPlugins.LeoPluginsController.printPluginsInfo">[docs]</a>    <span class="k">def</span> <span class="nf">printPluginsInfo</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Print the file name responsible for loading a plugin.</span>

<span class="sd">        This is the first .leo file containing an @enabled-plugins node</span>
<span class="sd">        that enables the plugin.&#39;&#39;&#39;</span>

        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadedModulesFilesDict</span>
        <span class="n">tabName</span> <span class="o">=</span> <span class="s">&#39;Plugins&#39;</span>
        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">selectTab</span><span class="p">(</span><span class="n">tabName</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="k">for</span> <span class="n">moduleName</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">moduleName</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">moduleName</span><span class="p">))</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">moduleName</span><span class="p">,</span><span class="n">fileName</span><span class="p">),)</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;</span><span class="si">%*s</span><span class="s"> </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="o">-</span><span class="n">n</span><span class="p">,</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">)</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
        <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span><span class="n">tabName</span><span class="o">=</span><span class="n">tabName</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100909065501.5949: *4* regularizeName</span></div>
<div class="viewcode-block" id="LeoPluginsController.regularizeName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoPlugins.LeoPluginsController.regularizeName">[docs]</a>    <span class="k">def</span> <span class="nf">regularizeName</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the name used as a key to this modules dictionaries.&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">fn</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.py&#39;</span><span class="p">):</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="s">&quot;leo.plugins.&quot;</span> <span class="o">+</span> <span class="n">fn</span> <span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">fn</span>
    <span class="c">#@+node:ekr.20100909104341.5979: *4* setLoaded</span></div>
<div class="viewcode-block" id="LeoPluginsController.setLoaded"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoPlugins.LeoPluginsController.setLoaded">[docs]</a>    <span class="k">def</span> <span class="nf">setLoaded</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span><span class="n">m</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loadedModules</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">regularizeName</span><span class="p">(</span><span class="n">fn</span><span class="p">)]</span> <span class="o">=</span> <span class="n">m</span>

    <span class="c">#@+node:ekr.20100909065501.5953: *3* Load &amp; unload</span>
    <span class="c">#@+node:ekr.20100908125007.6022: *4* loadHandlers</span></div>
<div class="viewcode-block" id="LeoPluginsController.loadHandlers"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoPlugins.LeoPluginsController.loadHandlers">[docs]</a>    <span class="k">def</span> <span class="nf">loadHandlers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tag</span><span class="p">,</span><span class="n">keys</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Load all enabled plugins from the plugins directory&quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">pr</span> <span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">)</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getEnabledPlugins</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span> <span class="k">return</span>

        <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;open0&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">silentMode</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">batchMode</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">s2</span> <span class="o">=</span> <span class="s">&#39;@enabled-plugins found in </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">enabledPluginsFileName</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">plugin</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">plugin</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loadOnePlugin</span><span class="p">(</span><span class="n">plugin</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100908125007.6024: *4* loadOnePlugin</span></div>
<div class="viewcode-block" id="LeoPluginsController.loadOnePlugin"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoPlugins.LeoPluginsController.loadOnePlugin">[docs]</a>    <span class="k">def</span> <span class="nf">loadOnePlugin</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">moduleOrFileName</span><span class="p">,</span><span class="n">tag</span><span class="o">=</span><span class="s">&#39;open0&#39;</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">True</span> <span class="ow">or</span> <span class="n">verbose</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">enablePlugins</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;plugins disabled&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">moduleOrFileName</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;ignoring Leo directive&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
                <span class="c"># Return None, not False, to keep pylint happy.</span>
                <span class="c"># Allow Leo directives in @enabled-plugins nodes.</span>

        <span class="n">moduleName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regularizeName</span><span class="p">(</span><span class="n">moduleOrFileName</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isLoaded</span><span class="p">(</span><span class="n">moduleName</span><span class="p">):</span>
            <span class="n">module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadedModules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">moduleName</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;loadOnePlugin: plugin&#39;</span><span class="p">,</span><span class="n">moduleName</span><span class="p">,</span><span class="s">&#39;already loaded&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">module</span>

        <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadDir</span>

        <span class="n">moduleName</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicode</span><span class="p">(</span><span class="n">moduleName</span><span class="p">)</span>

        <span class="c"># This import will typically result in calls to registerHandler.</span>
        <span class="c"># if the plugin does _not_ use the init top-level function.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loadingModuleNameStack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">moduleName</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="nb">__import__</span><span class="p">(</span><span class="n">moduleName</span><span class="p">)</span>
            <span class="c"># need to look up through sys.modules, __import__ returns toplevel package</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">moduleName</span><span class="p">]</span>

        <span class="k">except</span> <span class="n">g</span><span class="o">.</span><span class="n">UiTypeException</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">batchMode</span><span class="p">):</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;Plugin </span><span class="si">%s</span><span class="s"> does not support </span><span class="si">%s</span><span class="s"> gui&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">moduleName</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">guiName</span><span class="p">()))</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span> <span class="ow">or</span> <span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;open0&#39;</span><span class="p">:</span> <span class="c"># Just give the warning once.</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;error importing plugin:&#39;</span><span class="p">,</span><span class="n">moduleName</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">except</span> <span class="ne">SyntaxError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span> <span class="ow">or</span> <span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;open0&#39;</span><span class="p">:</span> <span class="c"># Just give the warning once.</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;syntax error importing plugin:&#39;</span><span class="p">,</span><span class="n">moduleName</span><span class="p">)</span>
                <span class="c"># g.es_exception()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;exception importing plugin &#39;</span> <span class="o">+</span> <span class="n">moduleName</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loadingModuleNameStack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">signonModule</span> <span class="o">=</span> <span class="n">result</span> <span class="c"># for self.plugin_signon.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loadingModuleNameStack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">moduleName</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;unit-test-load&#39;</span><span class="p">:</span>
                <span class="k">pass</span> <span class="c"># Keep the result, but do no more.</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="s">&#39;init&#39;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c"># Indicate success only if init_result is True.</span>
                    <span class="n">init_result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">init_result</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span><span class="bp">False</span><span class="p">):</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Error: </span><span class="si">%s</span><span class="s">.init did not return a bool&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">moduleName</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">init_result</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">loadedModules</span><span class="p">[</span><span class="n">moduleName</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">loadedModulesFilesDict</span><span class="p">[</span><span class="n">moduleName</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">enabledPluginsFileName</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">initing</span><span class="p">:</span>
                            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;loadOnePlugin: failed to load module&#39;</span><span class="p">,</span><span class="n">moduleName</span><span class="p">)</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;exception loading plugin&#39;</span><span class="p">)</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># No top-level init function.</span>
                <span class="c"># Guess that the module was loaded correctly,</span>
                <span class="c"># but do *not* load the plugin if we are unit testing.</span>

                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">loadedModules</span><span class="p">[</span><span class="n">moduleName</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;no init()&#39;</span><span class="p">,</span><span class="n">moduleName</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">loadedModules</span><span class="p">[</span><span class="n">moduleName</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loadingModuleNameStack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">batchMode</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">inBridge</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&#39;loadOnePlugin: loaded&#39;</span><span class="p">,</span><span class="n">moduleName</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">trace</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">warn_on_failure</span> <span class="ow">or</span> <span class="p">(</span><span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">initing</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">trace</span> <span class="ow">or</span> <span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;open0&#39;</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;loadOnePlugin: can not load enabled plugin:&#39;</span><span class="p">,</span><span class="n">moduleName</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>
    <span class="c">#@+node:ekr.20031218072017.1318: *4* plugin_signon</span></div>
<div class="viewcode-block" id="LeoPluginsController.plugin_signon"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoPlugins.LeoPluginsController.plugin_signon">[docs]</a>    <span class="k">def</span> <span class="nf">plugin_signon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">module_name</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="c"># This is called from as the result of the imports</span>
        <span class="c"># in self.loadOnePlugin</span>

        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">signonModule</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&quot;...</span><span class="si">%s</span><span class="s">.py v</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">m</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">__version__</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">plugin_date</span><span class="p">(</span><span class="n">m</span><span class="p">)))</span>

            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">signonModule</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># Prevent double signons.</span>
    <span class="c">#@+node:ekr.20100908125007.6030: *4* unloadOnePlugin</span></div>
<div class="viewcode-block" id="LeoPluginsController.unloadOnePlugin"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoPlugins.LeoPluginsController.unloadOnePlugin">[docs]</a>    <span class="k">def</span> <span class="nf">unloadOnePlugin</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">moduleOrFileName</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="n">moduleName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regularizeName</span><span class="p">(</span><span class="n">moduleOrFileName</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isLoaded</span><span class="p">(</span><span class="n">moduleName</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;unloading&#39;</span><span class="p">,</span><span class="n">moduleName</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadedModules</span><span class="p">[</span><span class="n">moduleName</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
            <span class="n">bunches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
            <span class="n">bunches</span> <span class="o">=</span> <span class="p">[</span><span class="n">bunch</span> <span class="k">for</span> <span class="n">bunch</span> <span class="ow">in</span> <span class="n">bunches</span> <span class="k">if</span> <span class="n">bunch</span><span class="o">.</span><span class="n">moduleName</span> <span class="o">!=</span> <span class="n">moduleName</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">bunches</span>
    <span class="c">#@+node:ekr.20100909065501.5951: *3* Registration</span>
    <span class="c">#@+node:ekr.20100908125007.6028: *4* registerExclusiveHandler</span></div>
<div class="viewcode-block" id="LeoPluginsController.registerExclusiveHandler"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoPlugins.LeoPluginsController.registerExclusiveHandler">[docs]</a>    <span class="k">def</span> <span class="nf">registerExclusiveHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tags</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; Register one or more exclusive handlers&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">type</span><span class="p">((),),</span><span class="nb">type</span><span class="p">([])):</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">registerOneExclusiveHandler</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">registerOneExclusiveHandler</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="LeoPluginsController.registerOneExclusiveHandler"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoPlugins.LeoPluginsController.registerOneExclusiveHandler">[docs]</a>    <span class="k">def</span> <span class="nf">registerOneExclusiveHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tag</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Register one exclusive handler&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">moduleName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadingModuleNameStack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">moduleName</span> <span class="o">=</span> <span class="s">&#39;&lt;no module&gt;&#39;</span>

        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%6s</span><span class="s"> </span><span class="si">%15s</span><span class="s"> </span><span class="si">%25s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">,</span><span class="n">moduleName</span><span class="p">,</span><span class="n">tag</span><span class="p">,</span><span class="n">fn</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span> <span class="k">return</span>

        <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;*** Two exclusive handlers for&quot;</span><span class="p">,</span><span class="s">&quot;&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bunch</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">Bunch</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="n">fn</span><span class="p">,</span><span class="n">moduleName</span><span class="o">=</span><span class="n">moduleName</span><span class="p">,</span><span class="n">tag</span><span class="o">=</span><span class="s">&#39;handler&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">[</span><span class="n">bunch</span><span class="p">]</span>
    <span class="c">#@+node:ekr.20100908125007.6029: *4* registerHandler</span></div>
<div class="viewcode-block" id="LeoPluginsController.registerHandler"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoPlugins.LeoPluginsController.registerHandler">[docs]</a>    <span class="k">def</span> <span class="nf">registerHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tags</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; Register one or more handlers&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">type</span><span class="p">((),),</span><span class="nb">type</span><span class="p">([])):</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">registerOneHandler</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">registerOneHandler</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="LeoPluginsController.registerOneHandler"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoPlugins.LeoPluginsController.registerOneHandler">[docs]</a>    <span class="k">def</span> <span class="nf">registerOneHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tag</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Register one handler&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">moduleName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadingModuleNameStack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">moduleName</span> <span class="o">=</span> <span class="s">&#39;&lt;no module&gt;&#39;</span>

        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%6s</span><span class="s"> </span><span class="si">%15s</span><span class="s"> </span><span class="si">%25s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">,</span><span class="n">moduleName</span><span class="p">,</span><span class="n">tag</span><span class="p">,</span><span class="n">fn</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>

        <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">,[])</span>
        <span class="k">if</span> <span class="n">fn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="n">bunch</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">Bunch</span><span class="p">(</span><span class="n">fn</span><span class="o">=</span><span class="n">fn</span><span class="p">,</span><span class="n">moduleName</span><span class="o">=</span><span class="n">moduleName</span><span class="p">,</span><span class="n">tag</span><span class="o">=</span><span class="s">&#39;handler&#39;</span><span class="p">)</span>
            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bunch</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">items</span>
    <span class="c">#@+node:ekr.20100908125007.6031: *4* unregisterHandler</span></div>
<div class="viewcode-block" id="LeoPluginsController.unregisterHandler"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoPlugins.LeoPluginsController.unregisterHandler">[docs]</a>    <span class="k">def</span> <span class="nf">unregisterHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tags</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">type</span><span class="p">((),),</span><span class="nb">type</span><span class="p">([])):</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unregisterOneHandler</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unregisterOneHandler</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="LeoPluginsController.unregisterOneHandler"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoPlugins.LeoPluginsController.unregisterOneHandler">[docs]</a>    <span class="k">def</span> <span class="nf">unregisterOneHandler</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tag</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>

        <span class="n">bunches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
        <span class="n">bunches</span> <span class="o">=</span> <span class="p">[</span><span class="n">bunch</span> <span class="k">for</span> <span class="n">bunch</span> <span class="ow">in</span> <span class="n">bunches</span> <span class="k">if</span> <span class="n">bunch</span><span class="o">.</span><span class="n">fn</span> <span class="o">!=</span> <span class="n">fn</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">bunches</span>
    <span class="c">#@-others</span>
<span class="c">#@-others</span>
<span class="c">#@-leo</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Leo API 4.11dev documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Ed K. Ream.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
  </body>
</html>