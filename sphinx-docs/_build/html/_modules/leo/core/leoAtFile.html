<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>leo.core.leoAtFile &mdash; Leo API 4.11dev documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '4.11dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Leo API 4.11dev documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Leo API 4.11dev documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for leo.core.leoAtFile</h1><div class="highlight"><pre>
<span class="c">#@+leo-ver=5-thin</span>
<span class="c">#@+node:ekr.20041005105605.1: * @file leoAtFile.py</span>
<span class="c">#@@first</span>
    <span class="c"># Needed because of unicode characters in tests.</span>

<span class="sd">&quot;&quot;&quot;Classes to read and write @file nodes.&quot;&quot;&quot;</span>

<span class="c">#@@language python</span>
<span class="c">#@@tabwidth -4</span>
<span class="c">#@@pagewidth 60</span>

<span class="c">#@+&lt;&lt; imports &gt;&gt;</span>
<span class="c">#@+node:ekr.20041005105605.2: ** &lt;&lt; imports &gt;&gt; (leoAtFile)</span>
<span class="kn">import</span> <span class="nn">leo.core.leoGlobals</span> <span class="kn">as</span> <span class="nn">g</span>

<span class="c"># if g.app and g.app.use_psyco:</span>
    <span class="c"># # print(&quot;enabled psyco classes&quot;,__file__)</span>
    <span class="c"># try: from psyco.classes import *</span>
    <span class="c"># except ImportError: pass</span>

<span class="kn">import</span> <span class="nn">leo.core.leoNodes</span> <span class="kn">as</span> <span class="nn">leoNodes</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c">#@-&lt;&lt; imports &gt;&gt;</span>

<span class="n">allow_cloned_sibs</span> <span class="o">=</span> <span class="bp">True</span> <span class="c"># True: allow cloned siblings in @file nodes.</span>

<span class="c"># if allow_cloned_sibs:</span>
    <span class="c"># print(&#39;** allow_cloned_sibs: True&#39;)</span>

<span class="k">class</span> <span class="nc">atFile</span><span class="p">:</span>
<div class="viewcode-block" id="atFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile">[docs]</a>
    <span class="sd">&quot;&quot;&quot;The class implementing the atFile subcommander.&quot;&quot;&quot;</span>

    <span class="c">#@+&lt;&lt; define class constants &gt;&gt;</span>
    <span class="c">#@+node:ekr.20041005105605.5: ** &lt;&lt; define class constants &gt;&gt;</span>
    <span class="c"># These constants must be global to this module</span>
    <span class="c"># because they are shared by several classes.</span>

    <span class="c"># The kind of at_directives.</span>
    <span class="n">noDirective</span>     <span class="o">=</span>  <span class="mi">1</span> <span class="c"># not an at-directive.</span>
    <span class="n">allDirective</span>    <span class="o">=</span>  <span class="mi">2</span> <span class="c"># at-all (4.2)</span>
    <span class="n">docDirective</span>    <span class="o">=</span>  <span class="mi">3</span> <span class="c"># @doc.</span>
    <span class="n">atDirective</span>     <span class="o">=</span>  <span class="mi">4</span> <span class="c"># @&lt;space&gt; or @&lt;newline&gt;</span>
    <span class="n">codeDirective</span>   <span class="o">=</span>  <span class="mi">5</span> <span class="c"># @code</span>
    <span class="n">cDirective</span>      <span class="o">=</span>  <span class="mi">6</span> <span class="c"># @c&lt;space&gt; or @c&lt;newline&gt;</span>
    <span class="n">othersDirective</span> <span class="o">=</span>  <span class="mi">7</span> <span class="c"># at-others</span>
    <span class="n">miscDirective</span>   <span class="o">=</span>  <span class="mi">8</span> <span class="c"># All other directives</span>
    <span class="n">rawDirective</span>    <span class="o">=</span>  <span class="mi">9</span> <span class="c"># @raw</span>
    <span class="n">endRawDirective</span> <span class="o">=</span> <span class="mi">10</span> <span class="c"># @end_raw</span>

    <span class="c"># The kind of sentinel line.</span>
    <span class="n">noSentinel</span>   <span class="o">=</span> <span class="mi">20</span> <span class="c"># Not a sentinel</span>
    <span class="n">endAt</span>        <span class="o">=</span> <span class="mi">21</span> <span class="c"># @-at</span>
    <span class="n">endBody</span>      <span class="o">=</span> <span class="mi">22</span> <span class="c"># @-body</span>
    <span class="c"># not used   = 23</span>
    <span class="n">endDoc</span>       <span class="o">=</span> <span class="mi">24</span> <span class="c"># @-doc</span>
    <span class="n">endLeo</span>       <span class="o">=</span> <span class="mi">25</span> <span class="c"># @-leo</span>
    <span class="n">endNode</span>      <span class="o">=</span> <span class="mi">26</span> <span class="c"># @-node</span>
    <span class="n">endOthers</span>    <span class="o">=</span> <span class="mi">27</span> <span class="c"># @-others</span>

    <span class="c"># not used     = 40</span>
    <span class="n">startAt</span>        <span class="o">=</span> <span class="mi">41</span> <span class="c"># @+at</span>
    <span class="n">startBody</span>      <span class="o">=</span> <span class="mi">42</span> <span class="c"># @+body</span>
    <span class="n">startDoc</span>       <span class="o">=</span> <span class="mi">43</span> <span class="c"># @+doc</span>
    <span class="n">startLeo</span>       <span class="o">=</span> <span class="mi">44</span> <span class="c"># @+leo</span>
    <span class="n">startNode</span>      <span class="o">=</span> <span class="mi">45</span> <span class="c"># @+node</span>
    <span class="n">startOthers</span>    <span class="o">=</span> <span class="mi">46</span> <span class="c"># @+others</span>

    <span class="n">startComment</span>   <span class="o">=</span> <span class="mi">60</span> <span class="c"># @comment</span>
    <span class="n">startDelims</span>    <span class="o">=</span> <span class="mi">61</span> <span class="c"># @delims</span>
    <span class="n">startDirective</span> <span class="o">=</span> <span class="mi">62</span> <span class="c"># @@</span>
    <span class="n">startRef</span>       <span class="o">=</span> <span class="mi">63</span> <span class="c"># @&lt; &lt; ... &gt; &gt;</span>
    <span class="n">startVerbatim</span>  <span class="o">=</span> <span class="mi">64</span> <span class="c"># @verbatim</span>
    <span class="n">startVerbatimAfterRef</span> <span class="o">=</span> <span class="mi">65</span> <span class="c"># @verbatimAfterRef (3.0 only)</span>

    <span class="c"># New in 4.x. Paired</span>
    <span class="n">endAll</span>         <span class="o">=</span> <span class="mi">70</span> <span class="c"># at-all (4.2)</span>
    <span class="n">endMiddle</span>      <span class="o">=</span> <span class="mi">71</span> <span class="c"># at-middle (4.2)</span>
    <span class="n">startAll</span>       <span class="o">=</span> <span class="mi">72</span> <span class="c"># at+all (4.2)</span>
    <span class="n">startMiddle</span>    <span class="o">=</span> <span class="mi">73</span> <span class="c"># at+middle (4.2)</span>

    <span class="c"># New in 4.x.  Unpaired.</span>
    <span class="n">startAfterRef</span>  <span class="o">=</span> <span class="mi">80</span> <span class="c"># @afterref (4.0)</span>
    <span class="n">startClone</span>     <span class="o">=</span> <span class="mi">81</span> <span class="c"># @clone (4.2)</span>
    <span class="n">startNl</span>        <span class="o">=</span> <span class="mi">82</span> <span class="c"># @nl (4.0)</span>
    <span class="n">startNonl</span>      <span class="o">=</span> <span class="mi">83</span> <span class="c"># @nonl (4.0)</span>

    <span class="c"># New in 4.8.</span>
    <span class="n">endRef</span>         <span class="o">=</span> <span class="mi">84</span> <span class="c"># @-&lt;&lt;</span>
    <span class="c">#@-&lt;&lt; define class constants &gt;&gt;</span>
    <span class="c">#@+&lt;&lt; define sentinelDict &gt;&gt;</span>
    <span class="c">#@+node:ekr.20041005105605.6: ** &lt;&lt; define sentinelDict &gt;&gt;</span>
    <span class="n">sentinelDict</span> <span class="o">=</span> <span class="p">{</span>

        <span class="c"># Unpaired sentinels: 3.x and 4.x.</span>
        <span class="s">&quot;@comment&quot;</span> <span class="p">:</span> <span class="n">startComment</span><span class="p">,</span>
        <span class="s">&quot;@delims&quot;</span> <span class="p">:</span>  <span class="n">startDelims</span><span class="p">,</span>
        <span class="s">&quot;@verbatim&quot;</span><span class="p">:</span> <span class="n">startVerbatim</span><span class="p">,</span>

        <span class="c"># Unpaired sentinels: 3.x only.</span>
        <span class="s">&quot;@verbatimAfterRef&quot;</span><span class="p">:</span> <span class="n">startVerbatimAfterRef</span><span class="p">,</span>

        <span class="c"># Unpaired sentinels: 4.x only.</span>
        <span class="s">&quot;@afterref&quot;</span> <span class="p">:</span> <span class="n">startAfterRef</span><span class="p">,</span>
        <span class="s">&quot;@clone&quot;</span>    <span class="p">:</span> <span class="n">startClone</span><span class="p">,</span>
        <span class="s">&quot;@nl&quot;</span>       <span class="p">:</span> <span class="n">startNl</span><span class="p">,</span>
        <span class="s">&quot;@nonl&quot;</span>     <span class="p">:</span> <span class="n">startNonl</span><span class="p">,</span>

        <span class="c"># Paired sentinels: 3.x only.</span>
        <span class="s">&quot;@+body&quot;</span><span class="p">:</span>   <span class="n">startBody</span><span class="p">,</span>   <span class="s">&quot;@-body&quot;</span><span class="p">:</span>   <span class="n">endBody</span><span class="p">,</span>

        <span class="c"># Paired sentinels: 3.x and 4.x.</span>
        <span class="s">&quot;@+all&quot;</span><span class="p">:</span>    <span class="n">startAll</span><span class="p">,</span>    <span class="s">&quot;@-all&quot;</span><span class="p">:</span>    <span class="n">endAll</span><span class="p">,</span>
        <span class="s">&quot;@+at&quot;</span><span class="p">:</span>     <span class="n">startAt</span><span class="p">,</span>     <span class="s">&quot;@-at&quot;</span><span class="p">:</span>     <span class="n">endAt</span><span class="p">,</span>
        <span class="s">&quot;@+doc&quot;</span><span class="p">:</span>    <span class="n">startDoc</span><span class="p">,</span>    <span class="s">&quot;@-doc&quot;</span><span class="p">:</span>    <span class="n">endDoc</span><span class="p">,</span>
        <span class="s">&quot;@+leo&quot;</span><span class="p">:</span>    <span class="n">startLeo</span><span class="p">,</span>    <span class="s">&quot;@-leo&quot;</span><span class="p">:</span>    <span class="n">endLeo</span><span class="p">,</span>
        <span class="s">&quot;@+middle&quot;</span><span class="p">:</span> <span class="n">startMiddle</span><span class="p">,</span> <span class="s">&quot;@-middle&quot;</span><span class="p">:</span> <span class="n">endMiddle</span><span class="p">,</span>
        <span class="s">&quot;@+node&quot;</span><span class="p">:</span>   <span class="n">startNode</span><span class="p">,</span>   <span class="s">&quot;@-node&quot;</span><span class="p">:</span>   <span class="n">endNode</span><span class="p">,</span>
        <span class="s">&quot;@+others&quot;</span><span class="p">:</span> <span class="n">startOthers</span><span class="p">,</span> <span class="s">&quot;@-others&quot;</span><span class="p">:</span> <span class="n">endOthers</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="c">#@-&lt;&lt; define sentinelDict &gt;&gt;</span>

    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20041005105605.7: ** at.Birth &amp; init</span>
    <span class="c">#@+node:ekr.20041005105605.8: *3*  atFile.ctor</span>
    <span class="c"># Note: g.getScript also call the at.__init__ and at.finishCreate().</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>

        <span class="c"># **Warning**: all these ivars must **also** be inited in initCommonIvars.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fileCommands</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fileCommands</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># Make sure at.error() works even when not inited.</span>

        <span class="c"># User options.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkPythonCodeOnWrite</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getBool</span><span class="p">(</span>
            <span class="s">&#39;check-python-code-on-write&#39;</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">underindentEscapeString</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getString</span><span class="p">(</span>
            <span class="s">&#39;underindent-escape-string&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">-&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dispatch_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defineDispatchDict</span><span class="p">()</span>
            <span class="c"># Define the dispatch dictionary used by scanText4.</span>
    <span class="c">#@+node:ekr.20041005105605.9: *3* at.defineDispatchDict</span>
    <span class="k">def</span> <span class="nf">defineDispatchDict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="viewcode-block" id="atFile.defineDispatchDict"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.defineDispatchDict">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Return the dispatch dictionary used by scanText4.&#39;&#39;&#39;</span>

        <span class="k">return</span>  <span class="p">{</span>
            <span class="c"># Plain line.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noSentinel</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">readNormalLine</span><span class="p">,</span>
            <span class="c"># Starting sentinels...</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startAll</span><span class="p">:</span>    <span class="bp">self</span><span class="o">.</span><span class="n">readStartAll</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startAt</span><span class="p">:</span>     <span class="bp">self</span><span class="o">.</span><span class="n">readStartAt</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startDoc</span><span class="p">:</span>    <span class="bp">self</span><span class="o">.</span><span class="n">readStartDoc</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startLeo</span><span class="p">:</span>    <span class="bp">self</span><span class="o">.</span><span class="n">readStartLeo</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startMiddle</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">readStartMiddle</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startNode</span><span class="p">:</span>   <span class="bp">self</span><span class="o">.</span><span class="n">readStartNode</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startOthers</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">readStartOthers</span><span class="p">,</span>
            <span class="c"># Ending sentinels...</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">endAll</span><span class="p">:</span>    <span class="bp">self</span><span class="o">.</span><span class="n">readEndAll</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">endAt</span><span class="p">:</span>     <span class="bp">self</span><span class="o">.</span><span class="n">readEndAt</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">endDoc</span><span class="p">:</span>    <span class="bp">self</span><span class="o">.</span><span class="n">readEndDoc</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">endLeo</span><span class="p">:</span>    <span class="bp">self</span><span class="o">.</span><span class="n">readEndLeo</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">endMiddle</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">readEndMiddle</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">endNode</span><span class="p">:</span>   <span class="bp">self</span><span class="o">.</span><span class="n">readEndNode</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">endOthers</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">readEndOthers</span><span class="p">,</span>
            <span class="c"># Non-paired sentinels.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startAfterRef</span><span class="p">:</span>  <span class="bp">self</span><span class="o">.</span><span class="n">readAfterRef</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startClone</span><span class="p">:</span>     <span class="bp">self</span><span class="o">.</span><span class="n">readClone</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startComment</span><span class="p">:</span>   <span class="bp">self</span><span class="o">.</span><span class="n">readComment</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startDelims</span><span class="p">:</span>    <span class="bp">self</span><span class="o">.</span><span class="n">readDelims</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startDirective</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">readDirective</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startNl</span><span class="p">:</span>        <span class="bp">self</span><span class="o">.</span><span class="n">readNl</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startNonl</span><span class="p">:</span>      <span class="bp">self</span><span class="o">.</span><span class="n">readNonl</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startRef</span><span class="p">:</span>       <span class="bp">self</span><span class="o">.</span><span class="n">readRef</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startVerbatim</span><span class="p">:</span>  <span class="bp">self</span><span class="o">.</span><span class="n">readVerbatim</span><span class="p">,</span>
            <span class="c"># Ignored 3.x sentinels</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">endBody</span><span class="p">:</span>               <span class="bp">self</span><span class="o">.</span><span class="n">ignoreOldSentinel</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startBody</span><span class="p">:</span>             <span class="bp">self</span><span class="o">.</span><span class="n">ignoreOldSentinel</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startVerbatimAfterRef</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignoreOldSentinel</span><span class="p">,</span>
            <span class="c"># New 4.8 sentinels</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">endRef</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">readEndRef</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="c">#@+node:ekr.20041005105605.10: *3* at.initCommonIvars</span>
    <span class="k">def</span> <span class="nf">initCommonIvars</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.initCommonIvars"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.initCommonIvars">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Init ivars common to both reading and writing.</span>

<span class="sd">        The defaults set here may be changed later.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">c</span>

        <span class="n">at</span><span class="o">.</span><span class="n">at_auto_encoding</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">default_at_auto_file_encoding</span>
        <span class="n">at</span><span class="o">.</span><span class="n">default_directory</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">at</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">default_derived_file_encoding</span>
        <span class="n">at</span><span class="o">.</span><span class="n">endSentinelComment</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="n">at</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">at</span><span class="o">.</span><span class="n">inCode</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">at</span><span class="o">.</span><span class="n">indent</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c"># The unit of indentation is spaces, not tabs.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">language</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">at</span><span class="o">.</span><span class="n">output_newline</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">getOutputNewline</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">page_width</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">at</span><span class="o">.</span><span class="n">pending</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">at</span><span class="o">.</span><span class="n">raw</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># True: in @raw mode</span>
        <span class="n">at</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># The root (a position) of tree being read or written.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">root_seen</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># True: root vnode has been handled in this file.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">startSentinelComment</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="n">at</span><span class="o">.</span><span class="n">startSentinelComment</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="n">at</span><span class="o">.</span><span class="n">tab_width</span>  <span class="o">=</span> <span class="bp">None</span>
        <span class="n">at</span><span class="o">.</span><span class="n">toString</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># True: sring-oriented read or write.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">writing_to_shadow_directory</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20041005105605.13: *3* at.initReadIvars</span>
    <span class="k">def</span> <span class="nf">initReadIvars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">root</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span></div>
<div class="viewcode-block" id="atFile.initReadIvars"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.initReadIvars">[docs]</a>        <span class="n">importFileName</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">perfectImportRoot</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">atShadow</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">at</span><span class="o">.</span><span class="n">initCommonIvars</span><span class="p">()</span>

        <span class="n">at</span><span class="o">.</span><span class="n">cloneSibCount</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c"># n &gt; 1: Make sure n cloned sibs exists at next @+node sentinel</span>
        <span class="n">at</span><span class="o">.</span><span class="n">correctedLines</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c"># For perfect import.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">docOut</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># The doc part being accumulated.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># True when @-leo seen.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">endSentinelIndentStack</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c"># Restored indentation for @-others and @-&lt;&lt; sentinels.</span>
            <span class="c"># Used only when readVersion5.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">endSentinelStack</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c"># Contains entries for +node sentinels only when not readVersion5</span>
        <span class="n">at</span><span class="o">.</span><span class="n">endSentinelLevelStack</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c"># The saved level, len(at.thinNodeStack), for @-others and @-&lt;&lt; sentinels.</span>
            <span class="c"># Used only when readVersion5.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">endSentinelNodeStack</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c"># Used only when readVersion5.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">fromString</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">at</span><span class="o">.</span><span class="n">importing</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">importFileName</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">importRootSeen</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">at</span><span class="o">.</span><span class="n">indentStack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">at</span><span class="o">.</span><span class="n">inputFile</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">at</span><span class="o">.</span><span class="n">lastLines</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># The lines after @-leo</span>
        <span class="n">at</span><span class="o">.</span><span class="n">lastRefNode</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="c"># The previous reference node, for at.readAfterRef.</span>
            <span class="c"># No stack is needed because -&lt;&lt; sentinels restore at.v</span>
            <span class="c"># to the node needed by at.readAfterRef.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">lastThinNode</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="c"># The last thin node at this level.</span>
            <span class="c"># Used by createThinChild4.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">leadingWs</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="n">at</span><span class="o">.</span><span class="n">lineNumber</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># New in Leo 4.4.8.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">at</span><span class="o">.</span><span class="n">outStack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">at</span><span class="o">.</span><span class="n">perfectImportRoot</span> <span class="o">=</span> <span class="n">perfectImportRoot</span>
        <span class="n">at</span><span class="o">.</span><span class="n">readVersion</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="c"># New in Leo 4.8: &quot;4&quot; or &quot;5&quot; for new-style thin files.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">readVersion5</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="c"># synonym for at.readVersion &gt;= &#39;5&#39; and not atShadow.</span>
            <span class="c"># set by at.parseLeoSentinel()</span>
        <span class="n">at</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>
        <span class="n">at</span><span class="o">.</span><span class="n">rootSeen</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">at</span><span class="o">.</span><span class="n">atShadow</span> <span class="o">=</span> <span class="n">atShadow</span>
        <span class="n">at</span><span class="o">.</span><span class="n">targetFileName</span> <span class="o">=</span> <span class="n">fileName</span>
        <span class="n">at</span><span class="o">.</span><span class="n">tnodeList</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c"># Needed until old-style @file nodes are no longer supported.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">tnodeListIndex</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">at</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">at</span><span class="o">.</span><span class="n">vStack</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># Stack of at.v values.</span>
        <span class="k">if</span> <span class="n">allow_cloned_sibs</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">thinChildIndexStack</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># 2013/01/20: number of siblings at this level.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">thinFile</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># 2010/01/22: was thinFile</span>
        <span class="n">at</span><span class="o">.</span><span class="n">thinNodeStack</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># Entries are vnodes.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">updateWarningGiven</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20041005105605.15: *3* at.initWriteIvars</span>
    <span class="k">def</span> <span class="nf">initWriteIvars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">root</span><span class="p">,</span><span class="n">targetFileName</span><span class="p">,</span></div>
<div class="viewcode-block" id="atFile.initWriteIvars"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.initWriteIvars">[docs]</a>        <span class="n">atAuto</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">atEdit</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">atShadow</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">forcePythonSentinels</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">nosentinels</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">perfectImportFlag</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">scriptWrite</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">thinFile</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">toString</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">at</span><span class="p">,</span><span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="k">assert</span> <span class="n">root</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initCommonIvars</span><span class="p">()</span>

        <span class="k">assert</span> <span class="n">at</span><span class="o">.</span><span class="n">checkPythonCodeOnWrite</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
        <span class="k">assert</span> <span class="n">at</span><span class="o">.</span><span class="n">underindentEscapeString</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>

        <span class="n">at</span><span class="o">.</span><span class="n">atAuto</span> <span class="o">=</span> <span class="n">atAuto</span>
        <span class="n">at</span><span class="o">.</span><span class="n">atEdit</span> <span class="o">=</span> <span class="n">atEdit</span>
        <span class="n">at</span><span class="o">.</span><span class="n">atShadow</span> <span class="o">=</span> <span class="n">atShadow</span>
        <span class="c"># at.default_directory: set by scanAllDirectives()</span>
        <span class="n">at</span><span class="o">.</span><span class="n">docKind</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">forcePythonSentinels</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">endSentinelComment</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c"># else: at.endSentinelComment set by initCommonIvars.</span>
        <span class="c"># at.encoding: set by scanAllDirectives() below.</span>
        <span class="c"># at.explicitLineEnding # True: an @lineending directive specifies the ending.</span>
            <span class="c"># Set by scanAllDirectives() below.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">fileChangedFlag</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># True: the file has actually been updated.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">force_newlines_in_at_nosent_bodies</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getBool</span><span class="p">(</span>
            <span class="s">&#39;force_newlines_in_at_nosent_bodies&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">forcePythonSentinels</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">forcePythonSentinels</span> <span class="o">=</span> <span class="n">scriptWrite</span>
        <span class="c"># at.language:      set by scanAllDirectives() below.</span>
        <span class="c"># at.outputFile:    set below.</span>
        <span class="c"># at.outputNewline: set below.</span>
        <span class="k">if</span> <span class="n">forcePythonSentinels</span><span class="p">:</span>
            <span class="c"># Force Python comment delims for g.getScript.</span>
            <span class="n">at</span><span class="o">.</span><span class="n">startSentinelComment</span> <span class="o">=</span> <span class="s">&quot;#&quot;</span>
        <span class="c"># else:                 set by initCommonIvars.</span>
        <span class="c"># at.stringOutput:      set below.</span>
        <span class="c"># at.outputFileName:    set below.</span>
        <span class="c"># at.output_newline:    set by scanAllDirectives() below.</span>
        <span class="c"># at.page_width:        set by scanAllDirectives() below.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">perfectImportFlag</span> <span class="o">=</span> <span class="n">perfectImportFlag</span>
        <span class="n">at</span><span class="o">.</span><span class="n">sentinels</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">nosentinels</span>
        <span class="n">at</span><span class="o">.</span><span class="n">shortFileName</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>   <span class="c"># For messages.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>
        <span class="c"># at.tab_width:         set by scanAllDirectives() below.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">targetFileName</span> <span class="o">=</span> <span class="n">targetFileName</span>
            <span class="c"># Must be None for @shadow.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">thinFile</span> <span class="o">=</span> <span class="n">thinFile</span>
        <span class="n">at</span><span class="o">.</span><span class="n">toString</span> <span class="o">=</span> <span class="n">toString</span>
        <span class="n">at</span><span class="o">.</span><span class="n">writeVersion5</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">atShadow</span>

        <span class="n">at</span><span class="o">.</span><span class="n">scanAllDirectives</span><span class="p">(</span><span class="n">root</span><span class="p">,</span>
            <span class="n">scripting</span><span class="o">=</span><span class="n">scriptWrite</span><span class="p">,</span>
            <span class="n">forcePythonSentinels</span><span class="o">=</span><span class="n">forcePythonSentinels</span><span class="p">,</span>
            <span class="n">issuePathWarning</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c"># Sets the following ivars:</span>
            <span class="c"># at.default_directory</span>
            <span class="c"># at.encoding</span>
            <span class="c"># at.explicitLineEnding</span>
            <span class="c"># at.language</span>
            <span class="c"># at.output_newline</span>
            <span class="c"># at.page_width</span>
            <span class="c"># at.tab_width</span>

        <span class="c"># 2011/10/21: Encoding directive overrides everything else.</span>
        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">language</span> <span class="o">==</span> <span class="s">&#39;python&#39;</span><span class="p">:</span>
            <span class="n">encoding</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">getPythonEncodingFromString</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">encoding</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">encoding</span>
                <span class="c"># g.trace(&#39;scanned encoding&#39;,encoding)</span>

        <span class="k">if</span> <span class="n">toString</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">fileLikeObject</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">output_newline</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
            <span class="c"># else: at.output_newline set in initCommonIvars.</span>
            <span class="n">at</span><span class="o">.</span><span class="n">stringOutput</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
            <span class="n">at</span><span class="o">.</span><span class="n">outputFileName</span> <span class="o">=</span> <span class="s">&quot;&lt;string-file&gt;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># The temporary output file.</span>
            <span class="c"># at.outputNewline set in initCommonIvars.</span>
            <span class="n">at</span><span class="o">.</span><span class="n">stringOutput</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">at</span><span class="o">.</span><span class="n">outputFileName</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">u</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>

        <span class="c"># Init all other ivars even if there is an error.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">at</span><span class="o">.</span><span class="n">errors</span> <span class="ow">and</span> <span class="n">at</span><span class="o">.</span><span class="n">root</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;tnodeList&#39;</span><span class="p">):</span>
                <span class="nb">delattr</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;tnodeList&#39;</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">_p_changed</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="c">#@+node:ekr.20041005105605.17: ** at.Reading</span>
    <span class="c">#@+&lt;&lt; about new sentinels &gt;&gt;</span>
    <span class="c">#@+node:ekr.20100619222623.5918: *3* &lt;&lt; about new sentinels &gt;&gt;</span>
    <span class="c">#@@nocolor-node</span>
    <span class="c">#@+at</span>
    <span class="c"># </span>
    <span class="c"># Surprisingly, it&#39;s easier to read new sentinels than to read old sentinels:</span>
    <span class="c"># </span>
    <span class="c"># - There must be closing sentinels for section references and the @all and</span>
    <span class="c">#   @others directives, collectively known as **embedding constructs.** Indeed,</span>
    <span class="c">#   these constructs do not terminate the node in which they appear, so without a</span>
    <span class="c">#   closing sentinel there would be no way to know where the construct ended and</span>
    <span class="c">#   the following lines of the enclosing node began.</span>
    <span class="c"># </span>
    <span class="c"># - The read code &quot;accumulates&quot; body text of node v in v.tempBodyList, a list of</span>
    <span class="c">#   lines. A post-pass assigns v.tempBodyString = &#39;&#39;.join(v.tempBodyList). This</span>
    <span class="c">#   assignment **terminates** the node.</span>
    <span class="c"># </span>
    <span class="c"># - The new read code *never* terminates the body text of a node until the</span>
    <span class="c">#   post-pass. This is the crucial simplification that allows the read code not to</span>
    <span class="c">#   need @-node sentinels.</span>
    <span class="c"># </span>
    <span class="c"># - An older version of the body text exists for v iff v has the tempBodyString</span>
    <span class="c">#   attribute. It is *essential* not to create this attribute until finalizing v.</span>
    <span class="c">#   The read code warns (creates a &quot;Recovered Nodes&quot; node) if the previous value</span>
    <span class="c">#   of v.tempBodyString does not match &#39;&#39;.join(tempBodyList) when v is terminated.</span>
    <span class="c"># </span>
    <span class="c"># - The read code for new sentinels creates nodes using the node-level stars, by</span>
    <span class="c">#   making the new node at level N a child of of the previous node at level N-1.</span>
    <span class="c"># </span>
    <span class="c"># Other notes.</span>
    <span class="c"># </span>
    <span class="c"># - Leo no longer maintains the &quot;spelling&quot; of whitespace before embedding constructs.</span>
    <span class="c">#   This can never cause any harm.</span>
    <span class="c"># </span>
    <span class="c"># - Leo does not write @nonl or @nl sentinels when writing new sentinels. In</span>
    <span class="c">#   effect, this &quot;regularizes&quot; body text so that it always ends with at least one</span>
    <span class="c">#   blank. Again, this can never cause any harm, because nodes must be terminated</span>
    <span class="c">#   (in the external file), by a newline the precedes the next sentinel.</span>
    <span class="c">#   Eliminating @nonl and @nl sentinels simplifies the appearance of the external</span>
    <span class="c">#   file and reduces spurious sccs diffs.</span>
    <span class="c"># </span>
    <span class="c"># - Leo always writes private @shadow files using old sentines. This guarantees</span>
    <span class="c">#   permanent compatibility with older versions of Leo.</span>
    <span class="c">#@-&lt;&lt; about new sentinels &gt;&gt;</span>
    <span class="c">#@+node:ekr.20041005105605.18: *3* Reading (top level)</span>
    <span class="c">#@+at All reading happens in the readOpenFile logic, so plugins</span>
    <span class="c"># should need to override only this method.</span>
    <span class="c">#@+node:ekr.20070919133659: *4* at.checkDerivedFile</span>
    <span class="k">def</span> <span class="nf">checkDerivedFile</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.checkDerivedFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.checkDerivedFile">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Make sure an external file written by Leo may be read properly.&#39;&#39;&#39;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtFileNode</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtThinFileNode</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">red</span><span class="p">(</span><span class="s">&#39;Please select an @thin or @file node&#39;</span><span class="p">)</span>

        <span class="n">fn</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">anyAtFileNodeName</span><span class="p">()</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_dirname</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">mFileName</span><span class="p">)</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadDir</span><span class="p">,</span><span class="n">path</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;file not found: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fn</span><span class="p">))</span>

        <span class="n">s</span><span class="p">,</span><span class="n">e</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">readFileIntoString</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span>

        <span class="c"># Create a dummy, unconnected, vnode as the root.</span>
        <span class="n">root_v</span> <span class="o">=</span> <span class="n">leoNodes</span><span class="o">.</span><span class="n">vnode</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">leoNodes</span><span class="o">.</span><span class="n">position</span><span class="p">(</span><span class="n">root_v</span><span class="p">)</span>
        <span class="c"># 2010/01/22: readOpenFiles now determines whether a file is thin or not.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">initReadIvars</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">at</span><span class="o">.</span><span class="n">openFileForReading</span><span class="p">(</span><span class="n">fromString</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">at</span><span class="o">.</span><span class="n">inputFile</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">at</span><span class="o">.</span><span class="n">readOpenFile</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">inputFile</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">inputFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">errors</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&#39;check-derived-file passed&#39;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20041005105605.19: *4* at.openFileForReading</span>
    <span class="k">def</span> <span class="nf">openFileForReading</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fromString</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.openFileForReading"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.openFileForReading">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Open the file given by at.root.</span>
<span class="sd">        This will be the private file for @shadow nodes.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">fromString</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">atShadow</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">at</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s">&#39;can not call at.read from string for @shadow files&#39;</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">inputFile</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">fileLikeObject</span><span class="p">(</span><span class="n">fromString</span><span class="o">=</span><span class="n">fromString</span><span class="p">)</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">fullPath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
                <span class="c"># Returns full path, including file name.</span>
            <span class="n">at</span><span class="o">.</span><span class="n">setPathUa</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span> <span class="c"># Remember the full path to this node.</span>

            <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">atShadow</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">shadowController</span>
                <span class="c"># readOneAtShadowNode should already have checked these.</span>
                <span class="n">shadow_fn</span>     <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shadowPathName</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
                <span class="n">shadow_exists</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">shadow_fn</span><span class="p">)</span> <span class="ow">and</span> \
                    <span class="n">g</span><span class="o">.</span><span class="n">os_path_isfile</span><span class="p">(</span><span class="n">shadow_fn</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">shadow_exists</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;can not happen: no private file&#39;</span><span class="p">,</span>
                        <span class="n">shadow_fn</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>
                    <span class="k">return</span> <span class="n">at</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s">&#39;can not happen: private file does not exist: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">shadow_fn</span><span class="p">))</span>
                <span class="c"># This method is the gateway to the shadow algorithm.</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;         fn:       &#39;</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;reading: shadow_fn:&#39;</span><span class="p">,</span><span class="n">shadow_fn</span><span class="p">)</span>
                <span class="n">x</span><span class="o">.</span><span class="n">updatePublicAndPrivateFiles</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span><span class="n">shadow_fn</span><span class="p">)</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="n">shadow_fn</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c"># Open the file in binary mode to allow 0x1a in bodies &amp; headlines.</span>
                <span class="n">at</span><span class="o">.</span><span class="n">inputFile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="s">&#39;rb&#39;</span><span class="p">)</span>
                <span class="n">at</span><span class="o">.</span><span class="n">warnOnReadOnlyFile</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;can not open: &#39;@file </span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fn</span><span class="p">))</span>
                <span class="n">at</span><span class="o">.</span><span class="n">inputFile</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">return</span> <span class="n">fn</span>
    <span class="c">#@+node:ekr.20041005105605.21: *4* at.read &amp; helpers</span>
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">root</span><span class="p">,</span><span class="n">importFileName</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span></div>
<div class="viewcode-block" id="atFile.read"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.read">[docs]</a>        <span class="n">fromString</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">atShadow</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">force</span><span class="o">=</span><span class="bp">False</span>
    <span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Read an @thin or @file tree.&quot;&quot;&quot;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">c</span>
        <span class="n">fileName</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">initFileName</span><span class="p">(</span><span class="n">fromString</span><span class="p">,</span><span class="n">importFileName</span><span class="p">,</span><span class="n">root</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fileName</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Missing file name.  Restoring @file tree from .leo file.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="c"># Fix bug 760531: always mark the root as read, even if there was an error.</span>
        <span class="c"># Fix bug 889175: Remember the full fileName.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">rememberReadPath</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">fullPath</span><span class="p">(</span><span class="n">root</span><span class="p">),</span><span class="n">root</span><span class="p">)</span>

        <span class="c"># Bug fix 2011/05/23: Restore orphan trees from the outline.</span>
        <span class="k">if</span> <span class="n">root</span><span class="o">.</span><span class="n">isOrphan</span><span class="p">():</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;reading:&quot;</span><span class="p">,</span><span class="n">root</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
            <span class="c"># g.warning(&#39;The outline contains an orphan node!\nRetaining the outline&#39;)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;orphan node in&#39;</span><span class="p">,</span><span class="n">root</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&#39;retaining the data from the .leo file&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">at</span><span class="o">.</span><span class="n">initReadIvars</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span>
            <span class="n">importFileName</span><span class="o">=</span><span class="n">importFileName</span><span class="p">,</span><span class="n">atShadow</span><span class="o">=</span><span class="n">atShadow</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">fromString</span> <span class="o">=</span> <span class="n">fromString</span>
        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;Init error&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="n">fileName</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">openFileForReading</span><span class="p">(</span><span class="n">fromString</span><span class="o">=</span><span class="n">fromString</span><span class="p">)</span>
            <span class="c"># For @shadow files, calls x.updatePublicAndPrivateFiles.</span>
        <span class="k">if</span> <span class="n">fileName</span> <span class="ow">and</span> <span class="n">at</span><span class="o">.</span><span class="n">inputFile</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">setFileTimeStamp</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fromString</span><span class="p">:</span> <span class="c"># 2010/09/02.</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;No inputFile&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="c"># Get the file from the cache if possible.</span>
        <span class="k">if</span> <span class="n">fromString</span><span class="p">:</span>
            <span class="n">s</span><span class="p">,</span><span class="n">loaded</span><span class="p">,</span><span class="n">fileKey</span> <span class="o">=</span> <span class="n">fromString</span><span class="p">,</span><span class="bp">False</span><span class="p">,</span><span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span><span class="p">,</span><span class="n">loaded</span><span class="p">,</span><span class="n">fileKey</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">cacher</span><span class="o">.</span><span class="n">readFile</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">root</span><span class="p">)</span>
        <span class="c"># Never read an external file with file-like sentinels from the cache.</span>
        <span class="n">isFileLike</span> <span class="o">=</span> <span class="n">loaded</span> <span class="ow">and</span> <span class="n">at</span><span class="o">.</span><span class="n">isFileLike</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">loaded</span> <span class="ow">or</span> <span class="n">isFileLike</span><span class="p">:</span>
            <span class="c"># if trace: g.trace(&#39;file-like file&#39;,fileName)</span>
            <span class="n">force</span> <span class="o">=</span> <span class="bp">True</span> <span class="c"># Disable caching.</span>
        <span class="k">if</span> <span class="n">loaded</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;in cache&#39;</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">inputFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">root</span><span class="o">.</span><span class="n">clearDirty</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;reading:&quot;</span><span class="p">,</span><span class="n">root</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">isFileLike</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                <span class="k">if</span> <span class="mi">0</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&quot;converting @file format in&quot;</span><span class="p">,</span><span class="n">root</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTestDict</span><span class="p">[</span><span class="s">&#39;read-convert&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">red</span><span class="p">(</span><span class="s">&quot;converting @file format in&quot;</span><span class="p">,</span><span class="n">root</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
        <span class="n">root</span><span class="o">.</span><span class="n">clearVisitedInTree</span><span class="p">()</span>

        <span class="n">at</span><span class="o">.</span><span class="n">scanAllDirectives</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">importing</span><span class="o">=</span><span class="n">at</span><span class="o">.</span><span class="n">importing</span><span class="p">,</span><span class="n">reading</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="c"># Sets the following ivars:</span>
                <span class="c"># at.default_directory</span>
                <span class="c"># at.encoding: **Important**: changed later</span>
                <span class="c">#     by readOpenFile/at.scanHeader.</span>
                <span class="c"># at.explicitLineEnding</span>
                <span class="c"># at.language</span>
                <span class="c"># at.output_newline</span>
                <span class="c"># at.page_width</span>
                <span class="c"># at.tab_width</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">encoding</span><span class="p">),</span><span class="n">fileName</span><span class="p">)</span>
        <span class="n">thinFile</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">readOpenFile</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">inputFile</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span><span class="n">deleteNodes</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="c"># Calls at.scanHeader, which sets at.encoding.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">inputFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">root</span><span class="o">.</span><span class="n">clearDirty</span><span class="p">()</span> <span class="c"># May be set dirty below.</span>
        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">errors</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">deleteUnvisitedNodes</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">deleteTnodeList</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">errors</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">at</span><span class="o">.</span><span class="n">importing</span><span class="p">:</span>
            <span class="c"># Used by mod_labels plugin.</span>
            <span class="n">at</span><span class="o">.</span><span class="n">copyAllTempBodyStringsToVnodes</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">thinFile</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">deleteAllTempBodyStrings</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">isFileLike</span> <span class="ow">and</span> <span class="n">at</span><span class="o">.</span><span class="n">errors</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># Old-style sentinels.</span>
            <span class="c"># 2010/02/24: Make the root @file node dirty so it will</span>
            <span class="c"># be written automatically when saving the file.</span>
            <span class="c"># Do *not* set the orphan bit here!</span>
            <span class="n">root</span><span class="o">.</span><span class="n">clearOrphan</span><span class="p">()</span>
            <span class="n">root</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span> <span class="c"># Essential, to keep dirty bit set.</span>
        <span class="k">elif</span> <span class="n">at</span><span class="o">.</span><span class="n">errors</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># 2010/10/22: Dirty bits are *always* cleared.</span>
            <span class="c"># Only the orphan bit is preserved.</span>
            <span class="c"># root.setDirty() # 2011/06/17: Won&#39;t be preserved anyway</span>
            <span class="n">root</span><span class="o">.</span><span class="n">setOrphan</span><span class="p">()</span>
            <span class="c"># c.setChanged(True) # 2011/06/17.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">root</span><span class="o">.</span><span class="n">clearOrphan</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">errors</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">isFileLike</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fromString</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">cacher</span><span class="o">.</span><span class="n">writeFile</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">fileKey</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;at.errors&#39;</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">at</span><span class="o">.</span><span class="n">errors</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="c">#@+node:ekr.20041005105605.25: *5* at.deleteAllTempBodyStrings</span>
    <span class="k">def</span> <span class="nf">deleteAllTempBodyStrings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.deleteAllTempBodyStrings"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.deleteAllTempBodyStrings">[docs]</a>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">all_unique_nodes</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s">&quot;tempBodyString&quot;</span><span class="p">):</span>
                <span class="nb">delattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s">&quot;tempBodyString&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s">&quot;tempBodyList&quot;</span><span class="p">):</span>
                <span class="nb">delattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s">&quot;tempBodyList&quot;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100122130101.6174: *5* at.deleteTnodeList</span>
    <span class="k">def</span> <span class="nf">deleteTnodeList</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span> <span class="c"># atFile method.</span></div>
<div class="viewcode-block" id="atFile.deleteTnodeList"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.deleteTnodeList">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Remove p&#39;s tnodeList.&#39;&#39;&#39;</span>

        <span class="n">v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s">&quot;tnodeList&quot;</span><span class="p">):</span>

            <span class="k">if</span> <span class="bp">False</span><span class="p">:</span> <span class="c"># Not an error, but a useful trace.</span>
                <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&quot;deleting tnodeList for &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

            <span class="nb">delattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s">&quot;tnodeList&quot;</span><span class="p">)</span>
            <span class="n">v</span><span class="o">.</span><span class="n">_p_changed</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="c">#@+node:ekr.20071105164407: *5* at.deleteUnvisitedNodes &amp; helpers</span>
    <span class="k">def</span> <span class="nf">deleteUnvisitedNodes</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">root</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.deleteUnvisitedNodes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.deleteUnvisitedNodes">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Delete unvisited nodes in root&#39;s subtree, not including root.</span>

<span class="sd">        Actually, instead of deleting the nodes, we move them to be children of the</span>
<span class="sd">        &#39;Resurrected Nodes&#39; r.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">root</span><span class="o">.</span><span class="n">hasChildren</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="c"># Carefully set up the arguments.</span>
        <span class="n">aList</span> <span class="o">=</span> <span class="p">[</span><span class="n">z</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">subtree</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">z</span><span class="o">.</span><span class="n">isVisited</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">aList</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">createResurrectedNodesNode</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">r</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">aList</span>
        <span class="n">callback</span><span class="o">=</span><span class="n">at</span><span class="o">.</span><span class="n">defineResurrectedNodeCallback</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">root</span><span class="p">)</span>

        <span class="c"># Now move the nodes.</span>
        <span class="n">root</span><span class="o">.</span><span class="n">firstChild</span><span class="p">()</span><span class="o">.</span><span class="n">deletePositionsInList</span><span class="p">(</span><span class="n">aList</span><span class="p">,</span><span class="n">callback</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100803073751.5817: *6* createResurrectedNodesNode</span>
    <span class="k">def</span> <span class="nf">createResurrectedNodesNode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.createResurrectedNodesNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.createResurrectedNodesNode">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Create a &#39;Resurrected Nodes&#39; node as the last top-level node.&#39;&#39;&#39;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">tag</span> <span class="o">=</span> <span class="s">&#39;Resurrected Nodes&#39;</span>

        <span class="c"># Find the last top-level node.</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">last</span><span class="o">.</span><span class="n">hasNext</span><span class="p">():</span>
            <span class="n">last</span><span class="o">.</span><span class="n">moveToNext</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">last</span><span class="o">.</span><span class="n">h</span> <span class="o">==</span> <span class="n">tag</span><span class="p">:</span>
            <span class="c"># The &#39;Resurrected Nodes&#39; node already exists.</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">last</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Create the &#39;Resurrected Nodes&#39; node after &#39;last&#39;.</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">last</span><span class="o">.</span><span class="n">insertAfter</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">setHeadString</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>

        <span class="n">p</span><span class="o">.</span><span class="n">expand</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">p</span>
    <span class="c">#@+node:ekr.20100803073751.5818: *6* defineResurrectedNodeCallback</span>
    <span class="k">def</span> <span class="nf">defineResurrectedNodeCallback</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">root</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.defineResurrectedNodeCallback"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.defineResurrectedNodeCallback">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Define a callback that moves node p as r&#39;s last child.&#39;&#39;&#39;</span>

        <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span><span class="n">root</span><span class="o">=</span><span class="n">root</span><span class="p">):</span>

            <span class="sd">&#39;&#39;&#39;The resurrected nodes callback.&#39;&#39;&#39;</span>

            <span class="n">child</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">insertAsLastChild</span><span class="p">()</span>
            <span class="n">child</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="s">&#39;From </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">root</span><span class="o">.</span><span class="n">h</span>
            <span class="n">p</span><span class="o">.</span><span class="n">moveToLastChildOf</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                <span class="c"># g.trace(p.h,r.h)</span>
                <span class="k">pass</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;resurrected node:&#39;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&#39;in file:&#39;</span><span class="p">,</span><span class="n">root</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">callback</span>


    <span class="c">#@+node:ekr.20041005105605.22: *5* at.initFileName</span>
    <span class="k">def</span> <span class="nf">initFileName</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fromString</span><span class="p">,</span><span class="n">importFileName</span><span class="p">,</span><span class="n">root</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.initFileName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.initFileName">[docs]</a>
        <span class="k">if</span> <span class="n">fromString</span><span class="p">:</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="s">&quot;&lt;string-file&gt;&quot;</span>
        <span class="k">elif</span> <span class="n">importFileName</span><span class="p">:</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="n">importFileName</span>
        <span class="k">elif</span> <span class="n">root</span><span class="o">.</span><span class="n">isAnyAtFileNode</span><span class="p">():</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">anyAtFileNodeName</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">return</span> <span class="n">fileName</span>
    <span class="c">#@+node:ekr.20100224050618.11547: *5* at.isFileLike</span>
    <span class="k">def</span> <span class="nf">isFileLike</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.isFileLike"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.isFileLike">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Return True if s has file-like sentinels.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">tag</span> <span class="o">=</span> <span class="s">&quot;@+leo&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicode</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;found: False&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">True</span> <span class="c"># Don&#39;t use the cashe.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">j</span><span class="p">,</span><span class="n">k</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">getLine</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">k</span><span class="p">]</span>
            <span class="n">valid</span><span class="p">,</span><span class="n">new_df</span><span class="p">,</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">,</span><span class="n">isThin</span> <span class="o">=</span> \
                <span class="n">at</span><span class="o">.</span><span class="n">parseLeoSentinel</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;found: True isThin:&#39;</span><span class="p">,</span>
                <span class="n">isThin</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
            <span class="k">return</span> <span class="ow">not</span> <span class="n">isThin</span>
    <span class="c">#@+node:ekr.20041005105605.26: *4* at.readAll</span>
    <span class="k">def</span> <span class="nf">readAll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">root</span><span class="p">,</span><span class="n">partialFlag</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.readAll"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.readAll">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Scan vnodes, looking for @&lt;file&gt; nodes to read.&quot;&quot;&quot;</span>

        <span class="n">use_tracer</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">use_tracer</span><span class="p">:</span> <span class="n">tt</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">startTracer</span><span class="p">()</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">c</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">partialFlag</span>
        <span class="k">if</span> <span class="n">partialFlag</span><span class="p">:</span>
            <span class="c"># Capture the current headline only if</span>
            <span class="c"># we aren&#39;t doing the initial read.</span>
            <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span> 
        <span class="n">anyRead</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">scanned_tnodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">init_error_dialogs</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">partialFlag</span><span class="p">:</span> <span class="n">after</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">nodeAfterTree</span><span class="p">()</span>    
        <span class="k">else</span><span class="p">:</span> <span class="n">after</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">nullPosition</span><span class="p">()</span>

        <span class="k">while</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">after</span><span class="p">:</span>
            <span class="n">gnx</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">gnx</span>
            <span class="c">#skip clones</span>
            <span class="k">if</span> <span class="n">gnx</span> <span class="ow">in</span> <span class="n">scanned_tnodes</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span>
                <span class="k">continue</span>
            <span class="n">scanned_tnodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gnx</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">):</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtIgnoreNode</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isAnyAtFileNode</span><span class="p">()</span> <span class="p">:</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">ignored_at_file_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtThinFileNode</span><span class="p">():</span>
                <span class="n">anyRead</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">at</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtAutoNode</span><span class="p">():</span>
                <span class="n">fileName</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">atAutoNodeName</span><span class="p">()</span>
                <span class="n">at</span><span class="o">.</span><span class="n">readOneAtAutoNode</span> <span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtEditNode</span><span class="p">():</span>
                <span class="n">fileName</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">atEditNodeName</span><span class="p">()</span>
                <span class="n">at</span><span class="o">.</span><span class="n">readOneAtEditNode</span> <span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtShadowFileNode</span><span class="p">():</span>
                <span class="n">fileName</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">atShadowFileNodeName</span><span class="p">()</span>
                <span class="n">at</span><span class="o">.</span><span class="n">readOneAtShadowNode</span> <span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtFileNode</span><span class="p">():</span>
                <span class="n">anyRead</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">wasOrphan</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">isOrphan</span><span class="p">()</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">wasOrphan</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">partialFlag</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
                    <span class="c"># Remind the user to fix the problem.</span>
                    <span class="c"># However, the dirty bit gets cleared.</span>
                    <span class="c"># p.setDirty() # 2011/06/17: won&#39;t be preserved anyway.</span>
                        <span class="c"># Expensive, but it can&#39;t be helped.</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">setOrphan</span><span class="p">()</span> <span class="c"># 2010/10/22: the dirty bit gets cleared.</span>
                    <span class="c"># c.setChanged(True) # 2011/06/17</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtAsisFileNode</span><span class="p">()</span> <span class="ow">or</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtNoSentFileNode</span><span class="p">():</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">rememberReadPath</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">fullPath</span><span class="p">(</span><span class="n">p</span><span class="p">),</span><span class="n">p</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>

        <span class="c"># 2010/10/22: Preserve the orphan bits: the dirty bits will be cleared!</span>
        <span class="c">#for v in c.all_unique_nodes():</span>
        <span class="c">#    v.clearOrphan()</span>

        <span class="k">if</span> <span class="n">partialFlag</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">anyRead</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;no @&lt;file&gt; nodes in the selected tree&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">use_tracer</span><span class="p">:</span> <span class="n">tt</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

        <span class="n">c</span><span class="o">.</span><span class="n">raise_error_dialogs</span><span class="p">()</span>  <span class="c"># 2011/12/17</span>
    <span class="c">#@+node:ekr.20080801071227.7: *4* at.readAtShadowNodes</span>
    <span class="k">def</span> <span class="nf">readAtShadowNodes</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.readAtShadowNodes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.readAtShadowNodes">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Read all @shadow nodes in the p&#39;s tree.&#39;&#39;&#39;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">after</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">nodeAfterTree</span><span class="p">()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c"># Don&#39;t change p in the caller.</span>
        <span class="k">while</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">after</span><span class="p">:</span> <span class="c"># Don&#39;t use iterator.</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtShadowFileNode</span><span class="p">():</span>
                <span class="n">fileName</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">atShadowFileNodeName</span><span class="p">()</span>
                <span class="n">at</span><span class="o">.</span><span class="n">readOneAtShadowNode</span> <span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20070909100252: *4* at.readOneAtAutoNode</span>
    <span class="k">def</span> <span class="nf">readOneAtAutoNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span><span class="n">p</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.readOneAtAutoNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.readOneAtAutoNode">[docs]</a>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">ic</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">importCommands</span>

        <span class="n">oldChanged</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">isChanged</span><span class="p">()</span>

        <span class="n">at</span><span class="o">.</span><span class="n">default_directory</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">setDefaultDirectory</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">importing</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">fileName</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">default_directory</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">fileName</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;not found: @auto </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fileName</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="c"># 2010/7/28: Remember that we have seen the @auto node.</span>
        <span class="c"># Fix bug 889175: Remember the full fileName.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">rememberReadPath</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>

        <span class="n">s</span><span class="p">,</span><span class="n">ok</span><span class="p">,</span><span class="n">fileKey</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">cacher</span><span class="o">.</span><span class="n">readFile</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&#39;after-auto&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
                <span class="c"># call after-auto callbacks</span>
                <span class="c"># 2011/09/30: added call to g.doHook here.</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;reading:&quot;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c"># 2012/04/09: catch failed asserts in the import code.</span>
            <span class="n">ic</span><span class="o">.</span><span class="n">createOutline</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">parent</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span><span class="n">atAuto</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="n">ic</span><span class="o">.</span><span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">ic</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span>
            <span class="c"># Read the entire file into the node.</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;errors inhibited read @auto </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fileName</span><span class="p">))</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;reading entire file into @auto node.&#39;</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">readOneAtEditNode</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ic</span><span class="o">.</span><span class="n">errors</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">fileName</span><span class="p">):</span>
            <span class="n">p</span><span class="o">.</span><span class="n">clearDirty</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="n">oldChanged</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">cacher</span><span class="o">.</span><span class="n">writeFile</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">fileKey</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&#39;after-auto&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
                <span class="c"># call after-auto callbacks</span>
                <span class="c"># 2011/09/30: add &#39;c&#39; keyword arg.</span>
    <span class="c">#@+node:ekr.20090225080846.3: *4* at.readOneAtEditNode</span>
    <span class="k">def</span> <span class="nf">readOneAtEditNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span><span class="n">p</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.readOneAtEditNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.readOneAtEditNode">[docs]</a>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">c</span>
        <span class="n">ic</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">importCommands</span>
        <span class="n">at</span><span class="o">.</span><span class="n">default_directory</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">setDefaultDirectory</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">importing</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">default_directory</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">junk</span><span class="p">,</span><span class="n">ext</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_splitext</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

        <span class="c"># Fix bug 889175: Remember the full fileName.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">rememberReadPath</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;reading: @edit </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">(</span><span class="n">fn</span><span class="p">)))</span>

        <span class="n">s</span><span class="p">,</span><span class="n">e</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">readFileIntoString</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;@edit&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">encoding</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">e</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span><span class="n">e</span><span class="p">)</span>

        <span class="c"># Delete all children.</span>
        <span class="k">while</span> <span class="n">p</span><span class="o">.</span><span class="n">hasChildren</span><span class="p">():</span>
            <span class="n">p</span><span class="o">.</span><span class="n">firstChild</span><span class="p">()</span><span class="o">.</span><span class="n">doDelete</span><span class="p">()</span>

        <span class="n">changed</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">isChanged</span><span class="p">()</span>
        <span class="n">head</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">ext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;.html&#39;</span><span class="p">,</span><span class="s">&#39;.htm&#39;</span><span class="p">):</span>   <span class="n">head</span> <span class="o">=</span> <span class="s">&#39;@language html</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="k">elif</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;.txt&#39;</span><span class="p">,</span><span class="s">&#39;.text&#39;</span><span class="p">):</span> <span class="n">head</span> <span class="o">=</span> <span class="s">&#39;@nocolor</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">language</span> <span class="o">=</span> <span class="n">ic</span><span class="o">.</span><span class="n">languageForExtension</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">language</span> <span class="ow">and</span> <span class="n">language</span> <span class="o">!=</span> <span class="s">&#39;unknown_language&#39;</span><span class="p">:</span>
                <span class="n">head</span> <span class="o">=</span> <span class="s">&#39;@language </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">language</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">head</span> <span class="o">=</span> <span class="s">&#39;@nocolor</span><span class="se">\n</span><span class="s">&#39;</span>

        <span class="n">p</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">u</span><span class="p">(</span><span class="n">head</span><span class="p">)</span> <span class="o">+</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span><span class="n">reportErrors</span><span class="o">=</span><span class="s">&#39;True&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">changed</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&#39;after-edit&#39;</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20080711093251.7: *4* at.readOneAtShadowNode</span>
    <span class="k">def</span> <span class="nf">readOneAtShadowNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">force</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.readOneAtShadowNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.readOneAtShadowNode">[docs]</a>
        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">shadowController</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">fn</span> <span class="o">==</span> <span class="n">p</span><span class="o">.</span><span class="n">atShadowFileNodeName</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">at</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;can not happen: fn: </span><span class="si">%s</span><span class="s"> != atShadowNodeName: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">fn</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">atShadowFileNodeName</span><span class="p">()))</span>

        <span class="c"># Fix bug 889175: Remember the full fileName.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">rememberReadPath</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>

        <span class="n">at</span><span class="o">.</span><span class="n">default_directory</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">setDefaultDirectory</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">importing</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">default_directory</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">shadow_fn</span>     <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shadowPathName</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">shadow_exists</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">shadow_fn</span><span class="p">)</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_isfile</span><span class="p">(</span><span class="n">shadow_fn</span><span class="p">)</span>

        <span class="c"># Delete all children.</span>
        <span class="k">while</span> <span class="n">p</span><span class="o">.</span><span class="n">hasChildren</span><span class="p">():</span>
            <span class="n">p</span><span class="o">.</span><span class="n">firstChild</span><span class="p">()</span><span class="o">.</span><span class="n">doDelete</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;shadow_exists&#39;</span><span class="p">,</span><span class="n">shadow_exists</span><span class="p">,</span><span class="n">shadow_fn</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">shadow_exists</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">atShadow</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;reading:&quot;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">importAtShadowNode</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                <span class="c"># Create the private file automatically.</span>
                <span class="n">at</span><span class="o">.</span><span class="n">writeOneAtShadowNode</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20080712080505.1: *5* at.importAtShadowNode</span>
    <span class="k">def</span> <span class="nf">importAtShadowNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span><span class="n">p</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.importAtShadowNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.importAtShadowNode">[docs]</a>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">c</span>  <span class="p">;</span> <span class="n">ic</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">importCommands</span>
        <span class="n">oldChanged</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">isChanged</span><span class="p">()</span>

        <span class="c"># Delete all the child nodes.</span>
        <span class="k">while</span> <span class="n">p</span><span class="o">.</span><span class="n">hasChildren</span><span class="p">():</span>
            <span class="n">p</span><span class="o">.</span><span class="n">firstChild</span><span class="p">()</span><span class="o">.</span><span class="n">doDelete</span><span class="p">()</span>

        <span class="c"># Import the outline, exactly as @auto does.</span>
        <span class="n">ic</span><span class="o">.</span><span class="n">createOutline</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">parent</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span><span class="n">atAuto</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">atShadow</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ic</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;errors inhibited read @shadow&#39;</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ic</span><span class="o">.</span><span class="n">errors</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="n">p</span><span class="o">.</span><span class="n">clearDirty</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="n">oldChanged</span><span class="p">)</span>

        <span class="c"># else: g.doHook(&#39;after-shadow&#39;, p = p)</span>

        <span class="k">return</span> <span class="n">ic</span><span class="o">.</span><span class="n">errors</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="c">#@+node:ekr.20041005105605.27: *4* at.readOpenFile &amp; helpers</span>
    <span class="k">def</span> <span class="nf">readOpenFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">root</span><span class="p">,</span><span class="n">theFile</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span><span class="n">deleteNodes</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.readOpenFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.readOpenFile">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Read an open derived file.</span>

<span class="sd">        Leo 4.5 and later can only read 4.x derived files.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">firstLines</span><span class="p">,</span><span class="n">read_new</span><span class="p">,</span><span class="n">thinFile</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">scanHeader</span><span class="p">(</span><span class="n">theFile</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>
            <span class="c"># Important: this sets at.encoding, used by at.readLine.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">thinFile</span> <span class="o">=</span> <span class="n">thinFile</span>
            <span class="c"># 2010/01/22: use *only* the header to set self.thinFile.</span>

        <span class="k">if</span> <span class="n">deleteNodes</span> <span class="ow">and</span> <span class="n">at</span><span class="o">.</span><span class="n">shouldDeleteChildren</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">thinFile</span><span class="p">):</span>
            <span class="c"># Fix bug 889175: Remember the full fileName.</span>
            <span class="n">at</span><span class="o">.</span><span class="n">rememberReadPath</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">root</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">root</span><span class="o">.</span><span class="n">hasChildren</span><span class="p">():</span>
                <span class="n">root</span><span class="o">.</span><span class="n">firstChild</span><span class="p">()</span><span class="o">.</span><span class="n">doDelete</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">read_new</span><span class="p">:</span>
            <span class="n">lastLines</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">scanText4</span><span class="p">(</span><span class="n">theFile</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span><span class="n">root</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">firstLines</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">;</span> <span class="n">lastLines</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">atShadow</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;invalid @shadow private file&#39;</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>
                <span class="n">at</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;invalid @shadow private file&#39;</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;can not read 3.x derived file&#39;</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>
                <span class="c"># g.es(&#39;you may upgrade these file using Leo 4.0 through 4.4.x&#39;)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;Please use Leo&#39;s import command to read the file&quot;</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;root&#39;</span><span class="p">,</span><span class="n">root</span> <span class="ow">and</span> <span class="n">root</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">root</span><span class="p">:</span>
            <span class="n">root</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">setVisited</span><span class="p">()</span> <span class="c"># Disable warning about set nodes.</span>

        <span class="c">#@+&lt;&lt; handle first and last lines &gt;&gt;</span>
        <span class="c">#@+node:ekr.20041005105605.28: *5* &lt;&lt; handle first and last lines &gt;&gt; (at.readOpenFile)</span>
        <span class="c"># The code below only deals with the root node!</span>
        <span class="c"># We terminate the root&#39;s body text if it exists.</span>
        <span class="c"># This is a hack to allow us to handle @first and @last.</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">v</span>
        <span class="n">tempString</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;tempBodyString&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">tempBodyString</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
        <span class="n">tempList</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;tempBodyList&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">tempBodyList</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">readVersion5</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;tempBodyList&#39;</span><span class="p">):</span>
                <span class="n">body</span> <span class="o">=</span> <span class="n">tempList</span>
                <span class="nb">delattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;tempBodyList&#39;</span><span class="p">)</span> <span class="c"># So the change below &quot;takes&quot;.</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;tempBodyString&#39;</span><span class="p">):</span>
                <span class="n">body</span> <span class="o">=</span> <span class="n">tempString</span>
                <span class="nb">delattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;tempBodyString&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">body</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">body</span> <span class="o">=</span> <span class="n">tempString</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

        <span class="n">at</span><span class="o">.</span><span class="n">completeFirstDirectives</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="n">firstLines</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">completeLastDirectives</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="n">lastLines</span><span class="p">)</span>

        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\r</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>

        <span class="c"># *Always* put the temp body text into at.v.tempBodyString.</span>
        <span class="n">v</span><span class="o">.</span><span class="n">tempBodyString</span> <span class="o">=</span> <span class="n">s</span>
        <span class="c">#@-&lt;&lt; handle first and last lines &gt;&gt;</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span> <span class="c"># root.v.tempBodyString)</span>

        <span class="k">return</span> <span class="n">thinFile</span>
    <span class="c">#@+node:ekr.20100122130101.6175: *5* at.shouldDeleteChildren</span>
    <span class="k">def</span> <span class="nf">shouldDeleteChildren</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">root</span><span class="p">,</span><span class="n">thinFile</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.shouldDeleteChildren"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.shouldDeleteChildren">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Return True if we should delete all children before a read.&#39;&#39;&#39;</span>

        <span class="c"># Delete all children except for old-style @file nodes</span>

        <span class="k">if</span> <span class="n">root</span><span class="o">.</span><span class="n">isAtNoSentFileNode</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="n">root</span><span class="o">.</span><span class="n">isAtFileNode</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">thinFile</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
    <span class="c">#@+node:ekr.20041005105605.117: *5* at.completeFirstDirective</span>
    <span class="c"># 14-SEP-2002 DTHEIN: added for use by atFile.read()</span>

    <span class="c"># this function scans the lines in the list &#39;out&#39; for @first directives</span>
    <span class="c"># and appends the corresponding line from &#39;firstLines&#39; to each @first </span>
    <span class="c"># directive found.  NOTE: the @first directives must be the very first</span>
    <span class="c"># lines in &#39;out&#39;.</span>
    <span class="k">def</span> <span class="nf">completeFirstDirectives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">out</span><span class="p">,</span><span class="n">firstLines</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.completeFirstDirectives"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.completeFirstDirectives">[docs]</a>
        <span class="n">tag</span> <span class="o">=</span> <span class="s">&quot;@first&quot;</span>
        <span class="n">foundAtFirstYet</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">outRange</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
        <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">outRange</span><span class="p">:</span>
            <span class="c"># skip leading whitespace lines</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">foundAtFirstYet</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="k">continue</span>
            <span class="c"># quit if something other than @first directive</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">i</span><span class="p">,</span><span class="n">tag</span><span class="p">):</span> <span class="k">break</span>
            <span class="n">foundAtFirstYet</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="c"># quit if no leading lines to apply</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">firstLines</span><span class="p">):</span> <span class="k">break</span>
            <span class="c"># make the new @first directive</span>
            <span class="c">#18-SEP-2002 DTHEIN: remove trailing newlines because they are inserted later</span>
            <span class="c"># 21-SEP-2002 DTHEIN: no trailing whitespace on empty @first directive</span>
            <span class="n">leadingLine</span> <span class="o">=</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">firstLines</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">tag</span> <span class="o">+</span> <span class="n">leadingLine</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="p">;</span> <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c">#@+node:ekr.20041005105605.118: *5* at.completeLastDirectives</span>
    <span class="c"># 14-SEP-2002 DTHEIN: added for use by atFile.read()</span>

    <span class="c"># this function scans the lines in the list &#39;out&#39; for @last directives</span>
    <span class="c"># and appends the corresponding line from &#39;lastLines&#39; to each @last </span>
    <span class="c"># directive found.  NOTE: the @last directives must be the very last</span>
    <span class="c"># lines in &#39;out&#39;.</span>
    <span class="k">def</span> <span class="nf">completeLastDirectives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">out</span><span class="p">,</span><span class="n">lastLines</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.completeLastDirectives"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.completeLastDirectives">[docs]</a>
        <span class="n">tag</span> <span class="o">=</span> <span class="s">&quot;@last&quot;</span>
        <span class="n">foundAtLastYet</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">outRange</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">outRange</span><span class="p">:</span>
            <span class="c"># skip trailing whitespace lines</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">foundAtLastYet</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> <span class="k">continue</span>
            <span class="c"># quit if something other than @last directive</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">i</span><span class="p">,</span><span class="n">tag</span><span class="p">):</span> <span class="k">break</span>
            <span class="n">foundAtLastYet</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="c"># quit if no trailing lines to apply</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">lastLines</span><span class="p">):</span> <span class="k">break</span>
            <span class="c"># make the new @last directive</span>
            <span class="c">#18-SEP-2002 DTHEIN: remove trailing newlines because they are inserted later</span>
            <span class="c"># 21-SEP-2002 DTHEIN: no trailing whitespace on empty @last directive</span>
            <span class="n">trailingLine</span> <span class="o">=</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">lastLines</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">tag</span> <span class="o">+</span> <span class="n">trailingLine</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="p">;</span> <span class="n">j</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="c">#@+node:ekr.20041005105605.71: *3* Reading (4.x)</span>
    <span class="c">#@+node:ekr.20041005105605.72: *4* at.old/new_createThinChild4</span>
    <span class="c">#@+node:ekr.20041005105605.73: *4* at.findChild4</span>
    <span class="k">def</span> <span class="nf">findChild4</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">headline</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.findChild4"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.findChild4">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Return the next vnode in at.root.tnodeList.</span>
<span class="sd">        This is called only for **legacy** @file nodes&quot;&quot;&quot;</span>

        <span class="c"># tnodeLists are used *only* when reading @file (not @thin) nodes.</span>
        <span class="c"># tnodeLists compensate for not having gnx&#39;s in derived files! </span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">v</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">v</span>

        <span class="c"># if not g.unitTesting:</span>
            <span class="c"># if headline.startswith(&#39;@file&#39;):</span>
                <span class="c"># g.es_print(&#39;Warning: @file logic&#39;,headline)</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">at</span><span class="o">.</span><span class="n">tnodeListIndex</span><span class="p">,</span>
            <span class="n">v</span><span class="o">.</span><span class="n">tnodeList</span><span class="p">[</span><span class="n">at</span><span class="o">.</span><span class="n">tnodeListIndex</span><span class="p">],</span><span class="n">headline</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s">&quot;tnodeList&quot;</span><span class="p">):</span>
            <span class="n">at</span><span class="o">.</span><span class="n">readError</span><span class="p">(</span><span class="s">&quot;no tnodeList for &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;write the @file node or use the Import Derived File command&quot;</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&quot;no tnodeList for &quot;</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">tnodeListIndex</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">tnodeList</span><span class="p">):</span>
            <span class="n">at</span><span class="o">.</span><span class="n">readError</span><span class="p">(</span><span class="s">&quot;bad tnodeList index: </span><span class="si">%d</span><span class="s">, </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">at</span><span class="o">.</span><span class="n">tnodeListIndex</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&quot;bad tnodeList index&quot;</span><span class="p">,</span>
                <span class="n">at</span><span class="o">.</span><span class="n">tnodeListIndex</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">tnodeList</span><span class="p">),</span><span class="n">v</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">tnodeList</span><span class="p">[</span><span class="n">at</span><span class="o">.</span><span class="n">tnodeListIndex</span><span class="p">]</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">tnodeListIndex</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c"># Don&#39;t check the headline.  It simply causes problems.</span>
        <span class="n">v</span><span class="o">.</span><span class="n">setVisited</span><span class="p">()</span> <span class="c"># Supress warning/deletion of unvisited nodes.</span>
        <span class="k">return</span> <span class="n">v</span>
    <span class="c">#@+node:ekr.20041005105605.74: *4* at.scanText4 &amp; allies</span>
    <span class="k">def</span> <span class="nf">scanText4</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">theFile</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.scanText4"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.scanText4">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Scan a 4.x derived file non-recursively.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="n">at</span><span class="o">.</span><span class="n">readVersion5</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c">#@+&lt;&lt; init ivars for scanText4 &gt;&gt;</span>
        <span class="c">#@+node:ekr.20041005105605.75: *5* &lt;&lt; init ivars for scanText4 &gt;&gt;</span>
        <span class="c"># Unstacked ivars...</span>
        <span class="n">at</span><span class="o">.</span><span class="n">cloneSibCount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">at</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">at</span><span class="o">.</span><span class="n">inCode</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">at</span><span class="o">.</span><span class="n">indent</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># Changed only for sentinels.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">lastLines</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># The lines after @-leo</span>
        <span class="n">at</span><span class="o">.</span><span class="n">leadingWs</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="n">at</span><span class="o">.</span><span class="n">lineNumber</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">at</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c"># Bug fix: 12/10/05</span>
        <span class="n">at</span><span class="o">.</span><span class="n">rootSeen</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">at</span><span class="o">.</span><span class="n">updateWarningGiven</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># Stacked ivars...</span>
        <span class="n">at</span><span class="o">.</span><span class="n">endSentinelStack</span> <span class="o">=</span> <span class="p">[</span><span class="n">at</span><span class="o">.</span><span class="n">endLeo</span><span class="p">]</span> <span class="c"># We have already handled the @+leo sentinel.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">endSentinelNodeStack</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span>
        <span class="n">at</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">;</span> <span class="n">at</span><span class="o">.</span><span class="n">outStack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">at</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span>
        <span class="n">at</span><span class="o">.</span><span class="n">vStack</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># New code: always identify root @thin node with self.root:</span>
        <span class="k">if</span> <span class="n">allow_cloned_sibs</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">thinChildIndexStack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">at</span><span class="o">.</span><span class="n">lastThinNode</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">at</span><span class="o">.</span><span class="n">thinNodeStack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c">#@-&lt;&lt; init ivars for scanText4 &gt;&gt;</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;filename:&#39;</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">at</span><span class="o">.</span><span class="n">errors</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">at</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">readLine</span><span class="p">(</span><span class="n">theFile</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
                <span class="n">at</span><span class="o">.</span><span class="n">lineNumber</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c"># An error.  We expect readEndLeo to set at.done.</span>
                    <span class="k">break</span>
                <span class="n">kind</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">sentinelKind4</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="n">at</span><span class="o">.</span><span class="n">noSentinel</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">skipSentinelStart4</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">func</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">dispatch_dict</span><span class="p">[</span><span class="n">kind</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%15s</span><span class="s"> </span><span class="si">%16s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">sentinelName</span><span class="p">(</span><span class="n">kind</span><span class="p">),</span><span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
                <span class="n">func</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="n">junk</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">junk</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
            <span class="n">at</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;scanText4: unexpected assertion failure in&#39;</span><span class="p">,</span>
                <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">fromString</span><span class="p">,</span><span class="s">&#39;fromString&#39;</span><span class="p">,</span><span class="n">fileName</span><span class="p">),</span>
                <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="n">message</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
            <span class="k">raise</span>
            <span class="c"># if g.unitTesting:</span>
            <span class="c">#    raise</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">errors</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">at</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>
            <span class="c">#@+&lt;&lt; report unexpected end of text &gt;&gt;</span>
            <span class="c">#@+node:ekr.20041005105605.76: *5* &lt;&lt; report unexpected end of text &gt;&gt;</span>
            <span class="k">assert</span> <span class="n">at</span><span class="o">.</span><span class="n">endSentinelStack</span><span class="p">,</span><span class="s">&#39;empty sentinel stack&#39;</span>

            <span class="n">at</span><span class="o">.</span><span class="n">readError</span><span class="p">(</span>
                <span class="s">&quot;Unexpected end of file. Expecting </span><span class="si">%s</span><span class="s"> sentinel&quot;</span> <span class="o">%</span>
                <span class="n">at</span><span class="o">.</span><span class="n">sentinelName</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">endSentinelStack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="c">#@-&lt;&lt; report unexpected end of text &gt;&gt;</span>

        <span class="k">return</span> <span class="n">at</span><span class="o">.</span><span class="n">lastLines</span>
    <span class="c">#@+node:ekr.20041005105605.77: *5* at.readNormalLine &amp; appendToDocPart</span>
    <span class="k">def</span> <span class="nf">readNormalLine</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span> <span class="c"># i not used.</span></div>
<div class="viewcode-block" id="atFile.readNormalLine"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.readNormalLine">[docs]</a>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># g.trace(&#39;inCode&#39;,at.inCode,repr(s))</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">inCode</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">at</span><span class="o">.</span><span class="n">raw</span><span class="p">:</span>
                <span class="c"># 2012/06/05: Major bug fix: insert \\-n. for underindented lines.</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">computeLeadingWhitespaceWidth</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">tab_width</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">at</span><span class="o">.</span><span class="n">indent</span><span class="p">:</span>
                    <span class="c"># g.trace(&#39;n: %s at.indent: %s\n%s&#39; % (n,at.indent,repr(s)))</span>
                    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="s">r&#39;</span><span class="se">\\</span><span class="s">-</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">indent</span><span class="o">-</span><span class="n">n</span><span class="p">,</span><span class="n">s</span><span class="o">.</span><span class="n">lstrip</span><span class="p">())</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s">&#39;&#39;</span>
                <span class="k">else</span><span class="p">:</span> <span class="c"># Legacy</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">removeLeadingWhitespace</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">indent</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">tab_width</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">appendToOut</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">appendToDocPart</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100624082003.5942: *6* at.appendToDocPart</span>
    <span class="k">def</span> <span class="nf">appendToDocPart</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.appendToDocPart"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.appendToDocPart">[docs]</a>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="n">at</span><span class="o">.</span><span class="n">readVersion5</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

        <span class="c"># Skip the leading stuff</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">endSentinelComment</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># Skip the single comment delim and a blank.</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">startSentinelComment</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">startSentinelComment</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot; &quot;</span><span class="p">):</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">skipIndent</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">indent</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">readVersion5</span><span class="p">:</span>
            <span class="c"># Append the line to docOut.</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>
            <span class="n">at</span><span class="o">.</span><span class="n">docOut</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Append line to docOut, possibly stripping the newline.</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c"># remove newline for rstrip.</span>

            <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">():</span>
                <span class="c"># no trailing whitespace: the newline is real.</span>
                <span class="n">at</span><span class="o">.</span><span class="n">docOut</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># trailing whitespace: the newline is fake.</span>
                <span class="n">at</span><span class="o">.</span><span class="n">docOut</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20041005105605.80: *5* start sentinels</span>
    <span class="c">#@+node:ekr.20041005105605.81: *6* at.readStartAll</span>
    <span class="k">def</span> <span class="nf">readStartAll</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.readStartAll"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.readStartAll">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Read an @+all sentinel.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="n">leadingWs</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">leadingWs</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="s">&quot;@+all&quot;</span><span class="p">),</span><span class="s">&#39;missing @+all&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="s">&quot;+all&quot;</span><span class="p">),</span><span class="s">&#39;missing +all&#39;</span>

        <span class="c"># Make sure that the generated at-all is properly indented.</span>
        <span class="c"># New code (for both old and new sentinels).</span>
        <span class="c"># Regularize the whitespace preceding the @all directive.</span>
        <span class="n">junk_i</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_leading_ws_with_indent</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">tab_width</span><span class="p">)</span>
        <span class="n">lws2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">computeLeadingWhitespace</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">w</span><span class="o">-</span><span class="n">at</span><span class="o">.</span><span class="n">indent</span><span class="p">),</span><span class="n">at</span><span class="o">.</span><span class="n">tab_width</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">appendToOut</span><span class="p">(</span><span class="n">lws2</span> <span class="o">+</span> <span class="s">&quot;@all</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="n">at</span><span class="o">.</span><span class="n">endSentinelStack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">endAll</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">readVersion5</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">endSentinelNodeStack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">endSentinelLevelStack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">thinNodeStack</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20041005105605.85: *6* at.readStartNode &amp; helpers</span>
    <span class="k">def</span> <span class="nf">readStartNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">middle</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.readStartNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.readStartNode">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Read an @+node or @+middle sentinel.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">gnx</span><span class="p">,</span><span class="n">headline</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">level</span><span class="p">,</span><span class="n">ok</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">parseNodeSentinel</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">middle</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">at</span><span class="o">.</span><span class="n">root_seen</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c"># Switch context.</span>
        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">readVersion5</span><span class="p">:</span>
            <span class="c"># Terminate the *previous* doc part if it exists.</span>
            <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">docOut</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">appendToOut</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">docOut</span><span class="p">))</span>
                <span class="n">at</span><span class="o">.</span><span class="n">docOut</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c"># Important: with new sentinels we *never*</span>
            <span class="c"># terminate nodes until the post-pass.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">at</span><span class="o">.</span><span class="n">docOut</span><span class="p">,</span><span class="s">&#39;not at.docOut&#39;</span> <span class="c"># Cleared by @-node sentinel.</span>
            <span class="n">at</span><span class="o">.</span><span class="n">outStack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">out</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">at</span><span class="o">.</span><span class="n">inCode</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">at</span><span class="o">.</span><span class="n">raw</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># End raw mode.</span>

        <span class="n">at</span><span class="o">.</span><span class="n">vStack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>

        <span class="n">at</span><span class="o">.</span><span class="n">indentStack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">indent</span><span class="p">)</span>
        <span class="n">i</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">indent</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_leading_ws_with_indent</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">tab_width</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">importing</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">createImportedNode</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="n">headline</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span>
        <span class="k">elif</span> <span class="n">at</span><span class="o">.</span><span class="n">thinFile</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">createNewThinNode</span><span class="p">(</span><span class="n">gnx</span><span class="p">,</span><span class="n">headline</span><span class="p">,</span><span class="n">level</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">findChild4</span><span class="p">(</span><span class="n">headline</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">at</span><span class="o">.</span><span class="n">v</span><span class="p">:</span>
            <span class="k">return</span> <span class="c"># 2010/08/02: This can happen when reading strange files.</span>

        <span class="k">if</span> <span class="n">allow_cloned_sibs</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">at</span><span class="o">.</span><span class="n">v</span> <span class="o">==</span> <span class="n">at</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">v</span> <span class="ow">or</span> <span class="n">at</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">isVisited</span><span class="p">(),</span><span class="n">at</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">h</span>

        <span class="n">at</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">setVisited</span><span class="p">()</span>
            <span class="c"># Indicate that the vnode has been set in the external file.</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">at</span><span class="o">.</span><span class="n">readVersion5</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">endSentinelStack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">endNode</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100625085138.5957: *7* at.createNewThinNode &amp; helpers</span>
    <span class="k">def</span> <span class="nf">createNewThinNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">gnx</span><span class="p">,</span><span class="n">headline</span><span class="p">,</span><span class="n">level</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.createNewThinNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.createNewThinNode">[docs]</a>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">thinNodeStack</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">readVersion5</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createV5ThinNode</span><span class="p">(</span><span class="n">gnx</span><span class="p">,</span><span class="n">headline</span><span class="p">,</span><span class="n">level</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">thinNodeStack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">lastThinNode</span><span class="p">)</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">old_createThinChild4</span><span class="p">(</span><span class="n">gnx</span><span class="p">,</span><span class="n">headline</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">v</span>
            <span class="k">if</span> <span class="n">allow_cloned_sibs</span> <span class="ow">and</span> <span class="n">at</span><span class="o">.</span><span class="n">readVersion5</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">thinChildIndexStack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">thinNodeStack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

        <span class="n">at</span><span class="o">.</span><span class="n">lastThinNode</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">return</span> <span class="n">v</span>
    <span class="c">#@+node:ekr.20130121102015.10272: *8* at.createV5ThinNode</span>
    <span class="k">def</span> <span class="nf">createV5ThinNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">gnx</span><span class="p">,</span><span class="n">headline</span><span class="p">,</span><span class="n">level</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.createV5ThinNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.createV5ThinNode">[docs]</a>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span> <span class="c"># at.readVersion5 and </span>
        <span class="n">oldLevel</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">thinNodeStack</span><span class="p">)</span>
        <span class="n">newLevel</span> <span class="o">=</span> <span class="n">level</span>
        <span class="k">assert</span> <span class="n">oldLevel</span> <span class="o">&gt;=</span> <span class="mi">1</span>
        <span class="k">assert</span> <span class="n">newLevel</span> <span class="o">&gt;=</span> <span class="mi">1</span>
        <span class="c"># The invariant: top of at.thinNodeStack after changeLevel is the parent.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">changeLevel</span><span class="p">(</span><span class="n">oldLevel</span><span class="p">,</span><span class="n">newLevel</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">allow_cloned_sibs</span><span class="p">:</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">thinNodeStack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">thinChildIndexStack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">oldLevel</span><span class="p">,</span><span class="n">newLevel</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">parent</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="n">headline</span><span class="p">)</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">new_createThinChild4</span><span class="p">(</span><span class="n">gnx</span><span class="p">,</span><span class="n">headline</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">parent</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">thinChildIndexStack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">at</span><span class="o">.</span><span class="n">thinNodeStack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">thinChildIndexStack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">lastThinNode</span> <span class="o">=</span> <span class="n">v</span>
            <span class="c"># Ensure that the body text is set only once.</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">isVisited</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;tempBodyList&#39;</span><span class="p">):</span>
                    <span class="nb">delattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;tempBodyList&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># This is the only place we call v.setVisited in the read logic.</span>
                <span class="n">v</span><span class="o">.</span><span class="n">setVisited</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">old_createThinChild4</span><span class="p">(</span><span class="n">gnx</span><span class="p">,</span><span class="n">headline</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">thinNodeStack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

        <span class="c"># Common exit code. </span>
        <span class="c"># Terminate a previous clone if it exists.</span>
        <span class="c"># Do not use the full terminateNode logic!</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;tempBodyList&#39;</span><span class="p">):</span>
            <span class="c"># To keep pylint happy.</span>
            <span class="n">v</span><span class="o">.</span><span class="n">tempBodyString</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;tempBodyList&#39;</span><span class="p">))</span>
            <span class="nb">delattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;tempBodyList&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Major bug fix: 2010/07/6:</span>
            <span class="c"># Do *not* create v.tempBodyString here!</span>
            <span class="c"># That would tell at.copyAllTempBodyStringsToVnodes</span>
            <span class="c"># that an older (empty) version exists!</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">v</span>
    <span class="c">#@+node:ekr.20130121075058.10245: *8* at.old_createThinChild4</span>
    <span class="k">def</span> <span class="nf">old_createThinChild4</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">gnxString</span><span class="p">,</span><span class="n">headline</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.old_createThinChild4"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.old_createThinChild4">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Find or create a new *vnode* whose parent (also a vnode)</span>
<span class="sd">        is at.lastThinNode. This is called only for @thin trees.&quot;&quot;&quot;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">c</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">nodeIndices</span>
        <span class="n">gnx</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">scanGnx</span><span class="p">(</span><span class="n">gnxString</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">gnxDict</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fileCommands</span><span class="o">.</span><span class="n">gnxDict</span>

        <span class="n">last</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">lastThinNode</span> <span class="c"># A vnode.</span>
        <span class="n">lastIndex</span> <span class="o">=</span> <span class="n">last</span><span class="o">.</span><span class="n">fileIndex</span>
        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&quot;last </span><span class="si">%s</span><span class="s">, gnx </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">last</span> <span class="ow">and</span> <span class="n">last</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="n">gnxString</span><span class="p">,</span><span class="n">headline</span><span class="p">))</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">last</span>
        <span class="n">children</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">children</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">gnx</span> <span class="o">==</span> <span class="n">child</span><span class="o">.</span><span class="n">fileIndex</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">child</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">cloneSibCount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">cloneSibCount</span> <span class="p">;</span> <span class="n">at</span><span class="o">.</span><span class="n">cloneSibCount</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">child</span><span class="p">:</span> <span class="n">clonedSibs</span><span class="p">,</span><span class="n">junk</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">scanForClonedSibs</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">child</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">clonedSibs</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">copies</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="n">clonedSibs</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">copies</span><span class="p">,</span><span class="n">headline</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">gnx</span> <span class="o">==</span> <span class="n">lastIndex</span><span class="p">:</span>
                <span class="n">last</span><span class="o">.</span><span class="n">setVisited</span><span class="p">()</span>
                    <span class="c"># Supress warning/deletion of unvisited nodes.</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span><span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;found last&#39;</span><span class="p">,</span><span class="n">last</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">last</span>
            <span class="k">if</span> <span class="n">child</span><span class="p">:</span>
                <span class="n">child</span><span class="o">.</span><span class="n">setVisited</span><span class="p">()</span>
                    <span class="c"># Supress warning/deletion of unvisited nodes.</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;found child&#39;</span><span class="p">,</span><span class="n">child</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">child</span>
            <span class="n">copies</span> <span class="o">=</span> <span class="mi">1</span> <span class="c"># Create exactly one copy.</span>

        <span class="k">while</span> <span class="n">copies</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">copies</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="c"># Create the vnode only if it does not already exist.</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">gnxDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gnxString</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">gnx</span> <span class="o">!=</span> <span class="n">v</span><span class="o">.</span><span class="n">fileIndex</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">internalError</span><span class="p">(</span><span class="s">&#39;v.fileIndex: </span><span class="si">%s</span><span class="s"> gnx: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">v</span><span class="o">.</span><span class="n">fileIndex</span><span class="p">,</span><span class="n">gnx</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">leoNodes</span><span class="o">.</span><span class="n">vnode</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
                <span class="n">v</span><span class="o">.</span><span class="n">_headString</span> <span class="o">=</span> <span class="n">headline</span> <span class="c"># Allowed use of v._headString.</span>
                <span class="n">v</span><span class="o">.</span><span class="n">fileIndex</span> <span class="o">=</span> <span class="n">gnx</span>
                <span class="n">gnxDict</span><span class="p">[</span><span class="n">gnxString</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

            <span class="n">child</span> <span class="o">=</span> <span class="n">v</span>
            <span class="n">child</span><span class="o">.</span><span class="n">_linkAsNthChild</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">parent</span><span class="o">.</span><span class="n">numberOfChildren</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;new node: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">child</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
        <span class="n">child</span><span class="o">.</span><span class="n">setVisited</span><span class="p">()</span> <span class="c"># Supress warning/deletion of unvisited nodes.</span>
        <span class="k">return</span> <span class="n">child</span>
    <span class="c">#@+node:ekr.20130121075058.10246: *8* at.new_createThinChild4</span>
    <span class="k">def</span> <span class="nf">new_createThinChild4</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">gnxString</span><span class="p">,</span><span class="n">headline</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">parent</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.new_createThinChild4"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.new_createThinChild4">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Find or create a new *vnode* whose parent (also a vnode)</span>
<span class="sd">        is at.lastThinNode. This is called only for @thin trees.&quot;&quot;&quot;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">nodeIndices</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">children</span><span class="p">),</span><span class="n">parent</span><span class="o">.</span><span class="n">h</span><span class="p">,</span>
            <span class="c"># at.thinChildIndexStack,[z.h for z in at.thinNodeStack],</span>
            <span class="s">&#39; -&gt; &#39;</span><span class="p">,</span><span class="n">headline</span><span class="p">)</span>
        <span class="n">gnx</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">scanGnx</span><span class="p">(</span><span class="n">gnxString</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">gnxDict</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fileCommands</span><span class="o">.</span><span class="n">gnxDict</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">gnxDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gnxString</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">gnx</span> <span class="o">==</span> <span class="n">v</span><span class="o">.</span><span class="n">fileIndex</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">h</span> <span class="o">!=</span> <span class="n">headline</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;read error v.h: </span><span class="si">%s</span><span class="s"> headline: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="n">headline</span><span class="p">))</span>
                <span class="n">child</span> <span class="o">=</span> <span class="n">v</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">children</span><span class="p">):</span>
                    <span class="n">child</span><span class="o">.</span><span class="n">_linkAsNthChild</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;OLD n: </span><span class="si">%s</span><span class="s"> parent: </span><span class="si">%s</span><span class="s"> -&gt; </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">parent</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="n">child</span><span class="o">.</span><span class="n">h</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;DUP n: </span><span class="si">%s</span><span class="s"> parent: </span><span class="si">%s</span><span class="s"> -&gt; </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">parent</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="n">child</span><span class="o">.</span><span class="n">h</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gnx_s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">nodeIndices</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="n">gnx</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">internalError</span><span class="p">(</span><span class="s">&#39;v.fileIndex: </span><span class="si">%s</span><span class="s"> gnx: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">fileIndex</span><span class="p">,</span><span class="n">gnx_s</span><span class="p">))</span>
                <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">leoNodes</span><span class="o">.</span><span class="n">vnode</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
            <span class="n">v</span><span class="o">.</span><span class="n">_headString</span> <span class="o">=</span> <span class="n">headline</span> <span class="c"># Allowed use of v._headString.</span>
            <span class="n">v</span><span class="o">.</span><span class="n">fileIndex</span> <span class="o">=</span> <span class="n">gnx</span>
            <span class="n">gnxDict</span><span class="p">[</span><span class="n">gnxString</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="n">child</span> <span class="o">=</span> <span class="n">v</span>
            <span class="n">child</span><span class="o">.</span><span class="n">_linkAsNthChild</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;NEW n: </span><span class="si">%s</span><span class="s"> parent: </span><span class="si">%s</span><span class="s"> -&gt; </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">parent</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="n">child</span><span class="o">.</span><span class="n">h</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">child</span>
    <span class="c">#@+node:ekr.20100625184546.5979: *7* at.parseNodeSentinel &amp; helpers</span>
    <span class="k">def</span> <span class="nf">parseNodeSentinel</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">middle</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.parseNodeSentinel"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.parseNodeSentinel">[docs]</a>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">middle</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;+middle:&quot;</span><span class="p">),</span><span class="s">&#39;missing +middle&#39;</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">8</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;+node:&#39;</span><span class="p">):</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">40</span><span class="p">]),</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
            <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;+node:&quot;</span><span class="p">),</span><span class="s">&#39;missing +node:&#39;</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">6</span>

        <span class="c"># Get the gnx and the headline.</span>
        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">thinFile</span><span class="p">:</span>
            <span class="n">gnx</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">level</span><span class="p">,</span><span class="n">ok</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">parseThinNodeSentinel</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gnx</span><span class="p">,</span><span class="n">level</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span><span class="bp">None</span>

        <span class="n">headline</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">getNodeHeadline</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gnx</span><span class="p">,</span><span class="n">headline</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">level</span><span class="p">,</span><span class="bp">True</span>
    <span class="c">#@+node:ekr.20100625085138.5955: *8* at.getNodeHeadline</span>
    <span class="k">def</span> <span class="nf">getNodeHeadline</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.getNodeHeadline"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.getNodeHeadline">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Set headline to the rest of the line.</span>
<span class="sd">        Don&#39;t strip leading whitespace.&#39;&#39;&#39;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">endSentinelComment</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">endSentinelComment</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="c"># works if k == -1</span>

        <span class="c"># Undo the CWEB hack: undouble @ signs if\</span>
        <span class="c"># the opening comment delim ends in &#39;@&#39;.</span>
        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">startSentinelComment</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="s">&#39;@&#39;</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;@@&#39;</span><span class="p">,</span><span class="s">&#39;@&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">h</span>
    <span class="c">#@+node:ekr.20100625085138.5953: *8* at.parseThinNodeSentinel</span>
    <span class="k">def</span> <span class="nf">parseThinNodeSentinel</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.parseThinNodeSentinel"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.parseThinNodeSentinel">[docs]</a>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">def</span> <span class="nf">oops</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">message</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">at</span><span class="o">.</span><span class="n">readError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span><span class="bp">False</span>

        <span class="n">j</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">oops</span><span class="p">(</span><span class="s">&#39;Expecting gnx in @+node sentinel&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gnx</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">readVersion5</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="s">&#39;: &#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">oops</span><span class="p">(</span><span class="s">&#39;Expecting space after gnx&#39;</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;*&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">oops</span><span class="p">(</span><span class="s">&#39;No level stars&#39;</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39; &#39;</span><span class="p">):</span>
                <span class="n">level</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;* &#39;</span><span class="p">):</span>
                <span class="n">level</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># The level stars have the form *N*.</span>
                <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span>  <span class="p">;</span> <span class="n">j</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">j</span><span class="p">:</span>
                    <span class="n">level</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">i</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">oops</span><span class="p">(</span><span class="s">&#39;No level number&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;* &#39;</span><span class="p">):</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">oops</span><span class="p">(</span><span class="s">&#39;No space after level stars&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># not readVersion5.</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span> <span class="c"># Skip the gnx.</span>
            <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="n">gnx</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">level</span><span class="p">,</span><span class="bp">True</span>
    <span class="c">#@+node:ekr.20041005105605.111: *6* at.readRef (paired using new sentinels)</span>
    <span class="c">#@+at The sentinel contains an @ followed by a section name in angle brackets.</span>
    <span class="c"># This code is different from the code for the @@ sentinel: the expansion</span>
    <span class="c"># of the reference does not include a trailing newline.</span>
    <span class="c">#@@c</span>

    <span class="k">def</span> <span class="nf">readRef</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.readRef"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.readRef">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Handle an @&lt;&lt; sentinel.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">readVersion5</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;+&quot;</span><span class="p">),</span><span class="s">&#39;g.match(s,i,&quot;+&quot;)&#39;</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c"># Skip the new plus sign.</span>

            <span class="c"># New in Leo 4.8: Ignore the spellling in leadingWs.</span>
            <span class="c"># Instead, compute lws2, the regularized leading whitespace.</span>
            <span class="n">junk_i</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_leading_ws_with_indent</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">tab_width</span><span class="p">)</span>
            <span class="n">lws2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">computeLeadingWhitespace</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">w</span><span class="o">-</span><span class="n">at</span><span class="o">.</span><span class="n">indent</span><span class="p">),</span><span class="n">at</span><span class="o">.</span><span class="n">tab_width</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lws2</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

        <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="s">&quot;&lt;&lt;&quot;</span><span class="p">),</span><span class="s">&#39;missing @&lt;&lt; sentinel&#39;</span>

        <span class="c"># g.trace(repr(at.endSentinelComment))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">endSentinelComment</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">readVersion5</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">lws2</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c"># No trailing newline</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">endSentinelComment</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">readVersion5</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">lws2</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="c"># Restore the newline.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">k</span><span class="p">]</span> <span class="c"># No trailing newline, whatever k is.</span>
            <span class="c"># g.trace(repr(line))</span>

        <span class="c"># Undo the cweb hack.</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">startSentinelComment</span>
        <span class="k">if</span> <span class="n">start</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">start</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;@&#39;</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;@@&#39;</span><span class="p">,</span><span class="s">&#39;@&#39;</span><span class="p">)</span>

        <span class="n">at</span><span class="o">.</span><span class="n">appendToOut</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">readVersion5</span><span class="p">:</span>
            <span class="c"># g.trace(at.indent,repr(line))</span>
            <span class="n">at</span><span class="o">.</span><span class="n">endSentinelLevelStack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">thinNodeStack</span><span class="p">))</span>
            <span class="n">at</span><span class="o">.</span><span class="n">endSentinelIndentStack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">indent</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">endSentinelStack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">endRef</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">endSentinelNodeStack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c"># There is no paired @-ref sentinel.</span>
    <span class="c">#@+node:ekr.20041005105605.82: *6* at.readStartAt/Doc &amp; helpers</span>
    <span class="c">#@+node:ekr.20100624082003.5938: *7* readStartAt</span>
    <span class="k">def</span> <span class="nf">readStartAt</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.readStartAt"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.readStartAt">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Read an @+at sentinel.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;+at&quot;</span><span class="p">),</span><span class="s">&#39;missing +at&#39;</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">3</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">readVersion5</span><span class="p">:</span> <span class="c"># Append whatever follows the sentinel.</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">skipToEndSentinel</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="n">follow</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>
            <span class="n">at</span><span class="o">.</span><span class="n">appendToOut</span><span class="p">(</span><span class="s">&#39;@&#39;</span> <span class="o">+</span> <span class="n">follow</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">docOut</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">at</span><span class="o">.</span><span class="n">inCode</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="n">ws</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>
            <span class="n">at</span><span class="o">.</span><span class="n">docOut</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;@&#39;</span> <span class="o">+</span> <span class="n">ws</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">]</span>
                <span class="c"># This newline may be removed by a following @nonl</span>
            <span class="n">at</span><span class="o">.</span><span class="n">inCode</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">at</span><span class="o">.</span><span class="n">endSentinelStack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">endAt</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100624082003.5939: *7* readStartDoc</span>
    <span class="k">def</span> <span class="nf">readStartDoc</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.readStartDoc"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.readStartDoc">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Read an @+doc sentinel.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;+doc&quot;</span><span class="p">),</span><span class="s">&#39;missing +doc&#39;</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">readVersion5</span><span class="p">:</span> <span class="c"># Append whatever follows the sentinel.</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">skipToEndSentinel</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="n">follow</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
            <span class="n">at</span><span class="o">.</span><span class="n">appendToOut</span><span class="p">(</span><span class="s">&#39;@&#39;</span> <span class="o">+</span> <span class="n">follow</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">docOut</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">at</span><span class="o">.</span><span class="n">inCode</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="n">ws</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>
            <span class="n">at</span><span class="o">.</span><span class="n">docOut</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;@doc&quot;</span> <span class="o">+</span> <span class="n">ws</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">]</span>
                <span class="c"># This newline may be removed by a following @nonl</span>
            <span class="n">at</span><span class="o">.</span><span class="n">inCode</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">at</span><span class="o">.</span><span class="n">endSentinelStack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">endDoc</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100624082003.5940: *7* skipToEndSentinel</span>
    <span class="k">def</span> <span class="nf">skipToEndSentinel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.skipToEndSentinel"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.skipToEndSentinel">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Skip to the end of the sentinel line.&#39;&#39;&#39;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">endSentinelComment</span>

        <span class="k">if</span> <span class="n">end</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">end</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_to_end_of_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">j</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_to_end_of_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20041005105605.83: *6* at.readStartLeo</span>
    <span class="k">def</span> <span class="nf">readStartLeo</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.readStartLeo"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.readStartLeo">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Read an unexpected @+leo sentinel.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;+leo&quot;</span><span class="p">),</span><span class="s">&#39;missing +leo sentinel&#39;</span>
        <span class="n">at</span><span class="o">.</span><span class="n">readError</span><span class="p">(</span><span class="s">&quot;Ignoring unexpected @+leo sentinel&quot;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20041005105605.84: *6* at.readStartMiddle</span>
    <span class="k">def</span> <span class="nf">readStartMiddle</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.readStartMiddle"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.readStartMiddle">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Read an @+middle sentinel.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">at</span><span class="o">.</span><span class="n">readStartNode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">middle</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20041005105605.89: *6* at.readStartOthers</span>
    <span class="k">def</span> <span class="nf">readStartOthers</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.readStartOthers"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.readStartOthers">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Read an @+others sentinel.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="n">leadingWs</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">leadingWs</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="s">&quot;@+others&quot;</span><span class="p">),</span><span class="s">&#39;missing @+others&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="s">&quot;+others&quot;</span><span class="p">),</span><span class="s">&#39;missing +others&#39;</span>

        <span class="c"># Make sure that the generated at-others is properly indented.</span>
        <span class="c"># New code (for both old and new sentinels).</span>
        <span class="c"># Regularize the whitespace preceding the @others directive.</span>
        <span class="n">junk_i</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_leading_ws_with_indent</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">tab_width</span><span class="p">)</span>
        <span class="n">lws2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">computeLeadingWhitespace</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">w</span><span class="o">-</span><span class="n">at</span><span class="o">.</span><span class="n">indent</span><span class="p">),</span><span class="n">at</span><span class="o">.</span><span class="n">tab_width</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">appendToOut</span><span class="p">(</span><span class="n">lws2</span> <span class="o">+</span> <span class="s">&quot;@others</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">readVersion5</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">endSentinelIndentStack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">indent</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">endSentinelStack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">endOthers</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">endSentinelNodeStack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">endSentinelLevelStack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">thinNodeStack</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">endSentinelStack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">endOthers</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20041005105605.90: *5* end sentinels</span>
    <span class="c">#@+node:ekr.20041005105605.91: *6* at.readEndAll</span>
    <span class="k">def</span> <span class="nf">readEndAll</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">unused_s</span><span class="p">,</span><span class="n">unused_i</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.readEndAll"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.readEndAll">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Read an @-all sentinel.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">at</span><span class="o">.</span><span class="n">popSentinelStack</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">endAll</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">readVersion5</span><span class="p">:</span>

            <span class="c"># Restore the node containing the @all directive.</span>
            <span class="c"># *Never* terminate new-sentinel nodes until the post-pass.</span>
            <span class="n">at</span><span class="o">.</span><span class="n">raw</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># End raw mode: 2011/06/13.</span>
            <span class="n">oldLevel</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">thinNodeStack</span><span class="p">)</span>
            <span class="n">newLevel</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">endSentinelLevelStack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">at</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">endSentinelNodeStack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="c"># Bug fix: 2011/06/13.</span>
            <span class="n">at</span><span class="o">.</span><span class="n">changeLevel</span><span class="p">(</span><span class="n">oldLevel</span><span class="p">,</span><span class="n">newLevel</span><span class="p">)</span>

            <span class="c"># g.trace(&#39;oldLevel&#39;,oldLevel,&#39;newLevel&#39;,newLevel,&#39;at.v&#39;,at.v)</span>
    <span class="c">#@+node:ekr.20041005105605.92: *6* at.readEndAt &amp; readEndDoc</span>
    <span class="k">def</span> <span class="nf">readEndAt</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">unused_s</span><span class="p">,</span><span class="n">unused_i</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.readEndAt"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.readEndAt">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Read an @-at sentinel.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">at</span><span class="o">.</span><span class="n">readLastDocLine</span><span class="p">(</span><span class="s">&quot;@&quot;</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">popSentinelStack</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">endAt</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">inCode</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">readEndDoc</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">unused_s</span><span class="p">,</span><span class="n">unused_i</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.readEndDoc"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.readEndDoc">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Read an @-doc sentinel.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">at</span><span class="o">.</span><span class="n">readLastDocLine</span><span class="p">(</span><span class="s">&quot;@doc&quot;</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">popSentinelStack</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">endDoc</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">inCode</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="c">#@+node:ekr.20041005105605.93: *6* at.readEndLeo</span>
    <span class="k">def</span> <span class="nf">readEndLeo</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">unused_s</span><span class="p">,</span><span class="n">unused_i</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.readEndLeo"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.readEndLeo">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Read an @-leo sentinel.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># Ignore everything after @-leo.</span>
        <span class="c"># Such lines were presumably written by @last.</span>
        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">readLine</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">inputFile</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">break</span>
            <span class="n">at</span><span class="o">.</span><span class="n">lastLines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="c"># Capture all trailing lines, even if empty.</span>

        <span class="n">at</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="c">#@+node:ekr.20041005105605.94: *6* at.readEndMiddle</span>
    <span class="k">def</span> <span class="nf">readEndMiddle</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.readEndMiddle"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.readEndMiddle">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Read an @-middle sentinel.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">at</span><span class="o">.</span><span class="n">readEndNode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">middle</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20041005105605.95: *6* at.readEndNode</span>
    <span class="k">def</span> <span class="nf">readEndNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">unused_s</span><span class="p">,</span><span class="n">unused_i</span><span class="p">,</span><span class="n">middle</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.readEndNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.readEndNode">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Handle @-node sentinels.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">assert</span> <span class="ow">not</span> <span class="n">at</span><span class="o">.</span><span class="n">readVersion5</span><span class="p">,</span><span class="s">&#39;not at.readVersion5&#39;</span>
            <span class="c"># Must not be called for new sentinels.</span>

        <span class="n">at</span><span class="o">.</span><span class="n">raw</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># End raw mode.</span>

        <span class="n">at</span><span class="o">.</span><span class="n">terminateNode</span><span class="p">(</span><span class="n">middle</span><span class="p">)</span>
            <span class="c"># Set the body text and warn about changed text.</span>
            <span class="c"># This must not be called when handling new sentinels!</span>

        <span class="c"># End the previous node sentinel.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">indent</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">indentStack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">at</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">outStack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">at</span><span class="o">.</span><span class="n">docOut</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">at</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">vStack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">thinFile</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">at</span><span class="o">.</span><span class="n">importing</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">lastThinNode</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">thinNodeStack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="n">at</span><span class="o">.</span><span class="n">popSentinelStack</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">endNode</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20041005105605.98: *6* at.readEndOthers</span>
    <span class="k">def</span> <span class="nf">readEndOthers</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">unused_s</span><span class="p">,</span><span class="n">unused_i</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.readEndOthers"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.readEndOthers">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Read an @-others sentinel.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">at</span><span class="o">.</span><span class="n">popSentinelStack</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">endOthers</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">readVersion5</span><span class="p">:</span>
            <span class="c"># g.trace(at.readVersion5,repr(at.docOut))</span>
            <span class="c"># Terminate the *previous* doc part if it exists.</span>
            <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">docOut</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">docOut</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">massageAtDocPart</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="c"># 2011/05/24</span>
                <span class="n">at</span><span class="o">.</span><span class="n">appendToOut</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="n">at</span><span class="o">.</span><span class="n">docOut</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c"># 2010/10/21: Important bug fix: always enter code mode.</span>
            <span class="n">at</span><span class="o">.</span><span class="n">inCode</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="c"># Restore the node continain the @others directive.</span>
            <span class="c"># *Never* terminate new-sentinel nodes until the post-pass.</span>
            <span class="n">at</span><span class="o">.</span><span class="n">raw</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># End raw mode.</span>
            <span class="n">at</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">endSentinelNodeStack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">at</span><span class="o">.</span><span class="n">indent</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">endSentinelIndentStack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">oldLevel</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">thinNodeStack</span><span class="p">)</span>
            <span class="n">newLevel</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">endSentinelLevelStack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">at</span><span class="o">.</span><span class="n">changeLevel</span><span class="p">(</span><span class="n">oldLevel</span><span class="p">,</span><span class="n">newLevel</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100625140824.5968: *6* at.readEndRef</span>
    <span class="k">def</span> <span class="nf">readEndRef</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">unused_s</span><span class="p">,</span><span class="n">unused_i</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.readEndRef"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.readEndRef">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Read an @-&lt;&lt; sentinel.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">at</span><span class="o">.</span><span class="n">popSentinelStack</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">endRef</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">readVersion5</span><span class="p">:</span>
            <span class="c"># Terminate the *previous* doc part if it exists.</span>
            <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">docOut</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">appendToOut</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">docOut</span><span class="p">))</span>
                <span class="n">at</span><span class="o">.</span><span class="n">docOut</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c"># 2010/10/21: Important bug fix: always enter code mode.</span>
            <span class="n">at</span><span class="o">.</span><span class="n">inCode</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="c"># Restore the node containing the section reference.</span>
            <span class="c"># *Never* terminate new-sentinel nodes until the post-pass.</span>
            <span class="n">at</span><span class="o">.</span><span class="n">raw</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># End raw mode.</span>
            <span class="n">at</span><span class="o">.</span><span class="n">lastRefNode</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">v</span> <span class="c"># A kludge for at.readAfterRef</span>
            <span class="n">at</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">endSentinelNodeStack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">at</span><span class="o">.</span><span class="n">indent</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">endSentinelIndentStack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">oldLevel</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">thinNodeStack</span><span class="p">)</span>
            <span class="n">newLevel</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">endSentinelLevelStack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">at</span><span class="o">.</span><span class="n">changeLevel</span><span class="p">(</span><span class="n">oldLevel</span><span class="p">,</span><span class="n">newLevel</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20041005105605.99: *6* at.readLastDocLine (old sentinels only)</span>
    <span class="k">def</span> <span class="nf">readLastDocLine</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tag</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.readLastDocLine"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.readLastDocLine">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Read the @c line that terminates the doc part.</span>
<span class="sd">        tag is @doc or @.</span>

<span class="sd">        Not used when reading new sentinels.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">endSentinelComment</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">startSentinelComment</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">docOut</span><span class="p">)</span>

        <span class="c"># Remove the @doc or @space.  We&#39;ll add it back at the end.</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">tag</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">tag</span><span class="p">):]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">readError</span><span class="p">(</span><span class="s">&quot;Missing start of doc part&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c"># Bug fix: Append any whitespace following the tag to tag.</span>
        <span class="k">while</span> <span class="n">s</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">):</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">;</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="k">if</span> <span class="n">end</span><span class="p">:</span>
            <span class="c"># Remove leading newline.</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">:</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="c"># Remove opening block delim.</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">start</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">start</span><span class="p">):]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">readError</span><span class="p">(</span><span class="s">&quot;Missing open block comment&quot;</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;tag&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">tag</span><span class="p">),</span><span class="s">&#39;start&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">start</span><span class="p">),</span><span class="s">&#39;s&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
                <span class="k">return</span>
            <span class="c"># Remove trailing newline.</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">:</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c"># Remove closing block delim.</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">end</span><span class="p">):]</span> <span class="o">==</span> <span class="n">end</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">end</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">readError</span><span class="p">(</span><span class="s">&quot;Missing close block comment&quot;</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="n">at</span><span class="o">.</span><span class="n">appendToOut</span><span class="p">(</span><span class="n">tag</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">docOut</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c">#@+node:ekr.20041005105605.100: *5* Unpaired sentinels</span>
    <span class="c"># Ooops: shadow files are cleared if there is a read error!!</span>
    <span class="c">#@+node:ekr.20041005105605.101: *6* at.ignoreOldSentinel</span>
    <span class="k">def</span>  <span class="nf">ignoreOldSentinel</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">unused_i</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.ignoreOldSentinel"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.ignoreOldSentinel">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Ignore an 3.x sentinel.&quot;&quot;&quot;</span>

        <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;ignoring 3.x sentinel:&quot;</span><span class="p">,</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="c">#@+node:ekr.20041005105605.102: *6* at.readAfterRef</span>
    <span class="k">def</span>  <span class="nf">readAfterRef</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.readAfterRef"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.readAfterRef">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Read an @afterref sentinel.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;afterref&quot;</span><span class="p">),</span><span class="s">&#39;missing afterref&#39;</span>

        <span class="c"># Append the next line to the text.</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">readLine</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">inputFile</span><span class="p">)</span>

        <span class="n">v</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">lastRefNode</span>
        <span class="n">hasList</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;tempBodyList&#39;</span><span class="p">)</span>
        <span class="c"># g.trace(&#39;hasList&#39;,hasList,&#39;v&#39;,v and v.h)</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">readVersion5</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">hasList</span> <span class="ow">and</span> <span class="n">at</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">tempBodyList</span><span class="p">:</span>
                <span class="c"># Remove the trailing newline.</span>
                <span class="n">s2</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">tempBodyList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">s2</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">):</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">s2</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">at</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">tempBodyList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">s2</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;v: </span><span class="si">%30s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">s2</span><span class="o">+</span><span class="n">s</span><span class="p">)))</span>

        <span class="n">at</span><span class="o">.</span><span class="n">appendToOut</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20041005105605.103: *6* at.readClone</span>
    <span class="k">def</span> <span class="nf">readClone</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.readClone"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.readClone">[docs]</a>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">tag</span> <span class="o">=</span> <span class="s">&quot;clone&quot;</span>

        <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">tag</span><span class="p">),</span><span class="s">&#39;missing clone sentinel&#39;</span>

        <span class="c"># Skip the tag and whitespace.</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">tag</span><span class="p">))</span>

        <span class="c"># Get the clone count.</span>
        <span class="n">junk</span><span class="p">,</span><span class="n">val</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_long</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">readError</span><span class="p">(</span><span class="s">&quot;Invalid count in @clone sentinel&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">cloneSibCount</span> <span class="o">=</span> <span class="n">val</span>
    <span class="c">#@+node:ekr.20041005105605.104: *6* at.readComment</span>
    <span class="k">def</span> <span class="nf">readComment</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.readComment"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.readComment">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Read an @comment sentinel.&quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;comment&quot;</span><span class="p">),</span><span class="s">&#39;missing comment sentinel&#39;</span>

        <span class="c"># Just ignore the comment line!</span>
    <span class="c">#@+node:ekr.20041005105605.105: *6* at.readDelims</span>
    <span class="k">def</span> <span class="nf">readDelims</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.readDelims"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.readDelims">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Read an @delims sentinel.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;@delims&quot;</span><span class="p">),</span><span class="s">&#39;missing @delims&#39;</span>

        <span class="c"># Skip the keyword and whitespace.</span>
        <span class="n">i0</span> <span class="o">=</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="mi">7</span><span class="p">)</span>

        <span class="c"># Get the first delim.</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">is_ws</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">is_nl</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">startSentinelComment</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">i</span><span class="p">]</span>

            <span class="c"># Get the optional second delim.</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">is_ws</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">is_nl</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">j</span><span class="o">&lt;</span><span class="n">i</span><span class="p">,</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">i</span><span class="p">],</span><span class="s">&quot;&quot;</span><span class="p">)</span>
            <span class="n">i2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">end</span> <span class="o">==</span> <span class="n">at</span><span class="o">.</span><span class="n">endSentinelComment</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i2</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">is_nl</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i2</span><span class="p">)):</span>
                <span class="n">at</span><span class="o">.</span><span class="n">endSentinelComment</span> <span class="o">=</span> <span class="s">&quot;&quot;</span> <span class="c"># Not really two params.</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i0</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
                <span class="n">at</span><span class="o">.</span><span class="n">appendToOut</span><span class="p">(</span><span class="n">line</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">endSentinelComment</span> <span class="o">=</span> <span class="n">end</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i0</span><span class="p">:</span><span class="n">i</span><span class="p">]</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
                <span class="n">at</span><span class="o">.</span><span class="n">appendToOut</span><span class="p">(</span><span class="n">line</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">readError</span><span class="p">(</span><span class="s">&quot;Bad @delims&quot;</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">appendToOut</span><span class="p">(</span><span class="s">&quot;@delims&quot;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20041005105605.106: *6* at.readDirective (@@)</span>
    <span class="k">def</span> <span class="nf">readDirective</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.readDirective"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.readDirective">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Read an @@sentinel.&quot;&quot;&quot;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;@&quot;</span><span class="p">),</span><span class="s">&#39;missing @@ sentinel&#39;</span>
            <span class="c"># The first &#39;@&#39; has already been eaten.</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:]))</span>
            <span class="c"># g.trace(g.get_line(s,i))</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;@raw&quot;</span><span class="p">):</span>
            <span class="n">at</span><span class="o">.</span><span class="n">raw</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;@end_raw&quot;</span><span class="p">):</span>
            <span class="n">at</span><span class="o">.</span><span class="n">raw</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="n">e</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">endSentinelComment</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">s2</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">startSentinelComment</span>
        <span class="k">if</span> <span class="n">start</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">start</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;@&#39;</span><span class="p">:</span>
            <span class="n">s2</span> <span class="o">=</span> <span class="n">s2</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;@@&#39;</span><span class="p">,</span><span class="s">&#39;@&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># New in 4.2.1: never change comment delims here...</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;@language&quot;</span><span class="p">):</span>
                <span class="c">#@+&lt;&lt; handle @language &gt;&gt;</span>
                <span class="c">#@+node:ekr.20041005105605.107: *7* &lt;&lt; handle @language &gt;&gt;</span>
                <span class="c"># Skip the keyword and whitespace.</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="s">&quot;@language&quot;</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_c_id</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                <span class="n">language</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>

                <span class="n">delim1</span><span class="p">,</span><span class="n">delim2</span><span class="p">,</span><span class="n">delim3</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">set_delims_from_language</span><span class="p">(</span><span class="n">language</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">get_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">))</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">delim1</span><span class="p">,</span><span class="n">delim2</span><span class="p">,</span><span class="n">delim3</span><span class="p">)</span>

                <span class="c"># Returns a tuple (single,start,end) of comment delims</span>
                <span class="k">if</span> <span class="n">delim1</span><span class="p">:</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">startSentinelComment</span> <span class="o">=</span> <span class="n">delim1</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">endSentinelComment</span> <span class="o">=</span> <span class="s">&quot;&quot;</span> <span class="c"># Must not be None.</span>
                <span class="k">elif</span> <span class="n">delim2</span> <span class="ow">and</span> <span class="n">delim3</span><span class="p">:</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">startSentinelComment</span> <span class="o">=</span> <span class="n">delim2</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">endSentinelComment</span> <span class="o">=</span> <span class="n">delim3</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;ignoring bad @language sentinel:&quot;</span><span class="p">,</span><span class="n">line</span><span class="p">)</span>
                <span class="c">#@-&lt;&lt; handle @language &gt;&gt;</span>
            <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;@comment&quot;</span><span class="p">):</span>
                <span class="c">#@+&lt;&lt; handle @comment &gt;&gt;</span>
                <span class="c">#@+node:ekr.20041005105605.108: *7* &lt;&lt; handle @comment &gt;&gt;</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>
                <span class="n">delim1</span><span class="p">,</span><span class="n">delim2</span><span class="p">,</span><span class="n">delim3</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">set_delims_from_string</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                <span class="c">#g.trace(g.get_line(s,i))</span>
                <span class="c">#g.trace(delim1,delim2,delim3)</span>

                <span class="c"># Returns a tuple (single,start,end) of comment delims</span>
                <span class="k">if</span> <span class="n">delim1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">startSentinelComment</span> <span class="o">=</span> <span class="n">delim1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">endSentinelComment</span> <span class="o">=</span> <span class="s">&quot;&quot;</span> <span class="c"># Must not be None.</span>
                <span class="k">elif</span> <span class="n">delim2</span> <span class="ow">and</span> <span class="n">delim3</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">startSentinelComment</span> <span class="o">=</span> <span class="n">delim2</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">endSentinelComment</span> <span class="o">=</span> <span class="n">delim3</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;ignoring bad @comment sentinel:&quot;</span><span class="p">,</span><span class="n">line</span><span class="p">)</span>
                <span class="c">#@-&lt;&lt; handle @comment &gt;&gt;</span>

        <span class="c"># An @c or @code ends the doc part when using new sentinels.</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">at</span><span class="o">.</span><span class="n">readVersion5</span> <span class="ow">and</span> <span class="n">s2</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@c&#39;</span><span class="p">)</span> <span class="ow">and</span>
            <span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;@c&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;@code&#39;</span><span class="p">))</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">docOut</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">docOut</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">massageAtDocPart</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="c"># 2011/05/24</span>
                <span class="n">at</span><span class="o">.</span><span class="n">appendToOut</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="n">at</span><span class="o">.</span><span class="n">docOut</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">at</span><span class="o">.</span><span class="n">inCode</span> <span class="o">=</span> <span class="bp">True</span> <span class="c"># End the doc part.</span>

        <span class="n">at</span><span class="o">.</span><span class="n">appendToOut</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20041005105605.109: *6* at.readNl</span>
    <span class="k">def</span> <span class="nf">readNl</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.readNl"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.readNl">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Handle an @nonl sentinel.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;nl&quot;</span><span class="p">),</span><span class="s">&#39;missing nl sentinel&#39;</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">inCode</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">appendToOut</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">docOut</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20041005105605.110: *6* at.readNonl</span>
    <span class="k">def</span> <span class="nf">readNonl</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.readNonl"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.readNonl">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Handle an @nonl sentinel.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;nonl&quot;</span><span class="p">),</span><span class="s">&#39;missing nonl sentinel&#39;</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">inCode</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">out</span><span class="p">)</span>
            <span class="c"># 2010/01/07: protect against a mostly-harmless read error.</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">:</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="c"># Do not use at.appendToOut here!</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&quot;out:&quot;</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">readError</span><span class="p">(</span><span class="s">&quot;unexpected @nonl directive in code part&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">pending</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">:</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">pending</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&quot;docOut:&quot;</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">readError</span><span class="p">(</span><span class="s">&quot;unexpected @nonl directive in pending doc part&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">docOut</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">s</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">:</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">docOut</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&quot;docOut:&quot;</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">readError</span><span class="p">(</span><span class="s">&quot;unexpected @nonl directive in doc part&quot;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20041005105605.112: *6* at.readVerbatim</span>
    <span class="k">def</span> <span class="nf">readVerbatim</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.readVerbatim"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.readVerbatim">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Read an @verbatim sentinel.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;verbatim&quot;</span><span class="p">),</span><span class="s">&#39;missing verbatim sentinel&#39;</span>

        <span class="c"># Append the next line to the text.</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">readLine</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">inputFile</span><span class="p">)</span> 
        <span class="n">i</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">skipIndent</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">indent</span><span class="p">)</span>
        <span class="c"># Do **not** insert the verbatim line itself!</span>
            <span class="c"># at.appendToOut(&quot;@verbatim\n&quot;)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">appendToOut</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:])</span>
    <span class="c">#@+node:ekr.20041005105605.113: *5* at.badEndSentinel, popSentinelStack</span>
    <span class="k">def</span> <span class="nf">badEndSentinel</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">expectedKind</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.badEndSentinel"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.badEndSentinel">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Handle a mismatched ending sentinel.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">assert</span> <span class="n">at</span><span class="o">.</span><span class="n">endSentinelStack</span><span class="p">,</span><span class="s">&#39;empty sentinel stack&#39;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;(badEndSentinel) Ignoring </span><span class="si">%s</span><span class="s"> sentinel.  Expecting </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">at</span><span class="o">.</span><span class="n">sentinelName</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">endSentinelStack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
            <span class="n">at</span><span class="o">.</span><span class="n">sentinelName</span><span class="p">(</span><span class="n">expectedKind</span><span class="p">))</span>
        <span class="n">at</span><span class="o">.</span><span class="n">readError</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">popSentinelStack</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">expectedKind</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.popSentinelStack"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.popSentinelStack">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Pop an entry from endSentinelStack and check it.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">endSentinelStack</span> <span class="ow">and</span> <span class="n">at</span><span class="o">.</span><span class="n">endSentinelStack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">expectedKind</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">endSentinelStack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">1</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="p">[</span><span class="n">at</span><span class="o">.</span><span class="n">sentinelName</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">at</span><span class="o">.</span><span class="n">endSentinelStack</span><span class="p">],</span>
                <span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">(</span><span class="mi">4</span><span class="p">)))</span>
            <span class="n">at</span><span class="o">.</span><span class="n">badEndSentinel</span><span class="p">(</span><span class="n">expectedKind</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20130121102851.10249: *5* at.changeLevel</span>
    <span class="c"># Called from various methods.</span>

    <span class="k">def</span> <span class="nf">changeLevel</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">oldLevel</span><span class="p">,</span><span class="n">newLevel</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.changeLevel"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.changeLevel">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Update data structures when changing node level.</span>

<span class="sd">        The key invariant: on exit, the top of at.thinNodeStack is the new parent node.&#39;&#39;&#39;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># Crucial: we must be using new-style sentinels.</span>
        <span class="k">assert</span> <span class="n">at</span><span class="o">.</span><span class="n">readVersion5</span><span class="p">,</span><span class="s">&#39;at.readVersion5&#39;</span>
        <span class="k">assert</span> <span class="n">at</span><span class="o">.</span><span class="n">thinFile</span><span class="p">,</span><span class="s">&#39;at.thinFile&#39;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">at</span><span class="o">.</span><span class="n">importing</span><span class="p">,</span><span class="s">&#39;not at.importing&#39;</span>

        <span class="k">if</span> <span class="n">newLevel</span> <span class="o">&gt;</span> <span class="n">oldLevel</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">newLevel</span> <span class="o">==</span> <span class="n">oldLevel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span><span class="s">&#39;newLevel == oldLevel + 1&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">oldLevel</span> <span class="o">&gt;</span> <span class="n">newLevel</span><span class="p">:</span>
                <span class="n">oldLevel</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">allow_cloned_sibs</span><span class="p">:</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">thinChildIndexStack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">at</span><span class="o">.</span><span class="n">indentStack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">at</span><span class="o">.</span><span class="n">thinNodeStack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">at</span><span class="o">.</span><span class="n">vStack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">assert</span> <span class="n">oldLevel</span> <span class="o">==</span> <span class="n">newLevel</span><span class="p">,</span><span class="s">&#39;oldLevel: </span><span class="si">%s</span><span class="s"> newLevel: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">oldLevel</span><span class="p">,</span><span class="n">newLevel</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">thinNodeStack</span><span class="p">)</span> <span class="o">==</span> <span class="n">newLevel</span><span class="p">,</span><span class="s">&#39;len(at.thinNodeStack) == newLevel&#39;</span>

        <span class="c"># The last node is the node at the top of the stack.</span>
        <span class="c"># This node will be the parent of any newly created node.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">lastThinNode</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">thinNodeStack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="c">#@+node:ekr.20110523201030.18288: *5* at.massageAtDocPart (new)</span>
    <span class="k">def</span> <span class="nf">massageAtDocPart</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.massageAtDocPart"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.massageAtDocPart">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Compute the final @doc part when block comments are used.&#39;&#39;&#39;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">endSentinelComment</span><span class="p">:</span>
            <span class="n">ok1</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">startSentinelComment</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="n">ok2</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">endSentinelComment</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ok1</span> <span class="ow">and</span> <span class="n">ok2</span><span class="p">:</span>
                <span class="n">n1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">startSentinelComment</span><span class="p">)</span>
                <span class="n">n2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">endSentinelComment</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">n1</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="p">(</span><span class="n">n2</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;invalid @doc part...</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>

        <span class="c"># g.trace(repr(s))</span>
        <span class="k">return</span> <span class="n">s</span>
    <span class="c">#@+node:ekr.20041005105605.114: *4* at.sentinelKind4 &amp; helper (read logic)</span>
    <span class="k">def</span> <span class="nf">sentinelKind4</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.sentinelKind4"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.sentinelKind4">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Return the kind of sentinel at s.&quot;&quot;&quot;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">val</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">sentinelKind4_helper</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="p">(</span><span class="n">verbose</span> <span class="ow">or</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">at</span><span class="o">.</span><span class="n">noSentinel</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%-20s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">at</span><span class="o">.</span><span class="n">sentinelName</span><span class="p">(</span><span class="n">val</span><span class="p">),</span><span class="n">s</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()))</span>

        <span class="k">return</span> <span class="n">val</span>
    <span class="c">#@+node:ekr.20100518083515.5896: *5* sentinelKind4_helper</span>
    <span class="k">def</span> <span class="nf">sentinelKind4_helper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.sentinelKind4_helper"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.sentinelKind4_helper">[docs]</a>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">startSentinelComment</span><span class="p">):</span> 
            <span class="n">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">startSentinelComment</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">at</span><span class="o">.</span><span class="n">noSentinel</span>

        <span class="c"># Locally undo cweb hack here</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">startSentinelComment</span>
        <span class="k">if</span> <span class="n">start</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">start</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;@&#39;</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;@@&#39;</span><span class="p">,</span><span class="s">&#39;@&#39;</span><span class="p">)</span>

        <span class="c"># New sentinels.</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;@+&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="s">&quot;others&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">at</span><span class="o">.</span><span class="n">startOthers</span>
            <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="s">&quot;&lt;&lt;&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">at</span><span class="o">.</span><span class="n">startRef</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="s">&quot;&lt;&lt;&quot;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">at</span><span class="o">.</span><span class="n">startRef</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;@-&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="s">&quot;others&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">at</span><span class="o">.</span><span class="n">endOthers</span>
            <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="s">&quot;&lt;&lt;&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">at</span><span class="o">.</span><span class="n">endRef</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="s">&quot;&lt;&lt;&quot;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">at</span><span class="o">.</span><span class="n">endRef</span>
        <span class="c"># Old sentinels.</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;@&quot;</span><span class="p">):</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="s">&quot;@+others&quot;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">at</span><span class="o">.</span><span class="n">startOthers</span>
                <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="s">&quot;@-others&quot;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">at</span><span class="o">.</span><span class="n">endOthers</span>
                <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="s">&quot;&lt;&lt;&quot;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">at</span><span class="o">.</span><span class="n">startRef</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># No other sentinels allow whitespace following the &#39;@&#39;</span>
                    <span class="k">return</span> <span class="n">at</span><span class="o">.</span><span class="n">noSentinel</span>

        <span class="c"># Do not skip whitespace here!</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;@&lt;&lt;&quot;</span><span class="p">):</span> <span class="k">return</span> <span class="n">at</span><span class="o">.</span><span class="n">startRef</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;@@&quot;</span><span class="p">):</span>   <span class="k">return</span> <span class="n">at</span><span class="o">.</span><span class="n">startDirective</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;@&#39;</span><span class="p">):</span> <span class="k">return</span> <span class="n">at</span><span class="o">.</span><span class="n">noSentinel</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="c"># start of lookup</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c"># skip the at sign.</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;+&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;-&#39;</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_c_id</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">at</span><span class="o">.</span><span class="n">sentinelDict</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">at</span><span class="o">.</span><span class="n">sentinelDict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">at</span><span class="o">.</span><span class="n">noSentinel</span>
    <span class="c">#@+node:ekr.20041005105605.115: *4* at.skipSentinelStart4</span>
    <span class="k">def</span> <span class="nf">skipSentinelStart4</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.skipSentinelStart4"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.skipSentinelStart4">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Skip the start of a sentinel.&quot;&quot;&quot;</span>

        <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">startSentinelComment</span>
        <span class="k">assert</span> <span class="n">start</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;skipSentinelStart4 1&#39;</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">start</span><span class="p">),</span><span class="s">&#39;skipSentinelStart4 2&#39;</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>

        <span class="c"># 7/8/02: Support for REM hack</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;@&#39;</span><span class="p">,</span><span class="s">&#39;skipSentinelStart4 3&#39;</span>
        <span class="k">return</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="c">#@+node:ekr.20041005105605.116: *3* Reading utils...</span>
    <span class="c">#@+node:ekr.20100625092449.5963: *4* at.appendToOut</span>
    <span class="k">def</span> <span class="nf">appendToOut</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.appendToOut"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.appendToOut">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Append s to at.out (old sentinels) or</span>
<span class="sd">           at.v.tempBodyList (new sentinels).&#39;&#39;&#39;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="n">at</span><span class="o">.</span><span class="n">readVersion5</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">readVersion5</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">at</span><span class="o">.</span><span class="n">v</span><span class="p">:</span> <span class="n">at</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">v</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="s">&quot;tempBodyList&quot;</span><span class="p">):</span>
                <span class="n">at</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">tempBodyList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">tempBodyList</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%4s</span><span class="s"> </span><span class="si">%25s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">inCode</span><span class="p">,</span><span class="s">&#39;code&#39;</span><span class="p">,</span><span class="s">&#39;doc&#39;</span><span class="p">),</span><span class="n">at</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
    <span class="c">#@+node:ekr.20050301105854: *4* at.copyAllTempBodyStringsToVnodes</span>
    <span class="k">def</span> <span class="nf">copyAllTempBodyStringsToVnodes</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">root</span><span class="p">,</span><span class="n">thinFile</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.copyAllTempBodyStringsToVnodes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.copyAllTempBodyStringsToVnodes">[docs]</a>
        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;*****&#39;</span><span class="p">,</span><span class="n">root</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">c</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">self_and_subtree</span><span class="p">():</span>
            <span class="n">hasList</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;tempBodyList&#39;</span><span class="p">)</span>
            <span class="n">hasString</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;tempBodyString&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">hasString</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">hasList</span><span class="p">:</span>
                <span class="k">continue</span> <span class="c"># Bug fix 2010/07/06: do nothing!</span>
            <span class="c"># Terminate the node if v.tempBodyList exists.</span>
            <span class="k">if</span> <span class="n">hasList</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">terminateNode</span><span class="p">(</span><span class="n">v</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
                    <span class="c"># Sets v.tempBodyString and clears v.tempBodyList.</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;tempBodyList&#39;</span><span class="p">),</span><span class="s">&#39;copyAllTempBodyStringsToVnodes 1&#39;</span>
                <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;tempBodyString&#39;</span><span class="p">),</span><span class="s">&#39;copyAllTempBodyStringsToVnodes 2&#39;</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">tempBodyString</span>
            <span class="nb">delattr</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;tempBodyString&#39;</span><span class="p">)</span> <span class="c"># essential.</span>
            <span class="n">old_body</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span>
            <span class="k">if</span> <span class="n">s</span> <span class="o">!=</span> <span class="n">old_body</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">thinFile</span><span class="p">:</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">setBodyString</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">isDirty</span><span class="p">():</span>
                        <span class="n">p</span><span class="o">.</span><span class="n">setAllAncestorAtFileNodesDirty</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">setBodyString</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">s</span><span class="p">)</span> <span class="c"># Sets c and p dirty.</span>

                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">isDirty</span><span class="p">():</span>
                    <span class="c"># New in Leo 4.3: support for mod_labels plugin:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">c</span><span class="o">.</span><span class="n">mod_label_controller</span><span class="o">.</span><span class="n">add_label</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="s">&quot;before change:&quot;</span><span class="p">,</span><span class="n">old_body</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="c"># This warning is given elsewhere.</span>
                    <span class="c"># g.warning(&quot;changed:&quot;,p.h)</span>
    <span class="c">#@+node:ekr.20041005105605.119: *4* at.createImportedNode</span>
    <span class="k">def</span> <span class="nf">createImportedNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">root</span><span class="p">,</span><span class="n">headline</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.createImportedNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.createImportedNode">[docs]</a>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">importRootSeen</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">insertAsLastChild</span><span class="p">()</span>
            <span class="n">p</span><span class="o">.</span><span class="n">initHeadString</span><span class="p">(</span><span class="n">headline</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Put the text into the already-existing root node.</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">root</span>
            <span class="n">at</span><span class="o">.</span><span class="n">importRootSeen</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">setVisited</span><span class="p">()</span> <span class="c"># Suppress warning about unvisited node.</span>
        <span class="k">return</span> <span class="n">p</span>
    <span class="c">#@+node:ekr.20041005105605.120: *4* at.parseLeoSentinel</span>
    <span class="k">def</span> <span class="nf">parseLeoSentinel</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.parseLeoSentinel"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.parseLeoSentinel">[docs]</a>
        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">c</span>
        <span class="n">new_df</span> <span class="o">=</span> <span class="bp">False</span> <span class="p">;</span> <span class="n">valid</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="s">&#39;&#39;</span> <span class="p">;</span> <span class="n">end</span> <span class="o">=</span> <span class="s">&#39;&#39;</span> <span class="p">;</span> <span class="n">isThinDerivedFile</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">encoding_tag</span> <span class="o">=</span> <span class="s">&quot;-encoding=&quot;</span>
        <span class="n">version_tag</span> <span class="o">=</span> <span class="s">&quot;-ver=&quot;</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="s">&quot;@+leo&quot;</span>
        <span class="n">thin_tag</span> <span class="o">=</span> <span class="s">&quot;-thin&quot;</span>
        <span class="c">#@+&lt;&lt; set the opening comment delim &gt;&gt;</span>
        <span class="c">#@+node:ekr.20041005105605.121: *5* &lt;&lt; set the opening comment delim &gt;&gt;</span>
        <span class="c"># s contains the tag</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

        <span class="c"># The opening comment delim is the initial non-tag</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">tag</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">is_nl</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;no opening delim&#39;</span><span class="p">)</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c">#@-&lt;&lt; set the opening comment delim &gt;&gt;</span>
        <span class="c">#@+&lt;&lt; make sure we have @+leo &gt;&gt;</span>
        <span class="c">#@+node:ekr.20041005105605.122: *5* &lt;&lt; make sure we have @+leo &gt;&gt;</span>
        <span class="c">#@+at</span>
        <span class="c"># REM hack: leading whitespace is significant before the</span>
        <span class="c"># @+leo. We do this so that sentinelKind need not skip</span>
        <span class="c"># whitespace following self.startSentinelComment. This is</span>
        <span class="c"># correct: we want to be as restrictive as possible about what</span>
        <span class="c"># is recognized as a sentinel. This minimizes false matches.</span>
        <span class="c">#@@c</span>

        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># Make leading whitespace significant.</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">tag</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;no @+leo&#39;</span><span class="p">)</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c">#@-&lt;&lt; make sure we have @+leo &gt;&gt;</span>
        <span class="c">#@+&lt;&lt; read optional version param &gt;&gt;</span>
        <span class="c">#@+node:ekr.20041005105605.123: *5* &lt;&lt; read optional version param &gt;&gt;</span>
        <span class="n">new_df</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">version_tag</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">new_df</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;not new_df&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">100</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">new_df</span><span class="p">:</span>
            <span class="c"># Pre Leo 4.4.1: Skip to the next minus sign or end-of-line.</span>
            <span class="c"># Leo 4.4.1 +:   Skip to next minus sign, end-of-line,</span>
            <span class="c">#                or non numeric character.</span>
            <span class="c"># This is required to handle trailing comment delims properly.</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">version_tag</span><span class="p">)</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;.&#39;</span> <span class="ow">or</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()):</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">at</span><span class="o">.</span><span class="n">readVersion</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">i</span><span class="p">]</span> <span class="c"># 2010/05/18.</span>
            <span class="n">at</span><span class="o">.</span><span class="n">readVersion5</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">readVersion</span> <span class="o">&gt;=</span> <span class="s">&#39;5&#39;</span>

            <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;no version&#39;</span><span class="p">)</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c">#@-&lt;&lt; read optional version param &gt;&gt;</span>
        <span class="c">#@+&lt;&lt; read optional thin param &gt;&gt;</span>
        <span class="c">#@+node:ekr.20041005105605.124: *5* &lt;&lt; read optional thin param &gt;&gt;</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">thin_tag</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
            <span class="n">isThinDerivedFile</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c">#@-&lt;&lt; read optional thin param &gt;&gt;</span>
        <span class="c">#@+&lt;&lt; read optional encoding param &gt;&gt;</span>
        <span class="c">#@+node:ekr.20041005105605.125: *5* &lt;&lt; read optional encoding param &gt;&gt;</span>
        <span class="c"># Set the default encoding</span>
        <span class="n">at</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">default_derived_file_encoding</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">encoding_tag</span><span class="p">):</span>
            <span class="c"># Read optional encoding param, e.g., -encoding=utf-8,</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">encoding_tag</span><span class="p">)</span>
            <span class="c"># Skip to the next end of the field.</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;,.&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c"># The encoding field was written by 4.2 or after:</span>
                <span class="n">encoding</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">2</span> <span class="c"># 6/8/04, 1/11/05 (was i = j + 1)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># The encoding field was written before 4.2.</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">encoding</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span> <span class="c"># 6/8/04</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">encoding</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="c"># g.trace(&quot;encoding:&quot;,encoding)</span>
            <span class="k">if</span> <span class="n">encoding</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isValidEncoding</span><span class="p">(</span><span class="n">encoding</span><span class="p">):</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">encoding</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&quot;bad encoding in derived file:&quot;</span><span class="p">,</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;no encoding&#39;</span><span class="p">)</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c">#@-&lt;&lt; read optional encoding param &gt;&gt;</span>
        <span class="c">#@+&lt;&lt; set the closing comment delim &gt;&gt;</span>
        <span class="c">#@+node:ekr.20041005105605.126: *5* &lt;&lt; set the closing comment delim &gt;&gt;</span>
        <span class="c"># The closing comment delim is the trailing non-whitespace.</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">is_ws</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">is_nl</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">i</span><span class="p">]</span>
        <span class="c">#@-&lt;&lt; set the closing comment delim &gt;&gt;</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;valid&#39;</span><span class="p">,</span><span class="n">valid</span><span class="p">,</span><span class="s">&#39;isThin&#39;</span><span class="p">,</span><span class="n">isThinDerivedFile</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">valid</span><span class="p">,</span><span class="n">new_df</span><span class="p">,</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">,</span><span class="n">isThinDerivedFile</span>
    <span class="c">#@+node:ekr.20041005105605.127: *4* at.readError</span>
    <span class="k">def</span> <span class="nf">readError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">message</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.readError"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.readError">[docs]</a>
        <span class="c"># This is useful now that we don&#39;t print the actual messages.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">printError</span><span class="p">(</span><span class="s">&quot;----- read error. line: </span><span class="si">%s</span><span class="s">, file: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lineNumber</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">targetFileName</span><span class="p">,))</span>

        <span class="c"># g.trace(self.root,g.callers())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="c"># Delete all of root&#39;s tree.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span>
            <span class="c"># 2010/10/22: the dirty bit gets cleared later, though.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">setOrphan</span><span class="p">()</span>

    <span class="c">#@+node:ekr.20041005105605.128: *4* at.readLine</span>
    <span class="k">def</span> <span class="nf">readLine</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">theFile</span><span class="p">,</span><span class="n">fileName</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.readLine"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.readLine">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Reads one line from file using the present encoding&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">readlineForceUnixNewline</span><span class="p">(</span><span class="n">theFile</span><span class="p">,</span><span class="n">fileName</span><span class="o">=</span><span class="n">fileName</span><span class="p">)</span> <span class="c"># calls theFile.readline</span>
        <span class="c"># g.trace(repr(s),g.callers(4))</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">u</span>
    <span class="c">#@+node:ekr.20041005105605.129: *4* at.scanHeader</span>
    <span class="k">def</span> <span class="nf">scanHeader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">theFile</span><span class="p">,</span><span class="n">fileName</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.scanHeader"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.scanHeader">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Scan the @+leo sentinel.</span>

<span class="sd">        Sets self.encoding, and self.start/endSentinelComment.</span>

<span class="sd">        Returns (firstLines,new_df,isThinDerivedFile) where:</span>
<span class="sd">        firstLines        contains all @first lines,</span>
<span class="sd">        new_df            is True if we are reading a new-format derived file.</span>
<span class="sd">        isThinDerivedFile is True if the file is an @thin file.&quot;&quot;&quot;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="c"># if trace: g.trace(&#39;=====&#39;,fileName)</span>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">firstLines</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># The lines before @+leo.</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="s">&quot;@+leo&quot;</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">;</span> <span class="n">new_df</span> <span class="o">=</span> <span class="bp">False</span> <span class="p">;</span> <span class="n">isThinDerivedFile</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c">#@+&lt;&lt; skip any non @+leo lines &gt;&gt;</span>
        <span class="c">#@+node:ekr.20041005105605.130: *5* &lt;&lt; skip any non @+leo lines &gt;&gt;</span>
        <span class="c">#@+at Queue up the lines before the @+leo.</span>
        <span class="c"># </span>
        <span class="c"># These will be used to add as parameters to the @first directives, if any.</span>
        <span class="c"># Empty lines are ignored (because empty @first directives are ignored).</span>
        <span class="c"># NOTE: the function now returns a list of the lines before @+leo.</span>
        <span class="c"># </span>
        <span class="c"># We can not call sentinelKind here because that depends on</span>
        <span class="c"># the comment delimiters we set here.</span>
        <span class="c"># </span>
        <span class="c"># at-first lines are written &quot;verbatim&quot;, so nothing more needs to be done!</span>
        <span class="c">#@@c</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">readLine</span><span class="p">(</span><span class="n">theFile</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="s">&#39;first line&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="k">break</span>
            <span class="n">firstLines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="c"># Queue the line</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">readLine</span><span class="p">(</span><span class="n">theFile</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="c">#@-&lt;&lt; skip any non @+leo lines &gt;&gt;</span>
        <span class="k">if</span> <span class="n">valid</span><span class="p">:</span>
            <span class="n">valid</span><span class="p">,</span><span class="n">new_df</span><span class="p">,</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">,</span><span class="n">isThinDerivedFile</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">parseLeoSentinel</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">valid</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">startSentinelComment</span> <span class="o">=</span> <span class="n">start</span>
            <span class="n">at</span><span class="o">.</span><span class="n">endSentinelComment</span> <span class="o">=</span> <span class="n">end</span>
            <span class="c"># g.trace(&#39;start&#39;,repr(start),&#39;end&#39;,repr(end))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;No @+leo sentinel in: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">fileName</span><span class="p">)</span>
        <span class="c"># g.trace(&quot;start,end&quot;,repr(at.startSentinelComment),repr(at.endSentinelComment))</span>
        <span class="c"># g.trace(fileName,firstLines)</span>
        <span class="k">return</span> <span class="n">firstLines</span><span class="p">,</span><span class="n">new_df</span><span class="p">,</span><span class="n">isThinDerivedFile</span>
    <span class="c">#@+node:ekr.20050103163224: *4* at.scanHeaderForThin (used by import code)</span>
    <span class="c"># Note: Import code uses this.</span>

    <span class="k">def</span> <span class="nf">scanHeaderForThin</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">theFile</span><span class="p">,</span><span class="n">fileName</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.scanHeaderForThin"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.scanHeaderForThin">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Scan the header of a derived file and return True if it is a thin file.</span>

<span class="sd">        N.B. We are not interested in @first lines, so any encoding will do.&#39;&#39;&#39;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># The encoding doesn&#39;t matter.  No error messages are given.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">default_derived_file_encoding</span>

        <span class="n">junk</span><span class="p">,</span><span class="n">junk</span><span class="p">,</span><span class="n">isThin</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">scanHeader</span><span class="p">(</span><span class="n">theFile</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">isThin</span>
    <span class="c">#@+node:ekr.20041005105605.131: *4* at.skipIndent</span>
    <span class="c"># Skip past whitespace equivalent to width spaces.</span>

    <span class="k">def</span> <span class="nf">skipIndent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">width</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.skipIndent"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.skipIndent">[docs]</a>
        <span class="n">ws</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">ws</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">:</span>
            <span class="k">if</span>   <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">:</span> <span class="n">ws</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tab_width</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">ws</span> <span class="o">%</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tab_width</span><span class="p">)))</span>
            <span class="k">elif</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39; &#39;</span><span class="p">:</span>  <span class="n">ws</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">break</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">i</span>
    <span class="c">#@+node:ekr.20100628072537.5814: *4* at.terminateNode &amp; helpers</span>
    <span class="k">def</span> <span class="nf">terminateNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">middle</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.terminateNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.terminateNode">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Set the body text of at.v, and issue warning if it has changed.</span>

<span class="sd">        This is called as follows:</span>

<span class="sd">        old sentinels: when handling a @-node sentinel.</span>
<span class="sd">        new sentinels: from the post-pass when v.tempBodyList exists.&#39;&#39;&#39;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="n">at</span><span class="o">.</span><span class="n">readVersion5</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">postPass</span> <span class="o">=</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
            <span class="c"># A little kludge: v is given only when this is called</span>
            <span class="c"># from copyAllTempBodyStringsToVnodes.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">v</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">readVersion5</span><span class="p">:</span>
            <span class="c"># A vital assertion.</span>
            <span class="c"># We must *never* terminate a node before the post pass.</span>
            <span class="k">assert</span> <span class="n">postPass</span><span class="p">,</span><span class="s">&#39;terminateNode&#39;</span>

        <span class="c"># Get the temp attributes.</span>
        <span class="c"># hasString  = hasattr(v,&#39;tempBodyString&#39;)</span>
        <span class="c"># tempString = hasString and v.tempBodyString or &#39;&#39;</span>
        <span class="n">hasList</span>    <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;tempBodyList&#39;</span><span class="p">)</span>
        <span class="n">tempList</span>   <span class="o">=</span> <span class="n">hasList</span> <span class="ow">and</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">tempBodyList</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>

        <span class="c"># Compute the new text.</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">readVersion5</span><span class="p">,</span><span class="n">tempList</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">out</span><span class="p">))</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicode</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%28s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">new</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">importing</span><span class="p">:</span>
            <span class="n">v</span><span class="o">.</span><span class="n">_bodyString</span> <span class="o">=</span> <span class="n">new</span> <span class="c"># Allowed use of _bodyString.</span>
        <span class="k">elif</span> <span class="n">middle</span><span class="p">:</span> 
            <span class="k">pass</span> <span class="c"># Middle sentinels never alter text.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">terminateBody</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">postPass</span><span class="p">)</span>

        <span class="c"># *Always delete tempBodyList.  Do not leave this lying around!</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;tempBodyList&#39;</span><span class="p">):</span> <span class="nb">delattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;tempBodyList&#39;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100628124907.5816: *5* at.indicateNodeChanged</span>
    <span class="k">def</span> <span class="nf">indicateNodeChanged</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">old</span><span class="p">,</span><span class="n">new</span><span class="p">,</span><span class="n">postPass</span><span class="p">,</span><span class="n">v</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.indicateNodeChanged"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.indicateNodeChanged">[docs]</a>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">c</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">perfectImportRoot</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">postPass</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">correctedLines</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">at</span><span class="o">.</span><span class="n">reportCorrection</span><span class="p">(</span><span class="n">old</span><span class="p">,</span><span class="n">new</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
                <span class="n">v</span><span class="o">.</span><span class="n">_bodyString</span> <span class="o">=</span> <span class="n">new</span> <span class="c"># Allowed use of _bodyString.</span>
                    <span class="c"># Just setting v.tempBodyString won&#39;t work here.</span>
                <span class="n">v</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span>
                    <span class="c"># Mark the node dirty. Ancestors will be marked dirty later.</span>
                <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Do nothing if only trailing whitespace is involved.</span>
            <span class="k">if</span> <span class="n">new</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">old</span> <span class="o">==</span> <span class="n">new</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span> <span class="k">return</span>
            <span class="k">if</span> <span class="n">old</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">new</span> <span class="o">==</span> <span class="n">old</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span> <span class="k">return</span>
            <span class="c"># if old == new.rstrip(): return</span>
            <span class="c"># if new == old.rstrip(): return</span>

            <span class="n">c</span><span class="o">.</span><span class="n">nodeConflictList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">bunch</span><span class="p">(</span>
                <span class="n">tag</span><span class="o">=</span><span class="s">&#39;(uncached)&#39;</span><span class="p">,</span>
                <span class="n">gnx</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">gnx</span><span class="p">,</span>
                <span class="n">fileName</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">h</span><span class="p">,</span>
                <span class="n">b_old</span><span class="o">=</span><span class="n">old</span><span class="p">,</span>
                <span class="n">b_new</span><span class="o">=</span><span class="n">new</span><span class="p">,</span>
                <span class="n">h_old</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">_headString</span><span class="p">,</span>
                <span class="n">h_new</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">_headString</span><span class="p">,</span>
            <span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;uncached read node changed&quot;</span><span class="p">,</span><span class="n">v</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

            <span class="n">v</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span>
                <span class="c"># Just set the dirty bit. Ancestors will be marked dirty later.</span>
            <span class="n">c</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="c"># Important: the dirty bits won&#39;t stick unless we set c.changed here.</span>
                <span class="c"># Do *not* call c.setChanged(True) here: that would be too slow.</span>
    <span class="c">#@+node:ekr.20100628124907.5818: *5* at.reportCorrection</span>
    <span class="k">def</span> <span class="nf">reportCorrection</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">old</span><span class="p">,</span><span class="n">new</span><span class="p">,</span><span class="n">v</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.reportCorrection"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.reportCorrection">[docs]</a>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">found</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">at</span><span class="o">.</span><span class="n">perfectImportRoot</span><span class="o">.</span><span class="n">self_and_subtree</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="o">==</span> <span class="n">v</span><span class="p">:</span>
                <span class="n">found</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">;</span> <span class="k">break</span>

        <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># For debugging.</span>
                <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;old&quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">old</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">old</span><span class="p">):</span>
                    <span class="c">#line = line.replace(&#39; &#39;,&#39;&lt; &gt;&#39;).replace(&#39;\t&#39;,&#39;&lt;TAB&gt;&#39;)</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="p">)))</span>
                <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;new&quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">new</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">new</span><span class="p">):</span>
                    <span class="c">#line = line.replace(&#39; &#39;,&#39;&lt; &gt;&#39;).replace(&#39;\t&#39;,&#39;&lt;TAB&gt;&#39;)</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="p">)))</span>
                <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># This should never happen.</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;correcting hidden node: v=&quot;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20100702062857.5824: *5* at.terminateBody</span>
    <span class="k">def</span> <span class="nf">terminateBody</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">postPass</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.terminateBody"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.terminateBody">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Terminate the scanning of body text for node v.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">hasString</span>  <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;tempBodyString&#39;</span><span class="p">)</span>
        <span class="n">hasList</span>    <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;tempBodyList&#39;</span><span class="p">)</span>
        <span class="n">tempString</span> <span class="o">=</span> <span class="n">hasString</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">tempBodyString</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
        <span class="n">tempList</span>   <span class="o">=</span> <span class="n">hasList</span> <span class="ow">and</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">tempBodyList</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>

        <span class="c"># The old temp text is *always* in tempBodyString.</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">readVersion5</span><span class="p">,</span><span class="n">tempList</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">out</span><span class="p">))</span>
        <span class="n">new</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicode</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
        <span class="n">old</span> <span class="o">=</span> <span class="n">tempString</span> <span class="ow">or</span> <span class="n">v</span><span class="o">.</span><span class="n">getBody</span><span class="p">()</span>
            <span class="c"># v.getBody returns v._bodyString.</span>

        <span class="c"># Warn if the body text has changed.</span>
        <span class="c"># Don&#39;t warn about the root node.</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">!=</span> <span class="n">at</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">v</span> <span class="ow">and</span> <span class="n">old</span> <span class="o">!=</span> <span class="n">new</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">postPass</span><span class="p">:</span>
                <span class="n">warn</span> <span class="o">=</span> <span class="n">old</span> <span class="c"># The previous text must exist.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warn</span> <span class="o">=</span> <span class="n">old</span> <span class="ow">and</span> <span class="n">new</span> <span class="c"># Both must exit.</span>
            <span class="k">if</span> <span class="n">warn</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">indicateNodeChanged</span><span class="p">(</span><span class="n">old</span><span class="p">,</span><span class="n">new</span><span class="p">,</span><span class="n">postPass</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>

        <span class="c"># *Always* put the new text into tempBodyString.</span>
        <span class="n">v</span><span class="o">.</span><span class="n">tempBodyString</span> <span class="o">=</span> <span class="n">new</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
            <span class="n">v</span><span class="o">.</span><span class="n">gnx</span><span class="p">,</span>
            <span class="s">&#39;tempString </span><span class="si">%3s</span><span class="s"> getBody </span><span class="si">%3s</span><span class="s"> old </span><span class="si">%3s</span><span class="s"> new </span><span class="si">%3s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">tempString</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">getBody</span><span class="p">()),</span><span class="nb">len</span><span class="p">(</span><span class="n">old</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">new</span><span class="p">)),</span>
            <span class="n">v</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
            <span class="c"># &#39;\n* callers&#39;,g.callers(4))</span>

        <span class="c"># *Always delete tempBodyList.  Do not leave this lying around!</span>
        <span class="k">if</span> <span class="n">hasList</span><span class="p">:</span> <span class="nb">delattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;tempBodyList&#39;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20041005105605.132: ** at.Writing</span>
    <span class="c">#@+node:ekr.20041005105605.133: *3* Writing (top level)</span>
    <span class="c">#@+node:ekr.20041005105605.154: *4* at.asisWrite</span>
    <span class="k">def</span> <span class="nf">asisWrite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">root</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.asisWrite"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.asisWrite">[docs]</a>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">c</span>
        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span> <span class="c"># Capture the current headline.</span>
        <span class="n">c</span><span class="o">.</span><span class="n">init_error_dialogs</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># Note: @asis always writes all nodes,</span>
            <span class="c"># so there can be no orphan or ignored nodes.</span>
            <span class="n">targetFileName</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">atAsisFileNodeName</span><span class="p">()</span>
            <span class="n">at</span><span class="o">.</span><span class="n">initWriteIvars</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">targetFileName</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="n">toString</span><span class="p">)</span>
            <span class="c"># &quot;look ahead&quot; computation of eventual fileName.</span>
            <span class="n">eventualFileName</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span>
                <span class="n">at</span><span class="o">.</span><span class="n">default_directory</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">targetFileName</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">shouldPromptForDangerousWrite</span><span class="p">(</span><span class="n">eventualFileName</span><span class="p">,</span><span class="n">root</span><span class="p">):</span>
                <span class="c"># Prompt if writing a new @asis node would overwrite the existing file.</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">promptForDangerousWrite</span><span class="p">(</span><span class="n">eventualFileName</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;@asis&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                    <span class="c"># Fix bug 889175: Remember the full fileName.</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">rememberReadPath</span><span class="p">(</span><span class="n">eventualFileName</span><span class="p">,</span><span class="n">root</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;not written:&quot;</span><span class="p">,</span><span class="n">eventualFileName</span><span class="p">)</span>
                    <span class="k">return</span>
            <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span> <span class="k">return</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">at</span><span class="o">.</span><span class="n">openFileForWriting</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">targetFileName</span><span class="p">,</span><span class="n">toString</span><span class="p">):</span>
                <span class="c"># openFileForWriting calls root.setDirty() if there are errors.</span>
                <span class="k">return</span>

            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">self_and_subtree</span><span class="p">():</span>
                <span class="c">#@+&lt;&lt; Write p&#39;s headline if it starts with @@ &gt;&gt;</span>
                <span class="c">#@+node:ekr.20041005105605.155: *5* &lt;&lt; Write p&#39;s headline if it starts with @@ &gt;&gt;</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span>

                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;@@&quot;</span><span class="p">):</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
                    <span class="k">if</span> <span class="n">s</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c"># at.outputFile is a fileLikeObject.</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span><span class="n">reportErrors</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                        <span class="n">at</span><span class="o">.</span><span class="n">outputFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="c">#@-&lt;&lt; Write p&#39;s headline if it starts with @@ &gt;&gt;</span>
                <span class="c">#@+&lt;&lt; Write p&#39;s body &gt;&gt;</span>
                <span class="c">#@+node:ekr.20041005105605.156: *5* &lt;&lt; Write p&#39;s body &gt;&gt;</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span>

                <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span><span class="n">reportErrors</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="c"># 3/7/03</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">outputStringWithLineEndings</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="c">#@-&lt;&lt; Write p&#39;s body &gt;&gt;</span>
            <span class="n">at</span><span class="o">.</span><span class="n">closeWriteFile</span><span class="p">()</span>
            <span class="n">at</span><span class="o">.</span><span class="n">replaceTargetFileIfDifferent</span><span class="p">(</span><span class="n">root</span><span class="p">)</span> <span class="c"># Sets/clears dirty and orphan bits.</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">writeException</span><span class="p">(</span><span class="n">root</span><span class="p">)</span> <span class="c"># Sets dirty and orphan bits.</span>

    <span class="n">silentWrite</span> <span class="o">=</span> <span class="n">asisWrite</span> <span class="c"># Compatibility with old scripts.</span></div>
    <span class="c">#@+node:ekr.20041005105605.142: *4* at.openFileForWriting &amp; helper</span>
    <span class="k">def</span> <span class="nf">openFileForWriting</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">root</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span><span class="n">toString</span><span class="p">):</span>
<div class="viewcode-block" id="atFile.openFileForWriting"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.openFileForWriting">[docs]</a>
        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">at</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">toString</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">shortFileName</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">outputFileName</span> <span class="o">=</span> <span class="s">&quot;&lt;string: </span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="n">at</span><span class="o">.</span><span class="n">shortFileName</span>
            <span class="n">at</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">fileLikeObject</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">openFileForWritingHelper</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>

            <span class="c"># New in Leo 4.4.8: set dirty bit if there are errors.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span> <span class="n">at</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;root&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">root</span> <span class="ow">and</span> <span class="n">root</span><span class="o">.</span><span class="n">h</span><span class="p">),</span><span class="s">&#39;outputFile&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">outputFile</span><span class="p">))</span>

        <span class="c"># New in 4.3 b2: root may be none when writing from a string.</span>
        <span class="k">if</span> <span class="n">root</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">outputFile</span><span class="p">:</span>
                <span class="n">root</span><span class="o">.</span><span class="n">clearOrphan</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">root</span><span class="o">.</span><span class="n">setOrphan</span><span class="p">()</span>
                <span class="n">root</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">at</span><span class="o">.</span><span class="n">outputFile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20041005105605.143: *5* at.openFileForWritingHelper &amp; helper</span>
    <span class="k">def</span> <span class="nf">openFileForWritingHelper</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.openFileForWritingHelper"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.openFileForWritingHelper">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Open the file and return True if all went well.&#39;&#39;&#39;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">c</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">shortFileName</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">targetFileName</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">default_directory</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_dirname</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">targetFileName</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">makeAllNonExistentDirectories</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_dirname</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">targetFileName</span><span class="p">)</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">writeError</span><span class="p">(</span><span class="s">&quot;path does not exist: &quot;</span> <span class="o">+</span> <span class="n">path</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">False</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&quot;exception creating path: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">targetFileName</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">targetFileName</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="p">):</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">writeError</span><span class="p">(</span><span class="s">&quot;can not open: read only: &quot;</span> <span class="o">+</span> <span class="n">at</span><span class="o">.</span><span class="n">targetFileName</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">False</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span> <span class="c"># os.access() may not exist on all platforms.</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">outputFileName</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">targetFileName</span> <span class="o">+</span> <span class="s">&quot;.tmp&quot;</span>
            <span class="n">kind</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">openForWrite</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">outputFileName</span><span class="p">,</span><span class="s">&#39;wb&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">at</span><span class="o">.</span><span class="n">outputFile</span><span class="p">:</span>
                <span class="n">kind</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">kind</span><span class="o">==</span><span class="s">&#39;check&#39;</span><span class="p">,</span>
                    <span class="s">&#39;did not overwrite&#39;</span><span class="p">,</span><span class="s">&#39;can not create&#39;</span><span class="p">)</span>
                <span class="n">at</span><span class="o">.</span><span class="n">writeError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kind</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">outputFileName</span><span class="p">))</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&quot;exception creating:&quot;</span> <span class="o">+</span> <span class="n">at</span><span class="o">.</span><span class="n">outputFileName</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">return</span> <span class="bp">True</span>
    <span class="c">#@+node:bwmulder.20050101094804: *6* at.openForWrite</span>
    <span class="k">def</span> <span class="nf">openForWrite</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">wb</span><span class="o">=</span><span class="s">&#39;wb&#39;</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.openForWrite"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.openForWrite">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Open a file for writes, handling shadow files.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">shadowController</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c"># 2011/10/11: in &quot;quick edit/save&quot; mode the .leo file may not have a name.</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">fileName</span><span class="p">():</span>
                <span class="n">shadow_filename</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shadowPathName</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writing_to_shadow_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">shadow_filename</span><span class="p">)</span>
                <span class="n">open_file_name</span>       <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">writing_to_shadow_directory</span><span class="p">,</span><span class="n">shadow_filename</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shadow_filename</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">writing_to_shadow_directory</span><span class="p">,</span><span class="n">shadow_filename</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writing_to_shadow_directory</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">open_file_name</span> <span class="o">=</span> <span class="n">filename</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">writing_to_shadow_directory</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">shadow_filename</span><span class="p">)</span>
                <span class="n">x</span><span class="o">.</span><span class="n">message</span><span class="p">(</span><span class="s">&#39;writing </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">shadow_filename</span><span class="p">)</span>
                <span class="k">return</span> <span class="s">&#39;shadow&#39;</span><span class="p">,</span><span class="nb">open</span><span class="p">(</span><span class="n">open_file_name</span><span class="p">,</span><span class="n">wb</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">checkFileTimeStamp</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">targetFileName</span><span class="p">)</span>
                <span class="k">return</span> <span class="s">&#39;check&#39;</span><span class="p">,</span><span class="n">ok</span> <span class="ow">and</span> <span class="nb">open</span><span class="p">(</span><span class="n">open_file_name</span><span class="p">,</span><span class="n">wb</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;openForWrite: exception opening file: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">open_file_name</span><span class="p">))</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
            <span class="k">return</span> <span class="s">&#39;error&#39;</span><span class="p">,</span><span class="bp">None</span>
    <span class="c">#@+node:ekr.20041005105605.144: *4* at.write &amp; helper</span>
    <span class="k">def</span> <span class="nf">write</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">root</span><span class="p">,</span></div>
<div class="viewcode-block" id="atFile.write"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.write">[docs]</a>        <span class="n">kind</span> <span class="o">=</span> <span class="s">&#39;@unknown&#39;</span><span class="p">,</span> <span class="c"># Should not happen.</span>
        <span class="n">nosentinels</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">perfectImportFlag</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">scriptWrite</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">thinFile</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">toString</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write a 4.x derived file.</span>
<span class="sd">        root is the position of an @&lt;file&gt; node&quot;&quot;&quot;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">c</span>
        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span> <span class="c"># Capture the current headline.</span>

        <span class="c">#@+&lt;&lt; set at.targetFileName &gt;&gt;</span>
        <span class="c">#@+node:ekr.20041005105605.145: *5* &lt;&lt; set at.targetFileName &gt;&gt;</span>
        <span class="k">if</span> <span class="n">toString</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">targetFileName</span> <span class="o">=</span> <span class="s">&quot;&lt;string-file&gt;&quot;</span>
        <span class="k">elif</span> <span class="n">nosentinels</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">targetFileName</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">atNoSentFileNodeName</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">thinFile</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">targetFileName</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">atThinFileNodeName</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">at</span><span class="o">.</span><span class="n">targetFileName</span><span class="p">:</span>
                <span class="c"># We have an @file node.</span>
                <span class="n">at</span><span class="o">.</span><span class="n">targetFileName</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">atFileNodeName</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">targetFileName</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">atFileNodeName</span><span class="p">()</span>
        <span class="c">#@-&lt;&lt; set at.targetFileName &gt;&gt;</span>
        <span class="n">at</span><span class="o">.</span><span class="n">initWriteIvars</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">targetFileName</span><span class="p">,</span>
            <span class="n">perfectImportFlag</span> <span class="o">=</span> <span class="n">perfectImportFlag</span><span class="p">,</span>
            <span class="n">nosentinels</span> <span class="o">=</span> <span class="n">nosentinels</span><span class="p">,</span>
            <span class="n">thinFile</span> <span class="o">=</span> <span class="n">thinFile</span><span class="p">,</span>
            <span class="n">scriptWrite</span> <span class="o">=</span> <span class="n">scriptWrite</span><span class="p">,</span>
            <span class="n">toString</span> <span class="o">=</span> <span class="n">toString</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c"># &quot;look ahead&quot; computation of eventual fileName.</span>
        <span class="n">eventualFileName</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span>
            <span class="n">at</span><span class="o">.</span><span class="n">default_directory</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">targetFileName</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;default_dir&#39;</span><span class="p">,</span>
                <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">default_directory</span><span class="p">),</span>
                <span class="n">at</span><span class="o">.</span><span class="n">default_directory</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;eventual_fn&#39;</span><span class="p">,</span><span class="n">eventualFileName</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">scriptWrite</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">toString</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">shouldPromptForDangerousWrite</span><span class="p">(</span><span class="n">eventualFileName</span><span class="p">,</span><span class="n">root</span><span class="p">):</span>
                <span class="c"># Prompt if writing a new @file or @thin node would</span>
                <span class="c"># overwrite an existing file.</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">promptForDangerousWrite</span><span class="p">(</span><span class="n">eventualFileName</span><span class="p">,</span><span class="n">kind</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">rememberReadPath</span><span class="p">(</span><span class="n">eventualFileName</span><span class="p">,</span><span class="n">root</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;not written:&quot;</span><span class="p">,</span><span class="n">eventualFileName</span><span class="p">)</span>
                    <span class="c">#@+&lt;&lt; set dirty and orphan bits &gt;&gt;</span>
                    <span class="c">#@+node:ekr.20041005105605.146: *5* &lt;&lt; set dirty and orphan bits &gt;&gt;</span>
                    <span class="c"># Setting the orphan and dirty flags tells Leo to write the tree..</span>
                    <span class="n">root</span><span class="o">.</span><span class="n">setOrphan</span><span class="p">()</span>
                    <span class="n">root</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span>
                    <span class="c"># Delete the temp file.</span>
                    <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">outputFileName</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">outputFileName</span><span class="p">)</span> 

                    <span class="c">#@-&lt;&lt; set dirty and orphan bits &gt;&gt;</span>
                    <span class="c">#@afterref</span>
 <span class="c"># 2010/10/21.</span>
                    <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">at</span><span class="o">.</span><span class="n">openFileForWriting</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">targetFileName</span><span class="p">,</span><span class="n">toString</span><span class="p">):</span>
            <span class="c"># openFileForWriting calls root.setDirty() if there are errors.</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;open failed&#39;</span><span class="p">,</span><span class="n">eventualFileName</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">writeOpenFile</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">nosentinels</span><span class="o">=</span><span class="n">nosentinels</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="n">toString</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">root</span><span class="o">==</span><span class="n">at</span><span class="o">.</span><span class="n">root</span><span class="p">,</span><span class="s">&#39;write&#39;</span>
            <span class="k">if</span> <span class="n">toString</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">closeWriteFile</span><span class="p">()</span> <span class="c"># sets self.stringOutput</span>
                <span class="c"># Major bug: failure to clear this wipes out headlines!</span>
                <span class="c"># Minor bug: sometimes this causes slight problems...</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;tnodeList&#39;</span><span class="p">):</span>
                    <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;tnodeList&#39;</span><span class="p">)</span>
                <span class="n">root</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">_p_changed</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">closeWriteFile</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">errors</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">root</span><span class="o">.</span><span class="n">isOrphan</span><span class="p">():</span>
                    <span class="c">#@+&lt;&lt; set dirty and orphan bits &gt;&gt;</span>
                    <span class="c">#@+node:ekr.20041005105605.146: *5* &lt;&lt; set dirty and orphan bits &gt;&gt;</span>
                    <span class="c"># Setting the orphan and dirty flags tells Leo to write the tree..</span>
                    <span class="n">root</span><span class="o">.</span><span class="n">setOrphan</span><span class="p">()</span>
                    <span class="n">root</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span>
                    <span class="c"># Delete the temp file.</span>
                    <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">outputFileName</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">outputFileName</span><span class="p">)</span> 

                    <span class="c">#@-&lt;&lt; set dirty and orphan bits &gt;&gt;</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;not written:&quot;</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">outputFileName</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># Fix bug 889175: Remember the full fileName.</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">rememberReadPath</span><span class="p">(</span><span class="n">eventualFileName</span><span class="p">,</span><span class="n">root</span><span class="p">)</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">replaceTargetFileIfDifferent</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
                        <span class="c"># Sets/clears dirty and orphan bits.</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;tnodeList&#39;</span><span class="p">):</span>
                <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;tnodeList&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">toString</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&quot;exception preprocessing script&quot;</span><span class="p">)</span>
                <span class="n">root</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">_p_changed</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">writeException</span><span class="p">()</span> <span class="c"># Sets dirty and orphan bits.</span>
    <span class="c">#@+node:ekr.20041005105605.147: *4* at.writeAll &amp; helper</span>
    <span class="k">def</span> <span class="nf">writeAll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span></div>
<div class="viewcode-block" id="atFile.writeAll"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.writeAll">[docs]</a>        <span class="n">writeAtFileNodesFlag</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">writeDirtyAtFileNodesFlag</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">toString</span><span class="o">=</span><span class="bp">False</span>
    <span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Write @file nodes in all or part of the outline&quot;&quot;&quot;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">c</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">scanAtPathDirectivesCount</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">scanAtPathDirectivesCount</span>
        <span class="n">writtenFiles</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># Files that might be written again.</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">writeAtFileNodesFlag</span>

        <span class="k">if</span> <span class="n">writeAtFileNodesFlag</span><span class="p">:</span>
            <span class="c"># The Write @&lt;file&gt; Nodes command.</span>
            <span class="c"># Write all nodes in the selected tree.</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
            <span class="n">after</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">nodeAfterTree</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Write dirty nodes in the entire outline.</span>
            <span class="n">p</span> <span class="o">=</span>  <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span>
            <span class="n">after</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">nullPosition</span><span class="p">()</span>

        <span class="n">at</span><span class="o">.</span><span class="n">clearAllOrphanBits</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">after</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtIgnoreNode</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtAsisFileNode</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isAnyAtFileNode</span><span class="p">()</span> <span class="p">:</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">ignored_at_file_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
                <span class="c"># Note: @ignore not honored in @asis nodes.</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span> <span class="c"># 2011/10/08: Honor @ignore!</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">isAnyAtFileNode</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeAllHelper</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">force</span><span class="p">,</span><span class="n">toString</span><span class="p">,</span><span class="n">writeAtFileNodesFlag</span><span class="p">,</span><span class="n">writtenFiles</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>

        <span class="c">#@+&lt;&lt; say the command is finished &gt;&gt;</span>
        <span class="c">#@+node:ekr.20041005105605.150: *5* &lt;&lt; say the command is finished &gt;&gt;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">writeAtFileNodesFlag</span> <span class="ow">or</span> <span class="n">writeDirtyAtFileNodesFlag</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">writtenFiles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;finished&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">writeAtFileNodesFlag</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;no @&lt;file&gt; nodes in the selected tree&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;no dirty @&lt;file&gt; nodes&quot;</span><span class="p">)</span>
        <span class="c">#@-&lt;&lt; say the command is finished &gt;&gt;</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> calls to c.scanAtPathDirectives()&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">c</span><span class="o">.</span><span class="n">scanAtPathDirectivesCount</span><span class="o">-</span><span class="n">scanAtPathDirectivesCount</span><span class="p">))</span>

    <span class="c">#@+node:ekr.20041005105605.148: *5* at.clearAllOrphanBits</span>
    <span class="k">def</span> <span class="nf">clearAllOrphanBits</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.clearAllOrphanBits"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.clearAllOrphanBits">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Clear orphan bits for all nodes *except* orphan @file nodes.&#39;&#39;&#39;</span>

        <span class="c"># 2011/06/15: Important bug fix: retain orphan bits for @file nodes.</span>
        <span class="k">for</span> <span class="n">p2</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">self_and_subtree</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p2</span><span class="o">.</span><span class="n">isOrphan</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">p2</span><span class="o">.</span><span class="n">isAnyAtFileNode</span><span class="p">():</span>
                    <span class="c"># g.trace(&#39;*** retaining orphan bit&#39;,p2.h)</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">p2</span><span class="o">.</span><span class="n">clearOrphan</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20041005105605.149: *5* at.writeAllHelper</span>
    <span class="k">def</span> <span class="nf">writeAllHelper</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span></div>
<div class="viewcode-block" id="atFile.writeAllHelper"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.writeAllHelper">[docs]</a>        <span class="n">force</span><span class="p">,</span><span class="n">toString</span><span class="p">,</span><span class="n">writeAtFileNodesFlag</span><span class="p">,</span><span class="n">writtenFiles</span>
    <span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">c</span>

        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtIgnoreNode</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtAsisFileNode</span><span class="p">():</span>
            <span class="n">pathChanged</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">oldPath</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">getPathUa</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">newPath</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">fullPath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">pathChanged</span> <span class="o">=</span> <span class="n">oldPath</span> <span class="ow">and</span> <span class="n">oldPath</span> <span class="o">!=</span> <span class="n">newPath</span>
            <span class="c"># 2010/01/27: suppress this message during save-as and save-to commands.</span>
            <span class="k">if</span> <span class="n">pathChanged</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">ignoreChangedPaths</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">setPathUa</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">newPath</span><span class="p">)</span> <span class="c"># Remember that we have changed paths.</span>
                <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;path changed for&#39;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;p </span><span class="si">%s</span><span class="se">\n</span><span class="s">oldPath </span><span class="si">%s</span><span class="se">\n</span><span class="s">newPath </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">oldPath</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">newPath</span><span class="p">)))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">isDirty</span><span class="p">()</span> <span class="ow">or</span>
            <span class="c"># p.v.isOrphan() or # 2011/06/17.</span>
            <span class="n">pathChanged</span> <span class="ow">or</span>
            <span class="n">writeAtFileNodesFlag</span> <span class="ow">or</span>
            <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="ow">in</span> <span class="n">writtenFiles</span>
        <span class="p">):</span>

            <span class="c"># Tricky: @ignore not recognised in @asis nodes.</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtAsisFileNode</span><span class="p">():</span>
                <span class="n">at</span><span class="o">.</span><span class="n">asisWrite</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="n">toString</span><span class="p">)</span>
                <span class="n">writtenFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtIgnoreNode</span><span class="p">():</span>
                <span class="k">pass</span> <span class="c"># Handled in caller.</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtAutoNode</span><span class="p">():</span>
                <span class="n">at</span><span class="o">.</span><span class="n">writeOneAtAutoNode</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="n">toString</span><span class="p">,</span><span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>
                <span class="n">writtenFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtEditNode</span><span class="p">():</span>
                <span class="n">at</span><span class="o">.</span><span class="n">writeOneAtEditNode</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="n">toString</span><span class="p">)</span>
                <span class="n">writtenFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtNoSentFileNode</span><span class="p">():</span>
                <span class="n">at</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;@nosent&#39;</span><span class="p">,</span><span class="n">nosentinels</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="n">toString</span><span class="p">)</span>
                <span class="n">writtenFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtShadowFileNode</span><span class="p">():</span>
                <span class="n">at</span><span class="o">.</span><span class="n">writeOneAtShadowNode</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="n">toString</span><span class="p">,</span><span class="n">force</span><span class="o">=</span><span class="n">force</span> <span class="ow">or</span> <span class="n">pathChanged</span><span class="p">)</span>
                <span class="n">writtenFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtThinFileNode</span><span class="p">():</span>
                <span class="n">at</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;@thin&#39;</span><span class="p">,</span><span class="n">thinFile</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="n">toString</span><span class="p">)</span>
                <span class="n">writtenFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtFileNode</span><span class="p">():</span>
                <span class="c"># Write old @file nodes using @thin format.</span>
                <span class="n">at</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;@file&#39;</span><span class="p">,</span><span class="n">thinFile</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="n">toString</span><span class="p">)</span>
                <span class="n">writtenFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20070806105859: *4* at.writeAtAutoNodes &amp; writeDirtyAtAutoNodes &amp; helpers</span>
    <span class="k">def</span> <span class="nf">writeAtAutoNodes</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.writeAtAutoNodes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.writeAtAutoNodes">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Write all @auto nodes in the selected outline.&#39;&#39;&#39;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">c</span>
        <span class="n">c</span><span class="o">.</span><span class="n">init_error_dialogs</span><span class="p">()</span>
        <span class="n">at</span><span class="o">.</span><span class="n">writeAtAutoNodesHelper</span><span class="p">(</span><span class="n">writeDirtyOnly</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">raise_error_dialogs</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;write&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">writeDirtyAtAutoNodes</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.writeDirtyAtAutoNodes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.writeDirtyAtAutoNodes">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Write all dirty @auto nodes in the selected outline.&#39;&#39;&#39;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">c</span>
        <span class="n">c</span><span class="o">.</span><span class="n">init_error_dialogs</span><span class="p">()</span>
        <span class="n">at</span><span class="o">.</span><span class="n">writeAtAutoNodesHelper</span><span class="p">(</span><span class="n">writeDirtyOnly</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">raise_error_dialogs</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;write&#39;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20070806140208: *5* at.writeAtAutoNodesHelper</span>
    <span class="k">def</span> <span class="nf">writeAtAutoNodesHelper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">writeDirtyOnly</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.writeAtAutoNodesHelper"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.writeAtAutoNodesHelper">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Write @auto nodes in the selected outline&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">c</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span> <span class="p">;</span> <span class="n">after</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">nodeAfterTree</span><span class="p">()</span>
        <span class="n">found</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">while</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">after</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtAutoNode</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtIgnoreNode</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">isDirty</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">writeDirtyOnly</span><span class="p">):</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">writeOneAtAutoNode</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="n">toString</span><span class="p">,</span><span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;finished&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">writeDirtyOnly</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;no dirty @auto nodes in the selected tree&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;no @auto nodes in the selected tree&quot;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20070806141607: *5* at.writeOneAtAutoNode</span>
    <span class="k">def</span> <span class="nf">writeOneAtAutoNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">toString</span><span class="p">,</span><span class="n">force</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.writeOneAtAutoNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.writeOneAtAutoNode">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Write p, an @auto node.</span>

<span class="sd">        File indices *must* have already been assigned.&#39;&#39;&#39;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">root</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">fileName</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">atAutoNodeName</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fileName</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">toString</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>

        <span class="n">at</span><span class="o">.</span><span class="n">default_directory</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">setDefaultDirectory</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">importing</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">fileName</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">default_directory</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">toString</span> <span class="ow">and</span> <span class="n">at</span><span class="o">.</span><span class="n">shouldPromptForDangerousWrite</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">root</span><span class="p">):</span>
            <span class="c"># Prompt if writing a new @auto node would overwrite the existing file.</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">promptForDangerousWrite</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;@auto&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;not written:&quot;</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="c"># Fix bug 889175: Remember the full fileName.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">rememberReadPath</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">root</span><span class="p">)</span>

        <span class="c"># This code is similar to code in at.write.</span>
        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span> <span class="c"># Capture the current headline.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">targetFileName</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">toString</span><span class="p">,</span><span class="s">&quot;&lt;string-file&gt;&quot;</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>

        <span class="n">at</span><span class="o">.</span><span class="n">initWriteIvars</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">targetFileName</span><span class="p">,</span>
            <span class="n">atAuto</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">nosentinels</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">thinFile</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">scriptWrite</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">toString</span><span class="o">=</span><span class="n">toString</span><span class="p">)</span>

        <span class="n">ok</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">openFileForWriting</span> <span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">fileName</span><span class="o">=</span><span class="n">fileName</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="n">toString</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
            <span class="n">isAtAutoOtl</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">isAtAutoOtlNode</span><span class="p">()</span> <span class="c"># For traces.</span>
            <span class="n">isAtAutoRst</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">isAtAutoRstNode</span><span class="p">()</span> <span class="c"># For traces.</span>
            <span class="k">if</span> <span class="n">isAtAutoRst</span><span class="p">:</span>
                <span class="n">ok2</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rstCommands</span><span class="o">.</span><span class="n">writeAtAutoFile</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ok2</span><span class="p">:</span> <span class="n">at</span><span class="o">.</span><span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">isAtAutoOtl</span><span class="p">:</span>
                <span class="n">ok2</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">writeAtAutoOtlFile</span><span class="p">(</span><span class="n">root</span><span class="p">)</span> <span class="c">#,fileName,self.outputFile)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ok2</span><span class="p">:</span> <span class="n">at</span><span class="o">.</span><span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">writeOpenFile</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">nosentinels</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="n">toString</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">closeWriteFile</span><span class="p">()</span> <span class="c"># Sets stringOutput if toString is True.</span>
            <span class="c"># g.trace(&#39;at.errors&#39;,at.errors)</span>
            <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">errors</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c"># g.trace(&#39;toString&#39;,toString,&#39;force&#39;,force,&#39;isAtAutoRst&#39;,isAtAutoRst)</span>
                <span class="n">at</span><span class="o">.</span><span class="n">replaceTargetFileIfDifferent</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">ignoreBlankLines</span><span class="o">=</span><span class="n">isAtAutoRst</span><span class="p">)</span>
                    <span class="c"># Sets/clears dirty and orphan bits.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;not written:&quot;</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>
                <span class="n">root</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span> <span class="c"># New in Leo 4.4.8.</span>
                <span class="n">root</span><span class="o">.</span><span class="n">setOrphan</span><span class="p">()</span> <span class="c"># 2010/10/22.</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="n">toString</span><span class="p">:</span>
            <span class="n">root</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span> <span class="c"># Make _sure_ we try to rewrite this file.</span>
            <span class="n">root</span><span class="o">.</span><span class="n">setOrphan</span><span class="p">()</span> <span class="c"># 2010/10/22.</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;not written:&quot;</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ok</span>
    <span class="c">#@+node:ekr.20080711093251.3: *4* at.writeAtShadowNodes &amp; writeDirtyAtShadowNodes &amp; helpers</span>
    <span class="k">def</span> <span class="nf">writeAtShadowNodes</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.writeAtShadowNodes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.writeAtShadowNodes">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Write all @shadow nodes in the selected outline.&#39;&#39;&#39;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">c</span>
        <span class="n">c</span><span class="o">.</span><span class="n">init_error_dialogs</span><span class="p">()</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">writeAtShadowNodesHelper</span><span class="p">(</span><span class="n">writeDirtyOnly</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">raise_error_dialogs</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;write&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">val</span>

    <span class="k">def</span> <span class="nf">writeDirtyAtShadowNodes</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.writeDirtyAtShadowNodes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.writeDirtyAtShadowNodes">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Write all dirty @shadow nodes in the selected outline.&#39;&#39;&#39;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">c</span>
        <span class="n">c</span><span class="o">.</span><span class="n">init_error_dialogs</span><span class="p">()</span>
        <span class="n">val</span> <span class="o">=</span>  <span class="n">at</span><span class="o">.</span><span class="n">writeAtShadowNodesHelper</span><span class="p">(</span><span class="n">writeDirtyOnly</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">raise_error_dialogs</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;write&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">val</span>
    <span class="c">#@+node:ekr.20080711093251.4: *5* at.writeAtShadowNodesHelper</span>
    <span class="k">def</span> <span class="nf">writeAtShadowNodesHelper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">writeDirtyOnly</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.writeAtShadowNodesHelper"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.writeAtShadowNodesHelper">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Write @shadow nodes in the selected outline&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">c</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span> <span class="p">;</span> <span class="n">after</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">nodeAfterTree</span><span class="p">()</span>
        <span class="n">found</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">while</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">after</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">atShadowFileNodeName</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtIgnoreNode</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">isDirty</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">writeDirtyOnly</span><span class="p">):</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">writeOneAtShadowNode</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="n">toString</span><span class="p">,</span><span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&#39;wrote </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">p</span><span class="o">.</span><span class="n">atShadowFileNodeName</span><span class="p">())</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;finished&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">writeDirtyOnly</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;no dirty @shadow nodes in the selected tree&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;no @shadow nodes in the selected tree&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">found</span>
    <span class="c">#@+node:ekr.20080711093251.5: *5* at.writeOneAtShadowNode &amp; helpers</span>
    <span class="k">def</span> <span class="nf">writeOneAtShadowNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">toString</span><span class="p">,</span><span class="n">force</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.writeOneAtShadowNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.writeOneAtShadowNode">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Write p, an @shadow node.</span>

<span class="sd">        File indices *must* have already been assigned.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">x</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">shadowController</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> 

        <span class="n">fn</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">atShadowFileNodeName</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fn</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;can not happen: not an @shadow node&#39;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="c"># A hack to support unknown extensions.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adjustTargetLanguage</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="c"># May set c.target_language.</span>

        <span class="n">fn</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">fullPath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">default_directory</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_dirname</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

        <span class="c"># Bug fix 2010/01/18: Make sure we can compute the shadow directory.</span>
        <span class="n">private_fn</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shadowPathName</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">private_fn</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">toString</span> <span class="ow">and</span> <span class="n">at</span><span class="o">.</span><span class="n">shouldPromptForDangerousWrite</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">root</span><span class="p">):</span>
            <span class="c"># Prompt if writing a new @shadow node would overwrite the existing public file.</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">promptForDangerousWrite</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;@shadow&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                <span class="c"># Fix bug 889175: Remember the full fileName.</span>
                <span class="n">at</span><span class="o">.</span><span class="n">rememberReadPath</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">root</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;not written:&quot;</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span> <span class="c"># Capture the current headline.</span>

        <span class="n">at</span><span class="o">.</span><span class="n">initWriteIvars</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">targetFileName</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="c"># Not used.</span>
            <span class="n">atShadow</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">nosentinels</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="c"># set below.  Affects only error messages (sometimes).</span>
            <span class="n">thinFile</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="c"># New in Leo 4.5 b2: private files are thin files.</span>
            <span class="n">scriptWrite</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">toString</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="c"># True: create a fileLikeObject.  This is done below.</span>
            <span class="n">forcePythonSentinels</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="c"># A hack to suppress an error message.</span>
                <span class="c"># The actual sentinels will be set below.</span>

        <span class="c"># g.trace(&#39;encoding&#39;,repr(at.encoding))</span>

        <span class="c"># Bug fix: Leo 4.5.1: use x.markerFromFileName to force the delim to match</span>
        <span class="c">#                     what is used in x.propegate changes.</span>
        <span class="n">marker</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">markerFromFileName</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">startSentinelComment</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">endSentinelComment</span><span class="o">=</span><span class="n">marker</span><span class="o">.</span><span class="n">getDelims</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span> <span class="n">ivars_dict</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">getIvarsDict</span><span class="p">(</span><span class="n">at</span><span class="p">)</span>

        <span class="c"># Write the public and private files to public_s and private_s strings.</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sentinels</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span><span class="bp">True</span><span class="p">):</span>
            <span class="c"># 2011/09/09: specify encoding explicitly.</span>
            <span class="n">theFile</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">openStringFile</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="n">at</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">sentinels</span> <span class="o">=</span> <span class="n">sentinels</span>
            <span class="n">at</span><span class="o">.</span><span class="n">writeOpenFile</span><span class="p">(</span><span class="n">root</span><span class="p">,</span>
                <span class="n">nosentinels</span><span class="o">=</span><span class="ow">not</span> <span class="n">sentinels</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="c"># nosentinels only affects error messages, and then only if atAuto is True.</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">closeStringFile</span><span class="p">(</span><span class="n">theFile</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="c"># Set these new ivars for unit tests.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">public_s</span><span class="p">,</span> <span class="n">at</span><span class="o">.</span><span class="n">private_s</span> <span class="o">=</span> <span class="n">data</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
            <span class="n">exceptions</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;public_s&#39;</span><span class="p">,</span><span class="s">&#39;private_s&#39;</span><span class="p">,</span><span class="s">&#39;sentinels&#39;</span><span class="p">,</span><span class="s">&#39;stringOutput&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">checkUnchangedIvars</span><span class="p">(</span><span class="n">at</span><span class="p">,</span><span class="n">ivars_dict</span><span class="p">,</span><span class="n">exceptions</span><span class="p">),</span><span class="s">&#39;writeOneAtShadowNode&#39;</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">errors</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">toString</span><span class="p">:</span>
            <span class="c"># Write the public and private files.</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;writing&#39;</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
            <span class="n">x</span><span class="o">.</span><span class="n">makeShadowDirectory</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="c"># makeShadowDirectory takes a *public* file name.</span>
            <span class="n">at</span><span class="o">.</span><span class="n">replaceFileWithString</span><span class="p">(</span><span class="n">private_fn</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">private_s</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">replaceFileWithString</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">public_s</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">checkPythonCode</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">at</span><span class="o">.</span><span class="n">private_s</span><span class="p">,</span><span class="n">targetFn</span><span class="o">=</span><span class="n">fn</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">errors</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">root</span><span class="o">.</span><span class="n">clearOrphan</span><span class="p">()</span>
            <span class="n">root</span><span class="o">.</span><span class="n">clearDirty</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;not written:&quot;</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">outputFileName</span><span class="p">)</span>
            <span class="n">root</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span> <span class="c"># New in Leo 4.4.8.</span>
            <span class="n">root</span><span class="o">.</span><span class="n">setOrphan</span><span class="p">()</span> <span class="c"># 2010/10/22.</span>

        <span class="k">return</span> <span class="n">at</span><span class="o">.</span><span class="n">errors</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="c">#@+node:ekr.20080819075811.13: *6* adjustTargetLanguage</span>
    <span class="k">def</span> <span class="nf">adjustTargetLanguage</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.adjustTargetLanguage"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.adjustTargetLanguage">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Use the language implied by fn&#39;s extension if</span>
<span class="sd">        there is a conflict between it and c.target_language.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">c</span>
        <span class="n">junk</span><span class="p">,</span><span class="n">ext</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_splitext</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ext</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ext</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">):</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">ext</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

            <span class="n">language</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">extension_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">language</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">target_language</span> <span class="o">=</span> <span class="n">language</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># An unknown language.</span>
                <span class="k">pass</span> <span class="c"># Use the default language, **not** &#39;unknown_language&#39;</span>
    <span class="c">#@+node:ekr.20050506084734: *4* at.writeFromString</span>
    <span class="c"># This is at.write specialized for scripting.</span>

    <span class="k">def</span> <span class="nf">writeFromString</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">root</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">forcePythonSentinels</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">useSentinels</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.writeFromString"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.writeFromString">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Write a 4.x derived file from a string.</span>

<span class="sd">        This is used by the scripting logic.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">c</span>
        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span> <span class="c"># Capture the current headline, but don&#39;t change the focus!</span>

        <span class="n">at</span><span class="o">.</span><span class="n">initWriteIvars</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="s">&quot;&lt;string-file&gt;&quot;</span><span class="p">,</span>
            <span class="n">nosentinels</span><span class="o">=</span><span class="ow">not</span> <span class="n">useSentinels</span><span class="p">,</span><span class="n">thinFile</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">scriptWrite</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">forcePythonSentinels</span><span class="o">=</span><span class="n">forcePythonSentinels</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">openFileForWriting</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">targetFileName</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span> <span class="k">assert</span> <span class="n">ok</span><span class="p">,</span><span class="s">&#39;writeFromString&#39;</span> <span class="c"># string writes never fail.</span>
            <span class="c"># Simulate writing the entire file so error recovery works.</span>
            <span class="n">at</span><span class="o">.</span><span class="n">writeOpenFile</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">nosentinels</span><span class="o">=</span><span class="ow">not</span> <span class="n">useSentinels</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">fromString</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">closeWriteFile</span><span class="p">()</span>
            <span class="c"># Major bug: failure to clear this wipes out headlines!</span>
            <span class="c"># Minor bug: sometimes this causes slight problems...</span>
            <span class="k">if</span> <span class="n">root</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;tnodeList&#39;</span><span class="p">):</span>
                    <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;tnodeList&#39;</span><span class="p">)</span>
                <span class="n">root</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">_p_changed</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&quot;exception preprocessing script&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">at</span><span class="o">.</span><span class="n">stringOutput</span>
    <span class="c">#@+node:ekr.20041005105605.151: *4* at.writeMissing</span>
    <span class="k">def</span> <span class="nf">writeMissing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.writeMissing"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.writeMissing">[docs]</a>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">c</span>
        <span class="n">writtenFiles</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">c</span><span class="o">.</span><span class="n">init_error_dialogs</span><span class="p">()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">after</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">nodeAfterTree</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">after</span><span class="p">:</span> <span class="c"># Don&#39;t use iterator.</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtAsisFileNode</span><span class="p">()</span> <span class="ow">or</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">isAnyAtFileNode</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtIgnoreNode</span><span class="p">()):</span>
                <span class="n">at</span><span class="o">.</span><span class="n">targetFileName</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">anyAtFileNodeName</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">targetFileName</span><span class="p">:</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">targetFileName</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">default_directory</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">targetFileName</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">targetFileName</span><span class="p">):</span>
                        <span class="n">ok</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">openFileForWriting</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">targetFileName</span><span class="p">,</span><span class="n">toString</span><span class="p">)</span>
                        <span class="c"># openFileForWriting calls p.setDirty() if there are errors.</span>
                        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                            <span class="c">#@+&lt;&lt; write the @file node &gt;&gt;</span>
                            <span class="c">#@+node:ekr.20041005105605.152: *5* &lt;&lt; write the @file node &gt;&gt; (writeMissing)</span>
                            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtAsisFileNode</span><span class="p">():</span>
                                <span class="n">at</span><span class="o">.</span><span class="n">asisWrite</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtNoSentFileNode</span><span class="p">():</span>
                                <span class="n">at</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;@nosent&#39;</span><span class="p">,</span><span class="n">nosentinels</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtFileNode</span><span class="p">():</span>
                                <span class="n">at</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;@file&#39;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span> <span class="k">assert</span> <span class="mi">0</span><span class="p">,</span><span class="s">&#39;writeMissing&#39;</span>

                            <span class="n">writtenFiles</span> <span class="o">=</span> <span class="bp">True</span>
                            <span class="c">#@-&lt;&lt; write the @file node &gt;&gt;</span>
                            <span class="n">at</span><span class="o">.</span><span class="n">closeWriteFile</span><span class="p">()</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtIgnoreNode</span><span class="p">():</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">writtenFiles</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;finished&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;no @file node in the selected tree&quot;</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">raise_error_dialogs</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;write&#39;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20090225080846.5: *4* at.writeOneAtEditNode</span>
    <span class="k">def</span> <span class="nf">writeOneAtEditNode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">toString</span><span class="p">,</span><span class="n">force</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.writeOneAtEditNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.writeOneAtEditNode">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Write one @edit node.&#39;&#39;&#39;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">c</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">init_error_dialogs</span><span class="p">()</span>

        <span class="n">fn</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">atEditNodeName</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fn</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">toString</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">hasChildren</span><span class="p">():</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;@edit nodes must not have children&#39;</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;To save your work, convert @edit to @auto or @thin&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="n">at</span><span class="o">.</span><span class="n">default_directory</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">setDefaultDirectory</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">importing</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">default_directory</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span> <span class="ow">and</span> <span class="n">at</span><span class="o">.</span><span class="n">shouldPromptForDangerousWrite</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">root</span><span class="p">):</span>
            <span class="c"># Prompt if writing a new @edit node would overwrite the existing file.</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">promptForDangerousWrite</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;@edit&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                <span class="c"># Fix bug 889175: Remember the full fileName.</span>
                <span class="n">at</span><span class="o">.</span><span class="n">rememberReadPath</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">root</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;not written:&quot;</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>

        <span class="n">at</span><span class="o">.</span><span class="n">targetFileName</span> <span class="o">=</span> <span class="n">fn</span>
        <span class="n">at</span><span class="o">.</span><span class="n">initWriteIvars</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">targetFileName</span><span class="p">,</span>
            <span class="n">atAuto</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">atEdit</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">nosentinels</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">thinFile</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">scriptWrite</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="n">toString</span><span class="p">)</span>

        <span class="c"># Compute the file&#39;s contents.</span>
        <span class="c"># Unlike the @nosent file logic it does not add a final newline.</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">directiveKind4</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">at</span><span class="o">.</span><span class="n">noDirective</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">toString</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">stringOutput</span> <span class="o">=</span> <span class="n">contents</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="n">ok</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">openFileForWriting</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">fileName</span><span class="o">=</span><span class="n">fn</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">os</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">closeWriteFile</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ok</span> <span class="ow">and</span> <span class="n">at</span><span class="o">.</span><span class="n">errors</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">replaceTargetFileIfDifferent</span><span class="p">(</span><span class="n">root</span><span class="p">)</span> <span class="c"># Sets/clears dirty and orphan bits.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;not written:&quot;</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">targetFileName</span><span class="p">)</span> <span class="c"># 2010/10/22</span>
            <span class="n">root</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span>
            <span class="n">root</span><span class="o">.</span><span class="n">setOrphan</span><span class="p">()</span> <span class="c"># 2010/10/22</span>

        <span class="n">c</span><span class="o">.</span><span class="n">raise_error_dialogs</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">&#39;write&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ok</span>
    <span class="c">#@+node:ekr.20041005105605.157: *4* at.writeOpenFile</span>
    <span class="c"># New in 4.3: must be inited before calling this method.</span>
    <span class="c"># New in 4.3 b2: support for writing from a string.</span>

    <span class="k">def</span> <span class="nf">writeOpenFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">root</span><span class="p">,</span></div>
<div class="viewcode-block" id="atFile.writeOpenFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.writeOpenFile">[docs]</a>        <span class="n">nosentinels</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">fromString</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Do all writes except asis writes.&quot;&quot;&quot;</span>

        <span class="c"># g.trace(self.encoding,&#39;nosentinels&#39;,nosentinels,root.h,self.outputFile)</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">fromString</span><span class="p">,</span><span class="n">fromString</span><span class="p">,</span><span class="n">root</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
        <span class="n">root</span><span class="o">.</span><span class="n">clearAllVisitedInTree</span><span class="p">()</span>
        <span class="n">at</span><span class="o">.</span><span class="n">putAtFirstLines</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">putOpenLeoSentinel</span><span class="p">(</span><span class="s">&quot;@+leo-ver=</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">writeVersion5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">)))</span>
                <span class="c"># Use version 4 for @shadow, verion 5 otherwise.</span>

        <span class="n">at</span><span class="o">.</span><span class="n">putInitialComment</span><span class="p">()</span>
        <span class="n">at</span><span class="o">.</span><span class="n">putOpenNodeSentinel</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">putBody</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">fromString</span><span class="o">=</span><span class="n">fromString</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">putCloseNodeSentinel</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="c"># The -leo sentinel is required to handle @last.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">putSentinel</span><span class="p">(</span><span class="s">&quot;@-leo&quot;</span><span class="p">)</span>
        <span class="n">root</span><span class="o">.</span><span class="n">setVisited</span><span class="p">()</span>
        <span class="n">at</span><span class="o">.</span><span class="n">putAtLastLines</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">toString</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">warnAboutOrphandAndIgnoredNodes</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20120518080359.10006: *4* at.writeAtAutoOtlFile</span>
    <span class="k">def</span> <span class="nf">writeAtAutoOtlFile</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">root</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.writeAtAutoOtlFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.writeAtAutoOtlFile">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Write all the *descendants* of an @auto-otl node.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;Take care with output newlines.&#39;&#39;&#39;</span>
            <span class="n">at</span><span class="o">.</span><span class="n">os</span><span class="p">(</span><span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">s</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">onl</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">level</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">self_and_subtree</span><span class="p">():</span>
                <span class="n">indent</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">level</span><span class="p">()</span><span class="o">-</span><span class="n">n</span><span class="p">)</span>
                <span class="n">put</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">indent</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="bp">False</span><span class="p">):</span>
                    <span class="n">put</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">indent</span><span class="p">,</span><span class="n">s</span><span class="p">))</span>

        <span class="n">root</span><span class="o">.</span><span class="n">setVisited</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="c">#@+node:ekr.20041005105605.160: *3* Writing 4.x</span>
    <span class="c">#@+node:ekr.20041005105605.161: *4* at.putBody</span>
    <span class="c"># oneNodeOnly is no longer used, but it might be used in the future?</span>

    <span class="k">def</span> <span class="nf">putBody</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">oneNodeOnly</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">fromString</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.putBody"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.putBody">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Generate the body enclosed in sentinel lines.</span>
<span class="sd">        Return True if the body contains an @others line.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">at_comment_seen</span><span class="p">,</span><span class="n">at_delims_seen</span><span class="p">,</span><span class="n">at_warning_given</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="bp">False</span><span class="p">,</span><span class="bp">False</span>
            <span class="c"># 2011/05/25: warn if a node contains both @comment and @delims.</span>
        <span class="n">has_at_others</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># New in 4.3 b2: get s from fromString if possible.</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">fromString</span><span class="p">,</span><span class="n">fromString</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>

        <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">setVisited</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;visit&#39;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
            <span class="c"># Make sure v is never expanded again.</span>
            <span class="c"># Suppress orphans check.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">at</span><span class="o">.</span><span class="n">thinFile</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">setWriteBit</span><span class="p">()</span> <span class="c"># Mark the vnode to be written.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">at</span><span class="o">.</span><span class="n">thinFile</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">inCode</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c">#@+&lt;&lt; Make sure all lines end in a newline &gt;&gt;</span>
        <span class="c">#@+node:ekr.20041005105605.162: *5* &lt;&lt; Make sure all lines end in a newline &gt;&gt;</span>
        <span class="c">#@+at If we add a trailing newline, we&#39;ll generate an @nonl sentinel below.</span>
        <span class="c"># </span>
        <span class="c"># - We always ensure a newline in @file and @thin trees.</span>
        <span class="c"># - This code is not used used in @asis trees.</span>
        <span class="c"># - New in Leo 4.4.3 b1: We add a newline in @nosent trees unless</span>
        <span class="c">#   @bool force_newlines_in_at_nosent_bodies = False</span>
        <span class="c">#@@c</span>

        <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">trailingNewlineFlag</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">trailingNewlineFlag</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">sentinels</span> <span class="ow">or</span> 
                    <span class="p">(</span><span class="ow">not</span> <span class="n">at</span><span class="o">.</span><span class="n">atAuto</span> <span class="ow">and</span> <span class="n">at</span><span class="o">.</span><span class="n">force_newlines_in_at_nosent_bodies</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="c"># g.trace(&#39;Added newline&#39;,repr(s))</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">trailingNewlineFlag</span> <span class="o">=</span> <span class="bp">True</span> <span class="c"># don&#39;t need to generate an @nonl</span>
        <span class="c">#@-&lt;&lt; Make sure all lines end in a newline &gt;&gt;</span>
        <span class="n">at</span><span class="o">.</span><span class="n">raw</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># 2007/07/04: Bug fix exposed by new sentinels.</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="n">next_i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">next_i</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">,</span><span class="s">&#39;putBody&#39;</span>
            <span class="n">kind</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">directiveKind4</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="c">#@+&lt;&lt; handle line at s[i] &gt;&gt;</span>
            <span class="c">#@+node:ekr.20041005105605.163: *5* &lt;&lt; handle line at s[i] &gt;&gt; (putBody)</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">next_i</span><span class="p">]))</span>

            <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="n">at</span><span class="o">.</span><span class="n">noDirective</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">oneNodeOnly</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">inCode</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">raw</span> <span class="ow">or</span> <span class="n">at</span><span class="o">.</span><span class="n">atAuto</span> <span class="ow">or</span> <span class="n">at</span><span class="o">.</span><span class="n">perfectImportFlag</span><span class="p">:</span>
                            <span class="c"># 2011/12/14: Ignore references in @auto.</span>
                            <span class="c"># 2012/06/02: Needed for import checks.</span>
                            <span class="n">at</span><span class="o">.</span><span class="n">putCodeLine</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">hasRef</span><span class="p">,</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">findSectionName</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">hasRef</span><span class="p">:</span>
                                <span class="n">at</span><span class="o">.</span><span class="n">putRefLine</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">at</span><span class="o">.</span><span class="n">putCodeLine</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">at</span><span class="o">.</span><span class="n">putDocLine</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">at</span><span class="o">.</span><span class="n">raw</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="n">at</span><span class="o">.</span><span class="n">endRawDirective</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">at</span><span class="o">.</span><span class="n">perfectImportFlag</span><span class="p">:</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">raw</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">putSentinel</span><span class="p">(</span><span class="s">&quot;@@end_raw&quot;</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># Fix bug 784920: @raw mode does not ignore directives </span>
                    <span class="n">at</span><span class="o">.</span><span class="n">putCodeLine</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">docDirective</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">atDirective</span><span class="p">):</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="n">at</span><span class="o">.</span><span class="n">pending</span><span class="p">,</span><span class="s">&#39;putBody at.pending&#39;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">inCode</span><span class="p">:</span> <span class="c"># Bug fix 12/31/04: handle adjacent doc parts.</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">putEndDocLine</span><span class="p">()</span> 
                <span class="n">at</span><span class="o">.</span><span class="n">putStartDocLine</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">kind</span><span class="p">)</span>
                <span class="n">inCode</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">elif</span> <span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">cDirective</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">codeDirective</span><span class="p">):</span>
                <span class="c"># Only @c and @code end a doc part.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">inCode</span><span class="p">:</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">putEndDocLine</span><span class="p">()</span> 
                <span class="n">at</span><span class="o">.</span><span class="n">putDirective</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                <span class="n">inCode</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="n">at</span><span class="o">.</span><span class="n">allDirective</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">oneNodeOnly</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">inCode</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="p">:</span>
                            <span class="n">at</span><span class="o">.</span><span class="n">putAtAllLine</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">at</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;@all not valid in: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span> <span class="n">at</span><span class="o">.</span><span class="n">putDocLine</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="n">at</span><span class="o">.</span><span class="n">othersDirective</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">oneNodeOnly</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">inCode</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">has_at_others</span><span class="p">:</span>
                            <span class="n">at</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;multiple @others in: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">at</span><span class="o">.</span><span class="n">putAtOthersLine</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
                            <span class="n">has_at_others</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">at</span><span class="o">.</span><span class="n">putDocLine</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="n">at</span><span class="o">.</span><span class="n">rawDirective</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">raw</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">at</span><span class="o">.</span><span class="n">putSentinel</span><span class="p">(</span><span class="s">&quot;@@raw&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="n">at</span><span class="o">.</span><span class="n">endRawDirective</span><span class="p">:</span>
                <span class="c"># Fix bug 784920: @raw mode does not ignore directives </span>
                <span class="n">at</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;unmatched @end_raw directive: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
                <span class="c"># at.raw = False</span>
                <span class="c"># at.putSentinel(&quot;@@end_raw&quot;)</span>
                <span class="c"># i = g.skip_line(s,i)</span>
            <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="n">at</span><span class="o">.</span><span class="n">startVerbatim</span><span class="p">:</span>
                <span class="c"># Fix bug 778204: @verbatim not a valid Leo directive.</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                    <span class="c"># A hack: unit tests for @shadow use @verbatim as a kind of directive.</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">at</span><span class="o">.</span><span class="n">perfectImportFlag</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">atShadow</span><span class="p">)</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;@verbatim is not a Leo directive: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
                <span class="k">if</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># Old code.  This is wrong: @verbatim is not a directive!</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">putSentinel</span><span class="p">(</span><span class="s">&quot;@verbatim&quot;</span><span class="p">)</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">putIndent</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">indent</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">next_i</span>
                    <span class="n">next_i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">os</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">next_i</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="n">at</span><span class="o">.</span><span class="n">miscDirective</span><span class="p">:</span>
                <span class="c"># Fix bug 583878: Leo should warn about @comment/@delims clashes.</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;@comment&#39;</span><span class="p">):</span>
                    <span class="n">at_comment_seen</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;@delims&#39;</span><span class="p">):</span>
                    <span class="n">at_delims_seen</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">if</span> <span class="n">at_comment_seen</span> <span class="ow">and</span> <span class="n">at_delims_seen</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">at_warning_given</span><span class="p">:</span>
                    <span class="n">at_warning_given</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;@comment and @delims in node </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
                <span class="n">at</span><span class="o">.</span><span class="n">putDirective</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;putBody: can not happen: unknown directive kind: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">kind</span><span class="p">)</span>
            <span class="c">#@-&lt;&lt; handle line at s[i] &gt;&gt;</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">next_i</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">inCode</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">putEndDocLine</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">trailingNewlineFlag</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">writeVersion5</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">sentinels</span><span class="p">:</span>
                    <span class="k">pass</span> <span class="c"># Never write @nonl</span>
                <span class="k">elif</span> <span class="n">at</span><span class="o">.</span><span class="n">atAuto</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">at</span><span class="o">.</span><span class="n">atEdit</span><span class="p">:</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">onl</span><span class="p">()</span> <span class="c"># 2010/08/01: bug fix: ensure newline here.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">sentinels</span><span class="p">:</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">putSentinel</span><span class="p">(</span><span class="s">&quot;@nonl&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">at</span><span class="o">.</span><span class="n">atAuto</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">at</span><span class="o">.</span><span class="n">atEdit</span><span class="p">:</span>
                    <span class="c"># Ensure all @auto nodes end in a newline!</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">onl</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">has_at_others</span> <span class="c"># 2013/01/19: for new @others logic.</span>
    <span class="c">#@+node:ekr.20041005105605.164: *4* writing code lines...</span>
    <span class="c">#@+node:ekr.20041005105605.165: *5* @all</span>
    <span class="c">#@+node:ekr.20041005105605.166: *6* putAtAllLine</span>
    <span class="k">def</span> <span class="nf">putAtAllLine</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">p</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.putAtAllLine"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.putAtAllLine">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Put the expansion of @all.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">j</span><span class="p">,</span><span class="n">delta</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_leading_ws_with_indent</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">tab_width</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">putLeadInSentinel</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">delta</span><span class="p">)</span>

        <span class="n">at</span><span class="o">.</span><span class="n">indent</span> <span class="o">+=</span> <span class="n">delta</span>
        <span class="n">lws</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">leadingWs</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">writeVersion5</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">lws</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">putSentinel</span><span class="p">(</span><span class="s">&quot;@+all&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">putSentinel</span><span class="p">(</span><span class="s">&quot;@&quot;</span> <span class="o">+</span> <span class="n">at</span><span class="o">.</span><span class="n">leadingWs</span> <span class="o">+</span> <span class="s">&quot;@+all&quot;</span><span class="p">)</span> 

        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
            <span class="n">at</span><span class="o">.</span><span class="n">putAtAllChild</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>

        <span class="n">at</span><span class="o">.</span><span class="n">putSentinel</span><span class="p">(</span><span class="s">&quot;@-all&quot;</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">indent</span> <span class="o">-=</span> <span class="n">delta</span>
    <span class="c">#@+node:ekr.20041005105605.167: *6* putatAllBody</span>
    <span class="k">def</span> <span class="nf">putAtAllBody</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.putAtAllBody"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.putAtAllBody">[docs]</a>
        <span class="sd">&quot;&quot;&quot; Generate the body enclosed in sentinel lines.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span>

        <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">setVisited</span><span class="p">()</span>
        <span class="c"># g.trace(&#39;visit&#39;,p.h)</span>
            <span class="c"># Make sure v is never expanded again.</span>
            <span class="c"># Suppress orphans check.</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">at</span><span class="o">.</span><span class="n">thinFile</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">inCode</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c">#@+&lt;&lt; Make sure all lines end in a newline &gt;&gt;</span>
        <span class="c">#@+node:ekr.20041005105605.168: *7* &lt;&lt; Make sure all lines end in a newline &gt;&gt;</span>
        <span class="c"># 11/20/03: except in nosentinel mode.</span>
        <span class="c"># 1/30/04: and especially in scripting mode.</span>
        <span class="c"># If we add a trailing newline, we&#39;ll generate an @nonl sentinel below.</span>

        <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">trailingNewlineFlag</span> <span class="o">=</span> <span class="n">s</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
            <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">sentinels</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">trailingNewlineFlag</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">trailingNewlineFlag</span> <span class="o">=</span> <span class="bp">True</span> <span class="c"># don&#39;t need to generate an @nonl</span>
        <span class="c">#@-&lt;&lt; Make sure all lines end in a newline &gt;&gt;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="n">next_i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">next_i</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inCode</span><span class="p">:</span>
                <span class="c"># Use verbatim sentinels to write all directives.</span>
                <span class="n">at</span><span class="o">.</span><span class="n">putCodeLine</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">putDocLine</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">next_i</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">inCode</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">putEndDocLine</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">sentinels</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">trailingNewlineFlag</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">at</span><span class="o">.</span><span class="n">writeVersion5</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">putSentinel</span><span class="p">(</span><span class="s">&quot;@nonl&quot;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20041005105605.169: *6* putAtAllChild</span>
    <span class="c">#@+at This code puts only the first of two or more cloned siblings, preceding the</span>
    <span class="c"># clone with an @clone n sentinel.</span>
    <span class="c"># </span>
    <span class="c"># This is a debatable choice: the cloned tree appears only once in the external</span>
    <span class="c"># file. This should be benign; the text created by @all is likely to be used only</span>
    <span class="c"># for recreating the outline in Leo. The representation in the derived file</span>
    <span class="c"># doesn&#39;t matter much.</span>
    <span class="c">#@@c</span>

    <span class="k">def</span> <span class="nf">putAtAllChild</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.putAtAllChild"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.putAtAllChild">[docs]</a>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">parent_v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">_parentVnode</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">False</span><span class="p">:</span> <span class="c"># 2010/01/23: This generates atFile errors about orphan nodes.</span>
            <span class="n">clonedSibs</span><span class="p">,</span><span class="n">thisClonedSibIndex</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">scanForClonedSibs</span><span class="p">(</span><span class="n">parent_v</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">clonedSibs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">putSentinel</span><span class="p">(</span><span class="s">&quot;@clone </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">clonedSibs</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;**** ignoring&#39;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">setVisited</span><span class="p">()</span> <span class="c"># 2010/01/23</span>
                <span class="k">return</span> <span class="c"># Don&#39;t write second or greater trees.</span>

        <span class="n">at</span><span class="o">.</span><span class="n">putOpenNodeSentinel</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">inAtAll</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="c"># Suppress warnings about @file nodes.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">putAtAllBody</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> 

        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
            <span class="n">at</span><span class="o">.</span><span class="n">putAtAllChild</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>

        <span class="n">at</span><span class="o">.</span><span class="n">putCloseNodeSentinel</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20041005105605.170: *5* @others (write)</span>
    <span class="c">#@+node:ekr.20041005105605.173: *6* putAtOthersLine &amp; helpers</span>
    <span class="k">def</span> <span class="nf">putAtOthersLine</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">p</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.putAtOthersLine"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.putAtOthersLine">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Put the expansion of @others.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">j</span><span class="p">,</span><span class="n">delta</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_leading_ws_with_indent</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">tab_width</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">putLeadInSentinel</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">delta</span><span class="p">)</span>

        <span class="n">at</span><span class="o">.</span><span class="n">indent</span> <span class="o">+=</span> <span class="n">delta</span>

        <span class="n">lws</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">leadingWs</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">writeVersion5</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">lws</span><span class="p">:</span>
            <span class="c"># Never write lws in new sentinels.</span>
            <span class="n">at</span><span class="o">.</span><span class="n">putSentinel</span><span class="p">(</span><span class="s">&quot;@+others&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Use the old (bizarre) convention when writing old sentinels.</span>
            <span class="c"># Note: there are *two* at signs here.</span>
            <span class="n">at</span><span class="o">.</span><span class="n">putSentinel</span><span class="p">(</span><span class="s">&quot;@&quot;</span> <span class="o">+</span> <span class="n">lws</span> <span class="o">+</span> <span class="s">&quot;@+others&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">allow_cloned_sibs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">after</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">nodeAfterTree</span><span class="p">()</span>
                <span class="k">while</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">after</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">validInAtOthers</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                        <span class="n">at</span><span class="o">.</span><span class="n">putOpenNodeSentinel</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                        <span class="n">at_others_flag</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">putBody</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                        <span class="n">at</span><span class="o">.</span><span class="n">putCloseNodeSentinel</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">at_others_flag</span><span class="p">:</span>
                            <span class="n">p</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">p</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
                <span class="c"># g.trace(child.h)</span>
                <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">validInAtOthers</span><span class="p">(</span><span class="n">child</span><span class="p">):</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">putAtOthersChild</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>

        <span class="c"># This is the same in both old and new sentinels.</span>
        <span class="n">at</span><span class="o">.</span><span class="n">putSentinel</span><span class="p">(</span><span class="s">&quot;@-others&quot;</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">indent</span> <span class="o">-=</span> <span class="n">delta</span>
    <span class="c">#@+node:ekr.20041005105605.172: *7* putAtOthersChild</span>
    <span class="k">def</span> <span class="nf">putAtOthersChild</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.putAtOthersChild"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.putAtOthersChild">[docs]</a>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">parent_v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">_parentVnode</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_cloned_sibs</span><span class="p">:</span>
            <span class="n">clonedSibs</span><span class="p">,</span><span class="n">thisClonedSibIndex</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">scanForClonedSibs</span><span class="p">(</span><span class="n">parent_v</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">clonedSibs</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">thisClonedSibIndex</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">writeError</span><span class="p">(</span><span class="s">&quot;Cloned siblings are not valid in @thin trees&quot;</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

        <span class="n">at</span><span class="o">.</span><span class="n">putOpenNodeSentinel</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">putBody</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_cloned_sibs</span><span class="p">:</span>
            <span class="c"># Insert expansions of all children.</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
                <span class="c"># g.trace(child.h)</span>
                <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">validInAtOthers</span><span class="p">(</span><span class="n">child</span><span class="p">):</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">putAtOthersChild</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>

        <span class="n">at</span><span class="o">.</span><span class="n">putCloseNodeSentinel</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20041005105605.171: *7* validInAtOthers (write)</span>
    <span class="k">def</span> <span class="nf">validInAtOthers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.validInAtOthers"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.validInAtOthers">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Returns True if p should be included in the expansion of the at-others directive</span>

<span class="sd">        in the body text of p&#39;s parent.&quot;&quot;&quot;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_cloned_sibs</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">isVisited</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&quot;previously visited&quot;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">isSection</span><span class="p">,</span><span class="n">junk</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">isSectionName</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">isSection</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span> <span class="c"># A section definition node.</span>
        <span class="k">elif</span> <span class="n">at</span><span class="o">.</span><span class="n">sentinels</span> <span class="ow">or</span> <span class="n">at</span><span class="o">.</span><span class="n">atAuto</span> <span class="ow">or</span> <span class="n">at</span><span class="o">.</span><span class="n">toString</span><span class="p">:</span>
            <span class="c"># @ignore must not stop expansion here!</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtIgnoreNode</span><span class="p">():</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;did not write @ignore node&#39;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
    <span class="c">#@+node:ekr.20041005105605.174: *5* putCodeLine (leoAtFile)</span>
    <span class="k">def</span> <span class="nf">putCodeLine</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.putCodeLine"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.putCodeLine">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Put a normal code line.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># Put @verbatim sentinel if required.</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">startSentinelComment</span> <span class="o">+</span> <span class="s">&#39;@&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">putSentinel</span><span class="p">(</span><span class="s">&#39;@verbatim&#39;</span><span class="p">)</span>

        <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atShadow</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>

        <span class="c"># Don&#39;t put any whitespace in otherwise blank lines.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="c"># Preserve *anything* the user puts on the line!!!</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">at</span><span class="o">.</span><span class="n">raw</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">putIndent</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">indent</span><span class="p">,</span><span class="n">line</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span><span class="o">==</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">:</span>
                <span class="c"># g.trace(repr(line))</span>
                <span class="n">at</span><span class="o">.</span><span class="n">os</span><span class="p">(</span><span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">at</span><span class="o">.</span><span class="n">onl</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">os</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">onl</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;Can not happen: completely empty line&#39;</span><span class="p">)</span>

    <span class="c">#@+node:ekr.20041005105605.175: *5* putRefLine &amp; allies</span>
    <span class="c">#@+node:ekr.20041005105605.176: *6* putRefLine</span>
    <span class="k">def</span> <span class="nf">putRefLine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">p</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.putRefLine"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.putRefLine">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Put a line containing one or more references.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># Compute delta only once.</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">putRefAt</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">delta</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">delta</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span> <span class="c"># 11/23/03</span>

        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">n2</span> <span class="o">+</span> <span class="mi">2</span>
            <span class="n">hasRef</span><span class="p">,</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">findSectionName</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hasRef</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">putAfterMiddleRef</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">n1</span><span class="p">,</span><span class="n">delta</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">putRefAt</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">n1</span><span class="p">,</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">delta</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">putAfterLastRef</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">delta</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20041005105605.177: *6* putRefAt</span>
    <span class="k">def</span> <span class="nf">putRefAt</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">delta</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.putRefAt"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.putRefAt">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Put a reference at s[n1:n2+2] from p.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">name</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">n1</span><span class="p">:</span><span class="n">n2</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">ref</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">findReference</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ref</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">writeError</span><span class="p">(</span>
                    <span class="s">&quot;undefined section: </span><span class="si">%s</span><span class="se">\n\t</span><span class="s">referenced from: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                        <span class="p">(</span> <span class="n">name</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="c"># Expand the ref.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">delta</span><span class="p">:</span>
            <span class="n">junk</span><span class="p">,</span><span class="n">delta</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_leading_ws_with_indent</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">tab_width</span><span class="p">)</span>

        <span class="n">at</span><span class="o">.</span><span class="n">putLeadInSentinel</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">n1</span><span class="p">,</span><span class="n">delta</span><span class="p">)</span>

        <span class="n">inBetween</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">thinFile</span><span class="p">:</span> <span class="c"># @+-middle used only in thin files.</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>
            <span class="k">while</span> <span class="n">parent</span> <span class="o">!=</span> <span class="n">p</span><span class="p">:</span>
                <span class="n">inBetween</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
                <span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>

        <span class="n">at</span><span class="o">.</span><span class="n">indent</span> <span class="o">+=</span> <span class="n">delta</span>

        <span class="n">lws</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">leadingWs</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">writeVersion5</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">putSentinel</span><span class="p">(</span><span class="s">&quot;@+&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">putSentinel</span><span class="p">(</span><span class="s">&quot;@&quot;</span> <span class="o">+</span> <span class="n">lws</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">inBetween</span><span class="p">:</span>
            <span class="c"># Bug fix: reverse the +middle sentinels, not the -middle sentinels.</span>
            <span class="n">inBetween</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">p2</span> <span class="ow">in</span> <span class="n">inBetween</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">putOpenNodeSentinel</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span><span class="n">middle</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">at</span><span class="o">.</span><span class="n">putOpenNodeSentinel</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">putBody</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">putCloseNodeSentinel</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">inBetween</span><span class="p">:</span>
            <span class="n">inBetween</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">p2</span> <span class="ow">in</span> <span class="n">inBetween</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">putCloseNodeSentinel</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span><span class="n">middle</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">writeVersion5</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">putSentinel</span><span class="p">(</span><span class="s">&quot;@-&quot;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>

        <span class="n">at</span><span class="o">.</span><span class="n">indent</span> <span class="o">-=</span> <span class="n">delta</span>

        <span class="k">return</span> <span class="n">delta</span>
    <span class="c">#@+node:ekr.20041005105605.178: *6* putAfterLastRef</span>
    <span class="k">def</span> <span class="nf">putAfterLastRef</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">start</span><span class="p">,</span><span class="n">delta</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.putAfterLastRef"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.putAfterLastRef">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Handle whatever follows the last ref of a line.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">start</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">start</span><span class="p">)</span>
            <span class="n">after</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span> <span class="c"># Ends with a newline only if the line did.</span>
            <span class="c"># Temporarily readjust delta to make @afterref look better.</span>
            <span class="n">at</span><span class="o">.</span><span class="n">indent</span> <span class="o">+=</span> <span class="n">delta</span>
            <span class="n">at</span><span class="o">.</span><span class="n">putSentinel</span><span class="p">(</span><span class="s">&quot;@afterref&quot;</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">os</span><span class="p">(</span><span class="n">after</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">sentinels</span> <span class="ow">and</span> <span class="n">after</span> <span class="ow">and</span> <span class="n">after</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">onl</span><span class="p">()</span> <span class="c"># Add a newline if the line didn&#39;t end with one.</span>
            <span class="n">at</span><span class="o">.</span><span class="n">indent</span> <span class="o">-=</span> <span class="n">delta</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">writeVersion5</span><span class="p">:</span>
                <span class="k">pass</span> <span class="c"># Never write @nl sentinels.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># Temporarily readjust delta to make @nl look better.</span>
                <span class="n">at</span><span class="o">.</span><span class="n">indent</span> <span class="o">+=</span> <span class="n">delta</span>
                <span class="n">at</span><span class="o">.</span><span class="n">putSentinel</span><span class="p">(</span><span class="s">&quot;@nl&quot;</span><span class="p">)</span>
                <span class="n">at</span><span class="o">.</span><span class="n">indent</span> <span class="o">-=</span> <span class="n">delta</span>
    <span class="c">#@+node:ekr.20041005105605.179: *6* putAfterMiddleRef</span>
    <span class="k">def</span> <span class="nf">putAfterMiddleRef</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">,</span><span class="n">delta</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.putAfterMiddleRef"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.putAfterMiddleRef">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Handle whatever follows a ref that is not the last ref of a line.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">:</span>
            <span class="n">after</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
            <span class="n">at</span><span class="o">.</span><span class="n">indent</span> <span class="o">+=</span> <span class="n">delta</span>
            <span class="n">at</span><span class="o">.</span><span class="n">putSentinel</span><span class="p">(</span><span class="s">&quot;@afterref&quot;</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">os</span><span class="p">(</span><span class="n">after</span><span class="p">)</span> <span class="p">;</span> <span class="n">at</span><span class="o">.</span><span class="n">onl_sent</span><span class="p">()</span> <span class="c"># Not a real newline.</span>
            <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">writeVersion5</span><span class="p">:</span>
                <span class="k">pass</span> <span class="c"># Never write @nonl sentinels.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">putSentinel</span><span class="p">(</span><span class="s">&quot;@nonl&quot;</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">indent</span> <span class="o">-=</span> <span class="n">delta</span>
    <span class="c">#@+node:ekr.20041005105605.180: *4* writing doc lines...</span>
    <span class="c">#@+node:ekr.20041005105605.181: *5* putBlankDocLine</span>
    <span class="k">def</span> <span class="nf">putBlankDocLine</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.putBlankDocLine"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.putBlankDocLine">[docs]</a>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">at</span><span class="o">.</span><span class="n">putPending</span><span class="p">(</span><span class="n">split</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">at</span><span class="o">.</span><span class="n">endSentinelComment</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">putIndent</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">indent</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">os</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">startSentinelComment</span><span class="p">)</span> <span class="p">;</span> <span class="n">at</span><span class="o">.</span><span class="n">oblank</span><span class="p">()</span>

        <span class="n">at</span><span class="o">.</span><span class="n">onl</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20041005105605.183: *5* putDocLine</span>
    <span class="k">def</span> <span class="nf">putDocLine</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.putDocLine"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.putDocLine">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Handle one line of a doc part.</span>

<span class="sd">        Output complete lines and split long lines and queue pending lines.</span>
<span class="sd">        Inserted newlines are always preceded by whitespace.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">endSentinelComment</span><span class="p">:</span>
            <span class="n">leading</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">indent</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">leading</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">indent</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">startSentinelComment</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span> <span class="ow">or</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">:</span>
            <span class="c"># A blank line.</span>
            <span class="n">at</span><span class="o">.</span><span class="n">putBlankDocLine</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">at</span><span class="o">.</span><span class="n">writeVersion5</span><span class="p">:</span>
            <span class="c">#@+&lt;&lt; write the line as is &gt;&gt;</span>
            <span class="c">#@+node:ekr.20100629190353.5831: *6* &lt;&lt; write the line as is &gt;&gt;</span>
            <span class="n">at</span><span class="o">.</span><span class="n">putIndent</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">indent</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">at</span><span class="o">.</span><span class="n">endSentinelComment</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">os</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">startSentinelComment</span><span class="p">)</span> <span class="p">;</span> <span class="n">at</span><span class="o">.</span><span class="n">oblank</span><span class="p">()</span>

            <span class="n">at</span><span class="o">.</span><span class="n">os</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">):</span> <span class="n">at</span><span class="o">.</span><span class="n">onl</span><span class="p">()</span>
            <span class="c">#@-&lt;&lt; write the line as is &gt;&gt;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c">#@+&lt;&lt; append words to pending line, splitting the line if needed &gt;&gt;</span>
            <span class="c">#@+node:ekr.20041005105605.184: *6* &lt;&lt; append words to pending line, splitting the line if needed &gt;&gt;</span>
            <span class="c">#@+at All inserted newlines are preceeded by whitespace:</span>
            <span class="c"># we remove trailing whitespace from lines that have not been split.</span>
            <span class="c">#@@c</span>

            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>

                <span class="c"># Scan to the next word.</span>
                <span class="n">word1</span> <span class="o">=</span> <span class="n">i</span> <span class="c"># Start of the current word.</span>
                <span class="n">word2</span> <span class="o">=</span> <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">):</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">word3</span> <span class="o">=</span> <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                <span class="c"># g.trace(s[word1:i])</span>

                <span class="k">if</span> <span class="n">leading</span> <span class="o">+</span> <span class="n">word3</span> <span class="o">-</span> <span class="n">word1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">pending</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="n">at</span><span class="o">.</span><span class="n">page_width</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">pending</span><span class="p">:</span>
                        <span class="c"># g.trace(&quot;splitting long line.&quot;)</span>
                        <span class="c"># Ouput the pending line, and start a new line.</span>
                        <span class="n">at</span><span class="o">.</span><span class="n">putPending</span><span class="p">(</span><span class="n">split</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                        <span class="n">at</span><span class="o">.</span><span class="n">pending</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="n">word2</span><span class="p">:</span><span class="n">word3</span><span class="p">]]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c"># Output a long word on a line by itself.</span>
                        <span class="c"># g.trace(&quot;long word:&quot;,s[word2:word3])</span>
                        <span class="n">at</span><span class="o">.</span><span class="n">pending</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="n">word2</span><span class="p">:</span><span class="n">word3</span><span class="p">]]</span>
                        <span class="n">at</span><span class="o">.</span><span class="n">putPending</span><span class="p">(</span><span class="n">split</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># Append the entire word to the pending line.</span>
                    <span class="c"># g.trace(&quot;appending&quot;,s[word1:word3])</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">pending</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">word1</span><span class="p">:</span><span class="n">word3</span><span class="p">])</span>

            <span class="c"># Output the remaining line: no more is left.</span>
            <span class="n">at</span><span class="o">.</span><span class="n">putPending</span><span class="p">(</span><span class="n">split</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="c">#@-&lt;&lt; append words to pending line, splitting the line if needed &gt;&gt;</span>
    <span class="c">#@+node:ekr.20041005105605.185: *5* putEndDocLine</span>
    <span class="k">def</span> <span class="nf">putEndDocLine</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.putEndDocLine"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.putEndDocLine">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Write the conclusion of a doc part.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">at</span><span class="o">.</span><span class="n">putPending</span><span class="p">(</span><span class="n">split</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="c"># Put the closing delimiter if we are using block comments.</span>
        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">endSentinelComment</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">putIndent</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">indent</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">os</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">endSentinelComment</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">onl</span><span class="p">()</span> <span class="c"># Note: no trailing whitespace.</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">writeVersion5</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c"># Never write @-doc or @-at sentinels.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sentinel</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">docKind</span> <span class="o">==</span> <span class="n">at</span><span class="o">.</span><span class="n">docDirective</span><span class="p">,</span><span class="s">&quot;@-doc&quot;</span><span class="p">,</span><span class="s">&quot;@-at&quot;</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">putSentinel</span><span class="p">(</span><span class="n">sentinel</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20041005105605.186: *5* putPending (old only)</span>
    <span class="k">def</span> <span class="nf">putPending</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">split</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.putPending"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.putPending">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Write the pending part of a doc part.</span>

<span class="sd">        We retain trailing whitespace iff the split flag is True.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">pending</span><span class="p">)</span> <span class="p">;</span> <span class="n">at</span><span class="o">.</span><span class="n">pending</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># g.trace(&quot;split&quot;,s)</span>

        <span class="c"># Remove trailing newline temporarily.  We&#39;ll add it back later.</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">split</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
                <span class="k">return</span>

        <span class="n">at</span><span class="o">.</span><span class="n">putIndent</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">indent</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">at</span><span class="o">.</span><span class="n">endSentinelComment</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">os</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">startSentinelComment</span><span class="p">)</span> <span class="p">;</span> <span class="n">at</span><span class="o">.</span><span class="n">oblank</span><span class="p">()</span>

        <span class="n">at</span><span class="o">.</span><span class="n">os</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="p">;</span> <span class="n">at</span><span class="o">.</span><span class="n">onl</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20041005105605.182: *5* putStartDocLine</span>
    <span class="k">def</span> <span class="nf">putStartDocLine</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">kind</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.putStartDocLine"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.putStartDocLine">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Write the start of a doc part.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">at</span><span class="o">.</span><span class="n">docKind</span> <span class="o">=</span> <span class="n">kind</span>

        <span class="n">sentinel</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">kind</span> <span class="o">==</span> <span class="n">at</span><span class="o">.</span><span class="n">docDirective</span><span class="p">,</span><span class="s">&quot;@+doc&quot;</span><span class="p">,</span><span class="s">&quot;@+at&quot;</span><span class="p">)</span>
        <span class="n">directive</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">kind</span> <span class="o">==</span> <span class="n">at</span><span class="o">.</span><span class="n">docDirective</span><span class="p">,</span><span class="s">&quot;@doc&quot;</span><span class="p">,</span><span class="s">&quot;@&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">writeVersion5</span><span class="p">:</span> <span class="c"># Put whatever follows the directive in the sentinel</span>
            <span class="c"># Skip past the directive.</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">directive</span><span class="p">)</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_to_end_of_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="n">follow</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>

            <span class="c"># Put the opening @+doc or @-doc sentinel, including whatever follows the directive.</span>
            <span class="n">at</span><span class="o">.</span><span class="n">putSentinel</span><span class="p">(</span><span class="n">sentinel</span> <span class="o">+</span> <span class="n">follow</span><span class="p">)</span>

            <span class="c"># Put the opening comment if we are using block comments.</span>
            <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">endSentinelComment</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">putIndent</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">indent</span><span class="p">)</span>
                <span class="n">at</span><span class="o">.</span><span class="n">os</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">startSentinelComment</span><span class="p">)</span> <span class="p">;</span> <span class="n">at</span><span class="o">.</span><span class="n">onl</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># old code.</span>
            <span class="c"># Skip past the directive.</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">directive</span><span class="p">)</span>

            <span class="c"># Get the trailing whitespace.</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="n">ws</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>

            <span class="c"># Put the opening @+doc or @-doc sentinel, including trailing whitespace.</span>
            <span class="n">at</span><span class="o">.</span><span class="n">putSentinel</span><span class="p">(</span><span class="n">sentinel</span> <span class="o">+</span> <span class="n">ws</span><span class="p">)</span>

            <span class="c"># Put the opening comment.</span>
            <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">endSentinelComment</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">putIndent</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">indent</span><span class="p">)</span>
                <span class="n">at</span><span class="o">.</span><span class="n">os</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">startSentinelComment</span><span class="p">)</span> <span class="p">;</span> <span class="n">at</span><span class="o">.</span><span class="n">onl</span><span class="p">()</span>

            <span class="c"># Put an @nonl sentinel if there is significant text following @doc or @.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">is_nl</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">j</span><span class="p">):</span>
                <span class="c"># Doesn&#39;t work if we are using block comments.</span>
                <span class="n">at</span><span class="o">.</span><span class="n">putSentinel</span><span class="p">(</span><span class="s">&quot;@nonl&quot;</span><span class="p">)</span>
                <span class="n">at</span><span class="o">.</span><span class="n">putDocLine</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20041005105605.187: *3* Writing 4,x sentinels...</span>
    <span class="c">#@+node:ekr.20041005105605.188: *4* nodeSentinelText 4.x</span>
    <span class="k">def</span> <span class="nf">nodeSentinelText</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.nodeSentinelText"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.nodeSentinelText">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Return the text of a @+node or @-node sentinel for p.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">h</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span>
        <span class="c">#@+&lt;&lt; remove comment delims from h if necessary &gt;&gt;</span>
        <span class="c">#@+node:ekr.20041005105605.189: *5* &lt;&lt; remove comment delims from h if necessary &gt;&gt;</span>
        <span class="c">#@+at Bug fix 1/24/03:</span>
        <span class="c"># </span>
        <span class="c"># If the present @language/@comment settings do not specify a single-line comment</span>
        <span class="c"># we remove all block comment delims from h. This prevents headline text from</span>
        <span class="c"># interfering with the parsing of node sentinels.</span>
        <span class="c">#@@c</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">startSentinelComment</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">endSentinelComment</span>

        <span class="k">if</span> <span class="n">end</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">end</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">end</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="c">#@-&lt;&lt; remove comment delims from h if necessary &gt;&gt;</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">thinFile</span><span class="p">:</span>
            <span class="n">gnx</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">nodeIndices</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">fileIndex</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">writeVersion5</span><span class="p">:</span>
                <span class="n">level</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">p</span><span class="o">.</span><span class="n">level</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">level</span><span class="p">()</span>
                <span class="n">stars</span> <span class="o">=</span> <span class="s">&#39;*&#39;</span> <span class="o">*</span> <span class="n">level</span>
                <span class="k">if</span> <span class="mi">1</span><span class="p">:</span> <span class="c"># Put the gnx in the traditional place.</span>
                    <span class="k">if</span> <span class="n">level</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">: *</span><span class="si">%s</span><span class="s">* </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gnx</span><span class="p">,</span><span class="n">level</span><span class="p">,</span><span class="n">h</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gnx</span><span class="p">,</span><span class="n">stars</span><span class="p">,</span><span class="n">h</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> <span class="c"># Hide the gnx to the right.</span>
                    <span class="n">pad</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">100</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">stars</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">))</span> <span class="o">*</span> <span class="s">&#39; &#39;</span>
                    <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s%s</span><span class="s">::</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">stars</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">pad</span><span class="p">,</span><span class="n">gnx</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gnx</span><span class="p">,</span><span class="n">h</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">h</span>
    <span class="c">#@+node:ekr.20041005105605.190: *4* putLeadInSentinel 4.x</span>
    <span class="k">def</span> <span class="nf">putLeadInSentinel</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">delta</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.putLeadInSentinel"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.putLeadInSentinel">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Generate @nonl sentinels as needed to ensure a newline before a group of sentinels.</span>

<span class="sd">        Set at.leadingWs as needed for @+others and @+&lt;&lt; sentinels.</span>

<span class="sd">        i points at the start of a line.</span>
<span class="sd">        j points at @others or a section reference.</span>
<span class="sd">        delta is the change in at.indent that is about to happen and hasn&#39;t happened yet.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">at</span><span class="o">.</span><span class="n">leadingWs</span> <span class="o">=</span> <span class="s">&quot;&quot;</span> <span class="c"># Set the default.</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
            <span class="k">return</span> <span class="c"># The @others or ref starts a line.</span>

        <span class="n">k</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">k</span><span class="p">:</span>
            <span class="c"># Only whitespace before the @others or ref.</span>
            <span class="n">at</span><span class="o">.</span><span class="n">leadingWs</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span> <span class="c"># Remember the leading whitespace, including its spelling.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># g.trace(&quot;indent&quot;,self.indent)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">putIndent</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">indent</span><span class="p">)</span> <span class="c"># 1/29/04: fix bug reported by Dan Winkler.</span>
            <span class="n">at</span><span class="o">.</span><span class="n">os</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">])</span> <span class="p">;</span> <span class="n">at</span><span class="o">.</span><span class="n">onl_sent</span><span class="p">()</span> <span class="c"># 10/21/03</span>
            <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">writeVersion5</span><span class="p">:</span>
                <span class="k">pass</span> <span class="c"># Never write @nonl sentinels.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">indent</span> <span class="o">+=</span> <span class="n">delta</span> <span class="c"># Align the @nonl with the following line.</span>
                <span class="n">at</span><span class="o">.</span><span class="n">putSentinel</span><span class="p">(</span><span class="s">&quot;@nonl&quot;</span><span class="p">)</span>
                <span class="n">at</span><span class="o">.</span><span class="n">indent</span> <span class="o">-=</span> <span class="n">delta</span> <span class="c"># Let the caller set at.indent permanently.</span>
    <span class="c">#@+node:ekr.20041005105605.191: *4* putCloseNodeSentinel 4.x</span>
    <span class="k">def</span> <span class="nf">putCloseNodeSentinel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">middle</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.putCloseNodeSentinel"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.putCloseNodeSentinel">[docs]</a>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">writeVersion5</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">raw</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># Bug fix: 2010/07/04</span>
            <span class="k">return</span> <span class="c"># Never write @-node or @-middle sentinels.</span>

        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodeSentinelText</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">middle</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">putSentinel</span><span class="p">(</span><span class="s">&quot;@-middle:&quot;</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">putSentinel</span><span class="p">(</span><span class="s">&quot;@-node:&quot;</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20041005105605.192: *4* putOpenLeoSentinel 4.x</span>
    <span class="k">def</span> <span class="nf">putOpenLeoSentinel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.putOpenLeoSentinel"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.putOpenLeoSentinel">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Write @+leo sentinel.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">at</span><span class="o">.</span><span class="n">sentinels</span><span class="p">:</span>
            <span class="k">return</span> <span class="c"># Handle @nosentinelsfile.</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">thinFile</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="s">&quot;-thin&quot;</span>

        <span class="n">encoding</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">encoding</span> <span class="o">!=</span> <span class="s">&quot;utf-8&quot;</span><span class="p">:</span>
            <span class="c"># New in 4.2: encoding fields end in &quot;,.&quot;</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="s">&quot;-encoding=</span><span class="si">%s</span><span class="s">,.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">encoding</span><span class="p">)</span>

        <span class="n">at</span><span class="o">.</span><span class="n">putSentinel</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20041005105605.193: *4* putOpenNodeSentinel</span>
    <span class="k">def</span> <span class="nf">putOpenNodeSentinel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">inAtAll</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">middle</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.putOpenNodeSentinel"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.putOpenNodeSentinel">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Write @+node sentinel for p.&quot;&quot;&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">inAtAll</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtFileNode</span><span class="p">()</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">at</span><span class="o">.</span><span class="n">root</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">at</span><span class="o">.</span><span class="n">toString</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">writeError</span><span class="p">(</span><span class="s">&quot;@file not valid in: &quot;</span> <span class="o">+</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c"># g.trace(at.thinFile,p)</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">nodeSentinelText</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">middle</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">putSentinel</span><span class="p">(</span><span class="s">&quot;@+middle:&quot;</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">putSentinel</span><span class="p">(</span><span class="s">&quot;@+node:&quot;</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span>

        <span class="c"># Leo 4.7 b2: we never write tnodeLists.</span>
    <span class="c">#@+node:ekr.20041005105605.194: *4* putSentinel (applies cweb hack) 4.x</span>
    <span class="c"># This method outputs all sentinels.</span>

    <span class="k">def</span> <span class="nf">putSentinel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.putSentinel"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.putSentinel">[docs]</a>
        <span class="s">&quot;Write a sentinel whose text is s, applying the CWEB hack if needed.&quot;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">at</span><span class="o">.</span><span class="n">sentinels</span><span class="p">:</span>
            <span class="k">return</span> <span class="c"># Handle @file-nosent</span>

        <span class="n">at</span><span class="o">.</span><span class="n">putIndent</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">indent</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">os</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">startSentinelComment</span><span class="p">)</span>
        <span class="c">#@+&lt;&lt; apply the cweb hack to s &gt;&gt;</span>
        <span class="c">#@+node:ekr.20041005105605.195: *5* &lt;&lt; apply the cweb hack to s &gt;&gt;</span>
        <span class="c">#@+at The cweb hack:</span>
        <span class="c"># </span>
        <span class="c"># If the opening comment delim ends in &#39;@&#39;, double all &#39;@&#39; signs except the first,</span>
        <span class="c"># which is &quot;doubled&quot; by the trailing &#39;@&#39; in the opening comment delimiter.</span>
        <span class="c">#@@c</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">startSentinelComment</span>
        <span class="k">if</span> <span class="n">start</span> <span class="ow">and</span> <span class="n">start</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;@&#39;</span><span class="p">:</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">s</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;@&#39;</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">,</span><span class="s">&#39;@@&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="c">#@-&lt;&lt; apply the cweb hack to s &gt;&gt;</span>
        <span class="n">at</span><span class="o">.</span><span class="n">os</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">endSentinelComment</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">os</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">endSentinelComment</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">onl</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20041005105605.196: *3* Writing 4.x utils...</span>
    <span class="c">#@+node:ekr.20090514111518.5661: *4* checkPythonCode (leoAtFile) &amp; helpers</span>
    <span class="k">def</span> <span class="nf">checkPythonCode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">root</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">targetFn</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.checkPythonCode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.checkPythonCode">[docs]</a>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">targetFn</span><span class="p">:</span> <span class="n">targetFn</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">targetFileName</span>

        <span class="k">if</span> <span class="n">targetFn</span> <span class="ow">and</span> <span class="n">targetFn</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.py&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">at</span><span class="o">.</span><span class="n">checkPythonCodeOnWrite</span><span class="p">:</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">s</span><span class="p">,</span><span class="n">e</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">readFileIntoString</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">outputFileName</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span>

            <span class="c"># It&#39;s too slow to check each node separately.</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">checkPythonSyntax</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>

            <span class="c"># Syntax checking catches most indentation problems.</span>
            <span class="k">if</span> <span class="bp">False</span> <span class="ow">and</span> <span class="n">ok</span><span class="p">:</span> <span class="n">at</span><span class="o">.</span><span class="n">tabNannyNode</span><span class="p">(</span><span class="n">root</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20090514111518.5663: *5* checkPythonSyntax (leoAtFile)</span>
    <span class="k">def</span> <span class="nf">checkPythonSyntax</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">body</span><span class="p">,</span><span class="n">supress</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.checkPythonSyntax"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.checkPythonSyntax">[docs]</a>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
                <span class="n">body</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
            <span class="n">body</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\r</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="s">&#39;&lt;node: </span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span>
            <span class="nb">compile</span><span class="p">(</span><span class="n">body</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span><span class="s">&#39;exec&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">SyntaxError</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">supress</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">syntaxError</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">body</span><span class="p">)</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&quot;unexpected exception&quot;</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">ok</span>
    <span class="c">#@+node:ekr.20090514111518.5666: *6* syntaxError (leoAtFile)</span>
    <span class="k">def</span> <span class="nf">syntaxError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">body</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.syntaxError"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.syntaxError">[docs]</a>
        <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Syntax error in: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">))</span>
        <span class="n">typ</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
        <span class="n">message</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="s">&#39;message&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">val</span><span class="o">.</span><span class="n">message</span>
        <span class="k">if</span> <span class="n">message</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">lineno</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">offset</span> <span class="ow">or</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span><span class="k">return</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">lineno</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">3</span><span class="p">),</span><span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%5s</span><span class="s">:</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">j</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">j</span><span class="o">==</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;*&#39;</span><span class="p">,</span><span class="s">&#39; &#39;</span><span class="p">),</span><span class="n">lines</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()))</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">i</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="o">*</span><span class="p">(</span><span class="mi">7</span><span class="o">+</span><span class="n">offset</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;^&#39;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20090514111518.5665: *5* tabNannyNode (leoAtFile)</span>
    <span class="k">def</span> <span class="nf">tabNannyNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">body</span><span class="p">,</span><span class="n">suppress</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.tabNannyNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.tabNannyNode">[docs]</a>
        <span class="kn">import</span> <span class="nn">parser</span><span class="o">,</span><span class="nn">tabnanny</span><span class="o">,</span><span class="nn">tokenize</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">readline</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">readLinesClass</span><span class="p">(</span><span class="n">body</span><span class="p">)</span><span class="o">.</span><span class="n">next</span>
            <span class="n">tabnanny</span><span class="o">.</span><span class="n">process_tokens</span><span class="p">(</span><span class="n">tokenize</span><span class="o">.</span><span class="n">generate_tokens</span><span class="p">(</span><span class="n">readline</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">parser</span><span class="o">.</span><span class="n">ParserError</span><span class="p">:</span>
            <span class="n">junk</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">junk</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">suppress</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;ParserError in&quot;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">IndentationError</span><span class="p">:</span>
            <span class="n">junk</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">junk</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">suppress</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;IndentationError in&quot;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">tokenize</span><span class="o">.</span><span class="n">TokenError</span><span class="p">:</span>
            <span class="n">junk</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">junk</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">suppress</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;TokenError in&quot;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">tabnanny</span><span class="o">.</span><span class="n">NannyNag</span><span class="p">:</span>
            <span class="n">junk</span><span class="p">,</span> <span class="n">nag</span><span class="p">,</span> <span class="n">junk</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">suppress</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">badline</span> <span class="o">=</span> <span class="n">nag</span><span class="o">.</span><span class="n">get_lineno</span><span class="p">()</span>
                <span class="n">line</span>    <span class="o">=</span> <span class="n">nag</span><span class="o">.</span><span class="n">get_line</span><span class="p">()</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">nag</span><span class="o">.</span><span class="n">get_msg</span><span class="p">()</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;indentation error in&quot;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="s">&quot;line&quot;</span><span class="p">,</span><span class="n">badline</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="n">line2</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="p">))[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;offending line:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">line2</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&quot;unexpected exception&quot;</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">suppress</span><span class="p">:</span> <span class="k">raise</span>
    <span class="c">#@+node:ekr.20080712150045.3: *4* closeStringFile</span>
    <span class="k">def</span> <span class="nf">closeStringFile</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">theFile</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.closeStringFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.closeStringFile">[docs]</a>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">theFile</span><span class="p">:</span>
            <span class="n">theFile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">stringOutput</span> <span class="o">=</span> <span class="n">theFile</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">theFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">at</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="c"># at.outputFileName = u&#39;&#39;</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">outputFileName</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">outputFileName</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>

            <span class="n">at</span><span class="o">.</span><span class="n">shortFileName</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="n">at</span><span class="o">.</span><span class="n">targetFileName</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">return</span> <span class="n">s</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20041005105605.135: *4* closeWriteFile</span>
    <span class="c"># 4.0: Don&#39;t use newline-pending logic.</span>

    <span class="k">def</span> <span class="nf">closeWriteFile</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.closeWriteFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.closeWriteFile">[docs]</a>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">outputFile</span><span class="p">:</span>
            <span class="c"># g.trace(&#39;**closing&#39;,at.outputFileName,at.outputFile)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">outputFile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">toString</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">stringOutput</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">outputFile</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">at</span><span class="o">.</span><span class="n">outputFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">at</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">return</span> <span class="n">at</span><span class="o">.</span><span class="n">stringOutput</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20041005105605.197: *4* compareFiles</span>
    <span class="k">def</span> <span class="nf">compareFiles</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">path1</span><span class="p">,</span><span class="n">path2</span><span class="p">,</span><span class="n">ignoreLineEndings</span><span class="p">,</span><span class="n">ignoreBlankLines</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.compareFiles"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.compareFiles">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Compare two text files.&quot;&quot;&quot;</span>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># We can&#39;t use &#39;U&#39; mode because of encoding issues (Python 2.x only).</span>
        <span class="n">s1</span><span class="p">,</span><span class="n">e</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">readFileIntoString</span><span class="p">(</span><span class="n">path1</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s">&#39;rb&#39;</span><span class="p">,</span><span class="n">raw</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s1</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">internalError</span><span class="p">(</span><span class="s">&#39;empty compare file: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">path1</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">s2</span><span class="p">,</span><span class="n">e</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">readFileIntoString</span><span class="p">(</span><span class="n">path2</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s">&#39;rb&#39;</span><span class="p">,</span><span class="n">raw</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s2</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">internalError</span><span class="p">(</span><span class="s">&#39;empty compare file: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">path2</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">equal</span> <span class="o">=</span> <span class="n">s1</span> <span class="o">==</span> <span class="n">s2</span>

        <span class="c"># 2010/03/29: Make sure both strings are unicode.</span>
        <span class="c"># This is requred to handle binary files in Python 3.x.</span>
        <span class="n">s1</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicode</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="n">at</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicode</span><span class="p">(</span><span class="n">s2</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="n">at</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ignoreBlankLines</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">equal</span><span class="p">:</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">removeBlankLines</span><span class="p">(</span><span class="n">s1</span><span class="p">)</span>
            <span class="n">s2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">removeBlankLines</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span>
            <span class="n">equal</span> <span class="o">=</span> <span class="n">s1</span> <span class="o">==</span> <span class="n">s2</span>

        <span class="k">if</span> <span class="n">ignoreLineEndings</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">equal</span><span class="p">:</span>
            <span class="c"># Wrong: equivalent to ignoreBlankLines!</span>
                <span class="c"># s1 = s1.replace(&#39;\n&#39;,&#39;&#39;).replace(&#39;\r&#39;,&#39;&#39;)</span>
                <span class="c"># s2 = s2.replace(&#39;\n&#39;,&#39;&#39;).replace(&#39;\r&#39;,&#39;&#39;)</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="n">s1</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\r</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="n">s2</span> <span class="o">=</span> <span class="n">s2</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\r</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="n">equal</span> <span class="o">=</span> <span class="n">s1</span> <span class="o">==</span> <span class="n">s2</span>
        <span class="c"># g.trace(&#39;equal&#39;,equal,&#39;ignoreLineEndings&#39;,ignoreLineEndings,&#39;encoding&#39;,at.encoding)</span>
        <span class="k">return</span> <span class="n">equal</span>
    <span class="c">#@+node:ekr.20041005105605.198: *4* directiveKind4 (write logic)</span>
    <span class="k">def</span> <span class="nf">directiveKind4</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.directiveKind4"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.directiveKind4">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Return the kind of at-directive or noDirective.&quot;&quot;&quot;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">):</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">n</span> <span class="ow">or</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;@&#39;</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="s">&quot;@others&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">at</span><span class="o">.</span><span class="n">othersDirective</span>
            <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="s">&quot;@all&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">at</span><span class="o">.</span><span class="n">allDirective</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">at</span><span class="o">.</span><span class="n">noDirective</span>

        <span class="n">table</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="s">&quot;@all&quot;</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">allDirective</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;@c&quot;</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">cDirective</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;@code&quot;</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">codeDirective</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;@doc&quot;</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">docDirective</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;@end_raw&quot;</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">endRawDirective</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;@others&quot;</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">othersDirective</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;@raw&quot;</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">rawDirective</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;@verbatim&quot;</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">startVerbatim</span><span class="p">))</span>

        <span class="c"># Rewritten 6/8/2005.</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">n</span> <span class="ow">or</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">):</span>
            <span class="c"># Bare &#39;@&#39; not recognized in cweb mode.</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">language</span><span class="o">==</span><span class="s">&quot;cweb&quot;</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">noDirective</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">atDirective</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isalpha</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">at</span><span class="o">.</span><span class="n">noDirective</span> <span class="c"># Bug fix: do NOT return miscDirective here!</span>
        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">language</span><span class="o">==</span><span class="s">&quot;cweb&quot;</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;@c&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">at</span><span class="o">.</span><span class="n">noDirective</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">directive</span> <span class="ow">in</span> <span class="n">table</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">directive</span>

        <span class="c"># New in Leo 4.4.3: add support for add_directives plugin.</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">globalDirectiveList</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">at</span><span class="o">.</span><span class="n">miscDirective</span>

        <span class="k">return</span> <span class="n">at</span><span class="o">.</span><span class="n">noDirective</span>
    <span class="c">#@+node:ekr.20041005105605.199: *4* at.findSectionName</span>
    <span class="k">def</span> <span class="nf">findSectionName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.findSectionName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.findSectionName">[docs]</a>
        <span class="n">end</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">end</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">n1</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;&lt;&lt;&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="n">n2</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;&gt;&gt;&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n1</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;&lt;&lt;&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">end</span><span class="p">)</span>
            <span class="n">n2</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;&gt;&gt;&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">end</span><span class="p">)</span>

        <span class="n">ok</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">n1</span> <span class="o">&lt;</span> <span class="n">n2</span>

        <span class="c"># New in Leo 4.4.3: warn on extra brackets.</span>
        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ch</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="p">((</span><span class="s">&#39;&lt;&#39;</span><span class="p">,</span><span class="n">n1</span><span class="o">+</span><span class="mi">2</span><span class="p">),(</span><span class="s">&#39;&gt;&#39;</span><span class="p">,</span><span class="n">n2</span><span class="o">+</span><span class="mi">2</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">ch</span><span class="p">):</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;dubious brackets in&#39;</span><span class="p">,</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">break</span>

        <span class="k">return</span> <span class="n">ok</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span>
    <span class="c">#@+node:ekr.20041005105605.200: *4* at.isSectionName</span>
    <span class="c"># returns (flag, end). end is the index of the character after the section name.</span>

    <span class="k">def</span> <span class="nf">isSectionName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.isSectionName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.isSectionName">[docs]</a>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;&lt;&lt;&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">find_on_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;&gt;&gt;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
    <span class="c">#@+node:ekr.20070909103844: *4* isSignificantTree</span>
    <span class="k">def</span> <span class="nf">isSignificantTree</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.isSignificantTree"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.isSignificantTree">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Return True if p&#39;s tree has a significant amount of information.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span>

        <span class="c"># Remove all blank lines and all Leo directives.</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span> <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_id</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">chars</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">)</span>
                <span class="n">word</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">word</span> <span class="ow">and</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">globalDirectiveList</span><span class="p">):</span>
                    <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="n">s2</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">hasChildren</span><span class="p">()</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">s2</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="o">&gt;=</span> <span class="mi">10</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">val</span>
    <span class="c">#@+node:ekr.20080712150045.2: *4* at.openStringFile</span>
    <span class="k">def</span> <span class="nf">openStringFile</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.openStringFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.openStringFile">[docs]</a>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">at</span><span class="o">.</span><span class="n">shortFileName</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">outputFileName</span> <span class="o">=</span> <span class="s">&quot;&lt;string: </span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="n">at</span><span class="o">.</span><span class="n">shortFileName</span>
        <span class="n">at</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">fileLikeObject</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">targetFileName</span> <span class="o">=</span> <span class="s">&quot;&lt;string-file&gt;&quot;</span>

        <span class="k">return</span> <span class="n">at</span><span class="o">.</span><span class="n">outputFile</span>
    <span class="c">#@+node:ekr.20041005105605.201: *4* os and allies</span>
    <span class="c"># Note:  self.outputFile may be either a fileLikeObject or a real file.</span>
    <span class="c">#@+node:ekr.20041005105605.202: *5* oblank, oblanks &amp; otabs</span>
    <span class="k">def</span> <span class="nf">oblank</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.oblank"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.oblank">[docs]</a>        <span class="bp">self</span><span class="o">.</span><span class="n">os</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">oblanks</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.oblanks"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.oblanks">[docs]</a>        <span class="bp">self</span><span class="o">.</span><span class="n">os</span><span class="p">(</span><span class="s">&#39; &#39;</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">otabs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.otabs"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.otabs">[docs]</a>        <span class="bp">self</span><span class="o">.</span><span class="n">os</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20041005105605.203: *5* onl &amp; onl_sent</span>
    <span class="k">def</span> <span class="nf">onl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.onl"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.onl">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Write a newline to the output stream.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">os</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_newline</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">onl_sent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.onl_sent"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.onl_sent">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Write a newline to the output stream, provided we are outputting sentinels.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sentinels</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">onl</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20041005105605.204: *5* os</span>
    <span class="k">def</span> <span class="nf">os</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.os"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.os">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Write a string to the output stream.</span>

<span class="sd">        All output produced by leoAtFile module goes here.&quot;&quot;&quot;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">underindentEscapeString</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">outputFile</span>

        <span class="k">if</span> <span class="n">s</span> <span class="ow">and</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">tag</span><span class="p">):</span>
                    <span class="n">junk</span><span class="p">,</span><span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseUnderindentTag</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="c"># at.outputFile is a fileLikeObject.</span>
                <span class="c"># Bug fix: this must be done last.</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span><span class="n">reportErrors</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="c"># ,g.callers(5))</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&quot;exception writing:&quot;</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20041005105605.205: *4* outputStringWithLineEndings</span>
    <span class="c"># Write the string s as-is except that we replace &#39;\n&#39; with the proper line ending.</span>

    <span class="k">def</span> <span class="nf">outputStringWithLineEndings</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.outputStringWithLineEndings"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.outputStringWithLineEndings">[docs]</a>        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># Calling self.onl() runs afoul of queued newlines.</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">ue</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="n">at</span><span class="o">.</span><span class="n">output_newline</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">os</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="c">#@+node:ekr.20050506090446.1: *4* putAtFirstLines</span>
    <span class="k">def</span> <span class="nf">putAtFirstLines</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.putAtFirstLines"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.putAtFirstLines">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Write any @firstlines from string s.</span>
<span class="sd">        These lines are converted to @verbatim lines,</span>
<span class="sd">        so the read logic simply ignores lines preceding the @+leo sentinel.&#39;&#39;&#39;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">tag</span> <span class="o">=</span> <span class="s">&quot;@first&quot;</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">tag</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_to_end_of_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="c"># Write @first line, whether empty or not</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">i</span><span class="p">]</span>
            <span class="n">at</span><span class="o">.</span><span class="n">os</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="p">;</span> <span class="n">at</span><span class="o">.</span><span class="n">onl</span><span class="p">()</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_nl</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050506090955: *4* putAtLastLines</span>
    <span class="k">def</span> <span class="nf">putAtLastLines</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.putAtLastLines"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.putAtLastLines">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Write any @last lines from string s.</span>
<span class="sd">        These lines are converted to @verbatim lines,</span>
<span class="sd">        so the read logic simply ignores lines following the @-leo sentinel.&#39;&#39;&#39;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">tag</span> <span class="o">=</span> <span class="s">&quot;@last&quot;</span>

        <span class="c"># Use g.splitLines to preserve trailing newlines.</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="p">;</span> <span class="n">j</span> <span class="o">=</span> <span class="n">k</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="c"># Scan backwards for @last directives.</span>
        <span class="k">while</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">tag</span><span class="p">):</span> <span class="n">j</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">j</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">break</span>

        <span class="c"># Write the @last lines.</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">tag</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span> <span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                <span class="n">at</span><span class="o">.</span><span class="n">os</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">:])</span>
    <span class="c">#@+node:ekr.20071117152308: *4* putBuffered</span>
    <span class="k">def</span> <span class="nf">putBuffered</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.putBuffered"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.putBuffered">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Put s, converting all tabs to blanks as necessary.&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tab_width</span>
        <span class="k">if</span> <span class="n">w</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">line2</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">;</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">:</span>
                        <span class="n">w2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">computeWidth</span><span class="p">(</span><span class="n">s</span><span class="p">[:</span><span class="n">j</span><span class="p">],</span><span class="n">w</span><span class="p">)</span>
                        <span class="n">w3</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">w2</span> <span class="o">%</span> <span class="nb">abs</span><span class="p">(</span><span class="n">w</span><span class="p">)))</span>
                        <span class="n">line2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39; &#39;</span> <span class="o">*</span> <span class="n">w3</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">line2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line2</span><span class="p">))</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">os</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20041005105605.206: *4* putDirective  (handles @delims,@comment,@language) 4.x</span>
    <span class="c">#@+at It is important for PHP and other situations that \@first</span>
    <span class="c"># and \@last directives get translated to verbatim lines that</span>
    <span class="c"># do _not_ include what follows the @first &amp; @last directives.</span>
    <span class="c">#@@c</span>

    <span class="k">def</span> <span class="nf">putDirective</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.putDirective"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.putDirective">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Output a sentinel a directive or reference s.&quot;&quot;&quot;</span>

        <span class="n">tag</span> <span class="o">=</span> <span class="s">&quot;@delims&quot;</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;@&#39;</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">i</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_to_end_of_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="n">directive</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="s">&quot;@delims&quot;</span><span class="p">):</span>
            <span class="c">#@+&lt;&lt; handle @delims &gt;&gt;</span>
            <span class="c">#@+node:ekr.20041005105605.207: *5* &lt;&lt; handle @delims &gt;&gt;</span>
            <span class="c"># Put a space to protect the last delim.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">putSentinel</span><span class="p">(</span><span class="n">directive</span> <span class="o">+</span> <span class="s">&quot; &quot;</span><span class="p">)</span> <span class="c"># 10/23/02: put @delims, not @@delims</span>

            <span class="c"># Skip the keyword and whitespace.</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">tag</span><span class="p">))</span>

            <span class="c"># Get the first delim.</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">is_ws</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">is_nl</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">startSentinelComment</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">i</span><span class="p">]</span>
                <span class="c"># Get the optional second delim.</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">is_ws</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">is_nl</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">endSentinelComment</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">j</span><span class="o">&lt;</span><span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">i</span><span class="p">],</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeError</span><span class="p">(</span><span class="s">&quot;Bad @delims directive&quot;</span><span class="p">)</span>
            <span class="c">#@-&lt;&lt; handle @delims &gt;&gt;</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="s">&quot;@language&quot;</span><span class="p">):</span>
            <span class="c">#@+&lt;&lt; handle @language &gt;&gt;</span>
            <span class="c">#@+node:ekr.20041005105605.208: *5* &lt;&lt; handle @language &gt;&gt;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">putSentinel</span><span class="p">(</span><span class="s">&quot;@&quot;</span> <span class="o">+</span> <span class="n">directive</span><span class="p">)</span>

            <span class="k">if</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># Bug fix: Leo 4.4.1</span>
                <span class="c"># Do not scan the @language directive here!</span>
                <span class="c"># These ivars have already been scanned by the init code.</span>

                <span class="c"># Skip the keyword and whitespace.</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="s">&quot;@language&quot;</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_c_id</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                <span class="n">language</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>

                <span class="n">delim1</span><span class="p">,</span><span class="n">delim2</span><span class="p">,</span><span class="n">delim3</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">set_delims_from_language</span><span class="p">(</span><span class="n">language</span><span class="p">)</span>

                <span class="c"># g.trace(delim1,delim2,delim3)</span>

                <span class="c"># Returns a tuple (single,start,end) of comment delims</span>
                <span class="k">if</span> <span class="n">delim1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">startSentinelComment</span> <span class="o">=</span> <span class="n">delim1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">endSentinelComment</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
                <span class="k">elif</span> <span class="n">delim2</span> <span class="ow">and</span> <span class="n">delim3</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">startSentinelComment</span> <span class="o">=</span> <span class="n">delim2</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">endSentinelComment</span> <span class="o">=</span> <span class="n">delim3</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;ignoring bad @language directive:&quot;</span><span class="p">,</span><span class="n">line</span><span class="p">)</span>
            <span class="c">#@-&lt;&lt; handle @language &gt;&gt;</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="s">&quot;@comment&quot;</span><span class="p">):</span>
            <span class="c">#@+&lt;&lt; handle @comment &gt;&gt;</span>
            <span class="c">#@+node:ekr.20041005105605.209: *5* &lt;&lt; handle @comment &gt;&gt;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">putSentinel</span><span class="p">(</span><span class="s">&quot;@&quot;</span> <span class="o">+</span> <span class="n">directive</span><span class="p">)</span>

            <span class="k">if</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># Bug fix: Leo 4.4.1</span>
                <span class="c"># Do not scan the @comment directive here!</span>
                <span class="c"># These ivars have already been scanned by the init code.</span>

                <span class="c"># g.trace(delim1,delim2,delim3)</span>

                <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>
                <span class="n">delim1</span><span class="p">,</span><span class="n">delim2</span><span class="p">,</span><span class="n">delim3</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">set_delims_from_string</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

                <span class="c"># Returns a tuple (single,start,end) of comment delims</span>
                <span class="k">if</span> <span class="n">delim1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">startSentinelComment</span> <span class="o">=</span> <span class="n">delim1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">endSentinelComment</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">elif</span> <span class="n">delim2</span> <span class="ow">and</span> <span class="n">delim3</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">startSentinelComment</span> <span class="o">=</span> <span class="n">delim2</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">endSentinelComment</span> <span class="o">=</span> <span class="n">delim3</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;ignoring bad @comment directive:&quot;</span><span class="p">,</span><span class="n">line</span><span class="p">)</span>
            <span class="c">#@-&lt;&lt; handle @comment &gt;&gt;</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="s">&quot;@last&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">putSentinel</span><span class="p">(</span><span class="s">&quot;@@last&quot;</span><span class="p">)</span> <span class="c"># 10/27/03: Convert to an verbatim line _without_ anything else.</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="s">&quot;@first&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">putSentinel</span><span class="p">(</span><span class="s">&quot;@@first&quot;</span><span class="p">)</span> <span class="c"># 10/27/03: Convert to an verbatim line _without_ anything else.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">putSentinel</span><span class="p">(</span><span class="s">&quot;@&quot;</span> <span class="o">+</span> <span class="n">directive</span><span class="p">)</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">i</span>
    <span class="c">#@+node:ekr.20041005105605.210: *4* putIndent</span>
    <span class="k">def</span> <span class="nf">putIndent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.putIndent"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.putIndent">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Put tabs and spaces corresponding to n spaces,</span>
<span class="sd">        assuming that we are at the start of a line.</span>

<span class="sd">        Remove extra blanks if the line starts with the underindentEscapeString&quot;&quot;&quot;</span>

        <span class="c"># g.trace(repr(s))</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">underindentEscapeString</span>

        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">tag</span><span class="p">):</span>
            <span class="n">n2</span><span class="p">,</span><span class="n">s2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseUnderindentTag</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">n2</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">:</span> <span class="k">return</span>
            <span class="k">elif</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">n</span> <span class="o">-=</span> <span class="n">n2</span>
            <span class="k">else</span><span class="p">:</span>       <span class="n">n</span> <span class="o">+=</span> <span class="n">n2</span>

        <span class="c">### if n != 0:</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tab_width</span>
            <span class="k">if</span> <span class="n">w</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">q</span><span class="p">,</span><span class="n">r</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">w</span><span class="p">)</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">otabs</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">oblanks</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">oblanks</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20041005105605.211: *4* putInitialComment</span>
    <span class="k">def</span> <span class="nf">putInitialComment</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.putInitialComment"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.putInitialComment">[docs]</a>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">output_initial_comment</span>
        <span class="k">if</span> <span class="n">s2</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">s2</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">n&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;@date&quot;</span><span class="p">,</span><span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">())</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">putSentinel</span><span class="p">(</span><span class="s">&quot;@comment &quot;</span> <span class="o">+</span> <span class="n">line</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20080712150045.1: *4* replaceFileWithString (atFile)</span>
    <span class="k">def</span> <span class="nf">replaceFileWithString</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span><span class="n">s</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.replaceFileWithString"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.replaceFileWithString">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Replace the file with s if s is different from theFile&#39;s contents.</span>

<span class="sd">        Return True if theFile was changed.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">exists</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">exists</span><span class="p">:</span> <span class="c"># Read the file.  Return if it is the same.</span>
            <span class="n">s2</span><span class="p">,</span><span class="n">e</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">readFileIntoString</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="n">s2</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;unchanged:&#39;</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>

        <span class="c"># Issue warning if directory does not exist.</span>
        <span class="n">theDir</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_dirname</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">theDir</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">theDir</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;not written: </span><span class="si">%s</span><span class="s"> directory not found&#39;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="c"># Replace</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="s">&#39;wb&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;*****&#39;</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">exists</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;wrote:    &#39;</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;created:&#39;</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;unexpected exception writing file: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fn</span><span class="p">))</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20041005105605.212: *4* replaceTargetFileIfDifferent (atFile)</span>
    <span class="k">def</span> <span class="nf">replaceTargetFileIfDifferent</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">root</span><span class="p">,</span><span class="n">ignoreBlankLines</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.replaceTargetFileIfDifferent"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.replaceTargetFileIfDifferent">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Create target file as follows:</span>
<span class="sd">        1. If target file does not exist, rename output file to target file.</span>
<span class="sd">        2. If target file is identical to output file, remove the output file.</span>
<span class="sd">        3. If target file is different from output file,</span>
<span class="sd">           remove target file, then rename output file to be target file.</span>

<span class="sd">        Return True if the original file was changed.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">at</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">atFileCommands</span>

        <span class="k">assert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">toString</span><span class="p">:</span>
            <span class="c"># Do *not* change the actual file or set any dirty flag.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fileChangedFlag</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">root</span><span class="p">:</span>
            <span class="c"># The default: may be changed later.</span>
            <span class="n">root</span><span class="o">.</span><span class="n">clearOrphan</span><span class="p">()</span>
            <span class="n">root</span><span class="o">.</span><span class="n">clearDirty</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span>
            <span class="s">&#39;ignoreBlankLines&#39;</span><span class="p">,</span><span class="n">ignoreBlankLines</span><span class="p">,</span>
            <span class="s">&#39;target exists&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targetFileName</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputFileName</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">targetFileName</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targetFileName</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compareFiles</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputFileName</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">targetFileName</span><span class="p">,</span>
                <span class="n">ignoreLineEndings</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">explicitLineEnding</span><span class="p">,</span>
                <span class="n">ignoreBlankLines</span><span class="o">=</span><span class="n">ignoreBlankLines</span><span class="p">):</span>
                <span class="c"># Files are identical.</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputFileName</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;files are identical&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;unchanged:&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;error writing&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">)</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;not written:&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">root</span><span class="p">:</span>
                        <span class="n">root</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span> <span class="c"># New in 4.4.8.</span>
                        <span class="n">root</span><span class="o">.</span><span class="n">setOrphan</span><span class="p">()</span> <span class="c"># 2010/10/22.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fileChangedFlag</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># A mismatch.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">checkPythonCode</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
                <span class="c">#@+&lt;&lt; report if the files differ only in line endings &gt;&gt;</span>
                <span class="c">#@+node:ekr.20041019090322: *5* &lt;&lt; report if the files differ only in line endings &gt;&gt;</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">explicitLineEnding</span> <span class="ow">and</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">compareFiles</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">outputFileName</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">targetFileName</span><span class="p">,</span>
                        <span class="n">ignoreLineEndings</span><span class="o">=</span><span class="bp">True</span><span class="p">)):</span>

                    <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;correcting line endings in:&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">targetFileName</span><span class="p">)</span>
                <span class="c">#@-&lt;&lt; report if the files differ only in line endings &gt;&gt;</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targetFileName</span><span class="p">)</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputFileName</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">targetFileName</span><span class="p">,</span><span class="n">mode</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">setFileTimeStamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targetFileName</span><span class="p">)</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;wrote:&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;error writing&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">)</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;not written:&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">root</span><span class="p">:</span>
                        <span class="n">root</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span> <span class="c"># New in 4.4.8.</span>
                        <span class="n">root</span><span class="o">.</span><span class="n">setOrphan</span><span class="p">()</span> <span class="c"># 2010/10/22.</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">fileChangedFlag</span> <span class="o">=</span> <span class="n">ok</span>
                <span class="k">return</span> <span class="n">ok</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Rename the output file.</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputFileName</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">targetFileName</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">setFileTimeStamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targetFileName</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;created:&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">targetFileName</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">root</span><span class="p">:</span>
                    <span class="c"># Fix bug 889175: Remember the full fileName.</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">rememberReadPath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targetFileName</span><span class="p">,</span><span class="n">root</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># self.rename gives the error.</span>
                <span class="k">if</span> <span class="n">root</span><span class="p">:</span>
                    <span class="n">root</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span> <span class="c"># New in 4.4.8.</span>
                    <span class="n">root</span><span class="o">.</span><span class="n">setOrphan</span><span class="p">()</span> <span class="c"># 2010/10/22.</span>

            <span class="c"># No original file to change. Return value tested by a unit test.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fileChangedFlag</span> <span class="o">=</span> <span class="bp">False</span> 
            <span class="k">return</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20041005105605.216: *4* at.warnAboutOrpanAndIgnoredNodes</span>
    <span class="c"># Called from writeOpenFile.</span>

    <span class="k">def</span> <span class="nf">warnAboutOrphandAndIgnoredNodes</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.warnAboutOrphandAndIgnoredNodes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.warnAboutOrphandAndIgnoredNodes">[docs]</a>
        <span class="c"># Always warn, even when language==&quot;cweb&quot;</span>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">root</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">root</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span> <span class="k">return</span> <span class="c"># No need to repeat this.</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">self_and_subtree</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">isVisited</span><span class="p">():</span>
                <span class="n">at</span><span class="o">.</span><span class="n">writeError</span><span class="p">(</span><span class="s">&quot;Orphan node:  &quot;</span> <span class="o">+</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">hasParent</span><span class="p">():</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&quot;parent node:&quot;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">at</span><span class="o">.</span><span class="n">thinFile</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtIgnoreNode</span><span class="p">():</span>
                    <span class="n">at</span><span class="o">.</span><span class="n">writeError</span><span class="p">(</span><span class="s">&quot;@ignore node: &quot;</span> <span class="o">+</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">thinFile</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="p">;</span> <span class="n">after</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">nodeAfterTree</span><span class="p">()</span>
            <span class="k">while</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">after</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtAllNode</span><span class="p">():</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtIgnoreNode</span><span class="p">():</span>
                        <span class="n">at</span><span class="o">.</span><span class="n">writeError</span><span class="p">(</span><span class="s">&quot;@ignore node: &quot;</span> <span class="o">+</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20041005105605.217: *4* writeError</span>
    <span class="k">def</span> <span class="nf">writeError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">message</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.writeError"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.writeError">[docs]</a>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># Don&#39;t give errors for this particular file during unit testing.</span>
        <span class="n">h</span> <span class="o">=</span> <span class="s">&#39;nonexistent-directory/orphan-bit-test.txt&#39;</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span> <span class="ow">and</span> <span class="n">at</span><span class="o">.</span><span class="n">targetFileName</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
            <span class="n">at</span><span class="o">.</span><span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">errors</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es_error</span><span class="p">(</span><span class="s">&quot;errors writing: &quot;</span> <span class="o">+</span> <span class="n">at</span><span class="o">.</span><span class="n">targetFileName</span><span class="p">)</span>
                <span class="c"># g.trace(g.callers(5))</span>
            <span class="n">at</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="n">at</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span>
        <span class="n">at</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">setOrphan</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20041005105605.218: *4* writeException</span>
    <span class="k">def</span> <span class="nf">writeException</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">root</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span> <span class="c"># changed 11.</span></div>
<div class="viewcode-block" id="atFile.writeException"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.writeException">[docs]</a>
        <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;exception writing:&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">targetFileName</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFileName</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputFileName</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">root</span><span class="p">:</span>
            <span class="c"># Make sure we try to rewrite this file.</span>
            <span class="n">root</span><span class="o">.</span><span class="n">setOrphan</span><span class="p">()</span>
            <span class="n">root</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20041005105605.219: ** at.Utilites</span>
    <span class="c">#@+node:ekr.20041005105605.220: *3* at.error &amp; printError</span>
    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.error"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.error">[docs]</a>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="bp">True</span><span class="p">:</span> <span class="c"># args:</span>
            <span class="n">at</span><span class="o">.</span><span class="n">printError</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">printError</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.printError"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.printError">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Print an error message that may contain non-ascii characters.&#39;&#39;&#39;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="c"># keys = {&#39;color&#39;: g.choose(at.errors,&#39;blue&#39;,&#39;red&#39;)}</span>
        <span class="c"># g.es_print_error(*args,**keys)</span>
        <span class="k">if</span> <span class="n">at</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20041005105605.221: *3* at.exception</span>
    <span class="k">def</span> <span class="nf">exception</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">message</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.exception"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.exception">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20050104131929: *3* at.file operations...</span>
    <span class="c">#@+at The difference, if any, between these methods and the corresponding g.utils_x</span>
    <span class="c"># functions is that these methods may call self.error.</span>
    <span class="c">#@+node:ekr.20050104131820: *4* chmod</span>
    <span class="k">def</span> <span class="nf">chmod</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span><span class="n">mode</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.chmod"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.chmod">[docs]</a>
        <span class="c"># Do _not_ call self.error here.</span>
        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">utils_chmod</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">mode</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050104131929.1: *4* atFile.rename</span>
    <span class="c">#@+&lt;&lt; about os.rename &gt;&gt;</span>
    <span class="c">#@+node:ekr.20050104131929.2: *5* &lt;&lt; about os.rename &gt;&gt;</span>
    <span class="c">#@+at Here is the Python 2.4 documentation for rename (same as Python 2.3)</span>
    <span class="c"># </span>
    <span class="c"># Rename the file or directory src to dst.  If dst is a directory, OSError will be raised.</span>
    <span class="c"># </span>
    <span class="c"># On Unix, if dst exists and is a file, it will be removed silently if the user</span>
    <span class="c"># has permission. The operation may fail on some Unix flavors if src and dst are</span>
    <span class="c"># on different filesystems. If successful, the renaming will be an atomic</span>
    <span class="c"># operation (this is a POSIX requirement).</span>
    <span class="c"># </span>
    <span class="c"># On Windows, if dst already exists, OSError will be raised even if it is a file;</span>
    <span class="c"># there may be no way to implement an atomic rename when dst names an existing</span>
    <span class="c"># file.</span>
    <span class="c">#@-&lt;&lt; about os.rename &gt;&gt;</span>

    <span class="k">def</span> <span class="nf">rename</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">src</span><span class="p">,</span><span class="n">dst</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.rename"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.rename">[docs]</a>
        <span class="sd">&#39;&#39;&#39;remove dst if it exists, then rename src to dst.</span>

<span class="sd">        Change the mode of the renamed file if mode is given.</span>

<span class="sd">        Return True if all went well.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="n">head</span><span class="p">,</span><span class="n">junk</span><span class="o">=</span><span class="n">g</span><span class="o">.</span><span class="n">os_path_split</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">head</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">head</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">makeAllNonExistentDirectories</span><span class="p">(</span><span class="n">head</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="n">dst</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span><span class="n">mode</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;exception renaming: </span><span class="si">%s</span><span class="s"> to: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">outputFileName</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">targetFileName</span><span class="p">))</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20050104132018: *4* atFile.remove</span>
    <span class="k">def</span> <span class="nf">remove</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.remove"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.remove">[docs]</a>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fileName</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;No file name&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;exception removing: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">fileName</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20050104132026: *4* stat</span>
    <span class="k">def</span> <span class="nf">stat</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.stat"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.stat">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Return the access mode of named file, removing any setuid, setgid, and sticky bits.&#39;&#39;&#39;</span>

        <span class="c"># Do _not_ call self.error here.</span>
        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">utils_stat</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20090530055015.6050: *3* at.fullPath</span>
    <span class="k">def</span> <span class="nf">fullPath</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">simulate</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.fullPath"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.fullPath">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Return the full path (including fileName) in effect at p.</span>

<span class="sd">        Neither the path nor the fileName will be created if it does not exist.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">c</span>
        <span class="n">aList</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_directives_dict_list</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">scanAtPathDirectives</span><span class="p">(</span><span class="n">aList</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">simulate</span><span class="p">:</span> <span class="c"># for unit tests.</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">anyAtFileNodeName</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">fn</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;can not happen: not an @&lt;file&gt; node:&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">p2</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">self_and_parents</span><span class="p">():</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

        <span class="c"># g.trace(p.h,repr(path))</span>
        <span class="k">return</span> <span class="n">path</span>
    <span class="c">#@+node:ekr.20090530055015.6023: *3* at.get/setPathUa</span>
    <span class="k">def</span> <span class="nf">getPathUa</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.getPathUa"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.getPathUa">[docs]</a>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;tempAttributes&#39;</span><span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">tempAttributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;read-path&#39;</span><span class="p">,{})</span>
            <span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;path&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">setPathUa</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">path</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.setPathUa"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.setPathUa">[docs]</a>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;tempAttributes&#39;</span><span class="p">):</span>
            <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">tempAttributes</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">d</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">tempAttributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;read-path&#39;</span><span class="p">,{})</span>
        <span class="n">d</span><span class="p">[</span><span class="s">&#39;path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
        <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">tempAttributes</span> <span class="p">[</span><span class="s">&#39;read-path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
    <span class="c">#@+node:ekr.20081216090156.4: *3* at.parseUnderindentTag</span>
    <span class="c"># Important: this is part of the *write* logic.</span>
    <span class="c"># It is called from at.os and at.putIndent.</span>

    <span class="k">def</span> <span class="nf">parseUnderindentTag</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.parseUnderindentTag"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.parseUnderindentTag">[docs]</a>
        <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">underindentEscapeString</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">tag</span><span class="p">):]</span>

        <span class="c"># To be valid, the escape must be followed by at least one digit.</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s2</span><span class="p">[:</span><span class="n">i</span><span class="p">])</span>
            <span class="c"># Bug fix: 2012/06/05: remove any period following the count.</span>
            <span class="c"># This is a new convention.</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;.&#39;</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">n</span><span class="p">,</span><span class="n">s2</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span><span class="n">s</span>
    <span class="c">#@+node:ekr.20090712050729.6017: *3* at.promptForDangerousWrite</span>
    <span class="k">def</span> <span class="nf">promptForDangerousWrite</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span><span class="n">kind</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.promptForDangerousWrite"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.promptForDangerousWrite">[docs]</a>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTestDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;promptForDangerousWrite&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="bp">True</span><span class="p">)</span>

        <span class="c"># g.trace(timeStamp, timeStamp2)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">kind</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span>
            <span class="n">g</span><span class="o">.</span><span class="n">tr</span><span class="p">(</span><span class="s">&#39;already exists.&#39;</span><span class="p">),</span>
            <span class="n">g</span><span class="o">.</span><span class="n">tr</span><span class="p">(</span><span class="s">&#39;Overwrite this file?&#39;</span><span class="p">))</span>

        <span class="n">ok</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">runAskYesNoCancelDialog</span><span class="p">(</span><span class="n">c</span><span class="p">,</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s">&#39;Overwrite existing file?&#39;</span><span class="p">,</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ok</span> <span class="o">==</span> <span class="s">&#39;yes&#39;</span>
    <span class="c">#@+node:ekr.20120112084820.10001: *3* at.rememberReadPath</span>
    <span class="k">def</span> <span class="nf">rememberReadPath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span><span class="n">p</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.rememberReadPath"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.rememberReadPath">[docs]</a>
        <span class="n">v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;at_read&#39;</span><span class="p">):</span>
            <span class="n">v</span><span class="o">.</span><span class="n">at_read</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">at_read</span><span class="p">:</span>
            <span class="n">v</span><span class="o">.</span><span class="n">at_read</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20080923070954.4: *3* at.scanAllDirectives</span>
    <span class="k">def</span> <span class="nf">scanAllDirectives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span></div>
<div class="viewcode-block" id="atFile.scanAllDirectives"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.scanAllDirectives">[docs]</a>        <span class="n">scripting</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">importing</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">reading</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">forcePythonSentinels</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">createPath</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">issuePathWarning</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Scan p and p&#39;s ancestors looking for directives,</span>
<span class="sd">        setting corresponding atFile ivars.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">atPathInBodyWarning</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c">#@+&lt;&lt; set ivars &gt;&gt;</span>
        <span class="c">#@+node:ekr.20080923070954.14: *4* &lt;&lt; Set ivars &gt;&gt;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">page_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">page_width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tab_width</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">tab_width</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">default_directory</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># 8/2: will be set later.</span>

        <span class="c"># g.trace(c.target_language)</span>

        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">target_language</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">target_language</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">target_language</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="n">delims</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">set_delims_from_language</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">target_language</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">language</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">target_language</span>

        <span class="n">at</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">default_derived_file_encoding</span>
        <span class="n">at</span><span class="o">.</span><span class="n">output_newline</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">getOutputNewline</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">)</span> <span class="c"># Init from config settings.</span>
        <span class="c">#@-&lt;&lt; set ivars &gt;&gt;</span>
        <span class="n">lang_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;language&#39;</span><span class="p">:</span><span class="n">at</span><span class="o">.</span><span class="n">language</span><span class="p">,</span><span class="s">&#39;delims&#39;</span><span class="p">:</span><span class="n">delims</span><span class="p">,}</span>
        <span class="n">table</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="s">&#39;encoding&#39;</span><span class="p">,</span>    <span class="n">at</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span>    <span class="n">g</span><span class="o">.</span><span class="n">scanAtEncodingDirectives</span><span class="p">),</span>
            <span class="c"># (&#39;lang-dict&#39;,   lang_dict,      g.scanAtCommentAndAtLanguageDirectives),</span>
            <span class="p">(</span><span class="s">&#39;lang-dict&#39;</span><span class="p">,</span>   <span class="bp">None</span><span class="p">,</span>           <span class="n">g</span><span class="o">.</span><span class="n">scanAtCommentAndAtLanguageDirectives</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;lineending&#39;</span><span class="p">,</span>  <span class="bp">None</span><span class="p">,</span>           <span class="n">g</span><span class="o">.</span><span class="n">scanAtLineendingDirectives</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;pagewidth&#39;</span><span class="p">,</span>   <span class="n">c</span><span class="o">.</span><span class="n">page_width</span><span class="p">,</span>   <span class="n">g</span><span class="o">.</span><span class="n">scanAtPagewidthDirectives</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;path&#39;</span><span class="p">,</span>        <span class="bp">None</span><span class="p">,</span>           <span class="n">c</span><span class="o">.</span><span class="n">scanAtPathDirectives</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;tabwidth&#39;</span><span class="p">,</span>    <span class="n">c</span><span class="o">.</span><span class="n">tab_width</span><span class="p">,</span>    <span class="n">g</span><span class="o">.</span><span class="n">scanAtTabwidthDirectives</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c"># Set d by scanning all directives.</span>
        <span class="n">aList</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_directives_dict_list</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">default</span><span class="p">,</span><span class="n">func</span> <span class="ow">in</span> <span class="n">table</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">aList</span><span class="p">)</span>
            <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">val</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span><span class="n">default</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">issuePathWarning</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">atPathInBodyWarning</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;warning: ignoring @path directive in&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">atPathInBodyWarning</span><span class="p">)</span>

        <span class="c"># Post process.</span>
        <span class="n">lineending</span>  <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;lineending&#39;</span><span class="p">)</span>
        <span class="n">lang_dict</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;lang-dict&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lang_dict</span><span class="p">:</span>
            <span class="n">delims</span>      <span class="o">=</span> <span class="n">lang_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;delims&#39;</span><span class="p">)</span>
            <span class="n">at</span><span class="o">.</span><span class="n">language</span> <span class="o">=</span> <span class="n">lang_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;language&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># 2011/10/10:</span>
            <span class="c"># No language directive.  Look for @&lt;file&gt; nodes.</span>
            <span class="n">language</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">getLanguageFromAncestorAtFileNode</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;python&#39;</span>
            <span class="n">delims</span>   <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">set_delims_from_language</span><span class="p">(</span><span class="n">language</span><span class="p">)</span>

        <span class="n">at</span><span class="o">.</span><span class="n">encoding</span>             <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;encoding&#39;</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">explicitLineEnding</span>   <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">lineending</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">output_newline</span>       <span class="o">=</span> <span class="n">lineending</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">getOutputNewline</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">page_width</span>           <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;pagewidth&#39;</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">default_directory</span>    <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;path&#39;</span><span class="p">)</span>
        <span class="n">at</span><span class="o">.</span><span class="n">tab_width</span>            <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;tabwidth&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">importing</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">reading</span><span class="p">:</span>
            <span class="c"># Don&#39;t override comment delims when reading!</span>
            <span class="c">#@+&lt;&lt; set comment strings from delims &gt;&gt;</span>
            <span class="c">#@+node:ekr.20080923070954.13: *4* &lt;&lt; Set comment strings from delims &gt;&gt;</span>
            <span class="k">if</span> <span class="n">forcePythonSentinels</span><span class="p">:</span>
                <span class="c"># Force Python language.</span>
                <span class="n">delim1</span><span class="p">,</span><span class="n">delim2</span><span class="p">,</span><span class="n">delim3</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">set_delims_from_language</span><span class="p">(</span><span class="s">&quot;python&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">language</span> <span class="o">=</span> <span class="s">&quot;python&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">delim1</span><span class="p">,</span><span class="n">delim2</span><span class="p">,</span><span class="n">delim3</span> <span class="o">=</span> <span class="n">delims</span>

            <span class="c"># Use single-line comments if we have a choice.</span>
            <span class="c"># delim1,delim2,delim3 now correspond to line,start,end</span>
            <span class="k">if</span> <span class="n">delim1</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">startSentinelComment</span> <span class="o">=</span> <span class="n">delim1</span>
                <span class="n">at</span><span class="o">.</span><span class="n">endSentinelComment</span> <span class="o">=</span> <span class="s">&quot;&quot;</span> <span class="c"># Must not be None.</span>
            <span class="k">elif</span> <span class="n">delim2</span> <span class="ow">and</span> <span class="n">delim3</span><span class="p">:</span>
                <span class="n">at</span><span class="o">.</span><span class="n">startSentinelComment</span> <span class="o">=</span> <span class="n">delim2</span>
                <span class="n">at</span><span class="o">.</span><span class="n">endSentinelComment</span> <span class="o">=</span> <span class="n">delim3</span>
            <span class="k">else</span><span class="p">:</span> <span class="c"># Emergency!</span>
                <span class="c"># assert(0)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&quot;unknown language: using Python comment delimiters&quot;</span><span class="p">)</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&quot;c.target_language:&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">target_language</span><span class="p">)</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;delim1,delim2,delim3:&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">delim1</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">delim2</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">delim3</span><span class="p">)</span>
                <span class="n">at</span><span class="o">.</span><span class="n">startSentinelComment</span> <span class="o">=</span> <span class="s">&quot;#&quot;</span> <span class="c"># This should never happen!</span>
                <span class="n">at</span><span class="o">.</span><span class="n">endSentinelComment</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

            <span class="c"># g.trace(repr(self.startSentinelComment),repr(self.endSentinelComment))</span>
            <span class="c">#@-&lt;&lt; set comment strings from delims &gt;&gt;</span>

        <span class="c"># For unit testing.</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&quot;all&quot;</span>       <span class="p">:</span> <span class="nb">all</span><span class="p">,</span>
            <span class="s">&quot;encoding&quot;</span>  <span class="p">:</span> <span class="n">at</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span>
            <span class="s">&quot;language&quot;</span>  <span class="p">:</span> <span class="n">at</span><span class="o">.</span><span class="n">language</span><span class="p">,</span>
            <span class="s">&quot;lineending&quot;</span><span class="p">:</span> <span class="n">at</span><span class="o">.</span><span class="n">output_newline</span><span class="p">,</span>
            <span class="s">&quot;pagewidth&quot;</span> <span class="p">:</span> <span class="n">at</span><span class="o">.</span><span class="n">page_width</span><span class="p">,</span>
            <span class="s">&quot;path&quot;</span>      <span class="p">:</span> <span class="n">at</span><span class="o">.</span><span class="n">default_directory</span><span class="p">,</span>
            <span class="s">&quot;tabwidth&quot;</span>  <span class="p">:</span> <span class="n">at</span><span class="o">.</span><span class="n">tab_width</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">d</span>
    <span class="c">#@+node:ekr.20041005105605.242: *3* at.scanForClonedSibs (reading &amp; writing)</span>
    <span class="k">def</span> <span class="nf">scanForClonedSibs</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent_v</span><span class="p">,</span><span class="n">v</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.scanForClonedSibs"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.scanForClonedSibs">[docs]</a>
        <span class="sd">&quot;&quot;&quot;Scan the siblings of vnode v looking for clones of v.</span>
<span class="sd">        Return the number of cloned sibs and n where p is the n&#39;th cloned sibling.&quot;&quot;&quot;</span>

        <span class="n">clonedSibs</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># The number of cloned siblings of p, including p.</span>
        <span class="n">thisClonedSibIndex</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># Position of p in list of cloned siblings.</span>

        <span class="k">if</span> <span class="n">v</span> <span class="ow">and</span> <span class="n">v</span><span class="o">.</span><span class="n">isCloned</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">sib</span> <span class="ow">in</span> <span class="n">parent_v</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sib</span> <span class="o">==</span> <span class="n">v</span><span class="p">:</span>
                    <span class="n">clonedSibs</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">sib</span> <span class="o">==</span> <span class="n">v</span><span class="p">:</span>
                        <span class="n">thisClonedSibIndex</span> <span class="o">=</span> <span class="n">clonedSibs</span>

        <span class="k">return</span> <span class="n">clonedSibs</span><span class="p">,</span><span class="n">thisClonedSibIndex</span>
    <span class="c">#@+node:ekr.20041005105605.243: *3* at.sentinelName</span>
    <span class="c"># Returns the name of the sentinel for warnings.</span>

    <span class="k">def</span> <span class="nf">sentinelName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kind</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.sentinelName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.sentinelName">[docs]</a>
        <span class="n">at</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">sentinelNameDict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">at</span><span class="o">.</span><span class="n">endAll</span><span class="p">:</span>        <span class="s">&quot;@-all&quot;</span><span class="p">,</span> <span class="c"># 4.x</span>
            <span class="n">at</span><span class="o">.</span><span class="n">endAt</span><span class="p">:</span>         <span class="s">&quot;@-at&quot;</span><span class="p">,</span>
            <span class="n">at</span><span class="o">.</span><span class="n">endBody</span><span class="p">:</span>       <span class="s">&quot;@-body&quot;</span><span class="p">,</span> <span class="c"># 3.x only.</span>
            <span class="n">at</span><span class="o">.</span><span class="n">endDoc</span><span class="p">:</span>        <span class="s">&quot;@-doc&quot;</span><span class="p">,</span>
            <span class="n">at</span><span class="o">.</span><span class="n">endLeo</span><span class="p">:</span>        <span class="s">&quot;@-leo&quot;</span><span class="p">,</span>
            <span class="n">at</span><span class="o">.</span><span class="n">endMiddle</span><span class="p">:</span>     <span class="s">&quot;@-middle&quot;</span><span class="p">,</span> <span class="c"># 4.x</span>
            <span class="n">at</span><span class="o">.</span><span class="n">endNode</span><span class="p">:</span>       <span class="s">&quot;@-node&quot;</span><span class="p">,</span>
            <span class="n">at</span><span class="o">.</span><span class="n">endOthers</span><span class="p">:</span>     <span class="s">&quot;@-others&quot;</span><span class="p">,</span>
            <span class="n">at</span><span class="o">.</span><span class="n">endRef</span><span class="p">:</span>        <span class="s">&quot;@-&lt;&lt;&quot;</span><span class="p">,</span> <span class="c"># 4.8</span>
            <span class="n">at</span><span class="o">.</span><span class="n">noSentinel</span><span class="p">:</span>    <span class="s">&quot;&lt;no sentinel&gt;&quot;</span><span class="p">,</span>
            <span class="n">at</span><span class="o">.</span><span class="n">startAt</span><span class="p">:</span>       <span class="s">&quot;@+at&quot;</span><span class="p">,</span>
            <span class="n">at</span><span class="o">.</span><span class="n">startBody</span><span class="p">:</span>     <span class="s">&quot;@+body&quot;</span><span class="p">,</span>
            <span class="n">at</span><span class="o">.</span><span class="n">startDoc</span><span class="p">:</span>      <span class="s">&quot;@+doc&quot;</span><span class="p">,</span>
            <span class="n">at</span><span class="o">.</span><span class="n">startLeo</span><span class="p">:</span>      <span class="s">&quot;@+leo&quot;</span><span class="p">,</span>
            <span class="n">at</span><span class="o">.</span><span class="n">startNode</span><span class="p">:</span>     <span class="s">&quot;@+node&quot;</span><span class="p">,</span>
            <span class="n">at</span><span class="o">.</span><span class="n">startOthers</span><span class="p">:</span>   <span class="s">&quot;@+others&quot;</span><span class="p">,</span>
            <span class="n">at</span><span class="o">.</span><span class="n">startAll</span><span class="p">:</span>      <span class="s">&quot;@+all&quot;</span><span class="p">,</span>    
            <span class="n">at</span><span class="o">.</span><span class="n">startMiddle</span><span class="p">:</span>   <span class="s">&quot;@+middle&quot;</span><span class="p">,</span> 
            <span class="n">at</span><span class="o">.</span><span class="n">startAfterRef</span><span class="p">:</span> <span class="s">&quot;@afterref&quot;</span><span class="p">,</span> <span class="c"># 4.x</span>
            <span class="n">at</span><span class="o">.</span><span class="n">startComment</span><span class="p">:</span>  <span class="s">&quot;@comment&quot;</span><span class="p">,</span>
            <span class="n">at</span><span class="o">.</span><span class="n">startDelims</span><span class="p">:</span>   <span class="s">&quot;@delims&quot;</span><span class="p">,</span>
            <span class="n">at</span><span class="o">.</span><span class="n">startDirective</span><span class="p">:</span><span class="s">&quot;@@&quot;</span><span class="p">,</span>
            <span class="n">at</span><span class="o">.</span><span class="n">startNl</span><span class="p">:</span>       <span class="s">&quot;@nl&quot;</span><span class="p">,</span>   <span class="c"># 4.x</span>
            <span class="n">at</span><span class="o">.</span><span class="n">startNonl</span><span class="p">:</span>     <span class="s">&quot;@nonl&quot;</span><span class="p">,</span> <span class="c"># 4.x</span>
            <span class="n">at</span><span class="o">.</span><span class="n">startClone</span><span class="p">:</span>    <span class="s">&quot;@clone&quot;</span><span class="p">,</span> <span class="c"># 4.2</span>
            <span class="n">at</span><span class="o">.</span><span class="n">startRef</span><span class="p">:</span>      <span class="s">&quot;@&lt;&lt;&quot;</span><span class="p">,</span>
            <span class="n">at</span><span class="o">.</span><span class="n">startVerbatim</span><span class="p">:</span> <span class="s">&quot;@verbatim&quot;</span><span class="p">,</span>
            <span class="n">at</span><span class="o">.</span><span class="n">startVerbatimAfterRef</span><span class="p">:</span> <span class="s">&quot;@verbatimAfterRef&quot;</span><span class="p">,</span> <span class="c"># 3.x only.</span>
        <span class="p">}</span> 

        <span class="k">return</span> <span class="n">sentinelNameDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span><span class="s">&quot;&lt;unknown sentinel: </span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="n">kind</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20120110174009.9965: *3* at.shouldPromptForDangerousWrite</span>
    <span class="k">def</span> <span class="nf">shouldPromptForDangerousWrite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span><span class="n">p</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.shouldPromptForDangerousWrite"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.shouldPromptForDangerousWrite">[docs]</a>
        <span class="sd">&#39;&#39;&#39;Return True if a prompt should be issued</span>
<span class="sd">        when writing p (an @&lt;file&gt; node) to fn.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
                <span class="c"># No danger of overwriting fn.</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;at_read&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">fn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">at_read</span>
                <span class="c"># The path is new.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
                <span class="c"># The file was never read.</span>
    <span class="c">#@+node:ekr.20041005105605.20: *3* at.warnOnReadOnlyFile</span>
    <span class="k">def</span> <span class="nf">warnOnReadOnlyFile</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span></div>
<div class="viewcode-block" id="atFile.warnOnReadOnlyFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoAtFile.atFile.warnOnReadOnlyFile">[docs]</a>
        <span class="c"># os.access() may not exist on all platforms.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">read_only</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">read_only</span> <span class="o">=</span> <span class="bp">False</span> 

        <span class="k">if</span> <span class="n">read_only</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;read only:&quot;</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
    <span class="c">#@-others</span>
<span class="c">#@-leo</span>
</pre></div></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Leo API 4.11dev documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Ed K. Ream.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
  </body>
</html>