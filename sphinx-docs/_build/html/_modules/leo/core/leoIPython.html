<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>leo.core.leoIPython &mdash; Leo API 4.11dev documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '4.11dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Leo API 4.11dev documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Leo API 4.11dev documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for leo.core.leoIPython</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="c">#@+leo-ver=5-thin</span>
<span class="c">#@+node:ekr.20120401063816.10072: * @file leoIPython.py</span>
<span class="c">#@@first</span>

<span class="sd">&#39;&#39;&#39;Unified support code for ILeo: the Leo-IPython bridge.</span>

<span class="sd">Using this bridge, scripts running in Leo can affect IPython, and vice</span>
<span class="sd">versa. In particular, scripts running in IPython can alter Leo outlines!</span>

<span class="sd">For full details, see Leo Users Guide:</span>
<span class="sd">http://webpages.charter.net/edreamleo/IPythonBridge.html</span>

<span class="sd">This module replaces both ipython.py and leo/external/ipy_leo.</span>

<span class="sd">Users no longer need to activate a plugin. Use the --ipython command-line</span>
<span class="sd">option instead. This code will be active provided that some version of</span>
<span class="sd">IPyton is found on the Python path.</span>

<span class="sd">This module supports all versions of the IPython api:</span>
<span class="sd">    - legacy api: IPython to 0.11.</span>
<span class="sd">    - new api:    IPython 0.12 and up.</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="c">#@@language python</span>
<span class="c">#@@tabwidth -4</span>

<span class="c">#@+&lt;&lt; globals &gt;&gt;</span>
<span class="c">#@+node:ekr.20120402202350.10028: ** &lt;&lt; globals &gt;&gt; (leoIPython.py)</span>
<span class="c"># Globals switches...</span>

<span class="n">g_trace_imports</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c"># True: trace imports</span>

<span class="c"># Global vars...</span>

<span class="n">g_c</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c"># A copy of g.app.ipm.c</span>

<span class="n">g_import_ok</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c"># True if any IPython found.</span>

<span class="n">g_ipm</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c"># The global, singleton GlobalIPythonManager instance.</span>
    <span class="c"># This will remain None if there errors importing IPython.</span>

<span class="n">g_legacy</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c"># True if IPython 0.11 or previous found.</span>

<span class="n">g_push_history</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="c"># The IPython push history.</span>
<span class="c">#@-&lt;&lt; globals &gt;&gt;</span>
<span class="c">#@+&lt;&lt; imports &gt;&gt;</span>
<span class="c">#@+node:ekr.20120401063816.10141: ** &lt;&lt; imports &gt;&gt; (leoIPython.py)</span>
<span class="kn">import</span> <span class="nn">leo.core.leoGlobals</span> <span class="kn">as</span> <span class="nn">g</span>

<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">textwrap</span>

<span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
    <span class="c"># pylint: disable=E0611</span>
    <span class="c"># E0611:No name &#39;UserDict&#39; in module &#39;collections&#39;</span>
    <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">UserDict</span>
    <span class="n">UserDictMixin</span> <span class="o">=</span> <span class="n">UserDict</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">UserDict</span>
    <span class="n">UserDictMixin</span> <span class="o">=</span> <span class="n">UserDict</span><span class="o">.</span><span class="n">DictMixin</span>

<span class="c">#@+&lt;&lt; attempt to import new version of IPython &gt;&gt;</span>
<span class="c">#@+node:ekr.20120413094617.12250: *3* &lt;&lt; attempt to import new version of IPython &gt;&gt;</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c"># pylint: disable=E0611</span>
    <span class="c"># E0611:No name &#39;generics&#39; in module &#39;IPython&#39;</span>
    <span class="c"># E0611:No name &#39;genutils&#39; in module &#39;IPython&#39;</span>
    <span class="c"># E0611:No name &#39;hooks&#39; in module &#39;IPython&#39;</span>
    <span class="c"># E0611:No name &#39;ipapi&#39; in module &#39;IPython&#39;</span>
    <span class="c"># E0611:No name &#39;macro&#39; in module &#39;IPython&#39;</span>

    <span class="c"># Either of these works.</span>
    <span class="kn">import</span> <span class="nn">IPython.frontend.terminal.ipapp</span> <span class="kn">as</span> <span class="nn">ipapp</span>
    <span class="kn">import</span> <span class="nn">IPython.utils.generics</span> <span class="kn">as</span> <span class="nn">generics</span>
    <span class="kn">import</span> <span class="nn">IPython.core.macro</span> <span class="kn">as</span> <span class="nn">macro</span>
    <span class="kn">from</span> <span class="nn">IPython.external.simplegeneric</span> <span class="kn">import</span> <span class="n">generic</span>
    <span class="kn">from</span> <span class="nn">IPython.utils.text</span> <span class="kn">import</span> <span class="n">SList</span>
    <span class="kn">from</span> <span class="nn">IPython.core.completer</span> <span class="kn">import</span> <span class="n">IPCompleter</span>
    <span class="kn">from</span> <span class="nn">IPython.core.error</span> <span class="kn">import</span> <span class="n">TryNext</span>
    <span class="kn">from</span> <span class="nn">IPython.core.hooks</span> <span class="kn">import</span> <span class="n">CommandChainDispatcher</span>
    <span class="kn">from</span> <span class="nn">IPython.core.interactiveshell</span> <span class="kn">import</span> <span class="n">InteractiveShell</span>

    <span class="n">g_import_ok</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">g_legacy</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">g_trace_imports</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;imported new-style IPython&#39;</span><span class="p">)</span>

<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">g_trace_imports</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;can not import new-style IPython&#39;</span><span class="p">)</span>

<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">g_trace_imports</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;unexpected exception importing new-style IPython&#39;</span><span class="p">)</span>
<span class="c">#@-&lt;&lt; attempt to import new version of IPython &gt;&gt;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">g_import_ok</span><span class="p">:</span>
    <span class="c">#@+&lt;&lt; attempt to import legacy IPython &gt;&gt;</span>
    <span class="c">#@+node:ekr.20120413094617.12251: *3* &lt;&lt; attempt to import legacy IPython &gt;&gt;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># pylint: disable=E0611</span>
        <span class="c"># E0611:No name &#39;generics&#39; in module &#39;IPython&#39;</span>
        <span class="c"># E0611:No name &#39;genutils&#39; in module &#39;IPython&#39;</span>
        <span class="c"># E0611:No name &#39;hooks&#39; in module &#39;IPython&#39;</span>
        <span class="c"># E0611:No name &#39;ipapi&#39; in module &#39;IPython&#39;</span>
        <span class="c"># E0611:No name &#39;macro&#39; in module &#39;IPython&#39;</span>

        <span class="kn">import</span> <span class="nn">IPython.ipapi</span> <span class="kn">as</span> <span class="nn">ipapi</span>
        <span class="c"># import IPython.genutils as genutils</span>
        <span class="kn">import</span> <span class="nn">IPython.generics</span> <span class="kn">as</span> <span class="nn">generics</span>
        <span class="kn">import</span> <span class="nn">IPython.macro</span> <span class="kn">as</span> <span class="nn">macro</span>
        <span class="c"># import IPython.Shell as Shell # Used only for Shell.hijack_tk()</span>
        <span class="kn">from</span> <span class="nn">IPython.hooks</span> <span class="kn">import</span> <span class="n">CommandChainDispatcher</span>
        <span class="kn">from</span> <span class="nn">IPython.external.simplegeneric</span> <span class="kn">import</span> <span class="n">generic</span>
        <span class="kn">from</span> <span class="nn">IPython.ipapi</span> <span class="kn">import</span> <span class="n">TryNext</span>
        <span class="kn">from</span> <span class="nn">IPython.genutils</span> <span class="kn">import</span> <span class="n">SList</span>
        <span class="n">g_legacy</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">g_import_ok</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">g_trace_imports</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;imported legacy IPython&#39;</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">g_legacy</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">g_import_ok</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">g_trace_imports</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;can not import legacy IPython.ipapi&#39;</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">g_legacy</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">g_import_ok</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">g_trace_imports</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;unexpected exception importing legacy IPython&#39;</span><span class="p">)</span>
    <span class="c">#@-&lt;&lt; attempt to import legacy IPython &gt;&gt;</span>

<span class="k">if</span> <span class="n">g_trace_imports</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g_import_ok</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;leoIPython.py: can not import IPython&#39;</span><span class="p">)</span>
<span class="c">#@-&lt;&lt; imports &gt;&gt;</span>
<span class="c">#@+&lt;&lt; class LeoWorkBook &gt;&gt;</span>
<span class="c">#@+node:ekr.20120401063816.10181: ** &lt;&lt; class LeoWorkbook &gt;&gt;</span>
<div class="viewcode-block" id="LeoWorkbook"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoIPython.LeoWorkbook">[docs]</a><span class="k">class</span> <span class="nc">LeoWorkbook</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; class for &#39;advanced&#39; node access </span>

<span class="sd">    Has attributes for all &quot;discoverable&quot; nodes.</span>
<span class="sd">    Node is discoverable if it either</span>

<span class="sd">    - has a valid python name (Foo, bar_12)</span>
<span class="sd">    - is a parent of an anchor node.</span>
<span class="sd">    If it has a child &#39;@a foo&#39;, it is visible as foo.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20120401063816.10182: *3* __getattr__</span>
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s">&#39;trait_names&#39;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">valid_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span>
        <span class="n">cells</span> <span class="o">=</span> <span class="n">all_cells</span><span class="p">()</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">cells</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">add_var</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">LeoNode</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20120401063816.10185: *3* __iter__</span>
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Iterate all (even non-exposed) nodes &quot;&quot;&quot;</span>

        <span class="c"># cells = all_cells() # Huh???</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">g_ipm</span><span class="o">.</span><span class="n">c</span>
        <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">LeoNode</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">allNodes_iter</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">LeoNode</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[])</span>
    <span class="c">#@+node:ekr.20120401063816.10184: *3* __setattr__</span>
    <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
            <span class="s">&quot;Direct assignment to workbook denied, try wb.</span><span class="si">%s</span><span class="s">.v = </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">key</span><span class="p">,</span><span class="n">val</span><span class="p">))</span>

    <span class="c">#@+node:ekr.20120401063816.10183: *3* __str__</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;&lt;LeoWorkbook&gt;&quot;</span>

    <span class="n">__repr__</span> <span class="o">=</span> <span class="n">__str__</span>
    <span class="c">#@+node:ekr.20120401063816.10186: *3* current</span>
    <span class="n">current</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="n">LeoNode</span><span class="p">(</span><span class="n">g_c</span><span class="o">.</span><span class="n">currentPosition</span><span class="p">()),</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="s">&quot;Currently selected node&quot;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20120401063816.10187: *3* match_h</span>
<div class="viewcode-block" id="LeoWorkbook.match_h"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoIPython.LeoWorkbook.match_h">[docs]</a>    <span class="k">def</span> <span class="nf">match_h</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">regex</span><span class="p">):</span>

        <span class="nb">cmp</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">regex</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">PosList</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="nb">cmp</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">):</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>
    <span class="c">#@+node:ekr.20120401063816.10188: *3* require</span></div>
<div class="viewcode-block" id="LeoWorkbook.require"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoIPython.LeoWorkbook.require">[docs]</a>    <span class="k">def</span> <span class="nf">require</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; Used to control node push dependencies </span>

<span class="sd">        Call this as first statement in nodes.</span>
<span class="sd">        If node has not been pushed, it will be pushed before proceeding</span>

<span class="sd">        E.g. wb.require(&#39;foo&#39;) will do wb.foo.ipush()</span>
<span class="sd">        if it hasn&#39;t been done already.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">global</span> <span class="n">g_push_history</span>

        <span class="k">if</span> <span class="n">req</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">g_push_history</span><span class="p">:</span>
            <span class="n">es</span><span class="p">(</span><span class="s">&#39;Require: &#39;</span> <span class="o">+</span> <span class="n">req</span><span class="p">)</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">req</span><span class="p">)</span><span class="o">.</span><span class="n">ipush</span><span class="p">()</span>
    <span class="c">#@-others</span>
<span class="c">#@-&lt;&lt; class LeoWorkBook &gt;&gt;</span>

<span class="c"># Several defs depend on imports for types.</span></div></div>
<span class="k">if</span> <span class="n">g_import_ok</span><span class="p">:</span>
    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20120401082519.10036: ** class GlobalIPythonManager &amp; g_ipm</span>
    <span class="k">class</span> <span class="nc">GlobalIPythonManager</span><span class="p">:</span>

        <span class="sd">&#39;&#39;&#39;A class to manage global IPython data&#39;&#39;&#39;</span>

        <span class="c">#@+others</span>
        <span class="c">#@+node:ekr.20120401082519.10037: *3* ctor (GlobalIPythonManager)</span>
        <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="c"># The current commander, set by update_commander.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="c"># The global IPython instance.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inited</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="c"># True: init_ipython called</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root_node</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="c"># The global root node used by the allcells() and rootnode() functions.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">started</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="c"># True: IPython has been started.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wb</span> <span class="o">=</span> <span class="n">LeoWorkbook</span><span class="p">()</span>
                <span class="c"># The Leo workbook instance.</span>
        <span class="c">#@+node:ekr.20110605121601.18482: *3* embed_ipython &amp; helpers</span>
        <span class="k">def</span> <span class="nf">embed_ipython</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="sd">&#39;&#39;&#39;Run the Qt main loop using IPython if possible.&#39;&#39;&#39;</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">g_import_ok</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">qtApp</span><span class="o">.</span><span class="n">exec_</span><span class="p">())</span>
                    <span class="c"># Just run the Qt main loop.</span>
            <span class="k">elif</span> <span class="n">g_legacy</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">start_legacy_api</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">start_new_api</span><span class="p">()</span>
        <span class="c">#@+node:ekr.20120401144849.10115: *4* start_legacy_api</span>
        <span class="k">def</span> <span class="nf">start_legacy_api</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">started</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="c"># No c is available: we can&#39;t get @string ipython_argv setting.</span>
            <span class="n">old_argv</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;leo.py&#39;</span><span class="p">,</span> <span class="s">&#39;-p&#39;</span><span class="p">,</span> <span class="s">&#39;sh&#39;</span><span class="p">]</span>         
            <span class="n">session</span> <span class="o">=</span> <span class="n">ipapi</span><span class="o">.</span><span class="n">make_session</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">IP</span><span class="o">.</span><span class="n">getapi</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_ipython</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="o">=</span> <span class="n">old_argv</span>

            <span class="c"># Does not return until IPython closes.</span>
            <span class="c"># IPython runs the leo mainloop</span>
            <span class="n">session</span><span class="o">.</span><span class="n">mainloop</span><span class="p">()</span>
        <span class="c">#@+node:ekr.20120401144849.10116: *4* start_new_api</span>
        <span class="k">def</span> <span class="nf">start_new_api</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="c"># No c is available: we can&#39;t get @string ipython_argv setting.</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="o">=</span>  <span class="p">[</span><span class="s">&#39;ipython&#39;</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">started</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="c"># Prints signon.</span>
            <span class="c"># self.ip set in update_commander.</span>
            <span class="n">ipapp</span><span class="o">.</span><span class="n">launch_new_instance</span><span class="p">()</span>

                <span class="c"># Doesn&#39;t print signon.</span>
                <span class="c"># shell = ishell.TerminalInteractiveShell()</span>
                <span class="c"># self.ip = shell</span>
                <span class="c"># shell.mainloop()</span>
        <span class="c">#@+node:ekr.20120401144849.10084: *3* get_history</span>
        <span class="k">def</span> <span class="nf">get_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">hstart</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip</span>

            <span class="k">if</span> <span class="n">g_legacy</span><span class="p">:</span>
                <span class="n">ihist</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">IP</span><span class="o">.</span><span class="n">input_hist</span>
                <span class="n">ihist_raw</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">IP</span><span class="o">.</span><span class="n">input_hist_raw</span>
                <span class="n">ohist</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">IP</span><span class="o">.</span><span class="n">output_hist</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">history_manager</span>
                <span class="n">ihist</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">input_hist_parsed</span>
                <span class="n">ihist_raw</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">input_hist_raw</span>
                <span class="n">ohist</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">output_hist</span>

            <span class="c"># for idx in range(hstart, len(ip.IP.input_hist)):</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">hstart</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ihist</span><span class="p">)):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">ohist</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
                <span class="n">has_output</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="c"># inp = ip.IP.input_hist_raw[idx]</span>
                <span class="n">inp</span> <span class="o">=</span> <span class="n">ihist_raw</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">inp</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;In [</span><span class="si">%d</span><span class="s">]: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">inp</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>    
            <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="c">#@+node:ekr.20120401063816.10144: *3* init_ipython</span>
        <span class="k">def</span> <span class="nf">init_ipython</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="sd">&quot;&quot;&quot; This will be run by _ip.load(&#39;ipy_leo&#39;) </span>

<span class="sd">            Leo still needs to run update_commander() after this.</span>

<span class="sd">            &quot;&quot;&quot;</span>

            <span class="n">ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip</span>
            <span class="c"># g.trace(ip)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inited</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">show_welcome</span><span class="p">()</span>

            <span class="c">#### Shell.hijack_tk()</span>
            <span class="n">ip</span><span class="o">.</span><span class="n">set_hook</span><span class="p">(</span><span class="s">&#39;complete_command&#39;</span><span class="p">,</span><span class="n">mb_completer</span><span class="p">,</span><span class="n">str_key</span> <span class="o">=</span> <span class="s">&#39;%mb&#39;</span><span class="p">)</span>

            <span class="n">f</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">expose_magic</span> <span class="k">if</span> <span class="n">g_legacy</span> <span class="k">else</span> <span class="n">ip</span><span class="o">.</span><span class="n">define_magic</span>

            <span class="n">f</span><span class="p">(</span><span class="s">&#39;mb&#39;</span><span class="p">,</span><span class="n">mb_f</span><span class="p">)</span>
            <span class="n">f</span><span class="p">(</span><span class="s">&#39;lee&#39;</span><span class="p">,</span><span class="n">lee_f</span><span class="p">)</span>
            <span class="n">f</span><span class="p">(</span><span class="s">&#39;leoref&#39;</span><span class="p">,</span><span class="n">leoref_f</span><span class="p">)</span>
            <span class="n">f</span><span class="p">(</span><span class="s">&#39;lleo&#39;</span><span class="p">,</span><span class="n">lleo_f</span><span class="p">)</span>    
            <span class="n">f</span><span class="p">(</span><span class="s">&#39;lshadow&#39;</span><span class="p">,</span><span class="n">lshadow_f</span><span class="p">)</span>
            <span class="n">f</span><span class="p">(</span><span class="s">&#39;lno&#39;</span><span class="p">,</span><span class="n">lno_f</span><span class="p">)</span>

            <span class="c"># Note that no other push command should EVER have lower than 0</span>
            <span class="n">g_ipm</span><span class="o">.</span><span class="n">expose_ileo_push</span><span class="p">(</span><span class="n">g_ipm</span><span class="o">.</span><span class="n">push_mark_req</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">g_ipm</span><span class="o">.</span><span class="n">expose_ileo_push</span><span class="p">(</span><span class="n">g_ipm</span><span class="o">.</span><span class="n">push_cl_node</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
            <span class="c"># this should be the LAST one that will be executed,</span>
            <span class="c"># and it will never raise TryNext.</span>
            <span class="n">g_ipm</span><span class="o">.</span><span class="n">expose_ileo_push</span><span class="p">(</span><span class="n">g_ipm</span><span class="o">.</span><span class="n">push_ipython_script</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span>
            <span class="n">g_ipm</span><span class="o">.</span><span class="n">expose_ileo_push</span><span class="p">(</span><span class="n">g_ipm</span><span class="o">.</span><span class="n">push_plain_python</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
            <span class="n">g_ipm</span><span class="o">.</span><span class="n">expose_ileo_push</span><span class="p">(</span><span class="n">g_ipm</span><span class="o">.</span><span class="n">push_ev_node</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>

            <span class="n">ip</span><span class="o">.</span><span class="n">set_hook</span><span class="p">(</span><span class="s">&#39;pre_prompt_hook&#39;</span><span class="p">,</span><span class="n">ileo_pre_prompt_hook</span><span class="p">)</span> 

            <span class="c"># global wb</span>
            <span class="c"># wb = LeoWorkbook()</span>
            <span class="n">ip</span><span class="o">.</span><span class="n">user_ns</span><span class="p">[</span><span class="s">&#39;wb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wb</span>
        <span class="c">#@+node:ekr.20120401144849.10094: *3* push...</span>
        <span class="c">#@+node:ekr.20120401144849.10095: *4* expose_ileo_push</span>
        <span class="k">def</span> <span class="nf">expose_ileo_push</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">priority</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

            <span class="c"># self.push_from_leo.add(f,priority)</span>
            <span class="n">CommandChainDispatcher</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">priority</span><span class="p">)</span>
        <span class="c">#@+node:ekr.20120401144849.10102: *4* push_position_from_leo</span>
        <span class="k">def</span> <span class="nf">push_position_from_leo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">CommandChainDispatcher</span><span class="p">(</span><span class="n">LeoNode</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
                <span class="n">d</span><span class="p">()</span>

            <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span> <span class="o">==</span> <span class="p">(</span><span class="s">&quot;Commands instance has no attribute &#39;frame&#39;&quot;</span><span class="p">,):</span>
                    <span class="n">es</span><span class="p">(</span><span class="s">&quot;Error: ILeo not associated with .leo document&quot;</span><span class="p">)</span>
                    <span class="n">es</span><span class="p">(</span><span class="s">&quot;Press alt+shift+I to fix!&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>
        <span class="c">#@+node:ekr.20120401144849.10142: *4* push_to_ipython</span>
        <span class="k">def</span> <span class="nf">push_to_ipython</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="n">c</span><span class="p">,</span><span class="n">ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;can not happen: no c.&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;can not happen: no ip.&#39;</span><span class="p">)</span>

            <span class="n">c</span><span class="o">.</span><span class="n">inCommand</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># Disable the command lockout logic</span>

            <span class="n">n</span> <span class="o">=</span> <span class="n">LeoNode</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">push_ipython_script</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">CommandChainDispatcher</span><span class="p">()</span>
            <span class="n">d</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">d</span><span class="p">()</span>
        <span class="c">#@+node:ekr.20120401144849.10096: *4* push_cl_node</span>
        <span class="k">def</span> <span class="nf">push_cl_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">node</span><span class="p">):</span>

            <span class="sd">&quot;&quot;&quot; If node starts with @cl, eval it</span>

<span class="sd">            The result is put as last child of @ipy-results node, if it exists</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@cl&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">TryNext</span>

            <span class="n">p2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">findNodeAnywhere</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&#39;@ipy-results&#39;</span><span class="p">)</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">v</span>
            <span class="k">if</span> <span class="n">p2</span><span class="p">:</span>
                <span class="n">es</span><span class="p">(</span><span class="s">&quot;=&gt; @ipy-results&quot;</span><span class="p">)</span>
                <span class="n">LeoNode</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">val</span>
            <span class="n">es</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

        <span class="c">#@+node:ekr.20120401144849.10097: *4* push_ev_node</span>
        <span class="k">def</span> <span class="nf">push_ev_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">node</span><span class="p">):</span>

            <span class="sd">&quot;&quot;&quot; If headline starts with @ev, eval it and put result in body &quot;&quot;&quot;</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@ev &#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">TryNext</span>

            <span class="n">expr</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s">&#39;@ev &#39;</span><span class="p">)</span>
            <span class="n">es</span><span class="p">(</span><span class="s">&#39;ipy eval &#39;</span> <span class="o">+</span> <span class="n">expr</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">res</span>

        <span class="c">#@+node:ekr.20120401144849.10098: *4* push_from_leo</span>
        <span class="c"># push_from_leo = CommandChainDispatcher()</span>
        <span class="c">#@+node:ekr.20120401144849.10099: *4* push_ipython_script</span>
        <span class="k">def</span> <span class="nf">push_ipython_script</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">node</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Execute the node body in IPython,</span>
<span class="sd">            as if it was entered in interactive prompt &quot;&quot;&quot;</span>

            <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">ip</span><span class="p">)):</span>
                        <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%30s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="nb">getattr</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">__class__</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">g_legacy</span><span class="p">:</span>
                    <span class="n">ihist</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">IP</span><span class="o">.</span><span class="n">input_hist</span>
                    <span class="n">ohist</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">IP</span><span class="o">.</span><span class="n">output_hist</span> 
                    <span class="n">hstart</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ip</span><span class="o">.</span><span class="n">IP</span><span class="o">.</span><span class="n">input_hist</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">history_manager</span>
                    <span class="n">hstart</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">history_length</span>
                    <span class="n">ihist</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">input_hist_parsed</span>
                    <span class="n">ohist</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">output_hist</span>

                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;ihist&#39;</span><span class="p">,</span><span class="n">ihist</span><span class="p">)</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;ohist&#39;</span><span class="p">,</span><span class="n">ohist</span><span class="p">)</span>

                <span class="n">script</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">script</span><span class="p">()</span>

                <span class="c"># The current node _p needs to handle</span>
                <span class="c"># wb.require() and recursive ipushes.</span>
                <span class="n">old_p</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">user_ns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;_p&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
                <span class="n">ip</span><span class="o">.</span><span class="n">user_ns</span><span class="p">[</span><span class="s">&#39;_p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span>

                <span class="k">if</span> <span class="n">g_legacy</span><span class="p">:</span>
                    <span class="n">ip</span><span class="o">.</span><span class="n">runlines</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ip</span><span class="o">.</span><span class="n">runcode</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>

                <span class="n">ip</span><span class="o">.</span><span class="n">user_ns</span><span class="p">[</span><span class="s">&#39;_p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_p</span>
                <span class="k">if</span> <span class="n">old_p</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">ip</span><span class="o">.</span><span class="n">user_ns</span><span class="p">[</span><span class="s">&#39;_p&#39;</span><span class="p">]</span>

                <span class="n">has_output</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="c"># for idx in range(hstart,len(ip.IP.input_hist)):</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">hstart</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">ihist</span><span class="p">)):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">ohist</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">has_output</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="c"># inp = ip.IP.input_hist[idx]</span>
                        <span class="n">inp</span> <span class="o">=</span> <span class="n">ihist</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">inp</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                            <span class="n">es</span><span class="p">(</span><span class="s">&#39;In: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">inp</span><span class="p">[:</span><span class="mi">40</span><span class="p">],</span> <span class="p">))</span>
                        <span class="n">es</span><span class="p">(</span><span class="s">&#39;&lt;</span><span class="si">%d</span><span class="s">&gt; </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">ohist</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="n">width</span><span class="o">=</span><span class="mi">40</span><span class="p">)))</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">has_output</span><span class="p">:</span>
                    <span class="n">es</span><span class="p">(</span><span class="s">&#39;ipy run: </span><span class="si">%s</span><span class="s"> (</span><span class="si">%d</span><span class="s"> LL)&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">script</span><span class="p">)))</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="c"># if trace: g.trace(&#39;end push_ipython_script&#39;)</span>
                <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>
        <span class="c">#@+node:ekr.20120401144849.10100: *4* push_mark_req</span>
        <span class="k">def</span> <span class="nf">push_mark_req</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">node</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; This should be the first one that gets called.</span>

<span class="sd">            It will mark the node as &#39;pushed&#39;, for wb.require.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="k">global</span> <span class="n">g_push_history</span>

            <span class="n">g_push_history</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

            <span class="k">raise</span> <span class="n">TryNext</span>
        <span class="c">#@+node:ekr.20120401144849.10101: *4* push_plain_python</span>
        <span class="k">def</span> <span class="nf">push_plain_python</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">node</span><span class="p">):</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;P&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">TryNext</span>

            <span class="n">script</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">script</span><span class="p">()</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">script</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c"># exec script in ip.user_ns</span>
                <span class="c"># 2010/02/04: per 2to3</span>
                <span class="k">exec</span><span class="p">(</span><span class="n">script</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="o">.</span><span class="n">user_ns</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot; -- Exception in script:</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">+</span><span class="n">script</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s"> --&quot;</span><span class="p">)</span>
                <span class="k">raise</span>
            <span class="n">es</span><span class="p">(</span><span class="s">&#39;ipy plain: </span><span class="si">%s</span><span class="s"> (</span><span class="si">%d</span><span class="s"> LL)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="n">lines</span><span class="p">))</span>
        <span class="c">#@+node:ekr.20120401144849.10104: *3* run_leo_startup_node</span>
        <span class="k">def</span> <span class="nf">run_leo_startup_node</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">findNodeAnywhere</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&#39;@ipy-startup&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;Running @ipy-startup nodes&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">LeoNode</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                    <span class="c"># self.push_from_leo(n)</span>
                    <span class="n">CommandChainDispatcher</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

        <span class="c">#@+node:ekr.20120401144849.10119: *3* show_welcome</span>
        <span class="k">def</span> <span class="nf">show_welcome</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="k">print</span><span class="p">(</span><span class="s">&quot;------------------&quot;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Welcome to Leo-enabled IPython session!&quot;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Try </span><span class="si">%le</span><span class="s">oref for quick reference.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">g_legacy</span><span class="p">:</span>
                <span class="c"># pylint: disable=E0611</span>
                <span class="c"># E0611:GlobalIPythonManager.show_welcome: No name &#39;platutils&#39; in module &#39;IPython&#39;</span>
                <span class="kn">import</span> <span class="nn">IPython.platutils</span> <span class="kn">as</span> <span class="nn">u</span>
                <span class="n">u</span><span class="o">.</span><span class="n">set_term_title</span><span class="p">(</span><span class="s">&#39;ILeo&#39;</span><span class="p">)</span>
                <span class="n">u</span><span class="o">.</span><span class="n">freeze_term_title</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">IPython.utils.terminal</span> <span class="kn">as</span> <span class="nn">u</span>
                <span class="n">u</span><span class="o">.</span><span class="n">toggle_set_term_title</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">u</span><span class="o">.</span><span class="n">set_term_title</span><span class="p">(</span><span class="s">&#39;ILeo&#39;</span><span class="p">)</span>
        <span class="c">#@+node:ekr.20120415174008.10063: *3* get_ip</span>
        <span class="k">def</span> <span class="nf">get_ip</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="sd">&quot;&quot;&quot;Get the global InteractiveShell instance.&quot;&quot;&quot;</span>

            <span class="n">shell</span> <span class="o">=</span> <span class="n">InteractiveShell</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">shell</span>
        <span class="c">#@+node:ekr.20120401063816.10145: *3* update_commander</span>
        <span class="k">def</span> <span class="nf">update_commander</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Set the Leo commander to use</span>

<span class="sd">            This will be run every time Leo does ipython-launch; basically,</span>
<span class="sd">            when the user switches the document he is focusing on, he should do</span>
<span class="sd">            ipython-launch to tell ILeo what document the commands apply to.</span>

<span class="sd">            &quot;&quot;&quot;</span>

            <span class="n">ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip</span>

            <span class="k">if</span> <span class="n">g_legacy</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">ip</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">ip</span><span class="p">:</span>
                <span class="n">ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ip</span><span class="p">()</span>
                <span class="k">assert</span> <span class="n">ip</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">ip</span><span class="o">.</span><span class="n">user_ns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;c&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">c</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">inited</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">init_ipython</span><span class="p">()</span>

            <span class="k">global</span> <span class="n">g_c</span>
            <span class="n">g_c</span> <span class="o">=</span> <span class="n">c</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">c</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Set Leo Commander: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">getTitle</span><span class="p">())</span>

            <span class="n">leox</span> <span class="o">=</span> <span class="n">LeoInterface</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">g</span><span class="p">)</span>
            <span class="n">leox</span><span class="o">.</span><span class="n">push</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">push_position_from_leo</span>

            <span class="c"># will probably be overwritten by user,</span>
            <span class="c"># but handy for experimentation early on.</span>
            <span class="n">ip</span><span class="o">.</span><span class="n">user_ns</span><span class="p">[</span><span class="s">&#39;c&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>
            <span class="n">ip</span><span class="o">.</span><span class="n">user_ns</span><span class="p">[</span><span class="s">&#39;g&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span>
            <span class="n">ip</span><span class="o">.</span><span class="n">user_ns</span><span class="p">[</span><span class="s">&#39;_leo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">leox</span>
                <span class="c"># inject leox into the namespace.</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">run_leo_startup_node</span><span class="p">()</span>
            <span class="n">ip</span><span class="o">.</span><span class="n">user_ns</span><span class="p">[</span><span class="s">&#39;_prompt_title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;ileo&#39;</span>
        <span class="c">#@-others</span>

    <span class="n">g_ipm</span> <span class="o">=</span> <span class="n">GlobalIPythonManager</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20120401063816.10247: ** class LeoInterface</span>
    <span class="k">class</span> <span class="nc">LeoInterface</span><span class="p">:</span>

        <span class="sd">&#39;&#39;&#39;A class to allow full access to Leo from Ipython.</span>

<span class="sd">        An instance of this class called leox is typically injected</span>
<span class="sd">        into IPython&#39;s user_ns namespace by the init-ipython-command.&#39;&#39;&#39;</span>

        <span class="c"># pylint: disable=R0923</span>
        <span class="c"># R0923:LeoInterface: Interface not implemented</span>

        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">tag</span><span class="o">=</span><span class="s">&#39;@ipython-results&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">c</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="n">g</span>
    <span class="c">#@+node:ekr.20120401063816.10189: ** class LeoNode</span>
    <span class="k">class</span> <span class="nc">LeoNode</span><span class="p">(</span><span class="n">UserDictMixin</span><span class="p">,</span><span class="nb">object</span><span class="p">):</span> <span class="c">#### (object,UserDict.DictMixin):</span>
        <span class="sd">&quot;&quot;&quot; Node in Leo outline</span>

<span class="sd">        Most important attributes (getters/setters available:</span>
<span class="sd">         .v     - evaluate node, can also be aligned </span>
<span class="sd">         .b, .h - body string, headline string</span>
<span class="sd">         .l     - value as string list</span>

<span class="sd">        Also supports iteration, </span>

<span class="sd">        setitem / getitem (indexing):  </span>
<span class="sd">         wb.foo[&#39;key&#39;] = 12</span>
<span class="sd">         assert wb.foo[&#39;key&#39;].v == 12</span>

<span class="sd">        Note the asymmetry on setitem and getitem! Also other</span>
<span class="sd">        dict methods are available. </span>

<span class="sd">        .ipush() - run push-to-ipython</span>

<span class="sd">        Minibuffer command access (tab completion works):</span>

<span class="sd">         mb save-to-file</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#@+others</span>
        <span class="c">#@+node:ekr.20120401063816.10190: *3* __init__ (LeoNode)</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">context</span> <span class="c"># New in Leo 4.10.1.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c">#@+node:ekr.20120401063816.10191: *3* __str__</span>
        <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;&lt;LeoNode </span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

        <span class="n">__repr__</span> <span class="o">=</span> <span class="n">__str__</span>
        <span class="c">#@+node:ekr.20120401063816.10192: *3* __get_h and _set_h</span>
        <span class="k">def</span> <span class="nf">__get_h</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">headString</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">__set_h</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">val</span><span class="p">):</span>

            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
            <span class="n">c</span><span class="o">.</span><span class="n">setHeadString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>
            <span class="n">LeoNode</span><span class="o">.</span><span class="n">last_edited</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>

        <span class="n">h</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span> <span class="n">__get_h</span><span class="p">,</span> <span class="n">__set_h</span><span class="p">,</span> <span class="n">doc</span> <span class="o">=</span> <span class="s">&quot;Node headline string&quot;</span><span class="p">)</span>  
        <span class="c">#@+node:ekr.20120401063816.10193: *3* _get_b and __set_b</span>
        <span class="k">def</span> <span class="nf">__get_b</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">bodyString</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">__set_b</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">val</span><span class="p">):</span>

            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
            <span class="n">c</span><span class="o">.</span><span class="n">setBodyString</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
            <span class="n">LeoNode</span><span class="o">.</span><span class="n">last_edited</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>

        <span class="n">b</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">__get_b</span><span class="p">,</span> <span class="n">__set_b</span><span class="p">,</span> <span class="n">doc</span> <span class="o">=</span> <span class="s">&quot;Nody body string&quot;</span><span class="p">)</span>
        <span class="c">#@+node:ekr.20120401063816.10194: *3* __set_val</span>
        <span class="k">def</span> <span class="nf">__set_val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>        
            <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">format_for_leo</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

        <span class="n">v</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span>
            <span class="c"># pylint: disable=W0108</span>
            <span class="c"># W0108:LeoNode.&lt;lambda&gt;: Lambda may not be necessary</span>
            <span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="n">eval_node</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">__set_val</span><span class="p">,</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="s">&quot;Node evaluated value&quot;</span><span class="p">)</span>
        <span class="c">#@+node:ekr.20120401063816.10195: *3* __set_l</span>
        <span class="k">def</span> <span class="nf">__set_l</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">val</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">val</span> <span class="p">)</span>

        <span class="n">l</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span> <span class="p">:</span> <span class="n">SList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()),</span> 
                <span class="n">__set_l</span><span class="p">,</span> <span class="n">doc</span> <span class="o">=</span> <span class="s">&quot;Node value as string list&quot;</span><span class="p">)</span>
        <span class="c">#@+node:ekr.20120401063816.10196: *3* __iter__</span>
        <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Iterate through nodes direct children &quot;&quot;&quot;</span>

            <span class="k">return</span> <span class="p">(</span><span class="n">LeoNode</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">children_iter</span><span class="p">())</span>

        <span class="c">#@+node:ekr.20120401063816.10197: *3* __children</span>
        <span class="k">def</span> <span class="nf">__children</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="n">head</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">h</span>
                <span class="n">tup</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tup</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">tup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;@k&#39;</span><span class="p">:</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">tup</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">child</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_attribute</span><span class="p">(</span><span class="n">head</span><span class="p">):</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">head</span><span class="p">]</span> <span class="o">=</span> <span class="n">child</span>
                    <span class="k">continue</span>
            <span class="k">return</span> <span class="n">d</span>
        <span class="c">#@+node:ekr.20120401063816.10198: *3* keys</span>
        <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__children</span><span class="p">()</span>
            <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="c">#@+node:ekr.20120401063816.10199: *3* __getitem__</span>
        <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; wb.foo[&#39;Some stuff&#39;]</span>
<span class="sd">            Return a child node with headline &#39;Some stuff&#39;</span>

<span class="sd">            If key is a valid python name (e.g. &#39;foo&#39;),</span>
<span class="sd">            look for headline &#39;@k foo&#39; as well</span>
<span class="sd">            &quot;&quot;&quot;</span>  
            <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__children</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="c">#@+node:ekr.20120401063816.10200: *3* __setitem__</span>
        <span class="k">def</span> <span class="nf">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; You can do wb.foo[&#39;My Stuff&#39;] = 12 to create children </span>

<span class="sd">            Create &#39;My Stuff&#39; as a child of foo (if it does not exist), and </span>
<span class="sd">            do .v = 12 assignment.</span>

<span class="sd">            Exception:</span>

<span class="sd">            wb.foo[&#39;bar&#39;] = 12</span>

<span class="sd">            will create a child with headline &#39;@k bar&#39;,</span>
<span class="sd">            because bar is a valid python name and we don&#39;t want to crowd</span>
<span class="sd">            the WorkBook namespace with (possibly numerous) entries.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__children</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">val</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_attribute</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                <span class="n">head</span> <span class="o">=</span> <span class="n">key</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">head</span> <span class="o">=</span> <span class="s">&#39;@k &#39;</span> <span class="o">+</span> <span class="n">key</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">createLastChildNode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="n">LeoNode</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">val</span>

        <span class="c">#@+node:ekr.20120401063816.10201: *3* __delitem__</span>
        <span class="k">def</span> <span class="nf">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Remove child</span>

<span class="sd">            Allows stuff like wb.foo.clear() to remove all children</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">doDelete</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>

        <span class="c">#@+node:ekr.20120401063816.10202: *3* ipush (LeoNode)</span>
        <span class="k">def</span> <span class="nf">ipush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Does push-to-ipython on the node &quot;&quot;&quot;</span>
            <span class="c"># push_from_leo(self)</span>
            <span class="n">CommandChainDispatcher</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c">#@+node:ekr.20120401063816.10203: *3* go</span>
        <span class="k">def</span> <span class="nf">go</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Set node as current node (to quickly see it in Outline) &quot;&quot;&quot;</span>
            <span class="c">#c.setCurrentPosition(self.p)</span>

            <span class="c"># argh, there should be another way</span>
            <span class="c">#c.redraw()</span>
            <span class="c">#s = self.p.bodyString()</span>
            <span class="c">#c.setBodyString(self.p,s)</span>

            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
            <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
        <span class="c">#@+node:ekr.20120401063816.10204: *3* append</span>
        <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Add new node as the last child, return the new node &quot;&quot;&quot;</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">insertAsLastChild</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">LeoNode</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="c">#@+node:ekr.20120401063816.10205: *3* script</span>
        <span class="k">def</span> <span class="nf">script</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Method to get the &#39;tangled&#39; contents of the node</span>

<span class="sd">            (parse @others, section references etc.)</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">getScript</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">,</span><span class="n">useSelectedText</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">useSentinels</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="c">#@+node:ekr.20120401063816.10206: *3* __get_uA</span>
        <span class="k">def</span> <span class="nf">__get_uA</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="c"># Create the uA if necessary.</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;unknownAttributes&#39;</span><span class="p">):</span>
                <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">unknownAttributes</span> <span class="o">=</span> <span class="p">{}</span>        

            <span class="n">d</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">unknownAttributes</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;ipython&#39;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">return</span> <span class="n">d</span>        

        <span class="c">#@-others</span>
        <span class="n">uA</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">__get_uA</span><span class="p">,</span>
            <span class="n">doc</span> <span class="o">=</span> <span class="s">&quot;Access persistent unknownAttributes of node&quot;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20120401063816.10180: ** class PosList</span>
    <span class="k">class</span> <span class="nc">PosList</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pat</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">PosList</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="c">#print &quot;po&quot;,p</span>
                <span class="k">for</span> <span class="n">chi_p</span> <span class="ow">in</span> <span class="n">n</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">children_iter</span><span class="p">():</span>
                    <span class="c">#print &quot;chi&quot;,chi_p</span>
                    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span> <span class="n">chi_p</span><span class="o">.</span><span class="n">headString</span><span class="p">()):</span>
                        <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LeoNode</span><span class="p">(</span><span class="n">chi_p</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">res</span>
    <span class="c">#@+node:ekr.20120401144849.10150: ** Decorators</span>
    <span class="c">#@+node:ekr.20120401144849.10079: *3* edit_object_in_leo</span>
    <span class="nd">@generic</span>
    <span class="k">def</span> <span class="nf">edit_object_in_leo</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">varname</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; Make it @cl node so it can be pushed back directly by alt+I &quot;&quot;&quot;</span>

        <span class="n">node</span> <span class="o">=</span> <span class="n">add_var</span><span class="p">(</span><span class="n">varname</span><span class="p">)</span>
        <span class="n">formatted</span> <span class="o">=</span> <span class="n">format_for_leo</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">formatted</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@cl&#39;</span><span class="p">):</span>
            <span class="n">formatted</span> <span class="o">=</span> <span class="s">&#39;@cl</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">formatted</span>
        <span class="n">node</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">formatted</span> 
        <span class="n">node</span><span class="o">.</span><span class="n">go</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20120401144849.10138: ** IPython commands</span>
    <span class="c">#@+node:ekr.20120401144849.10139: *3* start-ipython</span>
    <span class="nd">@g.command</span><span class="p">(</span><span class="s">&#39;start-ipython&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">startIPython</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;The start-ipython command&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">event</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;c&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">g_ipm</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">g_import_ok</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;IPython not loaded&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">g_ipm</span><span class="o">.</span><span class="n">started</span><span class="p">:</span>
            <span class="n">g_ipm</span><span class="o">.</span><span class="n">update_commander</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">g_legacy</span><span class="p">:</span>
            <span class="n">g_ipm</span><span class="o">.</span><span class="n">start_legacy_api</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g_ipm</span><span class="o">.</span><span class="n">start_new_api</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20120401144849.10140: *3* pushToIPythonCommand (g.command push-to-ipython)</span>
    <span class="nd">@g.command</span><span class="p">(</span><span class="s">&#39;push-to-ipython&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">pushToIPythonCommand</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;The push-to-ipython command.</span>

<span class="sd">        IPython must be started, but the commander need not be inited.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

        <span class="c"># Ensure that the correct commander is set.</span>
        <span class="n">startIPython</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">)</span>

        <span class="n">g_ipm</span><span class="o">.</span><span class="n">push_to_ipython</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20120401144849.10134: ** Top-level functions</span>
    <span class="c">#@+node:ekr.20120401144849.10075: *3* add_file</span>
    <span class="k">def</span> <span class="nf">add_file</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">g_ipm</span><span class="o">.</span><span class="n">c</span>
        <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">currentPosition</span><span class="p">()</span><span class="o">.</span><span class="n">insertAfter</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20120401144849.10076: *3* add_var</span>
    <span class="k">def</span> <span class="nf">add_var</span><span class="p">(</span><span class="n">varname</span><span class="p">):</span>

        <span class="c"># pylint: disable=E1101</span>
        <span class="c"># E1101:add_var: Class &#39;LeoNode&#39; has no &#39;p&#39; member</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">g_ipm</span><span class="o">.</span><span class="n">c</span>
        <span class="c"># g.trace(varname)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">rootnode</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">p2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">findNodeAnywhere</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">varname</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">findNodeInChildren</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">r</span><span class="o">.</span><span class="n">p</span><span class="p">,</span><span class="n">varname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p2</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">LeoNode</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">p2</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">insertAsLastChild</span><span class="p">()</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">p2</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">currentPosition</span><span class="p">()</span><span class="o">.</span><span class="n">insertAfter</span><span class="p">()</span>

            <span class="n">c</span><span class="o">.</span><span class="n">setHeadString</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span><span class="n">varname</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">LeoNode</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20120401144849.10077: *3* all_cells</span>
    <span class="k">def</span> <span class="nf">all_cells</span><span class="p">():</span>

        <span class="c"># pylint: disable=E1101</span>
        <span class="c"># E1101:all_cells: Class &#39;LeoNode&#39; has no &#39;p&#39; member</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">g_ipm</span><span class="o">.</span><span class="n">c</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">d</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">rootnode</span><span class="p">()</span> 
        <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">children_iter</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">allNodes_iter</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">headString</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;@ipy-root&#39;</span><span class="p">:</span>
                <span class="c"># update root node (found it for the first time)</span>
                <span class="n">g_ipm</span><span class="o">.</span><span class="n">root_node</span> <span class="o">=</span> <span class="n">LeoNode</span>         
                <span class="c"># the next recursive call will use the children of new root</span>
                <span class="k">return</span> <span class="n">all_cells</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@a &#39;</span><span class="p">):</span>
                <span class="n">d</span><span class="p">[</span><span class="n">h</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s">&#39;@a &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">valid_attribute</span><span class="p">(</span><span class="n">h</span><span class="p">):</span>
                <span class="k">continue</span> 
            <span class="n">d</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">d</span>    
    <span class="c">#@+node:ekr.20120401144849.10078: *3* edit_macro</span>
    <span class="c"># E1101:edit_macro: Function &#39;edit_object_in_leo&#39; has no &#39;when_type&#39; member</span>
    <span class="nd">@edit_object_in_leo.when_type</span><span class="p">(</span><span class="n">macro</span><span class="o">.</span><span class="n">Macro</span><span class="p">)</span> <span class="c"># pylint: disable=E1101</span>
    <span class="k">def</span> <span class="nf">edit_macro</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">varname</span><span class="p">):</span>

        <span class="n">bod</span> <span class="o">=</span> <span class="s">&#39;_ip.defmacro(&quot;&quot;&quot;</span><span class="se">\\\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">obj</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="s">&#39;&quot;&quot;&quot;)&#39;</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">add_var</span><span class="p">(</span><span class="s">&#39;Macro_&#39;</span> <span class="o">+</span> <span class="n">varname</span><span class="p">)</span>
        <span class="n">node</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">bod</span>
        <span class="n">node</span><span class="o">.</span><span class="n">go</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20120401144849.10080: *3* es</span>
    <span class="k">def</span> <span class="nf">es</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>

        <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">tabName</span><span class="o">=</span><span class="s">&#39;IPython&#39;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20120401144849.10081: *3* eval_body</span>
    <span class="k">def</span> <span class="nf">eval_body</span><span class="p">(</span><span class="n">body</span><span class="p">):</span>

        <span class="n">ip</span> <span class="o">=</span> <span class="n">g_ipm</span><span class="o">.</span><span class="n">ip</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c"># just use stringlist if it&#39;s not completely legal python expression</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">SList</span><span class="p">(</span><span class="n">body</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">val</span> 

    <span class="c">#@+node:ekr.20120401144849.10082: *3* eval_node</span>
    <span class="k">def</span> <span class="nf">eval_node</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>

        <span class="n">ip</span> <span class="o">=</span> <span class="n">g_ipm</span><span class="o">.</span><span class="n">ip</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ip</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">body</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">b</span>    
        <span class="k">if</span> <span class="ow">not</span> <span class="n">body</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@cl&#39;</span><span class="p">):</span>
            <span class="c"># plain python repr node, just eval it</span>
            <span class="k">return</span> <span class="n">ip</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
        <span class="c"># @cl nodes deserve special treatment:</span>
        <span class="c"># first eval the first line (minus cl),</span>
        <span class="c"># then use it to call the rest of body.</span>
        <span class="n">first</span><span class="p">,</span> <span class="n">rest</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">tup</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c"># @cl alone SPECIAL USE-&gt; dump var to user_ns</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tup</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="n">rest</span><span class="p">)</span>
            <span class="n">ip</span><span class="o">.</span><span class="n">user_ns</span><span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="n">es</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> = </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">val</span><span class="p">)[:</span><span class="mi">20</span><span class="p">]</span>  <span class="p">))</span> 
            <span class="k">return</span> <span class="n">val</span>

        <span class="n">cl</span><span class="p">,</span> <span class="n">hd</span> <span class="o">=</span> <span class="n">tup</span> 
        <span class="n">xformer</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">ev</span><span class="p">(</span><span class="n">hd</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="n">es</span><span class="p">(</span><span class="s">&#39;Transform w/ </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">xformer</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">xformer</span><span class="p">(</span><span class="n">rest</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20120401144849.10083: *3* format_for_leo</span>
    <span class="nd">@generic</span>
    <span class="k">def</span> <span class="nf">format_for_leo</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Convert obj to string representiation (for editing in Leo)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="c"># Just an example - note that this is a bad to actually do!</span>
    <span class="c">#@verbatim</span>
    <span class="c">#@format_for_leo.when_type(list)</span>
    <span class="c">#def format_list(obj):</span>
    <span class="c">#    return &quot;\n&quot;.join(str(s) for s in obj)</span>
    <span class="c">#@+node:ekr.20120401144849.10091: *3* mb_completer</span>
    <span class="k">def</span> <span class="nf">mb_completer</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; Custom completer for minibuffer &quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">g_ipm</span><span class="o">.</span><span class="n">c</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="n">g_ipm</span><span class="o">.</span><span class="n">ip</span>

        <span class="n">cmd_param</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">):</span>
            <span class="n">cmd_param</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd_param</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">g_legacy</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ip</span><span class="o">.</span><span class="n">IP</span><span class="o">.</span><span class="n">Completer</span><span class="o">.</span><span class="n">file_matches</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">completer</span> <span class="o">=</span> <span class="n">IPCompleter</span><span class="p">(</span><span class="n">shell</span><span class="o">=</span><span class="n">ip</span><span class="p">,</span>
                    <span class="n">namespace</span><span class="o">=</span><span class="n">ip</span><span class="o">.</span><span class="n">user_ns</span><span class="p">,</span>
                    <span class="n">global_namespace</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">alias_table</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">use_readline</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                    <span class="n">config</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">completer</span><span class="o">.</span><span class="n">file_matches</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">symbol</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">commandsDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="c">#@+node:ekr.20120401144849.10092: *3* mb_f</span>
    <span class="k">def</span> <span class="nf">mb_f</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; Execute leo minibuffer commands </span>

<span class="sd">        Example:</span>
<span class="sd">         mb save-to-file</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">g_ipm</span><span class="o">.</span><span class="n">c</span>
        <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">executeMinibufferCommand</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20120401144849.10093: *3* mkbutton</span>
    <span class="k">def</span> <span class="nf">mkbutton</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">node_to_push</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">g_ipm</span><span class="o">.</span><span class="n">c</span>
        <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
            <span class="n">ib</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">getIconBarObject</span><span class="p">()</span>
            <span class="n">ib</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span><span class="n">command</span><span class="o">=</span><span class="n">node_to_push</span><span class="o">.</span><span class="n">ipush</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20120401144849.10103: *3* rootnode</span>
    <span class="k">def</span> <span class="nf">rootnode</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot; Get ileo root node (@ipy-root) </span>

<span class="sd">        if node has become invalid or has not been set, return None</span>

<span class="sd">        Note that the root is the *first* @ipy-root item found    </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># pylint: disable=E1101</span>
        <span class="c"># E1101:rootnode: Class &#39;LeoNode&#39; has no &#39;p&#39; member</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">g_ipm</span><span class="o">.</span><span class="n">c</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">g_ipm</span><span class="o">.</span><span class="n">root_node</span>

        <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">elif</span> <span class="n">c</span><span class="o">.</span><span class="n">positionExists</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">p</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">n</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g_ipm</span><span class="o">.</span><span class="n">root_node</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">return</span> <span class="bp">None</span>  
    <span class="c">#@+node:ekr.20120401144849.10105: *3* shadow_walk</span>
    <span class="k">def</span> <span class="nf">shadow_walk</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">isroot</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; source: http://leo.zwiki.org/CreateShadows</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">g_ipm</span><span class="o">.</span><span class="n">c</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">listdir</span>
        <span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span><span class="p">,</span> <span class="n">abspath</span><span class="p">,</span> <span class="n">basename</span><span class="p">,</span> <span class="n">normpath</span><span class="p">,</span> <span class="n">isfile</span>
        <span class="kn">from</span> <span class="nn">fnmatch</span> <span class="kn">import</span> <span class="n">fnmatch</span>

        <span class="n">RELATIVE_PATHS</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="n">patterns_to_ignore</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s">&#39;*.pyc&#39;</span><span class="p">,</span> <span class="s">&#39;*.leo&#39;</span><span class="p">,</span> <span class="s">&#39;*.gif&#39;</span><span class="p">,</span> <span class="s">&#39;*.png&#39;</span><span class="p">,</span> <span class="s">&#39;*.jpg&#39;</span><span class="p">,</span> <span class="s">&#39;*.json&#39;</span><span class="p">]</span>

        <span class="n">match</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">any</span><span class="p">(</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">patterns_to_ignore</span><span class="p">)</span>

        <span class="n">is_ignorable</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">any</span><span class="p">([</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">),</span> <span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="p">])</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">currentPosition</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">RELATIVE_PATHS</span><span class="p">:</span> <span class="n">directory</span> <span class="o">=</span> <span class="n">abspath</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">isroot</span><span class="p">:</span>
            <span class="n">body</span> <span class="o">=</span> <span class="s">&quot;@path </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">normpath</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">setHeadString</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">listdir</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">is_ignorable</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;file:&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                <span class="n">headline</span> <span class="o">=</span> <span class="s">&#39;@shadow </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">parent</span><span class="p">:</span>
                    <span class="n">node</span> <span class="o">=</span> <span class="n">parent</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">node</span> <span class="o">=</span> <span class="n">p</span>
                <span class="n">child</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">insertAsLastChild</span><span class="p">()</span>
                <span class="n">child</span><span class="o">.</span><span class="n">initHeadString</span><span class="p">(</span><span class="n">headline</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;dir:&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                <span class="n">headline</span> <span class="o">=</span> <span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="n">body</span> <span class="o">=</span> <span class="s">&quot;@path </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">normpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">parent</span><span class="p">:</span>
                    <span class="n">node</span> <span class="o">=</span> <span class="n">parent</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">node</span> <span class="o">=</span> <span class="n">p</span>
                <span class="n">child</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">insertAsLastChild</span><span class="p">()</span>
                <span class="n">child</span><span class="o">.</span><span class="n">initHeadString</span><span class="p">(</span><span class="n">headline</span><span class="p">)</span>
                <span class="n">child</span><span class="o">.</span><span class="n">initBodyString</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
                <span class="n">shadow_walk</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">child</span><span class="p">,</span> <span class="n">isroot</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20120401144849.10107: *3* valid_attribute</span>
    <span class="n">attribute_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;^[a-zA-Z_][a-zA-Z0-9_]*$&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">valid_attribute</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">attribute_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>    
    <span class="c">#@+node:ekr.20120401144849.10108: *3* workbook_complete</span>
    <span class="c"># E1103:workbook_complete: Function &#39;complete_object&#39; has no &#39;when_type&#39; member</span>
    <span class="nd">@generics.complete_object.when_type</span><span class="p">(</span><span class="n">LeoWorkbook</span><span class="p">)</span> <span class="c"># pylint: disable=E1103</span>
    <span class="k">def</span> <span class="nf">workbook_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">obj</span><span class="p">,</span><span class="n">prev</span><span class="p">):</span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">all_cells</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="p">[</span>
            <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">prev</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)]</span>
    <span class="c">#@+node:ekr.20120401144849.10109: ** Top-level IPython magic functions</span>
    <span class="c"># By IPython convention, these must have &quot;self&quot; as the first argument.</span>
    <span class="c">#@+node:ekr.20120401144849.10085: *3* ileo_pre_prompt_hook</span>
    <span class="k">def</span> <span class="nf">ileo_pre_prompt_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">g_ipm</span><span class="o">.</span><span class="n">c</span>
        <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">outerUpdate</span><span class="p">()</span>

        <span class="k">raise</span> <span class="n">TryNext</span>

        <span class="c"># old code</span>

            <span class="c"># # this will fail if leo is not running yet</span>
            <span class="c"># try:</span>
                <span class="c"># c.outerUpdate()</span>
            <span class="c"># except (NameError, AttributeError):</span>
                <span class="c"># pass</span>
            <span class="c"># raise TryNext</span>
    <span class="c">#@+node:ekr.20120401144849.10086: *3* lee_f</span>
    <span class="k">def</span> <span class="nf">lee_f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot; Open file(s)/objects in Leo</span>

<span class="sd">        - %lee hist -&gt; open full session history in leo</span>
<span class="sd">        - Takes an object. l = [1,2,&quot;hello&quot;]; %lee l.</span>
<span class="sd">          Alt+I in leo pushes the object back</span>
<span class="sd">        - Takes an mglob pattern, e.g. &#39;%lee *.cpp&#39; or %lee &#39;rec:*.cpp&#39;</span>
<span class="sd">        - Takes input history indices:  %lee 4 6-8 10 12-47</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># import os</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">g_ipm</span><span class="o">.</span><span class="n">c</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="n">g_ipm</span><span class="o">.</span><span class="n">ip</span>
        <span class="n">wb</span> <span class="o">=</span> <span class="n">g_ipm</span><span class="o">.</span><span class="n">wb</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="s">&#39;hist&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                    <span class="n">wb</span><span class="o">.</span><span class="n">ipython_history</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">g_ipm</span><span class="o">.</span><span class="n">get_history</span><span class="p">()</span>
                    <span class="n">wb</span><span class="o">.</span><span class="n">ipython_history</span><span class="o">.</span><span class="n">go</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;no c&#39;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="n">s</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                <span class="c"># numbers; push input slices to leo</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_input_slices</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="bp">True</span><span class="p">)</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">add_var</span><span class="p">(</span><span class="s">&#39;stored_ipython_input&#39;</span><span class="p">)</span>
                <span class="n">v</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="c"># try editing the object directly</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">user_ns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">edit_object_in_leo</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="p">:</span>
                <span class="c"># print(&#39;file not found: %s&#39; % s)</span>
                <span class="k">return</span>

            <span class="c"># if it&#39;s not object, it&#39;s a file name / mglob pattern</span>
            <span class="kn">from</span> <span class="nn">IPython.external</span> <span class="kn">import</span> <span class="n">mglob</span>

            <span class="n">files</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">mglob</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">findNodeAnywhere</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&#39;@auto &#39;</span> <span class="o">+</span> <span class="n">fname</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">currentPosition</span><span class="p">()</span><span class="o">.</span><span class="n">insertAfter</span><span class="p">()</span>

                <span class="n">p</span><span class="o">.</span><span class="n">setHeadString</span><span class="p">(</span><span class="s">&#39;@auto &#39;</span> <span class="o">+</span> <span class="n">fname</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">setBodyString</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Editing file(s), </span><span class="se">\</span>
<span class="s">                press ctrl+shift+w in Leo to write @auto nodes&quot;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20120401144849.10087: *3* leoref_f</span>
    <span class="k">def</span> <span class="nf">leoref_f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Quick reference for ILeo &quot;&quot;&quot;</span>

        <span class="k">print</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">        </span><span class="si">%le</span><span class="s">e file/object - open file / object in leo</span>
<span class="s">        %lleo Launch leo (use if you started ipython first!)</span>
<span class="s">        wb.foo.v  - eval node foo (i.e. headstring is &#39;foo&#39; or &#39;@ipy foo&#39;)</span>
<span class="s">        wb.foo.v = 12 - assign to body of node foo</span>
<span class="s">        wb.foo.b - read or write the body of node foo</span>
<span class="s">        wb.foo.l - body of node foo as string list</span>

<span class="s">        for el in wb.foo:</span>
<span class="s">          print el.v</span>

<span class="s">        &quot;&quot;&quot;</span>
        <span class="p">))</span>
    <span class="c">#@+node:ekr.20120401144849.10088: *3* lleo_f</span>
    <span class="k">def</span> <span class="nf">lleo_f</span><span class="p">(</span><span class="n">selg</span><span class="p">,</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Launch leo from within IPython</span>

<span class="sd">        This command will return immediately when Leo has been</span>
<span class="sd">        launched, leaving a Leo session that is connected </span>
<span class="sd">        with current IPython session (once you press alt+I in leo)</span>

<span class="sd">        Usage::</span>
<span class="sd">          lleo foo.leo</span>
<span class="sd">          lleo </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">import</span> <span class="nn">os</span>
        <span class="kn">import</span> <span class="nn">sys</span>
        <span class="kn">import</span> <span class="nn">shlex</span>
        <span class="n">argv</span> <span class="o">=</span> <span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="n">g_ipm</span><span class="o">.</span><span class="n">ip</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ip</span><span class="p">:</span> <span class="k">return</span>

        <span class="c"># when run without args, leo will open ipython_notebook for </span>
        <span class="c"># quick note taking / experimentation</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">argv</span><span class="p">:</span>
            <span class="n">argv</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ip</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">ipythondir</span><span class="p">,</span><span class="s">&#39;ipython_notebook.leo&#39;</span><span class="p">)]</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;leo&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">argv</span>

        <span class="c"># Set the --ipython option. </span>
            <span class="c"># global _request_immediate_connect</span>
            <span class="c"># _request_immediate_connect = True.</span>

        <span class="k">if</span> <span class="s">&#39;--ipython&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="o">.</span><span class="n">append</span> <span class="p">(</span><span class="s">&#39;--ipython&#39;</span><span class="p">)</span>

        <span class="kn">import</span> <span class="nn">leo.core.runLeo</span>
        <span class="n">leo</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">runLeo</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20120401144849.10089: *3* lno_f</span>
    <span class="k">def</span> <span class="nf">lno_f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; %lno [note text]</span>

<span class="sd">        Gather quick notes to leo notebook</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">wb</span> <span class="o">=</span> <span class="n">g_ipm</span><span class="o">.</span><span class="n">wb</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">scr</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="n">Scratch</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;No leo yet, attempt launch of notebook...&quot;</span><span class="p">)</span>
            <span class="n">lleo_f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="n">scr</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="n">Scratch</span>

        <span class="n">child</span> <span class="o">=</span> <span class="n">scr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">child</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">scr</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">()</span>
            <span class="n">child</span> <span class="o">=</span> <span class="n">scr</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span>

        <span class="n">child</span><span class="o">.</span><span class="n">go</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20120401144849.10090: *3* lshadow_f</span>
    <span class="k">def</span> <span class="nf">lshadow_f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; lshadow [path] </span>

<span class="sd">        Create shadow nodes for path (default .)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">g_ipm</span><span class="o">.</span><span class="n">c</span>
        <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">arg</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
                <span class="n">arg</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">insertAfter</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">setCurrentPosition</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">shadow_walk</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>
    <span class="c">#@-others</span>
<span class="c">#@-leo</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Leo API 4.11dev documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Ed K. Ream.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
  </body>
</html>