<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>leo.core.leoRst &mdash; Leo API 4.11dev documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '4.11dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Leo API 4.11dev documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Leo API 4.11dev documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for leo.core.leoRst</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="c">#@+leo-ver=5-thin</span>
<span class="c">#@+node:ekr.20090502071837.3: * @file leoRst.py</span>
<span class="c">#@@first</span>

<span class="c">#@+&lt;&lt; docstring &gt;&gt;</span>
<span class="c">#@+node:ekr.20090502071837.4: ** &lt;&lt; docstring &gt;&gt;</span>
<span class="sd">&#39;&#39;&#39;Support for restructured text (rST), adapted from rst3 plugin.</span>

<span class="sd">For full documentation, see:</span>
<span class="sd">http://webpages.charter.net/edreamleo/rstplugin3.html</span>

<span class="sd">To generate documents from rST files, Python&#39;s docutils_ module must be</span>
<span class="sd">installed. The code will use the SilverCity_ syntax coloring package if is is</span>
<span class="sd">available.&#39;&#39;&#39;</span>
<span class="c">#@-&lt;&lt; docstring &gt;&gt;</span>

<span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">bwm_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;bwm_file&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>

<span class="c">#@+&lt;&lt; imports &gt;&gt;</span>
<span class="c">#@+node:ekr.20100908120927.5971: ** &lt;&lt; imports &gt;&gt; (leoRst)</span>
<span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>
<span class="kn">import</span> <span class="nn">leo.core.leoGlobals</span> <span class="kn">as</span> <span class="nn">g</span>
<span class="n">docutils</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">importExtension</span><span class="p">(</span><span class="s">&#39;docutils&#39;</span><span class="p">,</span><span class="n">pluginName</span><span class="o">=</span><span class="s">&#39;leoRst.py&#39;</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="k">if</span> <span class="n">docutils</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;leoRst.py&#39;</span><span class="p">,</span><span class="n">docutils</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">docutils</span> <span class="kn">import</span> <span class="n">parsers</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">parsers</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;leoRst.py&#39;</span><span class="p">,</span><span class="n">parsers</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">docutils.parsers</span> <span class="kn">import</span> <span class="n">rst</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">rst</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;leoRst.py&#39;</span><span class="p">,</span><span class="n">rst</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">parsers</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">rst</span><span class="p">:</span>
            <span class="n">docutils</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">docutils</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
        <span class="n">docutils</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">html.parser</span> <span class="kn">as</span> <span class="nn">HTMLParser</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">HTMLParser</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">leo.plugins.mod_http</span> <span class="kn">as</span> <span class="nn">mod_http</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">mod_http</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="c"># Don&#39;t let a problem with a plugin crash Leo&#39;s core!</span>
    <span class="c"># g.es_print(&#39;leoRst: can not import leo.plugins.mod_http&#39;)</span>
    <span class="c"># g.es_exception()</span>
    <span class="n">mod_http</span> <span class="o">=</span> <span class="bp">None</span>
<span class="c"># import os</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">SilverCity</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">SilverCity</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">io</span>
    <span class="n">StringIO</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">StringIO</span>
    <span class="n">StringIO</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span>
<span class="c"># import sys</span>
<span class="c"># import tempfile</span>
<span class="c">#@-&lt;&lt; imports &gt;&gt;</span>

<span class="c">#@+others</span>
<span class="c">#@+node:ekr.20090502071837.12: ** code_block</span>
<div class="viewcode-block" id="code_block"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.code_block">[docs]</a><span class="k">def</span> <span class="nf">code_block</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">arguments</span><span class="p">,</span><span class="n">options</span><span class="p">,</span>
    <span class="n">content</span><span class="p">,</span><span class="n">lineno</span><span class="p">,</span><span class="n">content_offset</span><span class="p">,</span><span class="n">block_text</span><span class="p">,</span><span class="n">state</span><span class="p">,</span><span class="n">state_machine</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Implement the code-block directive for docutils.&#39;&#39;&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">language</span> <span class="o">=</span> <span class="n">arguments</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c"># See http://aspn.activestate.com/ASPN/Cookbook/Python/Recipe/252170</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">SilverCity</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">SilverCity</span><span class="p">,</span><span class="n">language</span><span class="p">)</span>
        <span class="n">generator</span> <span class="o">=</span> <span class="n">module</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span><span class="n">language</span><span class="o">+</span><span class="s">&quot;HTMLGenerator&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">generator</span><span class="p">:</span>
            <span class="n">io</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
            <span class="n">generator</span><span class="p">()</span><span class="o">.</span><span class="n">generate_html</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>
            <span class="n">html</span> <span class="o">=</span> <span class="s">&#39;&lt;div class=&quot;code-block&quot;&gt;</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s">&lt;/div&gt;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">io</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">html</span> <span class="o">=</span> <span class="s">&#39;&lt;div class=&quot;code-block&quot;&gt;</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s">&lt;/div&gt;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="s">&#39;&lt;br&gt;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        <span class="n">raw</span> <span class="o">=</span> <span class="n">docutils</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">html</span><span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="s">&#39;html&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">raw</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span> <span class="c"># Return html as shown.  Lines are separated by &lt;br&gt; elements.</span>
        <span class="n">g</span><span class="o">.</span><span class="n">es_trace</span><span class="p">(</span><span class="s">&#39;exception in rst3:code_block()&#39;</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span>

<span class="c"># See http://docutils.sourceforge.net/spec/howto/rst-directives.html</span></div>
<span class="n">code_block</span><span class="o">.</span><span class="n">arguments</span> <span class="o">=</span> <span class="p">(</span>
    <span class="mi">1</span><span class="p">,</span> <span class="c"># Number of required arguments.</span>
    <span class="mi">0</span><span class="p">,</span> <span class="c"># Number of optional arguments.</span>
    <span class="mi">0</span><span class="p">)</span> <span class="c"># True if final argument may contain whitespace.</span>

<span class="c"># A mapping from option name to conversion function.</span>
<span class="k">if</span> <span class="n">docutils</span><span class="p">:</span>
    <span class="n">code_block</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;language&#39;</span><span class="p">:</span>
        <span class="n">docutils</span><span class="o">.</span><span class="n">parsers</span><span class="o">.</span><span class="n">rst</span><span class="o">.</span><span class="n">directives</span><span class="o">.</span><span class="n">unchanged</span> <span class="c"># Return the text argument, unchanged.</span>
        <span class="c">### rst.directives.unchanged # Return the text argument, unchanged.</span>
    <span class="p">}</span>
    <span class="n">code_block</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="mi">1</span> <span class="c"># True if content is allowed.</span>

    <span class="c"># Register the directive with docutils.</span>
    <span class="n">docutils</span><span class="o">.</span><span class="n">parsers</span><span class="o">.</span><span class="n">rst</span><span class="o">.</span><span class="n">directives</span><span class="o">.</span><span class="n">register_directive</span><span class="p">(</span><span class="s">&#39;code-block&#39;</span><span class="p">,</span><span class="n">code_block</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">code_block</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
<span class="c">#@+node:ekr.20090502071837.33: ** class rstCommands</span>
<span class="c">#@+at This plugin optionally stores information for the http plugin. Each node can</span>
<span class="c"># have one additional attribute, with the name rst_http_attributename, which is a</span>
<span class="c"># list. The first three elements are stack of tags, the rest is html code::</span>
<span class="c"># </span>
<span class="c">#     [&lt;tag n start&gt;, &lt;tag n end&gt;, &lt;other stack elements&gt;, &lt;html line 1&gt;, &lt;html line 2&gt;, ...]</span>
<span class="c"># </span>
<span class="c"># &lt;other stack elements has the same structure::</span>
<span class="c"># </span>
<span class="c">#     [&lt;tag n-1 start&gt;, &lt;tag n-1 end&gt;, &lt;other stack elements&gt;]</span>
<span class="c">#@@c</span>

<div class="viewcode-block" id="rstCommands"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands">[docs]</a><span class="k">class</span> <span class="nc">rstCommands</span><span class="p">:</span>

    <span class="sd">&#39;&#39;&#39;A class to write rst markup in Leo outlines.&#39;&#39;&#39;</span>

    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20090502071837.34: *3*  Birth &amp; init (rstCommands)</span>
    <span class="c">#@+node:ekr.20090502071837.35: *4*  ctor (rstClass)</span>
    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>

        <span class="k">global</span> <span class="n">SilverCity</span>

        <span class="c"># g.trace(c)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">c</span>
        <span class="c">#@+&lt;&lt; init ivars &gt;&gt;</span>
        <span class="c">#@+node:ekr.20090502071837.36: *5* &lt;&lt; init ivars &gt;&gt; (leoRst)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">silverCityWarningGiven</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># The options dictionary.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeOptionDict</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># Keys are vnodes, values are optionsDict&#39;s.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optionsDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scriptSettingsDict</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># 2010/08/12: for format-code command.</span>

        <span class="c"># Formatting...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code_block_string</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topLevel</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topNode</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_alternate_code_block</span> <span class="o">=</span> <span class="n">SilverCity</span> <span class="ow">is</span> <span class="bp">None</span>

        <span class="c"># Http support...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeNumber</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c"># All nodes are numbered so that unique anchors can be generated.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">http_map</span> <span class="o">=</span> <span class="p">{}</span> 
        <span class="c"># Keys are named hyperlink targets.  Value are positions.</span>
        <span class="c"># The targets mark the beginning of the html code specific</span>
        <span class="c"># for this position.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">anchor_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c"># Maps anchors (generated by this module) to positions</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rst3_all</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c"># Set to True by the button which processes all @rst trees.</span>

        <span class="c"># For writing.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atAutoWrite</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># True, special cases for writeAtAutoFile.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atAutoWriteUnderlines</span> <span class="o">=</span> <span class="s">&#39;&#39;</span> <span class="c"># Forced underlines for writeAtAutoFile.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leoDirectivesList</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">globalDirectiveList</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="s">&#39;utf-8&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># The open file being written.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="s">&#39;&#39;</span> <span class="c"># The path from any @path directive.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># The written source as a string.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trialWrite</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># True if doing a trialWrite.</span>
        <span class="c">#@-&lt;&lt; init ivars &gt;&gt;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">createDefaultOptionsDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initOptionsFromSettings</span><span class="p">()</span> <span class="c"># Still needed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initHeadlineCommands</span><span class="p">()</span> <span class="c"># Only needs to be done once.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initSingleNodeOptions</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20090502071837.102: *4*  getPublicCommands</span>
<div class="viewcode-block" id="rstCommands.getPublicCommands"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.getPublicCommands">[docs]</a>    <span class="k">def</span> <span class="nf">getPublicCommands</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>        

        <span class="k">return</span> <span class="p">{</span>
            <span class="s">&#39;rst3&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rst3</span><span class="p">,</span> <span class="c"># Formerly write-restructured-text.</span>
            <span class="s">&#39;code-to-rst&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">code_to_rst_command</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="c">#@+node:ekr.20090511055302.5792: *4* finishCreate (rstCommands)</span></div>
<div class="viewcode-block" id="rstCommands.finishCreate"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.finishCreate">[docs]</a>    <span class="k">def</span> <span class="nf">finishCreate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getPublicCommands</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">commandsDict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20090502071837.38: *4* initHeadlineCommands</span></div>
<div class="viewcode-block" id="rstCommands.initHeadlineCommands"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.initHeadlineCommands">[docs]</a>    <span class="k">def</span> <span class="nf">initHeadlineCommands</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Init the list of headline commands used by writeHeadline.&#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">headlineCommands</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s">&#39;@rst&#39;</span><span class="p">,</span>
            <span class="s">&#39;@rst-code&#39;</span><span class="p">,</span>
            <span class="s">&#39;@rst-default-path&#39;</span><span class="p">,</span>
            <span class="s">&#39;@rst-doc-only&#39;</span><span class="p">,</span>
            <span class="s">&#39;@rst-head&#39;</span><span class="p">,</span>
            <span class="s">&#39;@rst-ignore-node&#39;</span><span class="p">,</span>
            <span class="s">&#39;@rst-ignore-tree&#39;</span><span class="p">,</span>
            <span class="s">&#39;@rst-no-head&#39;</span><span class="p">,</span>
            <span class="s">&#39;@rst-no-headlines&#39;</span><span class="p">,</span>
            <span class="s">&#39;@rst-option&#39;</span><span class="p">,</span>
            <span class="s">&#39;@rst-options&#39;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="c">#@+node:ekr.20090502071837.39: *4* initSingleNodeOptions</span></div>
<div class="viewcode-block" id="rstCommands.initSingleNodeOptions"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.initSingleNodeOptions">[docs]</a>    <span class="k">def</span> <span class="nf">initSingleNodeOptions</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">singleNodeOptions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s">&#39;ignore_this_headline&#39;</span><span class="p">,</span>
            <span class="s">&#39;ignore_this_node&#39;</span><span class="p">,</span>
            <span class="s">&#39;ignore_this_tree&#39;</span><span class="p">,</span>
            <span class="s">&#39;preformat_this_node&#39;</span><span class="p">,</span>
            <span class="s">&#39;show_this_headline&#39;</span><span class="p">,</span>
        <span class="p">]</span>
    <span class="c">#@+node:ekr.20090502071837.40: *4* munge</span></div>
<div class="viewcode-block" id="rstCommands.munge"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.munge">[docs]</a>    <span class="k">def</span> <span class="nf">munge</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Convert an option name to the equivalent ivar name.&#39;&#39;&#39;</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;rst&#39;</span><span class="p">),</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;_&#39;</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">s</span>
    <span class="c">#@+node:ekr.20100813041139.5920: *3* Entry points</span>
    <span class="c">#@+node:ekr.20100812082517.5945: *4* code_to_rst_command &amp; helpers</span></div>
<div class="viewcode-block" id="rstCommands.code_to_rst_command"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.code_to_rst_command">[docs]</a>    <span class="k">def</span> <span class="nf">code_to_rst_command</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">scriptSettingsDict</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Format the presently selected node as computer code.</span>

<span class="sd">        Settings from scriptSettingsDict override normal settings.</span>

<span class="sd">        On exit:</span>
<span class="sd">            self.source contains rst sources</span>
<span class="sd">            self.stringOutput contains docutils output if docutils called.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topNode</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topLevel</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">level</span><span class="p">()</span>

        <span class="c"># **Important**: This command works as much like the rst3 command as possible.</span>
        <span class="c"># Difference arise because there is no @rst node to specify a filename.</span>
        <span class="c"># Instead we get the filename from scriptSettingsDict, or use &#39;code_to_rst.html&#39;</span>

        <span class="c"># Capture the settings, munging all settings.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scriptSettingsDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">scriptSettingsDict</span>
        <span class="k">if</span> <span class="n">d</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scriptSettingsDict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">munge</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="c"># Init options...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocessTree</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_write</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="c"># scanAllDirectives sets self.path and self.encoding.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scanAllOptions</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="c"># Settings for p are valid after this call.</span>
        <span class="n">callDocutils</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;call_docutils&#39;</span><span class="p">)</span>
        <span class="n">writeIntermediateFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;write_intermediate_file&#39;</span><span class="p">)</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;output-file-name&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;code_to_rst.html&#39;</span>
        <span class="n">junk</span><span class="p">,</span><span class="n">ext</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_splitext</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

        <span class="c"># Write the rst sources to self.sources...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_code_tree</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">callDocutils</span> <span class="ow">or</span> <span class="n">writeIntermediateFile</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_files</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span><span class="n">callDocutils</span><span class="p">,</span><span class="n">toString</span><span class="p">,</span><span class="n">writeIntermediateFile</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100812082517.5963: *5* write_code_body &amp; helpers</span></div>
<div class="viewcode-block" id="rstCommands.write_code_body"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.write_code_body">[docs]</a>    <span class="k">def</span> <span class="nf">write_code_body</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c"># for traces.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="k">return</span> <span class="c"># No need to write any more newlines.</span>

        <span class="n">showDocsAsParagraphs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;show_doc_parts_as_paragraphs&#39;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_parts</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="n">showDocsAsParagraphs</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">kind</span><span class="p">,</span><span class="n">lines</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;@rst-option&#39;</span><span class="p">:</span> <span class="c"># Also handles &#39;@rst-options&#39;</span>
                <span class="k">pass</span> <span class="c"># The prepass has already handled the options.</span>
            <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;@rst-markup&#39;</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;@doc&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">showDocsAsParagraphs</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write_code_block</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;code&#39;</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write_code_block</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;Can not happen&#39;</span><span class="p">,</span><span class="n">kind</span><span class="p">)</span>

        <span class="c"># Write the lines with exactly two trailing newlines.</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n\n</span><span class="s">&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100812082517.5964: *6* split_parts</span></div>
<div class="viewcode-block" id="rstCommands.split_parts"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.split_parts">[docs]</a>    <span class="k">def</span> <span class="nf">split_parts</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span><span class="n">showDocsAsParagraphs</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Split a list of body lines into a list of tuples (kind,lines).&#39;&#39;&#39;</span>

        <span class="n">kind</span><span class="p">,</span><span class="n">parts</span><span class="p">,</span><span class="n">part_lines</span> <span class="o">=</span> <span class="s">&#39;code&#39;</span><span class="p">,[],[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;@ @rst-markup&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">part_lines</span><span class="p">:</span> <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">kind</span><span class="p">,</span><span class="n">part_lines</span><span class="p">[:]),)</span>
                <span class="n">kind</span> <span class="o">=</span> <span class="s">&#39;@rst-markup&#39;</span>
                <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="s">&#39;@ @rst-markup&#39;</span><span class="p">)</span>
                <span class="n">after</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">n</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">part_lines</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">after</span><span class="p">,[</span><span class="n">after</span><span class="p">],[])</span>
            <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@ @rst-option&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">part_lines</span><span class="p">:</span> <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">kind</span><span class="p">,</span><span class="n">part_lines</span><span class="p">[:]),)</span>
                <span class="n">kind</span><span class="p">,</span><span class="n">part_lines</span> <span class="o">=</span> <span class="s">&#39;@rst-option&#39;</span><span class="p">,[</span><span class="n">s</span><span class="p">]</span> <span class="c"># part_lines will be ignored.</span>
            <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@ &#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@doc&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">showDocsAsParagraphs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">part_lines</span><span class="p">:</span> <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">kind</span><span class="p">,</span><span class="n">part_lines</span><span class="p">[:]),)</span>
                    <span class="n">kind</span> <span class="o">=</span> <span class="s">&#39;@doc&#39;</span>
                    <span class="c"># Put only what follows @ or @doc</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@doc&#39;</span><span class="p">),</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">after</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">n</span><span class="p">:]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
                    <span class="n">part_lines</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">after</span><span class="p">,[</span><span class="n">after</span><span class="p">],[])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">part_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="c"># still in code mode.</span>
            <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;@c&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">kind</span> <span class="o">!=</span> <span class="s">&#39;code&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;@doc&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">showDocsAsParagraphs</span><span class="p">:</span>
                    <span class="n">part_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="c"># Show the @c as code.</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">kind</span><span class="p">,</span><span class="n">part_lines</span><span class="p">[:]),)</span>
                <span class="n">kind</span><span class="p">,</span><span class="n">part_lines</span> <span class="o">=</span> <span class="s">&#39;code&#39;</span><span class="p">,[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">part_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">part_lines</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">kind</span><span class="p">,</span><span class="n">part_lines</span><span class="p">[:]),)</span>

        <span class="k">return</span> <span class="n">parts</span>
    <span class="c">#@+node:ekr.20100812082517.5965: *6* write_code_block</span></div>
<div class="viewcode-block" id="rstCommands.write_code_block"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.write_code_block">[docs]</a>    <span class="k">def</span> <span class="nf">write_code_block</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lines</span><span class="p">):</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;::</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">]</span> <span class="c"># [&#39;[**code block**]\n\n&#39;]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;number-code-lines&#39;</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;    </span><span class="si">%d</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">s</span><span class="p">))</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s">&#39;    </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">])</span>

        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n\n</span><span class="s">&#39;</span>
        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100812082517.5966: *5* write_code_headline &amp; helper</span></div>
<div class="viewcode-block" id="rstCommands.write_code_headline"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.write_code_headline">[docs]</a>    <span class="k">def</span> <span class="nf">write_code_headline</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Generate an rST section if options permit it.</span>
<span class="sd">        Remove headline commands from the headline first,</span>
<span class="sd">        and never generate an rST section for @rst-option and @rst-options.&#39;&#39;&#39;</span>


        <span class="n">docOnly</span>             <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;doc_only_mode&#39;</span><span class="p">)</span>
        <span class="n">ignore</span>              <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;ignore_this_headline&#39;</span><span class="p">)</span>
        <span class="n">showHeadlines</span>       <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;show_headlines&#39;</span><span class="p">)</span>
        <span class="n">showThisHeadline</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;show_this_headline&#39;</span><span class="p">)</span>
        <span class="n">showOrganizers</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;show_organizer_nodes&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">p</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">topNode</span> <span class="ow">or</span>
            <span class="n">ignore</span> <span class="ow">or</span>
            <span class="n">docOnly</span> <span class="ow">or</span> <span class="c"># handleDocOnlyMode handles this.</span>
            <span class="ow">not</span> <span class="n">showHeadlines</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">showThisHeadline</span> <span class="ow">or</span>
            <span class="c"># docOnly and not showOrganizers and not thisHeadline or</span>
            <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">showOrganizers</span> <span class="ow">or</span>
            <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">showOrganizers</span>
        <span class="p">):</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">write_code_headline_helper</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100812082517.5967: *6* write_code_headline_helper</span></div>
<div class="viewcode-block" id="rstCommands.write_code_headline_helper"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.write_code_headline_helper">[docs]</a>    <span class="k">def</span> <span class="nf">write_code_headline_helper</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="n">h</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c"># Remove any headline command before writing the headline.</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_id</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">chars</span><span class="o">=</span><span class="s">&#39;@-&#39;</span><span class="p">)</span>
        <span class="n">word</span> <span class="o">=</span> <span class="n">h</span> <span class="p">[:</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">word</span><span class="p">:</span>
            <span class="c"># Never generate a section for @rst-option or @rst-options or @rst-no-head.</span>
            <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;@rst-option&#39;</span><span class="p">,</span><span class="s">&#39;@rst-options&#39;</span><span class="p">,</span><span class="s">&#39;@rst-no-head&#39;</span><span class="p">,</span><span class="s">&#39;@rst-no-headlines&#39;</span><span class="p">):</span>
                <span class="k">return</span>

            <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;@rst-ignore-node&#39;</span><span class="p">,</span><span class="s">&#39;@rst-ignore-tree&#39;</span><span class="p">,</span><span class="s">&#39;@rst-ignore&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">word</span> <span class="o">==</span> <span class="n">prefix</span><span class="p">:</span>
                    <span class="n">h</span> <span class="o">=</span> <span class="n">h</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">):]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">h</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;show_sections&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">underline</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">p</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">**</span><span class="si">%s</span><span class="s">**</span><span class="se">\n\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">h</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;*&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20100812082517.5968: *5* write_code_node</span></div>
<div class="viewcode-block" id="rstCommands.write_code_node"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.write_code_node">[docs]</a>    <span class="k">def</span> <span class="nf">write_code_node</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Format a node according to the options presently in effect.</span>

<span class="sd">        Side effect: advance p&#39;&#39;&#39;</span>

        <span class="n">h</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scanAllOptions</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;ignore_this_tree&#39;</span><span class="p">):</span>
            <span class="n">p</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;ignore_this_node&#39;</span><span class="p">):</span>
            <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;@rst-options&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;show_options_nodes&#39;</span><span class="p">):</span>
            <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">http_addNodeMarker</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_code_headline</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_code_body</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20100812082517.5939: *5* write_code_tree</span></div>
<div class="viewcode-block" id="rstCommands.write_code_tree"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.write_code_tree">[docs]</a>    <span class="k">def</span> <span class="nf">write_code_tree</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Write p&#39;s tree as code to self.outputFile.&#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scanAllOptions</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="c"># So we can get the next option.</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;generate_rst_header_comment&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;.. rst3: filename: </span><span class="si">%s</span><span class="se">\n\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">)</span>

        <span class="c"># We can&#39;t use an iterator because we may skip parts of the tree.</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c"># Only one copy is needed for traversal.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topNode</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c"># Indicate the top of this tree.</span>
        <span class="n">after</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">nodeAfterTree</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">after</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_code_node</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="c"># Side effect: advances p.</span>
    <span class="c">#@+node:ekr.20090511055302.5793: *4* rst3 command &amp; helpers</span></div>
<div class="viewcode-block" id="rstCommands.rst3"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.rst3">[docs]</a>    <span class="k">def</span> <span class="nf">rst3</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Write all @rst nodes.&#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">processTopTree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20090502071837.62: *5* processTopTree</span></div>
<div class="viewcode-block" id="rstCommands.processTopTree"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.processTopTree">[docs]</a>    <span class="k">def</span> <span class="nf">processTopTree</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">justOneFile</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="n">current</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c"># This strange looking code looks up and down the tree for @rst nodes.</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">current</span><span class="o">.</span><span class="n">self_and_parents</span><span class="p">():</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span>
            <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@rst&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">h</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@rst-&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">processTree</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">ext</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">justOneFile</span><span class="o">=</span><span class="n">justOneFile</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">h</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@slides&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">processTree</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">ext</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">justOneFile</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processTree</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="n">ext</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">justOneFile</span><span class="o">=</span><span class="n">justOneFile</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&#39;done&#39;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20090502071837.63: *5* processTree</span></div>
<div class="viewcode-block" id="rstCommands.processTree"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.processTree">[docs]</a>    <span class="k">def</span> <span class="nf">processTree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">ext</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">justOneFile</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Process all @rst nodes in a tree.</span>
<span class="sd">        ext is the docutils extention: it&#39;s useful for scripts and unit tests.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocessTree</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">found</span> <span class="o">=</span> <span class="bp">False</span> <span class="p">;</span> <span class="bp">self</span><span class="o">.</span><span class="n">stringOutput</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="p">;</span> <span class="n">after</span><span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">nodeAfterTree</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">after</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;@rst&quot;</span><span class="p">):</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">fn</span> <span class="ow">and</span> <span class="n">fn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;-&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">toString</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fn</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;found: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write_rst_tree</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">ext</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="n">toString</span><span class="p">,</span><span class="n">justOneFile</span><span class="o">=</span><span class="n">justOneFile</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">scanAllOptions</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="c"># Restore the top-level verbose setting.</span>
                    <span class="k">if</span> <span class="n">toString</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">stringOutput</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;@slides&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_slides</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="n">found</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">p</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;No @rst or @slides nodes in selected tree&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span><span class="p">,</span><span class="bp">None</span>
    <span class="c">#@+node:ekr.20090502071837.64: *5* write_rst_tree</span></div>
<div class="viewcode-block" id="rstCommands.write_rst_tree"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.write_rst_tree">[docs]</a>    <span class="k">def</span> <span class="nf">write_rst_tree</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">ext</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">justOneFile</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Convert p&#39;s tree to rst sources.</span>
<span class="sd">        Optionally call docutils to convert rst to output.</span>

<span class="sd">        On exit:</span>
<span class="sd">            self.source contains rst sources</span>
<span class="sd">            self.stringOutput contains docutils output if docutils called.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">topNode</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topLevel</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">level</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">toString</span><span class="p">:</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="n">ext</span> <span class="ow">or</span> <span class="s">&#39;.html&#39;</span> <span class="c"># 2010/08/12: Unit test found this.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">junk</span><span class="p">,</span><span class="n">ext</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_splitext</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">ext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ext</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">):</span> <span class="n">ext</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">ext</span>

        <span class="c"># Init options...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_write</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="c"># ScanAllDirectives sets self.path and self.encoding.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scanAllOptions</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="c"># Settings for p are valid after this call.</span>
        <span class="n">callDocutils</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;call_docutils&#39;</span><span class="p">)</span>
        <span class="n">writeIntermediateFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;write_intermediate_file&#39;</span><span class="p">)</span>

        <span class="c"># Write the rst sources to self.source.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeTree</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span> <span class="c"># the rST sources.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stringOutput</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">callDocutils</span> <span class="ow">or</span> <span class="n">writeIntermediateFile</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_files</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span><span class="n">callDocutils</span><span class="p">,</span><span class="n">toString</span><span class="p">,</span><span class="n">writeIntermediateFile</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100822092546.5835: *5* write_slides &amp; helper</span></div>
<div class="viewcode-block" id="rstCommands.write_slides"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.write_slides">[docs]</a>    <span class="k">def</span> <span class="nf">write_slides</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Convert p&#39;s children to slides.&#39;&#39;&#39;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="p">;</span> <span class="n">h</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_id</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c"># Skip the &#39;@&#39;</span>
        <span class="n">kind</span><span class="p">,</span><span class="n">fn</span> <span class="o">=</span> <span class="n">h</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span><span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fn</span><span class="p">:</span> <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> requires file name&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kind</span><span class="p">))</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">firstChild</span><span class="p">()</span><span class="o">.</span><span class="n">h</span> <span class="ow">or</span> <span class="s">&#39;&lt;no slide&gt;&#39;</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">title</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
        <span class="n">n_tot</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">numberOfChildren</span><span class="p">()</span>

        <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_write</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="c"># ScanAllDirectives sets self.path and self.encoding.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scanAllOptions</span><span class="p">(</span><span class="n">child</span><span class="p">)</span> <span class="c"># Settings for child are valid after this call.</span>
            <span class="c"># Compute the slide&#39;s file name.</span>
            <span class="n">fn2</span><span class="p">,</span><span class="n">ext</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_splitext</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="n">fn2</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">-</span><span class="si">%03d%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fn2</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">ext</span><span class="p">)</span> <span class="c"># Use leading zeros for :glob:.</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c"># Write the rst sources to self.source.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeSlideTitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">n_tot</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeBody</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span> <span class="c"># the rST sources.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">stringOutput</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span><span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_files</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span><span class="n">fn2</span><span class="p">,</span>
                <span class="n">callDocutils</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;call_docutils&#39;</span><span class="p">),</span>
                <span class="n">toString</span><span class="o">=</span><span class="n">toString</span><span class="p">,</span>
                <span class="n">writeIntermediateFile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;write_intermediate_file&#39;</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20100822174725.5836: *6* writeSlideTitle</span></div>
<div class="viewcode-block" id="rstCommands.writeSlideTitle"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.writeSlideTitle">[docs]</a>    <span class="k">def</span> <span class="nf">writeSlideTitle</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">title</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">n_tot</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Write the title, underlined with the &#39;#&#39; character.&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">n</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s"> of </span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">n_tot</span><span class="p">)</span>

        <span class="n">width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="n">title</span><span class="p">,</span>
            <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span><span class="n">reportErrors</span><span class="o">=</span><span class="bp">False</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s"> </span><span class="se">\n\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">title</span><span class="p">,(</span><span class="s">&#39;#&#39;</span><span class="o">*</span><span class="n">width</span><span class="p">)))</span>
    <span class="c">#@+node:ekr.20090502071837.58: *5* write methods (rst3 command)</span>
    <span class="c">#@+node:ekr.20090502071837.68: *6* getDocPart</span></div>
<div class="viewcode-block" id="rstCommands.getDocPart"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.getDocPart">[docs]</a>    <span class="k">def</span> <span class="nf">getDocPart</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>

        <span class="c"># g.trace(&#39;n&#39;,n,repr(&#39;&#39;.join(lines)))</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c">#@+&lt;&lt; Append whatever follows @doc or @space to result &gt;&gt;</span>
        <span class="c">#@+node:ekr.20090502071837.69: *7* &lt;&lt; Append whatever follows @doc or @space to result &gt;&gt;</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@doc&#39;</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

            <span class="c"># New in Leo 4.4.4: remove these special tags.</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;@rst-options&#39;</span><span class="p">,</span><span class="s">&#39;@rst-option&#39;</span><span class="p">,</span><span class="s">&#39;@rst-markup&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">tag</span><span class="p">):</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">tag</span><span class="p">):]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="c">#@-&lt;&lt; Append whatever follows @doc or @space to result &gt;&gt;</span>
        <span class="k">while</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">lines</span> <span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="p">;</span> <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;@code&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;@c&#39;</span><span class="p">):</span>
                <span class="k">break</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">n</span><span class="p">,</span> <span class="n">result</span>
    <span class="c">#@+node:ekr.20090502071837.81: *6* handleSpecialDocParts</span></div>
<div class="viewcode-block" id="rstCommands.handleSpecialDocParts"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.handleSpecialDocParts">[docs]</a>    <span class="k">def</span> <span class="nf">handleSpecialDocParts</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span><span class="n">kind</span><span class="p">,</span><span class="n">retainContents</span><span class="p">,</span><span class="n">asClass</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="c"># g.trace(kind,g.listToString(lines))</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">lines</span> <span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="p">;</span> <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;::&#39;</span><span class="p">):</span>
                <span class="n">n</span><span class="p">,</span> <span class="n">lit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_literal_block</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lit</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">isSpecialDocPart</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">kind</span><span class="p">):</span>
                <span class="n">n</span><span class="p">,</span> <span class="n">lines2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDocPart</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">retainContents</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s">&#39;&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">asClass</span><span class="p">:</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s">&#39;.. container:: &#39;</span><span class="o">+</span><span class="n">asClass</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">])</span>
                        <span class="k">if</span> <span class="s">&#39;literal&#39;</span> <span class="ow">in</span> <span class="n">asClass</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
                            <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s">&#39;  ::&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">l2</span> <span class="ow">in</span> <span class="n">lines2</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;    &#39;</span><span class="o">+</span><span class="n">l2</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lines2</span><span class="p">)</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s">&#39;&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>
    <span class="c">#@+node:ekr.20090502071837.77: *6* isAnyDocPart</span></div>
<div class="viewcode-block" id="rstCommands.isAnyDocPart"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.isAnyDocPart">[docs]</a>    <span class="k">def</span> <span class="nf">isAnyDocPart</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@doc&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isspace</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20090502071837.79: *6* isAnySpecialDocPart</span></div>
<div class="viewcode-block" id="rstCommands.isAnySpecialDocPart"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.isAnySpecialDocPart">[docs]</a>    <span class="k">def</span> <span class="nf">isAnySpecialDocPart</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s">&#39;@rst-markup&#39;</span><span class="p">,</span>
            <span class="s">&#39;@rst-option&#39;</span><span class="p">,</span>
            <span class="s">&#39;@rst-options&#39;</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isSpecialDocPart</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">kind</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20090502071837.78: *6* isSpecialDocPart</span></div>
<div class="viewcode-block" id="rstCommands.isSpecialDocPart"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.isSpecialDocPart">[docs]</a>    <span class="k">def</span> <span class="nf">isSpecialDocPart</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">kind</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return True if s is a special doc part of the indicated kind.</span>

<span class="sd">        If kind is None, return True if s is any doc part.&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">kind</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">kind</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">kind</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;@doc&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;@&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># g.trace(&#39;kind %s, result %s, s %s&#39; % (</span>
            <span class="c"># repr(kind),result,repr(s)))</span>

        <span class="k">return</span> <span class="n">result</span>
    <span class="c">#@+node:ekr.20090502071837.80: *6* removeLeoDirectives</span></div>
<div class="viewcode-block" id="rstCommands.removeLeoDirectives"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.removeLeoDirectives">[docs]</a>    <span class="k">def</span> <span class="nf">removeLeoDirectives</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lines</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Remove all Leo directives, except within literal blocks.&#39;&#39;&#39;</span>

        <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">lines</span> <span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="p">;</span> <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;::&#39;</span><span class="p">):</span>
                <span class="n">n</span><span class="p">,</span> <span class="n">lit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_literal_block</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lit</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">isAnySpecialDocPart</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">leoDirectivesList</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
                        <span class="c"># g.trace(&#39;removing %s&#39; % s)</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>
    <span class="c">#@+node:ekr.20090502071837.82: *6* replaceCodeBlockDirectives</span></div>
<div class="viewcode-block" id="rstCommands.replaceCodeBlockDirectives"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.replaceCodeBlockDirectives">[docs]</a>    <span class="k">def</span> <span class="nf">replaceCodeBlockDirectives</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lines</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Replace code-block directive, but not in literal blocks.&#39;&#39;&#39;</span>

        <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">lines</span> <span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="p">;</span> <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;::&#39;</span><span class="p">):</span>
                <span class="n">n</span><span class="p">,</span> <span class="n">lit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_literal_block</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lit</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;..&#39;</span><span class="p">):</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;code-block&#39;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="mi">1</span><span class="p">:</span> <span class="c"># Create a literal block to hold the code.</span>
                            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;::</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span> <span class="c"># This &#39;annotated&#39; literal block is confusing.</span>
                            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> code::</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="s">&#39;code-block&#39;</span><span class="p">):])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>
    <span class="c">#@+node:ekr.20090502071837.70: *6* skip_literal_block</span></div>
<div class="viewcode-block" id="rstCommands.skip_literal_block"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.skip_literal_block">[docs]</a>    <span class="k">def</span> <span class="nf">skip_literal_block</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="p">;</span> <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="p">;</span> <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">indent</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

        <span class="c"># Skip lines until a non-blank line is found with same or less indent.</span>
        <span class="k">while</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="n">indent2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">isspace</span><span class="p">()</span> <span class="ow">and</span> <span class="n">indent2</span> <span class="o">&lt;=</span> <span class="n">indent</span><span class="p">:</span>
                <span class="k">break</span> <span class="c"># We will rescan lines [n]</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="c"># g.printList(result,tag=&#39;literal block&#39;)</span>
        <span class="k">return</span> <span class="n">n</span><span class="p">,</span> <span class="n">result</span>
    <span class="c">#@+node:ekr.20090502071837.71: *6* writeBody &amp; helpers</span></div>
<div class="viewcode-block" id="rstCommands.writeBody"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.writeBody">[docs]</a>    <span class="k">def</span> <span class="nf">writeBody</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;ignore_noweb_definitions&#39;</span><span class="p">):</span>
            <span class="c"># 2011/06/10: Ignore section definition nodes.</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isSectionDef</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;section def: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span>
                <span class="k">return</span>

        <span class="c"># remove trailing cruft and split into lines.</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;code_mode&#39;</span><span class="p">):</span>
            <span class="c"># Important: code mode is no longer documented!</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;show_options_doc_parts&#39;</span><span class="p">):</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handleSpecialDocParts</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="s">&#39;@rst-options&#39;</span><span class="p">,</span>
                    <span class="n">retainContents</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;show_markup_doc_parts&#39;</span><span class="p">):</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handleSpecialDocParts</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="s">&#39;@rst-markup&#39;</span><span class="p">,</span>
                    <span class="n">retainContents</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;show_leo_directives&#39;</span><span class="p">):</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">removeLeoDirectives</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handleCodeMode</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;doc_only_mode&#39;</span><span class="p">):</span>
            <span class="c"># New in version 1.15</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handleDocOnlyMode</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handleSpecialDocParts</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="s">&#39;@rst-options&#39;</span><span class="p">,</span>
                <span class="n">retainContents</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handleSpecialDocParts</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="s">&#39;@rst-markup&#39;</span><span class="p">,</span>
                <span class="n">retainContents</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;generate_rst&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;show_doc_parts_in_rst_mode&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
                <span class="k">pass</span>  <span class="c"># original behaviour, treat as plain text</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;show_doc_parts_in_rst_mode&#39;</span><span class="p">):</span>
                <span class="c"># use value as class for content</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handleSpecialDocParts</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">retainContents</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">asClass</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;show_doc_parts_in_rst_mode&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c"># option evaluates to false, cut them out</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handleSpecialDocParts</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">retainContents</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">removeLeoDirectives</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;expand_noweb_references&#39;</span><span class="p">):</span>
                <span class="c"># 2011/06/10.</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expandSectionRefs</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">seen</span><span class="o">=</span><span class="p">[])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;generate_rst&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;use_alternate_code_block&#39;</span><span class="p">):</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">replaceCodeBlockDirectives</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

        <span class="c"># Write the lines.</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

        <span class="c"># We no longer add newlines to the start of nodes because</span>
        <span class="c"># we write a blank line after all sections.</span>
        <span class="c"># s = g.ensureLeadingNewlines(s,1)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">ensureTrailingNewlines</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20110610144305.6749: *7* isSectionDef/Ref</span></div>
<div class="viewcode-block" id="rstCommands.isSectionDef"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.isSectionDef">[docs]</a>    <span class="k">def</span> <span class="nf">isSectionDef</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">isSectionRef</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="rstCommands.isSectionRef"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.isSectionRef">[docs]</a>    <span class="k">def</span> <span class="nf">isSectionRef</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="n">n1</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;&lt;&lt;&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">n2</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;&gt;&gt;&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">n1</span> <span class="o">&lt;</span> <span class="n">n2</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="n">n1</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">n2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20110610144305.6750: *7* expandSectionRefs</span></div>
<div class="viewcode-block" id="rstCommands.expandSectionRefs"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.expandSectionRefs">[docs]</a>    <span class="k">def</span> <span class="nf">expandSectionRefs</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">seen</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isSectionRef</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
                <span class="n">p2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findSectionDef</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p2</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;expanding: </span><span class="si">%s</span><span class="s"> from </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">p2</span><span class="o">.</span><span class="n">h</span><span class="p">))</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="c"># Append the section reference line.</span>
                    <span class="n">lines2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">p2</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;expand_noweb_recursively&#39;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                            <span class="k">pass</span> <span class="c"># Prevent unbounded recursion</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">seen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                            <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expandSectionRefs</span><span class="p">(</span><span class="n">lines2</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">seen</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lines2</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># Undefined reference.</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>
    <span class="c">#@+node:ekr.20110610144305.6751: *7* findSectionDef</span></div>
<div class="viewcode-block" id="rstCommands.findSectionDef"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.findSectionDef">[docs]</a>    <span class="k">def</span> <span class="nf">findSectionDef</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">p2</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">subtree</span><span class="p">():</span>
            <span class="n">name2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isSectionDef</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name2</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">p2</span>

        <span class="k">return</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20090502071837.72: *7* handleCodeMode &amp; helper</span></div>
<div class="viewcode-block" id="rstCommands.handleCodeMode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.handleCodeMode">[docs]</a>    <span class="k">def</span> <span class="nf">handleCodeMode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">lines</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Handle the preprocessed body text in code mode as follows:</span>

<span class="sd">        - Blank lines are copied after being cleaned.</span>
<span class="sd">        - @ @rst-markup lines get copied as is.</span>
<span class="sd">        - Everything else gets put into a code-block directive.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">code</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">lines</span> <span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="p">;</span> <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">isSpecialDocPart</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="s">&#39;@rst-markup&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;show_doc_parts_as_paragraphs&#39;</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">isSpecialDocPart</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="n">code</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">finishCodePart</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">code</span><span class="p">)</span>
                    <span class="n">code</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                <span class="n">n</span><span class="p">,</span> <span class="n">lines2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDocPart</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
                <span class="c"># A fix, perhaps dubious, to a bug discussed at</span>
                <span class="c"># http://groups.google.com/group/leo-editor/browse_thread/thread/c212814815c92aac</span>
                <span class="c"># lines2 = [z.lstrip() for z in lines2]</span>
                <span class="c"># g.trace(&#39;lines2&#39;,lines2)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lines2</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">code</span><span class="p">:</span>
                <span class="k">pass</span> <span class="c"># Ignore blank lines before the first code block.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">code</span><span class="p">:</span> <span class="c"># Start the code block.</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">code_block_string</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;code line: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
                <span class="n">code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

            <span class="c"># elif not code: # Start the code block.</span>
                <span class="c"># result.append(&#39;&#39;)</span>
                <span class="c"># result.append(self.code_block_string)</span>
                <span class="c"># if trace: g.trace(&#39;code line: %s&#39; % repr(s))</span>
                <span class="c"># code.append(s)</span>
            <span class="c"># else: # Continue the code block.</span>
                <span class="c"># if trace: g.trace(&#39;code line: %s&#39; % repr(s))</span>
                <span class="c"># code.append(s)</span>

        <span class="k">if</span> <span class="n">code</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finishCodePart</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">code</span><span class="p">)</span>
            <span class="n">code</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># Munge the result so as to keep docutils happy.</span>
        <span class="c"># Don&#39;t use self.rstripList: it&#39;s not the same.</span>
        <span class="c"># g.trace(result)</span>
        <span class="n">result2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">z</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span> <span class="n">result2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="c"># 2010/08/27: Fix bug 618482.</span>
            <span class="c"># elif not z.rstrip(): pass</span>
            <span class="k">elif</span> <span class="n">z</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n\n</span><span class="s">&#39;</span><span class="p">):</span> <span class="n">result2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="c"># Leave alone.</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">result2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">z</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">result2</span>
    <span class="c">#@+node:ekr.20090502071837.73: *8* formatCodeModeLine</span></div>
<div class="viewcode-block" id="rstCommands.formatCodeModeLine"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.formatCodeModeLine">[docs]</a>    <span class="k">def</span> <span class="nf">formatCodeModeLine</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">numberOption</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

        <span class="k">if</span> <span class="n">numberOption</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;</span><span class="se">\t</span><span class="si">%d</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;</span><span class="se">\t</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">s</span>
    <span class="c">#@+node:ekr.20090502071837.74: *8* rstripList</span></div>
<div class="viewcode-block" id="rstCommands.rstripList"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.rstripList">[docs]</a>    <span class="k">def</span> <span class="nf">rstripList</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">theList</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Removed trailing blank lines from theList.&#39;&#39;&#39;</span>

        <span class="c"># 2010/08/27: fix bug 618482.</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">theList</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20090502071837.75: *8* finishCodePart</span></div>
<div class="viewcode-block" id="rstCommands.finishCodePart"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.finishCodePart">[docs]</a>    <span class="k">def</span> <span class="nf">finishCodePart</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">code</span><span class="p">):</span>

        <span class="n">numberOption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;number_code_lines&#39;</span><span class="p">)</span>
        <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rstripList</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">code</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">formatCodeModeLine</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">numberOption</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20090502071837.76: *7* handleDocOnlyMode</span></div>
<div class="viewcode-block" id="rstCommands.handleDocOnlyMode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.handleDocOnlyMode">[docs]</a>    <span class="k">def</span> <span class="nf">handleDocOnlyMode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">lines</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Handle the preprocessed body text in doc_only mode as follows:</span>

<span class="sd">        - Blank lines are copied after being cleaned.</span>
<span class="sd">        - @ @rst-markup lines get copied as is.</span>
<span class="sd">        - All doc parts get copied.</span>
<span class="sd">        - All code parts are ignored.&#39;&#39;&#39;</span>

        <span class="c"># ignore            = self.getOption(&#39;ignore_this_headline&#39;)</span>
        <span class="n">showHeadlines</span>       <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;show_headlines&#39;</span><span class="p">)</span>
        <span class="n">showThisHeadline</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;show_this_headline&#39;</span><span class="p">)</span>
        <span class="n">showOrganizers</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;show_organizer_nodes&#39;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">lines</span> <span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="p">;</span> <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isSpecialDocPart</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="s">&#39;@rst-options&#39;</span><span class="p">):</span>
                <span class="n">n</span><span class="p">,</span> <span class="n">lines2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDocPart</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="c"># ignore.</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">isAnyDocPart</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="c"># Handle any other doc part, including @rst-markup.</span>
                <span class="n">n</span><span class="p">,</span> <span class="n">lines2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getDocPart</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">lines2</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lines2</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span> <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">showHeadlines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">or</span> <span class="n">showThisHeadline</span> <span class="ow">or</span> <span class="n">showOrganizers</span> <span class="ow">or</span> <span class="n">p</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">topNode</span><span class="p">:</span>
                <span class="c"># g.trace(len(result),p.h)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">writeHeadlineHelper</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="c">#@+node:ekr.20090502071837.83: *6* writeHeadline &amp; helper</span></div>
<div class="viewcode-block" id="rstCommands.writeHeadline"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.writeHeadline">[docs]</a>    <span class="k">def</span> <span class="nf">writeHeadline</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Generate an rST section if options permit it.</span>
<span class="sd">        Remove headline commands from the headline first,</span>
<span class="sd">        and never generate an rST section for @rst-option and @rst-options.&#39;&#39;&#39;</span>

        <span class="n">docOnly</span>             <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;doc_only_mode&#39;</span><span class="p">)</span>
        <span class="n">ignore</span>              <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;ignore_this_headline&#39;</span><span class="p">)</span>
        <span class="n">ignoreNowebDefs</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;ignore_noweb_definitions&#39;</span><span class="p">)</span>
        <span class="n">showHeadlines</span>       <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;show_headlines&#39;</span><span class="p">)</span>
        <span class="n">showOrganizers</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;show_organizer_nodes&#39;</span><span class="p">)</span>
        <span class="n">showThisHeadline</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;show_this_headline&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">p</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">topNode</span> <span class="ow">or</span>
            <span class="n">ignore</span> <span class="ow">or</span>
            <span class="n">docOnly</span> <span class="ow">or</span> <span class="c"># handleDocOnlyMode handles this.</span>
            <span class="ow">not</span> <span class="n">showHeadlines</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">showThisHeadline</span> <span class="ow">or</span>
            <span class="c"># docOnly and not showOrganizers and not thisHeadline or</span>
            <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">showOrganizers</span> <span class="ow">or</span>
            <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">showOrganizers</span> <span class="ow">or</span>
            <span class="n">ignoreNowebDefs</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">isSectionDef</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="c"># 2011/06/10.</span>
        <span class="p">):</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">writeHeadlineHelper</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20090502071837.84: *7* writeHeadlineHelper</span></div>
<div class="viewcode-block" id="rstCommands.writeHeadlineHelper"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.writeHeadlineHelper">[docs]</a>    <span class="k">def</span> <span class="nf">writeHeadlineHelper</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="n">h</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">atAutoWrite</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">h</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c"># Remove any headline command before writing the headline.</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_id</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">chars</span><span class="o">=</span><span class="s">&#39;@-&#39;</span><span class="p">)</span>
        <span class="n">word</span> <span class="o">=</span> <span class="n">h</span> <span class="p">[:</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">word</span><span class="p">:</span>
            <span class="c"># Never generate a section for these...</span>
            <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="s">&#39;@rst-option&#39;</span><span class="p">,</span><span class="s">&#39;@rst-options&#39;</span><span class="p">,</span>
                <span class="s">&#39;@rst-no-head&#39;</span><span class="p">,</span><span class="s">&#39;@rst-no-headlines&#39;</span>
            <span class="p">):</span>
                <span class="k">return</span>

            <span class="c"># Remove all other headline commands from the headline.</span>
            <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">headlineCommands</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">word</span> <span class="o">==</span> <span class="n">command</span><span class="p">:</span>
                    <span class="n">h</span> <span class="o">=</span> <span class="n">h</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">):]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">break</span>

            <span class="c"># New in Leo 4.4.4.</span>
            <span class="k">if</span> <span class="n">word</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;strip_at_file_prefixes&#39;</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;@auto&#39;</span><span class="p">,</span><span class="s">&#39;@file&#39;</span><span class="p">,</span><span class="s">&#39;@nosent&#39;</span><span class="p">,</span><span class="s">&#39;@thin&#39;</span><span class="p">,):</span>
                        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">word</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>
                            <span class="n">h</span> <span class="o">=</span> <span class="n">h</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">h</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;show_sections&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;generate_rst&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">underline</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="n">p</span><span class="p">))</span> <span class="c"># Used by @auto-rst.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">h</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">**</span><span class="si">%s</span><span class="s">**</span><span class="se">\n\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">h</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;*&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20090502071837.85: *6* writeNode (leoRst)</span></div>
<div class="viewcode-block" id="rstCommands.writeNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.writeNode">[docs]</a>    <span class="k">def</span> <span class="nf">writeNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Format a node according to the options presently in effect.&#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initCodeBlockString</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scanAllOptions</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%24s</span><span class="s"> code_mode </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;code_mode&#39;</span><span class="p">)))</span>

        <span class="n">h</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;preformat_this_node&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">http_addNodeMarker</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writePreformat</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;ignore_this_tree&#39;</span><span class="p">):</span>
            <span class="n">p</span><span class="o">.</span><span class="n">moveToNodeAfterTree</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;ignore_this_node&#39;</span><span class="p">):</span>
            <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;@rst-options&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;show_options_nodes&#39;</span><span class="p">):</span>
            <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">http_addNodeMarker</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeHeadline</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeBody</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">moveToThreadNext</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20090502071837.86: *6* writePreformat</span></div>
<div class="viewcode-block" id="rstCommands.writePreformat"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.writePreformat">[docs]</a>    <span class="k">def</span> <span class="nf">writePreformat</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Write p&#39;s body text lines as if preformatted.</span>

<span class="sd">         ::</span>

<span class="sd">            line 1</span>
<span class="sd">            line 2 etc.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c"># g.trace(p.h,g.callers())</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39; &#39;</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="n">z</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;::</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="se">\n\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">s</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20090502071837.87: *6* writeTree</span></div>
<div class="viewcode-block" id="rstCommands.writeTree"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.writeTree">[docs]</a>    <span class="k">def</span> <span class="nf">writeTree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Write p&#39;s tree to self.outputFile.&#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scanAllOptions</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;generate_rst&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;generate_rst_header_comment&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rstComment</span><span class="p">(</span>
                    <span class="s">&#39;rst3: filename: </span><span class="si">%s</span><span class="se">\n\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">))</span>

        <span class="c"># We can&#39;t use an iterator because we may skip parts of the tree.</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c"># Only one copy is needed for traversal.</span>
        <span class="n">after</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">nodeAfterTree</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">after</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">writeNode</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="c"># Side effect: advances p.</span>
    <span class="c">#@+node:ekr.20090502071837.67: *4* writeNodeToString</span></div>
<div class="viewcode-block" id="rstCommands.writeNodeToString"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.writeNodeToString">[docs]</a>    <span class="k">def</span> <span class="nf">writeNodeToString</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">ext</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Scan p&#39;s tree (defaults to presently selected tree) looking for @rst nodes.</span>
<span class="sd">        Convert the first node found to an ouput of the type specified by ext.</span>

<span class="sd">        The @rst may or may not be followed by a filename; the filename is *ignored*,</span>
<span class="sd">        and its type does not affect ext or the output generated in any way.</span>

<span class="sd">        ext should start with a period: .html, .tex or None (specifies rst output).</span>

<span class="sd">        Returns (p, s), where p is the position of the @rst node and s is the converted text.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">current</span> <span class="o">=</span> <span class="n">p</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">current</span><span class="o">.</span><span class="n">self_and_parents</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@rst&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">processTree</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">ext</span><span class="o">=</span><span class="n">ext</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">justOneFile</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">processTree</span><span class="p">(</span><span class="n">current</span><span class="p">,</span><span class="n">ext</span><span class="o">=</span><span class="n">ext</span><span class="p">,</span><span class="n">toString</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">justOneFile</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20090512153903.5803: *4* writeAtAutoFile</span></div>
<div class="viewcode-block" id="rstCommands.writeAtAutoFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.writeAtAutoFile">[docs]</a>    <span class="k">def</span> <span class="nf">writeAtAutoFile</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span><span class="n">outputFile</span><span class="p">,</span><span class="n">trialWrite</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Write an @auto tree containing imported rST code.</span>
<span class="sd">        The caller will close the output file.&#39;&#39;&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trialWrite</span> <span class="o">=</span> <span class="n">trialWrite</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atAutoWrite</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initAtAutoWrite</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span><span class="n">outputFile</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">topNode</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c"># Indicate the top of this tree.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">topLevel</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">level</span><span class="p">()</span>
            <span class="n">after</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">nodeAfterTree</span><span class="p">()</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">isSafeWrite</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">firstChild</span><span class="p">()</span> <span class="c"># A hack: ignore the root node.</span>
                <span class="k">while</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">after</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">writeNode</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="c"># side effect: advances p</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atAutoWrite</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">ok</span>
    <span class="c">#@+node:ekr.20090513073632.5733: *5* initAtAutoWrite (rstCommands)</span></div>
<div class="viewcode-block" id="rstCommands.initAtAutoWrite"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.initAtAutoWrite">[docs]</a>    <span class="k">def</span> <span class="nf">initAtAutoWrite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">fileName</span><span class="p">,</span><span class="n">outputFile</span><span class="p">):</span>

        <span class="c"># Set up for a standard write.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">createDefaultOptionsDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeOptionDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scanAllOptions</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_write</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocessTree</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="c"># Allow @ @rst-options, for example.</span>
        <span class="c"># Do the overrides.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="n">outputFile</span>
        <span class="c"># Set underlining characters.</span>
        <span class="c"># It makes no sense to use user-defined</span>
        <span class="c"># underlining characters in @auto-rst.</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;rst-import&#39;</span><span class="p">,{})</span>
        <span class="n">underlines2</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;underlines2&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="c"># Do *not* set a default for overlining characters.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">underlines2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">underlines2</span> <span class="o">=</span> <span class="n">underlines2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;too many top-level underlines, using </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">underlines2</span><span class="p">))</span>
        <span class="n">underlines1</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;underlines1&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="c"># Bug fix:  2010/05/26: pad underlines with default characters.</span>
        <span class="n">default_underlines</span> <span class="o">=</span> <span class="s">&#39;=+*^~&quot;</span><span class="se">\&#39;</span><span class="s">`-:&gt;&lt;_&#39;</span>
        <span class="k">if</span> <span class="n">underlines1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">default_underlines</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="k">if</span> <span class="n">ch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">underlines1</span><span class="p">:</span>
                    <span class="n">underlines1</span> <span class="o">=</span> <span class="n">underlines1</span> <span class="o">+</span> <span class="n">ch</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">underlines1</span> <span class="o">=</span> <span class="n">default_underlines</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atAutoWriteUnderlines</span>   <span class="o">=</span> <span class="n">underlines2</span> <span class="o">+</span> <span class="n">underlines1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">underlines1</span> <span class="o">=</span> <span class="n">underlines1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">underlines2</span> <span class="o">=</span> <span class="n">underlines2</span>
    <span class="c">#@+node:ekr.20091228080620.6499: *5* isSafeWrite</span></div>
<div class="viewcode-block" id="rstCommands.isSafeWrite"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.isSafeWrite">[docs]</a>    <span class="k">def</span> <span class="nf">isSafeWrite</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return True if node p contributes nothing but</span>
<span class="sd">        rst-options to the write.&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trialWrite</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtAutoRstNode</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">True</span> <span class="c"># Trial writes are always safe.</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">z</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">z</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">z</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;.. &#39;</span><span class="p">):</span>
                <span class="c"># A real line that will not be written.</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;unsafe @auto-rst&#39;</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;body text will be ignored in</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
    <span class="c">#@+node:ekr.20090502071837.41: *3* Options</span>
    <span class="c">#@+node:ekr.20090502071837.42: *4* createDefaultOptionsDict</span></div>
<div class="viewcode-block" id="rstCommands.createDefaultOptionsDict"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.createDefaultOptionsDict">[docs]</a>    <span class="k">def</span> <span class="nf">createDefaultOptionsDict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># Important: these must be munged names.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defaultOptionsDict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c"># Http options...</span>
            <span class="s">&#39;clear_http_attributes&#39;</span><span class="p">:</span>   <span class="bp">False</span><span class="p">,</span>
            <span class="s">&#39;http_server_support&#39;</span><span class="p">:</span>     <span class="bp">False</span><span class="p">,</span>
            <span class="s">&#39;http_attributename&#39;</span><span class="p">:</span>      <span class="s">&#39;rst_http_attribute&#39;</span><span class="p">,</span>
            <span class="s">&#39;node_begin_marker&#39;</span><span class="p">:</span>       <span class="s">&#39;http-node-marker-&#39;</span><span class="p">,</span>
            <span class="c"># Path options...</span>
            <span class="s">&#39;default_path&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="c"># New in Leo 4.4a4 # Bug fix: must be None, not &#39;&#39;.</span>
            <span class="s">&#39;stylesheet_name&#39;</span><span class="p">:</span> <span class="s">&#39;default.css&#39;</span><span class="p">,</span>
            <span class="s">&#39;stylesheet_path&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="c"># Bug fix: must be None, not &#39;&#39;.</span>
            <span class="s">&#39;stylesheet_embed&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="s">&#39;publish_argv_for_missing_stylesheets&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
            <span class="c"># Global options...</span>
            <span class="s">&#39;call_docutils&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="c"># 2010/08/05</span>
            <span class="s">&#39;code_block_string&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
            <span class="s">&#39;number_code_lines&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="s">&#39;underline_characters&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;&#39;#=+*^~&quot;&#39;`-:&gt;&lt;_&#39;&#39;&#39;</span><span class="p">,</span>
            <span class="s">&#39;verbose&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
            <span class="s">&#39;write_intermediate_file&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="c"># Used only if generate_rst is True.</span>
            <span class="s">&#39;write_intermediate_extension&#39;</span><span class="p">:</span> <span class="s">&#39;.txt&#39;</span><span class="p">,</span>
            <span class="c"># Mode options...</span>
            <span class="s">&#39;code_mode&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="c"># True: generate rst markup from @code and @doc parts.</span>
            <span class="s">&#39;doc_only_mode&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span> <span class="c"># True: generate only from @doc parts.</span>
            <span class="s">&#39;generate_rst&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="c"># True: generate rst markup.  False: generate plain text.</span>
            <span class="s">&#39;generate_rst_header_comment&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                <span class="c"># True generate header comment (requires generate_rst option)</span>
            <span class="c"># Formatting options that apply to both code and rst modes....</span>
            <span class="s">&#39;expand_noweb_references&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="s">&#39;ignore_noweb_definitions&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="s">&#39;expand_noweb_recursively&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="s">&#39;show_headlines&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>  <span class="c"># Can be set by @rst-no-head headlines.</span>
            <span class="s">&#39;show_organizer_nodes&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="s">&#39;show_options_nodes&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="s">&#39;show_sections&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="s">&#39;strip_at_file_prefixes&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="s">&#39;show_doc_parts_in_rst_mode&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="c"># Formatting options that apply only to code mode.</span>
            <span class="s">&#39;show_doc_parts_as_paragraphs&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="s">&#39;show_leo_directives&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="s">&#39;show_markup_doc_parts&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="s">&#39;show_options_doc_parts&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="c">#@+node:ekr.20090502071837.43: *4* dumpSettings (debugging)</span></div>
<div class="viewcode-block" id="rstCommands.dumpSettings"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.dumpSettings">[docs]</a>    <span class="k">def</span> <span class="nf">dumpSettings</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optionsDict</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;present settings...&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%20s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)))</span>
    <span class="c">#@+node:ekr.20090502071837.44: *4* getOption &amp; setOption</span></div>
<div class="viewcode-block" id="rstCommands.getOption"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.getOption">[docs]</a>    <span class="k">def</span> <span class="nf">getOption</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>

        <span class="c"># 2010/08/12: munging names here is safe because setOption munges.</span>
        <span class="c"># g.trace(name,self.optionsDict.get(self.munge(name)))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">optionsDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">munge</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="rstCommands.setOption"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.setOption">[docs]</a>    <span class="k">def</span> <span class="nf">setOption</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">tag</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">optionsDict</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">munge</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span> <span class="o">=</span> <span class="n">val</span>
    <span class="c">#@+node:ekr.20090502071837.45: *4* initCodeBlockString</span></div>
<div class="viewcode-block" id="rstCommands.initCodeBlockString"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.initCodeBlockString">[docs]</a>    <span class="k">def</span> <span class="nf">initCodeBlockString</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
        <span class="c"># if trace: os.system(&#39;cls&#39;)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">scanAllDirectives</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">language</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;language&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">language</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">language</span> <span class="o">=</span> <span class="s">&#39;python&#39;</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">language</span> <span class="o">=</span> <span class="n">language</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">syntax</span> <span class="o">=</span> <span class="n">SilverCity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;language&#39;</span><span class="p">,</span><span class="n">language</span><span class="p">,</span><span class="s">&#39;language.title()&#39;</span><span class="p">,</span><span class="n">language</span><span class="o">.</span><span class="n">title</span><span class="p">(),</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

        <span class="c"># Note: lines that end with &#39;\n\n&#39; are a signal to handleCodeMode.</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;code_block_string&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">code_block_string</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">n&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">syntax</span> <span class="ow">and</span> <span class="n">language</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;python&#39;</span><span class="p">,</span><span class="s">&#39;ruby&#39;</span><span class="p">,</span><span class="s">&#39;perl&#39;</span><span class="p">,</span><span class="s">&#39;c&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">code_block_string</span> <span class="o">=</span> <span class="s">&#39;**code**:</span><span class="se">\n\n</span><span class="s">.. code-block:: </span><span class="si">%s</span><span class="se">\n\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">language</span><span class="o">.</span><span class="n">title</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">code_block_string</span> <span class="o">=</span> <span class="s">&#39;**code**:</span><span class="se">\n\n</span><span class="s">.. class:: code</span><span class="se">\n</span><span class="s">..</span><span class="se">\n\n</span><span class="s">::</span><span class="se">\n\n</span><span class="s">&#39;</span>
    <span class="c">#@+node:ekr.20090502071837.46: *4* preprocessTree &amp; helpers</span></div>
<div class="viewcode-block" id="rstCommands.preprocessTree"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.preprocessTree">[docs]</a>    <span class="k">def</span> <span class="nf">preprocessTree</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">root</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nodeOptionDict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c"># Bug fix 12/4/05: must preprocess parents too.</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">parents</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preprocessNode</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">self_and_subtree</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">preprocessNode</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodeOptionDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">printDict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodeOptionDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20090502071837.47: *5* preprocessNode</span></div>
<div class="viewcode-block" id="rstCommands.preprocessNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.preprocessNode">[docs]</a>    <span class="k">def</span> <span class="nf">preprocessNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodeOptionDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanNodeForOptions</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodeOptionDict</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
    <span class="c">#@+node:ekr.20090502071837.48: *5* parseOptionLine</span></div>
<div class="viewcode-block" id="rstCommands.parseOptionLine"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.parseOptionLine">[docs]</a>    <span class="k">def</span> <span class="nf">parseOptionLine</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Parse a line containing name=val and return (name,value) or None.</span>

<span class="sd">        If no value is found, default to True.&#39;&#39;&#39;</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">):</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c"># Get name.  Names may contain &#39;-&#39; and &#39;_&#39;.</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_id</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">chars</span><span class="o">=</span><span class="s">&#39;-_&#39;</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">s</span> <span class="p">[:</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="s">&#39;=&#39;</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">s</span> <span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c"># g.trace(val)</span>
            <span class="k">return</span> <span class="n">name</span><span class="p">,</span><span class="n">val</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># g.trace(&#39;*True&#39;)</span>
            <span class="k">return</span> <span class="n">name</span><span class="p">,</span><span class="s">&#39;True&#39;</span>
    <span class="c">#@+node:ekr.20090502071837.49: *5* scanForOptionDocParts</span></div>
<div class="viewcode-block" id="rstCommands.scanForOptionDocParts"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.scanForOptionDocParts">[docs]</a>    <span class="k">def</span> <span class="nf">scanForOptionDocParts</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return a dictionary containing all options from @rst-options doc parts in p.</span>
<span class="sd">        Multiple @rst-options doc parts are allowed: this code aggregates all options.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="p">;</span> <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;@rst-options&#39;</span><span class="p">,</span><span class="s">&#39;@rst-option&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">kind</span><span class="p">):</span>
                        <span class="c"># Allow options on the same line.</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">kind</span><span class="p">):]</span>
                        <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scanOption</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">line</span><span class="p">))</span>
                        <span class="c"># Add options until the end of the doc part.</span>
                        <span class="k">while</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
                            <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="p">;</span> <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span> <span class="p">;</span> <span class="n">found</span> <span class="o">=</span> <span class="bp">False</span>
                            <span class="k">for</span> <span class="n">stop</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;@c&#39;</span><span class="p">,</span><span class="s">&#39;@code&#39;</span><span class="p">,</span> <span class="s">&#39;@&#39;</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">stop</span><span class="p">):</span>
                                    <span class="n">found</span> <span class="o">=</span> <span class="bp">True</span> <span class="p">;</span> <span class="k">break</span>
                            <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
                                <span class="k">break</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scanOption</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">line</span><span class="p">))</span>
                        <span class="k">break</span>
        <span class="k">return</span> <span class="n">d</span>
    <span class="c">#@+node:ekr.20090502071837.50: *5* scanHeadlineForOptions</span></div>
<div class="viewcode-block" id="rstCommands.scanHeadlineForOptions"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.scanHeadlineForOptions">[docs]</a>    <span class="k">def</span> <span class="nf">scanHeadlineForOptions</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return a dictionary containing the options implied by p&#39;s headline.&#39;&#39;&#39;</span>

        <span class="n">h</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">topNode</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span> <span class="c"># Don&#39;t mess with the root node.</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;@rst-option&#39;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">h</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s">&#39;@rst-option&#39;</span><span class="p">):]</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanOption</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;@rst-options&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanOptions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Careful: can&#39;t use g.match_word because options may have &#39;-&#39; chars.</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_id</span><span class="p">(</span><span class="n">h</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">chars</span><span class="o">=</span><span class="s">&#39;@-&#39;</span><span class="p">)</span>
            <span class="n">word</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">option</span><span class="p">,</span><span class="n">ivar</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="p">(</span><span class="s">&#39;@rst&#39;</span><span class="p">,</span>                <span class="s">&#39;code_mode&#39;</span><span class="p">,</span><span class="bp">False</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;@rst-code&#39;</span><span class="p">,</span>           <span class="s">&#39;code_mode&#39;</span><span class="p">,</span><span class="bp">True</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;@rst-default-path&#39;</span><span class="p">,</span>   <span class="s">&#39;default_prefix&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;@rst-doc-only&#39;</span><span class="p">,</span>       <span class="s">&#39;doc_only_mode&#39;</span><span class="p">,</span><span class="bp">True</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;@rst-head&#39;</span><span class="p">,</span>           <span class="s">&#39;show_this_headline&#39;</span><span class="p">,</span><span class="bp">True</span><span class="p">),</span>
                <span class="c"># (&#39;@rst-head&#39; ,        &#39;show_headlines&#39;,False),</span>
                <span class="p">(</span><span class="s">&#39;@rst-ignore&#39;</span><span class="p">,</span>         <span class="s">&#39;ignore_this_tree&#39;</span><span class="p">,</span><span class="bp">True</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;@rst-ignore-node&#39;</span><span class="p">,</span>    <span class="s">&#39;ignore_this_node&#39;</span><span class="p">,</span><span class="bp">True</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;@rst-ignore-tree&#39;</span><span class="p">,</span>    <span class="s">&#39;ignore_this_tree&#39;</span><span class="p">,</span><span class="bp">True</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;@rst-no-head&#39;</span><span class="p">,</span>        <span class="s">&#39;ignore_this_headline&#39;</span><span class="p">,</span><span class="bp">True</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;@rst-preformat&#39;</span><span class="p">,</span>      <span class="s">&#39;preformat_this_node&#39;</span><span class="p">,</span><span class="bp">True</span><span class="p">),</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="n">word</span> <span class="o">==</span> <span class="n">option</span><span class="p">:</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span> <span class="n">ivar</span><span class="p">:</span> <span class="n">val</span> <span class="p">}</span>
                    <span class="c"># Special case: code mode and doc-only modes are linked.</span>
                    <span class="k">if</span> <span class="n">ivar</span> <span class="o">==</span> <span class="s">&#39;code_mode&#39;</span><span class="p">:</span>
                        <span class="n">d</span> <span class="p">[</span><span class="s">&#39;doc_only_mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="k">elif</span> <span class="n">ivar</span> <span class="o">==</span> <span class="s">&#39;doc_only_mode&#39;</span><span class="p">:</span>
                        <span class="n">d</span> <span class="p">[</span><span class="s">&#39;code_mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="c"># Special case: Treat a bare @rst like @rst-no-head</span>
                    <span class="k">if</span> <span class="n">h</span> <span class="o">==</span> <span class="s">&#39;@rst&#39;</span><span class="p">:</span>
                        <span class="n">d</span> <span class="p">[</span><span class="s">&#39;ignore_this_headline&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="c"># g.trace(repr(h),d)</span>
                    <span class="k">return</span> <span class="n">d</span>

            <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@rst&#39;</span><span class="p">):</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;unknown kind of @rst headline&#39;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

            <span class="k">return</span> <span class="p">{}</span>
    <span class="c">#@+node:ekr.20090502071837.51: *5* scanNodeForOptions</span></div>
<div class="viewcode-block" id="rstCommands.scanNodeForOptions"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.scanNodeForOptions">[docs]</a>    <span class="k">def</span> <span class="nf">scanNodeForOptions</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return a dictionary containing all the option-name:value entries in p.</span>

<span class="sd">        Such entries may arise from @rst-option or @rst-options in the headline,</span>
<span class="sd">        or from @ @rst-options doc parts.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

        <span class="n">h</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span>

        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanHeadlineForOptions</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="n">d2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanForOptionDocParts</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>

        <span class="c"># A fine point: body options over-ride headline options.</span>
        <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">d2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">d</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;    </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">z</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">d</span>
    <span class="c">#@+node:ekr.20090502071837.52: *5* scanOption</span></div>
<div class="viewcode-block" id="rstCommands.scanOption"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.scanOption">[docs]</a>    <span class="k">def</span> <span class="nf">scanOption</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return { name:val } if s is a line of the form name=val.</span>
<span class="sd">        Otherwise return {}&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">or</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;..&#39;</span><span class="p">):</span> <span class="k">return</span> <span class="p">{}</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseOptionLine</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">name</span><span class="p">,</span><span class="n">val</span> <span class="o">=</span> <span class="n">data</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">munge</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">defaultOptionsDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">if</span>   <span class="n">val</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;true&#39;</span><span class="p">:</span> <span class="n">val</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">elif</span> <span class="n">val</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;false&#39;</span><span class="p">:</span> <span class="n">val</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="c"># g.trace(&#39;%24s %8s %s&#39; % (self.munge(name),val,p.h))</span>
                <span class="k">return</span> <span class="p">{</span> <span class="bp">self</span><span class="o">.</span><span class="n">munge</span><span class="p">(</span><span class="n">name</span><span class="p">):</span> <span class="n">val</span> <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;ignoring unknown option:&#39;</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;bad rst3 option&#39;</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="s">&#39;in&#39;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{}</span>
    <span class="c">#@+node:ekr.20090502071837.53: *5* scanOptions</span></div>
<div class="viewcode-block" id="rstCommands.scanOptions"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.scanOptions">[docs]</a>    <span class="k">def</span> <span class="nf">scanOptions</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return a dictionary containing all the options in s.&#39;&#39;&#39;</span>

        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="n">d2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scanOption</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">d2</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">d2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">d</span>
    <span class="c">#@+node:ekr.20090502071837.54: *4* scanAllOptions &amp; helpers</span>
    <span class="c"># Once an option is seen, no other related options in ancestor nodes have any effect.</span>
</div>
<div class="viewcode-block" id="rstCommands.scanAllOptions"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.scanAllOptions">[docs]</a>    <span class="k">def</span> <span class="nf">scanAllOptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Scan position p and p&#39;s ancestors looking for options,</span>
<span class="sd">        setting corresponding ivars.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initOptionsFromSettings</span><span class="p">()</span> <span class="c"># Must be done on every node.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handleSingleNodeOptions</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">singleNodeOptions</span><span class="p">[:]</span> <span class="c"># Suppress inheritance of single-node options.</span>

        <span class="c"># g.trace(&#39;-&#39;*20)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">self_and_parents</span><span class="p">():</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodeOptionDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">,{})</span>
            <span class="c"># g.trace(p.h,d)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">ivar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">munge</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ivar</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                    <span class="n">seen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ivar</span><span class="p">)</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">setOption</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rst3_all</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setOption</span><span class="p">(</span><span class="s">&quot;generate_rst&quot;</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="s">&quot;rst3_all&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setOption</span><span class="p">(</span><span class="s">&quot;generate_rst_header_comment&quot;</span><span class="p">,</span><span class="bp">True</span><span class="p">,</span> <span class="s">&quot;rst3_all&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setOption</span><span class="p">(</span><span class="s">&quot;http_server_support&quot;</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="s">&quot;rst3_all&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setOption</span><span class="p">(</span><span class="s">&quot;write_intermediate_file&quot;</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="s">&quot;rst3_all&quot;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20090502071837.55: *5* initOptionsFromSettings</span></div>
<div class="viewcode-block" id="rstCommands.initOptionsFromSettings"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.initOptionsFromSettings">[docs]</a>    <span class="k">def</span> <span class="nf">initOptionsFromSettings</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>

        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">defaultOptionsDict</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">getter</span><span class="p">,</span><span class="n">kind</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getBool</span><span class="p">,</span><span class="s">&#39;@bool&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getString</span><span class="p">,</span><span class="s">&#39;@string&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">,</span><span class="s">&#39;default&#39;</span><span class="p">),</span>
            <span class="p">):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">getter</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;default&#39;</span> <span class="ow">or</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">setOption</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="s">&#39;initOptionsFromSettings&#39;</span><span class="p">)</span>
                    <span class="k">break</span>

        <span class="c"># 2010/08/12: Script settings override everything else.</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scriptSettingsDict</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">d2</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">d2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="c"># g.trace(key,val)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setOption</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="s">&#39;initOptionsFromSettings&#39;</span><span class="p">)</span>

        <span class="c"># Special case.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;http_server_support&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">mod_http</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;No http_server_support: can not import mod_http plugin&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setOption</span><span class="p">(</span><span class="s">&#39;http_server_support&#39;</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20090502071837.56: *5* handleSingleNodeOptions</span></div>
<div class="viewcode-block" id="rstCommands.handleSingleNodeOptions"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.handleSingleNodeOptions">[docs]</a>    <span class="k">def</span> <span class="nf">handleSingleNodeOptions</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Init the settings of single-node options from the tnodeOptionsDict.</span>

<span class="sd">        All such options default to False.&#39;&#39;&#39;</span>

        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodeOptionDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">,</span> <span class="p">{}</span> <span class="p">)</span>

        <span class="k">for</span> <span class="n">ivar</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">singleNodeOptions</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ivar</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
            <span class="c">#g.trace(&#39;%24s %8s %s&#39; % (ivar,val,p.h))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setOption</span><span class="p">(</span><span class="n">ivar</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

    <span class="c">#@+node:ekr.20090502071837.59: *3* Shared write code</span>
    <span class="c">#@+node:ekr.20090502071837.96: *4* http_addNodeMarker</span></div>
<div class="viewcode-block" id="rstCommands.http_addNodeMarker"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.http_addNodeMarker">[docs]</a>    <span class="k">def</span> <span class="nf">http_addNodeMarker</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;http_server_support&#39;</span><span class="p">)</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;generate_rst&#39;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodeNumber</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">anchorname</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;node_begin_marker&#39;</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">nodeNumber</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\n\n</span><span class="s">.. _</span><span class="si">%s</span><span class="s">:</span><span class="se">\n\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">anchorname</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">http_map</span> <span class="p">[</span><span class="n">anchorname</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c"># if bwm_file: print &gt;&gt; bwm_file, &quot;addNodeMarker&quot;, anchorname, p</span>
    <span class="c">#@+node:ekr.20090502071837.97: *4* http_endTree &amp; helpers</span>
    <span class="c"># Was http_support_main</span>
</div>
<div class="viewcode-block" id="rstCommands.http_endTree"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.http_endTree">[docs]</a>    <span class="k">def</span> <span class="nf">http_endTree</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">justOneFile</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Do end-of-tree processing to support the http plugin.&#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;http_server_support&#39;</span><span class="p">)</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;generate_rst&#39;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_initial_http_attributes</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">find_anchors</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">justOneFile</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">relocate_references</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">self_and_subtree</span><span class="p">)</span>

            <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&#39;html updated for http plugin&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;clear_http_attributes&#39;</span><span class="p">):</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&quot;http attributes cleared&quot;</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20090502071837.98: *5* set_initial_http_attributes</span></div>
<div class="viewcode-block" id="rstCommands.set_initial_http_attributes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.set_initial_http_attributes">[docs]</a>    <span class="k">def</span> <span class="nf">set_initial_http_attributes</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">):</span>

        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">htmlParserClass</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20090502071837.100: *5* relocate_references</span>
    <span class="c">#@+at Relocate references here if we are only running for one file.</span>
    <span class="c"># </span>
    <span class="c"># Otherwise we must postpone the relocation until we have processed all files.</span>
    <span class="c">#@@c</span>
</div>
<div class="viewcode-block" id="rstCommands.relocate_references"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.relocate_references">[docs]</a>    <span class="k">def</span> <span class="nf">relocate_references</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iterator_generator</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">iterator_generator</span><span class="p">():</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="n">mod_http</span><span class="o">.</span><span class="n">get_http_attribute</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">attr</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c"># g.trace(&#39;before&#39;,p.h,attr)</span>
            <span class="c"># if bwm_file:</span>
                <span class="c"># print &gt;&gt; bwm_file</span>
                <span class="c"># print &gt;&gt; bwm_file, &quot;relocate_references(1): Position, attr:&quot;</span>
                <span class="c"># pprint.pprint((p, attr), bwm_file)</span>
                <span class="c"># http_lines = attr [3:]</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">link_htmlparserClass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">attr</span> <span class="p">[</span><span class="mi">3</span><span class="p">:]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">parser</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">line</span> <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">127</span><span class="p">])</span>
                    <span class="n">parser</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">replacements</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">get_replacements</span><span class="p">()</span>
            <span class="n">replacements</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">replacements</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c"># if bwm_file:</span>
                <span class="c"># print &gt;&gt; bwm_file, &quot;relocate_references(2): Replacements:&quot;</span>
                <span class="c"># pprint.pprint(replacements, bwm_file)</span>
            <span class="k">for</span> <span class="n">line</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">href</span><span class="p">,</span> <span class="n">href_file</span><span class="p">,</span> <span class="n">http_node_ref</span> <span class="ow">in</span> <span class="n">replacements</span><span class="p">:</span>
                <span class="c"># if bwm_file: </span>
                    <span class="c"># print &gt;&gt; bwm_file, &quot;relocate_references(3): line:&quot;, line,</span>
                    <span class="c"># &quot;Column:&quot;, column, &quot;href:&quot;, href, &quot;href_file:&quot;,</span>
                    <span class="c"># href_file, &quot;http_node_ref:&quot;, http_node_ref</span>
                <span class="n">marker_parts</span> <span class="o">=</span> <span class="n">href</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;#&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">marker_parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">marker</span> <span class="o">=</span> <span class="n">marker_parts</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="c"># replacement = u&quot;%s#%s&quot; % (http_node_ref,marker)</span>
                    <span class="n">replacement</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">#</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">http_node_ref</span><span class="p">,</span><span class="n">marker</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c"># attr [line + 2] = attr [line + 2].replace(u&#39;href=&quot;%s&quot;&#39; % href, u&#39;href=&quot;%s&quot;&#39; % replacement)</span>
                        <span class="n">attr</span> <span class="p">[</span><span class="n">line</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr</span> <span class="p">[</span><span class="n">line</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;href=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">href</span><span class="p">,</span> <span class="s">&#39;href=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">replacement</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;Skipped &quot;</span><span class="p">,</span> <span class="n">attr</span><span class="p">[</span><span class="n">line</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># filename = marker_parts [0]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">attr</span> <span class="p">[</span><span class="n">line</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr</span> <span class="p">[</span><span class="n">line</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;href=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">href</span><span class="p">,</span><span class="s">&#39;href=&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">http_node_ref</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;Skipped&quot;</span><span class="p">,</span> <span class="n">attr</span><span class="p">[</span><span class="n">line</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span>
        <span class="c"># g.trace(&#39;after %s\n\n\n&#39;,attr)</span>
    <span class="c">#@+node:ekr.20090502071837.99: *5* find_anchors</span></div>
<div class="viewcode-block" id="rstCommands.find_anchors"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.find_anchors">[docs]</a>    <span class="k">def</span> <span class="nf">find_anchors</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Find the anchors in all the nodes.&#39;&#39;&#39;</span>

        <span class="k">for</span> <span class="n">p1</span><span class="p">,</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_attribute_iter</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="n">html</span> <span class="o">=</span> <span class="n">mod_http</span><span class="o">.</span><span class="n">reconstruct_html_from_attrs</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
            <span class="c"># g.trace(pprint.pprint(html))</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">anchor_htmlParserClass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">html</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">parser</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="c"># bwm: changed to unicode(line)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ch</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">line</span> <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">127</span><span class="p">])</span>
                    <span class="c"># filter out non-ascii characters.</span>
                    <span class="c"># bwm: not quite sure what&#39;s going on here.</span>
                    <span class="n">parser</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>        
        <span class="c"># g.trace(g.dictToString(self.anchor_map,tag=&#39;anchor_map&#39;))</span>
    <span class="c">#@+node:ekr.20090502071837.101: *5* http_attribute_iter</span></div>
<div class="viewcode-block" id="rstCommands.http_attribute_iter"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.http_attribute_iter">[docs]</a>    <span class="k">def</span> <span class="nf">http_attribute_iter</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Iterator for all the nodes which have html code.</span>
<span class="sd">        Look at the descendents of p.</span>
<span class="sd">        Used for relocation.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">p1</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">self_and_subtree</span><span class="p">():</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="n">mod_http</span><span class="o">.</span><span class="n">get_http_attribute</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">attr</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span><span class="n">attr</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20090502071837.60: *4* init_write (rstCommands)</span></div>
<div class="viewcode-block" id="rstCommands.init_write"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.init_write">[docs]</a>    <span class="k">def</span> <span class="nf">init_write</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initOptionsFromSettings</span><span class="p">()</span> <span class="c"># Still needed.</span>

        <span class="c"># Set the encoding from any parent @encoding directive.</span>
        <span class="c"># This can be overridden by @rst-option encoding=whatever.</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>

        <span class="n">d</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">scanAllDirectives</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;encoding&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;utf-8&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;path&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>

        <span class="c"># g.trace(&#39;path:&#39;,self.path)</span>
    <span class="c">#@+node:ekr.20090502071837.94: *4* write (leoRst)</span></div>
<div class="viewcode-block" id="rstCommands.write"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">theFile</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">theFile</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">theFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">is_binary_file</span><span class="p">(</span><span class="n">theFile</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="n">theFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20100813041139.5919: *4* write_files &amp; helpers</span></div>
<div class="viewcode-block" id="rstCommands.write_files"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.write_files">[docs]</a>    <span class="k">def</span> <span class="nf">write_files</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ext</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span><span class="n">callDocutils</span><span class="p">,</span><span class="n">toString</span><span class="p">,</span><span class="n">writeIntermediateFile</span><span class="p">):</span>

        <span class="n">isHtml</span> <span class="o">=</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;.html&#39;</span><span class="p">,</span><span class="s">&#39;.htm&#39;</span><span class="p">)</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computeOutputFileName</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">toString</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">createDirectoryForFile</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
                <span class="k">return</span>

        <span class="k">if</span> <span class="n">writeIntermediateFile</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">toString</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">createIntermediateFile</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">callDocutils</span> <span class="ow">and</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;.htm&#39;</span><span class="p">,</span><span class="s">&#39;.html&#39;</span><span class="p">,</span><span class="s">&#39;.tex&#39;</span><span class="p">,</span><span class="s">&#39;.pdf&#39;</span><span class="p">,</span><span class="s">&#39;.s5&#39;</span><span class="p">,</span><span class="s">&#39;.odt&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stringOutput</span> <span class="o">=</span> <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">writeToDocutils</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span><span class="n">ext</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">s</span> <span class="ow">and</span> <span class="n">isHtml</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stringOutput</span> <span class="o">=</span> <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">addTitleToHtml</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span> <span class="k">return</span>

            <span class="k">if</span> <span class="n">toString</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">isUnicode</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># Fixes bug 923301: Unicode error when executing &#39;rst3&#39; command</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="s">&#39;wb&#39;</span><span class="p">)</span> <span class="c"># Bug fix: use &#39;wb&#39;</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
                <span class="c"># self.http_endTree(fn,p,justOneFile=justOneFile)</span>
    <span class="c">#@+node:ekr.20100813041139.5913: *5* addTitleToHtml</span></div>
<div class="viewcode-block" id="rstCommands.addTitleToHtml"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.addTitleToHtml">[docs]</a>    <span class="k">def</span> <span class="nf">addTitleToHtml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Replace an empty &lt;title&gt; element by the contents of</span>
<span class="sd">        the first &lt;h1&gt; element.&#39;&#39;&#39;</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;&lt;title&gt;&lt;/title&gt;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="n">s</span>

        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;&lt;h1&gt;([^&lt;]*)&lt;/h1&gt;&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">&#39;&lt;h1&gt;&lt;[^&gt;]+&gt;([^&lt;]*)&lt;/a&gt;&lt;/h1&gt;&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&lt;title&gt;&lt;/title&gt;&#39;</span><span class="p">,</span>
                <span class="s">&#39;&lt;title&gt;</span><span class="si">%s</span><span class="s">&lt;/title&gt;&#39;</span> <span class="o">%</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">s</span>
    <span class="c">#@+node:ekr.20100813041139.5914: *5* createDirectoryForFile</span></div>
<div class="viewcode-block" id="rstCommands.createDirectoryForFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.createDirectoryForFile">[docs]</a>    <span class="k">def</span> <span class="nf">createDirectoryForFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Create the directory for fn if</span>
<span class="sd">        a) it doesn&#39;t exist and</span>
<span class="sd">        b) the user options allow it.</span>

<span class="sd">        Return True if the directory existed or was made.&#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>

        <span class="c"># Create the directory if it doesn&#39;t exist.</span>
        <span class="n">theDir</span><span class="p">,</span> <span class="n">junk</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_split</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
        <span class="n">theDir</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">os_path_finalize</span><span class="p">(</span><span class="n">theDir</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">theDir</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">makeAllNonExistentDirectories</span><span class="p">(</span><span class="n">theDir</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">force</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;did not create:&#39;</span><span class="p">,</span><span class="n">theDir</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ok</span>
    <span class="c">#@+node:ekr.20100813041139.5912: *5* createIntermediateFile (changed)</span></div>
<div class="viewcode-block" id="rstCommands.createIntermediateFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.createIntermediateFile">[docs]</a>    <span class="k">def</span> <span class="nf">createIntermediateFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Write s to to the file whose name is fn.&#39;&#39;&#39;</span>

        <span class="n">ext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;write_intermediate_extension&#39;</span><span class="p">)</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">ext</span> <span class="ow">or</span> <span class="s">&#39;.txt&#39;</span> <span class="c"># .txt by default.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ext</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">):</span> <span class="n">ext</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="n">ext</span>

        <span class="n">fn</span> <span class="o">=</span> <span class="n">fn</span> <span class="o">+</span> <span class="n">ext</span>

        <span class="c"># g.trace(&#39;intermediate file&#39;,fn)</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span> <span class="c"># 2010/08/27</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span><span class="n">reportErrors</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20090502071837.65: *5* writeToDocutils (sets argv) &amp; helper</span></div>
<div class="viewcode-block" id="rstCommands.writeToDocutils"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.writeToDocutils">[docs]</a>    <span class="k">def</span> <span class="nf">writeToDocutils</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">ext</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Send s to docutils using the writer implied by ext and return the result.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">docutils</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;writeToDocutils: docutils not present&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="n">openDirectory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">openDirectory</span>
        <span class="n">overrides</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;output_encoding&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="p">}</span>

        <span class="c"># Compute the args list if the stylesheet path does not exist.</span>
        <span class="n">styleSheetArgsDict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handleMissingStyleSheetArgs</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s">&#39;.pdf&#39;</span><span class="p">:</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">importFromPath</span><span class="p">(</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;leo_pdf.py&#39;</span><span class="p">,</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadDir</span><span class="p">,</span><span class="s">&#39;..&#39;</span><span class="p">,</span><span class="s">&#39;plugins&#39;</span><span class="p">),</span>
                <span class="n">pluginName</span> <span class="o">=</span> <span class="s">&#39;leo_pdf&#39;</span><span class="p">,</span>
                <span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">module</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">Writer</span><span class="p">()</span> <span class="c"># Get an instance.</span>
            <span class="n">writer_name</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">ext2</span><span class="p">,</span><span class="n">writer_name</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="p">(</span><span class="s">&#39;.html&#39;</span><span class="p">,</span><span class="s">&#39;html&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;.htm&#39;</span><span class="p">,</span><span class="s">&#39;html&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;.tex&#39;</span><span class="p">,</span><span class="s">&#39;latex&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;.pdf&#39;</span><span class="p">,</span><span class="s">&#39;leo.plugins.leo_pdf&#39;</span><span class="p">),</span> <span class="c"># 2011/11/03</span>
                <span class="p">(</span><span class="s">&#39;.s5&#39;</span><span class="p">,</span><span class="s">&#39;s5&#39;</span><span class="p">),</span> <span class="c"># 2011/03/27</span>
                <span class="p">(</span><span class="s">&#39;.odt&#39;</span><span class="p">,</span><span class="s">&#39;odt&#39;</span><span class="p">),</span> <span class="c"># 2011/03/27</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="n">ext2</span> <span class="o">==</span> <span class="n">ext</span><span class="p">:</span> <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;unknown docutils extension: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ext</span><span class="p">))</span>
                <span class="k">return</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;.html&#39;</span><span class="p">,</span><span class="s">&#39;.htm&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">SilverCity</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">silverCityWarningGiven</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">silverCityWarningGiven</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;SilverCity not present so no syntax highlighting&#39;</span><span class="p">)</span>

        <span class="c"># Make the stylesheet path relative to the directory containing the output file.</span>
        <span class="n">rel_stylesheet_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;stylesheet_path&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>

        <span class="c"># New in Leo 4.5: The rel_stylesheet_path is relative to the open directory.</span>
        <span class="n">stylesheet_path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span>
            <span class="n">openDirectory</span><span class="p">,</span><span class="n">rel_stylesheet_path</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span>
            <span class="n">stylesheet_path</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;stylesheet_name&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;stylesheet_embed&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">rel_path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_join</span><span class="p">(</span>
                <span class="n">rel_stylesheet_path</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;stylesheet_name&#39;</span><span class="p">))</span>
            <span class="n">rel_path</span> <span class="o">=</span> <span class="n">rel_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;/&#39;</span><span class="p">)</span> <span class="c"># 2010/01/28</span>
            <span class="n">overrides</span><span class="p">[</span><span class="s">&#39;stylesheet&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rel_path</span>
            <span class="n">overrides</span><span class="p">[</span><span class="s">&#39;stylesheet_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">overrides</span><span class="p">[</span><span class="s">&#39;embed_stylesheet&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ext</span> <span class="o">!=</span> <span class="s">&#39;.pdf&#39;</span><span class="p">:</span>
                <span class="n">overrides</span><span class="p">[</span><span class="s">&#39;stylesheet&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span>
                <span class="n">overrides</span><span class="p">[</span><span class="s">&#39;stylesheet_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">elif</span> <span class="n">styleSheetArgsDict</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;using publish_argv_for_missing_stylesheets&#39;</span><span class="p">,</span>
                <span class="n">styleSheetArgsDict</span><span class="p">)</span>
            <span class="n">overrides</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">styleSheetArgsDict</span><span class="p">)</span>
                <span class="c"># MWC add args to settings</span>
        <span class="k">elif</span> <span class="n">rel_stylesheet_path</span> <span class="o">==</span> <span class="n">stylesheet_path</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;stylesheet not found: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;stylesheet not found</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">:</span><span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;@path:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;open path:&#39;</span><span class="p">,</span><span class="n">openDirectory</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rel_stylesheet_path</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;relative path:&#39;</span><span class="p">,</span> <span class="n">rel_stylesheet_path</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># All paths now come through here.</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;overrides&#39;</span><span class="p">,</span><span class="n">overrides</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># Ensure that result is defined.</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">docutils</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">publish_string</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
                    <span class="n">reader_name</span><span class="o">=</span><span class="s">&#39;standalone&#39;</span><span class="p">,</span>
                    <span class="n">parser_name</span><span class="o">=</span><span class="s">&#39;restructuredtext&#39;</span><span class="p">,</span>
                    <span class="n">writer</span><span class="o">=</span><span class="n">writer</span><span class="p">,</span>
                    <span class="n">writer_name</span><span class="o">=</span><span class="n">writer_name</span><span class="p">,</span>
                    <span class="n">settings_overrides</span><span class="o">=</span><span class="n">overrides</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isBytes</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicode</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">docutils</span><span class="o">.</span><span class="n">ApplicationError</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
            <span class="c"># g.error(&#39;Docutils error (%s):&#39; % (error.__class__.__name__))</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Docutils error:&#39;</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;Unexpected docutils exception&#39;</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="c">#@+node:ekr.20090502071837.66: *6* handleMissingStyleSheetArgs</span></div>
<div class="viewcode-block" id="rstCommands.handleMissingStyleSheetArgs"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.handleMissingStyleSheetArgs">[docs]</a>    <span class="k">def</span> <span class="nf">handleMissingStyleSheetArgs</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Parse the publish_argv_for_missing_stylesheets option,</span>
<span class="sd">        returning a dict containing the parsed args.&#39;&#39;&#39;</span>

        <span class="n">force</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
            <span class="c"># See http://docutils.sourceforge.net/docs/user/config.html#documentclass</span>
            <span class="k">return</span> <span class="p">{</span><span class="s">&#39;documentclass&#39;</span><span class="p">:</span><span class="s">&#39;report&#39;</span><span class="p">,</span> <span class="s">&#39;documentoptions&#39;</span><span class="p">:</span><span class="s">&#39;english,12pt,lettersize&#39;</span><span class="p">}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;publish_argv_for_missing_stylesheets&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span> <span class="k">return</span> <span class="p">{}</span>

        <span class="c"># Handle argument lists such as this:</span>
        <span class="c"># --language=en,--documentclass=report,--documentoptions=[english,12pt,lettersize]</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">while</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;--&#39;</span><span class="p">):</span> <span class="k">break</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">eq</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">)</span>
            <span class="n">cm</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">eq</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">cm</span> <span class="o">&lt;</span> <span class="n">eq</span><span class="p">):</span> <span class="c"># key[nl] or key,</span>
                <span class="n">val</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                <span class="n">cm</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cm</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">cm</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">cm</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span> <span class="c"># key = val</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">eq</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">eq</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;[&#39;</span><span class="p">):</span> <span class="c"># [...]</span>
                    <span class="n">rb</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;]&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">rb</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="k">break</span> <span class="c"># Bad argument.</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">rb</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">rb</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">):</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span> <span class="c"># val[nl] or val,</span>
                    <span class="n">cm</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">cm</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="n">s</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">cm</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">cm</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="c"># g.trace(&#39;key&#39;,repr(key),&#39;val&#39;,repr(val),&#39;s&#39;,repr(s))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="p">:</span> <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">val</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="n">val</span> <span class="o">=</span> <span class="s">&#39;1&#39;</span>
            <span class="n">d</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">d</span>
    <span class="c">#@+node:ekr.20090502071837.88: *3* Utils</span>
    <span class="c">#@+node:ekr.20090502071837.89: *4* computeOutputFileName</span></div>
<div class="viewcode-block" id="rstCommands.computeOutputFileName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.computeOutputFileName">[docs]</a>    <span class="k">def</span> <span class="nf">computeOutputFileName</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>

        <span class="n">openDirectory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">openDirectory</span>
        <span class="n">default_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;default_path&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">default_path</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="n">default_path</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">openDirectory</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span><span class="n">openDirectory</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

        <span class="c"># g.trace(&#39;openDirectory %s\ndefault_path %s\npath %s&#39; % (</span>
            <span class="c"># repr(openDirectory),repr(default_path),repr(path)))</span>

        <span class="k">return</span> <span class="n">path</span>
    <span class="c">#@+node:ekr.20090502071837.90: *4* encode</span></div>
<div class="viewcode-block" id="rstCommands.encode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.encode">[docs]</a>    <span class="k">def</span> <span class="nf">encode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="c"># g.trace(self.encoding)</span>

        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span><span class="n">reportErrors</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20090502071837.91: *4* report</span></div>
<div class="viewcode-block" id="rstCommands.report"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.report">[docs]</a>    <span class="k">def</span> <span class="nf">report</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;verbose&#39;</span><span class="p">):</span>

            <span class="n">name</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&#39;wrote: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20090502071837.92: *4* rstComment</span></div>
<div class="viewcode-block" id="rstCommands.rstComment"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.rstComment">[docs]</a>    <span class="k">def</span> <span class="nf">rstComment</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="k">return</span> <span class="s">&#39;.. </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">s</span>
    <span class="c">#@+node:ekr.20090502071837.93: *4* underline (leoRst)</span></div>
<div class="viewcode-block" id="rstCommands.underline"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.rstCommands.underline">[docs]</a>    <span class="k">def</span> <span class="nf">underline</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return the underlining string to be used at the given level for string s.</span>
<span class="sd">        This includes the headline, and possibly a leading overlining line.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">atAutoWrite</span><span class="p">:</span>
            <span class="c"># We *might* generate overlines for top-level sections.</span>
            <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atAutoWriteUnderlines</span>
            <span class="n">level</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">level</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">topLevel</span>

            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;level: </span><span class="si">%s</span><span class="s"> under2: </span><span class="si">%s</span><span class="s"> under1: </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">level</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">underlines2</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">underlines1</span><span class="p">),</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">))</span>

            <span class="c"># This is tricky. The index n depends on several factors.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">underlines2</span><span class="p">:</span>
                <span class="n">level</span> <span class="o">-=</span> <span class="mi">1</span> <span class="c"># There *is* a double-underlined section.</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">level</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">level</span><span class="o">-</span><span class="mi">1</span>

            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="p">):</span>
                <span class="n">ch</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">u</span><span class="p">:</span>
                <span class="n">ch</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;can not happen: no u&#39;</span><span class="p">)</span>
                <span class="n">ch</span> <span class="o">=</span> <span class="s">&#39;#&#39;</span>

            <span class="c"># 2010/01/10: write longer underlines for non-ascii characters.</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span><span class="n">reportErrors</span><span class="o">=</span><span class="bp">False</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topLevel</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">level</span><span class="p">(),</span><span class="n">level</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">ch</span><span class="p">),</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">underlines2</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ch</span><span class="o">*</span><span class="n">n</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="n">ch</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="n">ch</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># The user is responsible for top-level overlining.</span>
            <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;underline_characters&#39;</span><span class="p">)</span> <span class="c">#  &#39;&#39;&#39;#=+*^~&quot;&#39;`-:&gt;&lt;_&#39;&#39;&#39;</span>
            <span class="n">level</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">level</span><span class="p">()</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">topLevel</span><span class="p">)</span>
            <span class="n">level</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">level</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c"># Reserve the first character for explicit titles.</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="n">u</span> <span class="p">[</span><span class="n">level</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">topLevel</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">level</span><span class="p">(),</span><span class="n">level</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">ch</span><span class="p">),</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span><span class="n">reportErrors</span><span class="o">=</span><span class="bp">False</span><span class="p">)))</span>
            <span class="c"># return &#39;%s\n%s\n\n&#39; % (p.h.strip(),ch*n)</span>
            <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span><span class="n">ch</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
                <span class="c"># Fixes bug 618570:</span>
    <span class="c">#@-others</span>
<span class="c">#@+node:ekr.20120219194520.10444: ** html parser classes</span>
<span class="c">#@+at</span>
<span class="c"># Code from rst3.py plugin.</span>
<span class="c"># </span>
<span class="c"># The parser classes are used to construct the html code for nodes. The algorithm has two phases:</span>
<span class="c">#     1. In the first phase, the html code for each node is identified.</span>
<span class="c">#     2. The second phase identifies all links and checks if these links need to be modified.</span>
<span class="c"># The first phase of scanning is done by the anchor_hmlParserClass. The second phase of this algorithm is</span>
<span class="c"># done with the link_htmlParserClass.</span>
<span class="c">#@@c</span>

<span class="c">#@+&lt;&lt; class linkAnchorParserClass &gt;&gt;</span>
<span class="c">#@+node:ekr.20120219194520.10445: *3*  &lt;&lt; class linkAnchorParserClass &gt;&gt;</span></div></div>
<div class="viewcode-block" id="linkAnchorParserClass"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.linkAnchorParserClass">[docs]</a><span class="k">class</span> <span class="nc">linkAnchorParserClass</span> <span class="p">(</span><span class="n">HTMLParser</span><span class="o">.</span><span class="n">HTMLParser</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A class to recognize anchors and links in HTML documents.</span>
<span class="sd">    A special marker is the &quot;node_marker&quot; which demarkates the border between </span>
<span class="sd">    node and the next.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20120219194520.10446: *4* __init__</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rst</span><span class="p">):</span>

        <span class="n">HTMLParser</span><span class="o">.</span><span class="n">HTMLParser</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="c"># Init the base class.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rst</span> <span class="o">=</span> <span class="n">rst</span>

        <span class="c"># Set ivars from options.  This works only if we don&#39;t change nodes!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_begin_marker</span>      <span class="o">=</span> <span class="n">rst</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;node_begin_marker&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_http_attributes</span>  <span class="o">=</span> <span class="n">rst</span><span class="o">.</span><span class="n">getOption</span><span class="p">(</span><span class="s">&#39;clear_http_attributes&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">current_file</span> <span class="o">=</span> <span class="n">rst</span><span class="o">.</span><span class="n">outputFileName</span>
    <span class="c">#@+node:ekr.20120219194520.10447: *4* is_anchor</span>
<div class="viewcode-block" id="linkAnchorParserClass.is_anchor"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.linkAnchorParserClass.is_anchor">[docs]</a>    <span class="k">def</span> <span class="nf">is_anchor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the current tag is an anchor.</span>
<span class="sd">        Returns *all* anchors.</span>
<span class="sd">        Works with docutils 0.4</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;a&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_node_marker</span><span class="p">(</span><span class="n">attrs</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="n">tag</span> <span class="o">==</span> <span class="s">&quot;span&quot;</span>
    <span class="c">#@+node:ekr.20120219194520.10448: *4* is_link</span></div>
<div class="viewcode-block" id="linkAnchorParserClass.is_link"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.linkAnchorParserClass.is_link">[docs]</a>    <span class="k">def</span> <span class="nf">is_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return True if tag, attrs is represents a link.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">tag</span> <span class="o">!=</span> <span class="s">&#39;a&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="n">result</span> <span class="o">=</span> <span class="s">&#39;href&#39;</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="c">#@+node:ekr.20120219194520.10449: *4* is_node_marker</span></div>
<div class="viewcode-block" id="linkAnchorParserClass.is_node_marker"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.linkAnchorParserClass.is_node_marker">[docs]</a>    <span class="k">def</span> <span class="nf">is_node_marker</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">attrs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return the name of the anchor, if this is an anchor for the beginning of a node,</span>
<span class="sd">        False otherwise.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="s">&#39;id&#39;</span> <span class="ow">in</span> <span class="n">d</span> <span class="ow">and</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_begin_marker</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="c">#@-others</span>
<span class="c">#@-&lt;&lt; class linkAnchorParserClass &gt;&gt;</span>
<span class="c">#@+node:ekr.20120219194520.10450: *3* class htmlParserClass (linkAnchorParserClass)</span></div></div>
<div class="viewcode-block" id="htmlParserClass"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.htmlParserClass">[docs]</a><span class="k">class</span> <span class="nc">htmlParserClass</span> <span class="p">(</span><span class="n">linkAnchorParserClass</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    The responsibility of the html parser is:</span>
<span class="sd">        1. Find out which html code belongs to which node.</span>
<span class="sd">        2. Keep a stack of open tags which apply to the current node.</span>
<span class="sd">        3. Keep a list of tags which should be included in the nodes, even</span>
<span class="sd">           though they might be closed.</span>
<span class="sd">           The &lt;style&gt; tag is one example of that.</span>

<span class="sd">    Later, we have to relocate inter-file links: if a reference to another location</span>
<span class="sd">    is in a file, we must change the link.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20120219194520.10451: *4* __init__</span>
    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rst</span><span class="p">):</span>

        <span class="n">linkAnchorParserClass</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rst</span><span class="p">)</span> <span class="c"># Init the base class.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c"># The stack contains lists of the form:</span>
            <span class="c"># [text1, text2, previous].</span>
            <span class="c"># text1 is the opening tag</span>
            <span class="c"># text2 is the closing tag</span>
            <span class="c"># previous points to the previous stack element</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">node_marker_stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c"># self.node_marker_stack.pop() returns True for a closing</span>
        <span class="c"># tag if the opening tag identified an anchor belonging to a vnode.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">node_code</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c"># Accumulated html code.</span>
            <span class="c"># Once the hmtl code is assigned a vnode, it is deleted here.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">deleted_lines</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># Number of lines deleted in self.node_code</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">endpos_pending</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c"># Do not include self.node_code[0:self.endpos_pending] in the html code.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">last_position</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c"># Last position; we must attach html code to this node.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">last_marker</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20120219194520.10452: *4* handle_starttag</span>
<div class="viewcode-block" id="htmlParserClass.handle_starttag"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.htmlParserClass.handle_starttag">[docs]</a>    <span class="k">def</span> <span class="nf">handle_starttag</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">tag</span><span class="p">,</span><span class="n">attrs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        1. Find out if the current tag is an achor.</span>
<span class="sd">        2. If it is an anchor, we check if this anchor marks the beginning of a new </span>
<span class="sd">           node</span>
<span class="sd">        3. If a new node begins, then we might have to store html code for the previous</span>
<span class="sd">           node.</span>
<span class="sd">        4. In any case, put the new tag on the stack.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">is_node_marker</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_anchor</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="n">attrs</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_node_marker</span><span class="p">(</span><span class="n">attrs</span><span class="p">):</span>
            <span class="n">is_node_marker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_node_marker</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
            <span class="c"># g.trace(tag,attrs)</span>
            <span class="n">line</span><span class="p">,</span> <span class="n">column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getpos</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_position</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_code</span> <span class="p">[:]</span>
                <span class="n">lines</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">lines</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">startpos</span><span class="p">:]</span>
                <span class="k">del</span> <span class="n">lines</span> <span class="p">[</span><span class="n">line</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">deleted_lines</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
                <span class="c"># g.trace(&#39;Storing in %s...\n%s&#39; % self.last_position, lines)</span>
                <span class="n">mod_http</span><span class="o">.</span><span class="n">get_http_attribute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_position</span><span class="p">)</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                <span class="c">#@+&lt;&lt; trace the unknownAttribute &gt;&gt;</span>
                <span class="c">#@+node:ekr.20120219194520.10453: *5* &lt;&lt; trace the unknownAttribute &gt;&gt;</span>
                <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;rst3: unknownAttributes[self.http_attributename]&quot;</span><span class="p">)</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;For:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_position</span><span class="p">)</span>
                    <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">mod_http</span><span class="o">.</span><span class="n">get_http_attribute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_position</span><span class="p">))</span>
                <span class="c">#@-&lt;&lt; trace the unknownAttribute &gt;&gt;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deleted_lines</span> <span class="o">&lt;</span> <span class="n">line</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_code</span> <span class="p">[:</span> <span class="n">line</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">deleted_lines</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">deleted_lines</span> <span class="o">=</span> <span class="n">line</span><span class="o">-</span><span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">endpos_pending</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c"># g.trace(&quot;rst2: handle_starttag:&quot;, tag, attrs, is_node_marker)</span>
        <span class="n">starttag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_starttag_text</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="p">[</span><span class="n">starttag</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_marker_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">is_node_marker</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20120219194520.10454: *4* handle_endtag</span></div>
<div class="viewcode-block" id="htmlParserClass.handle_endtag"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.htmlParserClass.handle_endtag">[docs]</a>    <span class="k">def</span> <span class="nf">handle_endtag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        1. Set the second element of the current top of stack.</span>
<span class="sd">        2. If this is the end tag for an anchor for a node,</span>
<span class="sd">           store the current stack for that node.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&lt;/&quot;</span> <span class="o">+</span> <span class="n">tag</span> <span class="o">+</span> <span class="s">&quot;&gt;&quot;</span>

        <span class="c"># g.trace(tag,g.listToString(self.stack))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">endpos_pending</span><span class="p">:</span>
            <span class="n">line</span><span class="p">,</span> <span class="n">column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getpos</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">startpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_code</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;&gt;&quot;</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">endpos_pending</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="n">is_node_marker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_marker_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">is_node_marker</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">clear_http_attributes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rst</span><span class="o">.</span><span class="n">http_map</span><span class="p">[</span><span class="n">is_node_marker</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">is_node_marker</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_marker</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bwm_file</span><span class="p">:</span> <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">bwm_file</span><span class="p">,</span> <span class="s">&quot;Handle endtag:&quot;</span><span class="p">,</span> <span class="n">is_node_marker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span>
                <span class="n">mod_http</span><span class="o">.</span><span class="n">set_http_attribute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rst</span><span class="o">.</span><span class="n">http_map</span><span class="p">[</span><span class="n">is_node_marker</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_marker</span> <span class="o">=</span> <span class="n">is_node_marker</span>
                <span class="c">#bwm: last_marker is not needed?</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="c">#@+node:ekr.20120219194520.10455: *4* feed</span></div>
<div class="viewcode-block" id="htmlParserClass.feed"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.htmlParserClass.feed">[docs]</a>    <span class="k">def</span> <span class="nf">feed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>

        <span class="c"># g.trace(repr(line))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">node_code</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="n">HTMLParser</span><span class="o">.</span><span class="n">HTMLParser</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span> <span class="c"># Call the base class&#39;s feed().</span>
    <span class="c">#@-others</span>
<span class="c">#@+node:ekr.20120219194520.10456: *3* class anchor_htmlParserClass (linkAnchorParserClass)</span></div></div>
<div class="viewcode-block" id="anchor_htmlParserClass"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.anchor_htmlParserClass">[docs]</a><span class="k">class</span> <span class="nc">anchor_htmlParserClass</span> <span class="p">(</span><span class="n">linkAnchorParserClass</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This htmlparser does the first step of relocating: finding all the anchors within the html nodes.</span>

<span class="sd">    Each anchor is mapped to a tuple:</span>
<span class="sd">        (current_file, position).</span>

<span class="sd">    Filters out markers which mark the beginning of the html code for a node.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20120219194520.10457: *4*  __init__</span>
    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rst</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="n">linkAnchorParserClass</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rst</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anchor_map</span> <span class="o">=</span> <span class="n">rst</span><span class="o">.</span><span class="n">anchor_map</span>
    <span class="c">#@+node:ekr.20120219194520.10458: *4* handle_starttag</span>
<div class="viewcode-block" id="anchor_htmlParserClass.handle_starttag"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.anchor_htmlParserClass.handle_starttag">[docs]</a>    <span class="k">def</span> <span class="nf">handle_starttag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        1. Find out if the current tag is an achor.</span>
<span class="sd">        2. If the current tag is an anchor, update the mapping;</span>
<span class="sd">             anchor -&gt; (filename, p)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_anchor</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor_map</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">anchor_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_file</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
            <span class="n">simple_name</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_file</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">anchor_map</span><span class="p">[</span><span class="n">simple_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_file</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">bwm_file</span><span class="p">:</span> <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">bwm_file</span><span class="p">,</span> <span class="s">&quot;anchor(1): current_file:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_file</span><span class="p">,</span> <span class="s">&quot;position:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;Simple name:&quot;</span><span class="p">,</span> <span class="n">simple_name</span>
            <span class="c"># Not sure what to do here, exactly. Do I need to manipulate</span>
            <span class="c"># the pathname?</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;name&#39;</span> <span class="ow">or</span> <span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;span&#39;</span> <span class="ow">and</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;id&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_begin_marker</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">bwm_file</span><span class="p">:</span> <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">bwm_file</span><span class="p">,</span> <span class="s">&quot;anchor(2):&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">anchor_map</span><span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
    <span class="c">#@-others</span>
<span class="c">#@+node:ekr.20120219194520.10459: *3* class link_htmlParserClass (linkAnchorParserClass)</span></div></div>
<div class="viewcode-block" id="link_htmlparserClass"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.link_htmlparserClass">[docs]</a><span class="k">class</span> <span class="nc">link_htmlparserClass</span> <span class="p">(</span><span class="n">linkAnchorParserClass</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;This html parser does the second step of relocating links:</span>
<span class="sd">    1. It scans the html code for links.</span>
<span class="sd">    2. If there is a link which links to a previously processed file</span>
<span class="sd">       then this link is changed so that it now refers to the node.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20120219194520.10460: *4* __init__</span>
    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rst</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="n">linkAnchorParserClass</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">rst</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anchor_map</span> <span class="o">=</span> <span class="n">rst</span><span class="o">.</span><span class="n">anchor_map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replacements</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c">#@+node:ekr.20120219194520.10461: *4* handle_starttag</span>
<div class="viewcode-block" id="link_htmlparserClass.handle_starttag"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.link_htmlparserClass.handle_starttag">[docs]</a>    <span class="k">def</span> <span class="nf">handle_starttag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        1. Find out if the current tag is an achor.</span>
<span class="sd">        2. If the current tag is an anchor, update the mapping;</span>
<span class="sd">             anchor -&gt; p</span>
<span class="sd">            Update the list of replacements for the document.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">bwm_file</span><span class="p">:</span> <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">bwm_file</span><span class="p">,</span> <span class="s">&quot;Is link?&quot;</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_link</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="n">marker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_begin_marker</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;href&#39;</span><span class="p">:</span>
                <span class="n">href</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">href_parts</span> <span class="o">=</span> <span class="n">href</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;#&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">href_parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">href_a</span> <span class="o">=</span> <span class="n">href_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">href_a</span> <span class="o">=</span> <span class="n">href_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">bwm_file</span><span class="p">:</span> <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">bwm_file</span><span class="p">,</span> <span class="s">&quot;link(1):&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">href_a</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">href_a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">marker</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">href_a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor_map</span><span class="p">:</span>
                        <span class="n">href_file</span><span class="p">,</span> <span class="n">href_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anchor_map</span><span class="p">[</span><span class="n">href_a</span><span class="p">]</span>
                        <span class="n">http_node_ref</span> <span class="o">=</span> <span class="n">mod_http</span><span class="o">.</span><span class="n">node_reference</span><span class="p">(</span><span class="n">href_node</span><span class="p">)</span>
                        <span class="n">line</span><span class="p">,</span> <span class="n">column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getpos</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">bwm_file</span><span class="p">:</span> <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">bwm_file</span><span class="p">,</span> <span class="s">&quot;link(2):&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">href</span><span class="p">,</span> <span class="n">href_file</span><span class="p">,</span> <span class="n">http_node_ref</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">replacements</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">line</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">href</span><span class="p">,</span> <span class="n">href_file</span><span class="p">,</span> <span class="n">http_node_ref</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20120219194520.10462: *4* get_replacements</span></div>
<div class="viewcode-block" id="link_htmlparserClass.get_replacements"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoRst.link_htmlparserClass.get_replacements">[docs]</a>    <span class="k">def</span> <span class="nf">get_replacements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">replacements</span>
    <span class="c">#@-others</span>
<span class="c">#@-others</span>
<span class="c">#@-leo</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Leo API 4.11dev documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Ed K. Ream.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
  </body>
</html>