<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>leo.core.leoGlobals &mdash; Leo API 4.11dev documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '4.11dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Leo API 4.11dev documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Leo API 4.11dev documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for leo.core.leoGlobals</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="c">#@+leo-ver=5-thin</span>
<span class="c">#@+node:ekr.20031218072017.3093: * @file leoGlobals.py</span>
<span class="c">#@@first</span>

<span class="sd">&#39;&#39;&#39;Global constants, variables and utility functions used throughout Leo.</span>

<span class="sd">Important: This module imports no other Leo module.</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="c">#@@language python</span>
<span class="c">#@@tabwidth -4</span>
<span class="c">#@@pagewidth 70</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">isPython3</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="c">#@+&lt;&lt; global switches &gt;&gt;</span>
<span class="c">#@+node:ekr.20120212060348.10374: **  &lt;&lt; global switches &gt;&gt;</span>
<span class="n">trace_startup</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c"># These traces use print instead of g.trace so that</span>
    <span class="c"># the traces can add class info the method name.</span>

<span class="n">new_modes</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c"># True: use ModeController and ModeInfo classes.</span>
<span class="k">if</span> <span class="n">new_modes</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;***** new_modes&#39;</span><span class="p">)</span>

<span class="n">new_keys</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c"># This project hardly seems urgent.</span>
    <span class="c"># True: Qt input methods produce a **user setting**, not a stroke.</span>
<span class="k">if</span> <span class="n">new_keys</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;***** new_keys&#39;</span><span class="p">)</span>

<span class="c"># Debugging options...</span>

<span class="n">enableDB</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="c"># Don&#39;t even think about eliminating this constant:</span>
    <span class="c"># it is needed for debugging.</span>

<span class="n">no_scroll</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c"># True: disable all calls to w.setYScrollPosition.</span>
<span class="n">no_see</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c"># True: disable all calls to w.see and w.seeInsertPoint.</span>

<span class="c"># Tracing options...</span>

<span class="n">trace_scroll</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c"># Trace calls to get/setYScrollPosition</span>
<span class="n">trace_see</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c"># Trace calls to see and setInsertPoint.</span>

<span class="c"># Switches to trace the garbage collector.</span>
<span class="n">trace_gc</span> <span class="o">=</span> <span class="bp">False</span>           
<span class="n">trace_gc_calls</span> <span class="o">=</span> <span class="bp">False</span>    
<span class="n">trace_gc_calls</span> <span class="o">=</span> <span class="bp">False</span> 
<span class="n">trace_gc_verbose</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">trace_gc_inited</span> <span class="o">=</span> <span class="bp">False</span>

<span class="n">trace_masterCommand</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">trace_masterKeyHandler</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">trace_masterKeyHandlerGC</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">trace_minibuffer</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">trace_modes</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c"># These print statements have been moved to writeWaitingLog.</span>
<span class="c"># This allows for better --silent operation.</span>
<span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;*** isPython3: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">isPython3</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">enableDB</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;** leoGlobals.py: caching disabled&#39;</span><span class="p">)</span>

<span class="c">#@-&lt;&lt; global switches &gt;&gt;</span>
<span class="c">#@+&lt;&lt; imports &gt;&gt;</span>
<span class="c">#@+node:ekr.20050208101229: ** &lt;&lt; imports &gt;&gt; (leoGlobals)</span>
<span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
    <span class="c"># This is now done in run.</span>
    <span class="kn">import</span> <span class="nn">leo.core.leoGlobals</span> <span class="kn">as</span> <span class="nn">g</span> <span class="c"># So code can use g below.</span>

<span class="c"># Don&#39;t import this here: it messes up Leo&#39;s startup code.</span>
<span class="c"># import leo.core.leoTest as leoTest</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">gc</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">gc</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">filecmp</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span> <span class="c"># does not exist in jython.</span>
    <span class="n">filecmp</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">gettext</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span> <span class="c"># does not exist in jython.</span>
    <span class="n">gettext</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">if</span> <span class="n">isPython3</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="nb">reduce</span>

<span class="k">if</span> <span class="n">isPython3</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">io</span>
    <span class="n">StringIO</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">cStringIO</span>
    <span class="n">StringIO</span> <span class="o">=</span> <span class="n">cStringIO</span><span class="o">.</span><span class="n">StringIO</span>

<span class="kn">import</span> <span class="nn">imp</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c"># Module &#39;urllib&#39; has no &#39;parse&#39; member.</span>
<span class="kn">import</span> <span class="nn">urllib</span> <span class="c"># pylint: disable=E0611</span>

<span class="c"># Do NOT import pdb here!  We shall define pdb as a _function_ below.</span>
<span class="c"># import pdb</span>

<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="c"># import sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">types</span>

<span class="k">if</span> <span class="n">isPython3</span><span class="p">:</span>
    <span class="c"># E0611: No name &#39;parse&#39; in urllib.</span>
    <span class="kn">import</span> <span class="nn">urllib.parse</span> <span class="kn">as</span> <span class="nn">urlparse</span> <span class="c"># pylint: disable=E0611</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">urlparse</span>

<span class="c"># import zipfile</span>

<span class="c"># These do not exist in IronPython.</span>
<span class="c"># However, it *is* valid for IronPython to use the Python 2.4 libs!</span>
    <span class="c"># import os</span>
    <span class="c"># import string</span>
    <span class="c"># import tempfile</span>
    <span class="c"># import traceback</span>
    <span class="c"># import types</span>
<span class="c">#@-&lt;&lt; imports &gt;&gt;</span>
<span class="c">#@+&lt;&lt; define globalDirectiveList &gt;&gt;</span>
<span class="c">#@+node:EKR.20040610094819: ** &lt;&lt; define globalDirectiveList &gt;&gt;</span>
<span class="c"># Visible externally so plugins may add to the list of directives.</span>

<span class="n">globalDirectiveList</span> <span class="o">=</span> <span class="p">[</span>

    <span class="c"># *** Longer prefixes must appear before shorter.</span>
    <span class="s">&#39;all&#39;</span><span class="p">,</span>
    <span class="s">&#39;colorcache&#39;</span><span class="p">,</span> <span class="c"># 2012/10/03.</span>
    <span class="s">&#39;code&#39;</span><span class="p">,</span><span class="s">&#39;color&#39;</span><span class="p">,</span> <span class="s">&#39;comment&#39;</span><span class="p">,</span><span class="s">&#39;c&#39;</span><span class="p">,</span>
    <span class="s">&#39;delims&#39;</span><span class="p">,</span><span class="s">&#39;doc&#39;</span><span class="p">,</span><span class="s">&#39;encoding&#39;</span><span class="p">,</span><span class="s">&#39;end_raw&#39;</span><span class="p">,</span>
    <span class="s">&#39;first&#39;</span><span class="p">,</span><span class="s">&#39;header&#39;</span><span class="p">,</span><span class="s">&#39;ignore&#39;</span><span class="p">,</span><span class="s">&#39;killcolor&#39;</span><span class="p">,</span>
    <span class="s">&#39;language&#39;</span><span class="p">,</span><span class="s">&#39;last&#39;</span><span class="p">,</span><span class="s">&#39;lineending&#39;</span><span class="p">,</span>
    <span class="s">&#39;markup&#39;</span><span class="p">,</span> <span class="c"># Make this an official directive,</span>
    <span class="s">&#39;nocolor-node&#39;</span><span class="p">,</span><span class="s">&#39;nocolor&#39;</span><span class="p">,</span><span class="s">&#39;noheader&#39;</span><span class="p">,</span><span class="s">&#39;nowrap&#39;</span><span class="p">,</span>
    <span class="s">&#39;others&#39;</span><span class="p">,</span><span class="s">&#39;pagewidth&#39;</span><span class="p">,</span><span class="s">&#39;path&#39;</span><span class="p">,</span><span class="s">&#39;quiet&#39;</span><span class="p">,</span>
    <span class="s">&#39;raw&#39;</span><span class="p">,</span><span class="s">&#39;root-code&#39;</span><span class="p">,</span><span class="s">&#39;root-doc&#39;</span><span class="p">,</span><span class="s">&#39;root&#39;</span><span class="p">,</span><span class="s">&#39;silent&#39;</span><span class="p">,</span>
    <span class="s">&#39;tabwidth&#39;</span><span class="p">,</span> <span class="s">&#39;terse&#39;</span><span class="p">,</span>
    <span class="s">&#39;unit&#39;</span><span class="p">,</span><span class="s">&#39;verbose&#39;</span><span class="p">,</span> <span class="s">&#39;wrap&#39;</span><span class="p">,</span>
<span class="p">]</span>
<span class="c">#@-&lt;&lt; define globalDirectiveList &gt;&gt;</span>
<span class="c">#@+&lt;&lt; define the nullObject class &gt;&gt;</span>
<span class="c">#@+node:ekr.20090521175848.5881: ** &lt;&lt; define the nullObject class &gt;&gt;</span>
<span class="c"># From the Python cookbook, recipe 5.23</span>

<div class="viewcode-block" id="nullObject"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.nullObject">[docs]</a><span class="k">class</span> <span class="nc">nullObject</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;An object that does nothing, and does it very well.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span>   <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">):</span> <span class="k">pass</span>
    <span class="k">def</span> <span class="nf">__call__</span>   <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span>
    <span class="c"># def __len__    (self): return 0 # Debatable.</span>
    <span class="k">def</span> <span class="nf">__repr__</span>   <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="s">&quot;nullObject&quot;</span>
    <span class="k">def</span> <span class="nf">__str__</span>    <span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="s">&quot;nullObject&quot;</span>
    <span class="k">if</span> <span class="n">isPython3</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="bp">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">__nonzero__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">return</span> <span class="mi">0</span>
    <span class="k">def</span> <span class="nf">__delattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">attr</span><span class="p">):</span>     <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">attr</span><span class="p">):</span>     <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="nf">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">attr</span><span class="p">,</span><span class="n">val</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span>
<span class="c">#@-&lt;&lt; define the nullObject class &gt;&gt;</span></div>
<span class="n">tree_popup_handlers</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># Set later.</span>
<span class="c"># g = None</span>
<span class="n">app</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># The singleton app object. Set by runLeo.py.</span>

<span class="c"># Global status vars.</span>
<span class="n">inScript</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># A synonym for app.inScript</span>
<span class="n">unitTesting</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># A synonym for app.unitTesting.</span>

<span class="c">#@+others</span>
<span class="c">#@+node:ekr.20031218072017.3095: ** Checking Leo Files...</span>
<span class="c">#@+node:ekr.20031218072017.822: *3* createTopologyList</span>
<div class="viewcode-block" id="createTopologyList"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.createTopologyList">[docs]</a><span class="k">def</span> <span class="nf">createTopologyList</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">root</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">useHeadlines</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Creates a list describing a node and all its descendents&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">root</span><span class="p">:</span> <span class="n">root</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">root</span>
    <span class="k">if</span> <span class="n">useHeadlines</span><span class="p">:</span>
        <span class="n">aList</span> <span class="o">=</span> <span class="p">[(</span><span class="n">v</span><span class="o">.</span><span class="n">numberOfChildren</span><span class="p">(),</span><span class="n">v</span><span class="o">.</span><span class="n">headString</span><span class="p">()),]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">aList</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">numberOfChildren</span><span class="p">()]</span>
    <span class="n">child</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">firstChild</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">child</span><span class="p">:</span>
        <span class="n">aList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">createTopologyList</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">child</span><span class="p">,</span><span class="n">useHeadlines</span><span class="p">))</span>
        <span class="n">child</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">aList</span>
<span class="c">#@+node:ekr.20031218072017.3099: ** Commands &amp; Directives</span>
<span class="c">#@+node:ekr.20031218072017.1380: *3* g.Directive utils...</span>
<span class="c"># New in Leo 4.6:</span>
<span class="c"># g.findAtTabWidthDirectives, g.findLanguageDirectives and</span>
<span class="c"># g.get_directives_dict use re module for faster searching.</span>
<span class="c">#@+node:EKR.20040504150046.4: *4* g.comment_delims_from_extension</span></div>
<div class="viewcode-block" id="comment_delims_from_extension"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.comment_delims_from_extension">[docs]</a><span class="k">def</span> <span class="nf">comment_delims_from_extension</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the comment delims corresponding to the filename&#39;s extension.</span>

<span class="sd">    &gt;&gt;&gt; import leo.core.leoGlobals as g</span>
<span class="sd">    &gt;&gt;&gt; g.comment_delims_from_extension(&quot;.py&quot;)</span>
<span class="sd">    (&#39;#&#39;, &#39;&#39;, &#39;&#39;)</span>

<span class="sd">    &gt;&gt;&gt; g.comment_delims_from_extension(&quot;.c&quot;)</span>
<span class="sd">    (&#39;//&#39;, &#39;/*&#39;, &#39;*/&#39;)</span>

<span class="sd">    &gt;&gt;&gt; g.comment_delims_from_extension(&quot;.html&quot;)</span>
<span class="sd">    (&#39;&#39;, &#39;&lt;!--&#39;, &#39;--&gt;&#39;)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">):</span>
        <span class="c"># Python 2.6 changes how splitext works.</span>
        <span class="n">root</span><span class="p">,</span><span class="n">ext</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span><span class="n">filename</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">root</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s">&#39;.tmp&#39;</span><span class="p">:</span>
        <span class="n">root</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>

    <span class="n">language</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">extension_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ext</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">if</span> <span class="n">ext</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">set_delims_from_language</span><span class="p">(</span><span class="n">language</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&quot;unknown extension: </span><span class="si">%s</span><span class="s">, filename: </span><span class="si">%s</span><span class="s">, root: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">repr</span><span class="p">(</span><span class="n">ext</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">root</span><span class="p">)))</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span>
<span class="c">#@+node:ekr.20090214075058.8: *4* g.findAtTabWidthDirectives (must be fast)</span></div>
<span class="n">g_tabwidth_pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;(^@tabwidth)&#39;</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>

<div class="viewcode-block" id="findTabWidthDirectives"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.findTabWidthDirectives">[docs]</a><span class="k">def</span> <span class="nf">findTabWidthDirectives</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Return the language in effect at position p.&#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="c"># c may be None for testing.</span>

    <span class="n">w</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c"># 2009/10/02: no need for copy arg to iter</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">self_and_parents</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">w</span><span class="p">:</span> <span class="k">break</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">w</span><span class="p">:</span> <span class="k">break</span>
            <span class="n">anIter</span> <span class="o">=</span> <span class="n">g_tabwidth_pat</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">anIter</span><span class="p">:</span>
                <span class="n">word</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">))</span>
                <span class="n">junk</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_long</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">w</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">w</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">w</span>
<span class="c">#@+node:ekr.20090214075058.6: *4* g.findLanguageDirectives (must be fast)</span></div>
<span class="n">g_language_pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;(^@language)&#39;</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>

<div class="viewcode-block" id="findLanguageDirectives"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.findLanguageDirectives">[docs]</a><span class="k">def</span> <span class="nf">findLanguageDirectives</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Return the language in effect at position p.&#39;&#39;&#39;</span>

    <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

    <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="c"># c may be None for testing. </span>
    <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">target_language</span><span class="p">:</span>
        <span class="n">language</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">target_language</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">language</span> <span class="o">=</span> <span class="s">&#39;python&#39;</span>
    <span class="n">found</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c"># 2009/10/02: no need for copy arg to iter.</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">self_and_parents</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">found</span><span class="p">:</span> <span class="k">break</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">found</span><span class="p">:</span> <span class="k">break</span>
            <span class="n">anIter</span> <span class="o">=</span> <span class="n">g_language_pat</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">anIter</span><span class="p">:</span>
                <span class="n">word</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
                <span class="n">language</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">found</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">language</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">language</span>
<span class="c">#@+node:ekr.20031218072017.1385: *4* g.findReference</span>
<span class="c"># Called from the syntax coloring method that colorizes section references.</span>
<span class="c"># Also called from write at.putRefAt.</span>
</div>
<div class="viewcode-block" id="findReference"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.findReference">[docs]</a><span class="k">def</span> <span class="nf">findReference</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">root</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Find the section definition for name.</span>

<span class="sd">    If a search of the descendants fails,</span>
<span class="sd">    and an ancestor is an @root node,</span>
<span class="sd">    search all the descendants of the @root node.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">subtree</span><span class="p">():</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">p</span><span class="o">!=</span><span class="n">root</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">matchHeadline</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">isAtIgnoreNode</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">p</span>

    <span class="c"># New in Leo 4.7: expand the search for @root trees.</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">self_and_parents</span><span class="p">():</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_directives_dict</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;root&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p2</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">subtree</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">p2</span><span class="o">.</span><span class="n">matchHeadline</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">p2</span><span class="o">.</span><span class="n">isAtIgnoreNode</span><span class="p">():</span>
                    <span class="k">return</span> <span class="n">p2</span>

    <span class="c"># g.trace(&quot;not found:&quot;,name,root)</span>
    <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">nullPosition</span><span class="p">()</span>
<span class="c">#@+node:ekr.20090214075058.9: *4* g.get_directives_dict (must be fast)</span>
<span class="c"># The caller passes [root_node] or None as the second arg.</span>
<span class="c"># This allows us to distinguish between None and [None].</span>
</div>
<span class="n">g_noweb_root</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;&lt;&#39;</span><span class="o">+</span><span class="s">&#39;&lt;&#39;</span><span class="o">+</span><span class="s">&#39;*&#39;</span><span class="o">+</span><span class="s">&#39;&gt;&#39;</span><span class="o">+</span><span class="s">&#39;&gt;&#39;</span><span class="o">+</span><span class="s">&#39;=&#39;</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>

<div class="viewcode-block" id="get_directives_dict"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.get_directives_dict">[docs]</a><span class="k">def</span> <span class="nf">get_directives_dict</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">root</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">scanToCursor</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Scan p for @directives found in globalDirectiveList.</span>

<span class="sd">    Returns a dict containing the stripped remainder of the line</span>
<span class="sd">    following the first occurrence of each recognized directive&quot;&quot;&quot;</span>

    <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;*&#39;</span><span class="o">*</span><span class="mi">20</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">root</span><span class="p">:</span> <span class="n">root_node</span> <span class="o">=</span> <span class="n">root</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c"># Do this every time so plugins can add directives.</span>
    <span class="n">pat</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">compute_directives_re</span><span class="p">()</span>
    <span class="n">directives_pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>

    <span class="c"># The headline has higher precedence because it is more visible.</span>
    <span class="k">for</span> <span class="n">kind</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="p">((</span><span class="s">&#39;head&#39;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">),(</span><span class="s">&#39;body&#39;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="p">)):</span>
        <span class="n">anIter</span> <span class="o">=</span> <span class="n">directives_pat</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">anIter</span><span class="p">:</span>
            <span class="n">word</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span> <span class="c"># Omit the @</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="c"># 2012/03/9: Special case @language directive in the body.</span>
                <span class="p">(</span><span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;body&#39;</span> <span class="ow">and</span> <span class="n">scanToCursor</span> <span class="ow">and</span> <span class="n">word</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;language&#39;</span><span class="p">)</span>
                <span class="ow">or</span> <span class="n">word</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">d</span>
            <span class="p">):</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">):</span>
                    <span class="c"># g.es_print(&#39;invalid character after directive&#39;,s[max(0,i-1):k-1])</span>
                    <span class="c"># if trace:g.trace(word,repr(val),s[i:i+20])</span>
                    <span class="k">pass</span> <span class="c"># Not a valid directive: just ignore it.</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">directive_word</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">directive_word</span> <span class="o">==</span> <span class="s">&#39;language&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;body&#39;</span> <span class="ow">and</span> <span class="n">scanToCursor</span><span class="p">:</span>
                            <span class="c"># 2012/03/09:Only add preceding @language directives.</span>
                            <span class="n">c</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">context</span>
                            <span class="n">w</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">bodyCtrl</span>
                            <span class="n">ins</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getInsertPoint</span><span class="p">()</span>
                            <span class="n">i1</span><span class="p">,</span><span class="n">i2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">getLine</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">kind</span><span class="p">,</span><span class="n">directive_word</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">ins</span> <span class="o">&gt;=</span> <span class="n">i2</span><span class="p">:</span>
                                <span class="n">d</span><span class="p">[</span><span class="n">directive_word</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">d</span><span class="p">[</span><span class="n">directive_word</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">directive_word</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;root-doc&#39;</span><span class="p">,</span> <span class="s">&#39;root-code&#39;</span><span class="p">):</span>
                            <span class="n">d</span><span class="p">[</span><span class="s">&#39;root&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="c"># in addition to optioned version</span>
                        <span class="n">d</span><span class="p">[</span><span class="n">directive_word</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

                    <span class="c"># g.trace(kind,directive_word,val)</span>

                    <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">word</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span><span class="n">kind</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
                    <span class="c"># A special case for @path in the body text of @&lt;file&gt; nodes.</span>
                    <span class="c"># Don&#39;t give an actual warning: just set some flags.</span>
                    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;body&#39;</span> <span class="ow">and</span> <span class="n">word</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;path&#39;</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">isAnyAtFileNode</span><span class="p">():</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">atPathInBodyWarning</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span>
                        <span class="n">d</span><span class="p">[</span><span class="s">&#39;@path_in_body&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span>
                        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;@path in body&#39;</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">root</span><span class="p">:</span>
        <span class="n">anIter</span> <span class="o">=</span> <span class="n">g_noweb_root</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">anIter</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">root_node</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="s">&quot;root&quot;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span> <span class="c"># value not immportant</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">= may only occur in a topmost node (i.e., without a parent)&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">angleBrackets</span><span class="p">(</span><span class="s">&#39;*&#39;</span><span class="p">)))</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%4d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="p">)),</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">d</span>
<span class="c">#@+node:ekr.20090214075058.10: *5* compute_directives_re</span></div>
<div class="viewcode-block" id="compute_directives_re"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.compute_directives_re">[docs]</a><span class="k">def</span> <span class="nf">compute_directives_re</span> <span class="p">():</span>

    <span class="sd">&#39;&#39;&#39;Return an re pattern which will match all Leo directives.&#39;&#39;&#39;</span>

    <span class="k">global</span> <span class="n">globalDirectiveList</span>

    <span class="n">aList</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;^@</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">z</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">globalDirectiveList</span>
                <span class="k">if</span> <span class="n">z</span> <span class="o">!=</span> <span class="s">&#39;others&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># 2010/02/01</span>
        <span class="c"># The code never uses this, and this regex is broken</span>
        <span class="c"># because it can confuse g.get_directives_dict.</span>
        <span class="c"># @others can have leading whitespace.</span>
        <span class="n">aList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">r&#39;^\s@others\s&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="s">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">aList</span><span class="p">)</span>
<span class="c">#@+node:ekr.20080827175609.1: *4* g.get_directives_dict_list (must be fast)</span></div>
<div class="viewcode-block" id="get_directives_dict_list"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.get_directives_dict_list">[docs]</a><span class="k">def</span> <span class="nf">get_directives_dict_list</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">scanToCursor</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Scans p and all its ancestors for directives.</span>

<span class="sd">    Returns a list of dicts containing pointers to</span>
<span class="sd">    the start of each directive&quot;&quot;&quot;</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">p1</span><span class="o">.</span><span class="n">self_and_parents</span><span class="p">():</span>
        <span class="n">root</span> <span class="o">=</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">hasParent</span><span class="p">()</span> <span class="k">else</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()]</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">get_directives_dict</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">root</span><span class="o">=</span><span class="n">root</span><span class="p">,</span>
            <span class="n">scanToCursor</span><span class="o">=</span><span class="n">scanToCursor</span> <span class="ow">and</span> <span class="n">p</span> <span class="o">==</span> <span class="n">p1</span><span class="p">))</span>
    <span class="c"># if trace:</span>
        <span class="c"># n = len(p1.h) + len(p1.b)</span>
        <span class="c"># g.trace(&#39;%4d %s&#39; % (n,g.timeSince(time1)))</span>
    <span class="k">return</span> <span class="n">result</span>
<span class="c">#@+node:ekr.20111010082822.15545: *4* g.getLanguageFromAncestorAtFileNode (New)</span></div>
<div class="viewcode-block" id="getLanguageFromAncestorAtFileNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.getLanguageFromAncestorAtFileNode">[docs]</a><span class="k">def</span> <span class="nf">getLanguageFromAncestorAtFileNode</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Return the language in effect as determined</span>
<span class="sd">    by the file extension of the nearest enclosing @&lt;file&gt; node.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">self_and_parents</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">isAnyAtFileNode</span><span class="p">():</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">anyAtFileNodeName</span><span class="p">()</span>
            <span class="n">junk</span><span class="p">,</span><span class="n">ext</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_splitext</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="n">ext</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="c"># strip the leading .</span>
            <span class="n">language</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">extension_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>

            <span class="c"># g.trace(&#39;found extension&#39;,p.h,ext,language)</span>
            <span class="k">return</span> <span class="n">language</span>

    <span class="k">return</span> <span class="bp">None</span>
<span class="c">#@+node:ekr.20031218072017.1386: *4* g.getOutputNewline</span></div>
<div class="viewcode-block" id="getOutputNewline"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.getOutputNewline">[docs]</a><span class="k">def</span> <span class="nf">getOutputNewline</span> <span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Convert the name of a line ending to the line ending itself.</span>

<span class="sd">    Priority:</span>
<span class="sd">    - Use name if name given</span>
<span class="sd">    - Use c.config.output_newline if c given,</span>
<span class="sd">    - Otherwise use g.app.config.output_newline.&#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">name</span><span class="p">:</span> <span class="n">s</span> <span class="o">=</span> <span class="n">name</span>
    <span class="k">elif</span> <span class="n">c</span><span class="p">:</span>  <span class="n">s</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">output_newline</span>
    <span class="k">else</span><span class="p">:</span>    <span class="n">s</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">output_newline</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span> <span class="s">&quot;nl&quot;</span><span class="p">,</span><span class="s">&quot;lf&quot;</span><span class="p">):</span> <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
    <span class="k">elif</span> <span class="n">s</span> <span class="o">==</span> <span class="s">&quot;cr&quot;</span><span class="p">:</span> <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\r</span><span class="s">&#39;</span>
    <span class="k">elif</span> <span class="n">s</span> <span class="o">==</span> <span class="s">&quot;platform&quot;</span><span class="p">:</span> <span class="n">s</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span>  <span class="c"># 12/2/03: emakital</span>
    <span class="k">elif</span> <span class="n">s</span> <span class="o">==</span> <span class="s">&quot;crlf&quot;</span><span class="p">:</span> <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="c"># Default for erroneous values.</span>
    <span class="c"># g.trace(c,name,c.config.output_newline,&#39;returns&#39;,repr(s))</span>

    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span>
<span class="c">#@+node:ekr.20080827175609.52: *4* g.scanAtCommentAndLanguageDirectives</span></div>
<div class="viewcode-block" id="scanAtCommentAndAtLanguageDirectives"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.scanAtCommentAndAtLanguageDirectives">[docs]</a><span class="k">def</span> <span class="nf">scanAtCommentAndAtLanguageDirectives</span><span class="p">(</span><span class="n">aList</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Scan aList for @comment and @language directives.</span>

<span class="sd">    @comment should follow @language if both appear in the same node.&#39;&#39;&#39;</span>

    <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
    <span class="n">lang</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>

        <span class="n">comment</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;comment&#39;</span><span class="p">)</span>
        <span class="n">language</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;language&#39;</span><span class="p">)</span>

        <span class="c"># Important: assume @comment follows @language.</span>
        <span class="k">if</span> <span class="n">language</span><span class="p">:</span>
            <span class="c"># if g.unitTesting: g.trace(&#39;language&#39;,language)</span>
            <span class="n">lang</span><span class="p">,</span><span class="n">delim1</span><span class="p">,</span><span class="n">delim2</span><span class="p">,</span><span class="n">delim3</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">set_language</span><span class="p">(</span><span class="n">language</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">comment</span><span class="p">:</span>
            <span class="c"># if g.unitTesting: g.trace(&#39;comment&#39;,comment)</span>
            <span class="n">delim1</span><span class="p">,</span><span class="n">delim2</span><span class="p">,</span><span class="n">delim3</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">set_delims_from_string</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">comment</span> <span class="ow">or</span> <span class="n">language</span><span class="p">:</span>
            <span class="n">delims</span> <span class="o">=</span> <span class="n">delim1</span><span class="p">,</span><span class="n">delim2</span><span class="p">,</span><span class="n">delim3</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;language&#39;</span><span class="p">:</span><span class="n">lang</span><span class="p">,</span><span class="s">&#39;comment&#39;</span><span class="p">:</span><span class="n">comment</span><span class="p">,</span><span class="s">&#39;delims&#39;</span><span class="p">:</span><span class="n">delims</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">d</span>

    <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">None</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">None</span>
<span class="c">#@+node:ekr.20080827175609.32: *4* g.scanAtEncodingDirectives</span></div>
<div class="viewcode-block" id="scanAtEncodingDirectives"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.scanAtEncodingDirectives">[docs]</a><span class="k">def</span> <span class="nf">scanAtEncodingDirectives</span><span class="p">(</span><span class="n">aList</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Scan aList for @encoding directives.&#39;&#39;&#39;</span>

    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
        <span class="n">encoding</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;encoding&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">encoding</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">isValidEncoding</span><span class="p">(</span><span class="n">encoding</span><span class="p">):</span>
            <span class="c"># g.trace(encoding)</span>
            <span class="k">return</span> <span class="n">encoding</span>
        <span class="k">elif</span> <span class="n">encoding</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;invalid @encoding:&quot;</span><span class="p">,</span><span class="n">encoding</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">None</span>
<span class="c">#@+node:ekr.20080827175609.53: *4* g.scanAtHeaderDirectives</span></div>
<div class="viewcode-block" id="scanAtHeaderDirectives"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.scanAtHeaderDirectives">[docs]</a><span class="k">def</span> <span class="nf">scanAtHeaderDirectives</span><span class="p">(</span><span class="n">aList</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;scan aList for @header and @noheader directives.&#39;&#39;&#39;</span>

    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;header&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;noheader&#39;</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;conflicting @header and @noheader directives&quot;</span><span class="p">)</span>
<span class="c">#@+node:ekr.20080827175609.33: *4* g.scanAtLineendingDirectives</span></div>
<div class="viewcode-block" id="scanAtLineendingDirectives"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.scanAtLineendingDirectives">[docs]</a><span class="k">def</span> <span class="nf">scanAtLineendingDirectives</span><span class="p">(</span><span class="n">aList</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Scan aList for @lineending directives.&#39;&#39;&#39;</span>

    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>

        <span class="n">e</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;lineending&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">e</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;cr&quot;</span><span class="p">,</span><span class="s">&quot;crlf&quot;</span><span class="p">,</span><span class="s">&quot;lf&quot;</span><span class="p">,</span><span class="s">&quot;nl&quot;</span><span class="p">,</span><span class="s">&quot;platform&quot;</span><span class="p">):</span>
            <span class="n">lineending</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">getOutputNewline</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">lineending</span>
        <span class="c"># else:</span>
            <span class="c"># g.error(&quot;invalid @lineending directive:&quot;,e)</span>

    <span class="k">return</span> <span class="bp">None</span>
<span class="c">#@+node:ekr.20080827175609.34: *4* g.scanAtPagewidthDirectives</span></div>
<div class="viewcode-block" id="scanAtPagewidthDirectives"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.scanAtPagewidthDirectives">[docs]</a><span class="k">def</span> <span class="nf">scanAtPagewidthDirectives</span><span class="p">(</span><span class="n">aList</span><span class="p">,</span><span class="n">issue_error_flag</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Scan aList for @pagewidth directives.&#39;&#39;&#39;</span>

    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;pagewidth&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_long</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c"># g.trace(val)</span>
                <span class="k">return</span> <span class="n">val</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">issue_error_flag</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;ignoring @pagewidth&quot;</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">None</span>
<span class="c">#@+node:ekr.20101022172109.6108: *4* g.scanAtPathDirectives scanAllAtPathDirectives</span></div>
<div class="viewcode-block" id="scanAtPathDirectives"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.scanAtPathDirectives">[docs]</a><span class="k">def</span> <span class="nf">scanAtPathDirectives</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">aList</span><span class="p">):</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">scanAtPathDirectives</span><span class="p">(</span><span class="n">aList</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">path</span>
</div>
<div class="viewcode-block" id="scanAllAtPathDirectives"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.scanAllAtPathDirectives">[docs]</a><span class="k">def</span> <span class="nf">scanAllAtPathDirectives</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

    <span class="n">aList</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_directives_dict_list</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">scanAtPathDirectives</span><span class="p">(</span><span class="n">aList</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">path</span>
<span class="c">#@+node:ekr.20100507084415.5760: *4* g.scanAtRootDirectives</span></div>
<div class="viewcode-block" id="scanAtRootDirectives"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.scanAtRootDirectives">[docs]</a><span class="k">def</span> <span class="nf">scanAtRootDirectives</span><span class="p">(</span><span class="n">aList</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Scan aList for @root directives.&#39;&#39;&#39;</span>

    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;root&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">scanAtRootOptions</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">mode</span>

    <span class="k">return</span> <span class="bp">None</span>
<span class="c">#@+node:ekr.20031218072017.3154: *4* g.scanAtRootOptions</span></div>
<div class="viewcode-block" id="scanAtRootOptions"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.scanAtRootOptions">[docs]</a><span class="k">def</span> <span class="nf">scanAtRootOptions</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">err_flag</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="c"># The @root has been eaten when called from tangle.scanAllDirectives.</span>
    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;@root&quot;</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="s">&quot;@root&quot;</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>

    <span class="n">mode</span> <span class="o">=</span> <span class="bp">None</span> 
    <span class="k">while</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;-&#39;</span><span class="p">):</span>
        <span class="c">#@+&lt;&lt; scan another @root option &gt;&gt;</span>
        <span class="c">#@+node:ekr.20031218072017.3155: *5* &lt;&lt; scan another @root option &gt;&gt;</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span> <span class="p">;</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;code&quot;</span><span class="p">):</span> <span class="c"># Just match the prefix.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mode</span><span class="p">:</span> <span class="n">mode</span> <span class="o">=</span> <span class="s">&quot;code&quot;</span>
            <span class="k">elif</span> <span class="n">err_flag</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;modes conflict in:&quot;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">get_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;doc&quot;</span><span class="p">):</span> <span class="c"># Just match the prefix.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">mode</span><span class="p">:</span> <span class="n">mode</span> <span class="o">=</span> <span class="s">&quot;doc&quot;</span>
            <span class="k">elif</span> <span class="n">err_flag</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;modes conflict in:&quot;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">get_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span>

        <span class="c"># Scan to the next minus sign.</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;-&#39;</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">err</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">err_flag</span><span class="p">:</span>
            <span class="n">z_opt</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">err</span><span class="p">:</span><span class="n">i</span><span class="p">]</span>
            <span class="n">z_line</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;unknown option:&quot;</span><span class="p">,</span><span class="n">z_opt</span><span class="p">,</span><span class="s">&quot;in&quot;</span><span class="p">,</span><span class="n">z_line</span><span class="p">)</span>
        <span class="c">#@-&lt;&lt; scan another @root option &gt;&gt;</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">at_root_bodies_start_in_doc_mode</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span><span class="s">&quot;doc&quot;</span><span class="p">,</span><span class="s">&quot;code&quot;</span><span class="p">)</span>

    <span class="c"># g.trace(mode,g.callers(3))</span>

    <span class="k">return</span> <span class="n">i</span><span class="p">,</span><span class="n">mode</span>
<span class="c">#@+node:ekr.20080827175609.37: *4* g.scanAtTabwidthDirectives &amp; scanAllTabWidthDirectives</span></div>
<div class="viewcode-block" id="scanAtTabwidthDirectives"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.scanAtTabwidthDirectives">[docs]</a><span class="k">def</span> <span class="nf">scanAtTabwidthDirectives</span><span class="p">(</span><span class="n">aList</span><span class="p">,</span><span class="n">issue_error_flag</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Scan aList for @tabwidth directives.&#39;&#39;&#39;</span>

    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;tabwidth&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">junk</span><span class="p">,</span><span class="n">val</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_long</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">val</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">issue_error_flag</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;ignoring @tabwidth&quot;</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="scanAllAtTabWidthDirectives"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.scanAllAtTabWidthDirectives">[docs]</a><span class="k">def</span> <span class="nf">scanAllAtTabWidthDirectives</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Scan p and all ancestors looking for @tabwidth directives.&#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">c</span> <span class="ow">and</span> <span class="n">p</span><span class="p">:</span>
        <span class="n">aList</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_directives_dict_list</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">scanAtTabwidthDirectives</span><span class="p">(</span><span class="n">aList</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">val</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">tab_width</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c"># g.trace(ret,p and p.h,ret)</span>
    <span class="k">return</span> <span class="n">ret</span>
<span class="c">#@+node:ekr.20080831084419.4: *4* g.scanAtWrapDirectives &amp; scanAllAtWrapDirectives</span></div>
<div class="viewcode-block" id="scanAtWrapDirectives"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.scanAtWrapDirectives">[docs]</a><span class="k">def</span> <span class="nf">scanAtWrapDirectives</span><span class="p">(</span><span class="n">aList</span><span class="p">,</span><span class="n">issue_error_flag</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Scan aList for @wrap and @nowrap directives.&#39;&#39;&#39;</span>

    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;wrap&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;nowrap&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="scanAllAtWrapDirectives"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.scanAllAtWrapDirectives">[docs]</a><span class="k">def</span> <span class="nf">scanAllAtWrapDirectives</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Scan p and all ancestors looking for @wrap/@nowrap directives.&#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">c</span> <span class="ow">and</span> <span class="n">p</span><span class="p">:</span>
        <span class="n">default</span> <span class="o">=</span> <span class="n">c</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getBool</span><span class="p">(</span><span class="s">&quot;body_pane_wraps&quot;</span><span class="p">)</span>
        <span class="n">aList</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_directives_dict_list</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="n">val</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">scanAtWrapDirectives</span><span class="p">(</span><span class="n">aList</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">val</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">,</span><span class="n">default</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c"># g.trace(ret,p.h)</span>
    <span class="k">return</span> <span class="n">ret</span>
<span class="c">#@+node:ekr.20080901195858.4: *4* g.scanDirectives  (for compatibility only)</span></div>
<div class="viewcode-block" id="scanDirectives"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.scanDirectives">[docs]</a><span class="k">def</span> <span class="nf">scanDirectives</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">scanAllDirectives</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="c">#@+node:ekr.20040715155607: *4* g.scanForAtIgnore</span></div>
<div class="viewcode-block" id="scanForAtIgnore"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.scanForAtIgnore">[docs]</a><span class="k">def</span> <span class="nf">scanForAtIgnore</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Scan position p and its ancestors looking for @ignore directives.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span> <span class="c"># For unit tests.</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">self_and_parents</span><span class="p">():</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_directives_dict</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;ignore&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>

    <span class="k">return</span> <span class="bp">False</span>
<span class="c">#@+node:ekr.20040712084911.1: *4* g.scanForAtLanguage</span></div>
<div class="viewcode-block" id="scanForAtLanguage"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.scanForAtLanguage">[docs]</a><span class="k">def</span> <span class="nf">scanForAtLanguage</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Scan position p and p&#39;s ancestors looking only for @language and @ignore directives.</span>

<span class="sd">    Returns the language found, or c.target_language.&quot;&quot;&quot;</span>

    <span class="c"># Unlike the code in x.scanAllDirectives, this code ignores @comment directives.</span>

    <span class="k">if</span> <span class="n">c</span> <span class="ow">and</span> <span class="n">p</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">self_and_parents</span><span class="p">():</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_directives_dict</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;language&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s">&quot;language&quot;</span><span class="p">]</span>
                <span class="n">language</span><span class="p">,</span><span class="n">delim1</span><span class="p">,</span><span class="n">delim2</span><span class="p">,</span><span class="n">delim3</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">set_language</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">language</span>

    <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">target_language</span>
<span class="c">#@+node:ekr.20041123094807: *4* g.scanForAtSettings</span></div>
<div class="viewcode-block" id="scanForAtSettings"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.scanForAtSettings">[docs]</a><span class="k">def</span> <span class="nf">scanForAtSettings</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Scan position p and its ancestors looking for @settings nodes.&quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">self_and_parents</span><span class="p">():</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">canonicalizeSettingName</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;@settings&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>

    <span class="k">return</span> <span class="bp">False</span>
<span class="c">#@+node:ekr.20031218072017.1382: *4* g.set_delims_from_language</span>
<span class="c"># Returns a tuple (single,start,end) of comment delims</span>
</div>
<div class="viewcode-block" id="set_delims_from_language"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.set_delims_from_language">[docs]</a><span class="k">def</span> <span class="nf">set_delims_from_language</span><span class="p">(</span><span class="n">language</span><span class="p">):</span>

    <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

    <span class="n">val</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">language_delims_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">language</span><span class="p">)</span>
    <span class="c"># if language.startswith(&#39;huh&#39;): g.pdb()</span>

    <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
        <span class="n">delim1</span><span class="p">,</span><span class="n">delim2</span><span class="p">,</span><span class="n">delim3</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">set_delims_from_string</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">language</span><span class="p">),</span>
            <span class="nb">repr</span><span class="p">(</span><span class="n">delim1</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">delim2</span><span class="p">),</span><span class="nb">repr</span><span class="p">(</span><span class="n">delim3</span><span class="p">),</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">delim2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">delim3</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">delim1</span><span class="p">,</span><span class="n">delim2</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># 0,1 or 3 params.</span>
            <span class="k">return</span> <span class="n">delim1</span><span class="p">,</span><span class="n">delim2</span><span class="p">,</span><span class="n">delim3</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span> <span class="c"># Indicate that no change should be made</span>
<span class="c">#@+node:ekr.20031218072017.1383: *4* g.set_delims_from_string</span></div>
<div class="viewcode-block" id="set_delims_from_string"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.set_delims_from_string">[docs]</a><span class="k">def</span> <span class="nf">set_delims_from_string</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Returns (delim1, delim2, delim2), the delims following the @comment directive.</span>

<span class="sd">    This code can be called from @language logic, in which case s can point at @comment&quot;&quot;&quot;</span>

    <span class="c"># Skip an optional @comment</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="s">&quot;@comment&quot;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">tag</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>

    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">delims</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">]</span>
    <span class="k">while</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">is_ws</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">is_nl</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">i</span><span class="p">:</span> <span class="k">break</span>
        <span class="n">delims</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">i</span><span class="p">]</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c"># &#39;rr 09/25/02</span>
    <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="c"># delims[0] is always the single-line delim.</span>
        <span class="n">delims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">delims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">delims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">delims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">delims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

    <span class="c"># 7/8/02: The &quot;REM hack&quot;: replace underscores by blanks.</span>
    <span class="c"># 9/25/02: The &quot;perlpod hack&quot;: replace double underscores by newlines.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">delims</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">delims</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">delims</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;__&quot;</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">,</span><span class="s">&#39; &#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">delims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">delims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">delims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="c">#@+node:ekr.20031218072017.1384: *4* g.set_language</span></div>
<div class="viewcode-block" id="set_language"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.set_language">[docs]</a><span class="k">def</span> <span class="nf">set_language</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">issue_errors_flag</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Scan the @language directive that appears at s[i:].</span>

<span class="sd">    The @language may have been stripped away.</span>

<span class="sd">    Returns (language, delim1, delim2, delim3)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">tag</span> <span class="o">=</span> <span class="s">&quot;@language&quot;</span>
    <span class="c"># g.trace(g.get_line(s,i))</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">)</span>
    <span class="c"># assert(g.match_word(s,i,tag))</span>
    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">tag</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
    <span class="c"># Get the argument.</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_c_id</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
    <span class="c"># Allow tcl/tk.</span>
    <span class="n">arg</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">language_delims_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
        <span class="n">language</span> <span class="o">=</span> <span class="n">arg</span>
        <span class="n">delim1</span><span class="p">,</span> <span class="n">delim2</span><span class="p">,</span> <span class="n">delim3</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">set_delims_from_language</span><span class="p">(</span><span class="n">language</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">language</span><span class="p">,</span> <span class="n">delim1</span><span class="p">,</span> <span class="n">delim2</span><span class="p">,</span> <span class="n">delim3</span>

    <span class="k">if</span> <span class="n">issue_errors_flag</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;ignoring:&quot;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">get_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">))</span>

    <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
<span class="c">#@+node:ekr.20081001062423.9: *4* g.setDefaultDirectory &amp; helper</span></div>
<div class="viewcode-block" id="setDefaultDirectory"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.setDefaultDirectory">[docs]</a><span class="k">def</span> <span class="nf">setDefaultDirectory</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">importing</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39; Return a default directory by scanning @path directives.&#39;&#39;&#39;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">anyAtFileNodeName</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
        <span class="c"># An absolute path overrides everything.</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_dirname</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">d</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_isabs</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">d</span>

    <span class="n">aList</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_directives_dict_list</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">scanAtPathDirectives</span><span class="p">(</span><span class="n">aList</span><span class="p">)</span>
        <span class="c"># Returns g.getBaseDirectory(c) by default.</span>
        <span class="c"># However, g.getBaseDirectory can return &#39;&#39;</span>
    <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">checkOpenDirectory</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">openDirectory</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">getBaseDirectory</span><span class="p">(</span><span class="n">c</span><span class="p">)):</span>
            <span class="c"># Errors may result in relative or invalid path.</span>
            <span class="k">if</span> <span class="n">d</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_isabs</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">d</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">importing</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
        <span class="c"># This should never happen, but is not serious if it does.</span>
        <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;No absolute directory specified anywhere.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">path</span>
<span class="c">#@+node:ekr.20101022124309.6132: *5* g.checkOpenDirectory</span></div>
<div class="viewcode-block" id="checkOpenDirectory"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.checkOpenDirectory">[docs]</a><span class="k">def</span> <span class="nf">checkOpenDirectory</span> <span class="p">(</span><span class="n">c</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">openDirectory</span> <span class="o">!=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">openDirectory</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="s">&#39;Error: c.openDirectory != c.frame.openDirectory</span><span class="se">\n</span><span class="s">&#39;</span>
            <span class="s">&#39;c.openDirectory: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span>
            <span class="s">&#39;c.frame.openDirectory: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">c</span><span class="o">.</span><span class="n">openDirectory</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">openDirectory</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_isabs</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">openDirectory</span><span class="p">):</span>
        <span class="n">g</span><span class="o">.</span><span class="n">error</span> <span class="p">(</span><span class="s">&#39;Error: relative c.openDirectory: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">c</span><span class="o">.</span><span class="n">openDirectory</span><span class="p">))</span>
<span class="c">#@+node:ekr.20071109165315: *4* g.stripPathCruft</span></div>
<div class="viewcode-block" id="stripPathCruft"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.stripPathCruft">[docs]</a><span class="k">def</span> <span class="nf">stripPathCruft</span> <span class="p">(</span><span class="n">path</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Strip cruft from a path name.&#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">path</span> <span class="c"># Retain empty paths for warnings.</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;&lt;&#39;</span> <span class="ow">and</span> <span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;&gt;&#39;</span><span class="p">)</span> <span class="ow">or</span>
        <span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;&quot;&#39;</span> <span class="ow">and</span> <span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;&quot;&#39;</span><span class="p">)</span> <span class="ow">or</span>
        <span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s">&quot;&#39;&quot;</span> <span class="ow">and</span> <span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;&#39;&quot;</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="c"># We want a *relative* path, not an absolute path.</span>
    <span class="k">return</span> <span class="n">path</span>
<span class="c">#@+node:ekr.20031218072017.3104: ** Debugging, Dumping, Timing, Tracing &amp; Sherlock</span>
<span class="c">#@+node:ekr.20051023083258: *3* callers &amp; _callerName</span></div>
<div class="viewcode-block" id="callers"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.callers">[docs]</a><span class="k">def</span> <span class="nf">callers</span> <span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">count</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">excludeCaller</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">files</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Return a list containing the callers of the function that called g.callerList.</span>

<span class="sd">    If the excludeCaller keyword is True (the default), g.callers is not on the list.</span>

<span class="sd">    If the files keyword argument is True, filenames are included in the list.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c"># sys._getframe throws ValueError in both cpython and jython if there are less than i entries.</span>
    <span class="c"># The jython stack often has less than 8 entries,</span>
    <span class="c"># so we must be careful to call g._callerName with smaller values of i first.</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">3</span> <span class="k">if</span> <span class="n">excludeCaller</span> <span class="k">else</span> <span class="mi">2</span>
    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">_callerName</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">)</span>
        <span class="c"># print(i,s)</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">:</span> <span class="k">break</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">result</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[:</span><span class="n">count</span><span class="p">]</span>
    <span class="n">sep</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="k">if</span> <span class="n">files</span> <span class="k">else</span> <span class="s">&#39;,&#39;</span>
    <span class="k">return</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="c">#@+node:ekr.20031218072017.3107: *4* _callerName</span></div>
<span class="k">def</span> <span class="nf">_callerName</span> <span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">files</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="c"># print(&#39;_callerName: %s %s&#39; % (n,files))</span>

    <span class="k">try</span><span class="p">:</span> <span class="c"># get the function name from the call stack.</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="c"># The stack frame, n levels up.</span>
        <span class="n">code1</span> <span class="o">=</span> <span class="n">f1</span><span class="o">.</span><span class="n">f_code</span> <span class="c"># The code object</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">code1</span><span class="o">.</span><span class="n">co_name</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;__init__&#39;</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;__init__(</span><span class="si">%s</span><span class="s">,line </span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">shortFileName</span><span class="p">(</span><span class="n">code1</span><span class="o">.</span><span class="n">co_filename</span><span class="p">),</span><span class="n">code1</span><span class="o">.</span><span class="n">co_firstlineno</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">shortFilename</span><span class="p">(</span><span class="n">code1</span><span class="o">.</span><span class="n">co_filename</span><span class="p">),</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">name</span> <span class="c"># The code name</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;ValueError&#39;</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span> <span class="c"># The stack is not deep enough.</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">es_exception</span><span class="p">()</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span> <span class="c"># &quot;&lt;no caller name&gt;&quot;</span>
<span class="c">#@+node:ekr.20121128031949.12605: *3* class SherlockTracer</span>
<div class="viewcode-block" id="SherlockTracer"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.SherlockTracer">[docs]</a><span class="k">class</span> <span class="nc">SherlockTracer</span><span class="p">:</span>

    <span class="sd">&#39;&#39;&#39;A stand-alone tracer class with many of Sherlock&#39;s features.</span>

<span class="sd">    This class should work in any environment in which it is possible</span>
<span class="sd">    to import os and sys.&#39;&#39;&#39;</span>

    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20121128031949.12602: *4* __init__</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">patterns</span><span class="p">,</span><span class="n">dots</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">show_args</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">show_return</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

        <span class="kn">import</span> <span class="nn">re</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bad_patterns</span> <span class="o">=</span> <span class="p">[]</span>          <span class="c"># List of bad patterns.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dots</span> <span class="o">=</span> <span class="n">dots</span>                <span class="c"># True: print level dots.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>                      <span class="c"># The frame level on entry to run.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span> <span class="o">=</span> <span class="p">{}</span>                 <span class="c"># Keys are full file names, values are dicts.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patterns</span> <span class="o">=</span> <span class="n">patterns</span>        <span class="c"># A list of regex patterns to match.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">re</span> <span class="o">=</span> <span class="n">re</span>                    <span class="c"># Import re only once.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_args</span> <span class="o">=</span> <span class="n">show_args</span>      <span class="c"># True: show args for each function call.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_return</span> <span class="o">=</span> <span class="n">show_return</span>  <span class="c"># True: show returns from each function.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>          <span class="c"># True: print filename:func</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">PyQt4</span> <span class="kn">import</span> <span class="n">QtCore</span>
            <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtRemoveInputHook</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="c">#@+node:ekr.20121128031949.12609: *4* dispatch</span>
<div class="viewcode-block" id="SherlockTracer.dispatch"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.SherlockTracer.dispatch">[docs]</a>    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">frame</span><span class="p">,</span><span class="n">event</span><span class="p">,</span><span class="n">arg</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s">&#39;call&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_call</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="n">arg</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="s">&#39;return&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_return</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">do_return</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="n">arg</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span>
    <span class="c">#@+node:ekr.20121128031949.12603: *4* do_call &amp; helper</span></div>
<div class="viewcode-block" id="SherlockTracer.do_call"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.SherlockTracer.do_call">[docs]</a>    <span class="k">def</span> <span class="nf">do_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">frame</span><span class="p">,</span><span class="n">arg</span><span class="p">):</span> <span class="c"># arg not used.</span>

        <span class="kn">import</span> <span class="nn">os</span>
        <span class="n">frame1</span> <span class="o">=</span> <span class="n">frame</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span>
        <span class="n">fn</span>   <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">co_filename</span>
        <span class="n">locals_</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">co_name</span>
        <span class="n">full_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_name</span><span class="p">(</span><span class="n">locals_</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_enabled</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">patterns</span><span class="p">)</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_enabled</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">full_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">patterns</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">frame</span><span class="p">:</span>
                <span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_back</span>
                <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c"># g_callers = &#39;,&#39;.join(self.g.callers(5).split(&#39;,&#39;)[:-1])</span>
            <span class="n">dots</span>   <span class="o">=</span> <span class="s">&#39;.&#39;</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dots</span> <span class="k">else</span> <span class="s">&#39;&#39;</span>
            <span class="n">path</span>   <span class="o">=</span> <span class="s">&#39;</span><span class="si">%-20s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="k">else</span> <span class="s">&#39;&#39;</span>
            <span class="n">leadin</span> <span class="o">=</span> <span class="s">&#39;+&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_return</span> <span class="k">else</span> <span class="s">&#39;&#39;</span>
            <span class="n">args</span> <span class="o">=</span> <span class="s">&#39;(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_args</span><span class="p">(</span><span class="n">frame1</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_args</span> <span class="k">else</span> <span class="s">&#39;&#39;</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s%s%s%s%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">dots</span><span class="p">,</span><span class="n">leadin</span><span class="p">,</span><span class="n">full_name</span><span class="p">,</span><span class="n">args</span><span class="p">))</span>

        <span class="c"># Alwas update stats.</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fn</span><span class="p">,{})</span>
        <span class="n">d</span><span class="p">[</span><span class="n">full_name</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">full_name</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="n">fn</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
    <span class="c">#@+node:ekr.20130111185820.10194: *5* get_args</span></div>
<div class="viewcode-block" id="SherlockTracer.get_args"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.SherlockTracer.get_args">[docs]</a>    <span class="k">def</span> <span class="nf">get_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">frame</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#39;&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">item</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span>
        <span class="n">locals_</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">co_name</span>
        <span class="c"># fn = code.co_filename</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">co_argcount</span>
        <span class="k">if</span> <span class="n">code</span><span class="o">.</span><span class="n">co_flags</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">:</span> <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">code</span><span class="o">.</span><span class="n">co_flags</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">:</span> <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="s">&#39;self&#39;</span><span class="p">:</span>
                <span class="n">arg</span> <span class="o">=</span> <span class="n">locals_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="s">&#39;*undefined*&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">arg</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,(</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">)):</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="s">&#39;[</span><span class="si">%s</span><span class="s">]&#39;</span> <span class="o">%</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">show</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">arg</span> <span class="k">if</span> <span class="n">show</span><span class="p">(</span><span class="n">z</span><span class="p">)])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="n">show</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">val</span><span class="p">))</span>
        <span class="k">return</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20130109154743.10172: *4* do_return &amp; helper</span></div>
<div class="viewcode-block" id="SherlockTracer.do_return"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.SherlockTracer.do_return">[docs]</a>    <span class="k">def</span> <span class="nf">do_return</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">frame</span><span class="p">,</span><span class="n">arg</span><span class="p">):</span> <span class="c"># arg not used.</span>

        <span class="kn">import</span> <span class="nn">os</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">co_filename</span>
        <span class="n">locals_</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">co_name</span>
        <span class="n">full_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_full_name</span><span class="p">(</span><span class="n">locals_</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_enabled</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">patterns</span><span class="p">)</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_enabled</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">full_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">patterns</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">frame</span><span class="p">:</span>
                <span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_back</span>
                <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">dots</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dots</span> <span class="k">else</span> <span class="s">&#39;&#39;</span>
            <span class="n">path</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%-20s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="k">else</span> <span class="s">&#39;&#39;</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_ret</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s%s</span><span class="s">-</span><span class="si">%s%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">dots</span><span class="p">,</span><span class="n">full_name</span><span class="p">,</span><span class="n">ret</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20130111120935.10192: *5* format_ret</span></div>
<div class="viewcode-block" id="SherlockTracer.format_ret"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.SherlockTracer.format_ret">[docs]</a>    <span class="k">def</span> <span class="nf">format_ret</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">arg</span><span class="p">):</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,(</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">list</span><span class="p">)):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="s">&#39; -&gt; [</span><span class="si">%s</span><span class="s">]&#39;</span> <span class="o">%</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">z</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="s">&#39; -&gt; [</span><span class="si">%s</span><span class="s">]&#39;</span> <span class="o">%</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">repr</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">40</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">ret</span> <span class="o">=</span> <span class="s">&#39; -&gt; [</span><span class="se">\n</span><span class="si">%s</span><span class="s">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">z</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">]))</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">ret</span> <span class="o">=</span> <span class="s">&#39; -&gt; [</span><span class="se">\n</span><span class="si">%s</span><span class="s">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">repr</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="n">arg</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="s">&#39; -&gt; </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">arg</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="s">&#39; -&gt; </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">arg</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">40</span><span class="p">:</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="s">&#39; -&gt;</span><span class="se">\n</span><span class="s">    </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">arg</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">exctype</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[:</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&lt;**exception: </span><span class="si">%s</span><span class="s">,</span><span class="si">%s</span><span class="s"> arg: </span><span class="si">%r</span><span class="s">**&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">exctype</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span><span class="n">arg</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="s">&#39; -&gt;</span><span class="se">\n</span><span class="s">    </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">40</span> <span class="k">else</span> <span class="s">&#39; -&gt; </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ret</span>
    <span class="c">#@+node:ekr.20121128111829.12185: *4* fn_is_enabled</span></div>
<div class="viewcode-block" id="SherlockTracer.fn_is_enabled"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.SherlockTracer.fn_is_enabled">[docs]</a>    <span class="k">def</span> <span class="nf">fn_is_enabled</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span><span class="n">patterns</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return True if tracing for fn is enabled.&#39;&#39;&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">enabled</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;+:&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span><span class="n">fn</span><span class="p">):</span> 
                        <span class="n">enabled</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">elif</span> <span class="n">pattern</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;-:&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span><span class="n">fn</span><span class="p">):</span>
                        <span class="n">enabled</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">return</span> <span class="n">enabled</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="c">#@+node:ekr.20130112093655.10195: *4* get_full_name</span></div>
<div class="viewcode-block" id="SherlockTracer.get_full_name"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.SherlockTracer.get_full_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_full_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">locals_</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>

        <span class="n">full_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user_self</span> <span class="o">=</span> <span class="n">locals_</span> <span class="ow">and</span> <span class="n">locals_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;self&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">user_self</span><span class="p">:</span>
                <span class="n">full_name</span> <span class="o">=</span> <span class="n">user_self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span> <span class="o">+</span> <span class="s">&#39;::&#39;</span> <span class="o">+</span> <span class="n">name</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">full_name</span>
    <span class="c">#@+node:ekr.20121128111829.12183: *4* is_enabled</span></div>
<div class="viewcode-block" id="SherlockTracer.is_enabled"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.SherlockTracer.is_enabled">[docs]</a>    <span class="k">def</span> <span class="nf">is_enabled</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fn</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">patterns</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return True if tracing for name in fn is enabled.&#39;&#39;&#39;</span>

        <span class="k">def</span> <span class="nf">oops</span><span class="p">(</span><span class="n">pattern</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pattern</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bad_patterns</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bad_patterns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;ignoring bad pattern: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">pattern</span><span class="p">)</span>

        <span class="n">enabled</span> <span class="o">=</span> <span class="bp">False</span> 
        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;+:&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span><span class="n">fn</span><span class="p">):</span> 
                        <span class="n">enabled</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">elif</span> <span class="n">pattern</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;-:&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span><span class="n">fn</span><span class="p">):</span>
                        <span class="n">enabled</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">elif</span> <span class="n">pattern</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;+&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="n">name</span><span class="p">):</span>
                        <span class="n">enabled</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">elif</span> <span class="n">pattern</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="n">name</span><span class="p">):</span>
                        <span class="n">enabled</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">oops</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">oops</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">enabled</span>

    <span class="c">#@+node:ekr.20121128111829.12182: *4* print_stats</span></div>
<div class="viewcode-block" id="SherlockTracer.print_stats"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.SherlockTracer.print_stats">[docs]</a>    <span class="k">def</span> <span class="nf">print_stats</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">patterns</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Sherlock statistics&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">patterns</span><span class="p">:</span> <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;+.*&#39;</span><span class="p">,</span><span class="s">&#39;+:.*&#39;</span><span class="p">,]</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn_is_enabled</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">patterns</span><span class="p">):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_enabled</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">patterns</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]))</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%4s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">),</span><span class="n">key</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20121128031949.12614: *4* run</span>
    <span class="c"># Modified from pdb.Pdb.set_trace.</span>
</div>
<div class="viewcode-block" id="SherlockTracer.run"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.SherlockTracer.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">frame</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Trace from the given frame or the caller&#39;s frame.&#39;&#39;&#39;</span>

        <span class="kn">import</span> <span class="nn">sys</span>

        <span class="k">if</span> <span class="n">frame</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_back</span>

        <span class="c"># Compute self.n, the number of frames to ignore.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">frame</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_back</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20121128093229.12616: *4* stop</span></div>
<div class="viewcode-block" id="SherlockTracer.stop"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.SherlockTracer.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Stop all tracing.&#39;&#39;&#39;</span>

        <span class="kn">import</span> <span class="nn">sys</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
    <span class="c">#@-others</span>
<span class="c">#@+node:ekr.20080531075119.1: *3* class Tracer &amp; g.startTracer</span></div></div>
<div class="viewcode-block" id="Tracer"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.Tracer">[docs]</a><span class="k">class</span> <span class="nc">Tracer</span><span class="p">:</span>

    <span class="sd">&#39;&#39;&#39;A &quot;debugger&quot; that computes a call graph.</span>

<span class="sd">    To trace a function and its callers, put the following at the function&#39;s start:</span>

<span class="sd">    g.startTracer()</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20080531075119.2: *4*  __init__ (Tracer)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">callDict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c"># Keys are function names.</span>
            <span class="c"># Values are the number of times the function was called by the caller.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calledDict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c"># Keys are function names.</span>
            <span class="c"># Values are the total number of times the function was called.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inited</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit</span> <span class="o">=</span> <span class="mi">2</span> <span class="c"># 0: no limit, otherwise, limit trace to n entries deep.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># True: print returns as well as calls.</span>
    <span class="c">#@+node:ekr.20080531075119.3: *4* computeName</span>
<div class="viewcode-block" id="Tracer.computeName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.Tracer.computeName">[docs]</a>    <span class="k">def</span> <span class="nf">computeName</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">frame</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">frame</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#39;&#39;</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_code</span> <span class="p">;</span> <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmodule</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">module</span><span class="p">:</span>
            <span class="n">module_name</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">__name__</span>
            <span class="k">if</span> <span class="n">module_name</span> <span class="o">==</span> <span class="s">&#39;leo.core.leoGlobals&#39;</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;g&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="s">&#39;leo.core.&#39;</span>
                <span class="k">if</span> <span class="n">module_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">tag</span><span class="p">):</span>
                    <span class="n">module_name</span> <span class="o">=</span> <span class="n">module_name</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">tag</span><span class="p">):]</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># This can fail during startup.</span>
            <span class="n">self_obj</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_locals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;self&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">self_obj</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">self_obj</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">co_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20080531075119.4: *4* report</span></div>
<div class="viewcode-block" id="Tracer.report"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.Tracer.report">[docs]</a>    <span class="k">def</span> <span class="nf">report</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">stack&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

        <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">callDict...&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callDict</span><span class="p">):</span>

            <span class="c"># Print the calling function.</span>
            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calledDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="mi">0</span><span class="p">)),</span><span class="n">key</span><span class="p">)</span>

            <span class="c"># Print the called functions.</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">callDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key2</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%8d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key2</span><span class="p">)),</span><span class="n">key2</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20080531075119.5: *4* stop</span></div>
<div class="viewcode-block" id="Tracer.stop"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.Tracer.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20080531075119.6: *4* tracer</span></div>
<div class="viewcode-block" id="Tracer.tracer"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.Tracer.tracer">[docs]</a>    <span class="k">def</span> <span class="nf">tracer</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;A function to be passed to sys.settrace.&#39;&#39;&#39;</span>

        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s">&#39;return&#39;</span><span class="p">:</span> <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pad</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span> <span class="o">*</span> <span class="n">n</span>

        <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s">&#39;call&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">inited</span><span class="p">:</span>
                <span class="c"># Add an extra stack element for the routine containing the call to startTracer.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inited</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computeName</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">f_back</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">updateStats</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">computeName</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit</span><span class="p">):</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">call&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pad</span><span class="p">),</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">updateStats</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracer</span>
        <span class="k">elif</span> <span class="n">event</span> <span class="o">==</span> <span class="s">&#39;return&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trace</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">limit</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">limit</span><span class="p">):</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">ret &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pad</span><span class="p">),</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;return underflow&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracer</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracer</span>
    <span class="c">#@+node:ekr.20080531075119.7: *4* updateStats</span></div>
<div class="viewcode-block" id="Tracer.updateStats"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.Tracer.updateStats">[docs]</a>    <span class="k">def</span> <span class="nf">updateStats</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">caller</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">callDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">caller</span><span class="p">,{})</span>
            <span class="c"># d is a dict reprenting the called functions.</span>
            <span class="c"># Keys are called functions, values are counts.</span>
        <span class="n">d</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callDict</span><span class="p">[</span><span class="n">caller</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>

        <span class="c"># Update the total counts.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calledDict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">calledDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="c">#@-others</span>
</div></div>
<div class="viewcode-block" id="startTracer"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.startTracer">[docs]</a><span class="k">def</span> <span class="nf">startTracer</span><span class="p">():</span>

    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">Tracer</span><span class="p">()</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">tracer</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">t</span>
<span class="c">#@+node:ekr.20031218072017.3108: *3* Dumps</span>
<span class="c">#@+node:ekr.20031218072017.3109: *4* dump</span></div>
<div class="viewcode-block" id="dump"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.dump">[docs]</a><span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>

    <span class="n">out</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span>
    <span class="k">return</span> <span class="n">out</span>
</div>
<div class="viewcode-block" id="oldDump"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.oldDump">[docs]</a><span class="k">def</span> <span class="nf">oldDump</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>

    <span class="n">out</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s">&quot;[&quot;</span> <span class="p">;</span> <span class="n">out</span> <span class="o">+=</span> <span class="s">&quot;n&quot;</span> <span class="p">;</span> <span class="n">out</span> <span class="o">+=</span> <span class="s">&quot;]&quot;</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s">&quot;[&quot;</span> <span class="p">;</span> <span class="n">out</span> <span class="o">+=</span> <span class="s">&quot;t&quot;</span> <span class="p">;</span> <span class="n">out</span> <span class="o">+=</span> <span class="s">&quot;]&quot;</span>
        <span class="k">elif</span> <span class="n">i</span><span class="o">==</span><span class="s">&#39; &#39;</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">+=</span> <span class="s">&quot;[&quot;</span> <span class="p">;</span> <span class="n">out</span> <span class="o">+=</span> <span class="s">&quot; &quot;</span> <span class="p">;</span> <span class="n">out</span> <span class="o">+=</span> <span class="s">&quot;]&quot;</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">out</span> <span class="o">+=</span> <span class="n">i</span>
    <span class="k">return</span> <span class="n">out</span>
<span class="c">#@+node:ekr.20060917120951: *4* es_dump</span></div>
<div class="viewcode-block" id="es_dump"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.es_dump">[docs]</a><span class="k">def</span> <span class="nf">es_dump</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">title</span><span class="p">)</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="n">aList</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&#39;</span><span class="si">%2x</span><span class="s"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">ch</span><span class="p">))</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">n</span><span class="p">]])</span>
        <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">aList</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="n">n</span>
<span class="c">#@+node:ekr.20031218072017.3110: *4* es_error &amp; es_print_error</span></div>
<div class="viewcode-block" id="es_error"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.es_error">[docs]</a><span class="k">def</span> <span class="nf">es_error</span> <span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">):</span>

    <span class="n">color</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;color&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
        <span class="n">keys</span><span class="p">[</span><span class="s">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getColor</span><span class="p">(</span><span class="s">&quot;log_error_color&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;red&#39;</span>

    <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="es_print_error"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.es_print_error">[docs]</a><span class="k">def</span> <span class="nf">es_print_error</span> <span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">):</span>

    <span class="n">color</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;color&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
        <span class="n">keys</span><span class="p">[</span><span class="s">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getColor</span><span class="p">(</span><span class="s">&quot;log_error_color&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;red&#39;</span>

    <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">)</span>
<span class="c">#@+node:ekr.20031218072017.3111: *4* es_event_exception</span></div>
<div class="viewcode-block" id="es_event_exception"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.es_event_exception">[docs]</a><span class="k">def</span> <span class="nf">es_event_exception</span> <span class="p">(</span><span class="n">eventName</span><span class="p">,</span><span class="n">full</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;exception handling &quot;</span><span class="p">,</span><span class="n">eventName</span><span class="p">,</span><span class="s">&quot;event&quot;</span><span class="p">)</span>
    <span class="n">typ</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">full</span><span class="p">:</span>
        <span class="n">errList</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">tb</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">errList</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception_only</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">errList</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">stdErrIsRedirected</span><span class="p">():</span> <span class="c"># 2/16/04</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
<span class="c">#@+node:ekr.20031218072017.3112: *4* es_exception</span></div>
<div class="viewcode-block" id="es_exception"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.es_exception">[docs]</a><span class="k">def</span> <span class="nf">es_exception</span> <span class="p">(</span><span class="n">full</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;red&quot;</span><span class="p">):</span>

    <span class="n">typ</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>

    <span class="c"># val is the second argument to the raise statement.</span>

    <span class="k">if</span> <span class="n">full</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">debugSwitch</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">tb</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception_only</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">es_print_error</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>

    <span class="c"># if g.app.debugSwitch &gt; 1:</span>
        <span class="c"># import pdb # Be careful: g.pdb may or may not have been defined.</span>
        <span class="c"># pdb.set_trace()</span>

    <span class="n">fileName</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">getLastTracebackFileAndLineNumber</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">fileName</span><span class="p">,</span><span class="n">n</span>
<span class="c">#@+node:ekr.20111107181638.9741: *4* es_print_exception</span></div>
<div class="viewcode-block" id="es_print_exception"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.es_print_exception">[docs]</a><span class="k">def</span> <span class="nf">es_print_exception</span> <span class="p">(</span><span class="n">full</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;red&quot;</span><span class="p">):</span>

    <span class="n">typ</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>

    <span class="c"># val is the second argument to the raise statement.</span>

    <span class="k">if</span> <span class="n">full</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">debugSwitch</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">tb</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception_only</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="n">fileName</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">getLastTracebackFileAndLineNumber</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">fileName</span><span class="p">,</span><span class="n">n</span>
<span class="c">#@+node:ekr.20061015090538: *4* es_exception_type</span></div>
<div class="viewcode-block" id="es_exception_type"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.es_exception_type">[docs]</a><span class="k">def</span> <span class="nf">es_exception_type</span> <span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">&quot;red&quot;</span><span class="p">):</span>

    <span class="c"># exctype is a Exception class object; value is the error message.</span>
    <span class="n">exctype</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[:</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">exctype</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">value</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
<span class="c">#@+node:ekr.20040731204831: *4* getLastTracebackFileAndLineNumber</span></div>
<div class="viewcode-block" id="getLastTracebackFileAndLineNumber"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.getLastTracebackFileAndLineNumber">[docs]</a><span class="k">def</span> <span class="nf">getLastTracebackFileAndLineNumber</span><span class="p">():</span>

    <span class="n">typ</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="ne">SyntaxError</span><span class="p">:</span>
        <span class="c"># IndentationError is a subclass of SyntaxError.</span>
        <span class="c"># Much easier in Python 2.6 and 3.x.</span>
        <span class="k">return</span> <span class="n">val</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span><span class="n">val</span><span class="o">.</span><span class="n">lineno</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># Data is a list of tuples, one per stack entry.</span>
        <span class="c"># Tupls have the form (filename,lineNumber,functionName,text).</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">extract_tb</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c"># Get the item at the top of the stack.</span>
            <span class="n">filename</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">functionName</span><span class="p">,</span><span class="n">text</span> <span class="o">=</span> <span class="n">item</span>
            <span class="k">return</span> <span class="n">filename</span><span class="p">,</span><span class="n">n</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Should never happen.</span>
            <span class="k">return</span> <span class="s">&#39;&lt;string&gt;&#39;</span><span class="p">,</span><span class="mi">0</span>
<span class="c">#@+node:ekr.20031218072017.3113: *4* printBindings</span></div>
<div class="viewcode-block" id="print_bindings"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.print_bindings">[docs]</a><span class="k">def</span> <span class="nf">print_bindings</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">window</span><span class="p">):</span>

    <span class="n">bindings</span> <span class="o">=</span> <span class="n">window</span><span class="o">.</span><span class="n">bind</span><span class="p">()</span>

    <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Bindings for&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bindings</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="c">#@+node:ekr.20031218072017.3114: *4* printGlobals</span></div>
<div class="viewcode-block" id="printGlobals"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.printGlobals">[docs]</a><span class="k">def</span> <span class="nf">printGlobals</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="c"># Get the list of globals.</span>
    <span class="n">globs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">globals</span><span class="p">())</span>
    <span class="n">globs</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="c"># Print the list.</span>
    <span class="k">if</span> <span class="n">message</span><span class="p">:</span>
        <span class="n">leader</span> <span class="o">=</span> <span class="s">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">10</span>
        <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="n">leader</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="p">,</span> <span class="n">leader</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">glob</span> <span class="ow">in</span> <span class="n">globs</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="n">glob</span><span class="p">)</span>
<span class="c">#@+node:ekr.20070510074941: *4* g.printEntireTree</span></div>
<div class="viewcode-block" id="printEntireTree"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.printEntireTree">[docs]</a><span class="k">def</span> <span class="nf">printEntireTree</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">tag</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>

    <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;printEntireTree&#39;</span><span class="p">,</span><span class="s">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
    <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;printEntireTree&#39;</span><span class="p">,</span><span class="n">tag</span><span class="p">,</span><span class="s">&#39;root&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">all_positions</span><span class="p">():</span>
        <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;..&#39;</span><span class="o">*</span><span class="n">p</span><span class="o">.</span><span class="n">level</span><span class="p">(),</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
<span class="c">#@+node:ekr.20031218072017.3115: *4* printLeoModules</span></div>
<div class="viewcode-block" id="printLeoModules"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.printLeoModules">[docs]</a><span class="k">def</span> <span class="nf">printLeoModules</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="c"># Create the list.</span>
    <span class="n">mods</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">and</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;leo&quot;</span><span class="p">:</span>
            <span class="n">mods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="c"># Print the list.</span>
    <span class="k">if</span> <span class="n">message</span><span class="p">:</span>
        <span class="n">leader</span> <span class="o">=</span> <span class="s">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">10</span>
        <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="n">leader</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="p">,</span> <span class="n">leader</span><span class="p">)</span>
    <span class="n">mods</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mods</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">newline</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
<span class="c">#@+node:ekr.20031218072017.1317: *3* file/module/plugin_date</span></div>
<div class="viewcode-block" id="module_date"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.module_date">[docs]</a><span class="k">def</span> <span class="nf">module_date</span> <span class="p">(</span><span class="n">mod</span><span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">theFile</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">loadDir</span><span class="p">,</span><span class="n">mod</span><span class="o">.</span><span class="n">__file__</span><span class="p">)</span>
    <span class="n">root</span><span class="p">,</span><span class="n">ext</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_splitext</span><span class="p">(</span><span class="n">theFile</span><span class="p">)</span> 
    <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">file_date</span><span class="p">(</span><span class="n">root</span> <span class="o">+</span> <span class="s">&quot;.py&quot;</span><span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="n">format</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="plugin_date"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.plugin_date">[docs]</a><span class="k">def</span> <span class="nf">plugin_date</span> <span class="p">(</span><span class="n">plugin_mod</span><span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">theFile</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">loadDir</span><span class="p">,</span><span class="s">&quot;..&quot;</span><span class="p">,</span><span class="s">&quot;plugins&quot;</span><span class="p">,</span><span class="n">plugin_mod</span><span class="o">.</span><span class="n">__file__</span><span class="p">)</span>
    <span class="n">root</span><span class="p">,</span><span class="n">ext</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_splitext</span><span class="p">(</span><span class="n">theFile</span><span class="p">)</span> 
    <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">file_date</span><span class="p">(</span><span class="n">root</span> <span class="o">+</span> <span class="s">&quot;.py&quot;</span><span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="n">format</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="file_date"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.file_date">[docs]</a><span class="k">def</span> <span class="nf">file_date</span> <span class="p">(</span><span class="n">theFile</span><span class="p">,</span><span class="n">format</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">theFile</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">theFile</span><span class="p">)</span><span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">theFile</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_getmtime</span><span class="p">(</span><span class="n">theFile</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">format</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">format</span> <span class="o">=</span> <span class="s">&quot;%m/</span><span class="si">%d</span><span class="s">/%y %H:%M:%S&quot;</span>
            <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">format</span><span class="p">,</span><span class="n">time</span><span class="o">.</span><span class="n">gmtime</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span><span class="ne">NameError</span><span class="p">):</span>
            <span class="k">pass</span> <span class="c"># Time module is platform dependent.</span>
    <span class="k">return</span> <span class="s">&quot;&quot;</span>
<span class="c">#@+node:ekr.20031218072017.3105: *3* g.alert</span></div>
<div class="viewcode-block" id="alert"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.alert">[docs]</a><span class="k">def</span> <span class="nf">alert</span><span class="p">(</span><span class="n">message</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Raise an alert.</span>

<span class="sd">    This method is deprecated: use c.alert instead.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c"># The unit tests just tests the args.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">alert</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">message</span><span class="p">)</span>
<span class="c">#@+node:ekr.20031218072017.3127: *3* g.get_line &amp; get_line__after</span>
<span class="c"># Very useful for tracing.</span>
</div>
<div class="viewcode-block" id="get_line"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.get_line">[docs]</a><span class="k">def</span> <span class="nf">get_line</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

    <span class="n">nl</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">is_nl</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_nl</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="n">nl</span> <span class="o">=</span> <span class="s">&quot;[nl]&quot;</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">find_line_start</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_to_end_of_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nl</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">k</span><span class="p">]</span>

<span class="c"># Important: getLine is a completely different function.</span>
<span class="c"># getLine = get_line</span>
</div>
<div class="viewcode-block" id="get_line_after"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.get_line_after">[docs]</a><span class="k">def</span> <span class="nf">get_line_after</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

    <span class="n">nl</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">is_nl</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_nl</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="n">nl</span> <span class="o">=</span> <span class="s">&quot;[nl]&quot;</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_to_end_of_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nl</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">k</span><span class="p">]</span>
</div>
<span class="n">getLineAfter</span> <span class="o">=</span> <span class="n">get_line_after</span>
<span class="c">#@+node:ekr.20080729142651.1: *3* g.getIvarsDict and checkUnchangedIvars</span>
<div class="viewcode-block" id="getIvarsDict"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.getIvarsDict">[docs]</a><span class="k">def</span> <span class="nf">getIvarsDict</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Return a dictionary of ivars:values for non-methods of obj.&#39;&#39;&#39;</span>

    <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="p">[[</span><span class="n">key</span><span class="p">,</span><span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">key</span><span class="p">)]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">type</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">key</span><span class="p">))</span> <span class="o">!=</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">d</span>
</div>
<div class="viewcode-block" id="checkUnchangedIvars"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.checkUnchangedIvars">[docs]</a><span class="k">def</span> <span class="nf">checkUnchangedIvars</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">exceptions</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">exceptions</span><span class="p">:</span> <span class="n">exceptions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ok</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exceptions</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">key</span><span class="p">)</span> <span class="o">!=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;changed ivar: </span><span class="si">%s</span><span class="s"> old: </span><span class="si">%s</span><span class="s"> new: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">key</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)),</span><span class="nb">repr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">key</span><span class="p">))))</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="n">ok</span>
<span class="c">#@+node:ekr.20041105091148: *3* g.pdb</span></div>
<div class="viewcode-block" id="pdb"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.pdb">[docs]</a><span class="k">def</span> <span class="nf">pdb</span> <span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Fall into pdb.&quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">pdb</span> <span class="c"># Required: we have just defined pdb as a function!</span>

    <span class="k">if</span> <span class="n">app</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">app</span><span class="o">.</span><span class="n">useIpython</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">PyQt4.QtCore</span> <span class="kn">as</span> <span class="nn">QtCore</span>
            <span class="n">QtCore</span><span class="o">.</span><span class="n">pyqtRemoveInputHook</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">if</span> <span class="n">message</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>
<span class="c">#@+node:ekr.20031218072017.3128: *3* pause</span></div>
<div class="viewcode-block" id="pause"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.pause">[docs]</a><span class="k">def</span> <span class="nf">pause</span> <span class="p">(</span><span class="n">s</span><span class="p">):</span>

    <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="nb">long</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="nb">long</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="c">#@+node:ekr.20041224080039: *3* print_dict &amp; dictToString</span></div>
<div class="viewcode-block" id="print_dict"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.print_dict">[docs]</a><span class="k">def</span> <span class="nf">print_dict</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">tag</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">indent</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">d</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tag</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">...{}&#39;</span> <span class="o">%</span> <span class="n">tag</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>   <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;{}&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">n</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">tag</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">...{</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">tag</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>   <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;{</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s%*s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">indent</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
    <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;}&#39;</span><span class="p">)</span>
</div>
<span class="n">printDict</span> <span class="o">=</span> <span class="n">print_dict</span>

<div class="viewcode-block" id="dictToString"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.dictToString">[docs]</a><span class="k">def</span> <span class="nf">dictToString</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">tag</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">indent</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">d</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tag</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">...{}&#39;</span> <span class="o">%</span> <span class="n">tag</span>
        <span class="k">else</span><span class="p">:</span>   <span class="k">return</span> <span class="s">&#39;{}&#39;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isString</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;</span><span class="si">%s%*s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">indent</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">d</span><span class="p">)]</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tag</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">...{</span><span class="se">\n</span><span class="si">%s</span><span class="s">}</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;{</span><span class="se">\n</span><span class="si">%s</span><span class="s">}</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">s</span>
<span class="c">#@+node:ekr.20041126060136: *3* print_list &amp; listToString</span></div>
<div class="viewcode-block" id="print_list"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.print_list">[docs]</a><span class="k">def</span> <span class="nf">print_list</span><span class="p">(</span><span class="n">aList</span><span class="p">,</span><span class="n">tag</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">sort</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">indent</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">aList</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tag</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">...[]&#39;</span> <span class="o">%</span> <span class="n">tag</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>   <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;[]&#39;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
        <span class="n">bList</span> <span class="o">=</span> <span class="n">aList</span><span class="p">[:]</span> <span class="c"># Sort a copy!</span>
        <span class="n">bList</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bList</span> <span class="o">=</span> <span class="n">aList</span>
    <span class="k">if</span> <span class="n">tag</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">...[&#39;</span> <span class="o">%</span> <span class="n">tag</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>   <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;[&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">bList</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">indent</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
    <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;]&#39;</span><span class="p">)</span>
</div>
<span class="n">printList</span> <span class="o">=</span> <span class="n">print_list</span>

<div class="viewcode-block" id="listToString"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.listToString">[docs]</a><span class="k">def</span> <span class="nf">listToString</span><span class="p">(</span><span class="n">aList</span><span class="p">,</span><span class="n">tag</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">sort</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">indent</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">toRepr</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">aList</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tag</span><span class="p">:</span> <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">...{}&#39;</span> <span class="o">%</span> <span class="n">tag</span>
        <span class="k">else</span><span class="p">:</span>   <span class="k">return</span> <span class="s">&#39;[]&#39;</span>
    <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
        <span class="n">bList</span> <span class="o">=</span> <span class="n">aList</span><span class="p">[:]</span> <span class="c"># Sort a copy!</span>
        <span class="n">bList</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bList</span> <span class="o">=</span> <span class="n">aList</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;</span><span class="si">%s%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">indent</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">bList</span><span class="p">]</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">toRepr</span><span class="p">:</span> <span class="n">s</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tag</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;[</span><span class="si">%s</span><span class="s">...</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;[</span><span class="si">%s</span><span class="s">]&#39;</span> <span class="o">%</span> <span class="n">s</span>
<span class="c">#@+node:ekr.20050819064157: *3* print_obj &amp; toString</span></div>
<div class="viewcode-block" id="print_obj"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.print_obj">[docs]</a><span class="k">def</span> <span class="nf">print_obj</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">tag</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">sort</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">indent</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">type</span><span class="p">(()),</span><span class="nb">type</span><span class="p">([])):</span>
        <span class="n">g</span><span class="o">.</span><span class="n">print_list</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">tag</span><span class="p">,</span><span class="n">sort</span><span class="p">,</span><span class="n">indent</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">({}):</span>
        <span class="n">g</span><span class="o">.</span><span class="n">print_dict</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">tag</span><span class="p">,</span><span class="n">verbose</span><span class="p">,</span><span class="n">indent</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">indent</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
</div>
<div class="viewcode-block" id="toString"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.toString">[docs]</a><span class="k">def</span> <span class="nf">toString</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">tag</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">sort</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">indent</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">type</span><span class="p">(()),</span><span class="nb">type</span><span class="p">([])):</span>
        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">listToString</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">tag</span><span class="p">,</span><span class="n">sort</span><span class="p">,</span><span class="n">indent</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">({}):</span>
        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">dictToString</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">tag</span><span class="p">,</span><span class="n">verbose</span><span class="p">,</span><span class="n">indent</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">indent</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
<span class="c">#@+node:ekr.20041122153823: *3* print_stack (printStack)</span></div>
<div class="viewcode-block" id="print_stack"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.print_stack">[docs]</a><span class="k">def</span> <span class="nf">print_stack</span><span class="p">():</span>

    <span class="n">traceback</span><span class="o">.</span><span class="n">print_stack</span><span class="p">()</span>
</div>
<span class="n">printStack</span> <span class="o">=</span> <span class="n">print_stack</span>
<span class="c">#@+node:ekr.20031218072017.3121: *3* redirecting stderr and stdout to Leo&#39;s log pane</span>
<div class="viewcode-block" id="redirectClass"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.redirectClass">[docs]</a><span class="k">class</span> <span class="nc">redirectClass</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;A class to redirect stdout and stderr to Leo&#39;s log pane.&quot;&quot;&quot;</span>

    <span class="c">#@+&lt;&lt; redirectClass methods &gt;&gt;</span>
    <span class="c">#@+node:ekr.20031218072017.1656: *4* &lt;&lt; redirectClass methods &gt;&gt;</span>
    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20041012082437: *5* redirectClass.__init__</span>
    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">old</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="s">&#39;utf-8&#39;</span> <span class="c"># 2019/03/29 For pdb.</span>
    <span class="c">#@+node:ekr.20041012082437.1: *5* isRedirected</span>
<div class="viewcode-block" id="redirectClass.isRedirected"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.redirectClass.isRedirected">[docs]</a>    <span class="k">def</span> <span class="nf">isRedirected</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">old</span> <span class="o">!=</span> <span class="bp">None</span>
    <span class="c">#@+node:ekr.20041012082437.2: *5* flush</span>
    <span class="c"># For LeoN: just for compatibility.</span>
</div>
<div class="viewcode-block" id="redirectClass.flush"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.redirectClass.flush">[docs]</a>    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span>
    <span class="c">#@+node:ekr.20041012091252: *5* rawPrint</span></div>
<div class="viewcode-block" id="redirectClass.rawPrint"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.redirectClass.rawPrint">[docs]</a>    <span class="k">def</span> <span class="nf">rawPrint</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">old</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">old</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20041012082437.3: *5* redirect</span></div>
<div class="viewcode-block" id="redirectClass.redirect"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.redirectClass.redirect">[docs]</a>    <span class="k">def</span> <span class="nf">redirect</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">stdout</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">batchMode</span><span class="p">:</span>
            <span class="c"># Redirection is futile in batch mode.</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">old</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">stdout</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">old</span><span class="p">,</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span><span class="bp">self</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">old</span><span class="p">,</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span><span class="bp">self</span>
    <span class="c">#@+node:ekr.20041012082437.4: *5* undirect</span></div>
<div class="viewcode-block" id="redirectClass.undirect"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.redirectClass.undirect">[docs]</a>    <span class="k">def</span> <span class="nf">undirect</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">stdout</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">old</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">stdout</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old</span><span class="p">,</span><span class="bp">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old</span><span class="p">,</span><span class="bp">None</span>
    <span class="c">#@+node:ekr.20041012082437.5: *5* write</span></div>
<div class="viewcode-block" id="redirectClass.write"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.redirectClass.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">old</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">old</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="s">&#39;redirectClass: to log: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
                <span class="n">app</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">from_redirect</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">old</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span> <span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Can happen when g.batchMode is True.</span>
            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="c">#@-others</span>
    <span class="c">#@-&lt;&lt; redirectClass methods &gt;&gt;</span>

<span class="c"># Create two redirection objects, one for each stream.</span></div></div>
<span class="n">redirectStdErrObj</span> <span class="o">=</span> <span class="n">redirectClass</span><span class="p">()</span>
<span class="n">redirectStdOutObj</span> <span class="o">=</span> <span class="n">redirectClass</span><span class="p">()</span>

<span class="c">#@+&lt;&lt; define convenience methods for redirecting streams &gt;&gt;</span>
<span class="c">#@+node:ekr.20031218072017.3122: *4* &lt;&lt; define convenience methods for redirecting streams &gt;&gt;</span>
<span class="c">#@+others</span>
<span class="c">#@+node:ekr.20041012090942: *5* redirectStderr &amp; redirectStdout</span>
<span class="c"># Redirect streams to the current log window.</span>
<div class="viewcode-block" id="redirectStderr"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.redirectStderr">[docs]</a><span class="k">def</span> <span class="nf">redirectStderr</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">redirectStdErrObj</span>
    <span class="n">redirectStdErrObj</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="n">stdout</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="redirectStdout"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.redirectStdout">[docs]</a><span class="k">def</span> <span class="nf">redirectStdout</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">redirectStdOutObj</span>
    <span class="n">redirectStdOutObj</span><span class="o">.</span><span class="n">redirect</span><span class="p">()</span>
<span class="c">#@+node:ekr.20041012090942.1: *5* restoreStderr &amp; restoreStdout</span>
<span class="c"># Restore standard streams.</span></div>
<div class="viewcode-block" id="restoreStderr"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.restoreStderr">[docs]</a><span class="k">def</span> <span class="nf">restoreStderr</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">redirectStdErrObj</span>
    <span class="n">redirectStdErrObj</span><span class="o">.</span><span class="n">undirect</span><span class="p">(</span><span class="n">stdout</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="restoreStdout"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.restoreStdout">[docs]</a><span class="k">def</span> <span class="nf">restoreStdout</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">redirectStdOutObj</span>
    <span class="n">redirectStdOutObj</span><span class="o">.</span><span class="n">undirect</span><span class="p">()</span>
<span class="c">#@+node:ekr.20041012090942.2: *5* stdErrIsRedirected &amp; stdOutIsRedirected</span></div>
<div class="viewcode-block" id="stdErrIsRedirected"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.stdErrIsRedirected">[docs]</a><span class="k">def</span> <span class="nf">stdErrIsRedirected</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">redirectStdErrObj</span>
    <span class="k">return</span> <span class="n">redirectStdErrObj</span><span class="o">.</span><span class="n">isRedirected</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="stdOutIsRedirected"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.stdOutIsRedirected">[docs]</a><span class="k">def</span> <span class="nf">stdOutIsRedirected</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">redirectStdOutObj</span>
    <span class="k">return</span> <span class="n">redirectStdOutObj</span><span class="o">.</span><span class="n">isRedirected</span><span class="p">()</span>
<span class="c">#@+node:ekr.20041012090942.3: *5* rawPrint</span>
<span class="c"># Send output to original stdout.</span>
</div>
<div class="viewcode-block" id="rawPrint"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.rawPrint">[docs]</a><span class="k">def</span> <span class="nf">rawPrint</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>

    <span class="k">global</span> <span class="n">redirectStdOutObj</span>

    <span class="n">redirectStdOutObj</span><span class="o">.</span><span class="n">rawPrint</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="c">#@-others</span>
<span class="c">#@-&lt;&lt; define convenience methods for redirecting streams &gt;&gt;</span>
<span class="c">#@+node:ekr.20031218072017.3133: *3* Statistics</span>
<span class="c">#@+node:ekr.20031218072017.3134: *4* clear_stats</span></div>
<div class="viewcode-block" id="clear_stats"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.clear_stats">[docs]</a><span class="k">def</span> <span class="nf">clear_stats</span><span class="p">():</span>

    <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">()</span>

    <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">statsDict</span> <span class="o">=</span> <span class="p">{}</span>
</div>
<span class="n">clearStats</span> <span class="o">=</span> <span class="n">clear_stats</span>
<span class="c">#@+node:ekr.20031218072017.3135: *4* print_stats</span>
<div class="viewcode-block" id="print_stats"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.print_stats">[docs]</a><span class="k">def</span> <span class="nf">print_stats</span> <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">_callerName</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c"># Get caller name 2 levels back.</span>

    <span class="n">g</span><span class="o">.</span><span class="n">printDict</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">statsDict</span><span class="p">,</span><span class="n">tag</span><span class="o">=</span><span class="s">&#39;statistics at </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
</div>
<span class="n">printStats</span> <span class="o">=</span> <span class="n">print_stats</span>
<span class="c">#@+node:ekr.20031218072017.3136: *4* stat</span>
<div class="viewcode-block" id="stat"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.stat">[docs]</a><span class="k">def</span> <span class="nf">stat</span> <span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Increments the statistic for name in g.app.statsDict</span>
<span class="sd">    The caller&#39;s name is used by default.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">statsDict</span>

    <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">_callerName</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c"># Get caller name 2 levels back.</span>

    <span class="c"># g.trace(name)</span>

    <span class="n">d</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<span class="c">#@+node:ekr.20031218072017.3137: *3* Timing</span></div>
<div class="viewcode-block" id="getTime"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.getTime">[docs]</a><span class="k">def</span> <span class="nf">getTime</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="esDiffTime"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.esDiffTime">[docs]</a><span class="k">def</span> <span class="nf">esDiffTime</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">start</span><span class="p">):</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span><span class="o">-</span><span class="n">start</span>
    <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> </span><span class="si">%6.3f</span><span class="s"> sec.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">message</span><span class="p">,</span><span class="n">delta</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="printDiffTime"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.printDiffTime">[docs]</a><span class="k">def</span> <span class="nf">printDiffTime</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">start</span><span class="p">):</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span><span class="o">-</span><span class="n">start</span>
    <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> </span><span class="si">%6.3f</span><span class="s"> sec.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">message</span><span class="p">,</span><span class="n">delta</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="timeSince"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.timeSince">[docs]</a><span class="k">def</span> <span class="nf">timeSince</span><span class="p">(</span><span class="n">start</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&quot;</span><span class="si">%6.3f</span><span class="s"> sec.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
<span class="c">#@+node:ekr.20031218072017.3116: ** Files &amp; Directories...</span>
<span class="c">#@+node:ekr.20120222084734.10287: *3*  Redirection to LoadManager methods</span>
<span class="c"># For compatibility with old code.</span></div>
<div class="viewcode-block" id="computeGlobalConfigDir"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.computeGlobalConfigDir">[docs]</a><span class="k">def</span> <span class="nf">computeGlobalConfigDir</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadManager</span><span class="o">.</span><span class="n">computeGlobalConfigDir</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="computeHomeDir"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.computeHomeDir">[docs]</a><span class="k">def</span> <span class="nf">computeHomeDir</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadManager</span><span class="o">.</span><span class="n">computeHomeDir</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="computeLeoDir"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.computeLeoDir">[docs]</a><span class="k">def</span> <span class="nf">computeLeoDir</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadManager</span><span class="o">.</span><span class="n">computeLeoDir</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="computeLoadDir"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.computeLoadDir">[docs]</a><span class="k">def</span> <span class="nf">computeLoadDir</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadManager</span><span class="o">.</span><span class="n">computeLoadDir</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="computeMachineName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.computeMachineName">[docs]</a><span class="k">def</span> <span class="nf">computeMachineName</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadManager</span><span class="o">.</span><span class="n">computeMachineName</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="computeStandardDirectories"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.computeStandardDirectories">[docs]</a><span class="k">def</span> <span class="nf">computeStandardDirectories</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadManager</span><span class="o">.</span><span class="n">computeStandardDirectories</span><span class="p">()</span>
<span class="c">#@+node:ekr.20080606074139.2: *3* g.chdir</span></div>
<div class="viewcode-block" id="chdir"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.chdir">[docs]</a><span class="k">def</span> <span class="nf">chdir</span> <span class="p">(</span><span class="n">path</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_dirname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_isdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="c">#@+node:ekr.20031218072017.3117: *3* g.create_temp_file</span></div>
<div class="viewcode-block" id="create_temp_file"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.create_temp_file">[docs]</a><span class="k">def</span> <span class="nf">create_temp_file</span> <span class="p">(</span><span class="n">textMode</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Return a tuple (theFile,theFileName)</span>

<span class="sd">    theFile: a file object open for writing.</span>
<span class="sd">    theFileName: the name of the temporary file.&#39;&#39;&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c"># fd is an handle to an open file as would be returned by os.open()</span>
        <span class="n">fd</span><span class="p">,</span><span class="n">theFileName</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">textMode</span><span class="p">)</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">textMode</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">,</span><span class="s">&#39;wb&#39;</span><span class="p">)</span>
        <span class="n">theFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="n">mode</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;unexpected exception in g.create_temp_file&#39;</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
        <span class="n">theFile</span><span class="p">,</span><span class="n">theFileName</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span><span class="s">&#39;&#39;</span>

    <span class="k">return</span> <span class="n">theFile</span><span class="p">,</span><span class="n">theFileName</span>
<span class="c">#@+node:ekr.20031218072017.3118: *3* g.ensure_extension</span></div>
<div class="viewcode-block" id="ensure_extension"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.ensure_extension">[docs]</a><span class="k">def</span> <span class="nf">ensure_extension</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ext</span><span class="p">):</span>

    <span class="n">theFile</span><span class="p">,</span> <span class="n">old_ext</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_splitext</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">name</span> <span class="c"># don&#39;t add to an empty name.</span>
    <span class="k">elif</span> <span class="n">old_ext</span> <span class="ow">and</span> <span class="n">old_ext</span> <span class="o">==</span> <span class="n">ext</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">name</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">name</span> <span class="o">+</span> <span class="n">ext</span>
<span class="c">#@+node:ekr.20031218072017.1264: *3* g.getBaseDirectory</span>
<span class="c"># Handles the conventions applying to the &quot;relative_path_base_directory&quot; configuration option.</span>
</div>
<div class="viewcode-block" id="getBaseDirectory"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.getBaseDirectory">[docs]</a><span class="k">def</span> <span class="nf">getBaseDirectory</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Convert &#39;!&#39; or &#39;.&#39; to proper directory references.&#39;&#39;&#39;</span>

    <span class="n">base</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">relative_path_base_directory</span>

    <span class="k">if</span> <span class="n">base</span> <span class="ow">and</span> <span class="n">base</span> <span class="o">==</span> <span class="s">&quot;!&quot;</span><span class="p">:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">loadDir</span>
    <span class="k">elif</span> <span class="n">base</span> <span class="ow">and</span> <span class="n">base</span> <span class="o">==</span> <span class="s">&quot;.&quot;</span><span class="p">:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">openDirectory</span>

    <span class="k">if</span> <span class="n">base</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_isabs</span><span class="p">(</span><span class="n">base</span><span class="p">):</span>
        <span class="c"># Set c.chdir_to_relative_path as needed.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">&#39;chdir_to_relative_path&#39;</span><span class="p">):</span>
            <span class="n">c</span><span class="o">.</span><span class="n">chdir_to_relative_path</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getBool</span><span class="p">(</span><span class="s">&#39;chdir_to_relative_path&#39;</span><span class="p">)</span>
        <span class="c"># Call os.chdir if requested.</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">chdir_to_relative_path</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
        <span class="c"># g.trace(base)</span>
        <span class="k">return</span> <span class="n">base</span> <span class="c"># base need not exist yet.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;&quot;</span> <span class="c"># No relative base given.</span>
<span class="c">#@+node:ville.20090701144325.14942: *3* g.guessExternalEditor</span></div>
<div class="viewcode-block" id="guessExternalEditor"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.guessExternalEditor">[docs]</a><span class="k">def</span> <span class="nf">guessExternalEditor</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return a &#39;sensible&#39; external editor &quot;&quot;&quot;</span>

    <span class="n">editor</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;LEO_EDITOR&quot;</span><span class="p">)</span> <span class="ow">or</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;EDITOR&quot;</span><span class="p">)</span> <span class="ow">or</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">db</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;LEO_EDITOR&quot;</span><span class="p">)</span> <span class="ow">or</span>
        <span class="n">c</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getString</span><span class="p">(</span><span class="s">&#39;external_editor&#39;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">editor</span><span class="p">:</span> <span class="k">return</span> <span class="n">editor</span>

    <span class="c"># fallbacks</span>
    <span class="n">platform</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;win&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;notepad&quot;</span>
    <span class="k">elif</span> <span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;linux&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;gedit&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;&#39;&#39;No editor set.</span>
<span class="s">Please set LEO_EDITOR or EDITOR environment variable,</span>
<span class="s">or do g.app.db[&#39;LEO_EDITOR&#39;] = &quot;gvim&quot;&#39;&#39;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>
<span class="c">#@+node:ekr.20100329071036.5744: *3* g.is_binary_file</span></div>
<div class="viewcode-block" id="is_binary_file"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.is_binary_file">[docs]</a><span class="k">def</span> <span class="nf">is_binary_file</span> <span class="p">(</span><span class="n">f</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">f</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">io</span><span class="o">.</span><span class="n">BufferedIOBase</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">internalError</span><span class="p">(</span><span class="s">&#39;g.is_binary_file called from Python 2.x code&#39;</span><span class="p">)</span>
<span class="c">#@+node:EKR.20040504154039: *3* g.is_sentinel</span></div>
<div class="viewcode-block" id="is_sentinel"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.is_sentinel">[docs]</a><span class="k">def</span> <span class="nf">is_sentinel</span> <span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="n">delims</span><span class="p">):</span>

    <span class="c">#@+&lt;&lt; is_sentinel doc tests &gt;&gt;</span>
    <span class="c">#@+node:ekr.20040719161756: *4* &lt;&lt; is_sentinel doc tests &gt;&gt;</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Return True if line starts with a sentinel comment.</span>

<span class="sd">    &gt;&gt;&gt; import leo.core.leoGlobals as g</span>
<span class="sd">    &gt;&gt;&gt; py_delims = g.comment_delims_from_extension(&#39;.py&#39;)</span>
<span class="sd">    &gt;&gt;&gt; g.is_sentinel(&quot;#@+node&quot;,py_delims)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; g.is_sentinel(&quot;#comment&quot;,py_delims)</span>
<span class="sd">    False</span>

<span class="sd">    &gt;&gt;&gt; c_delims = g.comment_delims_from_extension(&#39;.c&#39;)</span>
<span class="sd">    &gt;&gt;&gt; g.is_sentinel(&quot;//@+node&quot;,c_delims)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; g.is_sentinel(&quot;//comment&quot;,c_delims)</span>
<span class="sd">    False</span>

<span class="sd">    &gt;&gt;&gt; html_delims = g.comment_delims_from_extension(&#39;.html&#39;)</span>
<span class="sd">    &gt;&gt;&gt; g.is_sentinel(&quot;&lt;!--@+node--&gt;&quot;,html_delims)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; g.is_sentinel(&quot;&lt;!--comment--&gt;&quot;,html_delims)</span>
<span class="sd">    False</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#@-&lt;&lt; is_sentinel doc tests &gt;&gt;</span>

    <span class="n">delim1</span><span class="p">,</span><span class="n">delim2</span><span class="p">,</span><span class="n">delim3</span> <span class="o">=</span> <span class="n">delims</span>

    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">delim1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">delim1</span><span class="o">+</span><span class="s">&#39;@&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">delim2</span> <span class="ow">and</span> <span class="n">delim3</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">delim2</span><span class="o">+</span><span class="s">&#39;@&#39;</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">delim3</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span> <span class="o">==</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">j</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;is_sentinel: can not happen. delims: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">delims</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">False</span>
<span class="c">#@+node:ekr.20031218072017.3119: *3* g.makeAllNonExistentDirectories</span>
<span class="c"># This is a generalization of os.makedir.</span>
</div>
<div class="viewcode-block" id="makeAllNonExistentDirectories"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.makeAllNonExistentDirectories">[docs]</a><span class="k">def</span> <span class="nf">makeAllNonExistentDirectories</span> <span class="p">(</span><span class="n">theDir</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">force</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Attempt to make all non-existent directories&quot;&quot;&quot;</span>

    <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
    <span class="n">testing</span> <span class="o">=</span> <span class="n">trace</span> <span class="c"># True: don&#39;t actually make the directories.</span>

    <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
        <span class="n">create</span> <span class="o">=</span> <span class="bp">True</span> <span class="c"># Bug fix: g.app.config will not exist during startup.</span>
    <span class="k">elif</span> <span class="n">c</span><span class="p">:</span>
        <span class="n">create</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">create_nonexistent_directories</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">create</span> <span class="o">=</span> <span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">app</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">create_nonexistent_directories</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">c</span><span class="p">:</span> <span class="n">theDir</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_expandExpression</span><span class="p">(</span><span class="n">theDir</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>

    <span class="n">dir1</span> <span class="o">=</span> <span class="n">theDir</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_normpath</span><span class="p">(</span><span class="n">theDir</span><span class="p">)</span>

    <span class="n">ok</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_isdir</span><span class="p">(</span><span class="n">dir1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">dir1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;ok&#39;</span><span class="p">,</span><span class="n">ok</span><span class="p">,</span><span class="s">&#39;create&#39;</span><span class="p">,</span><span class="n">create</span><span class="p">,</span><span class="s">&#39;force&#39;</span><span class="p">,</span><span class="n">force</span><span class="p">,</span><span class="n">dir1</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ok</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">force</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">create</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;did not create: force and create are both false&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="n">theDir</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
        <span class="c"># g.trace(&#39;c exists: %s force: %s create: %s dir: %s&#39; % (</span>
            <span class="c"># c is not None,force,create,theDir))</span>

    <span class="c"># Split theDir into all its component parts.</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">theDir</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">head</span><span class="p">,</span><span class="n">tail</span><span class="o">=</span><span class="n">g</span><span class="o">.</span><span class="n">os_path_split</span><span class="p">(</span><span class="n">theDir</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tail</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">head</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tail</span><span class="p">)</span>
            <span class="n">theDir</span> <span class="o">=</span> <span class="n">head</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
    <span class="n">paths</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;paths:&#39;</span><span class="p">,</span><span class="n">paths</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">testing</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;***making&#39;</span><span class="p">,</span><span class="n">path</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">testing</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">red</span><span class="p">(</span><span class="s">&quot;created directory:&quot;</span><span class="p">,</span><span class="n">path</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;exception creating directory:&quot;</span><span class="p">,</span><span class="n">path</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
                <span class="k">return</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">dir1</span> <span class="c"># All have been created.</span>
<span class="c">#@+node:ekr.20071114113736: *3* g.makePathRelativeTo</span></div>
<div class="viewcode-block" id="makePathRelativeTo"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.makePathRelativeTo">[docs]</a><span class="k">def</span> <span class="nf">makePathRelativeTo</span> <span class="p">(</span><span class="n">fullPath</span><span class="p">,</span><span class="n">basePath</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">fullPath</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">basePath</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">fullPath</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">basePath</span><span class="p">):]</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">):]</span>
        <span class="k">return</span> <span class="n">s</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fullPath</span>
<span class="c">#@+node:ekr.20090520055433.5945: *3* g.openWithFileName</span></div>
<div class="viewcode-block" id="openWithFileName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.openWithFileName">[docs]</a><span class="k">def</span> <span class="nf">openWithFileName</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">old_c</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">gui</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Create a Leo Frame for the indicated fileName if the file exists.</span>

<span class="sd">    returns the commander of the newly-opened outline.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadManager</span><span class="o">.</span><span class="n">loadLocalFile</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">gui</span><span class="p">,</span><span class="n">old_c</span><span class="p">)</span>
<span class="c">#@+node:ekr.20100125073206.8710: *3* g.readFileIntoString (Leo 4.7)</span></div>
<div class="viewcode-block" id="readFileIntoString"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.readFileIntoString">[docs]</a><span class="k">def</span> <span class="nf">readFileIntoString</span> <span class="p">(</span><span class="n">fn</span><span class="p">,</span>
    <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span>
    <span class="n">kind</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">mode</span><span class="o">=</span><span class="s">&#39;rb&#39;</span><span class="p">,</span>
    <span class="n">raw</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
    <span class="n">silent</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
<span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Return the contents of the file whose full path is fn.</span>

<span class="sd">    Return (s,e)</span>
<span class="sd">    s is the string, converted to unicode, or None if there was an error.</span>
<span class="sd">    e the encoding line for Python files: it is usually None.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">e</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">mode</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">raw</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span><span class="p">,</span><span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Python&#39;s encoding comments override everything else.</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">junk</span><span class="p">,</span><span class="n">ext</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_splitext</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s">&#39;.py&#39;</span><span class="p">:</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">getPythonEncodingFromString</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="n">e</span> <span class="ow">or</span> <span class="n">encoding</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">s</span><span class="p">,</span><span class="n">e</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="c"># Translate &#39;can not open&#39; and kind, but not fn.</span>
        <span class="c"># g.trace(g.callers(5))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kind</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;can not open&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">kind</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;can not open&#39;</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;readFileIntoString: unexpected exception reading </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fn</span><span class="p">))</span>
        <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>

    <span class="k">return</span> <span class="bp">None</span><span class="p">,</span><span class="bp">None</span>
<span class="c">#@+node:ekr.20031218072017.3120: *3* g.readlineForceUnixNewline</span>
<span class="c">#@+at Stephen P. Schaefer 9/7/2002</span>
<span class="c"># </span>
<span class="c"># The Unix readline() routine delivers &quot;\r\n&quot; line end strings verbatim,</span>
<span class="c"># while the windows versions force the string to use the Unix convention</span>
<span class="c"># of using only &quot;\n&quot;. This routine causes the Unix readline to do the</span>
<span class="c"># same.</span>
<span class="c">#@@c</span>
</div>
<div class="viewcode-block" id="readlineForceUnixNewline"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.readlineForceUnixNewline">[docs]</a><span class="k">def</span> <span class="nf">readlineForceUnixNewline</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">fileName</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="c"># g.trace(repr(s))</span>
    <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;UnicodeDecodeError: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fileName</span><span class="p">),</span><span class="n">f</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">u</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;</span><span class="se">\r</span><span class="s">&quot;</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="k">return</span> <span class="n">s</span>
<span class="c">#@+node:tbrown.20110219154422.37469: *3* g.recursiveUNLSearch</span></div>
<div class="viewcode-block" id="recursiveUNLSearch"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.recursiveUNLSearch">[docs]</a><span class="k">def</span> <span class="nf">recursiveUNLSearch</span><span class="p">(</span><span class="n">unlList</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">maxdepth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">maxp</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;try and move to unl in the commander c</span>

<span class="sd">    NOTE: maxdepth is max depth seen in recursion so far, not a limit on</span>
<span class="sd">          how fast we will recurse.  So it should default to 0 (zero).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTestDict</span><span class="p">[</span><span class="s">&#39;g.recursiveUNLSearch&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">True</span>
        <span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="n">maxdepth</span><span class="p">,</span> <span class="n">maxp</span>

    <span class="k">def</span> <span class="nf">moveToP</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="n">c</span><span class="o">.</span><span class="n">expandAllAncestors</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">bringToFront</span><span class="p">()</span>

    <span class="n">found</span><span class="p">,</span> <span class="n">maxdepth</span><span class="p">,</span> <span class="n">maxp</span> <span class="o">=</span> <span class="n">recursiveUNLFind</span><span class="p">(</span><span class="n">unlList</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">maxdepth</span><span class="p">,</span> <span class="n">maxp</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">maxp</span><span class="p">:</span>
        <span class="n">moveToP</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">maxp</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">found</span><span class="p">,</span> <span class="n">maxdepth</span><span class="p">,</span> <span class="n">maxp</span>
</div>
<div class="viewcode-block" id="recursiveUNLFind"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.recursiveUNLFind">[docs]</a><span class="k">def</span> <span class="nf">recursiveUNLFind</span><span class="p">(</span><span class="n">unlList</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">maxdepth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">maxp</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Internal part of recursiveUNLSearch which doesn&#39;t change the</span>
<span class="sd">    selected position or call c.frame.bringToFront()&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">depth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">nds</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span><span class="o">.</span><span class="n">self_and_siblings</span><span class="p">()</span>
        <span class="n">unlList</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;--</span><span class="si">%3E</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;--&gt;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">unlList</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
        <span class="c"># drop empty parts so &quot;--&gt;node name&quot; works</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nds</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">children</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nds</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">unlList</span><span class="p">[</span><span class="n">depth</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="o">.</span><span class="n">h</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">depth</span><span class="o">+</span><span class="mi">1</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">unlList</span><span class="p">):</span>  <span class="c"># found it</span>
                <span class="c">#X moveToP(c, i)</span>
                <span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="n">maxdepth</span><span class="p">,</span> <span class="n">i</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">maxdepth</span> <span class="o">&lt;</span> <span class="n">depth</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">maxdepth</span> <span class="o">=</span> <span class="n">depth</span><span class="o">+</span><span class="mi">1</span>
                    <span class="n">maxp</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">found</span><span class="p">,</span> <span class="n">maxdepth</span><span class="p">,</span> <span class="n">maxp</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">recursiveUNLSearch</span><span class="p">(</span><span class="n">unlList</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">depth</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">maxdepth</span><span class="p">,</span> <span class="n">maxp</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">found</span><span class="p">,</span> <span class="n">maxdepth</span><span class="p">,</span> <span class="n">maxp</span>
                <span class="c"># else keep looking through nds</span>

    <span class="k">if</span> <span class="n">depth</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">maxp</span><span class="p">:</span>  <span class="c"># inexact match</span>
        <span class="c">#X moveToP(c, maxp)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;Partial UNL match&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="n">maxdepth</span><span class="p">,</span> <span class="n">maxp</span>
<span class="c">#@+node:ekr.20031218072017.3124: *3* g.sanitize_filename</span></div>
<div class="viewcode-block" id="sanitize_filename"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.sanitize_filename">[docs]</a><span class="k">def</span> <span class="nf">sanitize_filename</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Prepares string s to be a valid file name:</span>

<span class="sd">    - substitute &#39;_&#39; whitespace and characters used special path characters.</span>
<span class="sd">    - eliminate all other non-alphabetic characters.</span>
<span class="sd">    - strip leading and trailing whitespace.</span>
<span class="sd">    - return at most 128 characters.&quot;&quot;&quot;</span>

    <span class="n">result</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="n">ch</span>
        <span class="k">elif</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">whitespace</span><span class="p">:</span> <span class="c"># Translate whitespace.</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="s">&#39;_&#39;</span>
        <span class="k">elif</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;/&#39;</span><span class="p">,</span><span class="s">&#39;:&#39;</span><span class="p">):</span> <span class="c"># Translate special path characters.</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="s">&#39;_&#39;</span>
    <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;__&#39;</span><span class="p">,</span><span class="s">&#39;_&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">result</span> <span class="p">[:</span><span class="mi">128</span><span class="p">]</span>
<span class="c">#@+node:ekr.20060328150113: *3* g.setGlobalOpenDir</span></div>
<div class="viewcode-block" id="setGlobalOpenDir"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.setGlobalOpenDir">[docs]</a><span class="k">def</span> <span class="nf">setGlobalOpenDir</span> <span class="p">(</span><span class="n">fileName</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">fileName</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">globalOpenDir</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_dirname</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
        <span class="c"># g.es(&#39;current directory:&#39;,g.app.globalOpenDir)</span>
<span class="c">#@+node:ekr.20031218072017.3125: *3* g.shortFileName &amp; shortFilename</span></div>
<div class="viewcode-block" id="shortFileName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.shortFileName">[docs]</a><span class="k">def</span> <span class="nf">shortFileName</span> <span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    
    <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_basename</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fileName</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">)[</span><span class="o">-</span><span class="n">n</span><span class="p">:])</span>
</div>
<span class="n">shortFilename</span> <span class="o">=</span> <span class="n">shortFileName</span>
<span class="c">#@+node:ekr.20050104135720: *3* Used by tangle code &amp; leoFileCommands</span>
<span class="c">#@+node:ekr.20031218072017.1241: *4* g.update_file_if_changed</span>
<span class="c"># This is part of the tangle code.</span>

<div class="viewcode-block" id="update_file_if_changed"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.update_file_if_changed">[docs]</a><span class="k">def</span> <span class="nf">update_file_if_changed</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">file_name</span><span class="p">,</span><span class="n">temp_name</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Compares two files.</span>

<span class="sd">    If they are different, we replace file_name with temp_name.</span>
<span class="sd">    Otherwise, we just delete temp_name. Both files should be closed.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">filecmp</span><span class="o">.</span><span class="n">cmp</span><span class="p">(</span><span class="n">temp_name</span><span class="p">,</span> <span class="n">file_name</span><span class="p">):</span>
            <span class="n">kind</span> <span class="o">=</span> <span class="s">&#39;unchanged&#39;</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">utils_remove</span><span class="p">(</span><span class="n">temp_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kind</span> <span class="o">=</span> <span class="s">&#39;***updating&#39;</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">utils_stat</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">utils_rename</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">file_name</span><span class="p">,</span><span class="n">mode</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="s">&#39;creating&#39;</span>
        <span class="c"># 2010/02/04: g.utils_rename no longer calls</span>
        <span class="c"># makeAllNonExistentDirectories</span>
        <span class="n">head</span><span class="p">,</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_split</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">head</span><span class="p">:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">makeAllNonExistentDirectories</span><span class="p">(</span><span class="n">head</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">utils_rename</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">file_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="si">%12s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kind</span><span class="p">,</span><span class="n">file_name</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;rename failed: no file created!&quot;</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">file_name</span><span class="p">,</span><span class="s">&quot; may be read-only or in use&quot;</span><span class="p">)</span>
<span class="c">#@+node:ekr.20050104123726.3: *4* g.utils_remove</span></div>
<div class="viewcode-block" id="utils_remove"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.utils_remove">[docs]</a><span class="k">def</span> <span class="nf">utils_remove</span> <span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;exception removing:&quot;</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">False</span>
<span class="c">#@+node:ekr.20031218072017.1263: *4* g.utils_rename</span></div>
<div class="viewcode-block" id="utils_rename"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.utils_rename">[docs]</a><span class="k">def</span> <span class="nf">utils_rename</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">src</span><span class="p">,</span><span class="n">dst</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Platform independent rename.&#39;&#39;&#39;</span>

    <span class="c"># Don&#39;t call g.makeAllNonExistentDirectories.</span>
    <span class="c"># It&#39;s not right to do this here!!</span>

    <span class="c"># head, tail = g.os_path_split(dst)</span>
    <span class="c"># if head: g.makeAllNonExistentDirectories(head,c=c)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">src</span><span class="p">,</span><span class="n">dst</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;exception renaming&#39;</span><span class="p">,</span><span class="n">src</span><span class="p">,</span><span class="s">&#39;to&#39;</span><span class="p">,</span><span class="n">dst</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">(</span><span class="n">full</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">False</span>
<span class="c">#@+node:ekr.20050104124903: *4* g.utils_chmod</span></div>
<div class="viewcode-block" id="utils_chmod"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.utils_chmod">[docs]</a><span class="k">def</span> <span class="nf">utils_chmod</span> <span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">mode</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span><span class="n">mode</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;exception in os.chmod&quot;</span><span class="p">,</span><span class="n">fileName</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
<span class="c">#@+node:ekr.20050104123726.4: *4* g.utils_stat</span></div>
<div class="viewcode-block" id="utils_stat"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.utils_stat">[docs]</a><span class="k">def</span> <span class="nf">utils_stat</span> <span class="p">(</span><span class="n">fileName</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Return the access mode of named file, removing any setuid, setgid, and sticky bits.&#39;&#39;&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">fileName</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">7</span><span class="o">*</span><span class="mi">8</span><span class="o">*</span><span class="mi">8</span> <span class="o">+</span> <span class="mi">7</span><span class="o">*</span><span class="mi">8</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="c"># 0777</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">return</span> <span class="n">mode</span>
<span class="c">#@+node:ekr.20031218072017.1588: ** Garbage Collection</span></div>
<span class="n">lastObjectCount</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">lastObjectsDict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">lastTypesDict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">lastFunctionsDict</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c">#@+others</span>
<span class="c">#@+node:ekr.20031218072017.1589: *3* clearAllIvars</span>
<div class="viewcode-block" id="clearAllIvars"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.clearAllIvars">[docs]</a><span class="k">def</span> <span class="nf">clearAllIvars</span> <span class="p">(</span><span class="n">o</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Clear all ivars of o, a member of some class.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">o</span><span class="p">:</span>
        <span class="n">o</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<span class="c">#@+node:ekr.20031218072017.1590: *3* collectGarbage</span></div>
<div class="viewcode-block" id="collectGarbage"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.collectGarbage">[docs]</a><span class="k">def</span> <span class="nf">collectGarbage</span><span class="p">():</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">trace_gc_inited</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">enable_gc_debug</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">trace_gc_verbose</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">trace_gc_calls</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;collectGarbage:&#39;</span><span class="p">)</span>

        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c"># Only init once, regardless of what happens.</span>
    <span class="n">g</span><span class="o">.</span><span class="n">trace_gc_inited</span> <span class="o">=</span> <span class="bp">True</span>
<span class="c">#@+node:ekr.20060127162818: *3* enable_gc_debug</span></div>
<span class="n">no_gc_message</span> <span class="o">=</span> <span class="bp">False</span>

<div class="viewcode-block" id="enable_gc_debug"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.enable_gc_debug">[docs]</a><span class="k">def</span> <span class="nf">enable_gc_debug</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">gc</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">trace_gc_verbose</span><span class="p">:</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">set_debug</span><span class="p">(</span>
                <span class="n">gc</span><span class="o">.</span><span class="n">DEBUG_STATS</span> <span class="o">|</span> <span class="c"># prints statistics.</span>
                <span class="n">gc</span><span class="o">.</span><span class="n">DEBUG_LEAK</span> <span class="o">|</span> <span class="c"># Same as all below.</span>
                <span class="n">gc</span><span class="o">.</span><span class="n">DEBUG_COLLECTABLE</span> <span class="o">|</span>
                <span class="n">gc</span><span class="o">.</span><span class="n">DEBUG_UNCOLLECTABLE</span> <span class="o">|</span>
                <span class="n">gc</span><span class="o">.</span><span class="n">DEBUG_INSTANCES</span> <span class="o">|</span>
                <span class="n">gc</span><span class="o">.</span><span class="n">DEBUG_OBJECTS</span> <span class="o">|</span>
                <span class="n">gc</span><span class="o">.</span><span class="n">DEBUG_SAVEALL</span>
            <span class="p">)</span>
        <span class="c"># else:</span>
            <span class="c"># gc.set_debug(gc.DEBUG_STATS)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">no_gc_message</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">no_gc_message</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;can not import gc module&#39;</span><span class="p">)</span>
<span class="c">#@+node:ekr.20031218072017.1592: *3* printGc</span>
<span class="c"># Formerly called from unit tests.</span>
</div>
<div class="viewcode-block" id="printGc"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.printGc">[docs]</a><span class="k">def</span> <span class="nf">printGc</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">trace_gc</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>

    <span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">_callerName</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">printGcObjects</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">)</span>
    <span class="n">printGcRefs</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">trace_gc_verbose</span><span class="p">:</span>
        <span class="n">printGcVerbose</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="n">tag</span><span class="p">)</span>
<span class="c">#@+node:ekr.20031218072017.1593: *4* printGcRefs</span></div>
<div class="viewcode-block" id="printGcRefs"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.printGcRefs">[docs]</a><span class="k">def</span> <span class="nf">printGcRefs</span> <span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>

    <span class="n">refs</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">get_referrers</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">windowList</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">30</span><span class="p">,</span><span class="n">tag</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">trace_gc_verbose</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;refs of&quot;</span><span class="p">,</span> <span class="n">app</span><span class="o">.</span><span class="n">windowList</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">ref</span> <span class="ow">in</span> <span class="n">refs</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">ref</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="s"> referers&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">refs</span><span class="p">))</span>
<span class="c">#@+node:ekr.20060202161935: *3* printGcAll</span></div>
<div class="viewcode-block" id="printGcAll"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.printGcAll">[docs]</a><span class="k">def</span> <span class="nf">printGcAll</span> <span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>

    <span class="c"># Suppress warning about keywords arg not supported in sort.</span>

    <span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">_callerName</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">;</span> <span class="n">objects</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">get_objects</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">30</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">: </span><span class="si">%d</span><span class="s"> objects&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">objects</span><span class="p">)))</span>

    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="s">&#39;instance&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">t</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__class__</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span> <span class="k">pass</span>
        <span class="c"># if type(obj) == type(()):</span>
            <span class="c"># g.pr(id(obj),repr(obj))</span>

        <span class="c"># 2011/02/28: Some types may not be hashable.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="mi">1</span><span class="p">:</span> <span class="c"># Sort by n</span>
        <span class="n">items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="n">items</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="c"># key is a function that extracts args.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%40s</span><span class="s"> </span><span class="si">%7d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span> <span class="c"># Sort by type</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%40s</span><span class="s"> </span><span class="si">%7d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">t</span><span class="p">)))</span>
<span class="c">#@+node:ekr.20060127164729.1: *3* printGcObjects   (printNewObjects=pno)</span></div>
<div class="viewcode-block" id="printGcObjects"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.printGcObjects">[docs]</a><span class="k">def</span> <span class="nf">printGcObjects</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Print newly allocated objects.&#39;&#39;&#39;</span>

    <span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">_callerName</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">global</span> <span class="n">lastObjectCount</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">garbage</span><span class="p">)</span>
        <span class="n">n2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">get_objects</span><span class="p">())</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">n2</span><span class="o">-</span><span class="n">lastObjectCount</span>
        <span class="k">if</span> <span class="n">delta</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span>
        <span class="n">lastObjectCount</span> <span class="o">=</span> <span class="n">n2</span>

        <span class="c">#@+&lt;&lt; print number of each type of object &gt;&gt;</span>
        <span class="c">#@+node:ekr.20040703054646: *4* &lt;&lt; print number of each type of object &gt;&gt;</span>
        <span class="k">global</span> <span class="n">lastTypesDict</span>
        <span class="n">typesDict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">gc</span><span class="o">.</span><span class="n">get_objects</span><span class="p">():</span>
            <span class="n">t</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="s">&#39;instance&#39;</span> <span class="ow">and</span> <span class="n">t</span> <span class="o">!=</span> <span class="n">types</span><span class="o">.</span><span class="n">UnicodeType</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span> <span class="n">t</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__class__</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span> <span class="k">pass</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">!=</span> <span class="n">types</span><span class="o">.</span><span class="n">FrameType</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="c"># was type(obj) instead of repr(t)</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">typesDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> 
                <span class="n">typesDict</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c"># Create the union of all the keys.</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">lastTypesDict</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">typesDict</span><span class="p">:</span>
                <span class="n">keys</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="bp">None</span>

        <span class="n">empty</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">n3</span> <span class="o">=</span> <span class="n">lastTypesDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">n4</span> <span class="o">=</span> <span class="n">typesDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">delta2</span> <span class="o">=</span> <span class="n">n4</span><span class="o">-</span><span class="n">n3</span>
            <span class="k">if</span> <span class="n">delta2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">empty</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">empty</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">30</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">: garbage: </span><span class="si">%d</span><span class="s">, objects: </span><span class="si">%d</span><span class="s">, delta: </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">delta</span><span class="p">))</span>

            <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">keys</span><span class="p">):</span>
                    <span class="n">n1</span> <span class="o">=</span> <span class="n">lastTypesDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">n2</span> <span class="o">=</span> <span class="n">typesDict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">delta2</span> <span class="o">=</span> <span class="n">n2</span><span class="o">-</span><span class="n">n1</span>
                    <span class="k">if</span> <span class="n">delta2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%+6d</span><span class="s"> =</span><span class="si">%7d</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">delta2</span><span class="p">,</span><span class="n">n2</span><span class="p">,</span><span class="n">key</span><span class="p">))</span>

        <span class="n">lastTypesDict</span> <span class="o">=</span> <span class="n">typesDict</span>
        <span class="n">typesDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c">#@-&lt;&lt; print number of each type of object &gt;&gt;</span>
        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c">#@+&lt;&lt; print added functions &gt;&gt;</span>
            <span class="c">#@+node:ekr.20040703065638: *4* &lt;&lt; print added functions &gt;&gt;</span>
            <span class="k">global</span> <span class="n">lastFunctionsDict</span>
            <span class="n">funcDict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># Don&#39;t print more than 50 objects.</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">gc</span><span class="o">.</span><span class="n">get_objects</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">==</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">:</span>
                    <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">gc</span><span class="o">.</span><span class="n">get_objects</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">==</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="c"># Don&#39;t create a pointer to the object!</span>
                    <span class="n">funcDict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">=</span><span class="bp">None</span> 
                    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">50</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lastFunctionsDict</span><span class="p">:</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                        <span class="n">args</span><span class="p">,</span> <span class="n">varargs</span><span class="p">,</span> <span class="n">varkw</span><span class="p">,</span><span class="n">defaults</span>  <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;args&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">varargs</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;varargs&quot;</span><span class="p">,</span><span class="n">varargs</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">varkw</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;varkw&quot;</span><span class="p">,</span><span class="n">varkw</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">defaults</span><span class="p">:</span>
                            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;defaults...&quot;</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">defaults</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">lastFunctionsDict</span> <span class="o">=</span> <span class="n">funcDict</span>
            <span class="n">funcDict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c">#@-&lt;&lt; print added functions &gt;&gt;</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
</div>
<span class="n">printNewObjects</span> <span class="o">=</span> <span class="n">pno</span> <span class="o">=</span> <span class="n">printGcObjects</span>

<span class="c">#@+node:ekr.20060205043324.1: *3* printGcSummary</span>
<div class="viewcode-block" id="printGcSummary"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.printGcSummary">[docs]</a><span class="k">def</span> <span class="nf">printGcSummary</span> <span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>

    <span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">_callerName</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">g</span><span class="o">.</span><span class="n">enable_gc_debug</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">garbage</span><span class="p">)</span>
        <span class="n">n2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gc</span><span class="o">.</span><span class="n">get_objects</span><span class="p">())</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: printGCSummary: garbage: </span><span class="si">%d</span><span class="s">, objects: </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">n2</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
<span class="c">#@+node:ekr.20060127165509: *3* printGcVerbose</span>
<span class="c"># WARNING: the id trick is not proper because newly allocated objects</span>
<span class="c">#          can have the same address as old objets.</span>
</div>
<div class="viewcode-block" id="printGcVerbose"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.printGcVerbose">[docs]</a><span class="k">def</span> <span class="nf">printGcVerbose</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>

    <span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">_callerName</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">global</span> <span class="n">lastObjectsDict</span>
    <span class="n">objects</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">get_objects</span><span class="p">()</span>
    <span class="n">newObjects</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">objects</span> <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lastObjectsDict</span><span class="p">]</span>
    <span class="n">lastObjectsDict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">:</span>
        <span class="n">lastObjectsDict</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">o</span><span class="p">)]</span><span class="o">=</span><span class="n">o</span>

    <span class="n">dicts</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">seqs</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">newObjects</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">newObjects</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">({}):</span> <span class="n">dicts</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">type</span><span class="p">(()),</span><span class="nb">type</span><span class="p">([])):</span>
            <span class="c">#g.pr(id(o),repr(o))</span>
            <span class="n">seqs</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c">#else:</span>
        <span class="c">#    g.pr(o)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;=&#39;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
    <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;dicts: </span><span class="si">%d</span><span class="s">, sequences: </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dicts</span><span class="p">,</span><span class="n">seqs</span><span class="p">))</span>
    <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">: </span><span class="si">%d</span><span class="s"> new, </span><span class="si">%d</span><span class="s"> total objects&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">newObjects</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">objects</span><span class="p">)))</span>
    <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
<span class="c">#@-others</span>
<span class="c">#@+node:ekr.20031218072017.3139: ** Hooks &amp; plugins (leoGlobals)</span>
<span class="c">#@+node:ekr.20031218072017.1315: *3* idle time functions (leoGlobals)</span>
<span class="c">#@+node:EKR.20040602125018: *4* enableIdleTimeHook</span>
<span class="c">#@+at Enables the &quot;idle&quot; hook.</span>
<span class="c"># After enableIdleTimeHook is called, Leo will call the &quot;idle&quot; hook</span>
<span class="c"># approximately every g.idleTimeDelay milliseconds.</span>
<span class="c">#@@c</span>
</div>
<div class="viewcode-block" id="enableIdleTimeHook"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.enableIdleTimeHook">[docs]</a><span class="k">def</span> <span class="nf">enableIdleTimeHook</span><span class="p">(</span><span class="n">idleTimeDelay</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>

    <span class="c"># g.trace(idleTimeDelay)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">idleTimeHook</span><span class="p">:</span>
        <span class="c"># g.trace(&#39;start idle-time hook: %d msec.&#39; % idleTimeDelay)</span>
        <span class="c"># Start idle-time processing only after the first idle-time event.</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">setIdleTimeHook</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">idleTimeHookHandler</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">afterHandler</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">idleTimeHookHandler</span>

    <span class="c"># 1/4/05: Always update these.</span>
    <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">idleTimeHook</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">idleTimeDelay</span> <span class="o">=</span> <span class="n">idleTimeDelay</span> <span class="c"># Delay in msec.</span>
<span class="c">#@+node:EKR.20040602125018.1: *4* disableIdleTimeHook</span>
<span class="c"># Disables the &quot;idle&quot; hook.</span></div>
<div class="viewcode-block" id="disableIdleTimeHook"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.disableIdleTimeHook">[docs]</a><span class="k">def</span> <span class="nf">disableIdleTimeHook</span><span class="p">():</span>

    <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">idleTimeHook</span> <span class="o">=</span> <span class="bp">False</span>
<span class="c">#@+node:EKR.20040602125018.2: *4* idleTimeHookHandler</span>
<span class="c"># An internal routine used to dispatch the &quot;idle&quot; hook.</span></div>
<span class="n">trace_count</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="idleTimeHookHandler"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.idleTimeHookHandler">[docs]</a><span class="k">def</span> <span class="nf">idleTimeHookHandler</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">):</span>

    <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

    <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="c"># Do not use g.trace here!</span>
        <span class="k">global</span> <span class="n">trace_count</span> <span class="p">;</span> <span class="n">trace_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;idleTimeHookHandler&#39;</span><span class="p">,</span><span class="n">trace_count</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace_count</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">windowList</span><span class="p">:</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">c</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;idleTimeHookHandler&quot;</span><span class="p">,</span><span class="n">trace_count</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">())</span>

    <span class="c"># New for Python 2.3: may be called during shutdown.</span>
    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">killed</span><span class="p">:</span> <span class="k">return</span>

    <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">windowList</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">c</span>
        <span class="c"># Do NOT compute c.currentPosition.</span>
        <span class="c"># This would be a MAJOR leak of positions.</span>
        <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&quot;idle&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>

    <span class="c"># Requeue this routine after g.app.idleTimeDelay msec.</span>
    <span class="c"># (This delay is set by g.enableIdleTimeHook.)</span>
    <span class="c"># Faster requeues overload the system.</span>
    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">idleTimeHook</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">setIdleTimeHookAfterDelay</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">idleTimeHookHandler</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">afterHandler</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">idleTimeHookHandler</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">afterHandler</span> <span class="o">=</span> <span class="bp">None</span>
<span class="c">#@+node:ekr.20101028131948.5860: *3* g.act_on_node</span></div>
<div class="viewcode-block" id="dummy_act_on_node"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.dummy_act_on_node">[docs]</a><span class="k">def</span> <span class="nf">dummy_act_on_node</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">event</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="c"># This dummy definition keeps pylint happy.</span>
<span class="c"># Plugins can change this.</span></div>
<span class="n">act_on_node</span> <span class="o">=</span> <span class="n">dummy_act_on_node</span>
<span class="c">#@+node:ekr.20031218072017.1596: *3* g.doHook</span>
<span class="c">#@+at This global function calls a hook routine.  Hooks are identified by the tag param.</span>
<span class="c"># Returns the value returned by the hook routine, or None if the there is an exception.</span>
<span class="c"># </span>
<span class="c"># We look for a hook routine in three places:</span>
<span class="c"># 1. c.hookFunction</span>
<span class="c"># 2. app.hookFunction</span>
<span class="c"># 3. leoPlugins.doPlugins()</span>
<span class="c"># We set app.hookError on all exceptions.  Scripts may reset app.hookError to try again.</span>
<span class="c">#@@c</span>

<div class="viewcode-block" id="doHook"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.doHook">[docs]</a><span class="k">def</span> <span class="nf">doHook</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">keywords</span><span class="p">):</span>

    <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="p">;</span> <span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">killed</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">hookError</span><span class="p">:</span> <span class="c"># or (g.app.gui and g.app.gui.isNullGui):</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
        <span class="c"># A minor error in Leo&#39;s core.</span>
        <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;***ignoring args param.  tag = </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">tag</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">use_plugins</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;open0&#39;</span><span class="p">,</span><span class="s">&#39;start1&#39;</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Plugins disabled: use_plugins is 0 in a leoSettings.leo file.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="c"># Get the hook handler function.  Usually this is doPlugins.</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">keywords</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;c&quot;</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">hookFunction</span><span class="p">)</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">hookFunction</span>

    <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="p">(</span><span class="n">verbose</span> <span class="ow">or</span> <span class="n">tag</span> <span class="o">!=</span> <span class="s">&#39;idle&#39;</span><span class="p">):</span>
        <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;tag&#39;</span><span class="p">,</span><span class="n">tag</span><span class="p">,</span><span class="s">&#39;f&#39;</span><span class="p">,</span><span class="n">f</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">hookFunction</span> <span class="o">=</span> <span class="n">f</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">pluginsController</span><span class="o">.</span><span class="n">doPlugins</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c"># Pass the hook to the hook handler.</span>
        <span class="c"># g.pr(&#39;doHook&#39;,f.__name__,keywords.get(&#39;c&#39;))</span>
        <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="n">keywords</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">hookError</span> <span class="o">=</span> <span class="bp">True</span> <span class="c"># Supress this function.</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">idleTimeHook</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># Supress idle-time hook</span>
        <span class="k">return</span> <span class="bp">None</span> <span class="c"># No return value</span>
<span class="c">#@+node:ville.20090521164644.5924: *3* g.command (decorator for creating global commands)</span></div>
<div class="viewcode-block" id="command"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.command">[docs]</a><span class="k">class</span> <span class="nc">command</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Decorator to create global commands &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Registration for command &#39;name&#39;</span>

<span class="sd">        kwargs reserved for future use (shortcut, button, ...?)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">kwargs</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">func</span><span class="p">):</span>
        <span class="c"># register command for all future commanders</span>
        <span class="k">if</span> <span class="n">g</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">global_commands_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
            <span class="c"># ditto for all current commanders</span>
            <span class="k">for</span> <span class="n">co</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">commanders</span><span class="p">():</span>
                <span class="n">co</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">registerCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">shortcut</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">func</span><span class="p">,</span> <span class="n">pane</span><span class="o">=</span><span class="s">&#39;all&#39;</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;@command decorator inside leoGlobals.py&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span>


<span class="c">#@+node:ville.20120502221057.7500: *3* g.childrenModifiedSet, g.contentModifiedSet</span></div>
<span class="n">childrenModifiedSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<span class="n">contentModifiedSet</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<span class="c">#@+node:ekr.20100910075900.5950: *3* Wrappers for g.app.pluginController methods</span>
<span class="c"># Important: we can not define g.pc here!</span>

<span class="c">#@+node:ekr.20100910075900.5951: *4* Loading &amp; registration</span>
<div class="viewcode-block" id="loadOnePlugin"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.loadOnePlugin">[docs]</a><span class="k">def</span> <span class="nf">loadOnePlugin</span> <span class="p">(</span><span class="n">pluginName</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">pc</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">pluginsController</span>
    <span class="k">return</span> <span class="n">pc</span><span class="o">.</span><span class="n">loadOnePlugin</span><span class="p">(</span><span class="n">pluginName</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="registerExclusiveHandler"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.registerExclusiveHandler">[docs]</a><span class="k">def</span> <span class="nf">registerExclusiveHandler</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>
    <span class="n">pc</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">pluginsController</span>
    <span class="k">return</span> <span class="n">pc</span><span class="o">.</span><span class="n">registerExclusiveHandler</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="registerHandler"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.registerHandler">[docs]</a><span class="k">def</span> <span class="nf">registerHandler</span> <span class="p">(</span><span class="n">tags</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>
    <span class="n">pc</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">pluginsController</span>
    <span class="k">return</span> <span class="n">pc</span><span class="o">.</span><span class="n">registerHandler</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="plugin_signon"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.plugin_signon">[docs]</a><span class="k">def</span> <span class="nf">plugin_signon</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">pc</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">pluginsController</span>
    <span class="k">return</span> <span class="n">pc</span><span class="o">.</span><span class="n">plugin_signon</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span><span class="n">verbose</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="unloadOnePlugin"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.unloadOnePlugin">[docs]</a><span class="k">def</span> <span class="nf">unloadOnePlugin</span> <span class="p">(</span><span class="n">moduleOrFileName</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">pc</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">pluginsController</span>
    <span class="k">return</span> <span class="n">pc</span><span class="o">.</span><span class="n">unloadOnePlugin</span><span class="p">(</span><span class="n">moduleOrFileName</span><span class="p">,</span><span class="n">verbose</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="unregisterHandler"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.unregisterHandler">[docs]</a><span class="k">def</span> <span class="nf">unregisterHandler</span> <span class="p">(</span><span class="n">tags</span><span class="p">,</span><span class="n">fn</span><span class="p">):</span>
    <span class="n">pc</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">pluginsController</span>
    <span class="k">return</span> <span class="n">pc</span><span class="o">.</span><span class="n">unregisterHandler</span><span class="p">(</span><span class="n">tags</span><span class="p">,</span><span class="n">fn</span><span class="p">)</span>
<span class="c">#@+node:ekr.20100910075900.5952: *4* Information</span></div>
<div class="viewcode-block" id="getHandlersForTag"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.getHandlersForTag">[docs]</a><span class="k">def</span> <span class="nf">getHandlersForTag</span><span class="p">(</span><span class="n">tags</span><span class="p">):</span>
    <span class="n">pc</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">pluginsController</span>
    <span class="k">return</span> <span class="n">pc</span><span class="o">.</span><span class="n">getHandlersForTag</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="getLoadedPlugins"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.getLoadedPlugins">[docs]</a><span class="k">def</span> <span class="nf">getLoadedPlugins</span><span class="p">():</span>
    <span class="n">pc</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">pluginsController</span>
    <span class="k">return</span> <span class="n">pc</span><span class="o">.</span><span class="n">getLoadedPlugins</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="getPluginModule"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.getPluginModule">[docs]</a><span class="k">def</span> <span class="nf">getPluginModule</span><span class="p">(</span><span class="n">moduleName</span><span class="p">):</span>
    <span class="n">pc</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">pluginsController</span>
    <span class="k">return</span> <span class="n">pc</span><span class="o">.</span><span class="n">getPluginModule</span><span class="p">(</span><span class="n">moduleName</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="pluginIsLoaded"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.pluginIsLoaded">[docs]</a><span class="k">def</span> <span class="nf">pluginIsLoaded</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="n">pc</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">pluginsController</span>
    <span class="k">return</span> <span class="n">pc</span><span class="o">.</span><span class="n">isLoaded</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

<span class="c">#@+node:ekr.20031218072017.3145: ** Most common functions... (leoGlobals.py)</span>
<span class="c"># These are guaranteed always to exist for scripts.</span>
<span class="c">#@+node:ekr.20120928142052.10116: *3* g.actualColor</span></div>
<div class="viewcode-block" id="actualColor"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.actualColor">[docs]</a><span class="k">def</span> <span class="nf">actualColor</span><span class="p">(</span><span class="n">color</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">color</span>

    <span class="n">c</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">c</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;black&#39;</span><span class="p">:</span><span class="s">&#39;log_text_foreground_color&#39;</span><span class="p">,</span>
        <span class="s">&#39;blue&#39;</span><span class="p">:</span> <span class="s">&#39;log_warning_color&#39;</span><span class="p">,</span>
        <span class="s">&#39;red&#39;</span><span class="p">:</span>  <span class="s">&#39;log_error_color&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">setting</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>

    <span class="c"># Bug fix: 2012/10/17: c.config may not yet exist.</span>
    <span class="k">if</span> <span class="n">c</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span> <span class="ow">and</span> <span class="n">setting</span><span class="p">:</span>
        <span class="n">color2</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getColor</span><span class="p">(</span><span class="n">setting</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">color2</span> <span class="o">=</span> <span class="n">color</span>

    <span class="c"># g.trace(color,color2)</span>
    <span class="k">return</span> <span class="n">color2</span>
<span class="c">#@+node:ekr.20031218072017.3147: *3* g.choose (deprecated)</span></div>
<div class="viewcode-block" id="choose"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.choose">[docs]</a><span class="k">def</span> <span class="nf">choose</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span> <span class="c"># warning: evaluates all arguments</span>

    <span class="k">if</span> <span class="n">cond</span><span class="p">:</span> <span class="k">return</span> <span class="n">a</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">b</span>
<span class="c">#@+node:ekr.20080821073134.2: *3* g.doKeywordArgs</span></div>
<div class="viewcode-block" id="doKeywordArgs"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.doKeywordArgs">[docs]</a><span class="k">def</span> <span class="nf">doKeywordArgs</span> <span class="p">(</span><span class="n">keys</span><span class="p">,</span><span class="n">d</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Return a result dict that is a copy of the keys dict</span>
<span class="sd">    with missing items replaced by defaults in d dict.&#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">default_val</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">isBool</span> <span class="o">=</span> <span class="n">default_val</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">isBool</span> <span class="ow">and</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span><span class="s">&#39;True&#39;</span><span class="p">,</span><span class="s">&#39;true&#39;</span><span class="p">):</span>
            <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">isBool</span> <span class="ow">and</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span><span class="s">&#39;False&#39;</span><span class="p">,</span><span class="s">&#39;false&#39;</span><span class="p">):</span>
            <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="n">val</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_val</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">return</span> <span class="n">result</span> 
<span class="c">#@+node:ekr.20031218072017.1474: *3* g.enl, ecnl &amp; ecnls</span></div>
<div class="viewcode-block" id="ecnl"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.ecnl">[docs]</a><span class="k">def</span> <span class="nf">ecnl</span><span class="p">(</span><span class="n">tabName</span><span class="o">=</span><span class="s">&#39;Log&#39;</span><span class="p">):</span>
    <span class="n">g</span><span class="o">.</span><span class="n">ecnls</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">tabName</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ecnls"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.ecnls">[docs]</a><span class="k">def</span> <span class="nf">ecnls</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">tabName</span><span class="o">=</span><span class="s">&#39;Log&#39;</span><span class="p">):</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">log</span>
    <span class="k">if</span> <span class="n">log</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">log</span><span class="o">.</span><span class="n">isNull</span><span class="p">:</span>
        <span class="k">while</span> <span class="n">log</span><span class="o">.</span><span class="n">newlines</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">enl</span><span class="p">(</span><span class="n">tabName</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="enl"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.enl">[docs]</a><span class="k">def</span> <span class="nf">enl</span><span class="p">(</span><span class="n">tabName</span><span class="o">=</span><span class="s">&#39;Log&#39;</span><span class="p">):</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">log</span>
    <span class="k">if</span> <span class="n">log</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">log</span><span class="o">.</span><span class="n">isNull</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">newlines</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">log</span><span class="o">.</span><span class="n">putnl</span><span class="p">(</span><span class="n">tabName</span><span class="p">)</span>
<span class="c">#@+node:ekr.20100914094836.5892: *3* g.error, g.note, g.warning, g.red, g.blue</span></div>
<div class="viewcode-block" id="blue"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.blue">[docs]</a><span class="k">def</span> <span class="nf">blue</span> <span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">):</span>
    <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">g</span><span class="o">.</span><span class="n">actualColor</span><span class="p">(</span><span class="s">&#39;blue&#39;</span><span class="p">),</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="error"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.error">[docs]</a><span class="k">def</span> <span class="nf">error</span> <span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">):</span>
    <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">g</span><span class="o">.</span><span class="n">actualColor</span><span class="p">(</span><span class="s">&#39;red&#39;</span><span class="p">),</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="note"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.note">[docs]</a><span class="k">def</span> <span class="nf">note</span> <span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">):</span>
    <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">g</span><span class="o">.</span><span class="n">actualColor</span><span class="p">(</span><span class="s">&#39;black&#39;</span><span class="p">),</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="red"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.red">[docs]</a><span class="k">def</span> <span class="nf">red</span> <span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">):</span>
    <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">g</span><span class="o">.</span><span class="n">actualColor</span><span class="p">(</span><span class="s">&#39;red&#39;</span><span class="p">),</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="warning"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.warning">[docs]</a><span class="k">def</span> <span class="nf">warning</span> <span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">):</span>
    <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">g</span><span class="o">.</span><span class="n">actualColor</span><span class="p">(</span><span class="s">&#39;blue&#39;</span><span class="p">),</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">)</span>
<span class="c">#@+node:ekr.20070626132332: *3* g.es</span></div>
<div class="viewcode-block" id="es"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.es">[docs]</a><span class="k">def</span> <span class="nf">es</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Put all non-keyword args to the log pane.</span>
<span class="sd">    The first, third, fifth, etc. arg translated by g.translateString.</span>
<span class="sd">    Supports color, comma, newline, spaces and tabName keyword arguments.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">app</span> <span class="ow">or</span> <span class="n">app</span><span class="o">.</span><span class="n">killed</span><span class="p">:</span> <span class="k">return</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">log</span>

    <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="c"># Effective for debugging.</span>
        <span class="k">print</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;***es&#39;</span><span class="p">,</span><span class="n">args</span><span class="p">,</span><span class="n">keys</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;***es&#39;</span><span class="p">,</span><span class="s">&#39;logInited&#39;</span><span class="p">,</span><span class="n">app</span><span class="o">.</span><span class="n">logInited</span><span class="p">,</span><span class="s">&#39;log&#39;</span><span class="p">,</span><span class="n">log</span> <span class="ow">and</span> <span class="nb">id</span><span class="p">(</span><span class="n">log</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;***es&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>

    <span class="c"># Compute the effective args.</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;color&#39;</span><span class="p">:</span><span class="bp">None</span><span class="p">,</span>
        <span class="s">&#39;commas&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span>
        <span class="s">&#39;newline&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
        <span class="s">&#39;spaces&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
        <span class="s">&#39;tabName&#39;</span><span class="p">:</span><span class="s">&#39;Log&#39;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">doKeywordArgs</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span><span class="n">d</span><span class="p">)</span>
    <span class="n">color</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;color&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">color</span> <span class="o">==</span> <span class="s">&#39;suppress&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="c"># New in 4.3.</span>
    <span class="k">elif</span> <span class="n">log</span> <span class="ow">and</span> <span class="n">color</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">actualColor</span><span class="p">(</span><span class="s">&#39;black&#39;</span><span class="p">)</span>
        
    <span class="n">color</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">actualColor</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
        
    <span class="n">tabName</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;tabName&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;Log&#39;</span>
    <span class="n">newline</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;newline&#39;</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">translateArgs</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="n">d</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">batchMode</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">log</span><span class="p">:</span>
            <span class="n">app</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">log</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">log</span><span class="o">.</span><span class="n">isNull</span><span class="p">:</span>
            <span class="c"># This makes the output of unit tests match the output of scripts.</span>
            <span class="c"># s = g.toEncodedString(s,&#39;ascii&#39;)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">newline</span><span class="o">=</span><span class="n">newline</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">log</span> <span class="ow">and</span> <span class="n">app</span><span class="o">.</span><span class="n">logInited</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span><span class="n">tabName</span><span class="o">=</span><span class="n">tabName</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">newlines</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">newlines</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">newline</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">ecnl</span><span class="p">(</span><span class="n">tabName</span><span class="o">=</span><span class="n">tabName</span><span class="p">)</span> <span class="c"># only valid here</span>
    <span class="c"># 2012/05/20: Don&#39;t do this.</span>
    <span class="c"># elif app.logInited:</span>
        <span class="c"># print(s.rstrip()) # Happens only rarely.</span>
    <span class="k">elif</span> <span class="n">newline</span><span class="p">:</span>
        <span class="n">app</span><span class="o">.</span><span class="n">logWaiting</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">s</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="n">color</span><span class="p">),)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">app</span><span class="o">.</span><span class="n">logWaiting</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">s</span><span class="p">,</span><span class="n">color</span><span class="p">),)</span>
<span class="c">#@+node:ekr.20050707064040: *3* g.es_print</span>
<span class="c"># see: http://www.diveintopython.org/xml_processing/unicode.html</span>
</div>
<div class="viewcode-block" id="es_print"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.es_print">[docs]</a><span class="k">def</span> <span class="nf">es_print</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Print all non-keyword args, and put them to the log pane.</span>
<span class="sd">    The first, third, fifth, etc. arg translated by g.translateString.</span>
<span class="sd">    Supports color, comma, newline, spaces and tabName keyword arguments.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">)</span>
<span class="c">#@+node:ekr.20050707065530: *3* g.es_trace</span></div>
<div class="viewcode-block" id="es_trace"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.es_trace">[docs]</a><span class="k">def</span> <span class="nf">es_trace</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="s">&#39;ascii&#39;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">)</span>
<span class="c">#@+node:ekr.20100126062623.6240: *3* g.internalError</span></div>
<div class="viewcode-block" id="internalError"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.internalError">[docs]</a><span class="k">def</span> <span class="nf">internalError</span> <span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>

    <span class="n">callers</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
    <span class="n">caller</span> <span class="o">=</span> <span class="n">callers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Internal Leo error in&#39;</span><span class="p">,</span><span class="n">caller</span><span class="p">)</span>
    <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;Called from&#39;</span><span class="p">,</span><span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">callers</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
<span class="c">#@+node:ekr.20090128083459.82: *3* g.posList</span></div>
<div class="viewcode-block" id="posList"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.posList">[docs]</a><span class="k">class</span> <span class="nc">posList</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
    <span class="c">#@+&lt;&lt; docstring for posList &gt;&gt;</span>
    <span class="c">#@+node:ekr.20090130114732.2: *4* &lt;&lt; docstring for posList &gt;&gt;</span>
    <span class="sd">&#39;&#39;&#39;A subclass of list for creating and selecting lists of positions.</span>

<span class="sd">        This is deprecated, use leoNodes.poslist instead!</span>

<span class="sd">        aList = g.posList(c)</span>
<span class="sd">            # Creates a posList containing all positions in c.</span>

<span class="sd">        aList = g.posList(c,aList2)</span>
<span class="sd">            # Creates a posList from aList2.</span>

<span class="sd">        aList2 = aList.select(pattern,regex=False,removeClones=True)</span>
<span class="sd">            # Creates a posList containing all positions p in aList</span>
<span class="sd">            # such that p.h matches the pattern.</span>
<span class="sd">            # The pattern is a regular expression if regex is True.</span>
<span class="sd">            # if removeClones is True, all positions p2 are removed</span>
<span class="sd">            # if a position p is already in the list and p2.v == p.v.</span>

<span class="sd">        aList.dump(sort=False,verbose=False)</span>
<span class="sd">            # Prints all positions in aList, sorted if sort is True.</span>
<span class="sd">            # Prints p.h, or repr(p) if verbose is True.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c">#@-&lt;&lt; docstring for posList &gt;&gt;</span>
    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">aList</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">c</span>
        <span class="nb">list</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="c"># Init the base class</span>
        <span class="k">if</span> <span class="n">aList</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">all_positions</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

<div class="viewcode-block" id="posList.dump"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.posList.dump">[docs]</a>    <span class="k">def</span> <span class="nf">dump</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sort</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">listToString</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">listToString</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">h</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">],</span><span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="posList.select"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.posList.select">[docs]</a>    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pat</span><span class="p">,</span><span class="n">regex</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">removeClones</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return a new posList containing all positions</span>
<span class="sd">        in self that match the given pattern.&#39;&#39;&#39;</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">aList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">regex</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">):</span>
                    <span class="n">aList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">pat</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">aList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">removeClones</span><span class="p">:</span>
            <span class="n">aList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">removeClones</span><span class="p">(</span><span class="n">aList</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">posList</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">aList</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="posList.removeClones"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.posList.removeClones">[docs]</a>    <span class="k">def</span> <span class="nf">removeClones</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">aList</span><span class="p">):</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="p">{}</span> <span class="p">;</span> <span class="n">aList2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="n">seen</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span>
                <span class="n">aList2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">aList2</span>
<span class="c">#@+node:ekr.20080710101653.1: *3* g.pr</span>
<span class="c"># see: http://www.diveintopython.org/xml_processing/unicode.html</span>
</div></div>
<span class="n">pr_warning_given</span> <span class="o">=</span> <span class="bp">False</span>

<div class="viewcode-block" id="pr"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.pr">[docs]</a><span class="k">def</span> <span class="nf">pr</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Print all non-keyword args, and put them to the log pane.</span>
<span class="sd">    The first, third, fifth, etc. arg translated by g.translateString.</span>
<span class="sd">    Supports color, comma, newline, spaces and tabName keyword arguments.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">print_immediately</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">app</span> <span class="c"># True: good for debugging.</span>

    <span class="c"># Compute the effective args.</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;commas&#39;</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s">&#39;newline&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span><span class="s">&#39;spaces&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">}</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">doKeywordArgs</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span><span class="n">d</span><span class="p">)</span>
    <span class="n">newline</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;newline&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;win&#39;</span><span class="p">):</span>
        <span class="n">encoding</span> <span class="o">=</span> <span class="s">&#39;ascii&#39;</span> <span class="c"># 2011/11/9.</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span><span class="s">&#39;encoding&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">encoding</span><span class="p">:</span>
        <span class="c"># sys.stdout is a TextIOWrapper with a particular encoding.</span>
        <span class="n">encoding</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">encoding</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">encoding</span> <span class="o">=</span> <span class="s">&#39;utf-8&#39;</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">translateArgs</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="n">d</span><span class="p">)</span> <span class="c"># Translates everything to unicode.</span>

    <span class="c"># Add a newline unless we are going to queue the message.</span>
    <span class="k">if</span> <span class="n">newline</span> <span class="ow">and</span> <span class="p">(</span><span class="n">print_immediately</span> <span class="ow">or</span> <span class="n">app</span> <span class="ow">and</span> <span class="n">app</span><span class="o">.</span><span class="n">logInited</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>

    <span class="k">if</span> <span class="n">isPython3</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">encoding</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span><span class="s">&#39;utf-16&#39;</span><span class="p">):</span>
            <span class="n">s2</span> <span class="o">=</span> <span class="n">s</span> <span class="c"># There can be no problem.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Carefully convert s to the encoding.</span>
            <span class="n">s3</span> <span class="o">=</span> <span class="n">toEncodedString</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span><span class="n">reportErrors</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">s2</span> <span class="o">=</span> <span class="n">toUnicode</span><span class="p">(</span><span class="n">s3</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">,</span><span class="n">reportErrors</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="n">toEncodedString</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">encoding</span><span class="p">,</span><span class="n">reportErrors</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">print_immediately</span><span class="p">:</span>
        <span class="c"># Good for debugging: prints messages immediately.</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">app</span>
        <span class="c"># Good for production: queues &#39;reading settings&#39; until after signon.</span>
        <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">logInited</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span> <span class="c"># Bug fix: 2012/11/13.</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">app</span><span class="o">.</span><span class="n">printWaiting</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span>
<span class="c">#@+node:ekr.20031218072017.2317: *3* g.trace</span></div>
<div class="viewcode-block" id="trace"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.trace">[docs]</a><span class="k">def</span> <span class="nf">trace</span> <span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">):</span>

    <span class="c"># Don&#39;t use g here: in standalone mode g is a nullObject!</span>

    <span class="c"># Compute the effective args.</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;align&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;before&#39;</span><span class="p">:</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="s">&#39;newline&#39;</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span><span class="s">&#39;caller_level&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">doKeywordArgs</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span><span class="n">d</span><span class="p">)</span>
    <span class="n">newline</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;newline&#39;</span><span class="p">)</span>
    <span class="n">align</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;align&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">caller_level</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;caller_level&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

    <span class="c"># Compute the caller name.</span>
    <span class="k">try</span><span class="p">:</span> <span class="c"># get the function name from the call stack.</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">(</span><span class="n">caller_level</span><span class="p">)</span> <span class="c"># The stack frame, one level up.</span>
        <span class="n">code1</span> <span class="o">=</span> <span class="n">f1</span><span class="o">.</span><span class="n">f_code</span> <span class="c"># The code object</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">code1</span><span class="o">.</span><span class="n">co_name</span> <span class="c"># The code name</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;&lt;module&gt;&#39;</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.pyc&#39;</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c"># Pad the caller name.</span>
    <span class="k">if</span> <span class="n">align</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">align</span><span class="p">):</span>
        <span class="n">pad</span> <span class="o">=</span> <span class="s">&#39; &#39;</span> <span class="o">*</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">align</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">align</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="n">pad</span>
        <span class="k">else</span><span class="p">:</span>         <span class="n">name</span> <span class="o">=</span> <span class="n">pad</span> <span class="o">+</span> <span class="n">name</span>

    <span class="c"># Munge *args into s.</span>
    <span class="c"># print (&#39;g.trace:args...&#39;)</span>
    <span class="c"># for z in args: print (g.isString(z),repr(z))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">isString</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">isBytes</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">toUnicode</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">arg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;before&#39;</span><span class="p">)</span><span class="o">+</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="n">pr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">newline</span><span class="o">=</span><span class="n">newline</span><span class="p">)</span>
<span class="c">#@+node:ekr.20080220111323: *3* g.translateArgs</span></div>
<span class="n">console_encoding</span> <span class="o">=</span> <span class="bp">None</span>

<div class="viewcode-block" id="translateArgs"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.translateArgs">[docs]</a><span class="k">def</span> <span class="nf">translateArgs</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="n">d</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Return the concatenation of s and all args,</span>

<span class="sd">    with odd args translated.&#39;&#39;&#39;</span>

    <span class="k">global</span> <span class="n">console_encoding</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">console_encoding</span><span class="p">:</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">getdefaultencoding</span><span class="p">()</span>
        <span class="n">console_encoding</span> <span class="o">=</span> <span class="n">isValidEncoding</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="ow">and</span> <span class="n">e</span> <span class="ow">or</span> <span class="s">&#39;utf-8&#39;</span>
        <span class="c"># print &#39;translateArgs&#39;,console_encoding</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">spaces</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;spaces&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c"># print(&#39;g.translateArgs: arg&#39;,arg,type(arg),g.isString(arg),&#39;will trans&#39;,(n%2)==1)</span>

        <span class="c"># First, convert to unicode.</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">):</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">toUnicode</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span><span class="n">console_encoding</span><span class="p">)</span>

        <span class="c"># Now translate.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isString</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">n</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">translateString</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c"># The arg is an untranslated string.</span>

        <span class="k">if</span> <span class="n">arg</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">spaces</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

    <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="c">#@+node:ekr.20060810095921: *3* g.translateString &amp; tr</span></div>
<div class="viewcode-block" id="translateString"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.translateString">[docs]</a><span class="k">def</span> <span class="nf">translateString</span> <span class="p">(</span><span class="n">s</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Return the translated text of s.&#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">isPython3</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isString</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">app</span> <span class="ow">and</span> <span class="n">app</span><span class="o">.</span><span class="n">translateToUpperCase</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">gettext</span><span class="o">.</span><span class="n">gettext</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">s</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">app</span> <span class="ow">and</span> <span class="n">app</span><span class="o">.</span><span class="n">translateToUpperCase</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">gettext</span><span class="o">.</span><span class="n">gettext</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</div>
<span class="n">tr</span> <span class="o">=</span> <span class="n">translateString</span>
<span class="c">#@+node:ekr.20031218072017.3150: *3* g.windows</span>
<div class="viewcode-block" id="windows"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.windows">[docs]</a><span class="k">def</span> <span class="nf">windows</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">app</span> <span class="ow">and</span> <span class="n">app</span><span class="o">.</span><span class="n">windowList</span>
<span class="c">#@+node:ekr.20031218072017.2145: ** os.path wrappers (leoGlobals.py)</span>
<span class="c">#@+at Note: all these methods return Unicode strings. It is up to the user to</span>
<span class="c"># convert to an encoded string as needed, say when opening a file.</span>
<span class="c">#@+node:ekr.20031218072017.2146: *3* g.os_path_abspath</span></div>
<div class="viewcode-block" id="os_path_abspath"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.os_path_abspath">[docs]</a><span class="k">def</span> <span class="nf">os_path_abspath</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Convert a path to an absolute path.&quot;&quot;&quot;</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicodeFileEncoding</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicodeFileEncoding</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">path</span>
<span class="c">#@+node:ekr.20031218072017.2147: *3* g.os_path_basename</span></div>
<div class="viewcode-block" id="os_path_basename"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.os_path_basename">[docs]</a><span class="k">def</span> <span class="nf">os_path_basename</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Return the second half of the pair returned by split(path).&quot;&quot;&quot;</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicodeFileEncoding</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicodeFileEncoding</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">path</span>
<span class="c">#@+node:ekr.20031218072017.2148: *3* g.os_path_dirname</span></div>
<div class="viewcode-block" id="os_path_dirname"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.os_path_dirname">[docs]</a><span class="k">def</span> <span class="nf">os_path_dirname</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Return the first half of the pair returned by split(path).&quot;&quot;&quot;</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicodeFileEncoding</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicodeFileEncoding</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">path</span>
<span class="c">#@+node:ekr.20031218072017.2149: *3* g.os_path_exists</span></div>
<div class="viewcode-block" id="os_path_exists"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.os_path_exists">[docs]</a><span class="k">def</span> <span class="nf">os_path_exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Return True if path exists.&quot;&quot;&quot;</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicodeFileEncoding</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="c">#@+node:ekr.20080922124033.6: *3* g.os_path_expandExpression</span></div>
<div class="viewcode-block" id="os_path_expandExpression"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.os_path_expandExpression">[docs]</a><span class="k">def</span> <span class="nf">os_path_expandExpression</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Expand {{anExpression}} in c&#39;s context.&#39;&#39;&#39;</span>

    <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;c&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;can not happen: no c&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">s</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;no s&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;{{&#39;</span><span class="p">)</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;}}&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">j</span><span class="p">:</span>
        <span class="n">exp</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">exp</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
                <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;c&#39;</span><span class="p">:</span><span class="n">c</span><span class="p">,</span><span class="s">&#39;g&#39;</span><span class="p">:</span><span class="n">g</span><span class="p">,</span><span class="s">&#39;p&#39;</span><span class="p">:</span><span class="n">p</span><span class="p">,</span><span class="s">&#39;os&#39;</span><span class="p">:</span><span class="n">os</span><span class="p">,</span><span class="s">&#39;sys&#39;</span><span class="p">:</span><span class="n">sys</span><span class="p">,}</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span><span class="n">d</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">:]</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;returns&#39;</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">(</span><span class="n">full</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span>
<span class="c">#@+node:ekr.20080921060401.13: *3* g.os_path_expanduser</span></div>
<div class="viewcode-block" id="os_path_expanduser"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.os_path_expanduser">[docs]</a><span class="k">def</span> <span class="nf">os_path_expanduser</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;wrap os.path.expanduser&quot;&quot;&quot;</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicodeFileEncoding</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">result</span>
<span class="c">#@+node:ekr.20080921060401.14: *3* g.os_path_finalize &amp; os_path_finalize_join</span></div>
<div class="viewcode-block" id="os_path_finalize"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.os_path_finalize">[docs]</a><span class="k">def</span> <span class="nf">os_path_finalize</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Expand &#39;~&#39;, then return os.path.normpath, os.path.abspath of the path.</span>

<span class="sd">    There is no corresponding os.path method&#39;&#39;&#39;</span>

    <span class="n">c</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;c&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">c</span><span class="p">:</span> <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_expandExpression</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">)</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_expanduser</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="c"># calling os.path.realpath here would cause problems in some situations.</span>
    <span class="k">return</span> <span class="n">path</span>
</div>
<div class="viewcode-block" id="os_path_finalize_join"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.os_path_finalize_join">[docs]</a><span class="k">def</span> <span class="nf">os_path_finalize_join</span> <span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Do os.path.join(*args), then finalize the result.&#39;&#39;&#39;</span>

    <span class="n">c</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;c&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">os_path_expandExpression</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">if</span> <span class="n">z</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
        <span class="n">g</span><span class="o">.</span><span class="n">os_path_join</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">)))</span> <span class="c"># Handles expanduser</span>
<span class="c">#@+node:ekr.20031218072017.2150: *3* g.os_path_getmtime</span></div>
<div class="viewcode-block" id="os_path_getmtime"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.os_path_getmtime">[docs]</a><span class="k">def</span> <span class="nf">os_path_getmtime</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Return the modification time of path.&quot;&quot;&quot;</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicodeFileEncoding</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="c">#@+node:ekr.20080729142651.2: *3* g.os_path_getsize</span></div>
<div class="viewcode-block" id="os_path_getsize"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.os_path_getsize">[docs]</a><span class="k">def</span> <span class="nf">os_path_getsize</span> <span class="p">(</span><span class="n">path</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Return the size of path.&#39;&#39;&#39;</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicodeFileEncoding</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="c">#@+node:ekr.20031218072017.2151: *3* g.os_path_isabs</span></div>
<div class="viewcode-block" id="os_path_isabs"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.os_path_isabs">[docs]</a><span class="k">def</span> <span class="nf">os_path_isabs</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Return True if path is an absolute path.&quot;&quot;&quot;</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicodeFileEncoding</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="c">#@+node:ekr.20031218072017.2152: *3* g.os_path_isdir</span></div>
<div class="viewcode-block" id="os_path_isdir"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.os_path_isdir">[docs]</a><span class="k">def</span> <span class="nf">os_path_isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Return True if the path is a directory.&quot;&quot;&quot;</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicodeFileEncoding</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="c">#@+node:ekr.20031218072017.2153: *3* g.os_path_isfile</span></div>
<div class="viewcode-block" id="os_path_isfile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.os_path_isfile">[docs]</a><span class="k">def</span> <span class="nf">os_path_isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Return True if path is a file.&quot;&quot;&quot;</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicodeFileEncoding</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="c">#@+node:ekr.20031218072017.2154: *3* g.os_path_join</span></div>
<div class="viewcode-block" id="os_path_join"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.os_path_join">[docs]</a><span class="k">def</span> <span class="nf">os_path_join</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">keys</span><span class="p">):</span>

    <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;c&#39;</span><span class="p">)</span>

    <span class="n">uargs</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">toUnicodeFileEncoding</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;1&#39;</span><span class="p">,</span><span class="n">uargs</span><span class="p">)</span>

    <span class="c"># Note:  This is exactly the same convention as used by getBaseDirectory.</span>
    <span class="k">if</span> <span class="n">uargs</span> <span class="ow">and</span> <span class="n">uargs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;!!&#39;</span><span class="p">:</span>
        <span class="n">uargs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadDir</span>
    <span class="k">elif</span> <span class="n">uargs</span> <span class="ow">and</span> <span class="n">uargs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;.&#39;</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;c&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">openDirectory</span><span class="p">:</span>
            <span class="n">uargs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">openDirectory</span>
            <span class="c"># g.trace(c.openDirectory)</span>

    <span class="n">uargs</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">os_path_expanduser</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">uargs</span> <span class="k">if</span> <span class="n">z</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;2&#39;</span><span class="p">,</span><span class="n">uargs</span><span class="p">)</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">uargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;3&#39;</span><span class="p">,</span><span class="n">path</span><span class="p">)</span>

    <span class="c"># May not be needed on some Pythons.</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicodeFileEncoding</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">path</span>
<span class="c">#@+node:ekr.20031218072017.2156: *3* g.os_path_normcase</span></div>
<div class="viewcode-block" id="os_path_normcase"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.os_path_normcase">[docs]</a><span class="k">def</span> <span class="nf">os_path_normcase</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Normalize the path&#39;s case.&quot;&quot;&quot;</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicodeFileEncoding</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normcase</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicodeFileEncoding</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">path</span>
<span class="c">#@+node:ekr.20031218072017.2157: *3* g.os_path_normpath</span></div>
<div class="viewcode-block" id="os_path_normpath"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.os_path_normpath">[docs]</a><span class="k">def</span> <span class="nf">os_path_normpath</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Normalize the path.&quot;&quot;&quot;</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicodeFileEncoding</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicodeFileEncoding</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">path</span>
<span class="c">#@+node:ekr.20080605064555.2: *3* g.os_path_realpath</span></div>
<div class="viewcode-block" id="os_path_realpath"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.os_path_realpath">[docs]</a><span class="k">def</span> <span class="nf">os_path_realpath</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicodeFileEncoding</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicodeFileEncoding</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">path</span>
<span class="c">#@+node:ekr.20031218072017.2158: *3* g.os_path_split</span></div>
<div class="viewcode-block" id="os_path_split"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.os_path_split">[docs]</a><span class="k">def</span> <span class="nf">os_path_split</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicodeFileEncoding</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="n">head</span><span class="p">,</span><span class="n">tail</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="n">head</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicodeFileEncoding</span><span class="p">(</span><span class="n">head</span><span class="p">)</span>
    <span class="n">tail</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicodeFileEncoding</span><span class="p">(</span><span class="n">tail</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">head</span><span class="p">,</span><span class="n">tail</span>
<span class="c">#@+node:ekr.20031218072017.2159: *3* g.os_path_splitext</span></div>
<div class="viewcode-block" id="os_path_splitext"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.os_path_splitext">[docs]</a><span class="k">def</span> <span class="nf">os_path_splitext</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicodeFileEncoding</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="n">head</span><span class="p">,</span><span class="n">tail</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="n">head</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicodeFileEncoding</span><span class="p">(</span><span class="n">head</span><span class="p">)</span>
    <span class="n">tail</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicodeFileEncoding</span><span class="p">(</span><span class="n">tail</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">head</span><span class="p">,</span><span class="n">tail</span>
<span class="c">#@+node:ekr.20090829140232.6036: *3* g.os_startfile</span></div>
<div class="viewcode-block" id="os_startfile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.os_startfile">[docs]</a><span class="k">def</span> <span class="nf">os_startfile</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTestDict</span><span class="p">[</span><span class="s">&#39;os_startfile&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">fname</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">fname</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">quoted_fname</span> <span class="o">=</span> <span class="s">&quot;&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">fname</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">quoted_fname</span> <span class="o">=</span> <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">fname</span>

    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;win&#39;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">startfile</span><span class="p">(</span><span class="n">quoted_fname</span><span class="p">)</span>
            <span class="c"># Exists only on Windows.</span>
    <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&#39;darwin&#39;</span><span class="p">:</span>
        <span class="c"># From Marc-Antoine Parent.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s">&#39;open&#39;</span><span class="p">,</span> <span class="n">quoted_fname</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c"># There may be a spurious &quot;Interrupted system call&quot;</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;open </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">quoted_fname</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># os.system(&#39;xdg-open &quot;%s&quot;&#39; % (fname))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s">&#39;xdg-open </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">quoted_fname</span><span class="p">),</span><span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;xdg-open </span><span class="si">%s</span><span class="s"> failed&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fname</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;error opening </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">fname</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
<span class="c">#@+node:ekr.20031218072017.2160: *3* g.toUnicodeFileEncoding</span></div>
<div class="viewcode-block" id="toUnicodeFileEncoding"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.toUnicodeFileEncoding">[docs]</a><span class="k">def</span> <span class="nf">toUnicodeFileEncoding</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">path</span><span class="p">:</span> <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>

    <span class="c"># Yes, this is correct.  All os_path_x functions return Unicode strings.</span>
    <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicode</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="c">#@+node:ekr.20031218072017.3151: ** Scanning... (leoGlobals.py)</span>
<span class="c">#@+node:ekr.20031218072017.3156: *3* scanError</span>
<span class="c"># It is dubious to bump the Tangle error count here, but it really doesn&#39;t hurt.</span>
</div>
<div class="viewcode-block" id="scanError"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.scanError">[docs]</a><span class="k">def</span> <span class="nf">scanError</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Bump the error count in the tangle command.&#39;&#39;&#39;</span>

    <span class="c"># New in Leo 4.4b1: just set this global.</span>
    <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">scanErrors</span> <span class="o">+=</span><span class="mi">1</span>
    <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
<span class="c">#@+node:ekr.20031218072017.3157: *3* scanf</span>
<span class="c"># A quick and dirty sscanf.  Understands only %s and %d.</span>
</div>
<div class="viewcode-block" id="scanf"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.scanf">[docs]</a><span class="k">def</span> <span class="nf">scanf</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">pat</span><span class="p">):</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">pat</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">pat</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="n">pat</span> <span class="o">=</span> <span class="n">pat</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;(\S+)&quot;</span><span class="p">)</span>
    <span class="n">pat</span> <span class="o">=</span> <span class="n">pat</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;(\d+)&quot;</span><span class="p">)</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">pat</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">part</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
    <span class="c"># g.trace(&quot;scanf returns:&quot;,result)</span>
    <span class="k">return</span> <span class="n">result</span>
</div>
<span class="k">if</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># testing</span>
    <span class="n">g</span><span class="o">.</span><span class="n">scanf</span><span class="p">(</span><span class="s">&quot;1.0&quot;</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%d</span><span class="s">.</span><span class="si">%d</span><span class="s">&quot;</span><span class="p">,)</span>
<span class="c">#@+node:ekr.20031218072017.3158: *3* Scanners: calling scanError</span>
<span class="c">#@+at These scanners all call g.scanError() directly or indirectly, so they</span>
<span class="c"># will call g.es if they find an error. g.scanError() also bumps</span>
<span class="c"># c.tangleCommands.errors, which is harmless if we aren&#39;t tangling, and</span>
<span class="c"># useful if we are.</span>
<span class="c"># </span>
<span class="c"># These routines are called by the Import routines and the Tangle routines.</span>
<span class="c">#@+node:ekr.20031218072017.3159: *4* skip_block_comment</span>
<span class="c"># Scans past a block comment (an old_style C comment).</span>

<div class="viewcode-block" id="skip_block_comment"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.skip_block_comment">[docs]</a><span class="k">def</span> <span class="nf">skip_block_comment</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

    <span class="k">assert</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;/*&quot;</span><span class="p">))</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span> <span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="n">k</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;*/&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">scanError</span><span class="p">(</span><span class="s">&quot;Run on block comment: &quot;</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">n</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">2</span>
<span class="c">#@+node:ekr.20031218072017.3160: *4* skip_braces</span>
<span class="c">#@+at This code is called only from the import logic, so we are allowed to</span>
<span class="c"># try some tricks. In particular, we assume all braces are matched in</span>
<span class="c"># #if blocks.</span>
<span class="c">#@@c</span>
</div>
<div class="viewcode-block" id="skip_braces"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.skip_braces">[docs]</a><span class="k">def</span> <span class="nf">skip_braces</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Skips from the opening to the matching brace.</span>

<span class="sd">    If no matching is found i is set to len(s)&#39;&#39;&#39;</span>

    <span class="c"># start = g.get_line(s,i)</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;{&#39;</span><span class="p">))</span>
    <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;{&#39;</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">+=</span> <span class="mi">1</span> <span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;}&#39;</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">level</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">i</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\&#39;</span><span class="s">&#39;</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;&quot;&#39;</span><span class="p">:</span> <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_string</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;//&#39;</span><span class="p">):</span> <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_to_end_of_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;/*&#39;</span><span class="p">):</span> <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_block_comment</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="c"># 7/29/02: be more careful handling conditional code.</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;#if&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;#ifdef&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;#ifndef&quot;</span><span class="p">):</span>
            <span class="n">i</span><span class="p">,</span><span class="n">delta</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_pp_if</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="n">level</span> <span class="o">+=</span> <span class="n">delta</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">i</span>
<span class="c">#@+node:ekr.20031218072017.3161: *4* skip_php_braces (no longer used)</span>
<span class="c">#@+at 08-SEP-2002 DTHEIN: Added for PHP import support</span>
<span class="c"># Skips from the opening to the matching . If no matching is found i is set to len(s).</span>
<span class="c"># </span>
<span class="c"># This code is called only from the import logic, and only for PHP imports.</span>
<span class="c">#@@c</span>
</div>
<div class="viewcode-block" id="skip_php_braces"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.skip_php_braces">[docs]</a><span class="k">def</span> <span class="nf">skip_php_braces</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

    <span class="c"># start = g.get_line(s,i)</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;{&#39;</span><span class="p">))</span>
    <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;{&#39;</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">+=</span> <span class="mi">1</span> <span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;}&#39;</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">level</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\&#39;</span><span class="s">&#39;</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;&quot;&#39;</span><span class="p">:</span> <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_string</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;&lt;&lt;&lt;&quot;</span><span class="p">):</span> <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_heredoc_string</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;//&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;#&#39;</span><span class="p">):</span> <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_to_end_of_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;/*&#39;</span><span class="p">):</span> <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_block_comment</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">i</span>
<span class="c">#@+node:ekr.20031218072017.3162: *4* skip_parens</span></div>
<div class="viewcode-block" id="skip_parens"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.skip_parens">[docs]</a><span class="k">def</span> <span class="nf">skip_parens</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Skips from the opening ( to the matching ).</span>

<span class="sd">    If no matching is found i is set to len(s)&#39;&#39;&#39;</span>

    <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;(&#39;</span><span class="p">))</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;(&#39;</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">+=</span> <span class="mi">1</span> <span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;)&#39;</span><span class="p">:</span>
            <span class="n">level</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">level</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>  <span class="k">return</span> <span class="n">i</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\&#39;</span><span class="s">&#39;</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;&quot;&#39;</span><span class="p">:</span> <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_string</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;//&quot;</span><span class="p">):</span> <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_to_end_of_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;/*&quot;</span><span class="p">):</span> <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_block_comment</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">i</span>
<span class="c">#@+node:ekr.20031218072017.3163: *4* skip_pascal_begin_end</span></div>
<div class="viewcode-block" id="skip_pascal_begin_end"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.skip_pascal_begin_end">[docs]</a><span class="k">def</span> <span class="nf">skip_pascal_begin_end</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Skips from begin to matching end.</span>
<span class="sd">    If found, i points to the end. Otherwise, i &gt;= len(s)</span>
<span class="sd">    The end keyword matches begin, case, class, record, and try.&#39;&#39;&#39;</span>

    <span class="k">assert</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">match_c_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;begin&quot;</span><span class="p">))</span>
    <span class="n">level</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_c_id</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="c"># Skip the opening begin.</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span><span class="s">&#39;{&#39;</span> <span class="p">:</span> <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_pascal_braces</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span><span class="s">&#39;&quot;&#39;</span> <span class="ow">or</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\&#39;</span><span class="s">&#39;</span><span class="p">:</span> <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_pascal_string</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;//&quot;</span><span class="p">):</span> <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;(*&quot;</span><span class="p">):</span> <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_pascal_block_comment</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match_c_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;end&quot;</span><span class="p">):</span>
            <span class="n">level</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c"># lines = s[i1:i+3] ; g.trace(&#39;\n&#39; + lines + &#39;\n&#39;)</span>
                <span class="k">return</span> <span class="n">i</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_c_id</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">is_c_id</span><span class="p">(</span><span class="n">ch</span><span class="p">):</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_c_id</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="p">;</span> <span class="n">name</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;begin&quot;</span><span class="p">,</span> <span class="s">&quot;case&quot;</span><span class="p">,</span> <span class="s">&quot;class&quot;</span><span class="p">,</span> <span class="s">&quot;record&quot;</span><span class="p">,</span> <span class="s">&quot;try&quot;</span><span class="p">]:</span>
                <span class="n">level</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">i</span>
<span class="c">#@+node:ekr.20031218072017.3164: *4* skip_pascal_block_comment</span>
<span class="c"># Scans past a pascal comment delimited by (* and *).</span>
</div>
<div class="viewcode-block" id="skip_pascal_block_comment"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.skip_pascal_block_comment">[docs]</a><span class="k">def</span> <span class="nf">skip_pascal_block_comment</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

    <span class="n">j</span> <span class="o">=</span> <span class="n">i</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;(*&quot;</span><span class="p">))</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;*)&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">scanError</span><span class="p">(</span><span class="s">&quot;Run on comment&quot;</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="c">#@+node:ekr.20031218072017.3165: *4* skip_pascal_string : called by tangle</span></div>
<div class="viewcode-block" id="skip_pascal_string"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.skip_pascal_string">[docs]</a><span class="k">def</span> <span class="nf">skip_pascal_string</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

    <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="p">;</span> <span class="n">delim</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">delim</span> <span class="o">==</span> <span class="s">&#39;&quot;&#39;</span> <span class="ow">or</span> <span class="n">delim</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\&#39;</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">delim</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">g</span><span class="o">.</span><span class="n">scanError</span><span class="p">(</span><span class="s">&quot;Run on string: &quot;</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">i</span>
<span class="c">#@+node:ekr.20031218072017.3166: *4* skip_heredoc_string : called by php import (Dave Hein)</span>
<span class="c">#@+at 08-SEP-2002 DTHEIN:  added function skip_heredoc_string</span>
<span class="c"># A heredoc string in PHP looks like:</span>
<span class="c"># </span>
<span class="c">#   &lt;&lt;&lt;EOS</span>
<span class="c">#   This is my string.</span>
<span class="c">#   It is mine. I own it.</span>
<span class="c">#   No one else has it.</span>
<span class="c">#   EOS</span>
<span class="c"># </span>
<span class="c"># It begins with &lt;&lt;&lt; plus a token (naming same as PHP variable names).</span>
<span class="c"># It ends with the token on a line by itself (must start in first position.</span>
<span class="c"># </span>
<span class="c">#@@c</span></div>
<div class="viewcode-block" id="skip_heredoc_string"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.skip_heredoc_string">[docs]</a><span class="k">def</span> <span class="nf">skip_heredoc_string</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

    <span class="n">j</span> <span class="o">=</span> <span class="n">i</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;&lt;&lt;&lt;&quot;</span><span class="p">))</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;\&lt;\&lt;\&lt;([a-zA-Z_</span><span class="se">\x7f</span><span class="s">-</span><span class="se">\xff</span><span class="s">][a-zA-Z0-9_</span><span class="se">\x7f</span><span class="s">-</span><span class="se">\xff</span><span class="s">]*)&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:])</span>
    <span class="k">if</span> <span class="p">(</span><span class="bp">None</span> <span class="o">==</span> <span class="n">m</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">3</span>
        <span class="k">return</span> <span class="n">i</span>

    <span class="c"># 14-SEP-2002 DTHEIN: needed to add \n to find word, not just string</span>
    <span class="n">delim</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> 

    <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="c"># 14-SEP-2002 DTHEIN: look after \n, not before</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">delim</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="c"># 14-SEP-2002 DTHEIN: move past \n</span>

    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">scanError</span><span class="p">(</span><span class="s">&quot;Run on string: &quot;</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">i</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">delim</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">delim</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">i</span>
<span class="c">#@+node:ekr.20031218072017.3167: *4* skip_pp_directive</span>
<span class="c"># Now handles continuation lines and block comments.</span>
</div>
<div class="viewcode-block" id="skip_pp_directive"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.skip_pp_directive">[docs]</a><span class="k">def</span> <span class="nf">skip_pp_directive</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">is_nl</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">escaped</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span> <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_nl</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">break</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;//&quot;</span><span class="p">):</span> <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_to_end_of_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;/*&quot;</span><span class="p">):</span> <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_block_comment</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">i</span>
<span class="c">#@+node:ekr.20031218072017.3168: *4* skip_pp_if</span>
<span class="c"># Skips an entire if or if def statement, including any nested statements.</span>
</div>
<div class="viewcode-block" id="skip_pp_if"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.skip_pp_if">[docs]</a><span class="k">def</span> <span class="nf">skip_pp_if</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

    <span class="n">start_line</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="c"># used for error messages.</span>
    <span class="c"># g.trace(start_line)</span>

    <span class="k">assert</span><span class="p">(</span>
        <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;#if&quot;</span><span class="p">)</span> <span class="ow">or</span>
        <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;#ifdef&quot;</span><span class="p">)</span> <span class="ow">or</span>
        <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;#ifndef&quot;</span><span class="p">))</span>

    <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
    <span class="n">i</span><span class="p">,</span><span class="n">delta1</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_pp_part</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;#else&quot;</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="n">i</span><span class="p">,</span><span class="n">delta2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_pp_part</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">delta1</span> <span class="o">!=</span> <span class="n">delta2</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;#if and #else parts have different braces:&quot;</span><span class="p">,</span><span class="n">start_line</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;#endif&quot;</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;no matching #endif:&quot;</span><span class="p">,</span><span class="n">start_line</span><span class="p">)</span>

    <span class="c"># g.trace(delta1,start_line)</span>
    <span class="k">return</span> <span class="n">i</span><span class="p">,</span><span class="n">delta1</span>
<span class="c">#@+node:ekr.20031218072017.3169: *4* skip_pp_part</span>
<span class="c"># Skip to an #else or #endif.  The caller has eaten the #if, #ifdef, #ifndef or #else</span>
</div>
<div class="viewcode-block" id="skip_pp_part"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.skip_pp_part">[docs]</a><span class="k">def</span> <span class="nf">skip_pp_part</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

    <span class="c"># g.trace(g.get_line(s,i))</span>

    <span class="n">delta</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">get_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;#if&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;#ifdef&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;#ifndef&quot;</span><span class="p">):</span>
            <span class="n">i</span><span class="p">,</span><span class="n">delta1</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_pp_if</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="n">delta</span> <span class="o">+=</span> <span class="n">delta1</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;#else&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;#endif&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">i</span><span class="p">,</span><span class="n">delta</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\&#39;</span><span class="s">&#39;</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;&quot;&#39;</span><span class="p">:</span> <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_string</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;{&#39;</span><span class="p">:</span>
            <span class="n">delta</span> <span class="o">+=</span> <span class="mi">1</span> <span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;}&#39;</span><span class="p">:</span>
            <span class="n">delta</span> <span class="o">-=</span> <span class="mi">1</span> <span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;//&quot;</span><span class="p">):</span> <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;/*&quot;</span><span class="p">):</span> <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_block_comment</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">i</span><span class="p">,</span><span class="n">delta</span>
<span class="c">#@+node:ekr.20031218072017.3170: *4* skip_python_string</span></div>
<div class="viewcode-block" id="skip_python_string"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.skip_python_string">[docs]</a><span class="k">def</span> <span class="nf">skip_python_string</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;&#39;&#39;&#39;&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;&quot;&quot;&quot;&#39;</span><span class="p">):</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="p">;</span> <span class="n">delim</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span> <span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">3</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">delim</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="n">k</span><span class="o">+</span><span class="mi">3</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">scanError</span><span class="p">(</span><span class="s">&quot;Run on triple quoted string: &quot;</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_string</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
<span class="c">#@+node:ekr.20031218072017.2369: *4* skip_string</span></div>
<div class="viewcode-block" id="skip_string"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.skip_string">[docs]</a><span class="k">def</span> <span class="nf">skip_string</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Scan forward to the end of a string.</span>
<span class="sd">    New in Leo 4.4.2 final: give error only if verbose is True&#39;&#39;&#39;</span>

    <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="p">;</span> <span class="n">delim</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">delim</span> <span class="o">==</span> <span class="s">&#39;&quot;&#39;</span> <span class="ow">or</span> <span class="n">delim</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\&#39;</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">delim</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">scanError</span><span class="p">(</span><span class="s">&quot;Run on string: &quot;</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">i</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">delim</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c"># g.trace(s[j:i])</span>
    <span class="k">return</span> <span class="n">i</span>
<span class="c">#@+node:ekr.20031218072017.3171: *4* skip_to_semicolon</span>
<span class="c"># Skips to the next semicolon that is not in a comment or a string.</span>
</div>
<div class="viewcode-block" id="skip_to_semicolon"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.skip_to_semicolon">[docs]</a><span class="k">def</span> <span class="nf">skip_to_semicolon</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;;&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="n">i</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\&#39;</span><span class="s">&#39;</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;&quot;&#39;</span> <span class="p">:</span> <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_string</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;//&quot;</span><span class="p">):</span> <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_to_end_of_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;/*&quot;</span><span class="p">):</span> <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_block_comment</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">i</span>
<span class="c">#@+node:ekr.20031218072017.3172: *4* skip_typedef</span></div>
<div class="viewcode-block" id="skip_typedef"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.skip_typedef">[docs]</a><span class="k">def</span> <span class="nf">skip_typedef</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">is_c_id</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_c_id</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws_and_nl</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;{&#39;</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_braces</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_to_semicolon</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">i</span>
<span class="c">#@+node:ekr.20031218072017.3173: *3* Scanners: no error messages</span>
<span class="c">#@+node:ekr.20031218072017.3174: *4* escaped</span>
<span class="c"># Returns True if s[i] is preceded by an odd number of backslashes.</span>
</div>
<div class="viewcode-block" id="escaped"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.escaped">[docs]</a><span class="k">def</span> <span class="nf">escaped</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">count</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
<span class="c">#@+node:ekr.20031218072017.3175: *4* find_line_start</span></div>
<div class="viewcode-block" id="find_line_start"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.find_line_start">[docs]</a><span class="k">def</span> <span class="nf">find_line_start</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span> <span class="c"># New in Leo 4.4.5: add this defensive code.</span>

    <span class="c"># bug fix: 11/2/02: change i to i+1 in rfind</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="c"># Finds the highest index in the range.</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
<span class="c">#@+node:ekr.20031218072017.3176: *4* find_on_line</span></div>
<div class="viewcode-block" id="find_on_line"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.find_on_line">[docs]</a><span class="k">def</span> <span class="nf">find_on_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">pattern</span><span class="p">):</span>

    <span class="n">j</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">j</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">k</span>
<span class="c">#@+node:ekr.20031218072017.3177: *4* is_c_id</span></div>
<div class="viewcode-block" id="is_c_id"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.is_c_id">[docs]</a><span class="k">def</span> <span class="nf">is_c_id</span><span class="p">(</span><span class="n">ch</span><span class="p">):</span>

    <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">isWordChar</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>

<span class="c">#@+node:ekr.20031218072017.3178: *4* is_nl</span></div>
<div class="viewcode-block" id="is_nl"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.is_nl">[docs]</a><span class="k">def</span> <span class="nf">is_nl</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

    <span class="k">return</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="ow">or</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\r</span><span class="s">&#39;</span><span class="p">)</span>
<span class="c">#@+node:ekr.20031218072017.3179: *4* is_special</span>
<span class="c"># We no longer require that the directive appear befor any @c directive or section definition.</span>
</div>
<div class="viewcode-block" id="is_special"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.is_special">[docs]</a><span class="k">def</span> <span class="nf">is_special</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">directive</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Return True if the body text contains the @ directive.&#39;&#39;&#39;</span>

    <span class="c"># j = g.skip_line(s,i) ; g.trace(s[i:j],&#39;:&#39;,directive)</span>
    <span class="k">assert</span> <span class="p">(</span><span class="n">directive</span> <span class="ow">and</span> <span class="n">directive</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;@&#39;</span> <span class="p">)</span>

    <span class="c"># 10/23/02: all directives except @others must start the line.</span>
    <span class="n">skip_flag</span> <span class="o">=</span> <span class="n">directive</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;@others&quot;</span><span class="p">,</span><span class="s">&quot;@all&quot;</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">directive</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="n">i</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">skip_flag</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
<span class="c">#@+node:ekr.20031218072017.3180: *4* is_ws &amp; is_ws_or_nl</span></div>
<div class="viewcode-block" id="is_ws"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.is_ws">[docs]</a><span class="k">def</span> <span class="nf">is_ws</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>

    <span class="k">return</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39; &#39;</span>
</div>
<div class="viewcode-block" id="is_ws_or_nl"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.is_ws_or_nl">[docs]</a><span class="k">def</span> <span class="nf">is_ws_or_nl</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

    <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">is_nl</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">is_ws</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
<span class="c">#@+node:ekr.20031218072017.3181: *4* match</span>
<span class="c"># Warning: this code makes no assumptions about what follows pattern.</span>
</div>
<div class="viewcode-block" id="match"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.match">[docs]</a><span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">pattern</span><span class="p">):</span>

    <span class="k">return</span> <span class="n">s</span> <span class="ow">and</span> <span class="n">pattern</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">pattern</span><span class="p">))</span> <span class="o">==</span> <span class="n">i</span>
<span class="c">#@+node:ekr.20031218072017.3182: *4* match_c_word</span></div>
<div class="viewcode-block" id="match_c_word"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.match_c_word">[docs]</a><span class="k">def</span> <span class="nf">match_c_word</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="n">name</span> <span class="o">==</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">n</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">n</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">is_c_id</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">n</span><span class="p">]))</span>
<span class="c">#@+node:ekr.20031218072017.3183: *4* match_ignoring_case</span></div>
<div class="viewcode-block" id="match_ignoring_case"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.match_ignoring_case">[docs]</a><span class="k">def</span> <span class="nf">match_ignoring_case</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">s1</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">s2</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>

    <span class="k">return</span> <span class="n">s1</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">s2</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<span class="c">#@+node:ekr.20031218072017.3184: *4* match_word</span></div>
<div class="viewcode-block" id="match_word"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.match_word">[docs]</a><span class="k">def</span> <span class="nf">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">pattern</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">pattern</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>
    <span class="n">j</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">)</span> <span class="o">!=</span> <span class="n">i</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">i</span><span class="o">+</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="n">ch</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">]</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">isWordChar</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
<span class="c">#@+node:ekr.20031218072017.3185: *4* skip_blank_lines</span>
<span class="c"># This routine differs from skip_ws_and_nl in that</span>
<span class="c"># it does not advance over whitespace at the start</span>
<span class="c"># of a non-empty or non-nl terminated line</span></div>
<div class="viewcode-block" id="skip_blank_lines"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.skip_blank_lines">[docs]</a><span class="k">def</span> <span class="nf">skip_blank_lines</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">is_nl</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_nl</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">is_ws</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">is_nl</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">j</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">j</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">break</span>
    <span class="k">return</span> <span class="n">i</span>
<span class="c">#@+node:ekr.20031218072017.3186: *4* skip_c_id</span></div>
<div class="viewcode-block" id="skip_c_id"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.skip_c_id">[docs]</a><span class="k">def</span> <span class="nf">skip_c_id</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">isWordChar</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">i</span>
<span class="c">#@+node:ekr.20040705195048: *4* skip_id</span></div>
<div class="viewcode-block" id="skip_id"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.skip_id">[docs]</a><span class="k">def</span> <span class="nf">skip_id</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">chars</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="n">chars</span> <span class="o">=</span> <span class="n">chars</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicode</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">isWordChar</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">or</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">chars</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">i</span>
<span class="c">#@+node:ekr.20031218072017.3187: *4* skip_line, skip_to_start/end_of_line</span>
<span class="c">#@+at These methods skip to the next newline, regardless of whether the</span>
<span class="c"># newline may be preceeded by a backslash. Consequently, they should be</span>
<span class="c"># used only when we know that we are not in a preprocessor directive or</span>
<span class="c"># string.</span>
<span class="c">#@@c</span>
</div>
<div class="viewcode-block" id="skip_line"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.skip_line">[docs]</a><span class="k">def</span> <span class="nf">skip_line</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):</span> <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="c"># Bug fix: 2007/5/22</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
</div>
<div class="viewcode-block" id="skip_to_end_of_line"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.skip_to_end_of_line">[docs]</a><span class="k">def</span> <span class="nf">skip_to_end_of_line</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):</span> <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="c"># Bug fix: 2007/5/22</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">i</span>
</div>
<div class="viewcode-block" id="skip_to_start_of_line"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.skip_to_start_of_line">[docs]</a><span class="k">def</span> <span class="nf">skip_to_start_of_line</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):</span> <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>      <span class="k">return</span> <span class="mi">0</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="c"># Don&#39;t find s[i], so it doesn&#39;t matter if s[i] is a newline.</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>       <span class="k">return</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
<span class="c">#@+node:ekr.20031218072017.3188: *4* skip_long</span></div>
<div class="viewcode-block" id="skip_long"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.skip_long">[docs]</a><span class="k">def</span> <span class="nf">skip_long</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Scan s[i:] for a valid int.</span>
<span class="sd">    Return (i, val) or (i, None) if s[i] does not point at a number.&#39;&#39;&#39;</span>

    <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">n</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="s">&#39;+-&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">i</span><span class="p">,</span> <span class="bp">None</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">i</span>
    <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="s">&#39;+-&#39;</span><span class="p">:</span> <span class="c"># Allow sign before the first digit</span>
        <span class="n">i</span> <span class="o">+=</span><span class="mi">1</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">try</span><span class="p">:</span> <span class="c"># There may be no digits.</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">i</span><span class="p">,</span><span class="bp">None</span>
<span class="c">#@+node:ekr.20031218072017.3189: *4* skip_matching_python_delims</span></div>
<div class="viewcode-block" id="skip_matching_python_delims"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.skip_matching_python_delims">[docs]</a><span class="k">def</span> <span class="nf">skip_matching_python_delims</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">delim1</span><span class="p">,</span><span class="n">delim2</span><span class="p">,</span><span class="n">reverse</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Skip from the opening delim to the matching delim2.</span>

<span class="sd">    Return the index of the matching &#39;)&#39;, or -1&#39;&#39;&#39;</span>

    <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="c"># g.trace(&#39;delim1/2&#39;,repr(delim1),repr(delim2),&#39;i&#39;,i,&#39;s[i]&#39;,repr(s[i]),&#39;s&#39;,repr(s[i-5:i+5]))</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">delim1</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="n">delim1</span><span class="p">:</span>
                <span class="n">level</span> <span class="o">+=</span> <span class="mi">1</span> <span class="p">;</span> <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="n">delim2</span><span class="p">:</span>
                <span class="n">level</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">level</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>  <span class="k">return</span> <span class="n">i</span>
                <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="c"># Doesn&#39;t handle strings and comments properly...</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="n">delim1</span><span class="p">:</span>
                <span class="n">level</span> <span class="o">+=</span> <span class="mi">1</span> <span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="n">delim2</span><span class="p">:</span>
                <span class="n">level</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">level</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>  <span class="k">return</span> <span class="n">i</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\&#39;</span><span class="s">&#39;</span> <span class="ow">or</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;&quot;&#39;</span><span class="p">:</span> <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_string</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;#&#39;</span><span class="p">):</span>  <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_to_end_of_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">progress</span><span class="p">:</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
<span class="c">#@+node:ekr.20110916215321.6712: *4* g.skip_matching_c_delims</span></div>
<div class="viewcode-block" id="skip_matching_c_delims"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.skip_matching_c_delims">[docs]</a><span class="k">def</span> <span class="nf">skip_matching_c_delims</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">delim1</span><span class="p">,</span><span class="n">delim2</span><span class="p">,</span><span class="n">reverse</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Skip from the opening delim to the matching delim2.</span>

<span class="sd">    Return the index of the matching &#39;)&#39;, or -1&#39;&#39;&#39;</span>

    <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">delim1</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">reverse</span><span class="p">:</span>
        <span class="c"># Reverse scanning is tricky.</span>
        <span class="c"># This doesn&#39;t handle single-line comments properly.</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="n">delim1</span><span class="p">:</span>
                <span class="n">level</span> <span class="o">+=</span> <span class="mi">1</span> <span class="p">;</span> <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="n">delim2</span><span class="p">:</span>
                <span class="n">level</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">level</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>  <span class="k">return</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span>
                <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;</span><span class="se">\&#39;</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;&quot;&#39;</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">while</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">ch</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">:</span>
                        <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span> <span class="p">;</span> <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;*/&#39;</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span>
                <span class="k">while</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;/*&#39;</span><span class="p">):</span>
                        <span class="n">i</span> <span class="o">-=</span> <span class="mi">2</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">progress</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;oops: reverse&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">ch</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c"># g.trace(i,repr(ch))</span>
            <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="n">delim1</span><span class="p">:</span>
                <span class="n">level</span> <span class="o">+=</span> <span class="mi">1</span> <span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="n">delim2</span><span class="p">:</span>
                <span class="n">level</span> <span class="o">-=</span> <span class="mi">1</span> <span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">level</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>  <span class="k">return</span> <span class="n">i</span>
            <span class="k">elif</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;</span><span class="se">\&#39;</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;&quot;&#39;</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">ch</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">:</span>
                        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span> <span class="p">;</span> <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;//&#39;</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_to_end_of_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;/*&#39;</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span>
                <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;*/&#39;</span><span class="p">):</span>
                        <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">progress</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;oops&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;not found&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
<span class="c">#@+node:ekr.20060627080947: *4* skip_matching_python_parens</span></div>
<div class="viewcode-block" id="skip_matching_python_parens"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.skip_matching_python_parens">[docs]</a><span class="k">def</span> <span class="nf">skip_matching_python_parens</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Skip from the opening ( to the matching ).</span>

<span class="sd">    Return the index of the matching &#39;)&#39;, or -1&#39;&#39;&#39;</span>

    <span class="k">return</span> <span class="n">skip_matching_python_delims</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;(&#39;</span><span class="p">,</span><span class="s">&#39;)&#39;</span><span class="p">)</span>
<span class="c">#@+node:ekr.20031218072017.3190: *4* skip_nl</span>
<span class="c"># We need this function because different systems have different end-of-line conventions.</span>
</div>
<div class="viewcode-block" id="skip_nl"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.skip_nl">[docs]</a><span class="k">def</span> <span class="nf">skip_nl</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Skips a single &quot;logical&quot; end-of-line character.&#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">):</span> <span class="k">return</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\r</span><span class="s">&#39;</span><span class="p">):</span> <span class="k">return</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">i</span>
<span class="c">#@+node:ekr.20031218072017.3191: *4* skip_non_ws</span></div>
<div class="viewcode-block" id="skip_non_ws"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.skip_non_ws">[docs]</a><span class="k">def</span> <span class="nf">skip_non_ws</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">is_ws</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">i</span>
<span class="c">#@+node:ekr.20031218072017.3192: *4* skip_pascal_braces</span>
<span class="c"># Skips from the opening { to the matching }.</span>
</div>
<div class="viewcode-block" id="skip_pascal_braces"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.skip_pascal_braces">[docs]</a><span class="k">def</span> <span class="nf">skip_pascal_braces</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

    <span class="c"># No constructs are recognized inside Pascal block comments!</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;}&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">k</span>
<span class="c">#@+node:ekr.20031218072017.3193: *4* skip_to_char</span></div>
<div class="viewcode-block" id="skip_to_char"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.skip_to_char">[docs]</a><span class="k">def</span> <span class="nf">skip_to_char</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">ch</span><span class="p">):</span>

    <span class="n">j</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">j</span><span class="p">,</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>
<span class="c">#@+node:ekr.20031218072017.3194: *4* skip_ws, skip_ws_and_nl</span></div>
<div class="viewcode-block" id="skip_ws"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.skip_ws">[docs]</a><span class="k">def</span> <span class="nf">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">is_ws</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">i</span>
</div>
<div class="viewcode-block" id="skip_ws_and_nl"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.skip_ws_and_nl">[docs]</a><span class="k">def</span> <span class="nf">skip_ws_and_nl</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">is_ws</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">is_nl</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)):</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">i</span>
<span class="c">#@+node:ekr.20031218072017.3195: *3* splitLines &amp; joinLines</span></div>
<div class="viewcode-block" id="splitLines"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.splitLines">[docs]</a><span class="k">def</span> <span class="nf">splitLines</span> <span class="p">(</span><span class="n">s</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Split s into lines, preserving the number of lines and</span>
<span class="sd">    the endings of all lines, including the last line.&#39;&#39;&#39;</span>

    <span class="c"># g.stat()</span>

    <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span> <span class="c"># This is a Python string function!</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
</div>
<span class="n">splitlines</span> <span class="o">=</span> <span class="n">splitLines</span>

<div class="viewcode-block" id="joinLines"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.joinLines">[docs]</a><span class="k">def</span> <span class="nf">joinLines</span> <span class="p">(</span><span class="n">aList</span><span class="p">):</span>

    <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">aList</span><span class="p">)</span>
</div>
<span class="n">joinlines</span> <span class="o">=</span> <span class="n">joinLines</span>
<span class="c">#@+node:ekr.20040327103735.2: ** Script Tools (leoGlobals.py)</span>
<span class="c">#@+node:ekr.20050503112513.7: *3* g.executeFile</span>
<div class="viewcode-block" id="executeFile"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.executeFile">[docs]</a><span class="k">def</span> <span class="nf">executeFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">R_OK</span><span class="p">):</span> <span class="k">return</span>
    <span class="n">fdir</span><span class="p">,</span> <span class="n">fname</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_split</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="c"># New in Leo 4.10: alway use subprocess.</span>
    <span class="k">def</span> <span class="nf">subprocess_wrapper</span><span class="p">(</span><span class="n">cmdlst</span><span class="p">):</span>
        <span class="c"># g.trace(cmdlst, fdir)</span>
        <span class="c"># g.trace(subprocess.list2cmdline([cmdlst]))</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmdlst</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">fdir</span><span class="p">,</span>
            <span class="n">universal_newlines</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">stdo</span><span class="p">,</span> <span class="n">stde</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">(),</span> <span class="n">stdo</span><span class="p">,</span> <span class="n">stde</span>
    <span class="n">rc</span><span class="p">,</span> <span class="n">so</span><span class="p">,</span> <span class="n">se</span> <span class="o">=</span> <span class="n">subprocess_wrapper</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">options</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">rc</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;return code&#39;</span><span class="p">,</span> <span class="n">rc</span><span class="p">)</span>
    <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="n">so</span><span class="p">,</span><span class="n">se</span><span class="p">)</span>
<span class="c">#@+node:ekr.20040321065415: *3* g.findNode... &amp;,findTopLevelNode</span></div>
<div class="viewcode-block" id="findNodeInChildren"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.findNodeInChildren">[docs]</a><span class="k">def</span> <span class="nf">findNodeInChildren</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">headline</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Search for a node in v&#39;s tree matching the given headline.&quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">children</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="n">headline</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">nullPosition</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="findNodeInTree"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.findNodeInTree">[docs]</a><span class="k">def</span> <span class="nf">findNodeInTree</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">headline</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Search for a node in v&#39;s tree matching the given headline.&quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">subtree</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="n">headline</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">nullPosition</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="findNodeAnywhere"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.findNodeAnywhere">[docs]</a><span class="k">def</span> <span class="nf">findNodeAnywhere</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">headline</span><span class="p">):</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">all_unique_positions</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="n">headline</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">nullPosition</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="findTopLevelNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.findTopLevelNode">[docs]</a><span class="k">def</span> <span class="nf">findTopLevelNode</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">headline</span><span class="p">):</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span><span class="o">.</span><span class="n">self_and_siblings</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="n">headline</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">nullPosition</span><span class="p">()</span>
<span class="c">#@+node:EKR.20040614071102.1: *3* g.getScript</span></div>
<div class="viewcode-block" id="getScript"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.getScript">[docs]</a><span class="k">def</span> <span class="nf">getScript</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">useSelectedText</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">forcePythonSentinels</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">useSentinels</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Return the expansion of the selected text of node p.</span>
<span class="sd">    Return the expansion of all of node p&#39;s body text if</span>
<span class="sd">    p is not the current node or if there is no text selection.&#39;&#39;&#39;</span>

    <span class="c"># New in Leo 4.6 b2: use a pristine atFile handler</span>
    <span class="c"># so there can be no conflict with c.atFileCommands.</span>
    <span class="c"># at = c.atFileCommands</span>
    <span class="kn">import</span> <span class="nn">leo.core.leoAtFile</span> <span class="kn">as</span> <span class="nn">leoAtFile</span>
    <span class="n">at</span> <span class="o">=</span> <span class="n">leoAtFile</span><span class="o">.</span><span class="n">atFile</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

    <span class="n">w</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">bodyCtrl</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">inBridge</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span>
        <span class="k">elif</span> <span class="n">p1</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span> <span class="c"># Bug fix: Leo 8.8.4.</span>
        <span class="k">elif</span> <span class="n">p</span> <span class="o">==</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">useSelectedText</span> <span class="ow">and</span> <span class="n">w</span><span class="o">.</span><span class="n">hasSelection</span><span class="p">():</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getSelectedText</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getAllText</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span>
        <span class="c"># Remove extra leading whitespace so the user may execute indented code.</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">removeExtraLws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">tab_width</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">scriptDict</span><span class="p">[</span><span class="s">&quot;script1&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">s</span>
            <span class="c"># Important: converts unicode to utf-8 encoded strings.</span>
            <span class="n">script</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">writeFromString</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span><span class="n">s</span><span class="p">,</span>
                <span class="n">forcePythonSentinels</span><span class="o">=</span><span class="n">forcePythonSentinels</span><span class="p">,</span>
                <span class="n">useSentinels</span><span class="o">=</span><span class="n">useSentinels</span><span class="p">)</span>
            <span class="n">script</span> <span class="o">=</span> <span class="n">script</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span> <span class="c"># Use brute force.</span>
            <span class="c"># Important, the script is an **encoded string**, not a unicode string.</span>
            <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">scriptDict</span><span class="p">[</span><span class="s">&quot;script2&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">script</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">script</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&quot;unexpected exception in g.getScript&quot;</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
        <span class="n">script</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

    <span class="c"># g.trace(type(script),repr(script))</span>
    <span class="k">return</span> <span class="n">script</span>
<span class="c">#@+node:ekr.20060624085200: *3* g.handleScriptException</span></div>
<div class="viewcode-block" id="handleScriptException"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.handleScriptException">[docs]</a><span class="k">def</span> <span class="nf">handleScriptException</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">script</span><span class="p">,</span><span class="n">script1</span><span class="p">):</span>

    <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;exception executing script&quot;</span><span class="p">)</span>

    <span class="n">full</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getBool</span><span class="p">(</span><span class="s">&#39;show_full_tracebacks_in_scripts&#39;</span><span class="p">)</span>

    <span class="n">fileName</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">(</span><span class="n">full</span><span class="o">=</span><span class="n">full</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">p</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">script1</span> <span class="ow">and</span> <span class="n">fileName</span> <span class="o">==</span> <span class="s">&quot;&lt;string&gt;&quot;</span><span class="p">:</span>
        <span class="n">c</span><span class="o">.</span><span class="n">goToScriptLineNumber</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">script</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>

    <span class="c">#@+&lt;&lt; dump the lines near the error &gt;&gt;</span>
    <span class="c">#@+node:EKR.20040612215018: *4* &lt;&lt; dump the lines near the error &gt;&gt;</span>
    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">fileName</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>

    <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">20</span>
    <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>

    <span class="c"># Print surrounding lines.</span>
    <span class="n">i</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">j</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">j</span><span class="p">:</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s">&#39;*&#39;</span><span class="p">,</span><span class="s">&#39; &#39;</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> line </span><span class="si">%d</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ch</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">newline</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c">#@-&lt;&lt; dump the lines near the error &gt;&gt;</span>
<span class="c">#@+node:ekr.20031218072017.2418: *3* g.initScriptFind (set up dialog)</span></div>
<div class="viewcode-block" id="initScriptFind"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.initScriptFind">[docs]</a><span class="k">def</span> <span class="nf">initScriptFind</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">findHeadline</span><span class="p">,</span><span class="n">changeHeadline</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">firstNode</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
    <span class="n">script_search</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">script_change</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

    <span class="kn">import</span> <span class="nn">leo.core.leoGlobals</span> <span class="kn">as</span> <span class="nn">g</span>

    <span class="c"># Find the scripts.</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
    <span class="n">tm</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">testManager</span>
    <span class="n">find_p</span> <span class="o">=</span> <span class="n">tm</span><span class="o">.</span><span class="n">findNodeInTree</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">findHeadline</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">find_p</span><span class="p">:</span>
        <span class="n">find_text</span> <span class="o">=</span> <span class="n">find_p</span><span class="o">.</span><span class="n">b</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;no Find script node&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">changeHeadline</span><span class="p">:</span>
        <span class="n">change_p</span> <span class="o">=</span> <span class="n">tm</span><span class="o">.</span><span class="n">findNodeInTree</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">changeHeadline</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">change_p</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">change_p</span><span class="p">:</span>
        <span class="n">change_text</span> <span class="o">=</span> <span class="n">change_p</span><span class="o">.</span><span class="n">b</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">change_text</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
    <span class="c"># g.pr(find_p,change_p)</span>

    <span class="c"># Initialize the find panel.</span>
    <span class="n">c</span><span class="o">.</span><span class="n">script_search_flag</span> <span class="o">=</span> <span class="n">script_search</span>
    <span class="n">c</span><span class="o">.</span><span class="n">script_change_flag</span> <span class="o">=</span> <span class="n">script_change</span> <span class="ow">and</span> <span class="n">change_text</span>
    <span class="k">if</span> <span class="n">script_search</span><span class="p">:</span>
        <span class="n">c</span><span class="o">.</span><span class="n">find_text</span> <span class="o">=</span> <span class="n">find_text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">c</span><span class="o">.</span><span class="n">find_text</span> <span class="o">=</span> <span class="n">find_text</span>
    <span class="k">if</span> <span class="n">script_change</span><span class="p">:</span>
        <span class="n">c</span><span class="o">.</span><span class="n">change_text</span> <span class="o">=</span> <span class="n">change_text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">c</span><span class="o">.</span><span class="n">change_text</span> <span class="o">=</span> <span class="n">change_text</span>
    <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">findPanel</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">showFindPanel</span><span class="p">()</span>
<span class="c">#@+node:ekr.20111115155710.9859: ** Tokenizing &amp; parsing</span>
<span class="c">#@+node:ekr.20111115155710.9814: *3* g.python_tokenize</span></div>
<div class="viewcode-block" id="python_tokenize"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.python_tokenize">[docs]</a><span class="k">def</span> <span class="nf">python_tokenize</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">line_numbers</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Tokenize string s and return a list of tokens (kind,value,line_number)</span>

<span class="sd">    where kind is in (&#39;comment,&#39;id&#39;,&#39;nl&#39;,&#39;other&#39;,&#39;string&#39;,&#39;ws&#39;).</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">result</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">line_number</span> <span class="o">=</span> <span class="p">[],</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="n">progress</span> <span class="o">=</span> <span class="n">j</span> <span class="o">=</span> <span class="n">i</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">:</span>
            <span class="n">kind</span><span class="p">,</span><span class="n">i</span> <span class="o">=</span> <span class="s">&#39;nl&#39;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">elif</span> <span class="n">ch</span> <span class="ow">in</span> <span class="s">&#39; </span><span class="se">\t</span><span class="s">&#39;</span><span class="p">:</span>
            <span class="n">kind</span> <span class="o">=</span> <span class="s">&#39;ws&#39;</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="s">&#39; </span><span class="se">\t</span><span class="s">&#39;</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;#&#39;</span><span class="p">:</span>
            <span class="n">kind</span><span class="p">,</span><span class="n">i</span> <span class="o">=</span> <span class="s">&#39;comment&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">skip_to_end_of_line</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ch</span> <span class="ow">in</span> <span class="s">&#39;&quot;</span><span class="se">\&#39;</span><span class="s">&#39;</span><span class="p">:</span>
            <span class="n">kind</span><span class="p">,</span><span class="n">i</span> <span class="o">=</span> <span class="s">&#39;string&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">skip_python_string</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;_&#39;</span> <span class="ow">or</span> <span class="n">ch</span><span class="o">.</span><span class="n">isalpha</span><span class="p">():</span>
            <span class="n">kind</span><span class="p">,</span><span class="n">i</span> <span class="o">=</span> <span class="s">&#39;id&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">skip_id</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kind</span><span class="p">,</span><span class="n">i</span> <span class="o">=</span> <span class="s">&#39;other&#39;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>

        <span class="k">assert</span> <span class="n">progress</span> <span class="o">&lt;</span> <span class="n">i</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">==</span> <span class="n">progress</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">i</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">val</span>

        <span class="k">if</span> <span class="n">line_numbers</span><span class="p">:</span>
            <span class="n">line_number</span> <span class="o">+=</span> <span class="n">val</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span> <span class="c"># A comment.</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">kind</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">line_number</span><span class="p">),)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">kind</span><span class="p">,</span><span class="n">val</span><span class="p">),)</span>

    <span class="k">return</span> <span class="n">result</span>
<span class="c">#@+node:ekr.20031218072017.1498: ** Unicode utils...</span>
<span class="c">#@+node:ekr.20100125073206.8709: *3* g.getPythonEncodingFromString</span></div>
<div class="viewcode-block" id="getPythonEncodingFromString"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.getPythonEncodingFromString">[docs]</a><span class="k">def</span> <span class="nf">getPythonEncodingFromString</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Return the encoding given by Python&#39;s encoding line.</span>
<span class="sd">    s is the entire file.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">encoding</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">tag</span><span class="p">,</span><span class="n">tag2</span> <span class="o">=</span> <span class="s">&#39;# -*- coding:&#39;</span><span class="p">,</span><span class="s">&#39;-*-&#39;</span>
    <span class="n">n1</span><span class="p">,</span><span class="n">n2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tag</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">tag2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
        <span class="c"># For Python 3.x we must convert to unicode before calling startswith.</span>
        <span class="c"># The encoding doesn&#39;t matter: we only look at the first line, and if</span>
        <span class="c"># the first line is an encoding line, it will contain only ascii characters.</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s">&#39;ascii&#39;</span><span class="p">,</span><span class="n">reportErrors</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">line1</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">line1</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span> <span class="ow">and</span> <span class="n">line1</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">tag2</span><span class="p">):</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">line1</span><span class="p">[</span><span class="n">n1</span><span class="p">:</span><span class="o">-</span><span class="n">n2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">e</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">isValidEncoding</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                <span class="n">encoding</span> <span class="o">=</span> <span class="n">e</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">line1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;@first&#39;</span><span class="p">):</span> <span class="c"># 2011/10/21.</span>
            <span class="n">line1</span> <span class="o">=</span> <span class="n">line1</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s">&#39;@first&#39;</span><span class="p">):]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line1</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span> <span class="ow">and</span> <span class="n">line1</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">tag2</span><span class="p">):</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">line1</span><span class="p">[</span><span class="n">n1</span><span class="p">:</span><span class="o">-</span><span class="n">n2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="c"># g.trace(e,g.isValidEncoding(e),g.callers())</span>
                <span class="k">if</span> <span class="n">e</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">isValidEncoding</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                    <span class="n">encoding</span> <span class="o">=</span> <span class="n">e</span>

    <span class="k">return</span> <span class="n">encoding</span>
<span class="c">#@+node:ekr.20080816125725.2: *3* g.isBytes, isCallable, isChar, isString &amp; isUnicode</span>
<span class="c"># The syntax of these functions must be valid on Python2K and Python3K.</span>
</div>
<div class="viewcode-block" id="isBytes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.isBytes">[docs]</a><span class="k">def</span> <span class="nf">isBytes</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Return True if s is Python3k bytes type.&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
        <span class="c"># Generates a pylint warning, but that can&#39;t be helped.</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">,</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="isCallable"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.isCallable">[docs]</a><span class="k">def</span> <span class="nf">isCallable</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s">&#39;__call__&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">callable</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="isChar"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.isChar">[docs]</a><span class="k">def</span> <span class="nf">isChar</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Return True if s is a Python2K character type.&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="n">types</span><span class="o">.</span><span class="n">StringType</span>
</div>
<div class="viewcode-block" id="isString"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.isString">[docs]</a><span class="k">def</span> <span class="nf">isString</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Return True if s is any string, but not bytes.&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">in</span> <span class="n">types</span><span class="o">.</span><span class="n">StringTypes</span>
</div>
<div class="viewcode-block" id="isUnicode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.isUnicode">[docs]</a><span class="k">def</span> <span class="nf">isUnicode</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Return True if s is a unicode string.&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="n">types</span><span class="o">.</span><span class="n">UnicodeType</span>
<span class="c">#@+node:ekr.20031218072017.1500: *3* g.isValidEncoding</span></div>
<div class="viewcode-block" id="isValidEncoding"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.isValidEncoding">[docs]</a><span class="k">def</span> <span class="nf">isValidEncoding</span> <span class="p">(</span><span class="n">encoding</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">encoding</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&#39;cli&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="kn">import</span> <span class="nn">codecs</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">codecs</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">except</span> <span class="ne">LookupError</span><span class="p">:</span> <span class="c"># Windows.</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span> <span class="c"># Linux.</span>
        <span class="k">return</span> <span class="bp">False</span>
<span class="c">#@+node:ekr.20061006152327: *3* g.isWordChar &amp; g.isWordChar1</span></div>
<div class="viewcode-block" id="isWordChar"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.isWordChar">[docs]</a><span class="k">def</span> <span class="nf">isWordChar</span> <span class="p">(</span><span class="n">ch</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Return True if ch should be considered a letter.&#39;&#39;&#39;</span>

    <span class="k">return</span> <span class="n">ch</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">isalnum</span><span class="p">()</span> <span class="ow">or</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;_&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="isWordChar1"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.isWordChar1">[docs]</a><span class="k">def</span> <span class="nf">isWordChar1</span> <span class="p">(</span><span class="n">ch</span><span class="p">):</span>

    <span class="k">return</span> <span class="n">ch</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ch</span><span class="o">.</span><span class="n">isalpha</span><span class="p">()</span> <span class="ow">or</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;_&#39;</span><span class="p">)</span>
<span class="c">#@+node:ekr.20031218072017.1501: *3* g.reportBadChars</span></div>
<div class="viewcode-block" id="reportBadChars"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.reportBadChars">[docs]</a><span class="k">def</span> <span class="nf">reportBadChars</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">encoding</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isUnicode</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span> <span class="n">ch</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span><span class="s">&quot;strict&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">UnicodeEncodeError</span><span class="p">:</span>
                    <span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                <span class="n">s2</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s"> errors converting </span><span class="si">%s</span><span class="s"> to </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">errors</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span><span class="s">&#39;replace&#39;</span><span class="p">),</span>
                    <span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">,</span><span class="s">&#39;replace&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">isChar</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span><span class="n">encoding</span><span class="p">,</span><span class="s">&quot;strict&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span> <span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                <span class="n">s2</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s"> errors converting </span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s"> encoding) to unicode&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">errors</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">encoding</span><span class="p">,</span><span class="s">&#39;replace&#39;</span><span class="p">),</span>
                    <span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">,</span><span class="s">&#39;replace&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isUnicode</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span> <span class="n">ch</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span><span class="s">&quot;strict&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">UnicodeEncodeError</span><span class="p">:</span>
                    <span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                <span class="n">s2</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s"> errors converting </span><span class="si">%s</span><span class="s"> to </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">errors</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span><span class="s">&#39;replace&#39;</span><span class="p">),</span>
                    <span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">,</span><span class="s">&#39;replace&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">isChar</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span><span class="n">encoding</span><span class="p">,</span><span class="s">&quot;strict&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span> <span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
                <span class="n">s2</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s"> errors converting </span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s"> encoding) to unicode&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">errors</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">encoding</span><span class="p">,</span><span class="s">&#39;replace&#39;</span><span class="p">),</span>
                    <span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">,</span><span class="s">&#39;replace&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span>
<span class="c">#@+node:ekr.20050208093800: *3* g.toEncodedString</span></div>
<div class="viewcode-block" id="toEncodedString"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.toEncodedString">[docs]</a><span class="k">def</span> <span class="nf">toEncodedString</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span><span class="n">reportErrors</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">encoding</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">encoding</span> <span class="o">=</span> <span class="s">&#39;utf-8&#39;</span>

    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isUnicode</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span><span class="s">&quot;strict&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">UnicodeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">reportErrors</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">reportBadChars</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">encoding</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span><span class="s">&quot;replace&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span>
<span class="c">#@+node:ekr.20050208093800.1: *3* g.toUnicode</span></div>
<div class="viewcode-block" id="toUnicode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.toUnicode">[docs]</a><span class="k">def</span> <span class="nf">toUnicode</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span><span class="n">reportErrors</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="c"># The encoding is usually &#39;utf-8&#39;</span>
    <span class="c"># but is may be different while importing or reading files.</span>
    <span class="k">if</span> <span class="n">encoding</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">encoding</span> <span class="o">=</span> <span class="s">&#39;utf-8&#39;</span>

    <span class="k">if</span> <span class="n">isPython3</span><span class="p">:</span>
        <span class="n">f</span><span class="p">,</span><span class="n">mustConvert</span> <span class="o">=</span> <span class="nb">str</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">isBytes</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">unicode</span>
        <span class="k">def</span> <span class="nf">mustConvert</span> <span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">!=</span> <span class="n">types</span><span class="o">.</span><span class="n">UnicodeType</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">u</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">mustConvert</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">encoding</span><span class="p">,</span><span class="s">&#39;strict&#39;</span><span class="p">)</span>
        <span class="c"># except (UnicodeError,UnicodeDecodeError,Exception):</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">encoding</span><span class="p">,</span><span class="s">&#39;replace&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">reportErrors</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">reportBadChars</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">encoding</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;can not convert to unicode!&#39;</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">return</span> <span class="n">s</span>
<span class="c">#@+node:ekr.20091206161352.6232: *3* g.u &amp; g.ue</span></div>
<span class="k">if</span> <span class="n">isPython3</span><span class="p">:</span> <span class="c"># g.not defined yet.</span>
    <span class="k">def</span> <span class="nf">u</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">s</span>
    <span class="k">def</span> <span class="nf">ue</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">encoding</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">encoding</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
<div class="viewcode-block" id="u"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.u">[docs]</a>    <span class="k">def</span> <span class="nf">u</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></div>
<div class="viewcode-block" id="ue"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.ue">[docs]</a>    <span class="k">def</span> <span class="nf">ue</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">encoding</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">encoding</span><span class="p">)</span>
<span class="c">#@+node:ekr.20080919065433.2: *3* toEncodedStringWithErrorCode (for unit testing)</span></div>
<div class="viewcode-block" id="toEncodedStringWithErrorCode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.toEncodedStringWithErrorCode">[docs]</a><span class="k">def</span> <span class="nf">toEncodedStringWithErrorCode</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">encoding</span><span class="p">,</span><span class="n">reportErrors</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="n">ok</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isUnicode</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span><span class="s">&quot;strict&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">reportErrors</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">reportBadChars</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">encoding</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span><span class="s">&quot;replace&quot;</span><span class="p">)</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">,</span> <span class="n">ok</span>
<span class="c">#@+node:ekr.20080919065433.1: *3* toUnicodeWithErrorCode (for unit testing)</span></div>
<div class="viewcode-block" id="toUnicodeWithErrorCode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.toUnicodeWithErrorCode">[docs]</a><span class="k">def</span> <span class="nf">toUnicodeWithErrorCode</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">encoding</span><span class="p">,</span><span class="n">reportErrors</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="n">ok</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span> <span class="n">f</span> <span class="o">=</span> <span class="nb">str</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">f</span> <span class="o">=</span> <span class="nb">unicode</span>
    <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">u</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">isUnicode</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">encoding</span><span class="p">,</span><span class="s">&#39;strict&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">reportErrors</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">reportBadChars</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">encoding</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">encoding</span><span class="p">,</span><span class="s">&#39;replace&#39;</span><span class="p">)</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">,</span><span class="n">ok</span>
<span class="c">#@+node:ekr.20070524083513: ** Unit testing (leoGlobals.py)</span>
<span class="c">#@+node:ekr.20070619173330: *3* g.getTestVars</span></div>
<div class="viewcode-block" id="getTestVars"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.getTestVars">[docs]</a><span class="k">def</span> <span class="nf">getTestVars</span> <span class="p">():</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTestDict</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;c&#39;</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;p&#39;</span><span class="p">)</span>
    <span class="c"># Indicate that getTestVars has run.</span>
    <span class="c"># This is an indirect test that some unit test has run.</span>
    <span class="n">d</span><span class="p">[</span><span class="s">&#39;getTestVars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="n">c</span><span class="p">,</span><span class="n">p</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="c">#@+node:ekr.20100812172650.5909: *3* g.findTestScript</span></div>
<div class="viewcode-block" id="findTestScript"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.findTestScript">[docs]</a><span class="k">def</span> <span class="nf">findTestScript</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">where</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">warn</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">where</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">findNodeAnywhere</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">where</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">findNodeInTree</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">h</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">findNodeAnywhere</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">h</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">p</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">getScript</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">warn</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;Not found&#39;</span><span class="p">,</span><span class="n">h</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>
<span class="c">#@+node:ekr.20120311151914.9916: ** Urls... (leoGlobals.py)</span></div>
<span class="n">kinds</span> <span class="o">=</span> <span class="s">&#39;(file|ftp|gopher|http|https|mailto|news|nntp|prospero|telnet|wais)&#39;</span>
<span class="n">url_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;&quot;&quot;</span><span class="si">%s</span><span class="s">://[^\s&#39;&quot;]+[\w=/]&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kinds</span><span class="p">))</span>
<span class="c">#@+node:ekr.20120320053907.9776: *3* g.computeFileUrl</span>
<div class="viewcode-block" id="computeFileUrl"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.computeFileUrl">[docs]</a><span class="k">def</span> <span class="nf">computeFileUrl</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Compute finalized url for filename fn.</span>
<span class="sd">    This involves adding url escapes and evaluating Leo expressions.&#39;&#39;&#39;</span>


    <span class="c"># Module &#39;urllib&#39; has no &#39;parse&#39; member.</span>
    <span class="n">unquote</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">unquote</span> <span class="k">if</span> <span class="n">isPython3</span> <span class="k">else</span> <span class="n">urllib</span><span class="o">.</span><span class="n">unquote</span> <span class="c"># pylint: disable=E1101</span>

    <span class="c"># First, replace special characters (especially %20, by their equivalent).</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">unquote</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>

    <span class="c"># Finalize the path *before* parsing the url.</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;~&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="c"># Expand &#39;~&#39; and handle Leo expressions.</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">url</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_expanduser</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_expandExpression</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">path</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># Handle Leo expressions.</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="s">&#39;file://&#39;</span>
        <span class="n">tag2</span> <span class="o">=</span> <span class="s">&#39;file:///&#39;</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;win&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">tag2</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">url</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">tag2</span><span class="p">):]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">tag</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">url</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">tag</span><span class="p">):]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">url</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_expandExpression</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
        <span class="c"># Handle ancestor @path directives.</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">openDirectory</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">getNodePath</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">openDirectory</span><span class="p">,</span><span class="n">base</span><span class="p">,</span><span class="n">path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="n">path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">url</span>
<span class="c">#@+node:ekr.20120311151914.9917: *3* g.getUrlFromNode</span></div>
<div class="viewcode-block" id="getUrlFromNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.getUrlFromNode">[docs]</a><span class="k">def</span> <span class="nf">getUrlFromNode</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Get an url from node p:</span>

<span class="sd">    1. Use the headline if it contains a valid url.</span>
<span class="sd">    2. Otherwise, look *only* at the first line of the body.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">context</span>
    <span class="k">assert</span> <span class="n">c</span>

    <span class="n">table</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span> <span class="k">else</span> <span class="s">&#39;&#39;</span><span class="p">]</span>
    <span class="n">table</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span> <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">match_word</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&#39;@url&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">table</span><span class="p">]</span>
    <span class="n">table</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">table</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>

    <span class="c"># First, check for url&#39;s with an explicit scheme.</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">table</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isValidUrl</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">s</span>

    <span class="c"># Next check for existing file and add a file:// scheme.</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">table</span><span class="p">:</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="s">&#39;file://&#39;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">computeFileUrl</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">tag</span><span class="p">):</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">url</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">tag</span><span class="p">):]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c"># g.trace(&#39;fn&#39;,fn)</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_isfile</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
                <span class="c"># Return the *original* url, with a file:// scheme.</span>
                <span class="c"># g.handleUrl will call computeFileUrl again.</span>
                <span class="k">return</span> <span class="s">&#39;file://&#39;</span><span class="o">+</span><span class="n">s</span>

    <span class="c"># Finally, check for local url&#39;s.</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">table</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;#&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">s</span>

    <span class="k">return</span> <span class="bp">None</span>
<span class="c">#@+node:tbrown.20090219095555.63: *3* g.handleUrl</span>
<span class="c">#@+at Most browsers should handle the following urls:</span>
<span class="c">#   ftp://ftp.uu.net/public/whatever.</span>
<span class="c">#   http://localhost/MySiteUnderDevelopment/index.html</span>
<span class="c">#   file:///home/me/todolist.html</span>
<span class="c">#@@c</span>
</div>
<div class="viewcode-block" id="handleUrl"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.handleUrl">[docs]</a><span class="k">def</span> <span class="nf">handleUrl</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="c"># E1101: Module &#39;urllib&#39; has no &#39;parse&#39; member</span>
    <span class="n">unquote</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">unquote</span> <span class="k">if</span> <span class="n">isPython3</span> <span class="k">else</span> <span class="n">urllib</span><span class="o">.</span><span class="n">unquote</span> <span class="c"># pylint: disable=E1101</span>

    <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span> <span class="p">;</span> <span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">c</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>

    <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@url&#39;</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="p">[</span><span class="mi">4</span><span class="p">:]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="s">&#39;file://&#39;</span>
        <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">tag</span><span class="o">+</span><span class="s">&#39;#&#39;</span><span class="p">):</span>
            <span class="c"># Finalize the path *before* parsing the url.</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">computeFileUrl</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>

        <span class="n">parsed</span>   <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

        <span class="c"># pylint: disable=E1103</span>
        <span class="c"># E1103: Instance of &#39;ParseResult&#39; has no &#39;fragment&#39; member</span>
        <span class="c"># E1103: Instance of &#39;ParseResult&#39; has no &#39;netloc&#39; member</span>
        <span class="c"># E1103: Instance of &#39;ParseResult&#39; has no &#39;path&#39; member</span>
        <span class="c"># E1103: Instance of &#39;ParseResult&#39; has no &#39;scheme&#39; member</span>
        <span class="n">fragment</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">fragment</span> 
        <span class="n">netloc</span>   <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">netloc</span>
        <span class="n">path</span>     <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">path</span>
        <span class="n">scheme</span>   <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">scheme</span>

        <span class="k">if</span> <span class="n">netloc</span><span class="p">:</span>
            <span class="n">leo_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">netloc</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="c"># &quot;readme.txt&quot; gets parsed into .netloc...</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">leo_path</span> <span class="o">=</span> <span class="n">path</span>

        <span class="k">if</span> <span class="n">leo_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">):</span> <span class="n">leo_path</span> <span class="o">=</span> <span class="n">leo_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">leo_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">):</span>  <span class="n">leo_path</span> <span class="o">=</span> <span class="n">leo_path</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span><span class="p">()</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;url          &#39;</span><span class="p">,</span><span class="n">url</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;c.frame.title&#39;</span><span class="p">,</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;leo_path     &#39;</span><span class="p">,</span><span class="n">leo_path</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;parsed.netloc&#39;</span><span class="p">,</span><span class="n">netloc</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;parsed.path  &#39;</span><span class="p">,</span><span class="n">path</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;parsed.scheme&#39;</span><span class="p">,</span><span class="n">scheme</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">c</span> <span class="ow">and</span> <span class="n">scheme</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;file&#39;</span><span class="p">):</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">leo_path</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">&#39;--&gt;&#39;</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">recursiveUNLSearch</span><span class="p">(</span><span class="n">unquote</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;--&gt;&quot;</span><span class="p">),</span> <span class="n">c</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span> <span class="ow">and</span> <span class="n">fragment</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">recursiveUNLSearch</span><span class="p">(</span><span class="n">unquote</span><span class="p">(</span><span class="n">fragment</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;--&gt;&quot;</span><span class="p">),</span> <span class="n">c</span><span class="p">)</span>
                    <span class="k">return</span>

            <span class="c"># .leo file</span>
            <span class="k">if</span> <span class="n">leo_path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.leo&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">leo_path</span><span class="p">):</span>
                <span class="c"># Immediately end editing, so that typing in the new window works properly.</span>
                <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span>
                <span class="n">c</span><span class="o">.</span><span class="n">redraw_now</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTestDict</span><span class="p">[</span><span class="s">&#39;g.openWithFileName&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">leo_path</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">c2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">openWithFileName</span><span class="p">(</span><span class="n">leo_path</span><span class="p">,</span><span class="n">old_c</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
                    <span class="c"># with UNL after path</span>
                    <span class="k">if</span> <span class="n">c2</span> <span class="ow">and</span> <span class="n">fragment</span><span class="p">:</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">recursiveUNLSearch</span><span class="p">(</span><span class="n">fragment</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;--&gt;&quot;</span><span class="p">),</span><span class="n">c2</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">c2</span><span class="p">:</span>
                        <span class="n">c2</span><span class="o">.</span><span class="n">bringToFront</span><span class="p">()</span>
                        <span class="k">return</span>

        <span class="c"># isHtml = leo_path.endswith(&#39;.html&#39;) or leo_path.endswith(&#39;.htm&#39;)</span>

        <span class="c"># Use g.os_startfile for *all* files.</span>
        <span class="k">if</span> <span class="n">scheme</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;file&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_exists</span><span class="p">(</span><span class="n">leo_path</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;g.os_startfile(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">leo_path</span><span class="p">))</span>
                <span class="n">leo_path</span> <span class="o">=</span> <span class="n">unquote</span><span class="p">(</span><span class="n">leo_path</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">os_startfile</span><span class="p">(</span><span class="n">leo_path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;File &#39;</span><span class="si">%s</span><span class="s">&#39; does not exist&quot;</span><span class="o">%</span><span class="n">leo_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">webbrowser</span>

            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;webbrowser.open(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTestDict</span><span class="p">[</span><span class="s">&#39;browser&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">url</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># Mozilla throws a weird exception, then opens the file!</span>
                <span class="k">try</span><span class="p">:</span> <span class="n">webbrowser</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>

    <span class="k">except</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;exception opening&quot;</span><span class="p">,</span><span class="n">leo_path</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
<span class="c">#@+node:ekr.20120311151914.9918: *3* g.isValidUrl</span></div>
<div class="viewcode-block" id="isValidUrl"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.isValidUrl">[docs]</a><span class="k">def</span> <span class="nf">isValidUrl</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Return true if url *looks* like a valid url.&#39;&#39;&#39;</span>

    <span class="n">table</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s">&#39;file&#39;</span><span class="p">,</span><span class="s">&#39;ftp&#39;</span><span class="p">,</span><span class="s">&#39;gopher&#39;</span><span class="p">,</span><span class="s">&#39;hdl&#39;</span><span class="p">,</span><span class="s">&#39;http&#39;</span><span class="p">,</span><span class="s">&#39;https&#39;</span><span class="p">,</span><span class="s">&#39;imap&#39;</span><span class="p">,</span>
        <span class="s">&#39;mailto&#39;</span><span class="p">,</span><span class="s">&#39;mms&#39;</span><span class="p">,</span><span class="s">&#39;news&#39;</span><span class="p">,</span><span class="s">&#39;nntp&#39;</span><span class="p">,</span><span class="s">&#39;prospero&#39;</span><span class="p">,</span><span class="s">&#39;rsync&#39;</span><span class="p">,</span><span class="s">&#39;rtsp&#39;</span><span class="p">,</span><span class="s">&#39;rtspu&#39;</span><span class="p">,</span>
        <span class="s">&#39;sftp&#39;</span><span class="p">,</span><span class="s">&#39;shttp&#39;</span><span class="p">,</span><span class="s">&#39;sip&#39;</span><span class="p">,</span><span class="s">&#39;sips&#39;</span><span class="p">,</span><span class="s">&#39;snews&#39;</span><span class="p">,</span><span class="s">&#39;svn&#39;</span><span class="p">,</span><span class="s">&#39;svn+ssh&#39;</span><span class="p">,</span><span class="s">&#39;telnet&#39;</span><span class="p">,</span><span class="s">&#39;wais&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;#--&gt;&#39;</span><span class="p">):</span>
        <span class="c"># All Leo UNL&#39;s.</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">elif</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="c"># E1103: Instance of &#39;ParseResult&#39; has no &#39;scheme&#39; member.</span>
        <span class="n">scheme</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">scheme</span> <span class="c"># pylint: disable=E1103</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">table</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scheme</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>
<span class="c">#@+node:ekr.20120315062642.9744: *3* g.openUrl</span></div>
<div class="viewcode-block" id="openUrl"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.openUrl">[docs]</a><span class="k">def</span> <span class="nf">openUrl</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">url</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">getUrlFromNode</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">url</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">context</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&quot;@url1&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">p</span><span class="p">,</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">handleUrl</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&quot;@url2&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
<span class="c">#@+node:ekr.20110605121601.18135: *3* g.openUrlOnClick (open-url-under-cursor)</span></div>
<div class="viewcode-block" id="openUrlOnClick"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.openUrlOnClick">[docs]</a><span class="k">def</span> <span class="nf">openUrlOnClick</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Open the URL under the cursor.  Return it for unit testing.&#39;&#39;&#39;</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;c&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">bodyCtrl</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getAllText</span><span class="p">()</span>
    <span class="n">ins</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getInsertPoint</span><span class="p">()</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getSelectionRange</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">j</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span> <span class="c"># So find doesn&#39;t open the url.</span>
    <span class="n">row</span><span class="p">,</span><span class="n">col</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">convertPythonIndexToRowCol</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">ins</span><span class="p">)</span>
    <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">getLine</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">ins</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">url_regex</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">():</span> <span class="c"># Don&#39;t open if we click after the url.</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isValidUrl</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&quot;@url1&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">p</span><span class="p">,</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">):</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">handleUrl</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">doHook</span><span class="p">(</span><span class="s">&quot;@url2&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">url</span>
    <span class="k">return</span> <span class="bp">None</span>
<span class="c">#@+node:EKR.20040612114220: ** Utility classes, functions &amp; objects...</span>
<span class="c">#@+node:ekr.20050315073003: *3*  Index utilities... (leoGlobals)</span>
<span class="c">#@+node:ekr.20050314140957: *4* g.convertPythonIndexToRowCol</span></div>
<div class="viewcode-block" id="convertPythonIndexToRowCol"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.convertPythonIndexToRowCol">[docs]</a><span class="k">def</span> <span class="nf">convertPythonIndexToRowCol</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Convert index i into string s into zero-based row/col indices.&#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span>

    <span class="n">i</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>

    <span class="c"># works regardless of what s[i] is</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="c"># Don&#39;t include i</span>
    <span class="k">if</span> <span class="n">row</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">row</span><span class="p">,</span><span class="n">i</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">prevNL</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="c"># Don&#39;t include i</span>
        <span class="c"># g.trace(&#39;prevNL&#39;,prevNL,&#39;i&#39;,i,g.callers())</span>
        <span class="k">return</span> <span class="n">row</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="n">prevNL</span><span class="o">-</span><span class="mi">1</span>
<span class="c">#@+node:ekr.20050315071727: *4* g.convertRowColToPythonIndex</span></div>
<div class="viewcode-block" id="convertRowColToPythonIndex"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.convertRowColToPythonIndex">[docs]</a><span class="k">def</span> <span class="nf">convertRowColToPythonIndex</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">,</span><span class="n">lines</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Convert zero-based row/col indices into a python index into string s.&#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">lines</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">row</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="n">col</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">row</span><span class="p">]))</span>

    <span class="c"># A big bottleneck</span>
    <span class="n">prev</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[:</span><span class="n">row</span><span class="p">]:</span>
        <span class="n">prev</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">prev</span> <span class="o">+</span> <span class="n">col</span>
<span class="c">#@+node:ekr.20031218072017.3140: *3*  List utilities...</span>
<span class="c">#@+node:ekr.20031218072017.3141: *4* appendToList</span></div>
<div class="viewcode-block" id="appendToList"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.appendToList">[docs]</a><span class="k">def</span> <span class="nf">appendToList</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="c">#@+node:ekr.20031218072017.3142: *4* flattenList</span></div>
<div class="viewcode-block" id="flattenList"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.flattenList">[docs]</a><span class="k">def</span> <span class="nf">flattenList</span> <span class="p">(</span><span class="n">theList</span><span class="p">):</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">theList</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">==</span> <span class="n">types</span><span class="o">.</span><span class="n">ListType</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">flattenList</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
<span class="c">#@+node:ekr.20060221081328: *4* maxStringListLength</span></div>
<div class="viewcode-block" id="maxStringListLength"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.maxStringListLength">[docs]</a><span class="k">def</span> <span class="nf">maxStringListLength</span><span class="p">(</span><span class="n">aList</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Return the maximum string length in a list of strings.&#39;&#39;&#39;</span>

    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isString</span><span class="p">():</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">n</span>
<span class="c">#@+node:ekr.20031218072017.3106: *3* angleBrackets &amp; virtual_event_name</span>
<span class="c"># Returns &lt; &lt; s &gt; &gt;</span>
</div>
<div class="viewcode-block" id="angleBrackets"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.angleBrackets">[docs]</a><span class="k">def</span> <span class="nf">angleBrackets</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>

    <span class="k">return</span> <span class="p">(</span> <span class="s">&quot;&lt;&lt;&quot;</span> <span class="o">+</span> <span class="n">s</span> <span class="o">+</span>
        <span class="s">&quot;&gt;&gt;&quot;</span><span class="p">)</span> <span class="c"># must be on a separate line.</span>
</div>
<span class="n">virtual_event_name</span> <span class="o">=</span> <span class="n">angleBrackets</span>
<span class="c">#@+node:ekr.20031218072017.3097: *3* CheckVersion</span>
<span class="c">#@+node:ekr.20060921100435: *4* CheckVersion, helper</span>
<span class="c"># Simplified version by EKR: stringCompare not used.</span>

<div class="viewcode-block" id="CheckVersion"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.CheckVersion">[docs]</a><span class="k">def</span> <span class="nf">CheckVersion</span> <span class="p">(</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">,</span><span class="n">condition</span><span class="o">=</span><span class="s">&quot;&gt;=&quot;</span><span class="p">,</span><span class="n">stringCompare</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;.&#39;</span><span class="p">,</span><span class="n">trace</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="c"># CheckVersion is called early in the startup process.</span>

    <span class="n">vals1</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">CheckVersionToInt</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">s1</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">delimiter</span><span class="p">)]</span> <span class="p">;</span> <span class="n">n1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals1</span><span class="p">)</span>
    <span class="n">vals2</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">CheckVersionToInt</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">s2</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">delimiter</span><span class="p">)]</span> <span class="p">;</span> <span class="n">n2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals2</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">n1</span><span class="p">,</span><span class="n">n2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n1</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span> <span class="n">vals1</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">n1</span><span class="p">)])</span>
    <span class="k">if</span> <span class="n">n2</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span> <span class="n">vals2</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">n2</span><span class="p">)])</span>
    <span class="k">for</span> <span class="n">cond</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="p">(</span><span class="s">&#39;==&#39;</span><span class="p">,</span> <span class="n">vals1</span> <span class="o">==</span> <span class="n">vals2</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;!=&#39;</span><span class="p">,</span> <span class="n">vals1</span> <span class="o">!=</span> <span class="n">vals2</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;&lt;&#39;</span><span class="p">,</span>  <span class="n">vals1</span> <span class="o">&lt;</span>  <span class="n">vals2</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;&lt;=&#39;</span><span class="p">,</span> <span class="n">vals1</span> <span class="o">&lt;=</span> <span class="n">vals2</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;&gt;&#39;</span><span class="p">,</span>  <span class="n">vals1</span> <span class="o">&gt;</span>  <span class="n">vals2</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;&gt;=&#39;</span><span class="p">,</span> <span class="n">vals1</span> <span class="o">&gt;=</span> <span class="n">vals2</span><span class="p">),</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">condition</span> <span class="o">==</span> <span class="n">cond</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">val</span> <span class="p">;</span> <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span><span class="s">&quot;condition must be one of &#39;&gt;=&#39;, &#39;&gt;&#39;, &#39;==&#39;, &#39;!=&#39;, &#39;&lt;&#39;, or &#39;&lt;=&#39;.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
        <span class="c"># g.pr(&#39;%10s&#39; % (repr(vals1)),&#39;%2s&#39; % (condition),&#39;%10s&#39; % (repr(vals2)),result)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%7s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s1</span><span class="p">),</span><span class="s">&#39;</span><span class="si">%2s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">condition</span><span class="p">),</span><span class="s">&#39;</span><span class="si">%7s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">s2</span><span class="p">),</span><span class="n">result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
<span class="c">#@+node:ekr.20070120123930: *5* CheckVersionToInt</span></div>
<div class="viewcode-block" id="CheckVersionToInt"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.CheckVersionToInt">[docs]</a><span class="k">def</span> <span class="nf">CheckVersionToInt</span> <span class="p">(</span><span class="n">s</span><span class="p">):</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">aList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ch</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span> <span class="n">aList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">break</span>
        <span class="k">if</span> <span class="n">aList</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">aList</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
<span class="c">#@+node:ekr.20060921100435.1: *4* oldCheckVersion (Dave Hein)</span>
<span class="c">#@+at g.CheckVersion() is a generic version checker.  Assumes a</span>
<span class="c"># version string of up to four parts, or tokens, with</span>
<span class="c"># leftmost token being most significant and each token</span>
<span class="c"># becoming less signficant in sequence to the right.</span>
<span class="c"># </span>
<span class="c"># RETURN VALUE</span>
<span class="c"># </span>
<span class="c"># 1 if comparison is True</span>
<span class="c"># 0 if comparison is False</span>
<span class="c"># </span>
<span class="c"># PARAMETERS</span>
<span class="c"># </span>
<span class="c"># version: the version string to be tested</span>
<span class="c"># againstVersion: the reference version string to be</span>
<span class="c">#               compared against</span>
<span class="c"># condition: can be any of &quot;==&quot;, &quot;!=&quot;, &quot;&gt;=&quot;, &quot;&lt;=&quot;, &quot;&gt;&quot;, or &quot;&lt;&quot;</span>
<span class="c"># stringCompare: whether to test a token using only the</span>
<span class="c">#              leading integer of the token, or using the</span>
<span class="c">#              entire token string.  For example, a value</span>
<span class="c">#              of &quot;0.0.1.0&quot; means that we use the integer</span>
<span class="c">#              value of the first, second, and fourth</span>
<span class="c">#              tokens, but we use a string compare for the</span>
<span class="c">#              third version token.</span>
<span class="c"># delimiter: the character that separates the tokens in the</span>
<span class="c">#          version strings.</span>
<span class="c"># </span>
<span class="c"># The comparison uses the precision of the version string</span>
<span class="c"># with the least number of tokens.  For example a test of</span>
<span class="c"># &quot;8.4&quot; against &quot;8.3.3&quot; would just compare the first two</span>
<span class="c"># tokens.</span>
<span class="c"># </span>
<span class="c"># The version strings are limited to a maximum of 4 tokens.</span>
<span class="c">#@@c</span>
</div>
<div class="viewcode-block" id="oldCheckVersion"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.oldCheckVersion">[docs]</a><span class="k">def</span> <span class="nf">oldCheckVersion</span><span class="p">(</span> <span class="n">version</span><span class="p">,</span> <span class="n">againstVersion</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="s">&quot;&gt;=&quot;</span><span class="p">,</span> <span class="n">stringCompare</span><span class="o">=</span><span class="s">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s">&#39;.&#39;</span> <span class="p">):</span>

    <span class="c"># tokenize the stringCompare flags</span>
    <span class="n">compareFlag</span> <span class="o">=</span> <span class="n">stringCompare</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>

    <span class="c"># tokenize the version strings</span>
    <span class="n">testVersion</span> <span class="o">=</span> <span class="n">version</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">delimiter</span><span class="p">)</span>
    <span class="n">testAgainst</span> <span class="o">=</span> <span class="n">againstVersion</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">delimiter</span><span class="p">)</span>

    <span class="c"># find the &#39;precision&#39; of the comparison</span>
    <span class="n">tokenCount</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="k">if</span> <span class="n">tokenCount</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">testAgainst</span><span class="p">):</span>
        <span class="n">tokenCount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">testAgainst</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tokenCount</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">testVersion</span><span class="p">):</span>
        <span class="n">tokenCount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">testVersion</span><span class="p">)</span>

    <span class="c"># Apply the stringCompare flags</span>
    <span class="n">justInteger</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;^[0-9]+&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tokenCount</span><span class="p">):</span>
        <span class="k">if</span> <span class="s">&quot;0&quot;</span> <span class="o">==</span> <span class="n">compareFlag</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">justInteger</span><span class="o">.</span><span class="n">match</span><span class="p">(</span> <span class="n">testVersion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">testVersion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">justInteger</span><span class="o">.</span><span class="n">match</span><span class="p">(</span> <span class="n">testAgainst</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span>
            <span class="n">testAgainst</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
        <span class="k">elif</span> <span class="s">&quot;1&quot;</span> <span class="o">!=</span> <span class="n">compareFlag</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">errMsg</span> <span class="o">=</span> <span class="s">&quot;stringCompare argument must be of &quot;</span> <span class="o">+</span>\
                 <span class="s">&quot;the form </span><span class="se">\&quot;</span><span class="s">x.x.x.x</span><span class="se">\&quot;</span><span class="s"> where each &quot;</span> <span class="o">+</span>\
                 <span class="s">&quot;&#39;x&#39; is either &#39;0&#39; or &#39;1&#39;.&quot;</span>
            <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span><span class="n">errMsg</span><span class="p">)</span>

    <span class="c"># Compare the versions</span>
    <span class="k">if</span> <span class="n">condition</span> <span class="o">==</span> <span class="s">&quot;&gt;=&quot;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tokenCount</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">testVersion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">testAgainst</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">testVersion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">testAgainst</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">return</span> <span class="mi">1</span> <span class="c"># it was greater than</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="c"># it was equal</span>
    <span class="k">if</span> <span class="n">condition</span> <span class="o">==</span> <span class="s">&quot;&gt;&quot;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tokenCount</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">testVersion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">testAgainst</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">testVersion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">testAgainst</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">return</span> <span class="mi">1</span> <span class="c"># it was greater than</span>
        <span class="k">return</span> <span class="mi">0</span> <span class="c"># it was equal</span>
    <span class="k">if</span> <span class="n">condition</span> <span class="o">==</span> <span class="s">&quot;==&quot;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tokenCount</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">testVersion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">testAgainst</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">return</span> <span class="mi">0</span> <span class="c"># any token was not equal</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="c"># every token was equal</span>
    <span class="k">if</span> <span class="n">condition</span> <span class="o">==</span> <span class="s">&quot;!=&quot;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tokenCount</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">testVersion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">testAgainst</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">return</span> <span class="mi">1</span> <span class="c"># any token was not equal</span>
        <span class="k">return</span> <span class="mi">0</span> <span class="c"># every token was equal</span>
    <span class="k">if</span> <span class="n">condition</span> <span class="o">==</span> <span class="s">&quot;&lt;&quot;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tokenCount</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">testVersion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">testAgainst</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">testVersion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">testAgainst</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">return</span> <span class="mi">1</span> <span class="c"># it was less than</span>
        <span class="k">return</span> <span class="mi">0</span> <span class="c"># it was equal</span>
    <span class="k">if</span> <span class="n">condition</span> <span class="o">==</span> <span class="s">&quot;&lt;=&quot;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tokenCount</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">testVersion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">testAgainst</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">testVersion</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">testAgainst</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">return</span> <span class="mi">1</span> <span class="c"># it was less than</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="c"># it was equal</span>

    <span class="c"># didn&#39;t find a condition that we expected.</span>
    <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span><span class="s">&quot;condition must be one of &#39;&gt;=&#39;, &#39;&gt;&#39;, &#39;==&#39;, &#39;!=&#39;, &#39;&lt;&#39;, or &#39;&lt;=&#39;.&quot;</span><span class="p">)</span>
<span class="c">#@+node:ekr.20031218072017.3098: *3* class Bunch (object)</span>
<span class="c">#@+at From The Python Cookbook: Often we want to just collect a bunch of</span>
<span class="c"># stuff together, naming each item of the bunch; a dictionary&#39;s OK for</span>
<span class="c"># that, but a small do-nothing class is even handier, and prettier to</span>
<span class="c"># use.</span>
<span class="c"># </span>
<span class="c"># Create a Bunch whenever you want to group a few variables:</span>
<span class="c"># </span>
<span class="c">#     point = Bunch(datum=y, squared=y*y, coord=x)</span>
<span class="c"># </span>
<span class="c"># You can read/write the named attributes you just created, add others,</span>
<span class="c"># del some of them, etc:</span>
<span class="c">#     if point.squared &gt; threshold:</span>
<span class="c">#         point.isok = True</span>
<span class="c">#@@c</span>
</div>
<div class="viewcode-block" id="Bunch"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.Bunch">[docs]</a><span class="k">class</span> <span class="nc">Bunch</span> <span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;A class that represents a colection of things.</span>

<span class="sd">    Especially useful for representing a collection of related variables.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">keywords</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">update</span> <span class="p">(</span><span class="n">keywords</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span>

<div class="viewcode-block" id="Bunch.ivars"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.Bunch.ivars">[docs]</a>    <span class="k">def</span> <span class="nf">ivars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Bunch.keys"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.Bunch.keys">[docs]</a>    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Bunch.toString"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.Bunch.toString">[docs]</a>    <span class="k">def</span> <span class="nf">toString</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;tag&#39;</span><span class="p">)</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ivars</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s">&#39;tag&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">tag</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;Bunch(tag=</span><span class="si">%s</span><span class="s">)...</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">entries</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;Bunch...</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>

    <span class="c"># Used by new undo code.</span></div>
    <span class="k">def</span> <span class="nf">__setitem__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Support aBunch[key] = val&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">operator</span><span class="o">.</span><span class="n">setitem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Support aBunch[key]&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">operator</span><span class="o">.</span><span class="n">getitem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">,</span><span class="n">key</span><span class="p">)</span>

<div class="viewcode-block" id="Bunch.get"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.Bunch.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">theDefault</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">theDefault</span><span class="p">)</span>
</div></div>
<span class="n">bunch</span> <span class="o">=</span> <span class="n">Bunch</span>
<span class="c">#@+node:ekr.20031219074948.1: *3* class nullObject</span>
<span class="c"># From the Python cookbook, recipe 5.23</span>

<span class="c"># This is now defined at the start of this file.</span>
<span class="c">#@+node:ville.20090827174345.9963: *3* g.assertui</span>
<div class="viewcode-block" id="UiTypeException"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.UiTypeException">[docs]</a><span class="k">class</span> <span class="nc">UiTypeException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="assertUi"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.assertUi">[docs]</a><span class="k">def</span> <span class="nf">assertUi</span><span class="p">(</span><span class="n">uitype</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">guiName</span><span class="p">()</span> <span class="o">==</span> <span class="n">uitype</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UiTypeException</span>
<span class="c">#@+node:ekr.20111103205308.9657: *3* g.cls</span></div>
<div class="viewcode-block" id="cls"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.cls">[docs]</a><span class="k">def</span> <span class="nf">cls</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Clear the screen.&#39;&#39;&#39;</span>

    <span class="kn">import</span> <span class="nn">os</span>
    <span class="kn">import</span> <span class="nn">sys</span>

    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;win&#39;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;cls&#39;</span><span class="p">)</span>
<span class="c">#@+node:ekr.20031218072017.3103: *3* g.computeWindowTitle</span></div>
<div class="viewcode-block" id="computeWindowTitle"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.computeWindowTitle">[docs]</a><span class="k">def</span> <span class="nf">computeWindowTitle</span> <span class="p">(</span><span class="n">fileName</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">fileName</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;untitled&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">path</span><span class="p">,</span><span class="n">fn</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_split</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">fn</span> <span class="o">+</span> <span class="s">&quot; in &quot;</span> <span class="o">+</span> <span class="n">path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">fn</span>
        <span class="k">return</span> <span class="n">title</span>
<span class="c">#@+node:ekr.20090516135452.5777: *3* g.ensureLeading/TrailingNewlines</span></div>
<div class="viewcode-block" id="ensureLeadingNewlines"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.ensureLeadingNewlines">[docs]</a><span class="k">def</span> <span class="nf">ensureLeadingNewlines</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">removeLeading</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\t\n\r</span><span class="s"> &#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">*</span> <span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">s</span>
</div>
<div class="viewcode-block" id="ensureTrailingNewlines"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.ensureTrailingNewlines">[docs]</a><span class="k">def</span> <span class="nf">ensureTrailingNewlines</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">removeTrailing</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\t\n\r</span><span class="s"> &#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">*</span> <span class="n">n</span>


<span class="c">#@+node:ekr.20031218072017.3138: *3* g.executeScript</span></div>
<div class="viewcode-block" id="executeScript"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.executeScript">[docs]</a><span class="k">def</span> <span class="nf">executeScript</span> <span class="p">(</span><span class="n">name</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Execute a script whose short python file name is given.</span>

<span class="sd">    This is called only from the scripts_menu plugin.&quot;&quot;&quot;</span>

    <span class="n">mod_name</span><span class="p">,</span><span class="n">ext</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_splitext</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">theFile</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c"># This code is in effect an import or a reload.</span>
        <span class="c"># This allows the user to modify scripts without leaving Leo.</span>
        <span class="n">theFile</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">description</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">find_module</span><span class="p">(</span><span class="n">mod_name</span><span class="p">)</span>
        <span class="n">imp</span><span class="o">.</span><span class="n">load_module</span><span class="p">(</span><span class="n">mod_name</span><span class="p">,</span><span class="n">theFile</span><span class="p">,</span><span class="n">filename</span><span class="p">,</span><span class="n">description</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;exception executing&quot;</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">theFile</span><span class="p">:</span>
        <span class="n">theFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="c">#@+node:tbrown.20130411121812.28336: *3* g.expand_css_constants</span></div>
<div class="viewcode-block" id="expand_css_constants"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.expand_css_constants">[docs]</a><span class="k">def</span> <span class="nf">expand_css_constants</span><span class="p">(</span><span class="n">sheet</span><span class="p">,</span> <span class="n">font_size_delta</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    
    <span class="n">constants</span> <span class="o">=</span> <span class="n">find_constants_defined</span><span class="p">(</span><span class="n">sheet</span><span class="p">)</span>
    
    <span class="c"># adjust @font-size-body by font_size_delta</span>
    <span class="c"># easily extendable to @font-size-*</span>
    <span class="k">if</span> <span class="n">font_size_delta</span> <span class="ow">and</span> <span class="s">&quot;@font-size-body&quot;</span> <span class="ow">in</span> <span class="n">constants</span><span class="p">:</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">constants</span><span class="p">[</span><span class="s">&quot;@font-size-body&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;px&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">250</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">+</span> <span class="n">font_size_delta</span><span class="p">))</span>
        
        <span class="n">constants</span><span class="p">[</span><span class="s">&quot;@font-size-body&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">px&quot;</span> <span class="o">%</span> <span class="n">size</span>
    
    <span class="k">for</span> <span class="n">const</span> <span class="ow">in</span> <span class="n">constants</span><span class="p">:</span>
        <span class="n">sheet</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
            <span class="n">const</span><span class="o">+</span><span class="s">&quot;(?![-A-Za-z0-9_])&quot;</span><span class="p">,</span>  
            <span class="c"># don&#39;t replace shorter constants occuring in larger</span>
            <span class="n">constants</span><span class="p">[</span><span class="n">const</span><span class="p">],</span>
            <span class="n">sheet</span>
        <span class="p">)</span>
        
    <span class="k">return</span> <span class="n">sheet</span>
<span class="c">#@+node:ekr.20040331083824.1: *3* g.fileLikeObject</span>
<span class="c"># Note: we could use StringIo for this.</span>
</div>
<div class="viewcode-block" id="fileLikeObject"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.fileLikeObject">[docs]</a><span class="k">class</span> <span class="nc">fileLikeObject</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;Define a file-like object for redirecting writes to a string.</span>

<span class="sd">    The caller is responsible for handling newlines correctly.&quot;&quot;&quot;</span>

    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20050404151753: *4*  ctor (g.fileLikeObject)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span><span class="n">fromString</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="c"># g.trace(&#39;g.fileLikeObject:__init__&#39;,&#39;fromString&#39;,fromString)</span>

        <span class="c"># New in 4.2.1: allow the file to be inited from string s.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">encoding</span> <span class="ow">or</span> <span class="s">&#39;utf-8&#39;</span>

        <span class="k">if</span> <span class="n">fromString</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">fromString</span><span class="p">)</span> <span class="c"># Must preserve newlines!</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c"># In CStringIO the buffer is read-only if the initial value (fromString) is non-empty.</span>
    <span class="c">#@+node:ekr.20050404151753.1: *4* clear</span>
<div class="viewcode-block" id="fileLikeObject.clear"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.fileLikeObject.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c">#@+node:ekr.20050404151753.2: *4* close</span></div>
<div class="viewcode-block" id="fileLikeObject.close"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.fileLikeObject.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">pass</span>

        <span class="c"># The StringIo version free&#39;s the memory buffer.</span>
    <span class="c">#@+node:ekr.20050404151753.3: *4* flush</span></div>
<div class="viewcode-block" id="fileLikeObject.flush"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.fileLikeObject.flush">[docs]</a>    <span class="k">def</span> <span class="nf">flush</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">pass</span>
    <span class="c">#@+node:ekr.20050404151753.4: *4* get &amp; getvalue &amp; read</span></div>
<div class="viewcode-block" id="fileLikeObject.get"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.fileLikeObject.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">)</span>
</div>
    <span class="n">getvalue</span> <span class="o">=</span> <span class="n">get</span> <span class="c"># for compatibility with StringIo</span>
    <span class="n">read</span> <span class="o">=</span> <span class="n">get</span> <span class="c"># for use by sax.</span>
    <span class="c">#@+node:ekr.20050404151753.5: *4* readline</span>
<div class="viewcode-block" id="fileLikeObject.readline"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.fileLikeObject.readline">[docs]</a>    <span class="k">def</span> <span class="nf">readline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c"># New for read-from-string (readOpenFile).</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ptr</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ptr</span><span class="p">]</span>
            <span class="c"># g.trace(repr(line))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ptr</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">line</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;&#39;</span>
    <span class="c">#@+node:ekr.20050404151753.6: *4* write</span></div>
<div class="viewcode-block" id="fileLikeObject.write"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.fileLikeObject.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isBytes</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="c">#@-others</span>
<span class="c">#@+node:tbrown.20130411121812.28335: *3* g.find_constants_defined</span></div></div>
<div class="viewcode-block" id="find_constants_defined"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.find_constants_defined">[docs]</a><span class="k">def</span> <span class="nf">find_constants_defined</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;find_constants - Return a dict of constants defined in the supplied text,</span>
<span class="sd">    constants match::</span>
<span class="sd">    </span>
<span class="sd">        ^\s*(@[A-Za-z_][-A-Za-z0-9_]*)\s*=\s*(.*)$</span>
<span class="sd">        i.e.</span>
<span class="sd">        @foo_1-5=a</span>
<span class="sd">            @foo_1-5 = a more here</span>

<span class="sd">    :Parameters:</span>
<span class="sd">    - `text`: text to search</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;^\s*(@[A-Za-z_][-A-Za-z0-9_]*)\s*=\s*(.*)$&quot;</span><span class="p">)</span>
    
    <span class="n">ans</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>  <span class="c"># merge lines ending in \</span>
    
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">):</span>
        <span class="n">test</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">test</span><span class="p">:</span>
            <span class="n">ans</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">test</span><span class="o">.</span><span class="n">groups</span><span class="p">()])</span>

    <span class="c"># constants may refer to other constants, de-reference here    </span>
    <span class="n">change</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">change</span> <span class="ow">and</span> <span class="n">level</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">level</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">change</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ans</span><span class="p">:</span>
            <span class="c"># process longest first so @solarized-base0 is not replaced</span>
            <span class="c"># when it&#39;s part of @solarized-base03</span>
            <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ans</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">ans</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                    <span class="n">change</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="n">ans</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">ans</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">ans</span><span class="p">[</span><span class="n">o</span><span class="p">])</span>
    
    <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Ten levels of recursion processing styles, abandoned.&quot;</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;Ten levels of recursion processing styles, abandoned.&quot;</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">ans</span>
<span class="c">#@+node:ekr.20031218072017.3126: *3* g.funcToMethod</span>
<span class="c">#@+at The following is taken from page 188 of the Python Cookbook.</span>
<span class="c"># </span>
<span class="c"># The following method allows you to add a function as a method of any class. That</span>
<span class="c"># is, it converts the function to a method of the class. The method just added is</span>
<span class="c"># available instantly to all existing instances of the class, and to all instances</span>
<span class="c"># created in the future.</span>
<span class="c"># </span>
<span class="c"># The function&#39;s first argument should be self.</span>
<span class="c"># </span>
<span class="c"># The newly created method has the same name as the function unless the optional</span>
<span class="c"># name argument is supplied, in which case that name is used as the method name.</span>
<span class="c">#@@c</span>
</div>
<div class="viewcode-block" id="funcToMethod"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.funcToMethod">[docs]</a><span class="k">def</span> <span class="nf">funcToMethod</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">theClass</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="nb">setattr</span><span class="p">(</span><span class="n">theClass</span><span class="p">,</span><span class="n">name</span> <span class="ow">or</span> <span class="n">f</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span><span class="n">f</span><span class="p">)</span>
    <span class="c"># g.trace(name)</span>
<span class="c">#@+node:ekr.20120123143207.10223: *3* g.GeneralSetting &amp; isGeneralSetting</span>
<span class="c"># Important: The startup code uses this class,</span>
<span class="c"># so it is convenient to define it in leoGlobals.py.</span></div>
<div class="viewcode-block" id="GeneralSetting"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.GeneralSetting">[docs]</a><span class="k">class</span> <span class="nc">GeneralSetting</span><span class="p">:</span>

    <span class="sd">&#39;&#39;&#39;A class representing any kind of setting except shortcuts.&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">kind</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">ivar</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">setting</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">val</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">tag</span><span class="o">=</span><span class="s">&#39;setting&#39;</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">encoding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ivar</span> <span class="o">=</span> <span class="n">ivar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="n">kind</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setting</span> <span class="o">=</span> <span class="n">setting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span>

    <span class="k">def</span> <span class="nf">__repr__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;GeneralSetting kind: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">)]</span>
        <span class="n">ivars</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;ivar&#39;</span><span class="p">,</span><span class="s">&#39;path&#39;</span><span class="p">,</span><span class="s">&#39;setting&#39;</span><span class="p">,</span><span class="s">&#39;val&#39;</span><span class="p">,</span><span class="s">&#39;tag&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ivar</span> <span class="ow">in</span> <span class="n">ivars</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ivar</span><span class="p">):</span>
                <span class="n">val</span> <span class="o">=</span>  <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ivar</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ivar</span><span class="p">,</span><span class="n">val</span><span class="p">))</span>
        <span class="k">return</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="n">dump</span> <span class="o">=</span> <span class="n">__repr__</span>
</div>
<div class="viewcode-block" id="isGeneralSetting"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.isGeneralSetting">[docs]</a><span class="k">def</span> <span class="nf">isGeneralSetting</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">GeneralSetting</span><span class="p">)</span>
<span class="c">#@+node:ekr.20111017204736.15898: *3* g.getDocString</span></div>
<div class="viewcode-block" id="getDocString"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.getDocString">[docs]</a><span class="k">def</span> <span class="nf">getDocString</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Return the text of the first docstring found in s.&#39;&#39;&#39;</span>

    <span class="n">tags</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;&quot;&quot;&quot;&#39;</span><span class="p">,</span><span class="s">&quot;&#39;&#39;&#39;&quot;</span><span class="p">)</span>
    <span class="n">tag1</span><span class="p">,</span><span class="n">tag2</span> <span class="o">=</span> <span class="n">tags</span>
    <span class="n">i1</span><span class="p">,</span><span class="n">i2</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">tag1</span><span class="p">),</span><span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">tag2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">i1</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">i2</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">i1</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">i2</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span><span class="n">i2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span><span class="n">i2</span><span class="p">)</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags</span>

    <span class="n">j</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span>

<span class="c">#@+node:ekr.20111017211256.15905: *3* g.getDocStringForFunction</span></div>
<div class="viewcode-block" id="getDocStringForFunction"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.getDocStringForFunction">[docs]</a><span class="k">def</span> <span class="nf">getDocStringForFunction</span> <span class="p">(</span><span class="n">func</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Return the docstring for a function that creates a Leo command.&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span><span class="s">&#39;__name__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">func</span><span class="o">.</span><span class="n">__name__</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">get_defaults</span><span class="p">(</span><span class="n">func</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
        <span class="n">args</span><span class="p">,</span> <span class="n">varargs</span><span class="p">,</span> <span class="n">keywords</span><span class="p">,</span> <span class="n">defaults</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">defaults</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">name</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;minibufferCallback&#39;</span><span class="p">:</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">get_defaults</span><span class="p">(</span><span class="n">func</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;commonCommandCallback&#39;</span><span class="p">:</span>
            <span class="n">script</span> <span class="o">=</span> <span class="n">get_defaults</span><span class="p">(</span><span class="n">func</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">getDocString</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span><span class="s">&#39;docstring&#39;</span><span class="p">):</span> <span class="c"># atButtonCallback object.</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">docstring</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span><span class="s">&#39;__doc__&#39;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">__doc__</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;**oops&#39;</span><span class="p">,</span><span class="n">func</span><span class="p">)</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">__doc__</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>

    <span class="k">return</span> <span class="n">s</span>
<span class="c">#@+node:ekr.20061031102333.2: *3* g.getWord &amp; getLine</span></div>
<div class="viewcode-block" id="getWord"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.getWord">[docs]</a><span class="k">def</span> <span class="nf">getWord</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Return i,j such that s[i:j] is the word surrounding s[i].&#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):</span> <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c"># Scan backwards.</span>
    <span class="k">while</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">isWordChar</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
        <span class="n">i</span><span class="o">-=</span> <span class="mi">1</span>
    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c"># Scan forwards.</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">i</span>
    <span class="k">while</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">isWordChar</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
        <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span>
</div>
<div class="viewcode-block" id="getLine"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.getLine">[docs]</a><span class="k">def</span> <span class="nf">getLine</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Return i,j such that s[i:j] is the line surrounding s[i].</span>
<span class="sd">    s[i] is a newline only if the line is empty.</span>
<span class="sd">    s[j] is a newline unless there is no trailing newline.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):</span> <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span> <span class="c"># Bug fix: 10/6/07 (was if i &gt;= len(s))</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="c"># A newline *ends* the line, so look to the left of a newline.</span>
    <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>       <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>       <span class="n">k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="c"># g.trace(&#39;i,j,k&#39;,i,j,k,repr(s[j:k]))</span>
    <span class="k">return</span> <span class="n">j</span><span class="p">,</span><span class="n">k</span>
<span class="c">#@+node:ekr.20110609125359.16493: *3* g.isMacOS</span></div>
<div class="viewcode-block" id="isMacOS"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.isMacOS">[docs]</a><span class="k">def</span> <span class="nf">isMacOS</span><span class="p">():</span>

    <span class="k">return</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&#39;darwin&#39;</span>
<span class="c">#@+node:ekr.20050920084036.4: *3* g.longestCommonPrefix &amp; g.itemsMatchingPrefixInList</span></div>
<div class="viewcode-block" id="longestCommonPrefix"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.longestCommonPrefix">[docs]</a><span class="k">def</span> <span class="nf">longestCommonPrefix</span> <span class="p">(</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Find the longest prefix common to strings s1 and s2.&#39;&#39;&#39;</span>

    <span class="n">prefix</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">s1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">s2</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">ch</span><span class="p">):</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">ch</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">prefix</span>
    <span class="k">return</span> <span class="n">prefix</span>
</div>
<div class="viewcode-block" id="itemsMatchingPrefixInList"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.itemsMatchingPrefixInList">[docs]</a><span class="k">def</span> <span class="nf">itemsMatchingPrefixInList</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">aList</span><span class="p">,</span><span class="n">matchEmptyPrefix</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;This method returns a sorted list items of aList whose prefix is s.</span>

<span class="sd">    It also returns the longest common prefix of all the matches.&#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
        <span class="n">pmatches</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">aList</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">s</span><span class="p">)]</span>
    <span class="k">elif</span> <span class="n">matchEmptyPrefix</span><span class="p">:</span>
        <span class="n">pmatches</span> <span class="o">=</span> <span class="n">aList</span><span class="p">[:]</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">pmatches</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">pmatches</span><span class="p">:</span>
        <span class="n">pmatches</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">common_prefix</span> <span class="o">=</span> <span class="nb">reduce</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">longestCommonPrefix</span><span class="p">,</span><span class="n">pmatches</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">common_prefix</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

    <span class="c"># g.trace(repr(s),len(pmatches))</span>
    <span class="k">return</span> <span class="n">pmatches</span><span class="p">,</span><span class="n">common_prefix</span>
<span class="c">#@+node:ekr.20031218072017.3144: *3* g.makeDict</span>
<span class="c"># From the Python cookbook.</span>
</div>
<div class="viewcode-block" id="makeDict"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.makeDict">[docs]</a><span class="k">def</span> <span class="nf">makeDict</span><span class="p">(</span><span class="o">**</span><span class="n">keys</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Returns a Python dictionary from using the optional keyword arguments.&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">keys</span>
<span class="c">#@+node:ekr.20060221083356: *3* g.prettyPrintType</span></div>
<div class="viewcode-block" id="prettyPrintType"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.prettyPrintType">[docs]</a><span class="k">def</span> <span class="nf">prettyPrintType</span> <span class="p">(</span><span class="n">obj</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">,</span><span class="n">types</span><span class="o">.</span><span class="n">BuiltinMethodType</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&#39;method&#39;</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">BuiltinFunctionType</span><span class="p">,</span><span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&#39;function&#39;</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">==</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;module&#39;</span>
        <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">isString</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&#39;string&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">theType</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">theType</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;&lt;type &#39;&quot;</span><span class="p">):</span> <span class="n">theType</span> <span class="o">=</span> <span class="n">theType</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span>
            <span class="k">if</span> <span class="n">theType</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;&#39;&gt;&quot;</span><span class="p">):</span> <span class="n">theType</span> <span class="o">=</span> <span class="n">theType</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">theType</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">,</span><span class="n">types</span><span class="o">.</span><span class="n">UnboundMethodType</span><span class="p">,</span><span class="n">types</span><span class="o">.</span><span class="n">BuiltinMethodType</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&#39;method&#39;</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">BuiltinFunctionType</span><span class="p">,</span><span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&#39;function&#39;</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">==</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;module&#39;</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">==</span> <span class="n">types</span><span class="o">.</span><span class="n">InstanceType</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;object&#39;</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">UnicodeType</span><span class="p">,</span><span class="n">types</span><span class="o">.</span><span class="n">StringType</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&#39;string&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">theType</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">theType</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;&lt;type &#39;&quot;</span><span class="p">):</span> <span class="n">theType</span> <span class="o">=</span> <span class="n">theType</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span>
            <span class="k">if</span> <span class="n">theType</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;&#39;&gt;&quot;</span><span class="p">):</span> <span class="n">theType</span> <span class="o">=</span> <span class="n">theType</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">theType</span>
<span class="c">#@+node:ekr.20090516135452.5776: *3* g.removeLeading/Trailing</span>
<span class="c"># Warning: g.removeTrailingWs already exists.</span>
<span class="c"># Do not change it!</span>
</div>
<div class="viewcode-block" id="removeLeading"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.removeLeading">[docs]</a><span class="k">def</span> <span class="nf">removeLeading</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">chars</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Remove all characters in chars from the front of s.&#39;&#39;&#39;</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">chars</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>
</div>
<div class="viewcode-block" id="removeTrailing"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.removeTrailing">[docs]</a><span class="k">def</span> <span class="nf">removeTrailing</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">chars</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Remove all characters in chars from the end of s.&#39;&#39;&#39;</span>

    <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">chars</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
<span class="c">#@+node:ekr.20120123115816.10209: *3* g.ShortcutInfo &amp; isShortcutInfo</span>
<span class="c"># bindKey:            ShortcutInfo(kind,commandName,func,pane)</span>
<span class="c"># bindKeyToDict:      ShortcutInfo(kind,commandName,func,pane,stroke)</span>
<span class="c"># createModeBindings: ShortcutInfo(kind,commandName,func,nextMode,stroke)</span>

<span class="c"># Important: The startup code uses this class,</span>
<span class="c"># so it is convenient to define it in leoGlobals.py.</span></div>
<div class="viewcode-block" id="ShortcutInfo"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.ShortcutInfo">[docs]</a><span class="k">class</span> <span class="nc">ShortcutInfo</span><span class="p">:</span>

    <span class="sd">&#39;&#39;&#39;A class representing any kind of key binding line.</span>

<span class="sd">    This includes other information besides just the KeyStroke.&#39;&#39;&#39;</span>

    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20120129040823.10254: *4*  ctor (ShortcutInfo)</span>
    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">kind</span><span class="p">,</span><span class="n">commandName</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">func</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">nextMode</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">pane</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">stroke</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="n">commandName</span><span class="o">==</span><span class="s">&#39;new&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">stroke</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">g</span><span class="o">.</span><span class="n">isStroke</span><span class="p">(</span><span class="n">stroke</span><span class="p">)):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;***** (ShortcutInfo) oops&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">stroke</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="n">kind</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commandName</span> <span class="o">=</span> <span class="n">commandName</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nextMode</span> <span class="o">=</span> <span class="n">nextMode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pane</span> <span class="o">=</span> <span class="n">pane</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stroke</span> <span class="o">=</span> <span class="n">stroke</span>
            <span class="c"># The *caller* must canonicalize the shortcut.</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;(ShortcutInfo)&#39;</span><span class="p">,</span><span class="n">commandName</span><span class="p">,</span><span class="n">stroke</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>
    <span class="c">#@+node:ekr.20120203153754.10031: *4* __hash__ (ShortcutInfo)</span>
    <span class="k">def</span> <span class="nf">__hash__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stroke</span><span class="o">.</span><span class="n">__hash__</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stroke</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="c">#@+node:ekr.20120125045244.10188: *4* __repr__ &amp; ___str_&amp; dump (ShortcutInfo)</span>
    <span class="k">def</span> <span class="nf">__repr__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dump</span><span class="p">()</span>

    <span class="n">__str__</span> <span class="o">=</span> <span class="n">__repr__</span>

<div class="viewcode-block" id="ShortcutInfo.dump"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.ShortcutInfo.dump">[docs]</a>    <span class="k">def</span> <span class="nf">dump</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">si</span> <span class="o">=</span> <span class="bp">self</span>    
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;ShortcutInfo </span><span class="si">%17s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">si</span><span class="o">.</span><span class="n">kind</span><span class="p">)]</span>
        <span class="c"># Print all existing ivars.</span>
        <span class="n">table</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;commandName&#39;</span><span class="p">,</span><span class="s">&#39;func&#39;</span><span class="p">,</span><span class="s">&#39;nextMode&#39;</span><span class="p">,</span><span class="s">&#39;pane&#39;</span><span class="p">,</span><span class="s">&#39;stroke&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ivar</span> <span class="ow">in</span> <span class="n">table</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">si</span><span class="p">,</span><span class="n">ivar</span><span class="p">):</span>
                <span class="n">val</span> <span class="o">=</span>  <span class="nb">getattr</span><span class="p">(</span><span class="n">si</span><span class="p">,</span><span class="n">ivar</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="s">&#39;none&#39;</span><span class="p">,</span><span class="s">&#39;None&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">ivar</span> <span class="o">==</span> <span class="s">&#39;func&#39;</span><span class="p">:</span> <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">__name__</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ivar</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&#39;[</span><span class="si">%s</span><span class="s">]&#39;</span> <span class="o">%</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20120129040823.10226: *4* isModeBinding</span></div>
<div class="viewcode-block" id="ShortcutInfo.isModeBinding"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.ShortcutInfo.isModeBinding">[docs]</a>    <span class="k">def</span> <span class="nf">isModeBinding</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;*mode&#39;</span><span class="p">)</span>
    <span class="c">#@-others</span>
</div></div>
<div class="viewcode-block" id="isShortcutInfo"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.isShortcutInfo">[docs]</a><span class="k">def</span> <span class="nf">isShortcutInfo</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">ShortcutInfo</span><span class="p">)</span>
<span class="c">#@+node:ekr.20060410112600: *3* g.stripBrackets</span></div>
<div class="viewcode-block" id="stripBrackets"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.stripBrackets">[docs]</a><span class="k">def</span> <span class="nf">stripBrackets</span> <span class="p">(</span><span class="n">s</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Same as s.lstrip(&#39;&lt;&#39;).rstrip(&#39;&gt;&#39;) except it works for Python 2.2.1.&#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;&lt;&#39;</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;&gt;&#39;</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">s</span>
<span class="c">#@+node:ekr.20111114151846.9847: *3* g.toPythonIndex</span></div>
<div class="viewcode-block" id="toPythonIndex"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.toPythonIndex">[docs]</a><span class="k">def</span> <span class="nf">toPythonIndex</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">index</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Convert index to a Python int.</span>

<span class="sd">    index may be a Tk index (x.y) or &#39;end&#39;.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="mi">99</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">index</span>
    <span class="k">elif</span> <span class="n">index</span> <span class="o">==</span> <span class="s">&#39;1.0&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">index</span> <span class="o">==</span> <span class="s">&#39;end&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">row</span><span class="p">,</span><span class="n">col</span> <span class="o">=</span> <span class="n">data</span>
            <span class="n">row</span><span class="p">,</span><span class="n">col</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">convertRowColToPythonIndex</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">row</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">col</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">i</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;bad string index: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">index</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>
</div>
<span class="n">toGuiIndex</span> <span class="o">=</span> <span class="n">toPythonIndex</span>
<span class="c">#@+node:ekr.20120912153732.10597: *3* g.wait</span>
<div class="viewcode-block" id="sleep"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.sleep">[docs]</a><span class="k">def</span> <span class="nf">sleep</span> <span class="p">(</span><span class="n">n</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Wait about n milliseconds.&#39;&#39;&#39;</span>

    <span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
    <span class="n">sleep</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="c">#sleeps for 5 seconds</span>
<span class="c">#@+node:ekr.20120129181245.10220: *3* g.TypedDict/OfLists &amp; isTypedDict/OfLists</span></div>
<div class="viewcode-block" id="TypedDict"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.TypedDict">[docs]</a><span class="k">class</span> <span class="nc">TypedDict</span><span class="p">:</span>

    <span class="sd">&#39;&#39;&#39;A class containing a name and enforcing type checking.&#39;&#39;&#39;</span>

    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20120205022040.17769: *4* td.ctor</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">keyType</span><span class="p">,</span><span class="n">valType</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span> <span class="ow">and</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&#39;g.app.config.defaultsDict&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isList</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span> <span class="c"># name is a method.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyType</span> <span class="o">=</span> <span class="n">keyType</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valType</span> <span class="o">=</span> <span class="n">valType</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="c"># g.trace(self)</span>
    <span class="c">#@+node:ekr.20120205022040.17770: *4* td.__repr__ &amp; __str__</span>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="s">&#39;&lt;TypedDict name:</span><span class="si">%s</span><span class="s"> keys:</span><span class="si">%s</span><span class="s"> values:</span><span class="si">%s</span><span class="s"> len(keys): </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">keyType</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">valType</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>

    <span class="n">__str__</span> <span class="o">=</span> <span class="n">__repr__</span>

    <span class="c">#@+node:ekr.20120206134955.10150: *4* td._checkKey/ValType</span>
    <span class="k">def</span> <span class="nf">_checkKeyType</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>

        <span class="c"># These fail on Python 2.x for strings.</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
            <span class="c"># assert key.__class__ == self.keyType,self._reportTypeError(key,self.keyType)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">key</span><span class="o">.</span><span class="n">__class__</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyType</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_reportTypeError</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">keyType</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_checkValType</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">val</span><span class="p">):</span>

        <span class="c"># This doesn&#39;t fail, either on Python 2.x or 3.x.</span>
        <span class="k">assert</span> <span class="n">val</span><span class="o">.</span><span class="n">__class__</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">valType</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_reportTypeError</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">valType</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_reportTypeError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">obj</span><span class="p">,</span><span class="n">objType</span><span class="p">):</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&#39;obj&#39;</span><span class="p">,</span><span class="n">obj</span><span class="p">,</span><span class="s">&#39;obj.__class__&#39;</span><span class="p">,</span><span class="n">obj</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span><span class="s">&#39;objType&#39;</span><span class="p">,</span><span class="n">objType</span><span class="p">)</span>

        <span class="k">return</span> <span class="s">&#39;dict: </span><span class="si">%s</span><span class="s"> expected </span><span class="si">%s</span><span class="s"> got </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span><span class="n">obj</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span><span class="n">objType</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20120205022040.17774: *4* td.add &amp; td.replace</span>
<div class="viewcode-block" id="TypedDict.add"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.TypedDict.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkKeyType</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkValType</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isList</span><span class="p">:</span>
            <span class="n">aList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,[])</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
                <span class="n">aList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">aList</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
</div>
<div class="viewcode-block" id="TypedDict.replace"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.TypedDict.replace">[docs]</a>    <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkKeyType</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isList</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_checkValType</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_checkValType</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="c"># val is not iterable.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_checkValType</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
</div>
    <span class="n">__setitem__</span> <span class="o">=</span> <span class="n">replace</span> <span class="c"># allow d[key] = val.</span>
    <span class="c">#@+node:ekr.20120223062418.10422: *4* td.copy</span>
<div class="viewcode-block" id="TypedDict.copy"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.TypedDict.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return a new dict with the same contents.&#39;&#39;&#39;</span>

        <span class="n">d</span> <span class="o">=</span> <span class="n">TypedDict</span><span class="p">(</span><span class="n">name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">keyType</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">valType</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="c">#@+node:ekr.20120206134955.10151: *4* td.dump</span></div>
<div class="viewcode-block" id="TypedDict.dump"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.TypedDict.dump">[docs]</a>    <span class="k">def</span> <span class="nf">dump</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Dump of </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isList</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">aList</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,[])</span>
                <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;  &#39;</span><span class="o">+</span><span class="nb">repr</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>

        <span class="k">return</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20120205022040.17771: *4* td getters</span></div>
<div class="viewcode-block" id="TypedDict.get"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.TypedDict.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkKeyType</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">isList</span><span class="p">:</span>
            <span class="n">default</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">default</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TypedDict.keys"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.TypedDict.keys">[docs]</a>    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="TypedDict.name"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.TypedDict.name">[docs]</a>    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>
    <span class="c">#@+node:ekr.20120214165710.10728: *4* td.setName</span></div>
<div class="viewcode-block" id="TypedDict.setName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.TypedDict.setName">[docs]</a>    <span class="k">def</span> <span class="nf">setName</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span>  <span class="n">name</span>
    <span class="c">#@+node:ekr.20120205022040.17807: *4* td.update</span></div>
<div class="viewcode-block" id="TypedDict.update"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.TypedDict.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">d</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">TypedDict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">d</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="c">#@-others</span>
</div></div>
<div class="viewcode-block" id="isTypedDict"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.isTypedDict">[docs]</a><span class="k">def</span> <span class="nf">isTypedDict</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">TypedDict</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TypedDictOfLists"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.TypedDictOfLists">[docs]</a><span class="k">class</span> <span class="nc">TypedDictOfLists</span> <span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;A class whose values are lists of typed values.&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">keyType</span><span class="p">,</span><span class="n">valType</span><span class="p">):</span>
        <span class="n">TypedDict</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">keyType</span><span class="p">,</span><span class="n">valType</span><span class="p">)</span> <span class="c"># Init the base class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isList</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&lt;TypedDictOfLists name:</span><span class="si">%s</span><span class="s"> keys:</span><span class="si">%s</span><span class="s"> values:</span><span class="si">%s</span><span class="s"> len(keys): </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">keyType</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">valType</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
    <span class="n">__str__</span> <span class="o">=</span> <span class="n">__repr__</span>

<div class="viewcode-block" id="TypedDictOfLists.copy"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.TypedDictOfLists.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">TypedDictOfLists</span><span class="p">(</span><span class="n">name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">keyType</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">valType</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">d</span>
</div></div>
<div class="viewcode-block" id="isTypedDictOfLists"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.isTypedDictOfLists">[docs]</a><span class="k">def</span> <span class="nf">isTypedDictOfLists</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">TypedDictOfLists</span><span class="p">)</span>
<span class="c">#@+node:ekr.20041219095213: *3* import wrappers</span>
<span class="c">#@+node:ekr.20040917061619: *4* g.cantImport</span></div>
<div class="viewcode-block" id="cantImport"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.cantImport">[docs]</a><span class="k">def</span> <span class="nf">cantImport</span> <span class="p">(</span><span class="n">moduleName</span><span class="p">,</span><span class="n">pluginName</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Print a &quot;Can&#39;t Import&quot; message and return None.&quot;&quot;&quot;</span>

    <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;Can not import </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">moduleName</span>
    <span class="k">if</span> <span class="n">pluginName</span><span class="p">:</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="s">&quot; from plugin </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">pluginName</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="p">:</span>
        <span class="k">print</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>
        <span class="c"># print s</span>
        <span class="k">return</span>
    <span class="c"># elif g.app.gui.guiName() == &#39;tkinter&#39; and moduleName in (&#39;Tkinter&#39;,&#39;Pmw&#39;):</span>
        <span class="c"># return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">s</span><span class="p">)</span>

<span class="c">#@+node:ekr.20041219095213.1: *4* g.importModule</span></div>
<div class="viewcode-block" id="importModule"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.importModule">[docs]</a><span class="k">def</span> <span class="nf">importModule</span> <span class="p">(</span><span class="n">moduleName</span><span class="p">,</span><span class="n">pluginName</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Try to import a module as Python&#39;s import command does.</span>

<span class="sd">    moduleName is the module&#39;s name, without file extension.&#39;&#39;&#39;</span>

    <span class="c"># Important: g is Null during startup.</span>
    <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
    <span class="n">module</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">moduleName</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">module</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">module</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">blue</span><span class="p">(</span><span class="s">&#39;loading </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">moduleName</span><span class="p">)</span>
    <span class="n">exceptions</span> <span class="o">=</span> <span class="p">[]</span> 
    <span class="k">try</span><span class="p">:</span>
        <span class="n">theFile</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># New in Leo 4.7. We no longer add Leo directories to sys.path,</span>
            <span class="c"># so search extensions and external directories here explicitly.</span>
            <span class="k">for</span> <span class="n">findPath</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="s">&#39;extensions&#39;</span><span class="p">,</span><span class="s">&#39;external&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">findPath</span><span class="p">:</span>
                    <span class="n">findPath2</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_finalize_join</span><span class="p">(</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">loadDir</span><span class="p">,</span><span class="s">&#39;..&#39;</span><span class="p">,</span><span class="n">findPath</span><span class="p">)</span>
                    <span class="n">findPath</span> <span class="o">=</span> <span class="p">[</span><span class="n">findPath2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;findPath&#39;</span><span class="p">,</span><span class="n">findPath</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">find_module</span><span class="p">(</span><span class="n">moduleName</span><span class="p">,</span><span class="n">findPath</span><span class="p">)</span> <span class="c"># This can open the file.</span>
                    <span class="n">theFile</span><span class="p">,</span><span class="n">pathname</span><span class="p">,</span><span class="n">description</span> <span class="o">=</span> <span class="n">data</span>
                    <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">theFile</span><span class="p">,</span><span class="n">moduleName</span><span class="p">,</span><span class="n">pathname</span><span class="p">)</span>
                    <span class="n">module</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">load_module</span><span class="p">(</span><span class="n">moduleName</span><span class="p">,</span><span class="n">theFile</span><span class="p">,</span><span class="n">pathname</span><span class="p">,</span><span class="n">description</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">module</span><span class="p">:</span> 
                        <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> loaded&quot;</span> <span class="o">%</span> <span class="n">moduleName</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
                    <span class="k">del</span> <span class="n">tb</span>  <span class="c"># don&#39;t need the traceback</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="c"># in case v is empty, we&#39;ll at least have the execption type</span>
                    <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">moduleName</span><span class="p">,</span><span class="n">findPath</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exceptions</span><span class="p">:</span>
                        <span class="n">exceptions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c">#unable to load module, display all exception messages</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">exceptions</span><span class="p">:</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> 
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span> <span class="c"># Importing a module can throw exceptions other than ImportError.</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
                <span class="k">del</span> <span class="n">tb</span>  <span class="c"># don&#39;t need the traceback</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="c"># in case v is empty, we&#39;ll at least have the execption type</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">theFile</span><span class="p">:</span> <span class="n">theFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">module</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">cantImport</span><span class="p">(</span><span class="n">moduleName</span><span class="p">,</span><span class="n">pluginName</span><span class="o">=</span><span class="n">pluginName</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">module</span>
<span class="c">#@+node:ekr.20041219071407: *4* g.importExtension</span></div>
<div class="viewcode-block" id="importExtension"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.importExtension">[docs]</a><span class="k">def</span> <span class="nf">importExtension</span> <span class="p">(</span><span class="n">moduleName</span><span class="p">,</span><span class="n">pluginName</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Try to import a module.  If that fails,</span>
<span class="sd">    try to import the module from Leo&#39;s extensions directory.</span>

<span class="sd">    moduleName is the module&#39;s name, without file extension.&#39;&#39;&#39;</span>

    <span class="n">module</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">importModule</span><span class="p">(</span><span class="n">moduleName</span><span class="p">,</span><span class="n">pluginName</span><span class="o">=</span><span class="n">pluginName</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">module</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;Warning: &#39;</span><span class="si">%s</span><span class="s">&#39; failed to import &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">pluginName</span><span class="p">,</span><span class="n">moduleName</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">module</span>
<span class="c">#@+node:ekr.20031218072017.2278: *4* g.importFromPath</span></div>
<div class="viewcode-block" id="importFromPath"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.importFromPath">[docs]</a><span class="k">def</span> <span class="nf">importFromPath</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="n">path</span><span class="p">,</span><span class="n">pluginName</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

    <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">shortFileName</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">moduleName</span><span class="p">,</span><span class="n">ext</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_splitext</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">os_path_normpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">isPython3</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isString</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toEncodedString</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="c"># g.trace(type(path),repr(path))</span>

    <span class="k">if</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># Bug fix 2011/10/28: Always import the path from the specified path!</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">moduleName</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">module</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;already loaded&#39;</span><span class="p">,</span><span class="n">moduleName</span><span class="p">,</span><span class="n">module</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">module</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">module</span><span class="p">,</span><span class="n">theFile</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span><span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">find_module</span><span class="p">(</span><span class="n">moduleName</span><span class="p">,[</span><span class="n">path</span><span class="p">])</span> <span class="c"># This can open the file.</span>
            <span class="n">theFile</span><span class="p">,</span><span class="n">pathname</span><span class="p">,</span><span class="n">description</span> <span class="o">=</span> <span class="n">data</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">load_module</span><span class="p">(</span><span class="n">moduleName</span><span class="p">,</span><span class="n">theFile</span><span class="p">,</span><span class="n">pathname</span><span class="p">,</span><span class="n">description</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="c"># or verbose:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;exception in g.importFromPath&quot;</span><span class="p">)</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">UiTypeException</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">batchMode</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s">&#39;Plugin </span><span class="si">%s</span><span class="s"> does not support </span><span class="si">%s</span><span class="s"> gui&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">name</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">guiName</span><span class="p">()))</span>          
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;unexpected exception in g.importFromPath(</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
    <span class="c"># Put no return statements before here!</span>
    <span class="k">finally</span><span class="p">:</span> 
        <span class="k">if</span> <span class="n">theFile</span><span class="p">:</span> <span class="n">theFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">module</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;loaded&#39;</span><span class="p">,</span><span class="n">moduleName</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">cantImport</span><span class="p">(</span><span class="n">moduleName</span><span class="p">,</span><span class="n">pluginName</span><span class="o">=</span><span class="n">pluginName</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">module</span>
<span class="c">#@+node:ekr.20040629162023: *3* readLines class and generator</span>
<span class="c">#@+node:EKR.20040612114220.3: *4* g.readLinesGenerator</span>
<span class="c"># This has been replaced by readLinesClass because</span>
<span class="c"># yield is not valid in jython.</span>

<span class="c"># def readLinesGenerator(s):</span>

    <span class="c"># for line in g.splitLines(s):</span>
        <span class="c"># # g.trace(repr(line))</span>
        <span class="c"># yield line</span>
    <span class="c"># yield &#39;&#39;</span>
<span class="c">#@+node:EKR.20040612114220.4: *4* class readLinesClass</span></div>
<div class="viewcode-block" id="readLinesClass"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.readLinesClass">[docs]</a><span class="k">class</span> <span class="nc">readLinesClass</span><span class="p">:</span>

    <span class="sd">&quot;&quot;&quot;A class whose next method provides a readline method for Python&#39;s tokenize module.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="readLinesClass.next"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.readLinesClass.next">[docs]</a>    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="c"># g.trace(repr(line))</span>
        <span class="k">return</span> <span class="n">line</span>
</div>
    <span class="n">__next__</span> <span class="o">=</span> <span class="nb">next</span>
<span class="c">#@+node:ekr.20120201164453.10090: *3* g.KeyStroke &amp; isStroke/OrNone</span></div>
<div class="viewcode-block" id="KeyStroke"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.KeyStroke">[docs]</a><span class="k">class</span> <span class="nc">KeyStroke</span><span class="p">:</span>

    <span class="sd">&#39;&#39;&#39;A class that announces that its contents has been canonicalized by k.strokeFromSetting.</span>

<span class="sd">    This allows type-checking assertions in the code.&#39;&#39;&#39;</span>

    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20120204061120.10066: *4*  ks.ctor</span>
    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span> <span class="ow">and</span> <span class="n">s</span> <span class="o">==</span> <span class="s">&#39;name&#39;</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;(KeyStroke)&#39;</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>

        <span class="k">assert</span> <span class="n">s</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">isString</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="c"># type(&#39;s&#39;) does not work in Python 3.x.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">s</span>
    <span class="c">#@+node:ekr.20120204061120.10068: *4*  Special methods</span>
    <span class="c">#@+node:ekr.20120203053243.10118: *5* ks.__hash__</span>
    <span class="c"># Allow KeyStroke objects to be keys in dictionaries.</span>

    <span class="k">def</span> <span class="nf">__hash__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">__hash__</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="c">#@+node:ekr.20120204061120.10067: *5* ks.__repr___ &amp; __str__</span>
    <span class="k">def</span> <span class="nf">__str__</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="s">&#39;&lt;KeyStroke: </span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">))</span>

    <span class="n">__repr__</span> <span class="o">=</span> <span class="n">__str__</span>
    <span class="c">#@+node:ekr.20120203053243.10117: *5* ks.rich comparisons</span>
    <span class="c">#@+at All these must be defined in order to say, for example:</span>
    <span class="c">#     for key in sorted(d)</span>
    <span class="c"># where the keys of d are KeyStroke objects.</span>
    <span class="c">#@@c</span>

    <span class="k">def</span> <span class="nf">__eq__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">other</span><span class="p">):</span> 
        <span class="k">if</span> <span class="ow">not</span> <span class="n">other</span><span class="p">:</span>               <span class="k">return</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span><span class="s">&#39;s&#39;</span><span class="p">):</span>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">s</span>
        <span class="k">else</span><span class="p">:</span>                       <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">==</span> <span class="n">other</span>

    <span class="k">def</span> <span class="nf">__lt__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">other</span><span class="p">:</span>               <span class="k">return</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span><span class="s">&#39;s&#39;</span><span class="p">):</span>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">s</span>
        <span class="k">else</span><span class="p">:</span>                       <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">&lt;</span> <span class="n">other</span>

    <span class="k">def</span> <span class="nf">__le__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">other</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__lt__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>    
    <span class="k">def</span> <span class="nf">__ne__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">other</span><span class="p">):</span> <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__gt__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">other</span><span class="p">):</span> <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__lt__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>  
    <span class="k">def</span> <span class="nf">__ge__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">other</span><span class="p">):</span> <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__lt__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20120203053243.10124: *4* ks.find, lower &amp; startswith</span>
    <span class="c"># These may go away later, but for now they make conversion of string strokes easier.</span>

<div class="viewcode-block" id="KeyStroke.find"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.KeyStroke.find">[docs]</a>    <span class="k">def</span> <span class="nf">find</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pattern</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="KeyStroke.lower"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.KeyStroke.lower">[docs]</a>    <span class="k">def</span> <span class="nf">lower</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="KeyStroke.startswith"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.KeyStroke.startswith">[docs]</a>    <span class="k">def</span> <span class="nf">startswith</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">):</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20120203053243.10121: *4* ks.isFKey</span></div>
<div class="viewcode-block" id="KeyStroke.isFKey"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.KeyStroke.isFKey">[docs]</a>    <span class="k">def</span> <span class="nf">isFKey</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;f&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20120203053243.10125: *4* ks.toGuiChar</span></div>
<div class="viewcode-block" id="KeyStroke.toGuiChar"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.KeyStroke.toGuiChar">[docs]</a>    <span class="k">def</span> <span class="nf">toGuiChar</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Replace special chars by the actual gui char.&#39;&#39;&#39;</span>

        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;return&#39;</span><span class="p">):</span>        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="k">elif</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;tab&#39;</span><span class="p">):</span>         <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span>
        <span class="k">elif</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;</span><span class="se">\b</span><span class="s">&#39;</span><span class="p">,</span><span class="s">&#39;backspace&#39;</span><span class="p">):</span>   <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\b</span><span class="s">&#39;</span>
        <span class="k">elif</span> <span class="n">s</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span><span class="s">&#39;period&#39;</span><span class="p">):</span>       <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span>
        <span class="k">return</span> <span class="n">s</span>
    <span class="c">#@-others</span>
</div></div>
<div class="viewcode-block" id="isStroke"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.isStroke">[docs]</a><span class="k">def</span> <span class="nf">isStroke</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">KeyStroke</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="isStrokeOrNone"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.isStrokeOrNone">[docs]</a><span class="k">def</span> <span class="nf">isStrokeOrNone</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">obj</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">KeyStroke</span><span class="p">)</span>
<span class="c">#@+node:ekr.20031218072017.3197: ** Whitespace...</span>
<span class="c">#@+node:ekr.20031218072017.3198: *3* g.computeLeadingWhitespace</span>
<span class="c"># Returns optimized whitespace corresponding to width with the indicated tab_width.</span>
</div>
<div class="viewcode-block" id="computeLeadingWhitespace"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.computeLeadingWhitespace">[docs]</a><span class="k">def</span> <span class="nf">computeLeadingWhitespace</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">tab_width</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">width</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tab_width</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">tabs</span>   <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="n">tab_width</span><span class="p">)</span>
        <span class="n">blanks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">%</span> <span class="n">tab_width</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span> <span class="o">*</span> <span class="n">tabs</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="s">&#39; &#39;</span> <span class="o">*</span> <span class="n">blanks</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="c"># 7/3/02: negative tab width always gets converted to blanks.</span>
        <span class="k">return</span> <span class="p">(</span><span class="s">&#39; &#39;</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span>
<span class="c">#@+node:ekr.20120605172139.10263: *3* g.computeLeadingWhitespaceWidth (new)</span>
<span class="c"># Returns optimized whitespace corresponding to width with the indicated tab_width.</span>
</div>
<div class="viewcode-block" id="computeLeadingWhitespaceWidth"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.computeLeadingWhitespaceWidth">[docs]</a><span class="k">def</span> <span class="nf">computeLeadingWhitespaceWidth</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">tab_width</span><span class="p">):</span>

    <span class="n">w</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39; &#39;</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">tab_width</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">w</span> <span class="o">%</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tab_width</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="n">w</span>
<span class="c">#@+node:ekr.20031218072017.3199: *3* g.computeWidth</span>
<span class="c"># Returns the width of s, assuming s starts a line, with indicated tab_width.</span>
</div>
<div class="viewcode-block" id="computeWidth"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.computeWidth">[docs]</a><span class="k">def</span> <span class="nf">computeWidth</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">tab_width</span><span class="p">):</span>

    <span class="n">w</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">tab_width</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">w</span> <span class="o">%</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tab_width</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">:</span> <span class="c"># Bug fix: 2012/06/05.</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">w</span>
<span class="c">#@+node:ekr.20051014175117: *3* g.adjustTripleString</span></div>
<div class="viewcode-block" id="adjustTripleString"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.adjustTripleString">[docs]</a><span class="k">def</span> <span class="nf">adjustTripleString</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">tab_width</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Remove leading indentation from a triple-quoted string.</span>

<span class="sd">    This works around the fact that Leo nodes can&#39;t represent underindented strings.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c"># Compute the minimum leading whitespace of all non-blank lines.</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">first</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">lws</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_leading_ws</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="c"># The sign of w2 does not matter.</span>
            <span class="n">w2</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">computeWidth</span><span class="p">(</span><span class="n">lws</span><span class="p">,</span><span class="n">tab_width</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">w2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">s</span>
            <span class="k">elif</span> <span class="n">first</span> <span class="ow">or</span> <span class="n">w2</span> <span class="o">&lt;</span> <span class="n">w</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">w2</span>
                <span class="n">first</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">if</span> <span class="n">w</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">s</span>

    <span class="c"># Remove the leading whitespace.</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">removeLeadingWhitespace</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">tab_width</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
<span class="c">#@+node:ekr.20050211120242.2: *3* g.removeExtraLws</span></div>
<div class="viewcode-block" id="removeExtraLws"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.removeExtraLws">[docs]</a><span class="k">def</span> <span class="nf">removeExtraLws</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">tab_width</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Remove extra indentation from one or more lines.</span>

<span class="sd">    Warning: used by getScript.  This is *not* the same as g.adjustTripleString.&#39;&#39;&#39;</span>

    <span class="n">lines</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="c"># Find the first non-blank line and compute w, the width of its leading whitespace.</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="n">lws</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">get_leading_ws</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">computeWidth</span><span class="p">(</span><span class="n">lws</span><span class="p">,</span><span class="n">tab_width</span><span class="p">)</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">s</span>

    <span class="c"># Remove the leading whitespace.</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">removeLeadingWhitespace</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">tab_width</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;lines...&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">result</span>
<span class="c">#@+node:ekr.20110727091744.15083: *3* g.wrap_lines (newer)</span>
<span class="c">#@+at</span>
<span class="c"># Important note: this routine need not deal with leading whitespace.</span>
<span class="c"># Instead, the caller should simply reduce pageWidth by the width of</span>
<span class="c"># leading whitespace wanted, then add that whitespace to the lines</span>
<span class="c"># returned here.</span>
<span class="c"># </span>
<span class="c"># The key to this code is the invarient that line never ends in whitespace.</span>
<span class="c">#@@c</span>
</div>
<div class="viewcode-block" id="wrap_lines"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.wrap_lines">[docs]</a><span class="k">def</span> <span class="nf">wrap_lines</span> <span class="p">(</span><span class="n">lines</span><span class="p">,</span><span class="n">pageWidth</span><span class="p">,</span><span class="n">firstLineWidth</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Returns a list of lines, consisting of the input lines wrapped to the given pageWidth.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">pageWidth</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">pageWidth</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="c"># First line is special</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">firstLineWidth</span><span class="p">:</span>
        <span class="n">firstLineWidth</span> <span class="o">=</span> <span class="n">pageWidth</span>
    <span class="k">if</span> <span class="n">firstLineWidth</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">firstLineWidth</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">outputLineWidth</span> <span class="o">=</span> <span class="n">firstLineWidth</span>

    <span class="c"># Sentence spacing</span>
    <span class="c"># This should be determined by some setting, and can only be either 1 or 2</span>
    <span class="n">sentenceSpacingWidth</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">assert</span><span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">sentenceSpacingWidth</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>

    <span class="c"># g.trace(lines)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># The lines of the result.</span>
    <span class="n">line</span> <span class="o">=</span> <span class="s">&quot;&quot;</span> <span class="c"># The line being formed.  It never ends in whitespace.</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">outputLineWidth</span><span class="p">)</span> <span class="c"># DTHEIN 18-JAN-2004</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>   <span class="c"># ;   ws = s[i:j]</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_non_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="p">;</span> <span class="n">word</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">k</span><span class="p">]</span>
            <span class="k">assert</span><span class="p">(</span><span class="n">k</span><span class="o">&gt;</span><span class="n">i</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">k</span>
            <span class="c"># DTHEIN 18-JAN-2004: wrap at exactly the text width, </span>
            <span class="c"># not one character less</span>
            <span class="c"># </span>
            <span class="n">wordLen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;?&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;!&#39;</span><span class="p">):</span>
                <span class="n">space</span> <span class="o">=</span> <span class="s">&#39; &#39;</span> <span class="o">*</span> <span class="n">sentenceSpacingWidth</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">space</span> <span class="o">=</span> <span class="s">&#39; &#39;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">wordLen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">wordLen</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">space</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">wordLen</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">outputLineWidth</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">wordLen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c">#@+&lt;&lt; place blank and word on the present line &gt;&gt;</span>
                    <span class="c">#@+node:ekr.20110727091744.15084: *4* &lt;&lt; place blank and word on the present line &gt;&gt;</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c"># Just add the word to the start of the line.</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">word</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c"># Add the word, preceeded by a blank.</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">space</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">line</span><span class="p">,</span><span class="n">word</span><span class="p">))</span> <span class="c"># DTHEIN 18-JAN-2004: better syntax</span>
                    <span class="c">#@-&lt;&lt; place blank and word on the present line &gt;&gt;</span>
                <span class="k">else</span><span class="p">:</span> <span class="k">pass</span> <span class="c"># discard the trailing whitespace.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c">#@+&lt;&lt; place word on a new line &gt;&gt;</span>
                <span class="c">#@+node:ekr.20110727091744.15085: *4* &lt;&lt; place word on a new line &gt;&gt;</span>
                <span class="c"># End the previous line.</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="n">outputLineWidth</span> <span class="o">=</span> <span class="n">pageWidth</span> <span class="c"># DTHEIN 3-NOV-2002: width for remaining lines</span>

                <span class="c"># Discard the whitespace and put the word on a new line.</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">word</span>

                <span class="c"># Careful: the word may be longer than pageWidth.</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">pageWidth</span><span class="p">:</span> <span class="c"># DTHEIN 18-JAN-2004: line can equal pagewidth</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="n">outputLineWidth</span> <span class="o">=</span> <span class="n">pageWidth</span> <span class="c"># DTHEIN 3-NOV-2002: width for remaining lines</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
                <span class="c">#@-&lt;&lt; place word on a new line &gt;&gt;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="c"># g.trace(result)</span>
    <span class="k">return</span> <span class="n">result</span>
<span class="c">#@+node:ekr.20031218072017.3200: *3* g.get_leading_ws</span></div>
<div class="viewcode-block" id="get_leading_ws"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.get_leading_ws">[docs]</a><span class="k">def</span> <span class="nf">get_leading_ws</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Returns the leading whitespace of &#39;s&#39;.&quot;&quot;&quot;</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i</span><span class="p">]</span>
<span class="c">#@+node:ekr.20031218072017.3201: *3* g.optimizeLeadingWhitespace</span>
<span class="c"># Optimize leading whitespace in s with the given tab_width.</span>
</div>
<div class="viewcode-block" id="optimizeLeadingWhitespace"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.optimizeLeadingWhitespace">[docs]</a><span class="k">def</span> <span class="nf">optimizeLeadingWhitespace</span> <span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="n">tab_width</span><span class="p">):</span>

    <span class="n">i</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_leading_ws_with_indent</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">tab_width</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">computeLeadingWhitespace</span><span class="p">(</span><span class="n">width</span><span class="p">,</span><span class="n">tab_width</span><span class="p">)</span> <span class="o">+</span> <span class="n">line</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">s</span>
<span class="c">#@+node:ekr.20040723093558: *3* g.regularizeTrailingNewlines</span>
<span class="c">#@+at The caller should call g.stripBlankLines before calling this routine</span>
<span class="c"># if desired.</span>
<span class="c"># </span>
<span class="c"># This routine does _not_ simply call rstrip(): that would delete all</span>
<span class="c"># trailing whitespace-only lines, and in some cases that would change</span>
<span class="c"># the meaning of program or data.</span>
<span class="c">#@@c</span>
</div>
<div class="viewcode-block" id="regularizeTrailingNewlines"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.regularizeTrailingNewlines">[docs]</a><span class="k">def</span> <span class="nf">regularizeTrailingNewlines</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">kind</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Kind is &#39;asis&#39;, &#39;zero&#39; or &#39;one&#39;.&quot;&quot;&quot;</span>

    <span class="k">pass</span>
<span class="c">#@+node:ekr.20091229090857.11698: *3* g.removeBlankLines</span></div>
<div class="viewcode-block" id="removeBlankLines"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.removeBlankLines">[docs]</a><span class="k">def</span> <span class="nf">removeBlankLines</span> <span class="p">(</span><span class="n">s</span><span class="p">):</span>

    <span class="n">lines</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">z</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">z</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
<span class="c">#@+node:ekr.20091229075924.6235: *3* g.removeLeadingBlankLines</span></div>
<div class="viewcode-block" id="removeLeadingBlankLines"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.removeLeadingBlankLines">[docs]</a><span class="k">def</span> <span class="nf">removeLeadingBlankLines</span> <span class="p">(</span><span class="n">s</span><span class="p">):</span>

    <span class="n">lines</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">;</span> <span class="n">remove</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">remove</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">remove</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="c">#@+node:ekr.20031218072017.3202: *3* g.removeLeadingWhitespace</span>
<span class="c"># Remove whitespace up to first_ws wide in s, given tab_width, the width of a tab.</span>
</div>
<div class="viewcode-block" id="removeLeadingWhitespace"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.removeLeadingWhitespace">[docs]</a><span class="k">def</span> <span class="nf">removeLeadingWhitespace</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">first_ws</span><span class="p">,</span><span class="n">tab_width</span><span class="p">):</span>

    <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">ws</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">first_ws</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">first_ws</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ws</span> <span class="o">&gt;=</span> <span class="n">first_ws</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39; &#39;</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span> <span class="p">;</span> <span class="n">ws</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span> <span class="p">;</span> <span class="n">ws</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">tab_width</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">ws</span> <span class="o">%</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tab_width</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">break</span>
    <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">s</span>
<span class="c">#@+node:ekr.20031218072017.3203: *3* g.removeTrailingWs</span>
<span class="c"># Warning: string.rstrip also removes newlines!</span>
</div>
<div class="viewcode-block" id="removeTrailingWs"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.removeTrailingWs">[docs]</a><span class="k">def</span> <span class="nf">removeTrailingWs</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>

    <span class="n">j</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">while</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39; &#39;</span> <span class="ow">or</span> <span class="n">s</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">):</span>
        <span class="n">j</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">[:</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
<span class="c">#@+node:ekr.20031218072017.3204: *3* g.skip_leading_ws</span>
<span class="c"># Skips leading up to width leading whitespace.</span>
</div>
<div class="viewcode-block" id="skip_leading_ws"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.skip_leading_ws">[docs]</a><span class="k">def</span> <span class="nf">skip_leading_ws</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">ws</span><span class="p">,</span><span class="n">tab_width</span><span class="p">):</span>

    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">ws</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39; &#39;</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">tab_width</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">count</span> <span class="o">%</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tab_width</span><span class="p">)))</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">break</span>

    <span class="k">return</span> <span class="n">i</span>
<span class="c">#@+node:ekr.20031218072017.3205: *3* g.skip_leading_ws_with_indent</span></div>
<div class="viewcode-block" id="skip_leading_ws_with_indent"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.skip_leading_ws_with_indent">[docs]</a><span class="k">def</span> <span class="nf">skip_leading_ws_with_indent</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">tab_width</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Skips leading whitespace and returns (i, indent), </span>

<span class="sd">    - i points after the whitespace</span>
<span class="sd">    - indent is the width of the whitespace, assuming tab_width wide tabs.&quot;&quot;&quot;</span>

    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39; &#39;</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">ch</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">tab_width</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">count</span> <span class="o">%</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tab_width</span><span class="p">)))</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">break</span>

    <span class="k">return</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span>
<span class="c">#@+node:ekr.20040723093558.1: *3* g.stripBlankLines</span></div>
<div class="viewcode-block" id="stripBlankLines"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.stripBlankLines">[docs]</a><span class="k">def</span> <span class="nf">stripBlankLines</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>

    <span class="n">lines</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)):</span>

        <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">skip_ws</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="c"># g.trace(&quot;%4d %s&quot; % (i,repr(lines[i])))</span>
        <span class="k">elif</span> <span class="n">line</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">:</span>
            <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
            <span class="c"># g.trace(&quot;%4d %s&quot; % (i,repr(lines[i])))</span>

    <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
<span class="c">#@+node:ekr.20060913091602: ** ZODB support</span>
<span class="c">#@+node:ekr.20060913090832.1: *3* g.init_zodb</span></div>
<span class="n">init_zodb_import_failed</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">init_zodb_failed</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># Keys are paths, values are True.</span>
<span class="n">init_zodb_db</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># Keys are paths, values are ZODB.DB instances.</span>

<div class="viewcode-block" id="init_zodb"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoGlobals.init_zodb">[docs]</a><span class="k">def</span> <span class="nf">init_zodb</span> <span class="p">(</span><span class="n">pathToZodbStorage</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;Return an ZODB.DB instance from ZODB.FileStorage.FileStorage(pathToZodbStorage)</span>
<span class="sd">    return None on any error.&#39;&#39;&#39;</span>

    <span class="k">global</span> <span class="n">init_zodb_db</span><span class="p">,</span> <span class="n">init_zodb_failed</span><span class="p">,</span> <span class="n">init_zodb_import_failed</span>

    <span class="n">db</span> <span class="o">=</span> <span class="n">init_zodb_db</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pathToZodbStorage</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">db</span><span class="p">:</span> <span class="k">return</span> <span class="n">db</span>

    <span class="k">if</span> <span class="n">init_zodb_import_failed</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>

    <span class="n">failed</span> <span class="o">=</span> <span class="n">init_zodb_failed</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pathToZodbStorage</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">failed</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">ZODB</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;g.init_zodb: can not import ZODB&#39;</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
        <span class="n">init_zodb_import_failed</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">storage</span> <span class="o">=</span> <span class="n">ZODB</span><span class="o">.</span><span class="n">FileStorage</span><span class="o">.</span><span class="n">FileStorage</span><span class="p">(</span><span class="n">pathToZodbStorage</span><span class="p">)</span>
        <span class="n">init_zodb_db</span> <span class="p">[</span><span class="n">pathToZodbStorage</span><span class="p">]</span> <span class="o">=</span> <span class="n">db</span> <span class="o">=</span> <span class="n">ZODB</span><span class="o">.</span><span class="n">DB</span><span class="p">(</span><span class="n">storage</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">db</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&#39;g.init_zodb: exception creating ZODB.DB instance&#39;</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
        <span class="n">init_zodb_failed</span> <span class="p">[</span><span class="n">pathToZodbStorage</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">None</span>
<span class="c">#@-others</span>

<span class="c"># set g when the import is about to complete.</span></div>
<span class="n">g</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;leo.core.leoGlobals&#39;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">g</span><span class="p">,</span><span class="nb">sorted</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<span class="c">#@-leo</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Leo API 4.11dev documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Ed K. Ream.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
  </body>
</html>