<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>leo.core.leoUndo &mdash; Leo API 4.11dev documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '4.11dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Leo API 4.11dev documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Leo API 4.11dev documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for leo.core.leoUndo</h1><div class="highlight"><pre>
<span class="c">#@+leo-ver=5-thin</span>
<span class="c">#@+node:ekr.20031218072017.3603: * @file leoUndo.py</span>
<span class="sd">&#39;&#39;&#39;Undo manager.&#39;&#39;&#39;</span>

<span class="c">#@@language python</span>
<span class="c">#@@tabwidth -4</span>
<span class="c">#@@pagewidth 70</span>

<span class="c">#@+&lt;&lt; How Leo implements unlimited undo &gt;&gt;</span>
<span class="c">#@+node:ekr.20031218072017.2413: ** &lt;&lt; How Leo implements unlimited undo &gt;&gt;</span>
<span class="c">#@+at Think of the actions that may be Undone or Redone as a string of beads</span>
<span class="c"># (g.Bunches) containing all information needed to undo _and_ redo an operation.</span>
<span class="c"># </span>
<span class="c"># A bead pointer points to the present bead. Undoing an operation moves the bead</span>
<span class="c"># pointer backwards; redoing an operation moves the bead pointer forwards. The</span>
<span class="c"># bead pointer points in front of the first bead when Undo is disabled. The bead</span>
<span class="c"># pointer points at the last bead when Redo is disabled.</span>
<span class="c"># </span>
<span class="c"># The Undo command uses the present bead to undo the action, then moves the bead</span>
<span class="c"># pointer backwards. The Redo command uses the bead after the present bead to redo</span>
<span class="c"># the action, then moves the bead pointer forwards. The list of beads does not</span>
<span class="c"># branch; all undoable operations (except the Undo and Redo commands themselves)</span>
<span class="c"># delete any beads following the newly created bead.</span>
<span class="c"># </span>
<span class="c"># New in Leo 4.3: User (client) code should call u.beforeX and u.afterX methods to</span>
<span class="c"># create a bead describing the operation that is being performed. (By convention,</span>
<span class="c"># the code sets u = c.undoer for undoable operations.) Most u.beforeX methods</span>
<span class="c"># return &#39;undoData&#39; that the client code merely passes to the corresponding</span>
<span class="c"># u.afterX method. This data contains the &#39;before&#39; snapshot. The u.afterX methods</span>
<span class="c"># then create a bead containing both the &#39;before&#39; and &#39;after&#39; snapshots.</span>
<span class="c"># </span>
<span class="c"># New in Leo 4.3: u.beforeChangeGroup and u.afterChangeGroup allow multiple calls</span>
<span class="c"># to u.beforeX and u.afterX methods to be treated as a single undoable entry. See</span>
<span class="c"># the code for the Change All, Sort, Promote and Demote commands for examples.</span>
<span class="c"># u.before/afterChangeGroup substantially reduce the number of u.before/afterX</span>
<span class="c"># methods needed.</span>
<span class="c"># </span>
<span class="c"># New in Leo 4.3: It would be possible for plugins or other code to define their</span>
<span class="c"># own u.before/afterX methods. Indeed, u.afterX merely needs to set the</span>
<span class="c"># bunch.undoHelper and bunch.redoHelper ivars to the methods used to undo and redo</span>
<span class="c"># the operation. See the code for the various u.before/afterX methods for</span>
<span class="c"># guidance.</span>
<span class="c"># </span>
<span class="c"># New in Leo 4.3: p.setDirty and p.setAllAncestorAtFileNodesDirty now return a</span>
<span class="c"># &#39;dirtyVnodeList&#39; that all vnodes that became dirty as the result of an</span>
<span class="c"># operation. More than one list may be generated: client code is responsible for</span>
<span class="c"># merging lists using the pattern dirtyVnodeList.extend(dirtyVnodeList2)</span>
<span class="c"># </span>
<span class="c"># I first saw this model of unlimited undo in the documentation for Apple&#39;s Yellow Box classes.</span>
<span class="c">#@-&lt;&lt; How Leo implements unlimited undo &gt;&gt;</span>

<span class="kn">import</span> <span class="nn">leo.core.leoGlobals</span> <span class="kn">as</span> <span class="nn">g</span>

<span class="c">#@+others</span>
<span class="c">#@+node:ekr.20031218072017.3605: ** class undoer</span>
<div class="viewcode-block" id="undoer"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer">[docs]</a><span class="k">class</span> <span class="nc">undoer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A class that implements unlimited undo and redo.&quot;&quot;&quot;</span>
    <span class="c">#@+others</span>
    <span class="c">#@+node:ekr.20031218072017.3606: *3* undo.__init__</span>
    <span class="k">def</span> <span class="nf">__init__</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">c</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># True: enable debugging code in new undo scheme.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug_print</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># True: enable print statements in debug code.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getString</span><span class="p">(</span><span class="s">&#39;undo_granularity&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;node&#39;</span><span class="p">,</span><span class="s">&#39;line&#39;</span><span class="p">,</span><span class="s">&#39;word&#39;</span><span class="p">,</span><span class="s">&#39;char&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">granularity</span> <span class="o">=</span> <span class="s">&#39;line&#39;</span>
        <span class="c"># g.trace(&#39;undoer&#39;,self.granularity)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">max_undo_stack_size</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">getInt</span><span class="p">(</span><span class="s">&#39;max_undo_stack_size&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">0</span>

        <span class="c"># Statistics comparing old and new ways (only if self.debug is on).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_mem</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_mem</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c"># State ivars...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beads</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># List of undo nodes.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bead</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c"># Index of the present bead: -1:len(beads)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">undoType</span> <span class="o">=</span> <span class="s">&quot;Can&#39;t Undo&quot;</span>

        <span class="c"># These must be set here, _not_ in clearUndoState.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redoMenuLabel</span> <span class="o">=</span> <span class="s">&quot;Can&#39;t Redo&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">undoMenuLabel</span> <span class="o">=</span> <span class="s">&quot;Can&#39;t Undo&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">realRedoMenuLabel</span> <span class="o">=</span> <span class="s">&quot;Can&#39;t Redo&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">realUndoMenuLabel</span> <span class="o">=</span> <span class="s">&quot;Can&#39;t Undo&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">undoing</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># True if executing an Undo command.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redoing</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># True if executing a Redo command.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">per_node_undo</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># True: v may contain undo_info ivar.</span>

        <span class="c"># New in 4.2...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optionalIvars</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># Set the following ivars to keep pylint happy.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">afterTree</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beforeTree</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deleteMarkedNodesData</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">followingSibs</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newBack</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newBody</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newChanged</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newChildren</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newHead</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newMarked</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newN</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newP</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newParent</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newParent_v</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newRecentFiles</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newSel</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newTree</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">newYScroll</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oldBack</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oldBody</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oldChanged</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oldChildren</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oldHead</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oldMarked</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oldN</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oldParent</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oldParent_v</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oldRecentFiles</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oldSel</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oldTree</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oldYScroll</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pasteAsClone</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prevSel</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sortChildren</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verboseUndoGroup</span> <span class="o">=</span> <span class="bp">None</span>

<div class="viewcode-block" id="undoer.redoHelper"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.redoHelper">[docs]</a>    <span class="k">def</span> <span class="nf">redoHelper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="undoer.undoHelper"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.undoHelper">[docs]</a>    <span class="k">def</span> <span class="nf">undoHelper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="c">#@+node:ekr.20050416092908.1: *3* Internal helpers</span>
    <span class="c">#@+node:ekr.20031218072017.3607: *4* clearOptionalIvars</span></div>
<div class="viewcode-block" id="undoer.clearOptionalIvars"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.clearOptionalIvars">[docs]</a>    <span class="k">def</span> <span class="nf">clearOptionalIvars</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">u</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># The position/node being operated upon for undo and redo.</span>

        <span class="k">for</span> <span class="n">ivar</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">optionalIvars</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">ivar</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20060127052111.1: *4* cutStack</span></div>
<div class="viewcode-block" id="undoer.cutStack"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.cutStack">[docs]</a>    <span class="k">def</span> <span class="nf">cutStack</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">n</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">max_undo_stack_size</span>

        <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">u</span><span class="o">.</span><span class="n">bead</span> <span class="o">&gt;=</span> <span class="n">n</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">unitTesting</span><span class="p">:</span>

            <span class="c"># Do nothing if we are in the middle of creating a group.</span>
            <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">beads</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">bunch</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">beads</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">bunch</span><span class="p">,</span><span class="s">&#39;kind&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">bunch</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;beforeGroup&#39;</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>

            <span class="c"># This work regardless of how many items appear after bead n.</span>
            <span class="c"># g.trace(&#39;Cutting undo stack to %d entries&#39; % (n))</span>
            <span class="n">u</span><span class="o">.</span><span class="n">beads</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">beads</span><span class="p">[</span><span class="o">-</span><span class="n">n</span><span class="p">:]</span>
            <span class="n">u</span><span class="o">.</span><span class="n">bead</span> <span class="o">=</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span>
            <span class="c"># g.trace(&#39;bead:&#39;,u.bead,&#39;len(u.beads)&#39;,len(u.beads),g.callers())</span>
    <span class="c">#@+node:ekr.20080623083646.10: *4* dumpBead</span></div>
<div class="viewcode-block" id="undoer.dumpBead"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.dumpBead">[docs]</a>    <span class="k">def</span> <span class="nf">dumpBead</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">beads</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&#39;no bead: n = &#39;</span><span class="p">,</span><span class="n">n</span>

        <span class="c"># bunch = u.beads[n]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;len(u.beads): </span><span class="si">%s</span><span class="s">, n: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">beads</span><span class="p">),</span><span class="n">n</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ivar</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;kind&#39;</span><span class="p">,</span><span class="s">&#39;newP&#39;</span><span class="p">,</span><span class="s">&#39;newN&#39;</span><span class="p">,</span><span class="s">&#39;p&#39;</span><span class="p">,</span><span class="s">&#39;oldN&#39;</span><span class="p">,</span><span class="s">&#39;undoHelper&#39;</span><span class="p">):</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ivar</span><span class="p">,</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ivar</span><span class="p">)))</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="undoer.dumpTopBead"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.dumpTopBead">[docs]</a>    <span class="k">def</span> <span class="nf">dumpTopBead</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">beads</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dumpBead</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;&lt;no top bead&gt;&#39;</span>
    <span class="c">#@+node:EKR.20040526150818: *4* getBead</span></div>
<div class="viewcode-block" id="undoer.getBead"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.getBead">[docs]</a>    <span class="k">def</span> <span class="nf">getBead</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Set undoer ivars from the bunch at the top of the undo stack.&#39;&#39;&#39;</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">beads</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="n">bunch</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">beads</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setIvarsFromBunch</span><span class="p">(</span><span class="n">bunch</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">bunch</span>
    <span class="c">#@+node:EKR.20040526150818.1: *4* peekBead</span></div>
<div class="viewcode-block" id="undoer.peekBead"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.peekBead">[docs]</a>    <span class="k">def</span> <span class="nf">peekBead</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>

        <span class="c"># g.trace(repr(n),g.callers())</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">beads</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">u</span><span class="o">.</span><span class="n">beads</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
    <span class="c">#@+node:ekr.20060127113243: *4* pushBead</span></div>
<div class="viewcode-block" id="undoer.pushBead"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.pushBead">[docs]</a>    <span class="k">def</span> <span class="nf">pushBead</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">bunch</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># New in 4.4b2:  Add this to the group if it is being accumulated.</span>
        <span class="n">bunch2</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">bead</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">u</span><span class="o">.</span><span class="n">bead</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">beads</span><span class="p">)</span> <span class="ow">and</span> <span class="n">u</span><span class="o">.</span><span class="n">beads</span><span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">bead</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">bunch2</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">bunch2</span><span class="p">,</span><span class="s">&#39;kind&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">bunch2</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;beforeGroup&#39;</span><span class="p">:</span>
            <span class="c"># Just append the new bunch the group&#39;s items.</span>
            <span class="n">bunch2</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bunch</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Push the bunch.</span>
            <span class="n">u</span><span class="o">.</span><span class="n">bead</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">u</span><span class="o">.</span><span class="n">beads</span><span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">bead</span><span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">bunch</span><span class="p">]</span>
            <span class="c"># g.trace(&#39;u.bead&#39;,u.bead,&#39;len u.beads&#39;,len(u.beads),g.callers())</span>

            <span class="c"># Recalculate the menu labels.</span>
            <span class="n">u</span><span class="o">.</span><span class="n">setUndoTypes</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20050126081529: *4* recognizeStartOfTypingWord</span></div>
<div class="viewcode-block" id="undoer.recognizeStartOfTypingWord"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.recognizeStartOfTypingWord">[docs]</a>    <span class="k">def</span> <span class="nf">recognizeStartOfTypingWord</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span>
        <span class="n">old_lines</span><span class="p">,</span><span class="n">old_row</span><span class="p">,</span><span class="n">old_col</span><span class="p">,</span><span class="n">old_ch</span><span class="p">,</span> 
        <span class="n">new_lines</span><span class="p">,</span><span class="n">new_row</span><span class="p">,</span><span class="n">new_col</span><span class="p">,</span><span class="n">new_ch</span><span class="p">,</span>
        <span class="n">prev_row</span><span class="p">,</span><span class="n">prev_col</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39; A potentially user-modifiable method that should return True if the</span>
<span class="sd">        typing indicated by the params starts a new &#39;word&#39; for the purposes of</span>
<span class="sd">        undo with &#39;word&#39; granularity.</span>

<span class="sd">        u.setUndoTypingParams calls this method only when the typing could possibly</span>
<span class="sd">        continue a previous word. In other words, undo will work safely regardless</span>
<span class="sd">        of the value returned here.</span>

<span class="sd">        old_ch is the char at the given (Tk) row, col of old_lines.</span>
<span class="sd">        new_ch is the char at the given (Tk) row, col of new_lines.</span>

<span class="sd">        The present code uses only old_ch and new_ch. The other arguments are given</span>
<span class="sd">        for use by more sophisticated algorithms.&#39;&#39;&#39;</span>

        <span class="c"># Start a word if new_ch begins whitespace + word</span>
        <span class="n">new_word_started</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">old_ch</span><span class="o">.</span><span class="n">isspace</span><span class="p">()</span> <span class="ow">and</span> <span class="n">new_ch</span><span class="o">.</span><span class="n">isspace</span><span class="p">()</span>

        <span class="c"># Start a word if the cursor has been moved since the last change</span>
        <span class="n">moved_cursor</span> <span class="o">=</span> <span class="n">new_row</span> <span class="o">!=</span> <span class="n">prev_row</span> <span class="ow">or</span> <span class="n">new_col</span> <span class="o">!=</span> <span class="n">prev_col</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">new_word_started</span> <span class="ow">or</span> <span class="n">moved_cursor</span>
    <span class="c">#@+node:ekr.20031218072017.3613: *4* redoMenuName, undoMenuName</span></div>
<div class="viewcode-block" id="undoer.redoMenuName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.redoMenuName">[docs]</a>    <span class="k">def</span> <span class="nf">redoMenuName</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">name</span><span class="o">==</span><span class="s">&quot;Can&#39;t Redo&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;Redo &quot;</span> <span class="o">+</span> <span class="n">name</span>
</div>
<div class="viewcode-block" id="undoer.undoMenuName"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.undoMenuName">[docs]</a>    <span class="k">def</span> <span class="nf">undoMenuName</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">name</span><span class="o">==</span><span class="s">&quot;Can&#39;t Undo&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;Undo &quot;</span> <span class="o">+</span> <span class="n">name</span>
    <span class="c">#@+node:ekr.20060127070008: *4* setIvarsFromBunch</span></div>
<div class="viewcode-block" id="undoer.setIvarsFromBunch"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.setIvarsFromBunch">[docs]</a>    <span class="k">def</span> <span class="nf">setIvarsFromBunch</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">bunch</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">u</span><span class="o">.</span><span class="n">clearOptionalIvars</span><span class="p">()</span>

        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># Debugging.</span>
            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">bunch</span><span class="p">):</span>
                <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">bunch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>

        <span class="c"># bunch is not a dict, so bunch.keys() is required.</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">bunch</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span> 
            <span class="n">val</span> <span class="o">=</span> <span class="n">bunch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="c"># g.trace(key,val)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">optionalIvars</span><span class="p">:</span>
                <span class="n">u</span><span class="o">.</span><span class="n">optionalIvars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.3614: *4* setRedoType</span>
    <span class="c"># These routines update both the ivar and the menu label.</span></div>
<div class="viewcode-block" id="undoer.setRedoType"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.setRedoType">[docs]</a>    <span class="k">def</span> <span class="nf">setRedoType</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">theType</span><span class="p">):</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">theType</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">theType</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;oops: expected string for command, got </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">theType</span><span class="p">))</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>
            <span class="n">theType</span> <span class="o">=</span> <span class="s">&#39;&lt;unknown&gt;&#39;</span>

        <span class="n">menu</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">getMenu</span><span class="p">(</span><span class="s">&quot;Edit&quot;</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">redoMenuName</span><span class="p">(</span><span class="n">theType</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="n">u</span><span class="o">.</span><span class="n">redoMenuLabel</span><span class="p">:</span>
            <span class="c"># Update menu using old name.</span>
            <span class="n">realLabel</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">getRealMenuName</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">realLabel</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                <span class="n">underline</span><span class="o">=</span><span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;Can&#39;t&quot;</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">underline</span> <span class="o">=</span> <span class="n">realLabel</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;&amp;&quot;</span><span class="p">)</span>
            <span class="n">realLabel</span> <span class="o">=</span> <span class="n">realLabel</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&amp;&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">setMenuLabel</span><span class="p">(</span><span class="n">menu</span><span class="p">,</span><span class="n">u</span><span class="o">.</span><span class="n">realRedoMenuLabel</span><span class="p">,</span><span class="n">realLabel</span><span class="p">,</span><span class="n">underline</span><span class="o">=</span><span class="n">underline</span><span class="p">)</span>
            <span class="n">u</span><span class="o">.</span><span class="n">redoMenuLabel</span> <span class="o">=</span> <span class="n">name</span>
            <span class="n">u</span><span class="o">.</span><span class="n">realRedoMenuLabel</span> <span class="o">=</span> <span class="n">realLabel</span>
    <span class="c">#@+node:ekr.20091221145433.6381: *4* setUndoType</span></div>
<div class="viewcode-block" id="undoer.setUndoType"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.setUndoType">[docs]</a>    <span class="k">def</span> <span class="nf">setUndoType</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">theType</span><span class="p">):</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">theType</span><span class="p">,</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">theType</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;oops: expected string for command, got </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">theType</span><span class="p">))</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">callers</span><span class="p">())</span>
            <span class="n">theType</span> <span class="o">=</span> <span class="s">&#39;&lt;unknown&gt;&#39;</span>
        <span class="n">menu</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">getMenu</span><span class="p">(</span><span class="s">&quot;Edit&quot;</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">undoMenuName</span><span class="p">(</span><span class="n">theType</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="n">u</span><span class="o">.</span><span class="n">undoMenuLabel</span><span class="p">:</span>
            <span class="c"># Update menu using old name.</span>
            <span class="n">realLabel</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">getRealMenuName</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">realLabel</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                <span class="n">underline</span><span class="o">=</span><span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;Can&#39;t&quot;</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">underline</span> <span class="o">=</span> <span class="n">realLabel</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;&amp;&quot;</span><span class="p">)</span>
            <span class="n">realLabel</span> <span class="o">=</span> <span class="n">realLabel</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&amp;&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">)</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">setMenuLabel</span><span class="p">(</span><span class="n">menu</span><span class="p">,</span><span class="n">u</span><span class="o">.</span><span class="n">realUndoMenuLabel</span><span class="p">,</span><span class="n">realLabel</span><span class="p">,</span><span class="n">underline</span><span class="o">=</span><span class="n">underline</span><span class="p">)</span>
            <span class="n">u</span><span class="o">.</span><span class="n">undoType</span> <span class="o">=</span> <span class="n">theType</span>
            <span class="n">u</span><span class="o">.</span><span class="n">undoMenuLabel</span> <span class="o">=</span> <span class="n">name</span>
            <span class="n">u</span><span class="o">.</span><span class="n">realUndoMenuLabel</span> <span class="o">=</span> <span class="n">realLabel</span>
    <span class="c">#@+node:ekr.20031218072017.3616: *4* setUndoTypes</span></div>
<div class="viewcode-block" id="undoer.setUndoTypes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.setUndoTypes">[docs]</a>    <span class="k">def</span> <span class="nf">setUndoTypes</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># Set the undo type and undo menu label.</span>
        <span class="n">bunch</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">peekBead</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">bead</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bunch</span><span class="p">:</span>
            <span class="c"># g.trace(u.bead,len(u.beads),bunch.undoType)</span>
            <span class="n">u</span><span class="o">.</span><span class="n">setUndoType</span><span class="p">(</span><span class="n">bunch</span><span class="o">.</span><span class="n">undoType</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># g.trace(u.bead,len(u.beads))</span>
            <span class="n">u</span><span class="o">.</span><span class="n">setUndoType</span><span class="p">(</span><span class="s">&quot;Can&#39;t Undo&quot;</span><span class="p">)</span>

        <span class="c"># Set only the redo menu label.</span>
        <span class="n">bunch</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">peekBead</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">bead</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bunch</span><span class="p">:</span>
            <span class="n">u</span><span class="o">.</span><span class="n">setRedoType</span><span class="p">(</span><span class="n">bunch</span><span class="o">.</span><span class="n">undoType</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">u</span><span class="o">.</span><span class="n">setRedoType</span><span class="p">(</span><span class="s">&quot;Can&#39;t Redo&quot;</span><span class="p">)</span>

        <span class="n">u</span><span class="o">.</span><span class="n">cutStack</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">bead</span><span class="p">,</span><span class="n">u</span><span class="o">.</span><span class="n">undoMenuLabel</span><span class="p">,</span><span class="n">u</span><span class="o">.</span><span class="n">redoMenuLabel</span><span class="p">)</span>
    <span class="c">#@+node:EKR.20040530121329: *4* u.restoreTree &amp; helpers</span></div>
<div class="viewcode-block" id="undoer.restoreTree"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.restoreTree">[docs]</a>    <span class="k">def</span> <span class="nf">restoreTree</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">treeInfo</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Use the tree info to restore all vnode data,</span>
<span class="sd">        including all links.&quot;&quot;&quot;</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># This effectively relinks all vnodes.</span>
        <span class="k">for</span> <span class="n">v</span><span class="p">,</span><span class="n">vInfo</span><span class="p">,</span><span class="n">tInfo</span> <span class="ow">in</span> <span class="n">treeInfo</span><span class="p">:</span>
            <span class="n">u</span><span class="o">.</span><span class="n">restoreVnodeUndoInfo</span><span class="p">(</span><span class="n">vInfo</span><span class="p">)</span>
            <span class="n">u</span><span class="o">.</span><span class="n">restoreTnodeUndoInfo</span><span class="p">(</span><span class="n">tInfo</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050415170737.2: *5* restoreVnodeUndoInfo</span></div>
<div class="viewcode-block" id="undoer.restoreVnodeUndoInfo"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.restoreVnodeUndoInfo">[docs]</a>    <span class="k">def</span> <span class="nf">restoreVnodeUndoInfo</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">bunch</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Restore all ivars saved in the bunch.&quot;&quot;&quot;</span>

        <span class="n">v</span> <span class="o">=</span> <span class="n">bunch</span><span class="o">.</span><span class="n">v</span>

        <span class="n">v</span><span class="o">.</span><span class="n">statusBits</span> <span class="o">=</span> <span class="n">bunch</span><span class="o">.</span><span class="n">statusBits</span>
        <span class="n">v</span><span class="o">.</span><span class="n">children</span>   <span class="o">=</span> <span class="n">bunch</span><span class="o">.</span><span class="n">children</span>
        <span class="n">v</span><span class="o">.</span><span class="n">parents</span>    <span class="o">=</span> <span class="n">bunch</span><span class="o">.</span><span class="n">parents</span>

        <span class="n">uA</span> <span class="o">=</span> <span class="n">bunch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;unknownAttributes&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">uA</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">v</span><span class="o">.</span><span class="n">unknownAttributes</span> <span class="o">=</span> <span class="n">uA</span>
            <span class="n">v</span><span class="o">.</span><span class="n">_p_changed</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c">#@+node:ekr.20050415170812.2: *5* restoreTnodeUndoInfo</span></div>
<div class="viewcode-block" id="undoer.restoreTnodeUndoInfo"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.restoreTnodeUndoInfo">[docs]</a>    <span class="k">def</span> <span class="nf">restoreTnodeUndoInfo</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">bunch</span><span class="p">):</span>

        <span class="n">v</span> <span class="o">=</span> <span class="n">bunch</span><span class="o">.</span><span class="n">v</span>
        <span class="n">v</span><span class="o">.</span><span class="n">h</span>  <span class="o">=</span> <span class="n">bunch</span><span class="o">.</span><span class="n">headString</span>
        <span class="n">v</span><span class="o">.</span><span class="n">b</span>  <span class="o">=</span> <span class="n">bunch</span><span class="o">.</span><span class="n">bodyString</span>
        <span class="n">v</span><span class="o">.</span><span class="n">statusBits</span>  <span class="o">=</span> <span class="n">bunch</span><span class="o">.</span><span class="n">statusBits</span>

        <span class="n">uA</span> <span class="o">=</span> <span class="n">bunch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;unknownAttributes&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">uA</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">v</span><span class="o">.</span><span class="n">unknownAttributes</span> <span class="o">=</span> <span class="n">uA</span>
            <span class="n">v</span><span class="o">.</span><span class="n">_p_changed</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c">#@+node:EKR.20040528075307: *4* u.saveTree &amp; helpers</span></div>
<div class="viewcode-block" id="undoer.saveTree"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.saveTree">[docs]</a>    <span class="k">def</span> <span class="nf">saveTree</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">treeInfo</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Return a list of tuples with all info needed to handle a general undo operation.&quot;&quot;&quot;</span>

        <span class="c"># WARNING: read this before doing anything &quot;clever&quot;</span>
        <span class="c">#@+&lt;&lt; about u.saveTree &gt;&gt;</span>
        <span class="c">#@+node:EKR.20040530114124: *5* &lt;&lt; about u.saveTree &gt;&gt;</span>
        <span class="c">#@+at The old code made a free-standing copy of the tree using v.copy and</span>
        <span class="c"># t.copy. This looks &quot;elegant&quot; and is WRONG. The problem is that it can</span>
        <span class="c"># not handle clones properly, especially when some clones were in the</span>
        <span class="c"># &quot;undo&quot; tree and some were not. Moreover, it required complex</span>
        <span class="c"># adjustments to t.vnodeLists.</span>
        <span class="c"># </span>
        <span class="c"># Instead of creating new nodes, the new code creates all information</span>
        <span class="c"># needed to properly restore the vnodes and tnodes. It creates a list of</span>
        <span class="c"># tuples, on tuple for each vnode in the tree. Each tuple has the form,</span>
        <span class="c"># </span>
        <span class="c"># (vnodeInfo, tnodeInfo)</span>
        <span class="c"># </span>
        <span class="c"># where vnodeInfo and tnodeInfo are dicts contain all info needed to</span>
        <span class="c"># recreate the nodes. The v.createUndoInfoDict and t.createUndoInfoDict</span>
        <span class="c"># methods correspond to the old v.copy and t.copy methods.</span>
        <span class="c"># </span>
        <span class="c"># Aside: Prior to 4.2 Leo used a scheme that was equivalent to the</span>
        <span class="c"># createUndoInfoDict info, but quite a bit uglier.</span>
        <span class="c">#@-&lt;&lt; about u.saveTree &gt;&gt;</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">topLevel</span> <span class="o">=</span> <span class="p">(</span><span class="n">treeInfo</span> <span class="o">==</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">topLevel</span><span class="p">:</span> <span class="n">treeInfo</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># Add info for p.v.  Duplicate tnode info is harmless.</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">,</span><span class="n">u</span><span class="o">.</span><span class="n">createVnodeUndoInfo</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">),</span><span class="n">u</span><span class="o">.</span><span class="n">createTnodeUndoInfo</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">))</span>
        <span class="n">treeInfo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c"># Recursively add info for the subtree.</span>
        <span class="n">child</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">firstChild</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">child</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">saveTree</span><span class="p">(</span><span class="n">child</span><span class="p">,</span><span class="n">treeInfo</span><span class="p">)</span>
            <span class="n">child</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>

        <span class="c"># if topLevel: g.trace(treeInfo)</span>
        <span class="k">return</span> <span class="n">treeInfo</span>
    <span class="c">#@+node:ekr.20050415170737.1: *5* createVnodeUndoInfo</span></div>
<div class="viewcode-block" id="undoer.createVnodeUndoInfo"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.createVnodeUndoInfo">[docs]</a>    <span class="k">def</span> <span class="nf">createVnodeUndoInfo</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">v</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Create a bunch containing all info needed to recreate a vnode for undo.&quot;&quot;&quot;</span>

        <span class="n">bunch</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">Bunch</span><span class="p">(</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="p">,</span>
            <span class="n">statusBits</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">statusBits</span><span class="p">,</span>
            <span class="n">parents</span>    <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">parents</span><span class="p">[:],</span>
            <span class="n">children</span>   <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">children</span><span class="p">[:],</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;unknownAttributes&#39;</span><span class="p">):</span>
            <span class="n">bunch</span><span class="o">.</span><span class="n">unknownAttributes</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">unknownAttributes</span>

        <span class="k">return</span> <span class="n">bunch</span>
    <span class="c">#@+node:ekr.20050415170812.1: *5* createTnodeUndoInfo</span></div>
<div class="viewcode-block" id="undoer.createTnodeUndoInfo"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.createTnodeUndoInfo">[docs]</a>    <span class="k">def</span> <span class="nf">createTnodeUndoInfo</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">v</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Create a bunch containing all info needed to recreate a vnode.&quot;&quot;&quot;</span>

        <span class="n">bunch</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">Bunch</span><span class="p">(</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="p">,</span>
            <span class="n">headString</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">h</span><span class="p">,</span>
            <span class="n">bodyString</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">b</span><span class="p">,</span>
            <span class="n">statusBits</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">statusBits</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;unknownAttributes&#39;</span><span class="p">):</span>
            <span class="n">bunch</span><span class="o">.</span><span class="n">unknownAttributes</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">unknownAttributes</span>

        <span class="k">return</span> <span class="n">bunch</span>
    <span class="c">#@+node:ekr.20050525151449: *4* u.trace</span></div>
<div class="viewcode-block" id="undoer.trace"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.trace">[docs]</a>    <span class="k">def</span> <span class="nf">trace</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">ivars</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;kind&#39;</span><span class="p">,</span><span class="s">&#39;undoType&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ivar</span> <span class="ow">in</span> <span class="n">ivars</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="n">ivar</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ivar</span><span class="p">))</span>
    <span class="c">#@+node:ekr.20050410095424: *4* updateMarks</span></div>
<div class="viewcode-block" id="undoer.updateMarks"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.updateMarks">[docs]</a>    <span class="k">def</span> <span class="nf">updateMarks</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">oldOrNew</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Update dirty and marked bits.&#39;&#39;&#39;</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span>

        <span class="k">if</span> <span class="n">oldOrNew</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;new&#39;</span><span class="p">,</span><span class="s">&#39;old&#39;</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&quot;can&#39;t happen&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">isOld</span> <span class="o">=</span> <span class="n">oldOrNew</span><span class="o">==</span><span class="s">&#39;old&#39;</span>
        <span class="n">marked</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">isOld</span><span class="p">,</span><span class="n">u</span><span class="o">.</span><span class="n">oldMarked</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">newMarked</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">marked</span><span class="p">:</span>  <span class="n">c</span><span class="o">.</span><span class="n">setMarked</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>       <span class="n">c</span><span class="o">.</span><span class="n">clearMarked</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>

        <span class="c"># Bug fix: Leo 4.4.6: Undo/redo always set changed/dirty bits</span>
        <span class="c"># because the file may have been saved.</span>
        <span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">setDirty</span><span class="p">(</span><span class="n">setDescendentsDirty</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">setAllAncestorAtFileNodesDirty</span><span class="p">(</span><span class="n">setDescendentsDirty</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="c"># Bug fix: Leo 4.4.6</span>
        <span class="n">u</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.3608: *3* Externally visible entries</span>
    <span class="c">#@+node:ekr.20050318085432.4: *4* afterX...</span>
    <span class="c">#@+node:ekr.20050315134017.4: *5* afterChangeGroup</span></div>
<div class="viewcode-block" id="undoer.afterChangeGroup"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.afterChangeGroup">[docs]</a>    <span class="k">def</span> <span class="nf">afterChangeGroup</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">undoType</span><span class="p">,</span><span class="n">reportFlag</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">dirtyVnodeList</span><span class="o">=</span><span class="p">[]):</span>

        <span class="sd">&#39;&#39;&#39;Create an undo node for general tree operations using d created by beforeChangeTree&#39;&#39;&#39;</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">w</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">bodyCtrl</span>
        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">redoing</span> <span class="ow">or</span> <span class="n">u</span><span class="o">.</span><span class="n">undoing</span><span class="p">:</span> <span class="k">return</span>

        <span class="c"># g.trace(&#39;u.bead&#39;,u.bead,&#39;len u.beads&#39;,len(u.beads))</span>

        <span class="n">bunch</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">beads</span><span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">bead</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">bunch</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s">&#39;beforeGroup&#39;</span><span class="p">:</span>
            <span class="n">bunch</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="s">&#39;afterGroup&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;oops: expecting beforeGroup, got </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">bunch</span><span class="o">.</span><span class="n">kind</span><span class="p">)</span>

        <span class="c"># Set the types &amp; helpers.</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="s">&#39;afterGroup&#39;</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">undoType</span> <span class="o">=</span> <span class="n">undoType</span>

        <span class="c"># Set helper only for undo:</span>
        <span class="c"># The bead pointer will point to an &#39;beforeGroup&#39; bead for redo.</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">undoHelper</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">undoGroup</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">redoHelper</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">redoGroup</span>

        <span class="n">bunch</span><span class="o">.</span><span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="n">dirtyVnodeList</span>

        <span class="n">bunch</span><span class="o">.</span><span class="n">newP</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">newSel</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getSelectionRange</span><span class="p">()</span>

        <span class="c"># Tells whether to report the number of separate changes undone/redone.</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">reportFlag</span> <span class="o">=</span> <span class="n">reportFlag</span>

        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># Push the bunch.</span>
            <span class="n">u</span><span class="o">.</span><span class="n">bead</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">u</span><span class="o">.</span><span class="n">beads</span><span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">bead</span><span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">bunch</span><span class="p">]</span>

        <span class="c"># Recalculate the menu labels.</span>
        <span class="n">u</span><span class="o">.</span><span class="n">setUndoTypes</span><span class="p">()</span>

        <span class="c"># g.trace(u.undoMenuLabel,u.redoMenuLabel)</span>
    <span class="c">#@+node:ekr.20050315134017.2: *5* afterChangeNodeContents</span></div>
<div class="viewcode-block" id="undoer.afterChangeNodeContents"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.afterChangeNodeContents">[docs]</a>    <span class="k">def</span> <span class="nf">afterChangeNodeContents</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">command</span><span class="p">,</span><span class="n">bunch</span><span class="p">,</span><span class="n">dirtyVnodeList</span><span class="o">=</span><span class="p">[]):</span>

        <span class="sd">&#39;&#39;&#39;Create an undo node using d created by beforeChangeNode.&#39;&#39;&#39;</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">w</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">bodyCtrl</span>
        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">redoing</span> <span class="ow">or</span> <span class="n">u</span><span class="o">.</span><span class="n">undoing</span><span class="p">:</span> <span class="k">return</span>

        <span class="c"># Set the type &amp; helpers.</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="s">&#39;node&#39;</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">undoType</span> <span class="o">=</span> <span class="n">command</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">undoHelper</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">undoNodeContents</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">redoHelper</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">redoNodeContents</span>

        <span class="n">bunch</span><span class="o">.</span><span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="n">dirtyVnodeList</span>

        <span class="n">bunch</span><span class="o">.</span><span class="n">newBody</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">newChanged</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">isChanged</span><span class="p">()</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">newDirty</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">isDirty</span><span class="p">()</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">newHead</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">newMarked</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">isMarked</span><span class="p">()</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">newSel</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getSelectionRange</span><span class="p">()</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">newYScroll</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getYScrollPosition</span><span class="p">()</span>

        <span class="n">u</span><span class="o">.</span><span class="n">pushBead</span><span class="p">(</span><span class="n">bunch</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050315134017.3: *5* afterChangeTree</span></div>
<div class="viewcode-block" id="undoer.afterChangeTree"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.afterChangeTree">[docs]</a>    <span class="k">def</span> <span class="nf">afterChangeTree</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">command</span><span class="p">,</span><span class="n">bunch</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Create an undo node for general tree operations using d created by beforeChangeTree&#39;&#39;&#39;</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">w</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">bodyCtrl</span>
        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">redoing</span> <span class="ow">or</span> <span class="n">u</span><span class="o">.</span><span class="n">undoing</span><span class="p">:</span> <span class="k">return</span>

        <span class="c"># Set the types &amp; helpers.</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="s">&#39;tree&#39;</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">undoType</span> <span class="o">=</span> <span class="n">command</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">undoHelper</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">undoTree</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">redoHelper</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">redoTree</span>

        <span class="c"># Set by beforeChangeTree: changed, oldSel, oldText, oldTree, p</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">newSel</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getSelectionRange</span><span class="p">()</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">newText</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getAllText</span><span class="p">()</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">newTree</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">saveTree</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="n">u</span><span class="o">.</span><span class="n">pushBead</span><span class="p">(</span><span class="n">bunch</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050424161505: *5* afterClearRecentFiles</span></div>
<div class="viewcode-block" id="undoer.afterClearRecentFiles"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.afterClearRecentFiles">[docs]</a>    <span class="k">def</span> <span class="nf">afterClearRecentFiles</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">bunch</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">bunch</span><span class="o">.</span><span class="n">newRecentFiles</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">recentFiles</span><span class="p">[:]</span>

        <span class="n">bunch</span><span class="o">.</span><span class="n">undoType</span> <span class="o">=</span> <span class="s">&#39;Clear Recent Files&#39;</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">undoHelper</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">undoClearRecentFiles</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">redoHelper</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">redoClearRecentFiles</span>

        <span class="n">u</span><span class="o">.</span><span class="n">pushBead</span><span class="p">(</span><span class="n">bunch</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">bunch</span>
    <span class="c">#@+node:ekr.20111006060936.15639: *5* afterCloneMarkedNodes</span></div>
<div class="viewcode-block" id="undoer.afterCloneMarkedNodes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.afterCloneMarkedNodes">[docs]</a>    <span class="k">def</span> <span class="nf">afterCloneMarkedNodes</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span>
        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">redoing</span> <span class="ow">or</span> <span class="n">u</span><span class="o">.</span><span class="n">undoing</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">bunch</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">createCommonBunch</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

            <span class="c"># Sets</span>
            <span class="c"># oldChanged = c.isChanged(),</span>
            <span class="c"># oldDirty = p.isDirty(),</span>
            <span class="c"># oldMarked = p.isMarked(),</span>
            <span class="c"># oldSel = w and w.getSelectionRange() or None,</span>
            <span class="c"># p = p.copy(),</span>

        <span class="c"># Set types &amp; helpers</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="s">&#39;clone-marked-nodes&#39;</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">undoType</span> <span class="o">=</span> <span class="s">&#39;clone-marked-nodes&#39;</span>

        <span class="c"># Set helpers</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">undoHelper</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">undoCloneMarkedNodes</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">redoHelper</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">redoCloneMarkedNodes</span>

        <span class="n">bunch</span><span class="o">.</span><span class="n">newP</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">newChanged</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">isChanged</span><span class="p">()</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">newDirty</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">isDirty</span><span class="p">()</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">newMarked</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">isMarked</span><span class="p">()</span>

        <span class="n">u</span><span class="o">.</span><span class="n">pushBead</span><span class="p">(</span><span class="n">bunch</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050411193627.5: *5* afterCloneNode</span></div>
<div class="viewcode-block" id="undoer.afterCloneNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.afterCloneNode">[docs]</a>    <span class="k">def</span> <span class="nf">afterCloneNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">command</span><span class="p">,</span><span class="n">bunch</span><span class="p">,</span><span class="n">dirtyVnodeList</span><span class="o">=</span><span class="p">[]):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span>
        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">redoing</span> <span class="ow">or</span> <span class="n">u</span><span class="o">.</span><span class="n">undoing</span><span class="p">:</span> <span class="k">return</span>

        <span class="c"># Set types &amp; helpers</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="s">&#39;clone&#39;</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">undoType</span> <span class="o">=</span> <span class="n">command</span>

        <span class="c"># Set helpers</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">undoHelper</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">undoCloneNode</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">redoHelper</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">redoCloneNode</span>

        <span class="n">bunch</span><span class="o">.</span><span class="n">newBack</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">back</span><span class="p">()</span> <span class="c"># 6/15/05</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">newParent</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span> <span class="c"># 6/15/05</span>

        <span class="n">bunch</span><span class="o">.</span><span class="n">newP</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="n">dirtyVnodeList</span>

        <span class="n">bunch</span><span class="o">.</span><span class="n">newChanged</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">isChanged</span><span class="p">()</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">newDirty</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">isDirty</span><span class="p">()</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">newMarked</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">isMarked</span><span class="p">()</span>

        <span class="n">u</span><span class="o">.</span><span class="n">pushBead</span><span class="p">(</span><span class="n">bunch</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050411193627.6: *5* afterDehoist</span></div>
<div class="viewcode-block" id="undoer.afterDehoist"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.afterDehoist">[docs]</a>    <span class="k">def</span> <span class="nf">afterDehoist</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">command</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">redoing</span> <span class="ow">or</span> <span class="n">u</span><span class="o">.</span><span class="n">undoing</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">bunch</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">createCommonBunch</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="c"># Set types &amp; helpers</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="s">&#39;dehoist&#39;</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">undoType</span> <span class="o">=</span> <span class="n">command</span>

        <span class="c"># Set helpers</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">undoHelper</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">undoDehoistNode</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">redoHelper</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">redoDehoistNode</span>

        <span class="n">u</span><span class="o">.</span><span class="n">pushBead</span><span class="p">(</span><span class="n">bunch</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050411193627.8: *5* afterDeleteNode</span></div>
<div class="viewcode-block" id="undoer.afterDeleteNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.afterDeleteNode">[docs]</a>    <span class="k">def</span> <span class="nf">afterDeleteNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">command</span><span class="p">,</span><span class="n">bunch</span><span class="p">,</span><span class="n">dirtyVnodeList</span><span class="o">=</span><span class="p">[]):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span>
        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">redoing</span> <span class="ow">or</span> <span class="n">u</span><span class="o">.</span><span class="n">undoing</span><span class="p">:</span> <span class="k">return</span>

        <span class="c"># Set types &amp; helpers</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="s">&#39;delete&#39;</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">undoType</span> <span class="o">=</span> <span class="n">command</span>

        <span class="c"># Set helpers</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">undoHelper</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">undoDeleteNode</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">redoHelper</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">redoDeleteNode</span>

        <span class="n">bunch</span><span class="o">.</span><span class="n">newP</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="n">dirtyVnodeList</span>

        <span class="n">bunch</span><span class="o">.</span><span class="n">newChanged</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">isChanged</span><span class="p">()</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">newDirty</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">isDirty</span><span class="p">()</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">newMarked</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">isMarked</span><span class="p">()</span>

        <span class="n">u</span><span class="o">.</span><span class="n">pushBead</span><span class="p">(</span><span class="n">bunch</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20111005152227.15555: *5* afterDeleteMarkedNodes</span></div>
<div class="viewcode-block" id="undoer.afterDeleteMarkedNodes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.afterDeleteMarkedNodes">[docs]</a>    <span class="k">def</span> <span class="nf">afterDeleteMarkedNodes</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span>
        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">redoing</span> <span class="ow">or</span> <span class="n">u</span><span class="o">.</span><span class="n">undoing</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">bunch</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">createCommonBunch</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="c"># Set types &amp; helpers</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="s">&#39;delete-marked-nodes&#39;</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">undoType</span> <span class="o">=</span> <span class="s">&#39;delete-marked-nodes&#39;</span>

        <span class="c"># Set helpers</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">undoHelper</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">undoDeleteMarkedNodes</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">redoHelper</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">redoDeleteMarkedNodes</span>

        <span class="n">bunch</span><span class="o">.</span><span class="n">newP</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">deleteMarkedNodesData</span> <span class="o">=</span> <span class="n">data</span>
        <span class="c"># bunch.dirtyVnodeList = dirtyVnodeList</span>

        <span class="n">bunch</span><span class="o">.</span><span class="n">newChanged</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">isChanged</span><span class="p">()</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">newDirty</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">isDirty</span><span class="p">()</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">newMarked</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">isMarked</span><span class="p">()</span>

        <span class="n">u</span><span class="o">.</span><span class="n">pushBead</span><span class="p">(</span><span class="n">bunch</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20080425060424.8: *5* afterDemote</span></div>
<div class="viewcode-block" id="undoer.afterDemote"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.afterDemote">[docs]</a>    <span class="k">def</span> <span class="nf">afterDemote</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">followingSibs</span><span class="p">,</span><span class="n">dirtyVnodeList</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Create an undo node for demote operations.&#39;&#39;&#39;</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">bunch</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">createCommonBunch</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="c"># Set types.</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="s">&#39;demote&#39;</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">undoType</span> <span class="o">=</span> <span class="s">&#39;Demote&#39;</span>

        <span class="n">bunch</span><span class="o">.</span><span class="n">undoHelper</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">undoDemote</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">redoHelper</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">redoDemote</span>

        <span class="n">bunch</span><span class="o">.</span><span class="n">followingSibs</span> <span class="o">=</span> <span class="n">followingSibs</span>

        <span class="c"># Push the bunch.</span>
        <span class="n">u</span><span class="o">.</span><span class="n">bead</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">u</span><span class="o">.</span><span class="n">beads</span><span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">bead</span><span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">bunch</span><span class="p">]</span>

        <span class="c"># Recalculate the menu labels.</span>
        <span class="n">u</span><span class="o">.</span><span class="n">setUndoTypes</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20050411193627.7: *5* afterHoist</span></div>
<div class="viewcode-block" id="undoer.afterHoist"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.afterHoist">[docs]</a>    <span class="k">def</span> <span class="nf">afterHoist</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">command</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">redoing</span> <span class="ow">or</span> <span class="n">u</span><span class="o">.</span><span class="n">undoing</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">bunch</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">createCommonBunch</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="c"># Set types &amp; helpers</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="s">&#39;hoist&#39;</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">undoType</span> <span class="o">=</span> <span class="n">command</span>

        <span class="c"># Set helpers</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">undoHelper</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">undoHoistNode</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">redoHelper</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">redoHoistNode</span>

        <span class="n">u</span><span class="o">.</span><span class="n">pushBead</span><span class="p">(</span><span class="n">bunch</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050411193627.9: *5* afterInsertNode</span></div>
<div class="viewcode-block" id="undoer.afterInsertNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.afterInsertNode">[docs]</a>    <span class="k">def</span> <span class="nf">afterInsertNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">command</span><span class="p">,</span><span class="n">bunch</span><span class="p">,</span><span class="n">dirtyVnodeList</span><span class="o">=</span><span class="p">[]):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span>
        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">redoing</span> <span class="ow">or</span> <span class="n">u</span><span class="o">.</span><span class="n">undoing</span><span class="p">:</span> <span class="k">return</span>

        <span class="c"># Set types &amp; helpers</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="s">&#39;insert&#39;</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">undoType</span> <span class="o">=</span> <span class="n">command</span>
        <span class="c"># g.trace(repr(command),g.callers())</span>

        <span class="c"># Set helpers</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">undoHelper</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">undoInsertNode</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">redoHelper</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">redoInsertNode</span>

        <span class="n">bunch</span><span class="o">.</span><span class="n">newP</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="n">dirtyVnodeList</span>

        <span class="n">bunch</span><span class="o">.</span><span class="n">newBack</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">back</span><span class="p">()</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">newParent</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>

        <span class="n">bunch</span><span class="o">.</span><span class="n">newChanged</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">isChanged</span><span class="p">()</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">newDirty</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">isDirty</span><span class="p">()</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">newMarked</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">isMarked</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">bunch</span><span class="o">.</span><span class="n">pasteAsClone</span><span class="p">:</span>
            <span class="n">beforeTree</span><span class="o">=</span><span class="n">bunch</span><span class="o">.</span><span class="n">beforeTree</span>
            <span class="n">afterTree</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">bunch2</span> <span class="ow">in</span> <span class="n">beforeTree</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">bunch2</span><span class="o">.</span><span class="n">v</span>
                <span class="n">afterTree</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">Bunch</span><span class="p">(</span><span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span><span class="n">head</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">h</span><span class="p">[:],</span><span class="n">body</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">b</span><span class="p">[:]))</span>
            <span class="n">bunch</span><span class="o">.</span><span class="n">afterTree</span><span class="o">=</span><span class="n">afterTree</span>
            <span class="c"># g.trace(afterTree)</span>

        <span class="n">u</span><span class="o">.</span><span class="n">pushBead</span><span class="p">(</span><span class="n">bunch</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050526124257: *5* afterMark</span></div>
<div class="viewcode-block" id="undoer.afterMark"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.afterMark">[docs]</a>    <span class="k">def</span> <span class="nf">afterMark</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">command</span><span class="p">,</span><span class="n">bunch</span><span class="p">,</span><span class="n">dirtyVnodeList</span><span class="o">=</span><span class="p">[]):</span>

        <span class="sd">&#39;&#39;&#39;Create an undo node for mark and unmark commands.&#39;&#39;&#39;</span>

        <span class="c"># &#39;command&#39; unused, but present for compatibility with similar methods.</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">redoing</span> <span class="ow">or</span> <span class="n">u</span><span class="o">.</span><span class="n">undoing</span><span class="p">:</span> <span class="k">return</span>

        <span class="c"># Set the type &amp; helpers.</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">undoHelper</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">undoMark</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">redoHelper</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">redoMark</span>

        <span class="n">bunch</span><span class="o">.</span><span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="n">dirtyVnodeList</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">newChanged</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">isChanged</span><span class="p">()</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">newDirty</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">isDirty</span><span class="p">()</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">newMarked</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">isMarked</span><span class="p">()</span>

        <span class="n">u</span><span class="o">.</span><span class="n">pushBead</span><span class="p">(</span><span class="n">bunch</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20111005152227.15562: *5* afterMoveMarkedNodes</span></div>
<div class="viewcode-block" id="undoer.afterMoveMarkedNodes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.afterMoveMarkedNodes">[docs]</a>    <span class="k">def</span> <span class="nf">afterMoveMarkedNodes</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span>
        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">redoing</span> <span class="ow">or</span> <span class="n">u</span><span class="o">.</span><span class="n">undoing</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">bunch</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">createCommonBunch</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="c"># Set types &amp; helpers</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="s">&#39;move-marked-nodes&#39;</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">undoType</span> <span class="o">=</span> <span class="s">&#39;move-marked-nodes&#39;</span>

        <span class="c"># Set helpers</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">undoHelper</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">undoMoveMarkedNodes</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">redoHelper</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">redoMoveMarkedNodes</span>

        <span class="n">bunch</span><span class="o">.</span><span class="n">newP</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">deleteMarkedNodesData</span> <span class="o">=</span> <span class="n">data</span>
        <span class="c"># bunch.dirtyVnodeList = dirtyVnodeList</span>

        <span class="n">bunch</span><span class="o">.</span><span class="n">newChanged</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">isChanged</span><span class="p">()</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">newDirty</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">isDirty</span><span class="p">()</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">newMarked</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">isMarked</span><span class="p">()</span>

        <span class="n">u</span><span class="o">.</span><span class="n">pushBead</span><span class="p">(</span><span class="n">bunch</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050410110343: *5* afterMoveNode</span></div>
<div class="viewcode-block" id="undoer.afterMoveNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.afterMoveNode">[docs]</a>    <span class="k">def</span> <span class="nf">afterMoveNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">command</span><span class="p">,</span><span class="n">bunch</span><span class="p">,</span><span class="n">dirtyVnodeList</span><span class="o">=</span><span class="p">[]):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span>
        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">redoing</span> <span class="ow">or</span> <span class="n">u</span><span class="o">.</span><span class="n">undoing</span><span class="p">:</span> <span class="k">return</span>

        <span class="c"># g.trace(p.v,p.childIndex(),g.callers())</span>

        <span class="c"># Set the types &amp; helpers.</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="s">&#39;move&#39;</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">undoType</span> <span class="o">=</span> <span class="n">command</span>

        <span class="c"># Set helper only for undo:</span>
        <span class="c"># The bead pointer will point to an &#39;beforeGroup&#39; bead for redo.</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">undoHelper</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">undoMove</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">redoHelper</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">redoMove</span>

        <span class="n">bunch</span><span class="o">.</span><span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="n">dirtyVnodeList</span>

        <span class="n">bunch</span><span class="o">.</span><span class="n">newChanged</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">isChanged</span><span class="p">()</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">newDirty</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">isDirty</span><span class="p">()</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">newMarked</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">isMarked</span><span class="p">()</span>

        <span class="n">bunch</span><span class="o">.</span><span class="n">newN</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">childIndex</span><span class="p">()</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">newParent_v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">_parentVnode</span><span class="p">()</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">newP</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">u</span><span class="o">.</span><span class="n">pushBead</span><span class="p">(</span><span class="n">bunch</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20080425060424.12: *5* afterPromote</span></div>
<div class="viewcode-block" id="undoer.afterPromote"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.afterPromote">[docs]</a>    <span class="k">def</span> <span class="nf">afterPromote</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">children</span><span class="p">,</span><span class="n">dirtyVnodeList</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Create an undo node for demote operations.&#39;&#39;&#39;</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">bunch</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">createCommonBunch</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="c"># Set types.</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="s">&#39;promote&#39;</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">undoType</span> <span class="o">=</span> <span class="s">&#39;Promote&#39;</span>

        <span class="n">bunch</span><span class="o">.</span><span class="n">undoHelper</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">undoPromote</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">redoHelper</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">redoPromote</span>

        <span class="n">bunch</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="n">children</span>

        <span class="c"># Push the bunch.</span>
        <span class="n">u</span><span class="o">.</span><span class="n">bead</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">u</span><span class="o">.</span><span class="n">beads</span><span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">bead</span><span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">bunch</span><span class="p">]</span>

        <span class="c"># Recalculate the menu labels.</span>
        <span class="n">u</span><span class="o">.</span><span class="n">setUndoTypes</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20080425060424.2: *5* afterSort</span></div>
<div class="viewcode-block" id="undoer.afterSort"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.afterSort">[docs]</a>    <span class="k">def</span> <span class="nf">afterSort</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">bunch</span><span class="p">,</span><span class="n">dirtyVnodeList</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Create an undo node for sort operations&#39;&#39;&#39;</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="c"># c = self.c</span>
        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">redoing</span> <span class="ow">or</span> <span class="n">u</span><span class="o">.</span><span class="n">undoing</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">bunch</span><span class="o">.</span><span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="n">dirtyVnodeList</span>

        <span class="c"># Recalculate the menu labels.</span>
        <span class="n">u</span><span class="o">.</span><span class="n">setUndoTypes</span><span class="p">()</span>

        <span class="c"># g.trace(u.undoMenuLabel,u.redoMenuLabel)</span>
    <span class="c">#@+node:ekr.20050318085432.3: *4* beforeX...</span>
    <span class="c">#@+node:ekr.20050315134017.7: *5* beforeChangeGroup</span></div>
<div class="viewcode-block" id="undoer.beforeChangeGroup"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.beforeChangeGroup">[docs]</a>    <span class="k">def</span> <span class="nf">beforeChangeGroup</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">command</span><span class="p">,</span><span class="n">verboseUndoGroup</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">bunch</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">createCommonBunch</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="c"># Set types.</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="s">&#39;beforeGroup&#39;</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">undoType</span> <span class="o">=</span> <span class="n">command</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">verboseUndoGroup</span> <span class="o">=</span> <span class="n">verboseUndoGroup</span>

        <span class="c"># Set helper only for redo:</span>
        <span class="c"># The bead pointer will point to an &#39;afterGroup&#39; bead for undo.</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">undoHelper</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">undoGroup</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">redoHelper</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">redoGroup</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># Push the bunch.</span>
        <span class="n">u</span><span class="o">.</span><span class="n">bead</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">u</span><span class="o">.</span><span class="n">beads</span><span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">bead</span><span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">bunch</span><span class="p">]</span>
    <span class="c">#@+node:ekr.20050315133212.2: *5* beforeChangeNodeContents</span></div>
<div class="viewcode-block" id="undoer.beforeChangeNodeContents"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.beforeChangeNodeContents">[docs]</a>    <span class="k">def</span> <span class="nf">beforeChangeNodeContents</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">oldBody</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">oldHead</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">oldYScroll</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return data that gets passed to afterChangeNode&#39;&#39;&#39;</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">bunch</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">createCommonBunch</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="c"># g.trace(&#39;oldHead&#39;,oldHead,&#39;p.h&#39;,p.h,p.v,g.callers())</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">oldBody</span> <span class="o">=</span> <span class="n">oldBody</span> <span class="ow">or</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">oldHead</span> <span class="o">=</span> <span class="n">oldHead</span> <span class="ow">or</span> <span class="n">p</span><span class="o">.</span><span class="n">h</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">oldYScroll</span> <span class="o">=</span> <span class="n">oldYScroll</span>
        <span class="k">return</span> <span class="n">bunch</span>
    <span class="c">#@+node:ekr.20050315134017.6: *5* beforeChangeTree</span></div>
<div class="viewcode-block" id="undoer.beforeChangeTree"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.beforeChangeTree">[docs]</a>    <span class="k">def</span> <span class="nf">beforeChangeTree</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="c"># g.trace(p.h)</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">w</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">bodyCtrl</span>

        <span class="n">bunch</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">createCommonBunch</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">oldSel</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getSelectionRange</span><span class="p">()</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">oldText</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getAllText</span><span class="p">()</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">oldTree</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">saveTree</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">bunch</span>
    <span class="c">#@+node:ekr.20050424161505.1: *5* beforeClearRecentFiles</span></div>
<div class="viewcode-block" id="undoer.beforeClearRecentFiles"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.beforeClearRecentFiles">[docs]</a>    <span class="k">def</span> <span class="nf">beforeClearRecentFiles</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">p</span>

        <span class="n">bunch</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">createCommonBunch</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">oldRecentFiles</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">recentFiles</span><span class="p">[:]</span>

        <span class="k">return</span> <span class="n">bunch</span>
    <span class="c">#@+node:ekr.20050412080354: *5* beforeCloneNode</span></div>
<div class="viewcode-block" id="undoer.beforeCloneNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.beforeCloneNode">[docs]</a>    <span class="k">def</span> <span class="nf">beforeCloneNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">bunch</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">createCommonBunch</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">bunch</span>
    <span class="c">#@+node:ekr.20050411193627.3: *5* beforeDeleteNode</span></div>
<div class="viewcode-block" id="undoer.beforeDeleteNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.beforeDeleteNode">[docs]</a>    <span class="k">def</span> <span class="nf">beforeDeleteNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">bunch</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">createCommonBunch</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="n">bunch</span><span class="o">.</span><span class="n">oldBack</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">back</span><span class="p">()</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">oldParent</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">bunch</span>
    <span class="c">#@+node:ekr.20050411193627.4: *5* beforeInsertNode</span></div>
<div class="viewcode-block" id="undoer.beforeInsertNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.beforeInsertNode">[docs]</a>    <span class="k">def</span> <span class="nf">beforeInsertNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">pasteAsClone</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">copiedBunchList</span><span class="o">=</span><span class="p">[]):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="n">bunch</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">createCommonBunch</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">pasteAsClone</span> <span class="o">=</span> <span class="n">pasteAsClone</span>

        <span class="k">if</span> <span class="n">pasteAsClone</span><span class="p">:</span>
            <span class="c"># Save the list of bunched.</span>
            <span class="n">bunch</span><span class="o">.</span><span class="n">beforeTree</span> <span class="o">=</span> <span class="n">copiedBunchList</span>
            <span class="c"># g.trace(bunch.beforeTree)</span>

        <span class="k">return</span> <span class="n">bunch</span>
    <span class="c">#@+node:ekr.20050526131252: *5* beforeMark</span></div>
<div class="viewcode-block" id="undoer.beforeMark"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.beforeMark">[docs]</a>    <span class="k">def</span> <span class="nf">beforeMark</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">command</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">bunch</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">createCommonBunch</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="n">bunch</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="s">&#39;mark&#39;</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">undoType</span> <span class="o">=</span> <span class="n">command</span>

        <span class="k">return</span> <span class="n">bunch</span>
    <span class="c">#@+node:ekr.20050410110215: *5* beforeMoveNode</span></div>
<div class="viewcode-block" id="undoer.beforeMoveNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.beforeMoveNode">[docs]</a>    <span class="k">def</span> <span class="nf">beforeMoveNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># g.trace(p.v,p.childIndex(),g.callers())</span>

        <span class="n">bunch</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">createCommonBunch</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="n">bunch</span><span class="o">.</span><span class="n">oldN</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">childIndex</span><span class="p">()</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">oldParent_v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">_parentVnode</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">bunch</span>
    <span class="c">#@+node:ekr.20080425060424.3: *5* beforeSort</span></div>
<div class="viewcode-block" id="undoer.beforeSort"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.beforeSort">[docs]</a>    <span class="k">def</span> <span class="nf">beforeSort</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">undoType</span><span class="p">,</span><span class="n">oldChildren</span><span class="p">,</span><span class="n">newChildren</span><span class="p">,</span><span class="n">sortChildren</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Create an undo node for sort operations.&#39;&#39;&#39;</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">bunch</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">createCommonBunch</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="c"># Set types.</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="s">&#39;sort&#39;</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">undoType</span> <span class="o">=</span> <span class="n">undoType</span>

        <span class="n">bunch</span><span class="o">.</span><span class="n">undoHelper</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">undoSort</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">redoHelper</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">redoSort</span>

        <span class="n">bunch</span><span class="o">.</span><span class="n">oldChildren</span> <span class="o">=</span> <span class="n">oldChildren</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">newChildren</span> <span class="o">=</span> <span class="n">newChildren</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">sortChildren</span> <span class="o">=</span> <span class="n">sortChildren</span> <span class="c"># A bool</span>

        <span class="c"># Push the bunch.</span>
        <span class="n">u</span><span class="o">.</span><span class="n">bead</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">u</span><span class="o">.</span><span class="n">beads</span><span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">bead</span><span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">bunch</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">bunch</span>
    <span class="c">#@+node:ekr.20050318085432.2: *5* createCommonBunch</span></div>
<div class="viewcode-block" id="undoer.createCommonBunch"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.createCommonBunch">[docs]</a>    <span class="k">def</span> <span class="nf">createCommonBunch</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Return a bunch containing all common undo info.</span>
<span class="sd">        This is mostly the info for recreating an empty node at position p.&#39;&#39;&#39;</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">w</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">bodyCtrl</span>

        <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">Bunch</span><span class="p">(</span>
            <span class="n">oldChanged</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">isChanged</span><span class="p">(),</span>
            <span class="n">oldDirty</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">isDirty</span><span class="p">(),</span>
            <span class="n">oldMarked</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">isMarked</span><span class="p">(),</span>
            <span class="n">oldSel</span> <span class="o">=</span> <span class="n">w</span> <span class="ow">and</span> <span class="n">w</span><span class="o">.</span><span class="n">getSelectionRange</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">None</span><span class="p">,</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
        <span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.3610: *4* canRedo &amp; canUndo</span>
    <span class="c"># Translation does not affect these routines.</span>
</div>
<div class="viewcode-block" id="undoer.canRedo"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.canRedo">[docs]</a>    <span class="k">def</span> <span class="nf">canRedo</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">return</span> <span class="n">u</span><span class="o">.</span><span class="n">redoMenuLabel</span> <span class="o">!=</span> <span class="s">&quot;Can&#39;t Redo&quot;</span>
</div>
<div class="viewcode-block" id="undoer.canUndo"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.canUndo">[docs]</a>    <span class="k">def</span> <span class="nf">canUndo</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">return</span> <span class="n">u</span><span class="o">.</span><span class="n">undoMenuLabel</span> <span class="o">!=</span> <span class="s">&quot;Can&#39;t Undo&quot;</span>
    <span class="c">#@+node:ekr.20031218072017.3609: *4* clearUndoState</span></div>
<div class="viewcode-block" id="undoer.clearUndoState"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.clearUndoState">[docs]</a>    <span class="k">def</span> <span class="nf">clearUndoState</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Clears then entire Undo state.</span>

<span class="sd">        All non-undoable commands should call this method.&quot;&quot;&quot;</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">u</span><span class="o">.</span><span class="n">clearOptionalIvars</span><span class="p">()</span> <span class="c"># Do this first.</span>
        <span class="n">u</span><span class="o">.</span><span class="n">setRedoType</span><span class="p">(</span><span class="s">&quot;Can&#39;t Redo&quot;</span><span class="p">)</span>
        <span class="n">u</span><span class="o">.</span><span class="n">setUndoType</span><span class="p">(</span><span class="s">&quot;Can&#39;t Undo&quot;</span><span class="p">)</span>
        <span class="n">u</span><span class="o">.</span><span class="n">beads</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># List of undo nodes.</span>
        <span class="n">u</span><span class="o">.</span><span class="n">bead</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c"># Index of the present bead: -1:len(beads)</span>

    <span class="c">#@+node:ekr.20031218072017.3611: *4* enableMenuItems</span></div>
<div class="viewcode-block" id="undoer.enableMenuItems"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.enableMenuItems">[docs]</a>    <span class="k">def</span> <span class="nf">enableMenuItems</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">frame</span>

        <span class="n">menu</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">getMenu</span><span class="p">(</span><span class="s">&quot;Edit&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">menu</span><span class="p">:</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">enableMenu</span><span class="p">(</span><span class="n">menu</span><span class="p">,</span><span class="n">u</span><span class="o">.</span><span class="n">redoMenuLabel</span><span class="p">,</span><span class="n">u</span><span class="o">.</span><span class="n">canRedo</span><span class="p">())</span>
            <span class="n">frame</span><span class="o">.</span><span class="n">menu</span><span class="o">.</span><span class="n">enableMenu</span><span class="p">(</span><span class="n">menu</span><span class="p">,</span><span class="n">u</span><span class="o">.</span><span class="n">undoMenuLabel</span><span class="p">,</span><span class="n">u</span><span class="o">.</span><span class="n">canUndo</span><span class="p">())</span>
    <span class="c">#@+node:ekr.20110519074734.6094: *4* onSelect &amp; helpers</span></div>
<div class="viewcode-block" id="undoer.onSelect"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.onSelect">[docs]</a>    <span class="k">def</span> <span class="nf">onSelect</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">old_p</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">old_p</span> <span class="ow">and</span> <span class="n">old_p</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">per_node_undo</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">old_p</span> <span class="ow">and</span> <span class="n">u</span><span class="o">.</span><span class="n">beads</span><span class="p">:</span>
                <span class="n">u</span><span class="o">.</span><span class="n">putIvarsToVnode</span><span class="p">(</span><span class="n">old_p</span><span class="p">)</span>

            <span class="n">u</span><span class="o">.</span><span class="n">setIvarsFromVnode</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">u</span><span class="o">.</span><span class="n">setUndoTypes</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20110519074734.6096: *5* putIvarsToVnode (new)</span></div>
<div class="viewcode-block" id="undoer.putIvarsToVnode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.putIvarsToVnode">[docs]</a>    <span class="k">def</span> <span class="nf">putIvarsToVnode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">per_node_undo</span>

        <span class="n">bunch</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">bunch</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">optionalIvars</span><span class="p">:</span>
            <span class="n">bunch</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">key</span><span class="p">)</span>

        <span class="c"># Put these ivars by hand.</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;bead&#39;</span><span class="p">,</span><span class="s">&#39;beads&#39;</span><span class="p">,</span><span class="s">&#39;undoType&#39;</span><span class="p">,):</span>
            <span class="n">bunch</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">key</span><span class="p">)</span>

        <span class="n">v</span><span class="o">.</span><span class="n">undo_info</span> <span class="o">=</span> <span class="n">bunch</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;****&#39;</span><span class="p">,</span><span class="n">v</span><span class="o">.</span><span class="n">h</span><span class="p">,</span><span class="nb">getattr</span><span class="p">(</span><span class="n">bunch</span><span class="p">,</span><span class="s">&#39;bead&#39;</span><span class="p">))</span>
            <span class="c"># Use getattr to keep pylint happy.</span>
    <span class="c">#@+node:ekr.20110519074734.6095: *5* setIvarsFromVnode (new)</span></div>
<div class="viewcode-block" id="undoer.setIvarsFromVnode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.setIvarsFromVnode">[docs]</a>    <span class="k">def</span> <span class="nf">setIvarsFromVnode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">v</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">per_node_undo</span>

        <span class="n">u</span><span class="o">.</span><span class="n">clearUndoState</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;undo_info&#39;</span><span class="p">):</span>
            <span class="n">u</span><span class="o">.</span><span class="n">setIvarsFromBunch</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">undo_info</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.1490: *4* setUndoTypingParams</span></div>
<div class="viewcode-block" id="undoer.setUndoTypingParams"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.setUndoTypingParams">[docs]</a>    <span class="k">def</span> <span class="nf">setUndoTypingParams</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">undo_type</span><span class="p">,</span><span class="n">oldText</span><span class="p">,</span><span class="n">newText</span><span class="p">,</span><span class="n">oldSel</span><span class="p">,</span><span class="n">newSel</span><span class="p">,</span><span class="n">oldYview</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Save enough information so a typing operation can be undone and redone.</span>

<span class="sd">        Do nothing when called from the undo/redo logic because the Undo and Redo commands merely reset the bead pointer.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span>
        <span class="c">#@+&lt;&lt; return if there is nothing to do &gt;&gt;</span>
        <span class="c">#@+node:ekr.20040324061854: *5* &lt;&lt; return if there is nothing to do &gt;&gt;</span>
        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">redoing</span> <span class="ow">or</span> <span class="n">u</span><span class="o">.</span><span class="n">undoing</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">undo_type</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">undo_type</span> <span class="o">==</span> <span class="s">&quot;Can&#39;t Undo&quot;</span><span class="p">:</span>
            <span class="n">u</span><span class="o">.</span><span class="n">clearUndoState</span><span class="p">()</span>
            <span class="n">u</span><span class="o">.</span><span class="n">setUndoTypes</span><span class="p">()</span> <span class="c"># Must still recalculate the menu labels.</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">oldText</span> <span class="o">==</span> <span class="n">newText</span><span class="p">:</span>
            <span class="c"># g.trace(&quot;no change&quot;)</span>
            <span class="n">u</span><span class="o">.</span><span class="n">setUndoTypes</span><span class="p">()</span> <span class="c"># Must still recalculate the menu labels.</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="c">#@-&lt;&lt; return if there is nothing to do &gt;&gt;</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">undo_type</span><span class="p">,</span><span class="n">oldSel</span><span class="p">,</span><span class="n">newSel</span><span class="p">)</span>
        <span class="c">#@+&lt;&lt; init the undo params &gt;&gt;</span>
        <span class="c">#@+node:ekr.20040324061854.1: *5* &lt;&lt; init the undo params &gt;&gt;</span>
        <span class="c"># Clear all optional params.</span>
        <span class="c"># for ivar in u.optionalIvars:</span>
            <span class="c"># setattr(u,ivar,None)</span>
        <span class="n">u</span><span class="o">.</span><span class="n">clearOptionalIvars</span><span class="p">()</span>

        <span class="c"># Set the params.</span>
        <span class="n">u</span><span class="o">.</span><span class="n">undoType</span> <span class="o">=</span> <span class="n">undo_type</span>
        <span class="n">u</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c">#@-&lt;&lt; init the undo params &gt;&gt;</span>
        <span class="c">#@+&lt;&lt; compute leading, middle &amp; trailing  lines &gt;&gt;</span>
        <span class="c">#@+node:ekr.20031218072017.1491: *5* &lt;&lt; compute leading, middle &amp; trailing  lines &gt;&gt;</span>
        <span class="c">#@+at Incremental undo typing is similar to incremental syntax coloring. We compute</span>
        <span class="c"># the number of leading and trailing lines that match, and save both the old and</span>
        <span class="c"># new middle lines. NB: the number of old and new middle lines may be different.</span>
        <span class="c">#@@c</span>

        <span class="n">old_lines</span> <span class="o">=</span> <span class="n">oldText</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">new_lines</span> <span class="o">=</span> <span class="n">newText</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">new_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_lines</span><span class="p">)</span>
        <span class="n">old_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_lines</span><span class="p">)</span>
        <span class="n">min_len</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">old_len</span><span class="p">,</span><span class="n">new_len</span><span class="p">)</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">min_len</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">old_lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">new_lines</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">break</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">leading</span> <span class="o">=</span> <span class="n">i</span>

        <span class="k">if</span> <span class="n">leading</span> <span class="o">==</span> <span class="n">new_len</span><span class="p">:</span>
            <span class="c"># This happens when we remove lines from the end.</span>
            <span class="c"># The new text is simply the leading lines from the old text.</span>
            <span class="n">trailing</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">min_len</span> <span class="o">-</span> <span class="n">leading</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">old_lines</span><span class="p">[</span><span class="n">old_len</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">new_lines</span><span class="p">[</span><span class="n">new_len</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">break</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">trailing</span> <span class="o">=</span> <span class="n">i</span>

        <span class="c"># NB: the number of old and new middle lines may be different.</span>
        <span class="k">if</span> <span class="n">trailing</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">old_middle_lines</span> <span class="o">=</span> <span class="n">old_lines</span><span class="p">[</span><span class="n">leading</span><span class="p">:]</span>
            <span class="n">new_middle_lines</span> <span class="o">=</span> <span class="n">new_lines</span><span class="p">[</span><span class="n">leading</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">old_middle_lines</span> <span class="o">=</span> <span class="n">old_lines</span><span class="p">[</span><span class="n">leading</span><span class="p">:</span><span class="o">-</span><span class="n">trailing</span><span class="p">]</span>
            <span class="n">new_middle_lines</span> <span class="o">=</span> <span class="n">new_lines</span><span class="p">[</span><span class="n">leading</span><span class="p">:</span><span class="o">-</span><span class="n">trailing</span><span class="p">]</span>

        <span class="c"># Remember how many trailing newlines in the old and new text.</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">oldText</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">;</span> <span class="n">old_newlines</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">oldText</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">:</span>
            <span class="n">old_newlines</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">newText</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">;</span> <span class="n">new_newlines</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">newText</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">:</span>
            <span class="n">new_newlines</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">trace</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;lead,trail&quot;</span><span class="p">,</span><span class="n">leading</span><span class="p">,</span><span class="n">trailing</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;old mid,nls:&quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">old_middle_lines</span><span class="p">),</span><span class="n">old_newlines</span><span class="p">,</span><span class="n">oldText</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;new mid,nls:&quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">new_middle_lines</span><span class="p">),</span><span class="n">new_newlines</span><span class="p">,</span><span class="n">newText</span><span class="p">)</span>
            <span class="c">#g.pr(&quot;lead,trail:&quot;,leading,trailing)</span>
            <span class="c">#g.pr(&quot;old mid:&quot;,old_middle_lines)</span>
            <span class="c">#g.pr(&quot;new mid:&quot;,new_middle_lines)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;---------------------&quot;</span><span class="p">)</span>
        <span class="c">#@-&lt;&lt; compute leading, middle &amp; trailing  lines &gt;&gt;</span>
        <span class="c">#@+&lt;&lt; save undo text info &gt;&gt;</span>
        <span class="c">#@+node:ekr.20031218072017.1492: *5* &lt;&lt; save undo text info &gt;&gt;</span>
        <span class="c">#@+at This is the start of the incremental undo algorithm.</span>
        <span class="c"># </span>
        <span class="c"># We must save enough info to do _both_ of the following:</span>
        <span class="c"># </span>
        <span class="c"># Undo: Given newText, recreate oldText.</span>
        <span class="c"># Redo: Given oldText, recreate oldText.</span>
        <span class="c"># </span>
        <span class="c"># The &quot;given&quot; texts for the undo and redo routines are simply p.b.</span>
        <span class="c">#@@c</span>

        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="c"># Remember the complete text for comparisons...</span>
            <span class="n">u</span><span class="o">.</span><span class="n">oldText</span> <span class="o">=</span> <span class="n">oldText</span>
            <span class="n">u</span><span class="o">.</span><span class="n">newText</span> <span class="o">=</span> <span class="n">newText</span>
            <span class="c"># Compute statistics comparing old and new ways...</span>
            <span class="c"># The old doesn&#39;t often store the old text, so don&#39;t count it here.</span>
            <span class="n">u</span><span class="o">.</span><span class="n">old_mem</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">newText</span><span class="p">)</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">old_middle_lines</span><span class="p">)</span>
            <span class="n">s2</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_middle_lines</span><span class="p">)</span>
            <span class="n">u</span><span class="o">.</span><span class="n">new_mem</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">u</span><span class="o">.</span><span class="n">oldText</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">u</span><span class="o">.</span><span class="n">newText</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">u</span><span class="o">.</span><span class="n">leading</span> <span class="o">=</span> <span class="n">leading</span>
        <span class="n">u</span><span class="o">.</span><span class="n">trailing</span> <span class="o">=</span> <span class="n">trailing</span>
        <span class="n">u</span><span class="o">.</span><span class="n">oldMiddleLines</span> <span class="o">=</span> <span class="n">old_middle_lines</span>
        <span class="n">u</span><span class="o">.</span><span class="n">newMiddleLines</span> <span class="o">=</span> <span class="n">new_middle_lines</span>
        <span class="n">u</span><span class="o">.</span><span class="n">oldNewlines</span> <span class="o">=</span> <span class="n">old_newlines</span>
        <span class="n">u</span><span class="o">.</span><span class="n">newNewlines</span> <span class="o">=</span> <span class="n">new_newlines</span>
        <span class="c">#@-&lt;&lt; save undo text info &gt;&gt;</span>
        <span class="c">#@+&lt;&lt; save the selection and scrolling position &gt;&gt;</span>
        <span class="c">#@+node:ekr.20040324061854.2: *5* &lt;&lt; save the selection and scrolling position &gt;&gt;</span>
        <span class="c"># Remember the selection.</span>
        <span class="n">u</span><span class="o">.</span><span class="n">oldSel</span> <span class="o">=</span> <span class="n">oldSel</span>
        <span class="n">u</span><span class="o">.</span><span class="n">newSel</span> <span class="o">=</span> <span class="n">newSel</span>

        <span class="c"># Remember the scrolling position.</span>
        <span class="k">if</span> <span class="n">oldYview</span><span class="p">:</span>
            <span class="n">u</span><span class="o">.</span><span class="n">yview</span> <span class="o">=</span> <span class="n">oldYview</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">u</span><span class="o">.</span><span class="n">yview</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">getYScrollPosition</span><span class="p">()</span>
        <span class="c">#@-&lt;&lt; save the selection and scrolling position &gt;&gt;</span>
        <span class="c">#@+&lt;&lt; adjust the undo stack, clearing all forward entries &gt;&gt;</span>
        <span class="c">#@+node:ekr.20040324061854.3: *5* &lt;&lt; adjust the undo stack, clearing all forward entries &gt;&gt;</span>
        <span class="c">#@+at New in Leo 4.3. Instead of creating a new bead on every character, we</span>
        <span class="c"># may adjust the top bead:</span>
        <span class="c"># </span>
        <span class="c"># word granularity: adjust the top bead if the typing would continue the word.</span>
        <span class="c"># line granularity: adjust the top bead if the typing is on the same line.</span>
        <span class="c"># node granularity: adjust the top bead if the typing is anywhere on the same node.</span>
        <span class="c">#@@c</span>

        <span class="n">granularity</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">granularity</span>

        <span class="n">old_d</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">peekBead</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">bead</span><span class="p">)</span>
        <span class="n">old_p</span> <span class="o">=</span> <span class="n">old_d</span> <span class="ow">and</span> <span class="n">old_d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;p&#39;</span><span class="p">)</span>

        <span class="c">#@+&lt;&lt; set newBead if we can&#39;t share the previous bead &gt;&gt;</span>
        <span class="c">#@+node:ekr.20050125220613: *6* &lt;&lt; set newBead if we can&#39;t share the previous bead &gt;&gt;</span>
        <span class="c">#@+at We must set newBead to True if undo_type is not &#39;Typing&#39; so that commands that</span>
        <span class="c"># get treated like typing (by updateBodyPane and onBodyChanged) don&#39;t get lumped</span>
        <span class="c"># with &#39;real&#39; typing.</span>
        <span class="c">#@@c</span>
        <span class="c"># g.trace(granularity)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">old_d</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">old_p</span> <span class="ow">or</span>
            <span class="n">old_p</span><span class="o">.</span><span class="n">v</span> <span class="o">!=</span> <span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="ow">or</span>
            <span class="n">old_d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;kind&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#39;typing&#39;</span> <span class="ow">or</span>
            <span class="n">old_d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;undoType&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#39;Typing&#39;</span> <span class="ow">or</span>
            <span class="n">undo_type</span> <span class="o">!=</span> <span class="s">&#39;Typing&#39;</span>
        <span class="p">):</span>
            <span class="n">newBead</span> <span class="o">=</span> <span class="bp">True</span> <span class="c"># We can&#39;t share the previous node.</span>
        <span class="k">elif</span> <span class="n">granularity</span> <span class="o">==</span> <span class="s">&#39;char&#39;</span><span class="p">:</span>
            <span class="n">newBead</span> <span class="o">=</span> <span class="bp">True</span> <span class="c"># This was the old way.</span>
        <span class="k">elif</span> <span class="n">granularity</span> <span class="o">==</span> <span class="s">&#39;node&#39;</span><span class="p">:</span>
            <span class="n">newBead</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># Always replace previous bead.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">granularity</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;line&#39;</span><span class="p">,</span><span class="s">&#39;word&#39;</span><span class="p">)</span>
            <span class="c"># Replace the previous bead if only the middle lines have changed.</span>
            <span class="n">newBead</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">old_d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;leading&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>  <span class="o">!=</span> <span class="n">u</span><span class="o">.</span><span class="n">leading</span> <span class="ow">or</span> 
                <span class="n">old_d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;trailing&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">u</span><span class="o">.</span><span class="n">trailing</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">granularity</span> <span class="o">==</span> <span class="s">&#39;word&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">newBead</span><span class="p">:</span>
                <span class="c"># Protect the method that may be changed by the user</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c">#@+&lt;&lt; set newBead if the change does not continue a word &gt;&gt;</span>
                    <span class="c">#@+node:ekr.20050125203937: *7* &lt;&lt; set newBead if the change does not continue a word &gt;&gt;</span>
                    <span class="n">old_start</span><span class="p">,</span><span class="n">old_end</span> <span class="o">=</span> <span class="n">oldSel</span>
                    <span class="n">new_start</span><span class="p">,</span><span class="n">new_end</span> <span class="o">=</span> <span class="n">newSel</span>
                    <span class="n">prev_start</span><span class="p">,</span><span class="n">prev_end</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">prevSel</span>
                    <span class="c"># g.trace(&#39;new_start&#39;,new_start,&#39;old_start&#39;,old_start)</span>
                    <span class="k">if</span> <span class="n">old_start</span> <span class="o">!=</span> <span class="n">old_end</span> <span class="ow">or</span> <span class="n">new_start</span> <span class="o">!=</span> <span class="n">new_end</span><span class="p">:</span>
                        <span class="c"># The new and old characters are not contiguous.</span>
                        <span class="n">newBead</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c"># 2011/04/01: Patch by Sam Hartsfield</span>
                        <span class="n">old_row</span><span class="p">,</span><span class="n">old_col</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">convertPythonIndexToRowCol</span><span class="p">(</span><span class="n">oldText</span><span class="p">,</span><span class="n">old_start</span><span class="p">)</span>
                        <span class="n">new_row</span><span class="p">,</span><span class="n">new_col</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">convertPythonIndexToRowCol</span><span class="p">(</span><span class="n">newText</span><span class="p">,</span><span class="n">new_start</span><span class="p">)</span>
                        <span class="n">prev_row</span><span class="p">,</span><span class="n">prev_col</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">convertPythonIndexToRowCol</span><span class="p">(</span><span class="n">oldText</span><span class="p">,</span><span class="n">prev_start</span><span class="p">)</span>
                        <span class="n">old_lines</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">oldText</span><span class="p">)</span>
                        <span class="n">new_lines</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">splitLines</span><span class="p">(</span><span class="n">newText</span><span class="p">)</span>
                        <span class="c"># g.trace(&#39;old&#39;,old_row,old_col,len(old_lines))</span>
                        <span class="c"># g.trace(&#39;new&#39;,new_row,new_col,len(new_lines))</span>
                        <span class="c"># Recognize backspace, del, etc. as contiguous.</span>
                        <span class="k">if</span> <span class="n">old_row</span> <span class="o">!=</span> <span class="n">new_row</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">old_col</span><span class="o">-</span> <span class="n">new_col</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="c"># The new and old characters are not contiguous.</span>
                            <span class="n">newBead</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="k">elif</span> <span class="n">old_col</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">new_col</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="c"># pylint: disable=W0511</span>
                            <span class="c"># W0511:1362: TODO</span>
                            <span class="c"># TODO this is not true, we might as well just have entered a char at the beginning of an existing line</span>
                            <span class="k">pass</span> <span class="c"># We have just inserted a line.</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c"># 2011/04/01: Patch by Sam Hartsfield</span>
                            <span class="n">old_s</span> <span class="o">=</span> <span class="n">old_lines</span><span class="p">[</span><span class="n">old_row</span><span class="p">]</span>
                            <span class="n">new_s</span> <span class="o">=</span> <span class="n">new_lines</span><span class="p">[</span><span class="n">new_row</span><span class="p">]</span>
                            <span class="c"># New in 4.3b2:</span>
                            <span class="c"># Guard against invalid oldSel or newSel params.</span>
                            <span class="k">if</span> <span class="n">old_col</span><span class="o">-</span><span class="mi">1</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_s</span><span class="p">)</span> <span class="ow">or</span> <span class="n">new_col</span><span class="o">-</span><span class="mi">1</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_s</span><span class="p">):</span>
                                <span class="n">newBead</span> <span class="o">=</span> <span class="bp">True</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c"># g.trace(new_col,len(new_s),repr(new_s))</span>
                                <span class="n">old_ch</span> <span class="o">=</span> <span class="n">old_s</span><span class="p">[</span><span class="n">old_col</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                <span class="n">new_ch</span> <span class="o">=</span> <span class="n">new_s</span><span class="p">[</span><span class="n">new_col</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                <span class="c"># g.trace(repr(old_ch),repr(new_ch))</span>
                                <span class="n">newBead</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recognizeStartOfTypingWord</span><span class="p">(</span>
                                    <span class="n">old_lines</span><span class="p">,</span><span class="n">old_row</span><span class="p">,</span><span class="n">old_col</span><span class="p">,</span><span class="n">old_ch</span><span class="p">,</span>
                                    <span class="n">new_lines</span><span class="p">,</span><span class="n">new_row</span><span class="p">,</span><span class="n">new_col</span><span class="p">,</span><span class="n">new_ch</span><span class="p">,</span>
                                    <span class="n">prev_row</span><span class="p">,</span><span class="n">prev_col</span><span class="p">)</span>
                    <span class="c">#@-&lt;&lt; set newBead if the change does not continue a word &gt;&gt;</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">if</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;old_lines&#39;</span><span class="p">,</span><span class="n">old_lines</span><span class="p">)</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;new_lines&#39;</span><span class="p">,</span><span class="n">new_lines</span><span class="p">)</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Unexpected exception...&#39;</span><span class="p">)</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">es_exception</span><span class="p">()</span>
                    <span class="n">newBead</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c">#@-&lt;&lt; set newBead if we can&#39;t share the previous bead &gt;&gt;</span>

        <span class="c"># Save end selection as new &quot;previous&quot; selection</span>
        <span class="n">u</span><span class="o">.</span><span class="n">prevSel</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">newSel</span>

        <span class="k">if</span> <span class="n">newBead</span><span class="p">:</span>
            <span class="c"># Push params on undo stack, clearing all forward entries.</span>
            <span class="n">bunch</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">Bunch</span><span class="p">(</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                <span class="n">kind</span><span class="o">=</span><span class="s">&#39;typing&#39;</span><span class="p">,</span>
                <span class="n">undoType</span> <span class="o">=</span> <span class="n">undo_type</span><span class="p">,</span>
                <span class="n">undoHelper</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">undoTyping</span><span class="p">,</span>
                <span class="n">redoHelper</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">redoTyping</span><span class="p">,</span>
                <span class="n">oldText</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">oldText</span><span class="p">,</span>
                <span class="n">oldSel</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">oldSel</span><span class="p">,</span>
                <span class="n">oldNewlines</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">oldNewlines</span><span class="p">,</span>
                <span class="n">oldMiddleLines</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">oldMiddleLines</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">u</span><span class="o">.</span><span class="n">pushBead</span><span class="p">(</span><span class="n">bunch</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bunch</span> <span class="o">=</span> <span class="n">old_d</span>

        <span class="n">bunch</span><span class="o">.</span><span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">setAllAncestorAtFileNodesDirty</span><span class="p">()</span>

        <span class="c"># Bug fix: Leo 4.4.6: always add p to the list.</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">dirtyVnodeList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">leading</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">leading</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">trailing</span><span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">trailing</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">newNewlines</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">newNewlines</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">newMiddleLines</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">newMiddleLines</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">newSel</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">newSel</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">newText</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">newText</span>
        <span class="n">bunch</span><span class="o">.</span><span class="n">yview</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">yview</span>
        <span class="c">#@-&lt;&lt; adjust the undo stack, clearing all forward entries &gt;&gt;</span>

        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">per_node_undo</span><span class="p">:</span>
            <span class="n">u</span><span class="o">.</span><span class="n">putIvarsToVnode</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">bunch</span> <span class="c"># Never used.</span>
    <span class="c">#@+node:ekr.20031218072017.2030: *3* redo</span></div>
<div class="viewcode-block" id="undoer.redo"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.redo">[docs]</a>    <span class="k">def</span> <span class="nf">redo</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Redo the operation undone by the last undo.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">bodyCtrl</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;no current position&#39;</span><span class="p">)</span>
            <span class="k">return</span>
            
        <span class="c"># Bug fix: 2013/4/26: End editing *before* getting state.</span>
        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">u</span><span class="o">.</span><span class="n">canRedo</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;cant redo&#39;</span><span class="p">,</span><span class="n">u</span><span class="o">.</span><span class="n">undoMenuLabel</span><span class="p">,</span><span class="n">u</span><span class="o">.</span><span class="n">redoMenuLabel</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">u</span><span class="o">.</span><span class="n">getBead</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">bead</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;no bead&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">dumpBead</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">bead</span><span class="p">))</span>

        <span class="n">u</span><span class="o">.</span><span class="n">redoing</span> <span class="o">=</span> <span class="bp">True</span> 
        <span class="n">u</span><span class="o">.</span><span class="n">groupCount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c">### c.endEditing()</span>
        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">redoHelper</span><span class="p">:</span>
            <span class="n">u</span><span class="o">.</span><span class="n">redoHelper</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;no redo helper for </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span><span class="n">u</span><span class="o">.</span><span class="n">undoType</span><span class="p">))</span>

        <span class="c"># Redraw and recolor.</span>
        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">updateEditors</span><span class="p">()</span> <span class="c"># New in Leo 4.4.8.</span>
        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># Don&#39;t do this: it interferes with selection ranges.</span>
            <span class="c"># This strange code forces a recomputation of the root position.</span>
            <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">setCurrentPosition</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">newChanged</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">newChanged</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">newChanged</span><span class="p">)</span>

        <span class="c"># Redrawing *must* be done here before setting u.undoing to False.</span>
        <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getSelectionRange</span><span class="p">()</span>
        <span class="n">ins</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getInsertPoint</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">recolor</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">bodyWantsFocus</span><span class="p">()</span>
        <span class="n">w</span><span class="o">.</span><span class="n">setSelectionRange</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">insert</span><span class="o">=</span><span class="n">ins</span><span class="p">)</span>
        <span class="n">w</span><span class="o">.</span><span class="n">seeInsertPoint</span><span class="p">()</span>
        <span class="n">u</span><span class="o">.</span><span class="n">redoing</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">u</span><span class="o">.</span><span class="n">bead</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">u</span><span class="o">.</span><span class="n">setUndoTypes</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20110519074734.6092: *3* redo helpers</span>
    <span class="c">#@+node:ekr.20050424170219: *4* redoClearRecentFiles</span></div>
<div class="viewcode-block" id="undoer.redoClearRecentFiles"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.redoClearRecentFiles">[docs]</a>    <span class="k">def</span> <span class="nf">redoClearRecentFiles</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span>
        <span class="n">rf</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">recentFilesManager</span>

        <span class="n">rf</span><span class="o">.</span><span class="n">setRecentFiles</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">newRecentFiles</span><span class="p">[:])</span>
        <span class="n">rf</span><span class="o">.</span><span class="n">createRecentFilesMenuItems</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20111005152227.15558: *4* redoCloneMarkedNodes</span></div>
<div class="viewcode-block" id="undoer.redoCloneMarkedNodes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.redoCloneMarkedNodes">[docs]</a>    <span class="k">def</span> <span class="nf">redoCloneMarkedNodes</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span>

        <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">cloneMarked</span><span class="p">()</span>
        <span class="n">u</span><span class="o">.</span><span class="n">newP</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="n">u</span><span class="o">.</span><span class="n">newChanged</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">isChanged</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20050412083057: *4* redoCloneNode</span></div>
<div class="viewcode-block" id="undoer.redoCloneNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.redoCloneNode">[docs]</a>    <span class="k">def</span> <span class="nf">redoCloneNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">chapterController</span>

        <span class="k">if</span> <span class="n">cc</span><span class="p">:</span> <span class="n">cc</span><span class="o">.</span><span class="n">selectChapterByName</span><span class="p">(</span><span class="s">&#39;main&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">newBack</span><span class="p">:</span>
            <span class="n">u</span><span class="o">.</span><span class="n">newP</span><span class="o">.</span><span class="n">_linkAfter</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">newBack</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">u</span><span class="o">.</span><span class="n">newParent</span><span class="p">:</span>
            <span class="n">u</span><span class="o">.</span><span class="n">newP</span><span class="o">.</span><span class="n">_linkAsNthChild</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">newParent</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">oldRoot</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span>
            <span class="n">u</span><span class="o">.</span><span class="n">newP</span><span class="o">.</span><span class="n">_linkAsRoot</span><span class="p">(</span><span class="n">oldRoot</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">dirtyVnodeList</span><span class="p">:</span>
            <span class="n">v</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span>

        <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">newP</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20111005152227.15559: *4* redoDeleteMarkedNodes</span></div>
<div class="viewcode-block" id="undoer.redoDeleteMarkedNodes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.redoDeleteMarkedNodes">[docs]</a>    <span class="k">def</span> <span class="nf">redoDeleteMarkedNodes</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span>

        <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">deleteMarked</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">newP</span><span class="p">)</span>
        <span class="n">u</span><span class="o">.</span><span class="n">newChanged</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">isChanged</span><span class="p">()</span>
    <span class="c">#@+node:EKR.20040526072519.2: *4* redoDeleteNode</span></div>
<div class="viewcode-block" id="undoer.redoDeleteNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.redoDeleteNode">[docs]</a>    <span class="k">def</span> <span class="nf">redoDeleteNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span>

        <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">deleteOutline</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">newP</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20080425060424.9: *4* redoDemote</span></div>
<div class="viewcode-block" id="undoer.redoDemote"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.redoDemote">[docs]</a>    <span class="k">def</span> <span class="nf">redoDemote</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span>
        <span class="n">parent_v</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">_parentVnode</span><span class="p">()</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">childIndex</span><span class="p">()</span>

        <span class="c"># Move the demoted nodes from the old parent to the new parent.</span>
        <span class="n">parent_v</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="n">parent_v</span><span class="o">.</span><span class="n">children</span><span class="p">[:</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">followingSibs</span><span class="p">)</span>

        <span class="c"># Adjust the parent links of the moved nodes.</span>
        <span class="c"># There is no need to adjust descendant links.</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">followingSibs</span><span class="p">:</span>
            <span class="n">v</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">parent_v</span><span class="p">)</span>
            <span class="n">v</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">setCurrentPosition</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050318085432.6: *4* redoGroup</span></div>
<div class="viewcode-block" id="undoer.redoGroup"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.redoGroup">[docs]</a>    <span class="k">def</span> <span class="nf">redoGroup</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Process beads until the matching &#39;afterGroup&#39; bead is seen.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># Remember these values.</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span>
        <span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">dirtyVnodeList</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">newSel</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">newSel</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">u</span><span class="o">.</span><span class="n">groupCount</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">bunch</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">beads</span><span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">bead</span><span class="p">]</span> <span class="p">;</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">bunch</span><span class="p">,</span><span class="s">&#39;items&#39;</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;oops: expecting bunch.items.  bunch.kind = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">bunch</span><span class="o">.</span><span class="n">kind</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">bunch</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">bunch</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setIvarsFromBunch</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">z</span><span class="o">.</span><span class="n">redoHelper</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">redoHelper</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
                    <span class="n">z</span><span class="o">.</span><span class="n">redoHelper</span><span class="p">()</span> <span class="p">;</span> <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;oops: no redo helper for </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">undoType</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">h</span><span class="p">))</span>

        <span class="n">u</span><span class="o">.</span><span class="n">groupCount</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="n">u</span><span class="o">.</span><span class="n">updateMarks</span><span class="p">(</span><span class="s">&#39;new&#39;</span><span class="p">)</span> <span class="c"># Bug fix: Leo 4.4.6.</span>

        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dirtyVnodeList</span><span class="p">:</span>
            <span class="n">v</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span> <span class="ow">and</span> <span class="n">u</span><span class="o">.</span><span class="n">verboseUndoGroup</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;redo&quot;</span><span class="p">,</span><span class="n">count</span><span class="p">,</span><span class="s">&quot;instances&quot;</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">newSel</span><span class="p">:</span>
            <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">newSel</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">setSelectionRange</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050412085138.1: *4* redoHoistNode &amp; redoDehoistNode</span></div>
<div class="viewcode-block" id="undoer.redoHoistNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.redoHoistNode">[docs]</a>    <span class="k">def</span> <span class="nf">redoHoistNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span>

        <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">hoist</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="undoer.redoDehoistNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.redoDehoistNode">[docs]</a>    <span class="k">def</span> <span class="nf">redoDehoistNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span>

        <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">dehoist</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20050412084532: *4* redoInsertNode</span></div>
<div class="viewcode-block" id="undoer.redoInsertNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.redoInsertNode">[docs]</a>    <span class="k">def</span> <span class="nf">redoInsertNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">chapterController</span>

        <span class="k">if</span> <span class="n">cc</span><span class="p">:</span> <span class="n">cc</span><span class="o">.</span><span class="n">selectChapterByName</span><span class="p">(</span><span class="s">&#39;main&#39;</span><span class="p">)</span>

        <span class="c"># g.trace(&#39;newP&#39;,u.newP.v,&#39;back&#39;,u.newBack,&#39;parent&#39;,u.newParent.v)</span>

        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">newBack</span><span class="p">:</span>
            <span class="n">u</span><span class="o">.</span><span class="n">newP</span><span class="o">.</span><span class="n">_linkAfter</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">newBack</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">u</span><span class="o">.</span><span class="n">newParent</span><span class="p">:</span>
            <span class="n">u</span><span class="o">.</span><span class="n">newP</span><span class="o">.</span><span class="n">_linkAsNthChild</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">newParent</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">oldRoot</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span>
            <span class="n">u</span><span class="o">.</span><span class="n">newP</span><span class="o">.</span><span class="n">_linkAsRoot</span><span class="p">(</span><span class="n">oldRoot</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">pasteAsClone</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">bunch</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">afterTree</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">bunch</span><span class="o">.</span><span class="n">v</span>
                <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">newP</span><span class="o">.</span><span class="n">v</span> <span class="o">==</span> <span class="n">v</span><span class="p">:</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">setBodyString</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">newP</span><span class="p">,</span><span class="n">bunch</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">setHeadString</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">newP</span><span class="p">,</span><span class="n">bunch</span><span class="o">.</span><span class="n">head</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">v</span><span class="o">.</span><span class="n">setBodyString</span><span class="p">(</span><span class="n">bunch</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
                    <span class="n">v</span><span class="o">.</span><span class="n">setHeadString</span><span class="p">(</span><span class="n">bunch</span><span class="o">.</span><span class="n">head</span><span class="p">)</span>
                <span class="c"># g.trace(v,bunch.head,bunch.body)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">newP</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050526125801: *4* redoMark</span></div>
<div class="viewcode-block" id="undoer.redoMark"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.redoMark">[docs]</a>    <span class="k">def</span> <span class="nf">redoMark</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span>

        <span class="n">u</span><span class="o">.</span><span class="n">updateMarks</span><span class="p">(</span><span class="s">&#39;new&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">groupCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">dirtyVnodeList</span><span class="p">:</span>
                <span class="n">v</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span>

            <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050411111847: *4* redoMove</span></div>
<div class="viewcode-block" id="undoer.redoMove"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.redoMove">[docs]</a>    <span class="k">def</span> <span class="nf">redoMove</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">chapterController</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">v</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">oldParent_v</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">newParent_v</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cc</span><span class="p">:</span> <span class="n">cc</span><span class="o">.</span><span class="n">selectChapterByName</span><span class="p">(</span><span class="s">&#39;main&#39;</span><span class="p">)</span>

        <span class="c"># Adjust the children arrays.</span>
        <span class="k">assert</span> <span class="n">u</span><span class="o">.</span><span class="n">oldParent_v</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">oldN</span><span class="p">]</span> <span class="o">==</span> <span class="n">v</span>
        <span class="k">del</span> <span class="n">u</span><span class="o">.</span><span class="n">oldParent_v</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">oldN</span><span class="p">]</span>

        <span class="n">parent_v</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">newParent_v</span>
        <span class="n">parent_v</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">newN</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
        <span class="n">v</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">newParent_v</span><span class="p">)</span>
        <span class="n">v</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">oldParent_v</span><span class="p">)</span>

        <span class="n">u</span><span class="o">.</span><span class="n">updateMarks</span><span class="p">(</span><span class="s">&#39;new&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">dirtyVnodeList</span><span class="p">:</span>
            <span class="n">v</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span>

        <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">newP</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050318085432.7: *4* redoNodeContents</span></div>
<div class="viewcode-block" id="undoer.redoNodeContents"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.redoNodeContents">[docs]</a>    <span class="k">def</span> <span class="nf">redoNodeContents</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">w</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">bodyCtrl</span>

        <span class="c"># Restore the body.</span>
        <span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">setBodyString</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">newBody</span><span class="p">)</span>
        <span class="n">w</span><span class="o">.</span><span class="n">setAllText</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">newBody</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">recolor</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">,</span><span class="n">incremental</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="c"># Restore the headline.</span>
        <span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">initHeadString</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">newHead</span><span class="p">)</span>

        <span class="c"># This is required so.  Otherwise redraw will revert the change!</span>
        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">setHeadline</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">,</span><span class="n">u</span><span class="o">.</span><span class="n">newHead</span><span class="p">)</span> <span class="c"># New in 4.4b2.</span>

        <span class="c"># g.trace(&#39;newHead&#39;,u.newHead,&#39;revert&#39;,c.frame.tree.revertHeadline)</span>

        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">groupCount</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">u</span><span class="o">.</span><span class="n">newSel</span><span class="p">:</span>
            <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">newSel</span>
            <span class="n">w</span><span class="o">.</span><span class="n">setSelectionRange</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">groupCount</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">u</span><span class="o">.</span><span class="n">newYScroll</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">w</span><span class="o">.</span><span class="n">setYScrollPosition</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">newYScroll</span><span class="p">)</span>

        <span class="n">u</span><span class="o">.</span><span class="n">updateMarks</span><span class="p">(</span><span class="s">&#39;new&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">dirtyVnodeList</span><span class="p">:</span>
            <span class="n">v</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20111005152227.15564: *4* redoMoveMarkedNodes</span></div>
<div class="viewcode-block" id="undoer.redoMoveMarkedNodes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.redoMoveMarkedNodes">[docs]</a>    <span class="k">def</span> <span class="nf">redoMoveMarkedNodes</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span>

        <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">moveMarked</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">newP</span><span class="p">)</span>
        <span class="n">u</span><span class="o">.</span><span class="n">newChanged</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">isChanged</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20080425060424.13: *4* redoPromote</span></div>
<div class="viewcode-block" id="undoer.redoPromote"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.redoPromote">[docs]</a>    <span class="k">def</span> <span class="nf">redoPromote</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span>
        <span class="n">parent_v</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">_parentVnode</span><span class="p">()</span>

        <span class="c"># Add the children to parent_v&#39;s children.</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">childIndex</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">old_children</span> <span class="o">=</span> <span class="n">parent_v</span><span class="o">.</span><span class="n">children</span><span class="p">[:]</span>
        <span class="n">parent_v</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="n">old_children</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
            <span class="c"># Add children up to the promoted nodes.</span>
        <span class="n">parent_v</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>
            <span class="c"># Add the promoted nodes.</span>
        <span class="n">parent_v</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">old_children</span><span class="p">[</span><span class="n">n</span><span class="p">:])</span>
            <span class="c"># Add the children up to the promoted nodes.</span>

        <span class="c"># Remove the old children.</span>
        <span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c"># Adjust the parent links in the moved children.</span>
        <span class="c"># There is no need to adjust descendant links.</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="n">child</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
            <span class="n">child</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parent_v</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">setCurrentPosition</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20080425060424.4: *4* redoSort</span></div>
<div class="viewcode-block" id="undoer.redoSort"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.redoSort">[docs]</a>    <span class="k">def</span> <span class="nf">redoSort</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span>

        <span class="n">parent_v</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">_parentVnode</span><span class="p">()</span>
        <span class="n">parent_v</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">newChildren</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">setPositionAfterSort</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">sortChildren</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">setCurrentPosition</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050318085432.8: *4* redoTree</span></div>
<div class="viewcode-block" id="undoer.redoTree"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.redoTree">[docs]</a>    <span class="k">def</span> <span class="nf">redoTree</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Redo replacement of an entire tree.&#39;&#39;&#39;</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span>

        <span class="n">u</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">undoRedoTree</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">,</span><span class="n">u</span><span class="o">.</span><span class="n">oldTree</span><span class="p">,</span><span class="n">u</span><span class="o">.</span><span class="n">newTree</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">)</span> <span class="c"># Does full recolor.</span>
        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">newSel</span><span class="p">:</span>
            <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">newSel</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">setSelectionRange</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
    <span class="c">#@+node:EKR.20040526075238.5: *4* redoTyping</span></div>
<div class="viewcode-block" id="undoer.redoTyping"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.redoTyping">[docs]</a>    <span class="k">def</span> <span class="nf">redoTyping</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">current</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">bodyCtrl</span>

        <span class="c"># selectPosition causes recoloring, so avoid if possible.</span>
        <span class="k">if</span> <span class="n">current</span> <span class="o">!=</span> <span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">u</span><span class="o">.</span><span class="n">undoType</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;Cut&#39;</span><span class="p">,</span><span class="s">&#39;Paste&#39;</span><span class="p">,</span><span class="s">&#39;Clear Recent Files&#39;</span><span class="p">):</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">forceFullRecolor</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">undoRedoText</span><span class="p">(</span>
            <span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">,</span><span class="n">u</span><span class="o">.</span><span class="n">leading</span><span class="p">,</span><span class="n">u</span><span class="o">.</span><span class="n">trailing</span><span class="p">,</span>
            <span class="n">u</span><span class="o">.</span><span class="n">newMiddleLines</span><span class="p">,</span><span class="n">u</span><span class="o">.</span><span class="n">oldMiddleLines</span><span class="p">,</span>
            <span class="n">u</span><span class="o">.</span><span class="n">newNewlines</span><span class="p">,</span><span class="n">u</span><span class="o">.</span><span class="n">oldNewlines</span><span class="p">,</span>
            <span class="n">tag</span><span class="o">=</span><span class="s">&quot;redo&quot;</span><span class="p">,</span><span class="n">undoType</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">undoType</span><span class="p">)</span>

        <span class="n">u</span><span class="o">.</span><span class="n">updateMarks</span><span class="p">(</span><span class="s">&#39;new&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">dirtyVnodeList</span><span class="p">:</span>
            <span class="n">v</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">newSel</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">bodyWantsFocus</span><span class="p">()</span>
            <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">newSel</span>
            <span class="n">w</span><span class="o">.</span><span class="n">setSelectionRange</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">insert</span><span class="o">=</span><span class="n">j</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">yview</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">bodyWantsFocus</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">setYScrollPosition</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">yview</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.2039: *3* undo</span></div>
<div class="viewcode-block" id="undoer.undo"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.undo">[docs]</a>    <span class="k">def</span> <span class="nf">undo</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Undo the operation described by the undo parameters.&quot;&quot;&quot;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">bodyCtrl</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;no current position&#39;</span><span class="p">)</span>
            
        <span class="c"># Bug fix: 2013/4/26: End editing *before* getting state.</span>
        <span class="n">c</span><span class="o">.</span><span class="n">endEditing</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">per_node_undo</span><span class="p">:</span> <span class="c"># 2011/05/19</span>
            <span class="n">u</span><span class="o">.</span><span class="n">setIvarsFromVnode</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">u</span><span class="o">.</span><span class="n">canUndo</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;cant undo&#39;</span><span class="p">,</span><span class="n">u</span><span class="o">.</span><span class="n">undoMenuLabel</span><span class="p">,</span><span class="n">u</span><span class="o">.</span><span class="n">redoMenuLabel</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">u</span><span class="o">.</span><span class="n">getBead</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">bead</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;no bead&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">dumpBead</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">bead</span><span class="p">))</span>

        <span class="n">u</span><span class="o">.</span><span class="n">undoing</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">u</span><span class="o">.</span><span class="n">groupCount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c">### c.endEditing()</span>
        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">undoHelper</span><span class="p">:</span>
            <span class="n">u</span><span class="o">.</span><span class="n">undoHelper</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;no undo helper for </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span><span class="n">u</span><span class="o">.</span><span class="n">undoType</span><span class="p">))</span>

        <span class="c"># Redraw and recolor.</span>
        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">updateEditors</span><span class="p">()</span> <span class="c"># New in Leo 4.4.8.</span>
        <span class="k">if</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># Don&#39;t do this: it interferes with selection ranges.</span>
            <span class="c"># This strange code forces a recomputation of the root position.</span>
            <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">setCurrentPosition</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">oldChanged</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">oldChanged</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">c</span><span class="o">.</span><span class="n">setChanged</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">oldChanged</span><span class="p">)</span>

        <span class="c"># Redrawing *must* be done here before setting u.undoing to False.</span>
        <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getSelectionRange</span><span class="p">()</span>
        <span class="n">ins</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">getInsertPoint</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">redraw</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">recolor</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">bodyWantsFocus</span><span class="p">()</span>
        <span class="n">w</span><span class="o">.</span><span class="n">setSelectionRange</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">insert</span><span class="o">=</span><span class="n">ins</span><span class="p">)</span>
        <span class="n">w</span><span class="o">.</span><span class="n">seeInsertPoint</span><span class="p">()</span>
        <span class="n">u</span><span class="o">.</span><span class="n">undoing</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">u</span><span class="o">.</span><span class="n">bead</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="n">u</span><span class="o">.</span><span class="n">setUndoTypes</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20110519074734.6093: *3* undo helpers</span>
    <span class="c">#@+node:ekr.20050424170219.1: *4* undoClearRecentFiles</span></div>
<div class="viewcode-block" id="undoer.undoClearRecentFiles"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.undoClearRecentFiles">[docs]</a>    <span class="k">def</span> <span class="nf">undoClearRecentFiles</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span>
        <span class="n">rf</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">recentFilesManager</span>

        <span class="n">rf</span><span class="o">.</span><span class="n">setRecentFiles</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">oldRecentFiles</span><span class="p">[:])</span>
        <span class="n">rf</span><span class="o">.</span><span class="n">createRecentFilesMenuItems</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20111005152227.15560: *4* undoCloneMarkedNodes</span></div>
<div class="viewcode-block" id="undoer.undoCloneMarkedNodes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.undoCloneMarkedNodes">[docs]</a>    <span class="k">def</span> <span class="nf">undoCloneMarkedNodes</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="nb">next</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">next</span><span class="o">.</span><span class="n">h</span> <span class="o">==</span> <span class="s">&#39;Clones of marked nodes&#39;</span><span class="p">,</span><span class="nb">repr</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">,</span><span class="nb">next</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
        <span class="nb">next</span><span class="o">.</span><span class="n">doDelete</span><span class="p">()</span>

        <span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">setAllAncestorAtFileNodesDirty</span><span class="p">()</span>
        <span class="n">u</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050412083057.1: *4* undoCloneNode</span></div>
<div class="viewcode-block" id="undoer.undoCloneNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.undoCloneNode">[docs]</a>    <span class="k">def</span> <span class="nf">undoCloneNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">chapterController</span>

        <span class="k">if</span> <span class="n">cc</span><span class="p">:</span> <span class="n">cc</span><span class="o">.</span><span class="n">selectChapterByName</span><span class="p">(</span><span class="s">&#39;main&#39;</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">newP</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">deleteOutline</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">dirtyVnodeList</span><span class="p">:</span>
            <span class="n">v</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span> <span class="c"># Bug fix: Leo 4.4.6</span>

        <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20111005152227.15557: *4* undoDeleteMarkedNodes</span></div>
<div class="viewcode-block" id="undoer.undoDeleteMarkedNodes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.undoDeleteMarkedNodes">[docs]</a>    <span class="k">def</span> <span class="nf">undoDeleteMarkedNodes</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span>

        <span class="c"># Undo the deletes in reverse order</span>
        <span class="n">aList</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">deleteMarkedNodesData</span><span class="p">[:]</span>
        <span class="n">aList</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">stack</span><span class="p">:</span>
                <span class="n">parent_v</span><span class="p">,</span><span class="n">junk</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parent_v</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">hiddenRootNode</span>

            <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">_addLink</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">_childIndex</span><span class="p">,</span><span class="n">parent_v</span><span class="p">)</span>

        <span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">setAllAncestorAtFileNodesDirty</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050412084055: *4* undoDeleteNode</span></div>
<div class="viewcode-block" id="undoer.undoDeleteNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.undoDeleteNode">[docs]</a>    <span class="k">def</span> <span class="nf">undoDeleteNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span>

        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">oldBack</span><span class="p">:</span>
            <span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">_linkAfter</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">oldBack</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">u</span><span class="o">.</span><span class="n">oldParent</span><span class="p">:</span>
            <span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">_linkAsNthChild</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">oldParent</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">oldRoot</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span>
            <span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">_linkAsRoot</span><span class="p">(</span><span class="n">oldRoot</span><span class="p">)</span>

        <span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">setAllAncestorAtFileNodesDirty</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20080425060424.10: *4* undoDemote</span></div>
<div class="viewcode-block" id="undoer.undoDemote"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.undoDemote">[docs]</a>    <span class="k">def</span> <span class="nf">undoDemote</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span>
        <span class="n">parent_v</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">_parentVnode</span><span class="p">()</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">followingSibs</span><span class="p">)</span>

        <span class="c"># Remove the demoted nodes from p&#39;s children.</span>
        <span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">children</span><span class="p">[:</span><span class="o">-</span><span class="n">n</span><span class="p">]</span>

        <span class="c"># Add the demoted nodes to the parent&#39;s children.</span>
        <span class="n">parent_v</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">followingSibs</span><span class="p">)</span>

        <span class="c"># Adjust the parent links.</span>
        <span class="c"># There is no need to adjust descendant links.</span>
        <span class="k">for</span> <span class="n">sib</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">followingSibs</span><span class="p">:</span>
            <span class="n">sib</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
            <span class="n">sib</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parent_v</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">setCurrentPosition</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050318085713: *4* undoGroup</span></div>
<div class="viewcode-block" id="undoer.undoGroup"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.undoGroup">[docs]</a>    <span class="k">def</span> <span class="nf">undoGroup</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Process beads until the matching &#39;beforeGroup&#39; bead is seen.&#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c"># Remember these values.</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span>
        <span class="n">dirtyVnodeList</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">dirtyVnodeList</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="n">oldSel</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">oldSel</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">u</span><span class="o">.</span><span class="n">groupCount</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">bunch</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">beads</span><span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">bead</span><span class="p">]</span> <span class="p">;</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">bunch</span><span class="p">,</span><span class="s">&#39;items&#39;</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;oops: expecting bunch.items.  bunch.kind = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">bunch</span><span class="o">.</span><span class="n">kind</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">bunch</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Important bug fix: 9/8/06: reverse the items first.</span>
            <span class="n">reversedItems</span> <span class="o">=</span> <span class="n">bunch</span><span class="o">.</span><span class="n">items</span><span class="p">[:]</span>
            <span class="n">reversedItems</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">reversedItems</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setIvarsFromBunch</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">z</span><span class="o">.</span><span class="n">undoHelper</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">undoHelper</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>
                    <span class="n">z</span><span class="o">.</span><span class="n">undoHelper</span><span class="p">()</span> <span class="p">;</span> <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s">&#39;oops: no undo helper for </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">undoType</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">))</span>

        <span class="n">u</span><span class="o">.</span><span class="n">groupCount</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="n">u</span><span class="o">.</span><span class="n">updateMarks</span><span class="p">(</span><span class="s">&#39;old&#39;</span><span class="p">)</span> <span class="c"># Bug fix: Leo 4.4.6.</span>

        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dirtyVnodeList</span><span class="p">:</span>
            <span class="n">v</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span> <span class="c"># Bug fix: Leo 4.4.6.</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span> <span class="ow">and</span> <span class="n">u</span><span class="o">.</span><span class="n">verboseUndoGroup</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">es</span><span class="p">(</span><span class="s">&quot;undo&quot;</span><span class="p">,</span><span class="n">count</span><span class="p">,</span><span class="s">&quot;instances&quot;</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">oldSel</span><span class="p">:</span>
            <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">oldSel</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">setSelectionRange</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050412083244: *4* undoHoistNode &amp; undoDehoistNode</span></div>
<div class="viewcode-block" id="undoer.undoHoistNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.undoHoistNode">[docs]</a>    <span class="k">def</span> <span class="nf">undoHoistNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span>

        <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">dehoist</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="undoer.undoDehoistNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.undoDehoistNode">[docs]</a>    <span class="k">def</span> <span class="nf">undoDehoistNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span>

        <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">hoist</span><span class="p">()</span>
    <span class="c">#@+node:ekr.20050412085112: *4* undoInsertNode</span></div>
<div class="viewcode-block" id="undoer.undoInsertNode"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.undoInsertNode">[docs]</a>    <span class="k">def</span> <span class="nf">undoInsertNode</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">chapterController</span>

        <span class="k">if</span> <span class="n">cc</span><span class="p">:</span> <span class="n">cc</span><span class="o">.</span><span class="n">selectChapterByName</span><span class="p">(</span><span class="s">&#39;main&#39;</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">newP</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">deleteOutline</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">pasteAsClone</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">bunch</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">beforeTree</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">bunch</span><span class="o">.</span><span class="n">v</span>
                <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">v</span> <span class="o">==</span> <span class="n">v</span><span class="p">:</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">setBodyString</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">,</span><span class="n">bunch</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">setHeadString</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">,</span><span class="n">bunch</span><span class="o">.</span><span class="n">head</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">v</span><span class="o">.</span><span class="n">setBodyString</span><span class="p">(</span><span class="n">bunch</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
                    <span class="n">v</span><span class="o">.</span><span class="n">setHeadString</span><span class="p">(</span><span class="n">bunch</span><span class="o">.</span><span class="n">head</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050526124906: *4* undoMark</span></div>
<div class="viewcode-block" id="undoer.undoMark"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.undoMark">[docs]</a>    <span class="k">def</span> <span class="nf">undoMark</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span>

        <span class="n">u</span><span class="o">.</span><span class="n">updateMarks</span><span class="p">(</span><span class="s">&#39;old&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">groupCount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">dirtyVnodeList</span><span class="p">:</span>
                <span class="n">v</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span> <span class="c"># Bug fix: Leo 4.4.6.</span>

            <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050411112033: *4* undoMove</span></div>
<div class="viewcode-block" id="undoer.undoMove"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.undoMove">[docs]</a>    <span class="k">def</span> <span class="nf">undoMove</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">chapterController</span>

        <span class="k">if</span> <span class="n">cc</span><span class="p">:</span> <span class="n">cc</span><span class="o">.</span><span class="n">selectChapterByName</span><span class="p">(</span><span class="s">&#39;main&#39;</span><span class="p">)</span>

        <span class="n">v</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">v</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">oldParent_v</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">newParent_v</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;v&#39;</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="s">&#39;newN&#39;</span><span class="p">,</span><span class="n">u</span><span class="o">.</span><span class="n">newN</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">newParent_v</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

        <span class="c"># Adjust the children arrays.</span>
        <span class="k">assert</span> <span class="n">u</span><span class="o">.</span><span class="n">newParent_v</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">newN</span><span class="p">]</span> <span class="o">==</span> <span class="n">v</span>
        <span class="k">del</span> <span class="n">u</span><span class="o">.</span><span class="n">newParent_v</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">newN</span><span class="p">]</span>
        <span class="n">u</span><span class="o">.</span><span class="n">oldParent_v</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">oldN</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>

        <span class="c"># Recompute the parent links.</span>
        <span class="n">v</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">oldParent_v</span><span class="p">)</span>
        <span class="n">v</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">newParent_v</span><span class="p">)</span>

        <span class="n">u</span><span class="o">.</span><span class="n">updateMarks</span><span class="p">(</span><span class="s">&#39;old&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">dirtyVnodeList</span><span class="p">:</span>
            <span class="n">v</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span>

        <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050318085713.1: *4* undoNodeContents</span></div>
<div class="viewcode-block" id="undoer.undoNodeContents"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.undoNodeContents">[docs]</a>    <span class="k">def</span> <span class="nf">undoNodeContents</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Undo all changes to the contents of a node,</span>
<span class="sd">        including headline and body text, and marked bits.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>
        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">bodyCtrl</span>
        <span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">oldBody</span>
        <span class="n">w</span><span class="o">.</span><span class="n">setAllText</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">oldBody</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">recolor</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">,</span><span class="n">incremental</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">oldHead</span><span class="p">))</span>

        <span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">oldHead</span>

        <span class="c"># This is required.  Otherwise c.redraw will revert the change!</span>
        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">tree</span><span class="o">.</span><span class="n">setHeadline</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">,</span><span class="n">u</span><span class="o">.</span><span class="n">oldHead</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">groupCount</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">u</span><span class="o">.</span><span class="n">oldSel</span><span class="p">:</span>
            <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">oldSel</span>
            <span class="n">w</span><span class="o">.</span><span class="n">setSelectionRange</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">groupCount</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">u</span><span class="o">.</span><span class="n">oldYScroll</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">w</span><span class="o">.</span><span class="n">setYScrollPosition</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">oldYScroll</span><span class="p">)</span>

        <span class="n">u</span><span class="o">.</span><span class="n">updateMarks</span><span class="p">(</span><span class="s">&#39;old&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">dirtyVnodeList</span><span class="p">:</span>
            <span class="n">v</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span> <span class="c"># Bug fix: Leo 4.4.6.</span>
    <span class="c">#@+node:ekr.20111005152227.15563: *4* undoMoveMarkedNodes</span></div>
<div class="viewcode-block" id="undoer.undoMoveMarkedNodes"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.undoMoveMarkedNodes">[docs]</a>    <span class="k">def</span> <span class="nf">undoMoveMarkedNodes</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span>

        <span class="c"># Undo the moves in reverse order</span>
        <span class="n">aList</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">deleteMarkedNodesData</span><span class="p">[:]</span>
        <span class="n">aList</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">aList</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">stack</span><span class="p">:</span>
                <span class="n">parent_v</span><span class="p">,</span><span class="n">junk</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parent_v</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">hiddenRootNode</span>

            <span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">_addLink</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">_childIndex</span><span class="p">,</span><span class="n">parent_v</span><span class="p">)</span>

        <span class="c"># A shortcut. This deletes all the &quot;extra copies of the nodes&quot;.</span>
        <span class="n">root</span><span class="o">.</span><span class="n">doDelete</span><span class="p">()</span>

        <span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">setAllAncestorAtFileNodesDirty</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20080425060424.14: *4* undoPromote</span></div>
<div class="viewcode-block" id="undoer.undoPromote"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.undoPromote">[docs]</a>    <span class="k">def</span> <span class="nf">undoPromote</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span>
        <span class="n">parent_v</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">_parentVnode</span><span class="p">()</span> <span class="c"># The parent of the all the *promoted* nodes.</span>

        <span class="c"># Remove the promoted nodes from parent_v&#39;s children.</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">childIndex</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c"># Adjust the old parents children</span>
        <span class="n">old_children</span> <span class="o">=</span> <span class="n">parent_v</span><span class="o">.</span><span class="n">children</span>
        <span class="n">parent_v</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="n">old_children</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
            <span class="c"># Add the nodes before the promoted nodes.</span>
        <span class="n">parent_v</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">old_children</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">children</span><span class="p">):])</span>
            <span class="c"># Add the nodes after the promoted nodes.</span>

        <span class="c"># Add the demoted nodes to v&#39;s children.</span>
        <span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">children</span><span class="p">[:]</span>

        <span class="c"># Adjust the parent links.</span>
        <span class="c"># There is no need to adjust descendant links.</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
            <span class="n">child</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">parent_v</span><span class="p">)</span>
            <span class="n">child</span><span class="o">.</span><span class="n">parents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">v</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">setCurrentPosition</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20031218072017.1493: *4* undoRedoText</span></div>
<div class="viewcode-block" id="undoer.undoRedoText"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.undoRedoText">[docs]</a>    <span class="k">def</span> <span class="nf">undoRedoText</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span>
        <span class="n">leading</span><span class="p">,</span><span class="n">trailing</span><span class="p">,</span> <span class="c"># Number of matching leading &amp; trailing lines.</span>
        <span class="n">oldMidLines</span><span class="p">,</span><span class="n">newMidLines</span><span class="p">,</span> <span class="c"># Lists of unmatched lines.</span>
        <span class="n">oldNewlines</span><span class="p">,</span><span class="n">newNewlines</span><span class="p">,</span> <span class="c"># Number of trailing newlines.</span>
        <span class="n">tag</span><span class="o">=</span><span class="s">&quot;undo&quot;</span><span class="p">,</span> <span class="c"># &quot;undo&quot; or &quot;redo&quot;</span>
        <span class="n">undoType</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Handle text undo and redo: converts _new_ text into _old_ text.&#39;&#39;&#39;</span>

        <span class="c"># newNewlines is unused, but it has symmetry.</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">False</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">unitTesting</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">w</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">bodyCtrl</span>

        <span class="c">#@+&lt;&lt; Compute the result using p&#39;s body text &gt;&gt;</span>
        <span class="c">#@+node:ekr.20061106105812.1: *5* &lt;&lt; Compute the result using p&#39;s body text &gt;&gt;</span>
        <span class="c"># Recreate the text using the present body text.</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">b</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">toUnicode</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="n">body_lines</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">leading</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">body_lines</span><span class="p">[:</span><span class="n">leading</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">oldMidLines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">oldMidLines</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trailing</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">body_lines</span><span class="p">[</span><span class="o">-</span><span class="n">trailing</span><span class="p">:])</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="c"># Remove trailing newlines in s.</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c"># Add oldNewlines newlines.</span>
        <span class="k">if</span> <span class="n">oldNewlines</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">*</span> <span class="n">oldNewlines</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">s</span>

        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">debug_print</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;body:  &quot;</span><span class="p">,</span><span class="n">body</span><span class="p">)</span>
            <span class="n">g</span><span class="o">.</span><span class="n">pr</span><span class="p">(</span><span class="s">&quot;result:&quot;</span><span class="p">,</span><span class="n">result</span><span class="p">)</span>
        <span class="c">#@-&lt;&lt; Compute the result using p&#39;s body text &gt;&gt;</span>
        <span class="n">p</span><span class="o">.</span><span class="n">setBodyString</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">w</span><span class="o">.</span><span class="n">setAllText</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="n">tag</span><span class="o">==</span><span class="s">&#39;undo&#39;</span><span class="p">,</span><span class="n">u</span><span class="o">.</span><span class="n">oldSel</span><span class="p">,</span><span class="n">u</span><span class="o">.</span><span class="n">newSel</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sel</span><span class="p">:</span>
            <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">sel</span>
            <span class="n">w</span><span class="o">.</span><span class="n">setSelectionRange</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">insert</span><span class="o">=</span><span class="n">j</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">recolor</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">incremental</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">w</span><span class="o">.</span><span class="n">seeInsertPoint</span><span class="p">()</span> <span class="c"># 2009/12/21</span>
    <span class="c">#@+node:ekr.20050408100042: *4* undoRedoTree</span></div>
<div class="viewcode-block" id="undoer.undoRedoTree"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.undoRedoTree">[docs]</a>    <span class="k">def</span> <span class="nf">undoRedoTree</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">new_data</span><span class="p">,</span><span class="n">old_data</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Replace p and its subtree using old_data during undo.&#39;&#39;&#39;</span>

        <span class="c"># Same as undoReplace except uses g.Bunch.</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span>

        <span class="k">if</span> <span class="n">new_data</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># This is the first time we have undone the operation.</span>
            <span class="c"># Put the new data in the bead.</span>
            <span class="n">bunch</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">beads</span><span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">bead</span><span class="p">]</span>
            <span class="n">bunch</span><span class="o">.</span><span class="n">newTree</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">saveTree</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="n">u</span><span class="o">.</span><span class="n">beads</span><span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">bead</span><span class="p">]</span> <span class="o">=</span> <span class="n">bunch</span>

        <span class="c"># Replace data in tree with old data.</span>
        <span class="n">u</span><span class="o">.</span><span class="n">restoreTree</span><span class="p">(</span><span class="n">old_data</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">setBodyString</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">p</span> <span class="c"># Nothing really changes.</span>
    <span class="c">#@+node:ekr.20080425060424.5: *4* undoSort</span></div>
<div class="viewcode-block" id="undoer.undoSort"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.undoSort">[docs]</a>    <span class="k">def</span> <span class="nf">undoSort</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span>

        <span class="n">parent_v</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">_parentVnode</span><span class="p">()</span>
        <span class="n">parent_v</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">oldChildren</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">setPositionAfterSort</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">sortChildren</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">setCurrentPosition</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="c">#@+node:ekr.20050318085713.2: *4* undoTree</span></div>
<div class="viewcode-block" id="undoer.undoTree"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.undoTree">[docs]</a>    <span class="k">def</span> <span class="nf">undoTree</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;Redo replacement of an entire tree.&#39;&#39;&#39;</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span>

        <span class="n">u</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">undoRedoTree</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">,</span><span class="n">u</span><span class="o">.</span><span class="n">newTree</span><span class="p">,</span><span class="n">u</span><span class="o">.</span><span class="n">oldTree</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">)</span> <span class="c"># Does full recolor.</span>
        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">oldSel</span><span class="p">:</span>
            <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">oldSel</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">setSelectionRange</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
    <span class="c">#@+node:EKR.20040526090701.4: *4* undoTyping</span></div>
<div class="viewcode-block" id="undoer.undoTyping"><a class="viewcode-back" href="../../../leo.core.html#leo.core.leoUndo.undoer.undoTyping">[docs]</a>    <span class="k">def</span> <span class="nf">undoTyping</span> <span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span> <span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">c</span> <span class="p">;</span> <span class="n">current</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">bodyCtrl</span>

        <span class="c"># selectPosition causes recoloring, so don&#39;t do this unless needed.</span>
        <span class="k">if</span> <span class="n">current</span> <span class="o">!=</span> <span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">selectPosition</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">u</span><span class="o">.</span><span class="n">undoType</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;Cut&quot;</span><span class="p">,</span><span class="s">&quot;Paste&quot;</span><span class="p">,</span><span class="s">&#39;Clear Recent Files&#39;</span><span class="p">):</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">forceFullRecolor</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">undoRedoText</span><span class="p">(</span>
            <span class="n">u</span><span class="o">.</span><span class="n">p</span><span class="p">,</span><span class="n">u</span><span class="o">.</span><span class="n">leading</span><span class="p">,</span><span class="n">u</span><span class="o">.</span><span class="n">trailing</span><span class="p">,</span>
            <span class="n">u</span><span class="o">.</span><span class="n">oldMiddleLines</span><span class="p">,</span><span class="n">u</span><span class="o">.</span><span class="n">newMiddleLines</span><span class="p">,</span>
            <span class="n">u</span><span class="o">.</span><span class="n">oldNewlines</span><span class="p">,</span><span class="n">u</span><span class="o">.</span><span class="n">newNewlines</span><span class="p">,</span>
            <span class="n">tag</span><span class="o">=</span><span class="s">&quot;undo&quot;</span><span class="p">,</span><span class="n">undoType</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">undoType</span><span class="p">)</span>

        <span class="n">u</span><span class="o">.</span><span class="n">updateMarks</span><span class="p">(</span><span class="s">&#39;old&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">u</span><span class="o">.</span><span class="n">dirtyVnodeList</span><span class="p">:</span>
            <span class="n">v</span><span class="o">.</span><span class="n">setDirty</span><span class="p">()</span> <span class="c"># Bug fix: Leo 4.4.6.</span>

        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">oldSel</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">bodyWantsFocus</span><span class="p">()</span>
            <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">oldSel</span>
            <span class="n">w</span><span class="o">.</span><span class="n">setSelectionRange</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">insert</span><span class="o">=</span><span class="n">j</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">yview</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">bodyWantsFocus</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">setYScrollPosition</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">yview</span><span class="p">)</span>
    <span class="c">#@-others</span>
<span class="c">#@-others</span>
<span class="c">#@-leo</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Leo API 4.11dev documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Ed K. Ream.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
  </body>
</html>