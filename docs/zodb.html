

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Using ZODB with Leo &mdash; Leo 6.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Advanced Topics" href="intermediatetopics.html" />
    <link rel="prev" title="ILeo: Leo’s IPython Bridge" href="IPythonBridge.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="leo_toc.html" class="icon icon-home"> Leo
          

          
            
            <img src="_static/Leo4-80-border.jpg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                6.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="preliminaries.html">Preliminaries</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="getting-started.html">Downloading, Installing &amp; Running Leo</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="cheatsheet.html">Cheat Sheet</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="screencasts.html">Videos about Leo</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="usersguide.html">Users Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="leoandotherprograms.html">Leo and Other Programs</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="emacs.html">Leo and Emacs, including org mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="vimBindings.html">Using Vim with Leo</a></li>
<li class="toctree-l2"><a class="reference internal" href="leoBridge.html">Embedding Leo with the leoBridge module</a></li>
<li class="toctree-l2"><a class="reference internal" href="IPythonBridge.html">ILeo: Leo’s IPython Bridge</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Using ZODB with Leo</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#configuring-leo-to-use-zodb">Configuring Leo to use zodb</a></li>
<li class="toctree-l3"><a class="reference internal" href="#initing-zodb">Initing zodb</a></li>
<li class="toctree-l3"><a class="reference internal" href="#writing-data-to-zodb">Writing data to zodb</a></li>
<li class="toctree-l3"><a class="reference internal" href="#defining-zodb-keys">Defining zodb keys</a></li>
<li class="toctree-l3"><a class="reference internal" href="#reading-data-from-zodb">Reading data from zodb</a></li>
<li class="toctree-l3"><a class="reference internal" href="#about-connections">About connections</a></li>
<li class="toctree-l3"><a class="reference internal" href="#convenience-routines">Convenience routines</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#g-init-zodb-pathtozodbstorage-verbose-true">g.init_zodb (pathToZodbStorage,verbose=True)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#v-detach">v.detach()</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="intermediatetopics.html">Advanced Topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="appendices.html">Appendices</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="history.html">History of Leo</a></li>
<li class="toctree-l1"><a class="reference internal" href="FAQ.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="what-is-new.html">What's New</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="slides.html">Slides</a></li>
<li class="toctree-l1"><a class="reference internal" href="leoLinks.html">More Leo Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="screen-shots.html">Leo screen shots</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="leo_toc.html">Leo</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="leo_toc.html">Docs</a> &raquo;</li>
        
          <li><a href="leoandotherprograms.html">Leo and Other Programs</a> &raquo;</li>
        
      <li>Using ZODB with Leo</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="using-zodb-with-leo">
<h1>Using ZODB with Leo<a class="headerlink" href="#using-zodb-with-leo" title="Permalink to this headline">¶</a></h1>
<p>This chapter discusses how to write Leo scripts that store and retrieve data using <a class="reference external" href="http://www.zope.org/Wikis/ZODB/guide/zodb.html">ZODB</a>.</p>
<div class="contents local topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#configuring-leo-to-use-zodb" id="id1">Configuring Leo to use zodb</a></p></li>
<li><p><a class="reference internal" href="#initing-zodb" id="id2">Initing zodb</a></p></li>
<li><p><a class="reference internal" href="#writing-data-to-zodb" id="id3">Writing data to zodb</a></p></li>
<li><p><a class="reference internal" href="#defining-zodb-keys" id="id4">Defining zodb keys</a></p></li>
<li><p><a class="reference internal" href="#reading-data-from-zodb" id="id5">Reading data from zodb</a></p></li>
<li><p><a class="reference internal" href="#about-connections" id="id6">About connections</a></p></li>
<li><p><a class="reference internal" href="#convenience-routines" id="id7">Convenience routines</a></p>
<ul>
<li><p><a class="reference internal" href="#g-init-zodb-pathtozodbstorage-verbose-true" id="id8">g.init_zodb (pathToZodbStorage,verbose=True)</a></p></li>
<li><p><a class="reference internal" href="#v-detach" id="id9">v.detach()</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="configuring-leo-to-use-zodb">
<h2><a class="toc-backref" href="#id1">Configuring Leo to use zodb</a><a class="headerlink" href="#configuring-leo-to-use-zodb" title="Permalink to this headline">¶</a></h2>
<p>To enable zodb scripting within Leo, you must set use_zodb = True in the root node of leoNodes.py. You must also install ZODB itself.  See <a class="reference external" href="http://www.zope.org/Wikis/ZODB/guide/node3.html#SECTION000310000000000000000">Installing ZODB</a> for details.</p>
<p>When ZODB is installed and use_zodb is True, Leo’s vnode class becomes a subclass of ZODB.Persistence.Persistent. This is all that is needed to save/retrieve vnodes or tnodes to/from the ZODB.</p>
<p><strong>Important notes</strong>:</p>
<ul class="simple">
<li><p>Scripts <strong>should not</strong> store or retrieve positions using the ZODB! Doing so makes sense neither from Leo’s point of view nor from ZODB’s point of view.</p></li>
<li><p>The examples below show how to store or retrieve Leo data by accessing the so-called root of a ZODB connection. However, these are only examples. Scripts are free to do with Leo’s vnodes <em>anything</em> that can be done with ZODB.Persistence.Persistent objects.</p></li>
</ul>
</div>
<div class="section" id="initing-zodb">
<h2><a class="toc-backref" href="#id2">Initing zodb</a><a class="headerlink" href="#initing-zodb" title="Permalink to this headline">¶</a></h2>
<p>Scripts should call g.init_zodb to open a ZODB.Storage file. g.init_zodb returns an instance of ZODB.DB.  For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">init_zodb</span> <span class="p">(</span><span class="n">zodbStorageFileName</span><span class="p">)</span>
</pre></div>
</div>
<p>You can call g.init_zodb as many times as you like. Only the first call for any path actually does anything: subsequent calls for a previously opened path simply return the same value as the first call.</p>
</div>
<div class="section" id="writing-data-to-zodb">
<h2><a class="toc-backref" href="#id3">Writing data to zodb</a><a class="headerlink" href="#writing-data-to-zodb" title="Permalink to this headline">¶</a></h2>
<p>The following script writes v, a tree of vnodes, to zodb:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">init_zodb</span> <span class="p">(</span><span class="n">zodbStorageFileName</span><span class="p">)</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">root</span><span class="p">()</span>
    <span class="n">root</span><span class="p">[</span><span class="n">aKey</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span> <span class="c1"># See next section for how to define aKey.</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">get_transaction</span><span class="p">()</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>Notes:</p>
<ul>
<li><p>v must be a vnode.
Scripts should <em>not</em> attempt to store Leo positions in the zodb.
v can be the root of an entire outline or a subtree.
For example, either of the following would be reasonable:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="p">[</span><span class="n">aKey</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span><span class="o">.</span><span class="n">v</span>
<span class="n">root</span><span class="p">[</span><span class="n">aKey</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">v</span>
</pre></div>
</div>
</li>
<li><p>To write a single vnode without writing any of its children you can use v.detach.
For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="p">[</span><span class="n">aKey</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p><strong>Important</strong>: It is simplest if only one zodb connection is open at any one time,
so scripts would typically close the zodb connection immediately after processing the data.
The correct way to do this is in a finally statement, as shown above.</p></li>
<li><p>The script above does not define aKey.
The following section discusses how to define reasonable zodb keys.</p></li>
</ul>
</div>
<div class="section" id="defining-zodb-keys">
<h2><a class="toc-backref" href="#id4">Defining zodb keys</a><a class="headerlink" href="#defining-zodb-keys" title="Permalink to this headline">¶</a></h2>
<p>The keys used to store and retrieve data in connection.root() can be any string that uniquely identifies the data. The following are only suggestions; you are free to use any string you like.</p>
<ol class="arabic">
<li><p>When saving a file, you would probably use a key that is similar to a real file path.
For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">aKey</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fileName</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p>When saving a single vnode or tree of vnodes, say v,
a good choice would be to use v’s gnx, namely:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">aKey</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">nodeIndices</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">fileIndex</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that v.detach() does not automatically copy v.fileIndex to the detached node,
so when writing a detached node you would typically do the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">v2</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
<span class="n">v2</span><span class="o">.</span><span class="n">fileIndex</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">fileIndex</span>
<span class="n">aKey</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">nodeIndices</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="n">v2</span><span class="o">.</span><span class="n">fileIndex</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="reading-data-from-zodb">
<h2><a class="toc-backref" href="#id5">Reading data from zodb</a><a class="headerlink" href="#reading-data-from-zodb" title="Permalink to this headline">¶</a></h2>
<p>The following script reads a tree of vnodes from zodb and sets p as the root position of the tree:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">connection</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">root</span><span class="p">()</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">aKey</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">leoNodes</span><span class="o">.</span><span class="n">position</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">get_transaction</span><span class="p">()</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="about-connections">
<h2><a class="toc-backref" href="#id6">About connections</a><a class="headerlink" href="#about-connections" title="Permalink to this headline">¶</a></h2>
<p>The scripts shown above close the zodb connection after processing the data. This is by far the simplest strategy. I recommend it for typical scripts.</p>
<p><strong>Important</strong>: you must <strong>leave the connection open</strong> if your script modifies persistent data in any way. (Actually, this statement is not really true, but you must define zodb transaction managers if you intend to use multiple connections simultaneously. This complication is beyond the scope of this documentation.) For example, it would be possible to create a new Leo outline from the data just read, but the script must leave the connection open. I do not recommend this tactic, but for the adventurous here is some sample code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
<span class="n">root</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">root</span><span class="p">()</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
<span class="k">if</span> <span class="n">v</span><span class="p">:</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
    <span class="n">c2</span><span class="o">.</span><span class="n">openDirectory</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">openDirectory</span> <span class="c1"># A hack.</span>
    <span class="n">c2</span><span class="o">.</span><span class="n">mFileName</span> <span class="o">=</span> <span class="n">fileName</span> <span class="c1"># Another hack.</span>
    <span class="n">c2</span><span class="o">.</span><span class="n">beginUpdate</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">c2</span><span class="o">.</span><span class="n">setRootVnode</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">c2Root</span> <span class="o">=</span> <span class="n">c2</span><span class="o">.</span><span class="n">rootPosition</span><span class="p">()</span>
        <span class="n">c2</span><span class="o">.</span><span class="n">atFileCommands</span><span class="o">.</span><span class="n">readAll</span><span class="p">(</span><span class="n">c2Root</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s1">&#39;zodb read: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fileName</span><span class="p">))</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">c2</span><span class="o">.</span><span class="n">endUpdate</span><span class="p">()</span>
    <span class="c1"># Do *not* close the connection while the new Leo window is open!</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">g</span><span class="o">.</span><span class="n">es_print</span><span class="p">(</span><span class="s1">&#39;zodb read: not found: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fileName</span><span class="p">))</span>
</pre></div>
</div>
<p>This will work <strong>provided</strong> that no other zodb connection is ever opened while this connection is opened. Unless special zodb precautions are taken (like defining zodb transaction managers) calling get_transaction().commit() will affect <strong>all</strong> open connections. You have been warned.</p>
</div>
<div class="section" id="convenience-routines">
<h2><a class="toc-backref" href="#id7">Convenience routines</a><a class="headerlink" href="#convenience-routines" title="Permalink to this headline">¶</a></h2>
<div class="section" id="g-init-zodb-pathtozodbstorage-verbose-true">
<h3><a class="toc-backref" href="#id8">g.init_zodb (pathToZodbStorage,verbose=True)</a><a class="headerlink" href="#g-init-zodb-pathtozodbstorage-verbose-true" title="Permalink to this headline">¶</a></h3>
<p>This function inits the zodb. pathToZodbStorage is the full path to the zodb storage file. You can call g.init_zodb as many times as you like. Only the first call for any path actually does anything: subsequent calls for a previously opened path simply return the same value as the first call.</p>
</div>
<div class="section" id="v-detach">
<h3><a class="toc-backref" href="#id9">v.detach()</a><a class="headerlink" href="#v-detach" title="Permalink to this headline">¶</a></h3>
<p>This vnode method returns v2, a copy of v that is completely detached from the outline. v2.fileIndex is unrelated to v.fileIndex initially, but it may be convenient to copy this field:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">v2</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
<span class="n">v2</span><span class="o">.</span><span class="n">fileIndex</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">fileIndex</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="intermediatetopics.html" class="btn btn-neutral float-right" title="Advanced Topics" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="IPythonBridge.html" class="btn btn-neutral float-left" title="ILeo: Leo’s IPython Bridge" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 1997-2019, Edward K. Ream
      <span class="lastupdated">
        Last updated on Jul 13, 2019.
      </span>

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>